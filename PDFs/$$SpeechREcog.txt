
    Dim WithEvents RecoContext As SpeechLib.SpSharedRecoContext
    'Attribute RecoContext.VB_VarHelpID = -1
    Dim Grammar As SpeechLib.ISpeechRecoGrammar

    Dim m_bRecoRunning As Boolean
    Dim m_cChars As Integer


    Private Sub Form1_Load()
        SetState(False)
        m_cChars = 0
    End Sub


    ' This function handles Recognition event from the reco context object.
    ' Recognition event is fired when the speech recognition engines recognizes
    ' a sequences of words.
    Private Sub RecoContext_Recognition(ByVal StreamNumber As Long, _
                                        ByVal StreamPosition As Object, _
                                        ByVal RecognitionType As SpeechLib.SpeechRecognitionType, _
                                        ByVal Result As SpeechLib.ISpeechRecoResult _
                                        )
        Dim strText As String
        strText = Result.PhraseInfo.GetText
        Debug.Print("Recognition: " & strText & ", " & _
            StreamNumber & ", " & StreamPosition)

        ' Append the new text to the text box, and add a space at the end of the
        ' text so that it looks better
        txtSpeech.SelectionStart = m_cChars
        txtSpeech.SelectedText = strText & " "
        m_cChars = m_cChars + 1 + Len(strText)
    End Sub

    ' This function handles the state of Start and Stop buttons according to
    ' whether dictation is running.
    Private Sub SetState(ByVal bNewState As Boolean)
        m_bRecoRunning = bNewState
        btnStart.Enabled = Not m_bRecoRunning
        btnStop.Enabled = m_bRecoRunning
    End Sub

    Private Sub btnStart_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnStart.Click
        Debug.Assert(Not m_bRecoRunning)

        ' Initialize recognition context object and grammar object, then
        ' start dictation
        If (RecoContext Is Nothing) Then
            Debug.Print("Initializing SAPI reco context object...")
            RecoContext = New SpeechLib.SpSharedRecoContextClass
            Grammar = RecoContext.CreateGrammar(1)
            Grammar.DictationLoad()
        End If

        Grammar.DictationSetState(SpeechLib.SpeechRuleState.SGDSActive)
        SetState(True)
    End Sub

    Private Sub btnStop_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnStop.Click
        Debug.Assert(m_bRecoRunning)
        Grammar.DictationSetState(SpeechLib.SpeechRuleState.SGDSActive)
        SetState(False)
    End Sub
End Class