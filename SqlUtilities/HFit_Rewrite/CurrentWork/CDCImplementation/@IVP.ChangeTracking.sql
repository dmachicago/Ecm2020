--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: ckChangeTrackingTurnedON.sql \n 
--------------------------------------------------------------- 

go
print 'FROM ckChangeTrackingTurnedON.sql';
print 'Installing Change Tracking';
go


DECLARE @DB AS NVarChar (200) = DB_NAME () ;
DECLARE @DBID AS Int = 0;
DECLARE @s AS NVarChar (2000) = '';

IF NOT EXISTS (SELECT
				  [database_id]
			   FROM [sys].[change_tracking_databases]
			   WHERE [database_id] = DB_ID (@DB)) 
    BEGIN
	   SET @s =
			'ALTER DATABASE ' + @DB + ' SET CHANGE_TRACKING = ON (CHANGE_RETENTION = 5 DAYS, AUTO_CLEANUP = ON) ';
	   EXEC (@s) ;
	   PRINT 'Turned Change Tracking On';
    END;

GO
print 'FROM ckChangeTrackingTurnedON.sql';
print 'Installed Change Tracking';
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_ChangeTracking.sql" \n 
--------------------------------------------------------------- 


GO
PRINT 'Executing proc_ChangeTracking.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_ChangeTracking') 
    BEGIN
        PRINT 'replacing proc_ChangeTracking';
        DROP PROCEDURE
             proc_ChangeTracking;
    END;
GO

-- exec proc_ChangeTracking @InstanceName = 'KenticoCMS_1', @TblName = 'COM_SKU', @Enable = 1
-- exec proc_ChangeTracking 'KenticoCMS_1', 'CMS_USER', 1
CREATE PROCEDURE proc_ChangeTracking (
     @InstanceName AS nvarchar (100) 
   , @TblName AS nvarchar (100) 
   , @Enable AS bit) 
AS
BEGIN
    --DECLARE @InstanceName AS nvarchar (100) = 'KenticoCMS_2';
    --DECLARE @TblName AS nvarchar (100)  = 'CMS_Class';
    --DECLARE @Enable AS bit = 1;
    DECLARE @S AS nvarchar (2000) = '';
    DECLARE @iCnt AS integer = 0;
    DECLARE @TEMPVAR AS TABLE (
                              iCNT integer) ;
PRINT 'INSIDE proc_ChangeTracking: ' + @InstanceName + ' / ' +  @TblName;
    IF @Enable = 1
        BEGIN

            SET @S = 'SELECT count(*) as iCNT FROM ' + CHAR (10) ;
            SET @S = @S + '    ' + @InstanceName + '.sys.change_tracking_tables ' + CHAR (10) ;
            SET @S = @S + '        JOIN ' + @InstanceName + '.sys.tables ' + CHAR (10) ;
            SET @S = @S + '           ON ' + @InstanceName + '.sys.tables.object_id = ' + @InstanceName + '.sys.change_tracking_tables.object_id ' + CHAR (10) ;
            SET @S = @S + '               JOIN ' + @InstanceName + '.sys.schemas ' + CHAR (10) ;
            SET @S = @S + '			    ON ' + @InstanceName + '.sys.schemas.schema_id = ' + @InstanceName + '.sys.tables.schema_id ' + CHAR (10) ;
            SET @S = @S + '           WHERE ' + @InstanceName + '.sys.tables.name = ''' + @TblName + '''';

            INSERT INTO @TEMPVAR
            EXEC (@S) ;
            SET @iCnt = (SELECT TOP 1
                                iCNT
                                FROM @TEMPVAR);

            IF @iCnt = 0
                BEGIN
                    PRINT 'ENABLING Change Tracking on ' + @InstanceName + '.dbo.' + @TblName;
                    SET @S = 'ALTER TABLE ' + @InstanceName + '.dbo.' + @TblName + ' ENABLE CHANGE_TRACKING WITH (TRACK_COLUMNS_UPDATED = ON) ';
    print @S ;
                    EXEC (@S) ;
                END;
            ELSE
                BEGIN
                    PRINT 'Change Tracking ENABLED for: ' + + @InstanceName + '.dbo.' + @TblName;
                END;
        END;
    IF @Enable = 0
        BEGIN
            SET @S = 'SELECT count(*) as iCNT FROM ' + CHAR (10) ;
            SET @S = @S + '    ' + @InstanceName + '.sys.change_tracking_tables ' + CHAR (10) ;
            SET @S = @S + '        JOIN ' + @InstanceName + '.sys.tables ' + CHAR (10) ;
            SET @S = @S + '           ON ' + @InstanceName + '.sys.tables.object_id = ' + @InstanceName + '.sys.change_tracking_tables.object_id ' + CHAR (10) ;
            SET @S = @S + '               JOIN ' + @InstanceName + '.sys.schemas ' + CHAR (10) ;
            SET @S = @S + '			    ON ' + @InstanceName + '.sys.schemas.schema_id = ' + @InstanceName + '.sys.tables.schema_id ' + CHAR (10) ;
            SET @S = @S + '           WHERE ' + @InstanceName + '.sys.tables.name = ''' + @TblName + '''';

            INSERT INTO @TEMPVAR
            EXEC (@S) ;
            SET @iCnt = (SELECT TOP 1
                                iCNT
                                FROM @TEMPVAR);

            IF @iCnt > 0
                BEGIN
                    PRINT 'DISABLED Change Tracking on ' + @InstanceName + '.dbo.' + @TblName;
                    SET @S = 'ALTER TABLE ' + @InstanceName + '.dbo.' + @TblName + ' DISABLE CHANGE_TRACKING ';
                    EXEC (@S) ;
                END;
            ELSE
                BEGIN
                    PRINT 'Change Tracking is NOT applied to ' + + @InstanceName + '.dbo.' + @TblName + '.';
                END;
        END;
END;

GO
PRINT 'Executed proc_ChangeTracking.sql';
GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "SetCtHA.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'EXECUTING SetCtHA.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EnableChangeTracking') 
    BEGIN
        DROP PROCEDURE
             proc_EnableChangeTracking;
    END;

GO
-- exec proc_EnableChangeTracking 'KenticoCMS_1'
-- exec proc_EnableChangeTracking 'KenticoCMS_2'
-- exec proc_EnableChangeTracking 'KenticoCMS_3'
CREATE PROCEDURE proc_EnableChangeTracking ( @DatabaseName AS nvarchar (100) )
AS
BEGIN
    DECLARE @DB AS nvarchar (100) = DB_NAME () ;
    DECLARE @MySql AS nvarchar (1000) = '';
    --DECLARE @DatabaseName AS nvarchar (2000) = 'KenticoCMS_2';

    IF NOT EXISTS (SELECT
                          database_id
                          FROM sys.change_tracking_databases
                          WHERE database_id = DB_ID (@DatabaseName)) 
        BEGIN
		  PRINT ('ENABLED CHANGE TRACKING ON: ' + @DatabaseName);
            SET @MySql = 'ALTER DATABASE ' + @DatabaseName + ' SET CHANGE_TRACKING = ON (CHANGE_RETENTION = 2 DAYS, AUTO_CLEANUP = ON) ';
            EXEC (@MySql) ;
        END;

    DECLARE @DBID AS int = 0;
    DECLARE @s AS nvarchar (2000) = '';
    
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Class', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Document', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Site', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Tree', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'cms_user', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'cms_usersettings', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'cms_usersite', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'COM_SKU', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_Account', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_CoachingHealthArea', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_CoachingHealthInterest', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HACampaign', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentMatrixQuestion', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentModule', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentMultipleChoiceQuestion', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentRiskArea', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentRiskCategory', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserAnswers', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserModule', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserQuestion', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserQuestionGroupResults', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserRiskArea', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserRiskCategory', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserStarted', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssessment', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssessmentFreeForm', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'BASE_HFIT_LKP_EDW_REJECTMPI', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardActivity', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardLevelType', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardTrigger', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardType', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_TrackerVendor', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_OutComeMessages', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'hfit_PPTEligibility', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardActivity', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardException', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardGroup', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardLevel', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardProgram', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardsUserActivityDetail', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardsUserLevelDetail', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardTrigger', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardTriggerParameter', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'Hfit_SmallStepResponses', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_ToDoSmallSteps', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFIT_Tracker', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBloodPressure', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBloodSugarAndGlucose', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBMI', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBodyFat', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBodyMeasurements', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCardio', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCholesterol', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCollectionSource', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCotinine', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerDailySteps', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerDef_Tracker', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerFlexibility', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerFruits', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHbA1c', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHeight', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHighFatFoods', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHighSodiumFoods', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerInstance_Tracker', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerMealPortions', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerMedicalCarePlan', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerPreventiveCare', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerRegularMeals', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerRestingHeartRate', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerShots', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSitLess', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSleepPlan', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerStrength', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerStress', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerStressManagement', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSugaryDrinks', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSugaryFoods', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerTests', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerTobaccoAttestation', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerTobaccoFree', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerVegetables', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerWater', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerWeight', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerWholeGrains', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_UserTracker', 1;


    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_HA_Master_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_HA_Master_KenticoCMS_PRD_1', @enabled = 1;
        END;
    PRINT 'Activated Change Tracking for EDW Views and tables';
END;

GO
PRINT 'EXECUTED SetCtHA.sql';

GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "DisableCT_EDW.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing DisableCT_EDW.sql';
GO

if exists (select name from sys.procedures where name = 'proc_DisableChangeTracking')
drop procedure proc_DisableChangeTracking

go
-- exec proc_DisableChangeTracking 'KenticoCMS_1' ;
CREATE PROCEDURE proc_DisableChangeTracking (@DatabaseName as nvarchar(100))
AS
BEGIN
    DECLARE @DB AS nvarchar (100) = @DatabaseName ;
    DECLARE @MySql AS nvarchar (1000) = '';
    DECLARE @DBID AS int = 0;
    DECLARE @s AS nvarchar (2000) = '';

    --declare @DatabaseName as nvarchar(100) = 'KenticoCMS_1' ;
    EXEC proc_ChangeTracking @DatabaseName, 'Hfit_SmallStepResponses', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Class', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Document', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Site', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Tree', 0;
    -- The below tables are used in Audit Tracking and cannot be removed from Change TRacking
    --EXEC proc_ChangeTracking @DatabaseName, 'cms_user', 0;
    --EXEC proc_ChangeTracking @DatabaseName, 'cms_usersettings', 0;
    --EXEC proc_ChangeTracking @DatabaseName, 'cms_usersite', 0;
    --EXEC proc_ChangeTracking @DatabaseName, 'hfit_ppteligibility', 0;    
    EXEC proc_ChangeTracking @DatabaseName, 'COM_SKU', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_Account', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_CoachingHealthArea', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_CoachingHealthInterest', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HACampaign', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentMatrixQuestion', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentModule', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentMultipleChoiceQuestion', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentRiskArea', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentRiskCategory', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserAnswers', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserModule', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserQuestion', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserQuestionGroupResults', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserRiskArea', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserRiskCategory', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserStarted', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssessment', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssessmentFreeForm', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_EDW_RejectMPI', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardActivity', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardLevelType', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardTrigger', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardType', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_TrackerVendor', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_OutComeMessages', 0;    
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardActivity', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardException', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardGroup', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardLevel', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardProgram', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardsUserActivityDetail', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardsUserLevelDetail', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardTrigger', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardTriggerParameter', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_ToDoSmallSteps', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFIT_Tracker', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBloodPressure', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBloodSugarAndGlucose', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBMI', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBodyFat', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBodyMeasurements', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCardio', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCholesterol', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCollectionSource', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCotinine', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCotinine', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerDailySteps', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerDef_Tracker', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerFlexibility', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerFruits', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHbA1c', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHeight', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHighFatFoods', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHighSodiumFoods', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerInstance_Tracker', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerMealPortions', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerMedicalCarePlan', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerPreventiveCare', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerPreventiveCare', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerRegularMeals', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerRestingHeartRate', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerShots', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSitLess', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSleepPlan', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerStrength', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerStress', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerStressManagement', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSugaryDrinks', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSugaryFoods', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerTests', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerTobaccoAttestation', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerTobaccoFree', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerVegetables', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerWater', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerWeight', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerWholeGrains', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_UserTracker', 0;

    IF NOT EXISTS (SELECT
                          database_id
                          FROM sys.change_tracking_databases
                          WHERE database_id = DB_ID (@DB)) 
        BEGIN
            SET @MySql = 'ALTER DATABASE ' + @DB + ' SET CHANGE_TRACKING = OFF ';
            EXEC (@MySql) ;
        END;

    SELECT
           OBJECT_NAME (object_id) AS TABLE_NAME
           FROM sys.change_tracking_tables;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_HA_Master_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_HA_Master_KenticoCMS_PRD_1', @enabled = 0;
        END;

END;

GO
PRINT 'Executed DisableCT_EDW.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_QuickRowCount.sql" \n 
--------------------------------------------------------------- 



GO
PRINT 'Creating proc_QuickRowCount.sql';

GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_QuickRowCount' )
    BEGIN
        DROP PROCEDURE
             proc_QuickRowCount
    END;
GO

/*
declare @i as bigint = 0 ;
EXEC @i = proc_QuickRowCount 'Device_RawNotification' ;
print @i ;

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardUserDetail';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

*/

CREATE PROCEDURE proc_QuickRowCount ( @TblName AS nvarchar( 254 ))
AS
BEGIN

    /*********************************************
    Author:	  Dale Miller
    Date:	  02.02.2008
    Copyright:  DMA, Ltd., Chicago, IL
    **********************************************/

    DECLARE
   @i AS bigint = 0;

    SET @i = ( SELECT
                      SUM ( row_count )
                 FROM sys.dm_db_partition_stats
                 WHERE
                      object_id = OBJECT_ID( @TblName )
                  AND (
                      index_id = 0
                   OR index_id = 1));
    if @i is null
	   set @i = 0 ;
    PRINT @i;
    return @i ;
END;

GO
PRINT 'Created proc_QuickRowCount.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "createOperators.sql" \n 
--------------------------------------------------------------- 

go

print 'Executing createOperators.SQL'
go

if not exists (select name FROM MSDB.dbo.sysoperators where name = 'DBA_Email')
begin
EXEC msdb.dbo.sp_add_operator @name=N'DBA_Email', 
		@enabled=1, 
		@weekday_pager_start_time=60000, 
		@weekday_pager_end_time=220000, 
		@saturday_pager_start_time=80000, 
		@saturday_pager_end_time=220000, 
		@sunday_pager_start_time=80000, 
		@sunday_pager_end_time=220000, 
		@pager_days=127, 
		@email_address=N'majorconfigs@hotmail.com', 
		@category_name=N'[Uncategorized]'
end 

if not exists (select name  FROM MSDB.dbo.sysoperators where name = 'DBA_Mail')
begin
EXEC msdb.dbo.sp_add_operator @name=N'DBA_Mail', 
		@enabled=1, 
		@weekday_pager_start_time=60000, 
		@weekday_pager_end_time=220000, 
		@saturday_pager_start_time=80000, 
		@saturday_pager_end_time=220000, 
		@sunday_pager_start_time=80000, 
		@sunday_pager_end_time=220000, 
		@pager_days=127, 
		@email_address=N'majorconfigs@hotmail.com', 
		@category_name=N'[Uncategorized]'
end 

if not exists (select name  FROM MSDB.dbo.sysoperators where name = 'DBA_Notify')
begin
EXEC msdb.dbo.sp_add_operator @name=N'DBA_Notify', 
		@enabled=1, 
		@weekday_pager_start_time=60000, 
		@weekday_pager_end_time=220000, 
		@saturday_pager_start_time=80000, 
		@saturday_pager_end_time=220000, 
		@sunday_pager_start_time=80000, 
		@sunday_pager_end_time=220000, 
		@pager_days=127, 
		@email_address=N'majorconfigs@hotmail.com', 
		@category_name=N'[Uncategorized]'
end 

go
print 'Executed createOperators.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI.SQL" \n 
--------------------------------------------------------------- 

go
use KenticoCMS_DataMart

go
print 'executing proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI.SQL'
go

if exists (select name from sys.procedures where name = 'proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI')
    drop procedure proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI;

go
--WDMXX
-- exec proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI
CREATE PROCEDURE proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI
AS
BEGIN
    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE name = 'HFIT_LKP_EDW_ALLOWED_MPI') 
        BEGIN
            PRINT 'Creating Lookup table HFIT_LKP_EDW_ALLOWED_MPI';
            CREATE TABLE dbo.HFIT_LKP_EDW_ALLOWED_MPI (
                         HFITUSERMPINUMBER bigint NULL
            ) 
            ON [PRIMARY];

            CREATE UNIQUE CLUSTERED INDEX PK_HFIT_LKP_EDW_ALLOWED_MPI ON dbo.HFIT_LKP_EDW_ALLOWED_MPI
            (
            HFITUSERMPINUMBER ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    truncate TABLE HFIT_LKP_EDW_ALLOWED_MPI;

    INSERT INTO HFIT_LKP_EDW_ALLOWED_MPI
    (
           HFITUSERMPINUMBER) 
    SELECT DISTINCT
           HFITUSERMPINUMBER
           FROM CMS_USERSETTINGS AS USERSETTINGS
           WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
                 SELECT
                        BASE_HFIT_LKP_EDW_REJECTMPI.REJECTMPICODE
                        FROM DBO.BASE_HFIT_LKP_EDW_REJECTMPI) 
             AND HFITUSERMPINUMBER IS NOT NULL
    AND HFITUSERMPINUMBER > 0 ;
END;

go
print 'Executed proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI.SQL'
go--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_trace.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'EXecuting proc_trace.SQL';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_trace') 
    BEGIN
        DROP PROCEDURE
             proc_trace
    END;

GO

CREATE PROCEDURE proc_trace (
     @Msg nvarchar (500) 
   , @StartTime datetime
   , @EndTime datetime) 
AS
BEGIN

    DECLARE @rettime AS nvarchar (50) = '';
    DECLARE @dt2 datetime = GETDATE () ;

    IF @EndTime IS NOT NULL
        BEGIN
            SET @rettime = 'Duration: ' + (SELECT
                                                  CONVERT (varchar (12) , DATEADD (ms, DATEDIFF (ms, @StartTime, @EndTime) , 0) , 114) );
        END
    ELSE
        BEGIN
            SET @rettime = 'Start: ' + CAST (@StartTime AS nvarchar (50)) ;
        END;

    IF @EndTime IS NOT NULL
        BEGIN
            SET @Msg = CHAR (10) + @Msg + ' - ' + @rettime ;
        END
    ELSE
        BEGIN
            SET @Msg = @Msg + ' - ' + @rettime + CHAR (10) ;
        END;
    PRINT @Msg;
END;

GO
EXEC proc_trace 'Test Message', '2015-08-03 11:30:22.722', '2015-08-03 12:27:24.413';
GO
PRINT 'Ececuted proc_trace.SQL';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_HA_MarkDeletedRecords.sql" \n 
--------------------------------------------------------------- 

/*------------------------------------------------------------
DELETE FROM DIM_EDW_HealthAssessment
WHERE
      PkHashCode IN (SELECT TOP 1000
                            PkHashCode
                          FROM DIM_EDW_HealthAssessment) ;

SELECT
       COUNT (*) 
       FROM DIM_EDW_HealthAssessment;
*/
GO

PRINT 'Execute proc_CT_HA_MarkDeletedRecords.sql';

GO

--0.23.2015 03:36:42
--0.24.2015 00:08:42 @ 1,000,000 no CT
--0.24.2015 00:05:16 @ 1,000,000 no CT / no DUPS
--0.24.2015 00:04:56 @ 1,000,000 no CT / no DUPS / TEMP TABLE
-- select count(*) from [@EdwHAHashkeys]
-- exec [proc_CT_HA_MarkDeletedRecords]

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_HA_MarkDeletedRecords') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_MarkDeletedRecords;
    END;

GO
-- exec [proc_CT_HA_MarkDeletedRecords]
CREATE PROCEDURE proc_CT_HA_MarkDeletedRecords
AS
BEGIN

    --************************************************
    --MAKE SURE THE STAGED HASH KEY Table exists
    EXEC proc_Create_DIM_EDW_PkHashkey_TBL ;
    --************************************************

    DECLARE @st AS datetime = GETDATE () ;
    DECLARE @ET AS datetime = GETDATE () ;
    DECLARE @CT AS datetime = GETDATE () ;

    DECLARE @LatestDbVersionToPull AS bigint = 0;
    SET @LatestDbVersionToPull = CHANGE_TRACKING_CURRENT_VERSION () - 1;

    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START determine if DELETED records present', @CT, NULL;
    --**************************************************************

declare @iChgTypes as int = 0 ; 
declare @NbrOfDetectedChanges as bigint = 0 ; 
    EXEC @iChgTypes = proc_CkHaDataChanged NULL, @NbrOfDetectedChanges OUTPUT;
    PRINT 'iChgType is: ' + CAST (@iChgTypes AS nvarchar (50)) ;
    PRINT 'Total Number Of Changes to process is: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) ;
    --**************************************************************
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END determine if DELETED records present', @CT, @ET;
/*-------------------------------
if @iChgTypes = 
    0 - no changes
    1 - updates only
    2 - deletes only
    3 - deletes and updates
    4 - inserts only
    5 - inserts and updates
    6 - inserts and deletes
    7 - inserts, updates, and deletes
*/
    IF @iChgTypes = 0
    OR @iChgTypes = 1
    OR @iChgTypes = 4
    OR @iChgTypes = 5
        BEGIN
            PRINT 'NO DELETES found.';
		  RETURN 0;
        END;

    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process proc_EDW_Gen_Temp_PkHashKeys', @CT, NULL;
    --****************************************
    exec proc_EDW_Gen_Temp_PkHashKeys ;
    --****************************************
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process proc_EDW_Gen_Temp_PkHashKeys', @CT, @ET;

    --***************************************************************************************************************
    SET @CT = GETDATE () ;    
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - CREATE TABLE VAR', @CT, NULL;
    
    
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - Remove DUPS', @CT, NULL;
    --select * from @HASHKEYS
    DECLARE @ms AS float = DATEDIFF (ms, @st, GETDATE ()) ;
    DECLARE @secs AS float = @ms / 1000;
    DECLARE @mins AS float = @ms / 1000 / 60;
    PRINT '1 - @Secs = ' + CAST (@secs AS nvarchar (50)) ;
    PRINT '1 - @mins = ' + CAST (@mins AS nvarchar (50)) ;

    DECLARE @RemoveDups AS bit = 1;

    IF @RemoveDups = 1
        BEGIN
            WITH CTE (
                 PKHASHCODE
               , HAUSERSTARTED_ITEMID
               , HASHCODE
               , DuplicateCount) 
                AS (
                SELECT
                       PKHASHCODE
                     , HAUSERSTARTED_ITEMID
                     , HASHCODE
                     , ROW_NUMBER () OVER ( PARTITION BY PKHASHCODE
                                                       , HAUSERSTARTED_ITEMID
                                                       , HASHCODE  ORDER BY PKHASHCODE , HAUSERSTARTED_ITEMID , HASHCODE) AS DuplicateCount
                       FROM ##DIM_EDW_PkHashkey
                ) 
                DELETE
                FROM CTE
                WHERE
                      DuplicateCount > 1;
        END;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process MarkDeletedRecords - Remove DUPS', @CT, @ET;
    --***************************************************************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - Remove NULL RECS', @CT, NULL;

    DELETE FROM DIM_EDW_HealthAssessment
    WHERE
          PKHashCode IS NULL;

    DELETE FROM ##DIM_EDW_PkHashkey
    WHERE
          PKHashCode IS NULL;

    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process MarkDeletedRecords - Remove NULL RECS', @CT, @ET;
    --***************************************************************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - FIND AND MARK Deleted Recs', @CT, NULL;

    --delete from DIM_EDW_PkHashkey where RowNbr in (select top 100 RowNbr from DIM_EDW_PkHashkey)
    DECLARE
    @DELDATE AS  datetime2 ( 7) = GETDATE () ;
    -- select top 100 * from DIM_EDW_PkHashkey
    --  drop table LKUP_DeletedEdwHAHashkeys
if exists (select name from sys.tables where name = 'LKUP_DeletedEdwHAHashkeys')
    drop table LKUP_DeletedEdwHAHashkeys;

    create table LKUP_DeletedEdwHAHashkeys 
            (
                                    HAUSERSTARTED_ITEMID int  NOT NULL
                                  , USERGUID uniqueidentifier  NOT NULL
                                  , PKHASHCODE nvarchar (100) NOT NULL
                                  --, RowNbr int IDENTITY (1 , 1) 
                                  --             NOT NULL
                                  --  PRIMARY KEY ( PKHASHCODE ASC, HAUSERSTARTED_ITEMID ASC, USERGUID ASC, RowNbr ASC) 
            );

    CREATE CLUSTERED INDEX CI_TEMPEdwHAHashkeys ON dbo.LKUP_DeletedEdwHAHashkeys
	   (
		    HAUSERSTARTED_ITEMID ASC,
		    USERGUID ASC,
		    PKHASHCODE ASC
	   );
    
    -- delete from ##DIM_EDW_PkHashkey where PKHashCode in (select top 1000 PKHashCode from DIM_EDW_PkHashkey)
    -- exec proc_CT_HA_MarkDeletedRecords

    --*********************************************************************
    --If a record exists in the Staging Table and not in the temp table
    --Then it has been deleted. Take all the HASH KEYS in the Staging
    --table and remove those HASH KEYS that exists in the TEMP table,
    --and the ones remaining have been deleted from the STAGING table.
    --*********************************************************************
    WITH CTE_DEL (
         HAUserStarted_ItemID
       , UserGUID
       , PKHashCode
    ) 
        AS (
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
               FROM DIM_EDW_PkHashkey
			WHERE ISNULL (DeletedFlg, 0) = 0
        EXCEPT
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
               FROM ##DIM_EDW_PkHashkey               
        ) 
        INSERT INTO LKUP_DeletedEdwHAHashkeys
        (
               HAUSERSTARTED_ITEMID
             , USERGUID
             , PKHASHCODE) 
        SELECT
               HAUSERSTARTED_ITEMID
             , USERGUID
             , PKHASHCODE
               FROM CTE_DEL;


    -- select  count(*) from LKUP_DeletedEdwHAHashkeys ;

    UPDATE S
           SET
               S.DeletedFlg = 1
             ,S.ChangeDate = GETDATE () 
             ,S.ChangeType = 'D'
               FROM DIM_EDW_PkHashkey AS S
                        JOIN
                        LKUP_DeletedEdwHAHashkeys AS C
                            ON
                            C.PKHashCode = S.PKHashCode
                        AND C.HAUSERSTARTED_ITEMID = S.HAUSERSTARTED_ITEMID
                        AND C.UserGUID = S.UserGUID;    

    UPDATE S
           SET
               DeletedFlg = 1
             ,LastModifiedDate = GETDATE () 
             --,ChangeType = 'D'
               FROM DIM_EDW_HealthAssessment AS S
                        JOIN
                        LKUP_DeletedEdwHAHashkeys AS C
                            ON
                            C.PKHashCode = S.PKHashCode
                        AND C.HAUSERSTARTED_ITEMID = S.UserStartedItemID
                        AND C.UserGUID = S.UserGUID;
    
    DECLARE
    @iDels AS int = @@ROWCOUNT;

        UPDATE dbo.CT_VersionTracking
           SET
               CNT_Delete = @iDels
    WHERE
          SVRName = @@SERVERNAME
      AND DBName = DB_NAME () 
      AND TgtView = 'view_EDW_HealthAssesment'
      AND rownbr = (select max(RowNbr) from CT_VersionTracking where TgtView = 'view_EDW_HealthAssesment')

    PRINT 'NUMBER OF ROWS flagged as deleted: ' + CAST (@iDels AS nvarchar (50)) ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process MarkDeletedRecords - FIND AND MARK Deleted Recs', @CT, @ET;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process', @CT, @ET;
    RETURN @iDels;

END;

GO
PRINT 'Executed MarkDeletedRecords.sql';
--select top 1000 * from [@EdwHAHashkeys] order by RowNbr
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_EDW_UpdateDIMTables.sql" \n 
--------------------------------------------------------------- 

GO
EXEC PrintImmediate 'Executing proc_EDW_UpdateDIMTables.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_EDW_UpdateDIMTables') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_UpdateDIMTables;
    END;
GO

/*-----------------------------------
-------------------------------------
------------------------------
EXEC proc_EDW_UpdateDIMTables 12576 
exec proc_EDW_BuildHAHashkeys
*/
CREATE PROCEDURE proc_EDW_UpdateDIMTables (
       @ChangeVersionID INT = 0
     , @ReloadAll INT = 0) 
AS
BEGIN
    SET NOCOUNT ON;
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

    IF NOT EXISTS ( SELECT
                           NAME
                           FROM sys.tables
                           WHERE
                           name = 'DIM_EDW_MASTER_TABLES') 
        BEGIN

/*--------------------------------------------------------------------
---------------------------------------------------------------------
----------------------------------------------------------------------
@ChangeVersionID is the CHANGE Version number that is desired to pull.
If not provided, it defaults to 0 which will cause all CT recs to be 
considered.

ADD THE MASTER TABLE SO THAT THIS INITIALIZATION WILL NOT OCCUR AGAIN.
NOTE: TO RELOAD ALL STAGING TABLES, JUST DROP DIM_EDW_MASTER_TABLES.
*/

            EXEC PrintImmediate '**INSIDE Populating Staging Tables: ';

            DECLARE
                   @iInsertedCnt AS BIGINT = 0;

            EXEC PrintImmediate 'Populating DIM_EDW_MASTER_TABLES';
            RAISERROR ('Populating DIM_EDW_MASTER_TABLES.' , 10 , 1) WITH NOWAIT;
            SELECT
                   table_name INTO
                                   DIM_EDW_MASTER_TABLES
                   FROM information_schema.tables
                   WHERE table_name LIKE 'DIM_EDW%';

            --DROP ANY EXISTING TABLES SO THEY WILL BE REPOPULATED
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_CMS_USER') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;

                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_CMS_USERSETTINGS') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_CMS_USERSETTINGS;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_CMS_USERSITE') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_CMS_USERSITE;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HealthAssessmentDefinition') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_HealthAssessmentDefinition;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFIT_HealthAssesmentUserAnswers') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_HFIT_HealthAssesmentUserAnswers;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFit_HealthAssesmentUserQuestion') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_HFit_HealthAssesmentUserQuestion;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFit_HealthAssesmentUserRiskArea') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_HFit_HealthAssesmentUserRiskArea;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_VIEW_HFIT_HACAMPAIGN_JOINED') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_VIEW_HFIT_HACAMPAIGN_JOINED;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_VIEW_HFIT_HEALTHASSESSMENT_JOINED') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_VIEW_HFIT_HEALTHASSESSMENT_JOINED;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_View_EDW_HealthAssesmentQuestions') 
                BEGIN
                    EXEC PROC_CREATE_DIM_Tables;
                    EXEC proc_Add_EDW_CT_StdCols DIM_View_EDW_HealthAssesmentQuestions;
                END;

        END;

    --***************************************************************************
    DECLARE
           @iCnt AS BIGINT = 0;
    --***************************************************************************
    --IF EXISTS (SELECT
    --                  name
    --                  FROM sys.tables
    --                  WHERE
    --                  name = 'DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined') 
    --    BEGIN

    --        RAISERROR ('Populating DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined.' , 10 , 1) WITH NOWAIT;
    --        DROP TABLE
    --             DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined;
    --    END;

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined';
    IF
       @iCnt = 0 OR
       NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined') 
        BEGIN
            SELECT
                   HAUserRiskArea.ITEMID AS UserRiskAreaItemID
                 , HAUserRiskArea.HARISKCATEGORYITEMID
                 , HAUserRiskArea.CODENAME AS USERRISKAREACODENAME
                 , HAUserRiskArea.HARISKAREANODEGUID
                 , NULL AS HARISKAREAVERSIONID
                 , HAUserRiskArea.HARISKAREASCORE
                 , HAUserRiskArea.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
                 , HAUserRiskArea.ITEMMODIFIEDWHEN AS HAUserRiskArea_ITEMMODIFIEDWHEN
                 , HAUserRiskArea.ITEMMODIFIEDWHEN AS HAUserRiskArea_LASTMODIFIED   --HAUserRiskArea.LASTLOADEDDATE 
                 , NULL AS HAUserRiskArea_LastUpdateID   --HAUserRiskArea.LastUpdateID 

                 , HAUserQuestionGroupResults.HARiskAreaItemID
                 , HAUserQuestionGroupResults.ItemID AS HAUserQuestionGroupResultsItemID
                 , HAUserQuestionGroupResults.POINTRESULTS
                 , HAUserQuestionGroupResults.CODENAME AS QUESTIONGROUPCODENAME
                 , HAUserQuestionGroupResults.ITEMMODIFIEDWHEN AS HAUserQuestionGroupResults_LASTMODIFIED	--HAUserQuestionGroupResults.LASTLOADEDDATE 
                 , NULL AS HAUserQuestionGroupResults_LastUpdateID	--HAUserQuestionGroupResults.LastUpdateID 

                 , HAUserRiskArea.ItemModifiedWhen AS LastModifiedWhen
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , HAUserRiskArea.SVR AS SVR
                 , HAUserRiskArea.DBNAME AS DBNAME
                 , HAUserRiskArea.LastModifiedDate
                 , 0 AS DeletedFlg
            INTO
                 DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined
                   FROM
                        DBO.BASE_HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
                             LEFT JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS AS HAUserQuestionGroupResults
                             ON
                   HAUserRiskArea.ITEMID = HAUserQuestionGroupResults.HARiskAreaItemID AND
                   HAUserRiskArea.SVR = HAUserQuestionGroupResults.SVR AND
                   HAUserRiskArea.DBNAME = HAUserQuestionGroupResults.DBNAME;
        END;
    RAISERROR ('Populated DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined.' , 10 , 1) WITH NOWAIT;
    EXEC proc_Add_EDW_CT_StdCols DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined;

    IF NOT EXISTS (SELECT
                          column_name
                          FROM information_schema.columns
                          WHERE
                          table_name = 'DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined' AND
                          column_name = 'HARiskCATEGORYItemID') 
        BEGIN
            EXEC PrintImmediate 'ADDING HARiskCATEGORYItemID to DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined';
            ALTER TABLE DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined
            ADD
                        HARISKCATEGORYITEMID INT NULL;
        END;

    RAISERROR ('Populated PI_EDW_HFit_HealthAssesmentUserRiskArea_Joined.' , 10 , 1) WITH NOWAIT;
    IF NOT EXISTS (SELECT
                          name
                          FROM sys.indexes
                          WHERE
                          name = 'PI_EDW_HFit_HealthAssesmentUserRiskArea_Joined') 
        BEGIN
            CREATE CLUSTERED INDEX PI_EDW_HFit_HealthAssesmentUserRiskArea_Joined ON DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined (SVR ASC , DBNAME ASC , UserRiskAreaItemID ASC , HAUserQuestionGroupResultsItemID ASC) 
        END;

    RAISERROR ('Populated CI_EDW_HFit_HealthAssesmentUserRiskArea_Joined.' , 10 , 1) WITH NOWAIT;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.indexes
                          WHERE
                          name = 'CI_EDW_HFit_HealthAssesmentUserRiskArea_Joined') 
        BEGIN
            CREATE NONCLUSTERED INDEX CI_EDW_HFit_HealthAssesmentUserRiskArea_Joined
            ON dbo.DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined (SVR ASC , DBNAME ASC , HAUserQuestionGroupResultsItemID) 
            INCLUDE (UserRiskAreaItemID , LastUpdateID) 
        END;

    RAISERROR ('Created CI_EDW_HFit_HealthAssesmentUserRiskArea_Joined.' , 10 , 1) WITH NOWAIT;

    -- delete from BASE_HFit_HealthAssesmentUserRiskArea where ItemID = 6928
    -- Select * from CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea , 0) AS CT_HFit_HealthAssesmentUserRiskArea
    -- DECLARE @ChangeVersionID AS int = 0;
    DELETE D
           FROM DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined D
                     JOIN CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea , @ChangeVersionID) AS CT_HFit_HealthAssesmentUserRiskArea
                     ON
           D.UserRiskAreaItemID = CT_HFit_HealthAssesmentUserRiskArea.ItemID AND
           SYS_CHANGE_OPERATION = 'D' AND
           D.SVR = CT_HFit_HealthAssesmentUserRiskArea.SVR AND
           D.DBNAME = CT_HFit_HealthAssesmentUserRiskArea.DBNAME;

    -- select * from CHANGETABLE ( CHANGES BASE_HFit_HealthAssesmentUserRiskArea , 0) AS CT_HFit_HealthAssesmentUserRiskArea  
    -- select top 100 * from BASE_HFit_HealthAssesmentUserRiskArea
    -- update BASE_HFit_HealthAssesmentUserRiskArea set CodeName = 'Fats' where CodeNAme = 'Fats'
    -- DECLARE @ChangeVersionID AS int = 0;

    EXEC proc_Add_EDW_CT_StdCols BASE_HFit_HealthAssesmentUserRiskArea;

    RAISERROR ('Processing DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined.' , 10 , 1) WITH NOWAIT;
    SELECT
           CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION
         , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION
         , CT_HFit_HealthAssesmentUserRiskArea.SVR
         , CT_HFit_HealthAssesmentUserRiskArea.DBNAME
         , CT_HFit_HealthAssesmentUserRiskArea.ItemID
    INTO
         #TEMP_HFit_HealthAssesmentUserRiskArea
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea , 0) AS CT_HFit_HealthAssesmentUserRiskArea
           WHERE
           CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION = 'U';
    RAISERROR ('Created #TEMP_HFit_HealthAssesmentUserRiskArea.' , 10 , 1) WITH NOWAIT;

/*---------------------------------------------------------------------------------------------------------------
***** Object:  Index [CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS09]    Script Date: 11/25/2015 8:38:01 AM *****
*/
    IF NOT EXISTS (SELECT
                          name
                          FROM sys.indexes
                          WHERE
                          name = 'CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS09') 
        BEGIN
            CREATE CLUSTERED INDEX CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS09 ON #TEMP_HFit_HealthAssesmentUserRiskArea
            (
            ItemID ASC ,
            SVR ASC ,
            DBNAME ASC
            ) 
        END;
    RAISERROR ('Indexed #TEMP_HFit_HealthAssesmentUserRiskArea.' , 10 , 1) WITH NOWAIT;
    RAISERROR ('Updating DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined.' , 10 , 1) WITH NOWAIT;

    UPDATE S
      SET
          S.USERRISKAREACODENAME = T.CODENAME
        ,S.HARISKAREANODEGUID = T.HARISKAREANODEGUID
        ,S.HARISKAREASCORE = T.HARISKAREASCORE
        ,S.RISKAREAPREWEIGHTEDSCORE = T.PREWEIGHTEDSCORE
        ,S.HAUserRiskArea_ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
        ,S.HARISKCATEGORYITEMID = T.HARISKCATEGORYITEMID
        ,S.LastUpdateID = CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,S.LastModifiedDate = GETDATE () 
        ,DeletedFlg = 0
          FROM BASE_HFit_HealthAssesmentUserRiskArea AS T
                    JOIN DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined AS S
                    ON
           S.UserRiskAreaItemID = T.ItemID AND
           S.SVR = T.SVR AND
           S.DBNAME = T.DBNAME
                    JOIN #TEMP_HFit_HealthAssesmentUserRiskArea AS CT_HFit_HealthAssesmentUserRiskArea
                    ON
           CT_HFit_HealthAssesmentUserRiskArea.ItemID = T.ItemID
           --AND CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION = 'U' AND
           CT_HFit_HealthAssesmentUserRiskArea.SVR = T.SVR AND
           CT_HFit_HealthAssesmentUserRiskArea.DBNAME = T.DBNAME;

    -- select * from CHANGETABLE ( CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS , 0) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
    -- select top 100 * from BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS
    -- Update BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS set CodeNAme = 'MME' where CodeName = 'MME'
    -- DECLARE @ChangeVersionID AS int = 0;
    RAISERROR ('Updated DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined.' , 10 , 1) WITH NOWAIT;
    RAISERROR ('Updating BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS.' , 10 , 1) WITH NOWAIT;
    UPDATE S
      SET
          S.POINTRESULTS = T.POINTRESULTS
        ,S.QUESTIONGROUPCODENAME = T.CODENAME
        ,S.UserRiskAreaItemID = T.HARiskAreaItemID
        ,S.LastUpdateID = CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,DeletedFlg = 0
        ,S.LastModifiedDate = GETDATE () 
          FROM BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS AS T
                    JOIN DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined AS S
                    ON
           S.HAUserQuestionGroupResultsItemID = T.ItemID AND
           S.SVR = T.SVR AND
           S.DBNAME = T.DBNAME
                    JOIN CHANGETABLE ( CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS , @ChangeVersionID) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                    ON
           CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID = T.ItemID
           --AND CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION = 'U' AND
           CT_HFit_HealthAssesmentUserQuestionGroupResults.SVR = T.SVR AND
           CT_HFit_HealthAssesmentUserQuestionGroupResults.DBNAME = T.DBNAME;

    RAISERROR ('Populating DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined.' , 10 , 1) WITH NOWAIT;
    EXEC PrintImmediate 'Populating DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined';

    WITH CTE_temp (
         UserRiskAreaItemID
       , HaRiskAreaItemID
       , SVR
       , DBNAME) 
        AS (
        SELECT
               HAUserRiskArea.ITEMID AS UserRiskAreaItemID
             , HAUserQuestionGroupResults.HARiskAreaItemID
             , HAUserRiskArea.svr
             , HAUserRiskArea.dbname
               FROM
                    DBO.BASE_HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
                         LEFT JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS AS HAUserQuestionGroupResults
                         ON
               HAUserRiskArea.ITEMID = HAUserQuestionGroupResults.HaRiskAreaItemID AND
               HAUserRiskArea.SVR = HAUserQuestionGroupResults.SVR AND
               HAUserRiskArea.DBNAME = HAUserQuestionGroupResults.DBNAME
        EXCEPT
        SELECT
               UserRiskAreaItemID
             , HaRiskAreaItemID
             , SVR
             , DBNAME
               FROM DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined
        ) 
        INSERT INTO DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined (
               USERRISKAREAITEMID
             , HARISKCATEGORYITEMID
             , USERRISKAREACODENAME
             , HARISKAREANODEGUID
             , HARISKAREAVERSIONID
             , HARISKAREASCORE
             , RISKAREAPREWEIGHTEDSCORE
             , HAUserRiskArea_ITEMMODIFIEDWHEN
             , HAUserRiskArea_LASTMODIFIED
             , HAUserRiskArea_LastUpdateID
             , HAUserQuestionGroupResultsItemID
             , POINTRESULTS
             , QUESTIONGROUPCODENAME
             , HAUserQuestionGroupResults_LASTMODIFIED
             , HAUserQuestionGroupResults_LastUpdateID
             , LastModifiedWhen
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , LastModifiedDate
        ) 
        SELECT
               T.USERRISKAREAITEMID
             , T.HARISKCATEGORYITEMID
             , T.USERRISKAREACODENAME
             , T.HARISKAREANODEGUID
             , T.HARISKAREAVERSIONID
             , T.HARISKAREASCORE
             , T.RISKAREAPREWEIGHTEDSCORE
             , T.HAUserRiskArea_ITEMMODIFIEDWHEN
             , T.HAUserRiskArea_LASTMODIFIED
             , T.HAUserRiskArea_LastUpdateID
             , T.HAUserQuestionGroupResultsItemID
             , T.POINTRESULTS
             , T.QUESTIONGROUPCODENAME
             , T.HAUserQuestionGroupResults_LASTMODIFIED
             , T.HAUserQuestionGroupResults_LastUpdateID
             , T.LastModifiedWhen
             , 0 AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
             , T.LastModifiedWhen AS LAstModifiedDate
               FROM
                    View_EDW_HFIT_HealthAssesmentUserRiskArea_Joined AS T
                         JOIN CTE_temp AS C
                         ON
               c.UserRiskAreaItemID = T.UserRiskAreaItemID AND
               c.HaRiskAreaItemID = T.HaRiskAreaItemID AND
               C.SVR = T.SVR AND
               C.DBNAME = T.DBNAME;

    --***************************************************************************
    RAISERROR ('Populating DIM_EDW_CMS_USER - 01.' , 10 , 1) WITH NOWAIT;
    EXEC PrintImmediate 'Populating DIM_EDW_CMS_USER';
    --***************************************************************************
    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_CMS_USER';

    --Check for the existance of DIM_EDW_CMS_USER
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'Populating DIM_EDW_CMS_USER';
            truncate TABLE DIM_EDW_CMS_USER;
            INSERT INTO DIM_EDW_CMS_USER
            (
                   USERID
                 , USERGUID
                 , LastModifiedWhen
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT DISTINCT
                   CMSUSER.USERID
                 , CMSUSER.USERGUID
                 , CMSUSER.UserLastModified AS LastModifiedWhen
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , 0 AS DeletedFlg
                   FROM BASE_CMS_USER AS CMSUSER;

        --CREATE CLUSTERED INDEX PI_EDW_CMS_USER ON DIM_EDW_CMS_USER ( USERID ASC , USERGUID) ;
        END;

    RAISERROR ('Deleting from DIM_EDW_CMS_USER - 01.' , 10 , 1) WITH NOWAIT;
    DELETE D
           FROM DIM_EDW_CMS_USER D
                     JOIN CHANGETABLE (CHANGES BASE_CMS_User , @ChangeVersionID) AS CT_CMS_User
                     ON
           SYS_CHANGE_OPERATION = 'D' AND
           CT_CMS_User.UserID = D.UserID AND
           CT_CMS_User.SVR = D.SVR AND
           CT_CMS_User.DBNAME = D.DBNAME;

    RAISERROR ('Updating DIM_EDW_CMS_USER - 01.' , 10 , 1) WITH NOWAIT;
    UPDATE S
      SET
          S.LastUpdateID = CT_CMS_User.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,DeletedFlg = 0
        ,S.LastModifiedDate = GETDATE () 
          FROM BASE_CMS_USER AS T
                    JOIN DIM_EDW_CMS_USER AS S
                    ON
           S.UserID = T.UserID AND
           S.SVR = T.SVR AND
           S.DBNAME = T.DBNAME
                    JOIN CHANGETABLE ( CHANGES BASE_CMS_User , @ChangeVersionID) AS CT_CMS_User
                    ON
           CT_CMS_User.UserID = T.USERID AND
           S.UserGUID = T.UserGUID
           --AND CT_CMS_User.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_CMS_User.SYS_CHANGE_OPERATION = 'U' AND
           S.SVR = CT_CMS_User.SVR AND
           S.DBNAME = CT_CMS_User.DBNAME;

    EXEC PrintImmediate 'Populating DIM_EDW_CMS_USER';
    RAISERROR ('Populating DIM_EDW_CMS_USER - 01.' , 10 , 1) WITH NOWAIT;

    WITH CTE_EDW_CMS_USER (
         SVR
       , DBNAME
       , USERID) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CT_CMS_User.USERID
               FROM CHANGETABLE (CHANGES BASE_CMS_User , 0) AS CT_CMS_User
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , USERID
               FROM DIM_EDW_CMS_USER
        ) 
        INSERT INTO DIM_EDW_CMS_USER (
               USERID
             , USERGUID
             , LastModifiedWhen
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg) 
        SELECT
               T.USERID
             , T.USERGUID
             , T.UserLastModified AS LastModifiedWhen
             , CT_CMS_User.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
               FROM
                    BASE_cms_user AS T
                         JOIN CHANGETABLE (CHANGES BASE_CMS_USER , @ChangeVersionID) AS CT_CMS_User
                         ON
               CT_CMS_User.UserID = T.USERID AND
               CT_CMS_User.SYS_CHANGE_OPERATION = 'I' AND
               CT_CMS_User.SVR = T.SVR AND
               CT_CMS_User.DBNAME = T.DBNAME
                         JOIN CTE_EDW_CMS_USER AS C
                         ON
               c.userid = CT_CMS_User.userid AND
               c.SVR = CT_CMS_User.SVR AND
               c.DBNAME = CT_CMS_User.DBNAME;

    --*************************************************************************
    -- drop table DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED';
    EXEC PrintImmediate 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED';
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED';
            INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED
            (
                   ITEMID
                 , USERID
                 , HASTARTEDDT
                 , HACOMPLETEDDT
                 , HASCORE
                 , HAPAPERFLG
                 , HATELEPHONICFLG
                 , HASTARTEDMODE
                 , HACOMPLETEDMODE
                 , HACAMPAIGNNODEGUID
                 , HADocumentConfigID
                 , ItemModifiedWhen
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HAUSERSTARTED.ITEMID
                 , HAUSERSTARTED.USERID
                 , HAUSERSTARTED.HASTARTEDDT
                 , HAUSERSTARTED.HACOMPLETEDDT
                 , HAUSERSTARTED.HASCORE
                 , HAUSERSTARTED.HAPAPERFLG
                 , HAUSERSTARTED.HATELEPHONICFLG
                 , HAUSERSTARTED.HASTARTEDMODE
                 , HAUSERSTARTED.HACOMPLETEDMODE
                 , HAUSERSTARTED.HACAMPAIGNNODEGUID
                 , HAUserStarted.HADocumentConfigID
                 , HAUserStarted.ItemModifiedWhen
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , HAUSERSTARTED.SVR
                 , HAUSERSTARTED.DBNAME
                 , 0 AS DeletedFlg
                   FROM BASE_HFIT_HEALTHASSESMENTUSERSTARTED AS HAUSERSTARTED;
        END;

    RAISERROR ('Deleting from DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED - 01.' , 10 , 1) WITH NOWAIT;
    DELETE D
           FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED D
                     JOIN CHANGETABLE ( CHANGES BASE_HFIT_HEALTHASSESMENTUSERSTARTED , @ChangeVersionID) AS CT
                     ON
           CT.ItemID = D.ItemID AND
           CT.SVR = D.SVR AND
           CT.DBNAME = D.DBNAME AND
           SYS_CHANGE_OPERATION = 'D';

    RAISERROR ('Updating DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED - 01.' , 10 , 1) WITH NOWAIT;
    UPDATE S
      SET
          S.HASTARTEDDT = T.HASTARTEDDT
        ,S.HACOMPLETEDDT = T.HACOMPLETEDDT
        ,S.HASCORE = T.HASCORE
        ,S.HAPAPERFLG = T.HAPAPERFLG
        ,S.HATELEPHONICFLG = T.HATELEPHONICFLG
        ,S.HASTARTEDMODE = T.HASTARTEDMODE
        ,S.HACOMPLETEDMODE = T.HACOMPLETEDMODE
        ,S.HACAMPAIGNNODEGUID = T.HACAMPAIGNNODEGUID
        ,S.HADocumentConfigID = T.HADocumentConfigID
        ,S.ItemModifiedWhen = T.ItemModifiedWhen
        ,S.LastUpdateID = CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,S.DeletedFlg = 0
        ,S.LastModifiedDate = GETDATE () 
          FROM BASE_HFIT_HEALTHASSESMENTUSERSTARTED AS T
                    JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED AS S
                    ON
           S.ItemID = T.ItemID AND
           S.SVR = T.SVR AND
           S.DBNAME = T.DBNAME
                    JOIN CHANGETABLE ( CHANGES BASE_HFIT_HEALTHASSESMENTUSERSTARTED , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERSTARTED
                    ON
           CT_HFIT_HEALTHASSESMENTUSERSTARTED.ItemID = T.ItemID AND
           S.ItemID = T.ItemID AND
           S.SVR = T.SVR AND
           S.DBNAME = T.DBNAME
           --AND CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_OPERATION = 'U';
    EXEC PrintImmediate 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED';
    WITH CTE_HFIT_HEALTHASSESMENTUSERSTARTED (
         SVR
       , DBNAME
       , ItemID) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CT_HFIT_HEALTHASSESMENTUSERSTARTED.ItemID
               FROM CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERSTARTED , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERSTARTED
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , itemid
               FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED
        ) 
        INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED (
               USERID
             , HASTARTEDDT
             , HACOMPLETEDDT
             , HASCORE
             , HAPAPERFLG
             , HATELEPHONICFLG
             , HASTARTEDMODE
             , HACOMPLETEDMODE
             , HACAMPAIGNNODEGUID
             , HADocumentConfigID
             , ItemModifiedWhen
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , ITEMID) 
        SELECT
               T.USERID
             , T.HASTARTEDDT
             , T.HACOMPLETEDDT
             , T.HASCORE
             , T.HAPAPERFLG
             , T.HATELEPHONICFLG
             , T.HASTARTEDMODE
             , T.HACOMPLETEDMODE
             , T.HACAMPAIGNNODEGUID
             , T.HADocumentConfigID
             , T.ItemModifiedWhen
             , 0 AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
             , T.ITEMID
               FROM
                    BASE_HFIT_HEALTHASSESMENTUSERSTARTED AS T
                         JOIN CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERSTARTED , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERSTARTED
                         ON
               CT_HFIT_HEALTHASSESMENTUSERSTARTED.ItemID = T.ItemID AND
               CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_OPERATION = 'I' AND
               CT_HFIT_HEALTHASSESMENTUSERSTARTED.SVR = T.SVR AND
               CT_HFIT_HEALTHASSESMENTUSERSTARTED.DBNAME = T.DBNAME
                         JOIN CTE_HFIT_HEALTHASSESMENTUSERSTARTED AS C
                         ON
               C.ItemID = T.ItemID AND
               C.SVR = T.SVR AND
               C.DBNAME = T.DBNAME;

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFIT_HealthAssesmentUserAnswers';
    EXEC PrintImmediate 'Populating DIM_EDW_HFIT_HealthAssesmentUserAnswers';

    IF @iCnt = 0
        BEGIN
            EXEC @iCnt = proc_QuickRowCount 'BASE_HFIT_HealthAssesmentUserAnswers';
            DECLARE
                   @S AS NVARCHAR (250) = 'Populating DIM_EDW_HFIT_HealthAssesmentUserAnswers: ' + CAST (@iCnt AS NVARCHAR (50)) ;
            EXEC PrintImmediate @S;

            INSERT INTO DIM_EDW_HFIT_HealthAssesmentUserAnswers (
                   ITEMID
                 , HAANSWERNODEGUID
                 , CODENAME
                 , HAANSWERVALUE
                 , HAANSWERPOINTS
                 , UOMCODE
                 , ITEMCREATEDWHEN
                 , ITEMMODIFIEDWHEN
                 , HAQUESTIONITEMID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HAUSERANSWERS.ITEMID
                 , HAUSERANSWERS.HAANSWERNODEGUID
                 , HAUSERANSWERS.CODENAME
                 , HAUSERANSWERS.HAANSWERVALUE
                 , HAUSERANSWERS.HAANSWERPOINTS
                 , HAUSERANSWERS.UOMCODE
                 , HAUSERANSWERS.ITEMCREATEDWHEN
                 , HAUSERANSWERS.ITEMMODIFIEDWHEN
                 , HAUSERANSWERS.HAQUESTIONITEMID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , HAUSERANSWERS.SVR
                 , HAUSERANSWERS.DBNAME
                 , 0 AS DeletedFlg
                   FROM BASE_HFIT_HealthAssesmentUserAnswers AS HAUSERANSWERS;
        END;

    EXEC PrintImmediate 'Deleting DIM_EDW_HFIT_HealthAssesmentUserAnswers';
    DELETE T
           FROM DIM_EDW_HFIT_HealthAssesmentUserAnswers T
                     JOIN CHANGETABLE (CHANGES BASE_HFIT_HealthAssesmentUserAnswers , @ChangeVersionID) AS CT
                     ON
                     CT.SVR = T.SVR AND
           CT.DBNAME = T.DBNAME AND
           CT.ItemID = T.ItemID AND
           CT.SYS_CHANGE_OPERATION = 'D';

    EXEC PrintImmediate 'Updating DIM_EDW_HFIT_HealthAssesmentUserAnswers';
    UPDATE S
      SET
          S.HAANSWERNODEGUID = T.HAANSWERNODEGUID
        ,S.CODENAME = T.CODENAME
        ,S.HAANSWERVALUE = T.HAANSWERVALUE
        ,S.HAANSWERPOINTS = T.HAANSWERPOINTS
        ,S.UOMCODE = T.UOMCODE
        ,S.ITEMCREATEDWHEN = T.ITEMCREATEDWHEN
        ,S.ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
        ,S.HAQUESTIONITEMID = T.HAQUESTIONITEMID
        ,S.LastUpdateID = CT_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,DeletedFlg = 0
        ,S.LastModifiedDate = GETDATE () 
          FROM BASE_HFIT_HealthAssesmentUserAnswers AS T
                    JOIN DIM_EDW_HFIT_HealthAssesmentUserAnswers AS S
                    ON
           S.ItemID = T.ItemID AND
           S.SVR = T.SVR AND
           S.DBNAME = T.DBNAME
                    JOIN CHANGETABLE ( CHANGES BASE_HFIT_HealthAssesmentUserAnswers , @ChangeVersionID) AS CT_HealthAssesmentUserAnswers
                    ON
           CT_HealthAssesmentUserAnswers.ItemID = T.ItemID AND
           CT_HealthAssesmentUserAnswers.SVR = T.SVR AND
           CT_HealthAssesmentUserAnswers.DBNAME = T.DBNAME
           --AND CT_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION = 'U';

    EXEC PrintImmediate 'Populating Inserts DIM_EDW_HFIT_HealthAssesmentUserAnswers';
    WITH CTE_temp (
         SVR
       , DBNAME
       , ItemID) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CTE_temp.ItemID
               FROM CHANGETABLE (CHANGES BASE_HFIT_HealthAssesmentUserAnswers , @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , ItemID
               FROM DIM_EDW_HFIT_HealthAssesmentUserAnswers
        ) 
        INSERT INTO DIM_EDW_HFIT_HealthAssesmentUserAnswers (
               HAANSWERNODEGUID
             , CODENAME
             , HAANSWERVALUE
             , HAANSWERPOINTS
             , UOMCODE
             , ITEMCREATEDWHEN
             , ITEMMODIFIEDWHEN
             , HAQUESTIONITEMID
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , ITEMID) 
        SELECT
               T.HAANSWERNODEGUID
             , T.CODENAME
             , T.HAANSWERVALUE
             , T.HAANSWERPOINTS
             , T.UOMCODE
             , T.ITEMCREATEDWHEN
             , T.ITEMMODIFIEDWHEN
             , T.HAQUESTIONITEMID
             , CT_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
             , T.ITEMID
               FROM
                    BASE_HFIT_HealthAssesmentUserAnswers AS T
                         JOIN CHANGETABLE (CHANGES BASE_HFIT_HealthAssesmentUserAnswers , @ChangeVersionID) AS CT_HealthAssesmentUserAnswers
                         ON
               CT_HealthAssesmentUserAnswers.ItemID = T.ItemID AND
               CT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION = 'I' AND
               CT_HealthAssesmentUserAnswers.SVR = T.SVR AND
               CT_HealthAssesmentUserAnswers.DBNAME = T.DBNAME
                         JOIN CTE_temp AS C
                         ON
               c.ItemID = CT_HealthAssesmentUserAnswers.ItemID AND
               CT_HealthAssesmentUserAnswers.SVR = C.SVR AND
               CT_HealthAssesmentUserAnswers.DBNAME = C.DBNAME;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    --drop table DIM_EDW_CMS_USERSITE
    --select CT_TEMP.USERSITEID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES BASE_CMS_USERSITE , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_CMS_USERSITE
    --select top 100 * from BASE_CMS_USERSITE
    --select top 100 * from DIM_EDW_CMS_USERSITE
    --update BASE_CMS_USERSITE set UserPreferredCurrencyID = NULL where UserSiteID = 22594   --changes nothing, just enters a rec into CT

    EXEC PrintImmediate 'Populating DIM_EDW_CMS_USERSITE';
    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_CMS_USERSITE';
    IF @iCnt = 0
        BEGIN

            EXEC PrintImmediate 'Populating immediate DIM_EDW_CMS_USERSITE';
            INSERT INTO DIM_EDW_CMS_USERSITE
            (
                   USERSITEID
                 , USERID
                 , SITEID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   USERSITE.USERSITEID
                 , USERSITE.USERID
                 , USERSITE.SITEID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , USERSITE.SVR
                 , USERSITE.DBNAME
                 , 0 AS DeletedFlg
                   FROM BASE_CMS_USERSITE AS USERSITE;
        END;

    EXEC PrintImmediate 'Cleaning DIM_EDW_CMS_USERSITE';
    DELETE D
           FROM DIM_EDW_CMS_USERSITE D
                     JOIN CHANGETABLE (CHANGES BASE_CMS_USERSITE , @ChangeVersionID) AS CT_XXX
                     ON
           CT_XXX.SVR = D.SVR AND
           CT_XXX.DBNAME = D.DBNAME AND
           CT_XXX.UserSiteID = D.UserSiteID AND
           SYS_CHANGE_OPERATION = 'D';

    EXEC PrintImmediate 'Updating DIM_EDW_CMS_USERSITE';
    UPDATE S
      SET
          S.USERID = T.USERID
        ,S.SITEID = T.SITEID
        ,S.LastUpdateID = CT_CMS_USERSITE.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,S.DeletedFlg = 0
        ,S.LastModifiedDate = GETDATE () 
          FROM BASE_CMS_USERSITE AS T
                    JOIN DIM_EDW_CMS_USERSITE AS S
                    ON
           S.UserSiteID = T.UserSiteID AND
           S.SVR = T.SVR AND
           S.DBNAME = T.DBNAME
                    JOIN CHANGETABLE ( CHANGES BASE_CMS_USERSITE , @ChangeVersionID) AS CT_CMS_USERSITE
                    ON
           CT_CMS_USERSITE.UserSiteID = T.UserSiteID AND
           CT_CMS_USERSITE.SVR = T.SVR AND
           CT_CMS_USERSITE.DBNAME = T.DBNAME
           --AND CT_CMS_USERSITE.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_CMS_USERSITE.SYS_CHANGE_OPERATION = 'U';
    EXEC PrintImmediate 'Populating DIM_EDW_CMS_USERSITE';
    WITH CTE_temp (
         SVR
       , DBNAME
       , UserSiteID) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CTE_temp.UserSiteID
               FROM CHANGETABLE (CHANGES BASE_CMS_USERSITE , @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , UserSiteID
               FROM DIM_EDW_CMS_USERSITE
        ) 
        INSERT INTO DIM_EDW_CMS_USERSITE (
               USERID
             , SITEID
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , USERSITEID) 
        SELECT
               T.USERID
             , T.SITEID
             , CT_CMS_USERSITE.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
             , T.USERSITEID
               FROM
                    BASE_CMS_USERSITE AS T
                         JOIN CHANGETABLE (CHANGES BASE_CMS_USERSITE , @ChangeVersionID) AS CT_CMS_USERSITE
                         ON
               CT_CMS_USERSITE.UserSiteID = T.UserSiteID AND
               CT_CMS_USERSITE.SYS_CHANGE_OPERATION = 'I' AND
               CT_CMS_USERSITE.SVR = T.SVR AND
               CT_CMS_USERSITE.DBNAME = T.DBNAME
                         JOIN CTE_temp AS C
                         ON
               c.UserSiteID = CT_CMS_USERSITE.UserSiteID AND
               CT_CMS_USERSITE.SVR = C.SVR AND
               CT_CMS_USERSITE.DBNAME = C.DBNAME;

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE';
    EXEC PrintImmediate 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE';
    IF @iCnt = 0
        BEGIN

            EXEC PrintImmediate 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE';
            INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE
            (
                   HASTARTEDITEMID
                 , ITEMID
                 , CODENAME
                 , HAMODULENODEGUID
                 , HAMODULESCORE
                 , PREWEIGHTEDSCORE
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HAUSERMODULE.HASTARTEDITEMID
                 , HAUSERMODULE.ITEMID
                 , HAUSERMODULE.CODENAME
                 , HAUSERMODULE.HAMODULENODEGUID
                 , HAUSERMODULE.HAMODULESCORE
                 , HAUSERMODULE.PREWEIGHTEDSCORE
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , HAUSERMODULE.SVR
                 , HAUSERMODULE.DBNAME
                 , 0 AS DeletedFlg
                   FROM BASE_HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE;
        END;

    EXEC PrintImmediate 'Cleaning DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE';
    DELETE D
           FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE D
                     JOIN CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERMODULE , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERMODULE
                     ON
           CT_HFIT_HEALTHASSESMENTUSERMODULE.ItemID = D.ItemID AND
           CT_HFIT_HEALTHASSESMENTUSERMODULE.SVR = D.SVR AND
           CT_HFIT_HEALTHASSESMENTUSERMODULE.DBNAME = D.DBNAME AND
           SYS_CHANGE_OPERATION = 'D';

    EXEC PrintImmediate 'Updating DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE';
    UPDATE S
      SET
          S.HASTARTEDITEMID = T.HASTARTEDITEMID
        ,S.CODENAME = T.CODENAME
        ,S.HAMODULENODEGUID = T.HAMODULENODEGUID
        ,S.HAMODULESCORE = T.HAMODULESCORE
        ,S.PREWEIGHTEDSCORE = T.PREWEIGHTEDSCORE
        ,S.LastUpdateID = CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,DeletedFlg = 0
        ,S.LastModifiedDate = GETDATE () 
          FROM BASE_HFIT_HEALTHASSESMENTUSERMODULE AS T
                    JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE AS S
                    ON
           S.ItemID = T.ItemID AND
           S.SVR = T.SVR AND
           S.DBNAME = T.DBNAME
                    JOIN CHANGETABLE ( CHANGES BASE_HFIT_HEALTHASSESMENTUSERMODULE , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERMODULE
                    ON
           CT_HFIT_HEALTHASSESMENTUSERMODULE.ItemID = T.ItemID AND
           CT_HFIT_HEALTHASSESMENTUSERMODULE.SVR = T.SVR AND
           CT_HFIT_HEALTHASSESMENTUSERMODULE.DBNAME = T.DBNAME
           --AND CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION = 'U';

    EXEC PrintImmediate 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE';
    WITH CTE_temp (
         SVR
       , DBNAME
       , ItemID) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CTE_temp.ItemID
               FROM CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERMODULE , @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , ItemID
               FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE
        ) 
        INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE (
               HASTARTEDITEMID
             , CODENAME
             , HAMODULENODEGUID
             , HAMODULESCORE
             , PREWEIGHTEDSCORE
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , ITEMID) 
        SELECT
               T.HASTARTEDITEMID
             , T.CODENAME
             , T.HAMODULENODEGUID
             , T.HAMODULESCORE
             , T.PREWEIGHTEDSCORE
             , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
             , T.ITEMID
               FROM
                    BASE_HFIT_HEALTHASSESMENTUSERMODULE AS T
                         JOIN CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERMODULE , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERMODULE
                         ON
               CT_HFIT_HEALTHASSESMENTUSERMODULE.ItemID = T.ItemID AND
               CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION = 'I' AND
               CT_HFIT_HEALTHASSESMENTUSERMODULE.SVR = T.SVR AND
               CT_HFIT_HEALTHASSESMENTUSERMODULE.DBNAME = T.DBNAME
                         JOIN CTE_temp AS C
                         ON
               c.ItemID = CT_HFIT_HEALTHASSESMENTUSERMODULE.ItemID AND
               CT_HFIT_HEALTHASSESMENTUSERMODULE.SVR = C.SVR AND
               CT_HFIT_HEALTHASSESMENTUSERMODULE.DBNAME = C.DBNAME;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    --drop table DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
    --select CT_TEMP.ItemID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
    --select top 100 * from HFIT_HEALTHASSESMENTUSERRISKCATEGORY
    --select top 100 * from DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
    --update HFIT_HEALTHASSESMENTUSERRISKCATEGORY set CodeName = 'AboutYou' where itemid = 32919

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY';
    EXEC PrintImmediate 'PROCESSING DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY';
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY';
            INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
            (
                   ITEMID
                 , CODENAME
                 , HARISKCATEGORYNODEGUID
                 , HARISKCATEGORYSCORE
                 , PREWEIGHTEDSCORE
                 , ITEMMODIFIEDWHEN
                 , HAMODULEITEMID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HARISKCATEGORY.ITEMID
                 , HARISKCATEGORY.CODENAME
                 , HARISKCATEGORY.HARISKCATEGORYNODEGUID
                 , HARISKCATEGORY.HARISKCATEGORYSCORE
                 , HARISKCATEGORY.PREWEIGHTEDSCORE
                 , HARISKCATEGORY.ITEMMODIFIEDWHEN
                 , HARISKCATEGORY.HAMODULEITEMID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , 0 AS DeletedFlg
                   FROM BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY;
        END;

    EXEC PrintImmediate 'Cleaning DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY';
    DELETE D
           FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY D
                     JOIN CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
                     ON
           SYS_CHANGE_OPERATION = 'D' AND
           CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ItemID = D.ItemID AND
           CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SVR = D.SVR AND
           CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.DBNAME = D.DBNAME;

    EXEC PrintImmediate 'Updating DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY';
    UPDATE S
      SET
          S.CODENAME = T.CODENAME
        ,S.HARISKCATEGORYNODEGUID = T.HARISKCATEGORYNODEGUID
        ,S.HARISKCATEGORYSCORE = T.HARISKCATEGORYSCORE
        ,S.PREWEIGHTEDSCORE = T.PREWEIGHTEDSCORE
        ,S.ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
        ,S.HAMODULEITEMID = T.HAMODULEITEMID
        ,S.LastUpdateID = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,DeletedFlg = 0
        ,S.LastModifiedDate = GETDATE () 
          FROM BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS T
                    JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS S
                    ON
           S.ItemID = T.ItemID AND
           S.SVR = T.SVR AND
           S.DBNAME = T.DBNAME
                    JOIN CHANGETABLE ( CHANGES BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
                    ON
           CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ItemID = T.ItemID
           --AND CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION = 'U' AND
           S.SVR = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SVR AND
           S.DBNAME = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.DBNAME;
    EXEC PrintImmediate 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY';
    WITH CTE_temp (
         SVR
       , DBNAME
       , ItemID) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CTE_temp.ItemID
               FROM CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY , @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , ItemID
               FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
        ) 
        INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY (
               ITEMID
             , CODENAME
             , HARISKCATEGORYNODEGUID
             , HARISKCATEGORYSCORE
             , PREWEIGHTEDSCORE
             , ITEMMODIFIEDWHEN
             , HAMODULEITEMID
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg) 
        SELECT
               T.ITEMID
             , T.CODENAME
             , T.HARISKCATEGORYNODEGUID
             , T.HARISKCATEGORYSCORE
             , T.PREWEIGHTEDSCORE
             , T.ITEMMODIFIEDWHEN
             , T.HAMODULEITEMID
             , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
               FROM
                    BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS T
                         JOIN CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
                         ON
               CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ItemID = T.ItemID AND
               CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION = 'I' AND
               CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SVR = T.SVR AND
               CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.DBNAME = T.DBNAME
                         JOIN CTE_temp AS C
                         ON
               c.ItemID = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ItemID AND
               CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SVR = C.SVR AND
               CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.DBNAME = C.DBNAME;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    --drop table DIM_EDW_CMS_USERSETTINGS
    --select CT_TEMP.UserSettingID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES CMS_USERSETTINGS , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_CMS_USERSETTINGS
    --select top 100 * from CMS_USERSETTINGS
    --select top 100 * from DIM_EDW_CMS_USERSETTINGS
    --update CMS_USERSETTINGS set UserNickName = 'XXX' where UserSettingsID = 63971
    --update CMS_USERSETTINGS set UserNickName = null where UserSettingsID = 63971

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_CMS_USERSETTINGS';
    EXEC PrintImmediate 'Populating DIM_EDW_CMS_USERSETTINGS';
    IF @iCnt = 0
        BEGIN

            EXEC PrintImmediate 'Populating DIM_EDW_CMS_USERSETTINGS';
            INSERT INTO DIM_EDW_CMS_USERSETTINGS
            (
                   USERSETTINGSID
                 , USERSETTINGSUSERID
                 , HFITUSERMPINUMBER
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   USERSETTINGS.USERSETTINGSID
                 , USERSETTINGS.USERSETTINGSUSERID
                 , USERSETTINGS.HFITUSERMPINUMBER
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , USERSETTINGS.SVR
                 , USERSETTINGS.DBNAME
                 , 0 AS DeletedFlg
                   FROM BASE_CMS_USERSETTINGS AS USERSETTINGS;
        END;

    EXEC PrintImmediate 'Cleaning DIM_EDW_CMS_USERSETTINGS';
    DELETE D
           FROM DIM_EDW_CMS_USERSETTINGS D
                     JOIN CHANGETABLE (CHANGES BASE_CMS_USERSETTINGS , @ChangeVersionID) AS CT_CMS_USERSETTINGS
                     ON
           SYS_CHANGE_OPERATION = 'D' AND
           D.UserSettingsID = CT_CMS_USERSETTINGS.UserSettingsID AND
           D.SVR = CT_CMS_USERSETTINGS.SVR AND
           D.DBNAME = CT_CMS_USERSETTINGS.DBNAME;

    EXEC PrintImmediate 'Updating DIM_EDW_CMS_USERSETTINGS';
    UPDATE S
      SET
          S.USERSETTINGSUSERID = T.USERSETTINGSUSERID
        ,S.HFITUSERMPINUMBER = T.HFITUSERMPINUMBER
        ,S.LastUpdateID = CT_CMS_USERSETTINGS.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,DeletedFlg = 0
        ,S.LastModifiedDate = GETDATE () 
          FROM BASE_CMS_USERSETTINGS AS T
                    JOIN DIM_EDW_CMS_USERSETTINGS AS S
                    ON
           S.USERSETTINGSID = T.USERSETTINGSID
                    JOIN CHANGETABLE ( CHANGES BASE_CMS_USERSETTINGS , @ChangeVersionID) AS CT_CMS_USERSETTINGS
                    ON
           CT_CMS_USERSETTINGS.USERSETTINGSID = T.USERSETTINGSID
           --AND CT_CMS_USERSETTINGS.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION = 'U';

    EXEC PrintImmediate 'Populating DIM_EDW_CMS_USERSETTINGS';
    WITH CTE_temp (
         SVR
       , DBNAME
       , USERSETTINGSID) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CTE_temp.USERSETTINGSID
               FROM CHANGETABLE (CHANGES BASE_CMS_USERSETTINGS , @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , USERSETTINGSID
               FROM DIM_EDW_CMS_USERSETTINGS
        ) 
        INSERT INTO DIM_EDW_CMS_USERSETTINGS (
               USERSETTINGSUSERID
             , HFITUSERMPINUMBER
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , USERSETTINGSID) 
        SELECT
               T.USERSETTINGSUSERID
             , T.HFITUSERMPINUMBER
             , CT_CMS_USERSETTINGS.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
             , T.USERSETTINGSID
               FROM
                    BASE_CMS_USERSETTINGS AS T
                         JOIN CHANGETABLE (CHANGES BASE_CMS_USERSETTINGS , @ChangeVersionID) AS CT_CMS_USERSETTINGS
                         ON
               CT_CMS_USERSETTINGS.USERSETTINGSID = T.USERSETTINGSID AND
               CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION = 'I' AND
               CT_CMS_USERSETTINGS.SVR = T.SVR AND
               CT_CMS_USERSETTINGS.DBNAME = T.DBNAME
                         JOIN CTE_temp AS C
                         ON
               c.USERSETTINGSID = CT_CMS_USERSETTINGS.USERSETTINGSID AND
               CT_CMS_USERSETTINGS.SVR = C.SVR AND
               CT_CMS_USERSETTINGS.DBNAME = C.DBNAME;

    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    --drop table DIM_EDW_HFit_HealthAssesmentUserRiskArea
    --select CT_TEMP.ItemID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_HFit_HealthAssesmentUserRiskArea
    --select top 100 * from BASE_HFit_HealthAssesmentUserRiskArea
    --select top 100 * from DIM_EDW_HFit_HealthAssesmentUserRiskArea
    --update BASE_HFit_HealthAssesmentUserRiskArea set CodeName = 'AboutYou' where itemid = 46664

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFit_HealthAssesmentUserRiskArea';
    EXEC PrintImmediate 'Populating DIM_EDW_HFit_HealthAssesmentUserRiskArea';
    IF @iCnt = 0
        BEGIN

            EXEC PrintImmediate 'Add records DIM_EDW_HFit_HealthAssesmentUserRiskArea';
            INSERT INTO DIM_EDW_HFit_HealthAssesmentUserRiskArea
            (
                   ITEMID
                 , CODENAME
                 , HARISKAREANODEGUID
                 , HARISKAREASCORE
                 , PREWEIGHTEDSCORE
                 , ITEMMODIFIEDWHEN
                 , HARISKCATEGORYITEMID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HAUserRiskArea.ItemID
                 , HAUserRiskArea.CODENAME
                 , HAUserRiskArea.HARISKAREANODEGUID
                 , HAUserRiskArea.HARISKAREASCORE
                 , HAUserRiskArea.PREWEIGHTEDSCORE
                 , HAUserRiskArea.ITEMMODIFIEDWHEN
                 , HAUserRiskArea.HARISKCATEGORYITEMID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , HAUserRiskArea.SVR
                 , HAUserRiskArea.DBNAME
                 , 0 AS DeletedFlg
                   FROM BASE_HFIT_HealthAssesmentUserRiskArea AS HAUserRiskArea;

        END;

    EXEC PrintImmediate 'Cleaning DIM_EDW_HFit_HealthAssesmentUserRiskArea';
    DELETE D
           FROM DIM_EDW_HFit_HealthAssesmentUserRiskArea D
                     JOIN CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea , @ChangeVersionID) AS CT
                     ON
           D.ItemID = CT.ItemID AND
           SYS_CHANGE_OPERATION = 'D' AND
           D.SVR = CT.SVR AND
           D.DBNAME = CT.DBNAME;

    EXEC PrintImmediate 'Updating DIM_EDW_HFit_HealthAssesmentUserRiskArea';
    UPDATE S
      SET
          S.CODENAME = T.CODENAME
        ,S.HARISKAREANODEGUID = T.HARISKAREANODEGUID
        ,S.HARISKAREASCORE = T.HARISKAREASCORE
        ,S.PREWEIGHTEDSCORE = T.PREWEIGHTEDSCORE
        ,S.ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
        ,S.HARISKCATEGORYITEMID = T.HARISKCATEGORYITEMID
        ,S.LastUpdateID = CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,DeletedFlg = 0
        ,S.LastModifiedDate = GETDATE () 
          FROM BASE_HFit_HealthAssesmentUserRiskArea AS T
                    JOIN DIM_EDW_HFit_HealthAssesmentUserRiskArea AS S
                    ON
           S.ItemID = T.ItemID
                    JOIN CHANGETABLE ( CHANGES BASE_HFit_HealthAssesmentUserRiskArea , @ChangeVersionID) AS CT_HFit_HealthAssesmentUserRiskArea
                    ON
           CT_HFit_HealthAssesmentUserRiskArea.ItemID = T.ItemID
           --AND CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION = 'U';

    EXEC PrintImmediate 'INSERTS DIM_EDW_HFit_HealthAssesmentUserRiskArea';
    WITH CTE_temp (
         SVR
       , DBNAME
       , ItemID) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CTE_temp.ItemID
               FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea , @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , ItemID
               FROM DIM_EDW_HFit_HealthAssesmentUserRiskArea
        ) 
        INSERT INTO DIM_EDW_HFit_HealthAssesmentUserRiskArea (
               CODENAME
             , HARISKAREANODEGUID
             , HARISKAREASCORE
             , PREWEIGHTEDSCORE
             , ITEMMODIFIEDWHEN
             , HARISKCATEGORYITEMID
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , ITEMID) 
        SELECT
               T.CODENAME
             , T.HARISKAREANODEGUID
             , T.HARISKAREASCORE
             , T.PREWEIGHTEDSCORE
             , T.ITEMMODIFIEDWHEN
             , T.HARISKCATEGORYITEMID
             , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
             , T.ITEMID
               FROM
                    BASE_HFit_HealthAssesmentUserRiskArea AS T
                         JOIN CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea , @ChangeVersionID) AS CT_HFit_HealthAssesmentUserRiskArea
                         ON
               CT_HFit_HealthAssesmentUserRiskArea.ItemID = T.ItemID AND
               CT_HFit_HealthAssesmentUserRiskArea.SVR = T.SVR AND
               CT_HFit_HealthAssesmentUserRiskArea.DBNAME = T.DBNAME AND
               CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION = 'I'
                         JOIN CTE_temp AS C
                         ON
               c.ItemID = CT_HFit_HealthAssesmentUserRiskArea.ItemID AND
               c.SVR = CT_HFit_HealthAssesmentUserRiskArea.SVR AND
               c.DBNAME = CT_HFit_HealthAssesmentUserRiskArea.DBNAME;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************		 
    --drop table DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
    --select CT_TEMP.ItemID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
    --select top 100 * from BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS
    --select top 100 * from DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
    --update BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS set CodeName = 'MME' where itemid = 19864

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults';
    EXEC PrintImmediate 'Populating DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults';
    IF @iCnt = 0
        BEGIN

            EXEC PrintImmediate 'Populating DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults';
            INSERT INTO DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
            (
                   ITEMID
                 , POINTRESULTS
                 , CODENAME
                 , HARiskAreaItemID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HAUserQuestionGroupResults.ItemID
                 , HAUserQuestionGroupResults.POINTRESULTS
                 , HAUserQuestionGroupResults.CODENAME
                 , HAUserQuestionGroupResults.HARiskAreaItemID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , HAUserQuestionGroupResults.SVR
                 , HAUserQuestionGroupResults.DBNAME
                 , 0 AS DeletedFlg
                   FROM BASE_HFIT_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults;

        END;

    EXEC PrintImmediate 'Cleaning DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults';
    DELETE D
           FROM DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults D
                     JOIN CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestionGroupResults , @ChangeVersionID) AS CT
                     ON
           D.ItemID = CT.ItemID AND
           SYS_CHANGE_OPERATION = 'D' AND
           D.SVR = CT.SVR AND
           D.DBNAME = CT.DBNAME;

    EXEC PrintImmediate 'Updating DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults';
    UPDATE S
      SET
          S.POINTRESULTS = T.POINTRESULTS
        ,S.CODENAME = T.CODENAME
        ,S.HARiskAreaItemID = T.HARiskAreaItemID
        ,S.LastUpdateID = CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION
        ,S.LASTLOADEDDATE = GETDATE () 
        ,S.SVR = T.SVR
        ,S.DBNAME = T.DBNAME
        ,DeletedFlg = 0
        ,S.LastModifiedDate = GETDATE () 
          FROM BASE_HFit_HealthAssesmentUserQuestionGroupResults AS T
                    JOIN DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults AS S
                    ON
           S.ItemID = T.ItemID AND
           S.SVR = T.SVR AND
           S.DBNAME = T.DBNAME
                    JOIN CHANGETABLE ( CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS , @ChangeVersionID) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                    ON
           CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID = T.ItemID
           --AND CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION != S.LastUpdateID
           AND
           CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION = 'U' AND
           S.SVR = CT_HFit_HealthAssesmentUserQuestionGroupResults.SVR AND
           S.DBNAME = CT_HFit_HealthAssesmentUserQuestionGroupResults.DBNAME;

    EXEC PrintImmediate 'Populating DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults';
    WITH CTE_temp (
         SVR
       , DBNAME
       , ItemID) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CTE_temp.ItemID
               FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestionGroupResults , @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , ItemID
               FROM DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
        ) 
        INSERT INTO DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults (
               POINTRESULTS
             , CODENAME
             , HARiskAreaItemID
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , ITEMID) 
        SELECT
               T.POINTRESULTS
             , T.CODENAME
             , T.HARiskAreaItemID
             , CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
             , T.ITEMID
               FROM
                    BASE_HFit_HealthAssesmentUserQuestionGroupResults AS T
                         JOIN CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestionGroupResults , @ChangeVersionID) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                         ON
               CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID = T.ItemID AND
               CT_HFit_HealthAssesmentUserQuestionGroupResults.SVR = T.SVR AND
               CT_HFit_HealthAssesmentUserQuestionGroupResults.DBNAME = T.DBNAME AND
               CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION = 'I'
                         JOIN CTE_temp AS C
                         ON
               c.ItemID = CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID AND
               CT_HFit_HealthAssesmentUserQuestionGroupResults.SVR = C.SVR AND
               CT_HFit_HealthAssesmentUserQuestionGroupResults.DBNAME = C.DBNAME;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    -- drop table DIM_EDW_HFit_HealthAssesmentUserQuestion
    -- select top 100 * from DIM_EDW_HFit_HealthAssesmentUserQuestion

    EXEC PrintImmediate 'Populating #TEMP_BASE_HFIT_HEALTHASSESMENTUSERQUESTION';
    SELECT
           CT.ITEMID
         , CT.SVR
         , CT.DBNAME
         , CT.SYS_CHANGE_OPERATION
         , CT.SYS_CHANGE_VERSION
    INTO
         #TEMP_BASE_HFIT_HEALTHASSESMENTUSERQUESTION
           FROM CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTION , 0) AS CT;

    RAISERROR ('Populated TEMP_BASE_HFIT_HEALTHASSESMENTUSERQUESTION.' , 10 , 1) WITH NOWAIT;
    RAISERROR ('Creating IDXTEMP_BASE_HFIT_HEALTHASSESMENTUSERQUESTION.' , 10 , 1) WITH NOWAIT;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.indexes
                          WHERE
                          name = 'IDXTEMP_BASE_HFIT_HEALTHASSESMENTUSERQUESTION') 
        BEGIN
            CREATE CLUSTERED INDEX IDXTEMP_BASE_HFIT_HEALTHASSESMENTUSERQUESTION ON #TEMP_BASE_HFIT_HEALTHASSESMENTUSERQUESTION
            (SVR , DBNAME , ITEMID , SYS_CHANGE_OPERATION , SYS_CHANGE_VERSION) 
        END;
    RAISERROR ('Created IDXTEMP_BASE_HFIT_HEALTHASSESMENTUSERQUESTION.' , 10 , 1) WITH NOWAIT;

    -- Truncate table DIM_EDW_HFit_HealthAssesmentUserQuestion
    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFit_HealthAssesmentUserQuestion';
    EXEC PrintImmediate 'Populating DIM_EDW_HFit_HealthAssesmentUserQuestion';
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'Populating DIM_EDW_HFit_HealthAssesmentUserQuestion';
            INSERT INTO DIM_EDW_HFit_HealthAssesmentUserQuestion
            (
                   ITEMID
                 , HAQUESTIONNODEGUID
                 , CODENAME
                 , HAQUESTIONSCORE
                 , PREWEIGHTEDSCORE
                 , ISPROFESSIONALLYCOLLECTED
                 , ITEMMODIFIEDWHEN
                 , HARiskAreaItemID
                 , HFIT_HEALTHASSESMENTUSERQUESTION_CTID
                 , HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
                 , CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   USERQUES.ITEMID
                 , USERQUES.HAQUESTIONNODEGUID
                 , USERQUES.CODENAME
                 , USERQUES.HAQUESTIONSCORE
                 , USERQUES.PREWEIGHTEDSCORE
                 , USERQUES.ISPROFESSIONALLYCOLLECTED
                 , USERQUES.ITEMMODIFIEDWHEN
                 , USERQUES.HARiskAreaItemID
                 , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID AS HFIT_HEALTHASSESMENTUSERQUESTION_CTID
                 , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
                 , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , USERQUES.SVR
                 , USERQUES.DBNAME
                 , 0 AS DeletedFlg

                   FROM
                        BASE_HFIT_HEALTHASSESMENTUSERQUESTION AS USERQUES
                             LEFT OUTER JOIN #TEMP_BASE_HFIT_HEALTHASSESMENTUSERQUESTION AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
                             ON
                   USERQUES.ITEMID = CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID AND
                   USERQUES.svr = CT_HFIT_HEALTHASSESMENTUSERQUESTION.svr AND
                   USERQUES.DBNAME = CT_HFIT_HEALTHASSESMENTUSERQUESTION.DBNAME;

        END;

    EXEC PrintImmediate 'Populating Inserts DIM_EDW_HFit_HealthAssesmentUserQuestion';
    WITH CTE_HFIT_HEALTHASSESMENTUSERQUESTION (
         SVR
       , DBNAME
       , ItemID) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID
               FROM CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTION , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , itemid
               FROM DIM_EDW_HFit_HealthAssesmentUserQuestion
        ) 
        INSERT INTO DIM_EDW_HFit_HealthAssesmentUserQuestion (
               ITEMID
             , HAQUESTIONNODEGUID
             , CODENAME
             , HAQUESTIONSCORE
             , PREWEIGHTEDSCORE
             , ISPROFESSIONALLYCOLLECTED
             , ITEMMODIFIEDWHEN
             , HARiskAreaItemID
             , HFIT_HEALTHASSESMENTUSERQUESTION_CTID
             , HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
             , CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg) 
        SELECT
               T.ITEMID
             , T.HAQUESTIONNODEGUID
             , T.CODENAME
             , T.HAQUESTIONSCORE
             , T.PREWEIGHTEDSCORE
             , T.ISPROFESSIONALLYCOLLECTED
             , T.ITEMMODIFIEDWHEN
             , T.HARiskAreaItemID
             , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID  AS HFIT_HEALTHASSESMENTUSERQUESTION_CTID
             , 'I' AS HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
             , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
             , 0 AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , T.SVR
             , T.DBNAME
             , 0 AS DeletedFlg
               FROM
                    BASE_HFIT_HEALTHASSESMENTUSERQUESTION AS T
                         JOIN CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTION , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
                         ON
               CT_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID = T.ItemID AND
               CT_HFIT_HEALTHASSESMENTUSERQUESTION.SVR = T.SVR AND
               CT_HFIT_HEALTHASSESMENTUSERQUESTION.DBNAME = T.DBNAME AND
               CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION = 'I'
                         JOIN CTE_HFIT_HEALTHASSESMENTUSERQUESTION
                         ON
               CTE_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID = T.ItemID AND
               CTE_HFIT_HEALTHASSESMENTUSERQUESTION.SVR = T.SVR AND
               CTE_HFIT_HEALTHASSESMENTUSERQUESTION.DBNAME = T.DBNAME;

    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;
    DELETE D
           FROM DIM_EDW_HFit_HealthAssesmentUserQuestion D
                     JOIN CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTION , @ChangeVersionID) AS CT
                     ON
           D.ItemID = CT.ItemID AND
           SYS_CHANGE_OPERATION = 'D' AND
           D.SVR = CT.SVR AND
           D.DBNAME = CT.DBNAME;

    EXEC PrintImmediate 'Updating DIM_EDW_HFit_HealthAssesmentUserQuestion';
    WITH CTE_HAQ (
         SVR
       , DBNAME
       , ItemID
       , SYS_CHANGE_VERSION) 
        AS (
        SELECT
               SVR
             , DBNAME
             , CT_CMS_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID
             , CT_CMS_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION
               FROM CHANGETABLE (CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTION , @ChangeVersionID) AS CT_CMS_HFIT_HEALTHASSESMENTUSERQUESTION
               WHERE
               SYS_CHANGE_OPERATION = 'U'
        EXCEPT
        SELECT
               SVR
             , DBNAME
             , ItemID
             , LastUpdateID
               FROM DIM_EDW_HFit_HealthAssesmentUserQuestion
        ) 
        UPDATE S
          SET
              S.HAQUESTIONNODEGUID = T.HAQUESTIONNODEGUID
            ,S.CODENAME = T.CODENAME
            ,S.HAQUESTIONSCORE = T.HAQUESTIONSCORE
            ,S.PREWEIGHTEDSCORE = T.PREWEIGHTEDSCORE
            ,S.ISPROFESSIONALLYCOLLECTED = T.ISPROFESSIONALLYCOLLECTED
            ,S.ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
            ,S.HARiskAreaItemID = T.HARiskAreaItemID
            ,S.LastUpdateID = CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION
            ,S.LASTLOADEDDATE = GETDATE () 
            ,S.SVR = T.SVR
            ,S.DBNAME = T.DBNAME
            ,S.DeletedFlg = 0
            ,S.LastModifiedDate = GETDATE () 
              FROM BASE_HFIT_HEALTHASSESMENTUSERQUESTION AS T
                        JOIN DIM_EDW_HFit_HealthAssesmentUserQuestion AS S
                        ON
               S.ItemID = T.ItemID AND
               S.SVR = T.SVR AND
               S.DBNAME = T.DBNAME
                        JOIN CHANGETABLE ( CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTION , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
                        ON
               CT_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID = T.ItemID AND
               S.ItemID = T.ItemID AND
               S.SVR = T.SVR AND
               S.DBNAME = T.DBNAME
               --AND CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION != S.LastUpdateID
               AND
               CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION = 'U'
                        JOIN CTE_HAQ
                        ON
               CTE_HAQ.ItemID = S.ItemID AND
               CTE_HAQ.SVR = S.SVR AND
               CTE_HAQ.DBNAME = S.DBNAME;

    --********************************************************************************************
    -- THIS IS A TABLE CREATED FROM A VIEW WITH A SMALL NUMBER OF ROWS, JUST DROP AND RECREATE.
    --truncate TABLE DIM_EDW_VIEW_HFIT_HACAMPAIGN_JOINED;
    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_VIEW_HFIT_HACAMPAIGN_JOINED';
    EXEC PrintImmediate 'Populating DIM_EDW_VIEW_HFIT_HACAMPAIGN_JOINED';
    -- drop table DIM_EDW_VIEW_HFIT_HACAMPAIGN_JOINED ;
    IF @iCnt = 0
        BEGIN
            -- Select * from DIM_EDW_VIEW_HFIT_HACAMPAIGN_JOINED 
            EXEC PrintImmediate 'Populating DIM_EDW_VIEW_HFIT_HACAMPAIGN_JOINED';
            INSERT INTO DIM_EDW_VIEW_HFIT_HACAMPAIGN_JOINED
            (
                   DOCUMENTCULTURE
                 , HACAMPAIGNID
                 , NODEGUID
                 , NODESITEID
                 , HEALTHASSESSMENTID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
                 , LastModifiedDate) 
            SELECT
                   CAMPAIGN.DOCUMENTCULTURE
                 , CAMPAIGN.HACAMPAIGNID
                 , CAMPAIGN.NODEGUID
                 , CAMPAIGN.NODESITEID
                 , CAMPAIGN.HEALTHASSESSMENTID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , CAMPAIGN.SVR
                 , CAMPAIGN.DBNAME
                 , 0 AS DeletedFlg
                 , GETDATE () AS LastModifiedDate
                   FROM View_HFit_HACampaign_Joined AS CAMPAIGN;
        END;

    --***********************************************************************************
    --select top 100 * from View_HFit_HealthAssessment_Joined
    -- THIS IS A TABLE CREATED FROM A VIEW WITH A SMALL NUMBER OF ROWS, JUST DROP AND RECREATE.
    --truncate TABLE DIM_EDW_VIEW_HFIT_HEALTHASSESSMENT_JOINED;
    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_VIEW_HFIT_HEALTHASSESSMENT_JOINED';
    EXEC PrintImmediate 'Populating DIM_EDW_VIEW_HFIT_HEALTHASSESSMENT_JOINED';
    IF @iCnt = 0
        BEGIN

            EXEC PrintImmediate 'Populating DIM_EDW_VIEW_HFIT_HEALTHASSESSMENT_JOINED';
            INSERT INTO DIM_EDW_VIEW_HFIT_HEALTHASSESSMENT_JOINED
            (
                   NODEGUID
                 , DOCUMENTID
                 , DOCUMENTCULTURE
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg) 
            SELECT
                   HAJOINED.NODEGUID
                 , HAJOINED.DOCUMENTID
                 , HAJOINED.DOCUMENTCULTURE
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , HAJOINED.SVR
                 , HAJOINED.DBNAME
                 , 0 AS DeletedFlg
                   FROM VIEW_HFIT_HEALTHASSESSMENT_JOINED AS HAJOINED;
        END;

    --truncate table DIM_View_EDW_HealthAssesmentQuestions
    EXEC @iCnt = proc_QuickRowCount 'DIM_View_EDW_HealthAssesmentQuestions';
    EXEC PrintImmediate 'Populating DIM_View_EDW_HealthAssesmentQuestions';
    IF @iCnt = 0
        BEGIN

            EXEC PrintImmediate 'Populating DIM_View_EDW_HealthAssesmentQuestions';
            INSERT INTO DIM_View_EDW_HealthAssesmentQuestions
            (
                   TITLE
                 , DOCUMENTCULTURE
                 , NODEGUID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT 
                   DBO.UDF_STRIPHTML ( QUES.TITLE) AS TITLE
                 , QUES.DOCUMENTCULTURE
                 , QUES.NODEGUID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , QUES.SVR
                 , QUES.DBNAME
                 , 0 AS DeletedFlg				    
                   FROM View_EDW_HealthAssesmentQuestions AS QUES;
        END;

    --***********************************************************************************		 		 
    EXEC PrintImmediate 'Populating PI_DIM_HAUserQuestionGroupResults';
    IF NOT EXISTS ( SELECT
                           NAME
                           FROM SYS.INDEXES
                           WHERE
                           NAME = 'PI_DIM_HAUserQuestionGroupResults') 
        BEGIN
            EXEC PrintImmediate 'Populating PI_DIM_HAUserQuestionGroupResults';
            CREATE NONCLUSTERED INDEX PI_DIM_HAUserQuestionGroupResults ON DBO.DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults ( SVR ASC , DBNAME ASC , HARiskAreaItemID ASC) INCLUDE (
            ITEMID
            , POINTRESULTS
            , CODENAME) ;
        END;
    SET ANSI_PADDING ON;
    SET NOCOUNT OFF;
    SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
    EXEC PrintImmediate '**LEAVING Populating Staging Tables: ';

END;
GO
EXEC PrintImmediate 'Executed proc_EDW_UpdateDIMTables.sql';
GO
EXEC PrintImmediate 'RUNNING PROCEDURE proc_EDW_UpdateDIMTables';
GO

--EXEC PrintImmediate 'ERROR ERROR ERROR ERROR ERROR ERROR ERROR ';
PRINT GETDATE () ;
EXEC proc_EDW_UpdateDIMTables;
EXEC PrintImmediate 'COMPLETED RUNNING PROCEDURE proc_EDW_UpdateDIMTables';
PRINT GETDATE () ;

GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_EDW_Create_HA_TempTable.SQL" \n 
--------------------------------------------------------------- 

go
use KenticoCMS_DataMart

GO
PRINT 'Creating proc_EDW_Create_HA_TempTable.sql';
GO

--exec proc_EDW_UpdateDIMTables ;
--go

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_Create_HA_TempTable' )
    BEGIN
        DROP PROCEDURE
             proc_EDW_Create_HA_TempTable;
    END;
GO
--EXEC proc_EDW_Create_HA_TempTable
CREATE PROCEDURE proc_EDW_Create_HA_TempTable
AS
BEGIN

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.tables
                      WHERE name = 'TEMP_EDW_HealthAssessment_DATA' )
        BEGIN
            CREATE TABLE TEMP_EDW_HealthAssessment_DATA
            (
                         UserStartedItemID int  NULL
                         ,HealthAssesmentUserStartedNodeGUID uniqueidentifier  NULL
                         ,UserID bigint  NULL
                         ,UserGUID uniqueidentifier  NULL
                         ,HFitUserMpiNumber bigint  NULL
                         ,SiteGUID uniqueidentifier  NULL
                         ,AccountID int  NULL
                         ,AccountCD nvarchar( 8 ) NULL
                         ,AccountName nvarchar( 200 ) NULL
                         ,HAStartedDt datetime  NULL
                         ,HACompletedDt datetime  NULL
                         ,UserModuleItemId int  NULL
                         ,UserModuleCodeName nvarchar( 100 ) NULL
                         ,HAModuleNodeGUID uniqueidentifier  NULL
                         ,CMSNodeGuid uniqueidentifier  NULL
                         ,HAModuleVersionID int  NULL
                         ,UserRiskCategoryItemID int  NULL
                         ,UserRiskCategoryCodeName nvarchar( 100 ) NULL
                         ,HARiskCategoryNodeGUID uniqueidentifier  NULL
                         ,HARiskCategoryVersionID int  NULL
                         ,UserRiskAreaItemID int  NULL
                         ,UserRiskAreaCodeName nvarchar( 100 ) NULL
                         ,HARiskAreaNodeGUID uniqueidentifier  NULL
                         ,HARiskAreaVersionID int  NULL
                         ,UserQuestionItemID int  NULL
                         ,Title varchar( max ) NULL
                         ,HAQuestionGuid uniqueidentifier  NULL
                         ,UserQuestionCodeName nvarchar( 100 ) NULL
                         ,HAQuestionDocumentID int  NULL
                         ,HAQuestionVersionID int  NULL
                         ,HAQuestionNodeGUID uniqueidentifier  NULL
                         ,UserAnswerItemID int  NULL
                         ,HAAnswerNodeGUID uniqueidentifier  NULL
                         ,HAAnswerVersionID int  NULL
                         ,UserAnswerCodeName nvarchar( 100 ) NULL
                         ,HAAnswerValue nvarchar( 255 ) NULL
                         ,HAModuleScore float  NULL
                         ,HARiskCategoryScore float  NULL
                         ,HARiskAreaScore float  NULL
                         ,HAQuestionScore float  NULL
                         ,HAAnswerPoints int  NULL
                         ,PointResults int  NULL
                         ,UOMCode nvarchar( 10 ) NULL
                         ,HAScore int  NULL
                         ,ModulePreWeightedScore float  NULL
                         ,RiskCategoryPreWeightedScore float  NULL
                         ,RiskAreaPreWeightedScore float  NULL
                         ,QuestionPreWeightedScore float  NULL
                         ,QuestionGroupCodeName nvarchar( 100 ) NULL
                         ,ChangeType nchar( 1 ) NULL
                         ,ItemCreatedWhen datetime  NULL
                         ,ItemModifiedWhen datetime  NULL
                         ,IsProfessionallyCollected bit  NULL
                         ,HARiskCategory_ItemModifiedWhen datetime  NULL
                         ,HAUserRiskArea_ItemModifiedWhen datetime  NULL
                         ,HAUserQuestion_ItemModifiedWhen datetime  NULL
                         ,HAUserAnswers_ItemModifiedWhen datetime  NULL
                         ,HAPaperFlg bit  NULL
                         ,HATelephonicFlg bit  NULL
                         ,HAStartedMode int  NULL
                         ,HACompletedMode int  NULL
                         ,DocumentCulture_VHCJ nvarchar( 10 ) NULL
                         ,DocumentCulture_HAQuestionsView nvarchar( 10 ) NULL
                         ,CampaignNodeGUID uniqueidentifier  NULL
                         ,HACampaignID int  NULL
                         ,HashCode varchar( 100 ) NULL
                         ,PKHASHCODE nvarchar( 100 ) NOT  NULL
                         ,CHANGED_FLG int  NULL
                         ,CT_CMS_User_UserID int  NULL
                         ,CT_CMS_User_CHANGE_OPERATION nchar( 1 ) NULL
                         ,CT_UserSettingsID int  NULL
                         ,CT_UserSettingsID_CHANGE_OPERATION nchar( 1 ) NULL
                         ,SiteID_CtID int  NULL
                         ,SiteID_CHANGE_OPERATION nchar( 1 ) NULL
                         ,UserSiteID_CtID int  NULL
                         ,UserSiteID_CHANGE_OPERATION nchar( 1 ) NULL
                         ,AccountID_CtID int  NULL
                         ,AccountID__CHANGE_OPERATION nchar( 1 ) NULL
                         ,HAUserAnswers_CtID int  NULL
                         ,HAUserAnswers_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserModule_CtID int  NULL
                         ,HFit_HealthAssesmentUserModule_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserQuestion_CtID int  NULL
                         ,HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserQuestionGroupResults_CtID int  NULL
                         ,HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserRiskArea_CtID int  NULL
                         ,HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserRiskCategory_CtID int  NULL
                         ,HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserStarted_CtID int  NULL
                         ,HFit_HealthAssesmentUserStarted_CHANGE_OPERATION nchar( 1 ) NULL
                         ,CT_CMS_User_SCV bigint  NULL
                         ,CT_CMS_UserSettings_SCV bigint  NULL
                         ,CT_CMS_Site_SCV bigint  NULL
                         ,CT_CMS_UserSite_SCV bigint  NULL
                         ,CT_HFit_Account_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserAnswers_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserModule_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserQuestion_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserRiskArea_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserRiskCategory_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserStarted_SCV bigint  NULL
                         ,LastModifiedDate datetime  NULL
                         ,DeleteFlg int  NULL
            );
        END;

/******************************************************************************************************************
IF NOT EXISTS ( SELECT
                        name
                    FROM sys.indexes
                    WHERE name = 'temp_PI_EDW_HealthAssessment_IDs' )
CREATE INDEX temp_PI_EDW_HealthAssessment_IDs ON TEMP_EDW_HealthAssessment_DATA (
UserStartedItemID
, HealthAssesmentUserStartedNodeGUID
, UserGUID
, SiteGUID
, AccountCD
, HAModuleNodeGUID
, CMSNodeGuid
, HARiskCategoryNodeGUID
, UserRiskAreaItemID
, HARiskAreaNodeGUID
, UserQuestionItemID
, HAQuestionGuid
, HAQuestionNodeGUID
, UserAnswerItemID
, HAAnswerNodeGUID
, CampaignNodeGUID
)
INCLUDE ( AccountID , UserModuleItemId , UserRiskCategoryItemID , HASHCODE , LastModifiedDate )
WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
ALLOW_ROW_LOCKS = ON ,
ALLOW_PAGE_LOCKS = ON );
******************************************************************************************************************/

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'temp_PI_EDW_HealthAssessment_ChangeType' )
        BEGIN
            CREATE INDEX temp_PI_EDW_HealthAssessment_ChangeType ON TEMP_EDW_HealthAssessment_DATA ( ChangeType )
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON ,
            ALLOW_PAGE_LOCKS = ON )
        END;

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'temp_PI_EDW_HealthAssessment_NATKEY' )
        BEGIN
            CREATE INDEX temp_PI_EDW_HealthAssessment_NATKEY ON TEMP_EDW_HealthAssessment_DATA (
            UserStartedItemID
            , UserGUID
            , PKHashCode
            , HASHCODE
            )
        END;

END;

GO
PRINT 'Created proc_EDW_Create_HA_TempTable';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_HealthInterestDetail_AddNewRecs.sql" \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HealthInterestDetail_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestDetail_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestDetail_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HealthInterestDetail_AddNewRecs
AS
BEGIN

 WITH CTE_NEW (
             UserID
           , UserGUID
           , HFitUserMpiNumber
           , SiteGUID
           , CoachingHealthInterestID
           , FirstNodeID
           , SecondNodeGuid
           , ThirdNodeGuid) 
            AS ( SELECT
                        UserID
                      , UserGUID
                      , HFitUserMpiNumber
                      , SiteGUID
                      , CoachingHealthInterestID
                      , FirstNodeID
                      , SecondNodeGuid
                      , ThirdNodeGuid
                        FROM ##Temp_HealthInterestDetail
                 EXCEPT
                 SELECT
                        UserID
                      , UserGUID
                      , HFitUserMpiNumber
                      , SiteGUID
                      , CoachingHealthInterestID
                      , FirstNodeID
                      , SecondNodeGuid
                      , ThirdNodeGuid
                        FROM DIM_EDW_HealthInterestDetail
                        WHERE LastModifiedDate IS NULL) 
            INSERT INTO DIM_EDW_HealthInterestDetail
            SELECT
                   S.[UserID]
      ,S.[UserGUID]
      ,S.[HFitUserMpiNumber]
      ,S.[SiteGUID]
      ,S.[CoachingHealthInterestID]
      ,S.[FirstHealthAreaID]
      ,S.[FirstNodeID]
      ,S.[FirstNodeGuid]
      ,S.[FirstHealthAreaName]
      ,S.[FirstHealthAreaDescription]
      ,S.[FirstCodeName]
      ,S.[SecondHealthAreaID]
      ,S.[SecondNodeID]
      ,S.[SecondNodeGuid]
      ,S.[SecondHealthAreaName]
      ,S.[SecondHealthAreaDescription]
      ,S.[SecondCodeName]
      ,S.[ThirdHealthAreaID]
      ,S.[ThirdNodeID]
      ,S.[ThirdNodeGuid]
      ,S.[ThirdHealthAreaName]
      ,S.[ThirdHealthAreaDescription]
      ,S.[ThirdCodeName]
      ,S.[ItemCreatedWhen]
      ,S.[ItemModifiedWhen]
      ,S.[IsDeleted]
      ,S.[HashCode]
      ,S.[SVR]
      ,S.[DBNAME]
                 , NULL AS LastModifiedDate
                 , NULL AS RowNbr
                 , NULL AS DeletedFlg
                 , NULL AS TimeZone
                 , NULL AS ConvertedToCentralTime
                   FROM
                        ##Temp_HealthInterestDetail AS S
                             JOIN CTE_NEW AS C
                             ON
                                S.UserID = C.UserID AND
                                S.UserGUID = C.UserGUID AND
                                S.HFitUserMpiNumber = C.HFitUserMpiNumber AND
                                S.SiteGUID = C.SiteGUID AND
                                S.CoachingHealthInterestID = C.CoachingHealthInterestID AND
                                S.FirstNodeID = C.FirstNodeID AND
                                S.SecondNodeGuid = C.SecondNodeGuid AND
                                S.ThirdNodeGuid = C.ThirdNodeGuid;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestDetail_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_HealthInterestDetail_AddUpdatedRecs.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_HealthInterestDetail_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestDetail_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestDetail_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HealthInterestDetail_AddUpdatedRecs
AS
BEGIN

    DECLARE
        @RUNDATE AS datetime2 ( 7) = GETDATE () ;

        UPDATE S
          SET
              S.UserID = T.UserID
            ,S.UserGUID = T.UserGUID
            ,S.HFitUserMpiNumber = T.HFitUserMpiNumber
            ,S.SiteGUID = T.SiteGUID
            ,S.CoachingHealthInterestID = T.CoachingHealthInterestID
            ,S.FirstHealthAreaID = T.FirstHealthAreaID
            ,S.FirstNodeID = T.FirstNodeID
            ,S.FirstNodeGuid = T.FirstNodeGuid
            ,S.FirstHealthAreaName = T.FirstHealthAreaName
            ,S.FirstHealthAreaDescription = T.FirstHealthAreaDescription
            ,S.FirstCodeName = T.FirstCodeName
            ,S.SecondHealthAreaID = T.SecondHealthAreaID
            ,S.SecondNodeID = T.SecondNodeID
            ,S.SecondNodeGuid = T.SecondNodeGuid
            ,S.SecondHealthAreaName = T.SecondHealthAreaName
            ,S.SecondHealthAreaDescription = T.SecondHealthAreaDescription
            ,S.SecondCodeName = T.SecondCodeName
            ,S.ThirdHealthAreaID = T.ThirdHealthAreaID
            ,S.ThirdNodeID = T.ThirdNodeID
            ,S.ThirdNodeGuid = T.ThirdNodeGuid
            ,S.ThirdHealthAreaName = T.ThirdHealthAreaName
            ,S.ThirdHealthAreaDescription = T.ThirdHealthAreaDescription
            ,S.ThirdCodeName = T.ThirdCodeName
            ,S.ItemCreatedWhen = T.ItemCreatedWhen
            ,S.ItemModifiedWhen = T.ItemModifiedWhen
            ,S.HashCode = T.HashCode
              --,S.DESC1 = T.DESC1
              --,S.DESC2 = T.DESC2
              --,S.DESC3 = T.DESC3
              --,S.[DeletedFlg] = T.[DeletedFlg]
            ,
              S.LastModifiedDate = GETDATE () 
            ,S.ConvertedToCentralTime = NULL
              FROM ##Temp_HealthInterestDetail AS T
                        JOIN
                        DIM_EDW_HealthInterestDetail AS S
                        ON
                        S.UserID = T.UserID AND
                        S.UserGUID = T.UserGUID AND
                        S.HFitUserMpiNumber = T.HFitUserMpiNumber AND
                        S.SiteGUID = T.SiteGUID AND
                        S.CoachingHealthInterestID = T.CoachingHealthInterestID AND
                        S.FirstNodeID = T.FirstNodeID AND
                        S.SecondNodeGuid = T.SecondNodeGuid AND
                        S.ThirdNodeGuid = T.ThirdNodeGuid AND
                        S.HASHCODE != T.HASHCODE AND
                        S.LastModifiedDate IS NULL and S.DeletedFlg is null;
              

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestDetail_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_HealthInterestDetail_AddDeletedRecs.sql" \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HealthInterestDetail_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestDetail_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestDetail_AddDeletedRecs;
    END;
GO
-- exec proc_CT_HealthInterestDetail_AddDeletedRecs
CREATE PROCEDURE proc_CT_HealthInterestDetail_AddDeletedRecs
AS
BEGIN

DECLARE
        @DELDATE AS datetime2 ( 7) = GETDATE () ;
        WITH CTE_DEL (
             UserID
           , UserGUID
           , HFitUserMpiNumber
           , SiteGUID
           , CoachingHealthInterestID
           , FirstNodeID
           , SecondNodeGuid
           , ThirdNodeGuid) 
            AS ( SELECT
                        UserID
                      , UserGUID
                      , HFitUserMpiNumber
                      , SiteGUID
                      , CoachingHealthInterestID
                      , FirstNodeID
                      , SecondNodeGuid
                      , ThirdNodeGuid
                        FROM DIM_EDW_HealthInterestDetail
                 EXCEPT
                 SELECT
                        UserID
                      , UserGUID
                      , HFitUserMpiNumber
                      , SiteGUID
                      , CoachingHealthInterestID
                      , FirstNodeID
                      , SecondNodeGuid
                      , ThirdNodeGuid
                        FROM ##Temp_HealthInterestDetail) 

            UPDATE S
              SET
                  DeletedFlg = 1
                ,LastModifiedDate = @DELDATE
                  FROM DIM_EDW_HealthInterestDetail AS S
                            JOIN
                            CTE_DEL AS C
                            ON
                            S.UserID = C.UserID AND
                            S.UserGUID = C.UserGUID AND
                            S.HFitUserMpiNumber = C.HFitUserMpiNumber AND
                            S.SiteGUID = C.SiteGUID AND
                            S.CoachingHealthInterestID = C.CoachingHealthInterestID AND
                            S.FirstNodeID = C.FirstNodeID AND
                            S.SecondNodeGuid = C.SecondNodeGuid AND
                            S.ThirdNodeGuid = C.ThirdNodeGuid AND
                            S.DeletedFlg IS NULL;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    UPDATE DIM_EDW_HealthInterestDetail
      SET
          LastModifiedDate = GETDATE () 
           WHERE
                 LastModifiedDate IS NULL AND
                 DeletedFlg IS NOT NULL;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestDetail_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_HealthInterestList_AddNewRecs.sql" \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HealthInterestList_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestList_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestList_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HealthInterestList_AddNewRecs
AS
BEGIN

    WITH CTE_NEW (
         HealthAreaID
       , NodeID
       , NodeGuid
       , AccountCD) 
        AS ( SELECT
                    HealthAreaID
                  , NodeID
                  , NodeGuid
                  , AccountCD
                    FROM ##Temp_HealthInterestList
             EXCEPT
             SELECT
                    HealthAreaID
                  , NodeID
                  , NodeGuid
                  , AccountCD
                    FROM DIM_EDW_HealthInterestList
                    WHERE LastModifiedDate IS NULL) 
        INSERT INTO DIM_EDW_HealthInterestList
        SELECT
               T.HealthAreaID
             , T.NodeID
             , T.NodeGuid
             , T.AccountCD
             , T.HealthAreaName
             , T.HealthAreaDescription
             , T.CodeName
             , T.DocumentCreatedWhen
             , T.DocumentModifiedWhen
             , T.HashCode
             , T.SVR
             , T.DBNAME
             , NULL AS LastModifiedDate
             , NULL AS RowNbr
             , NULL AS DeletedFlg
             , NULL AS TimeZone
             , NULL AS ConvertedToCentralTime
               FROM
                    ##Temp_HealthInterestList AS T
                         JOIN CTE_NEW AS C
                         ON
                            T.HealthAreaID = C.HealthAreaID AND
                            T.NodeID = C.NodeID AND
                            T.NodeGuid = C.NodeGuid AND
                            T.AccountCD = C.AccountCD;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestList_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_HealthInterestList_AddUpdatedRecs.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_HealthInterestList_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestList_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestList_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HealthInterestList_AddUpdatedRecs
AS
BEGIN

        DECLARE @RUNDATE AS datetime2 ( 7) = GETDATE () ;

        UPDATE S
          SET
              S.HealthAreaName = T.HealthAreaName
            ,S.HealthAreaDescription = T.HealthAreaDescription
            ,S.CodeName = T.CodeName
            ,S.DocumentCreatedWhen = T.DocumentCreatedWhen
            ,S.DocumentModifiedWhen = T.DocumentModifiedWhen
            ,S.HashCode = T.HashCode
            ,S.LastModifiedDate = GETDATE () 
            ,S.ConvertedToCentralTime = NULL

              FROM ##Temp_HealthInterestList AS T
                        JOIN DIM_EDW_HealthInterestList AS S
                        ON
                        S.HealthAreaID = T.HealthAreaID AND
                        S.NodeID = T.NodeID AND
                        S.NodeGuid = T.NodeGuid AND
                        S.AccountCD = T.AccountCD AND
                        S.HASHCODE != T.HASHCODE AND
                        S.DeletedFlg IS NULL;
 
    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestList_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_HealthInterestList_AddDeletedRecs.sql" \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HealthInterestList_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestList_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestList_AddDeletedRecs;
    END;
GO
-- exec proc_CT_HealthInterestList_AddDeletedRecs
CREATE PROCEDURE proc_CT_HealthInterestList_AddDeletedRecs
AS
BEGIN
      
        WITH CTE_DEL (
             HealthAreaID
           , NodeID
           , NodeGuid
           , AccountCD, DeletedFlg) 
            AS ( SELECT
                        HealthAreaID
                      , NodeID
                      , NodeGuid
                      , AccountCD, DeletedFlg
                        FROM DIM_EDW_HealthInterestList
                 EXCEPT
                 SELECT
                        HealthAreaID
                      , NodeID
                      , NodeGuid
                      , AccountCD, DeletedFlg
                        FROM ##Temp_HealthInterestList) 

            UPDATE S
              SET
                  DeletedFlg = 1
                ,LastModifiedDate = GETDATE () 
                  FROM DIM_EDW_HealthInterestList AS S
                            JOIN CTE_DEL AS C
                            ON
                            S.HealthAreaID = C.HealthAreaID AND
                            S.NodeID = C.NodeID AND
                            isnull(S.NodeGuid,'00000000-0000-0000-0000-000000000000')  = isnull(C.NodeGuid,'00000000-0000-0000-0000-000000000000')  AND
                            S.AccountCD = C.AccountCD AND
                            isnull(S.DeletedFlg,0)  = 0 ;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    UPDATE DIM_EDW_HealthInterestList
      SET
          LastModifiedDate = GETDATE () 
           WHERE
                 LastModifiedDate IS NULL AND
                 DeletedFlg IS NOT NULL;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestList_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "view_EDW_Participant.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Processing: view_EDW_Participant ';
PRINT '***** FROM: view_EDW_Participant.sql';
GO

IF EXISTS (SELECT
           TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
                  WHERE TABLE_NAME = 'view_EDW_Participant') 
    BEGIN
        PRINT 'View exists, dropping to recreate.';
        DROP VIEW
        view_EDW_Participant;
    END;
GO
--select count(*) from view_EDW_Participant
--select top * from view_EDW_Participant where LastModifiedDate between d2 and d2
IF NOT EXISTS (SELECT column_name
                      FROM information_schema.columns
                      WHERE column_name = 'HFitUserIsRegistered'
                        AND table_name = 'FACT_CMS_UserSettings') 
    BEGIN
        ALTER TABLE FACT_CMS_UserSettings
        ADD HFitUserIsRegistered bit NULL;
    END;
GO

CREATE VIEW dbo.view_EDW_Participant
AS
--*********************************************************************************************
--WDM Reviewed 8/6/2014 for needed updates, none required
--09.11.2014 (wdm) added date fields to facilitate EDW determination of last mod date 
--05.06.2015 (wdm) added HFitUserPreferredEmail to the view to resolve 52888 per a 
--				conversation with Vijay, Shankar, and John K.
--05.15.2015 (WDM) John and I, while working on this item, found the story has been removed ??? No idea why.
--05.15.2015 (WDM) CUS.HFitUserRegistrationDate (52189)  The contract (story) was removed by Vijay causing John and I to miss this one. We luckily caught it today and fixed the missing columns
--05.15.2015 (WDM) CUS.HFitUserIsRegistered  (52189)	  The contract (story) was removed by Vijay causing John and I to miss this one. We luckily caught it today and fixed the missing columns
--*********************************************************************************************

SELECT
    cus.HFitUserMpiNumber
    , cu.UserID
    , cu.UserGUID
    , CS.SiteGUID
    , hfa.AccountID
    , hfa.AccountCD
    , cus.HFitUserPreferredMailingAddress
    , cus.HFitUserPreferredMailingCity
    , cus.HFitUserPreferredMailingState
    , cus.HFitUserPreferredMailingPostalCode
    , CAST (cus.HFitCoachingEnrollDate AS datetime) AS HFitCoachingEnrollDate
    , cus.HFitUserAltPreferredPhone
    , cus.HFitUserAltPreferredPhoneExt
    , cus.HFitUserAltPreferredPhoneType
    , cus.HFitUserPreferredPhone
    , cus.HFitUserPreferredFirstName
    , CUS.HFitUserPreferredEmail
    , CAST (CUS.HFitUserRegistrationDate AS datetime2) AS HFitUserRegistrationDate
    , CUS.HFitUserIsRegistered
    , CASE
		WHEN CAST (cu.UserCreated AS date) = CAST (cu.UserLastModified AS date) 
		    THEN 'I'
		ELSE 'U'
	 END AS ChangeType
    , CAST (cu.UserCreated AS datetime) AS User_Created
    , CAST (cu.UserLastModified AS datetime) AS User_LastModified
    , CAST (HFA.ItemModifiedWhen AS datetime) AS Account_LastModified	--wdm: 09.11.2014 added to view
    , CUS2.LASTMODIFIEDDATE AS UserSite_LastModified
    , CS.LASTMODIFIEDDATE AS Site_LastModified
    , CUS.LASTMODIFIEDDATE AS UserSettings_LastModified
    , (SELECT MAX (LASTMODIFIEDDATE) 
			   FROM (VALUES (
						 CUS.LASTMODIFIEDDATE) , (
						 CS.LASTMODIFIEDDATE) , (
						 CUS2.LASTMODIFIEDDATE) , (
						 HFA.ItemModifiedWhen) , (
						 cu.UserLastModified)) AS LastModDate) AS LastModifiedDate
       FROM
           dbo.FACT_CMS_User AS CU
               INNER JOIN dbo.FACT_CMS_UserSite AS CUS2 WITH (NOLOCK) 
                   ON CU.UserID = CUS2.UserID
                  AND CU.DBNAME = CUS2.DBNAME
                  AND CU.SVR = CUS2.SVR
               INNER JOIN dbo.FACT_HFit_Account AS HFA WITH (NOLOCK) 
                   ON cus2.SiteID = hfa.SiteID
                  AND cus2.DBNAME = hfa.DBNAME
                  AND cus2.SVR = hfa.SVR
               INNER JOIN dbo.FACT_CMS_Site AS CS WITH (NOLOCK) 
                   ON CUS2.SiteID = CS.SiteID
                  AND cus2.DBNAME = CS.DBNAME
                  AND cus2.SVR = CS.SVR
               INNER JOIN dbo.FACT_CMS_UserSettings AS CUS WITH (NOLOCK) 
                   ON CU.UserID = CUS.UserSettingsUserID
                  AND CUS.HFitUserMpiNumber > 0
                  AND CUS.HFitUserMpiNumber IS NOT NULL
                  AND CU.DBNAME = CUS.DBNAME
                  AND CU.SVR = CUS.SVR;
GO

IF NOT EXISTS (SELECT name
                      FROM sys.indexes
                      WHERE name = 'CI_FACT_cms_usersettings02') 
    BEGIN
        PRINT 'Created/Updated: CI_FACT_cms_usersettings02';
        CREATE NONCLUSTERED INDEX CI_FACT_cms_usersettings02
        ON dbo.FACT_cms_usersettings (HFitUserMpiNumber) 
        INCLUDE (UserSettingsUserID, HFitUserPreferredEmail, HFitUserPreferredPhone, HFitUserPreferredFirstName, HfitUserPreferredMailingAddress, HfitUserPreferredMailingCity, HfitUserPreferredMailingState, HfitUserPreferredMailingPostalCode, HFitCoachingEnrollDate, HFitUserAltPreferredPhone, HFitUserAltPreferredPhoneType, HFitUserAltPreferredPhoneExt, HFitUserRegistrationDate, HFitUserIsRegistered, LASTMODIFIEDDATE, SVR, DBNAME) ;
    END;

IF NOT EXISTS (SELECT name
                      FROM sys.indexes
                      WHERE name = 'CI_FACT_cms_usersettings03') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_FACT_cms_usersettings03
        ON dbo.FACT_cms_user (UserID, SVR, DBNAME) 
        INCLUDE (UserCreated, UserGUID, UserLastModified) ;
    END;
GO
IF NOT EXISTS (SELECT name
                      FROM sys.indexes
                      WHERE name = 'CI_FACT_cms_usersettings04') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_FACT_cms_usersettings04
        ON dbo.FACT_cms_usersettings (UserSettingsUserID, SVR, DBNAME, HFitUserMpiNumber) 
        INCLUDE (HFitUserPreferredEmail, HFitUserPreferredPhone, HFitUserPreferredFirstName, HfitUserPreferredMailingAddress, HfitUserPreferredMailingCity, HfitUserPreferredMailingState, HfitUserPreferredMailingPostalCode, HFitCoachingEnrollDate, HFitUserAltPreferredPhone, HFitUserAltPreferredPhoneType, HFitUserAltPreferredPhoneExt, HFitUserRegistrationDate, HFitUserIsRegistered, LASTMODIFIEDDATE) ;
    END;
GO
PRINT 'Created/Updated: view_EDW_Participant ';
PRINT '***** FROM: view_EDW_Participant.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "view_EDW_Participant_CT.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Processing: view_EDW_Participant_CT ';
PRINT '***** FROM: view_EDW_Participant_CT.sql';
GO

IF EXISTS ( SELECT
                   TABLE_NAME
              FROM INFORMATION_SCHEMA.VIEWS
              WHERE TABLE_NAME = 'view_EDW_Participant_CT' )
    BEGIN
        PRINT 'View exists, dropping to recreate.';
        DROP VIEW
             view_EDW_Participant_CT;
    END;
GO
--select top 300 * from view_EDW_Participant_CT where CHANGED_FLG is not null
-- select count(*) from view_EDW_Participant_CT
CREATE VIEW dbo.view_EDW_Participant_CT
AS
--*********************************************************************************************
--WDM Reviewed 8/6/2014 for needed updates, none required
--09.11.2014 (wdm) added date fields to facilitate EDW determination of last mod date 
--05.06.2015 (wdm) added HFitUserPreferredEmail to the view to resolve 52888 per a 
--				conversation with Vijay, Shankar, and John K.
--05.15.2015 (WDM) John and I, while working on this item, found the story has been removed ??? No idea why.
--05.15.2015 (WDM) CUS.HFitUserRegistrationDate (52189)  The contract (story) was removed by Vijay causing John and I to miss this one. We luckily caught it today and fixed the missing columns
--05.15.2015 (WDM) CUS.HFitUserIsRegistered  (52189)	  The contract (story) was removed by Vijay causing John and I to miss this one. We luckily caught it today and fixed the missing columns
--*********************************************************************************************

/*
Natural Key:
    [UserID]
    ,[UserGUID]
    ,[SiteGUID]
    ,[AccountID]
    ,[AccountCD]   
*/

SELECT  
       cus.HFitUserMpiNumber
       ,cu.UserID
       ,cu.UserGUID
       ,CS.SiteGUID
       ,hfa.AccountID
       ,hfa.AccountCD
       ,cus.HFitUserPreferredMailingAddress
       ,cus.HFitUserPreferredMailingCity
       ,cus.HFitUserPreferredMailingState
       ,cus.HFitUserPreferredMailingPostalCode
       ,CAST ( cus.HFitCoachingEnrollDate AS datetime ) AS HFitCoachingEnrollDate
       ,cus.HFitUserAltPreferredPhone
       ,cus.HFitUserAltPreferredPhoneExt
       ,cus.HFitUserAltPreferredPhoneType
       ,cus.HFitUserPreferredPhone
       ,cus.HFitUserPreferredFirstName
       ,CUS.HFitUserPreferredEmail
       ,CAST( CUS.HFitUserRegistrationDate AS datetime2 )	AS HFitUserRegistrationDate
       ,CUS.HFitUserIsRegistered
       ,CASE
        WHEN CAST ( cu.UserCreated AS date ) = CAST ( cu.UserLastModified AS date )
        THEN 'I'
            ELSE 'U'
        END AS ChangeType
       ,CAST ( cu.UserCreated AS datetime ) AS UserCreated
       ,CAST ( cu.UserLastModified AS datetime ) AS UserLastModified
       ,CAST ( HFA.ItemModifiedWhen AS datetime ) AS Account_ItemModifiedWhen	--wdm: 09.11.2014 added to view

       ,CAST( HASHBYTES( 'sha1' ,
			 ISNULL( CAST( cus.HFitUserMpiNumber AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cu.UserID AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cu.UserGUID AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( CS.SiteGUID AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( hfa.AccountID AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( hfa.AccountCD AS nvarchar( 50 )) , '-' ) +
			 ISNULL( cus.HFitUserPreferredMailingAddress , '-' ) +
			 ISNULL( cus.HFitUserPreferredMailingCity , '-' ) +
			 ISNULL( cus.HFitUserPreferredMailingState , '-' ) +
			 ISNULL( CAST( cus.HFitUserPreferredMailingPostalCode AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitCoachingEnrollDate  AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitUserAltPreferredPhone AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitUserAltPreferredPhoneExt AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitUserAltPreferredPhoneType AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitUserPreferredPhone AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitUserPreferredFirstName AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( CUS.HFitUserPreferredEmail AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( CUS.HFitUserRegistrationDate AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( CUS.HFitUserIsRegistered AS nvarchar( 50 )) , '-' )
       ) AS nvarchar( 100 )) AS HashCode
       , COALESCE ( 
		  CT_CMS_User.SYS_CHANGE_OPERATION
		  ,CT_CMS_UserSettings.SYS_CHANGE_OPERATION
		  ,CT_HFit_Account.SYS_CHANGE_OPERATION
		  ,CT_CMS_Site.SYS_CHANGE_OPERATION
		  ,CT_CMS_UserSettings.SYS_CHANGE_OPERATION) AS CHANGED_FLG
    , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	   FROM
		  dbo.FACT_CMS_User AS CU 
		  INNER JOIN dbo.FACT_CMS_UserSite AS CMSUS WITH ( NOLOCK )
                          ON CU.UserID = CMSUS.UserID
				        and CU.DBNAME = CMSUS.DBNAME
					   and CU.SVR = CMSUS.SVR
		  INNER JOIN dbo.FACT_HFit_Account AS HFA WITH ( NOLOCK )
                          ON CMSUS.SiteID = hfa.SiteID
					   and CMSUS.DBNAME = hfa.DBNAME
					   and CMSUS.SVR = hfa.SVR
		  INNER JOIN dbo.FACT_CMS_Site AS CS WITH ( NOLOCK )
                          ON CMSUS.SiteID = CS.SiteID
					   and CMSUS.DBNAME = CS.DBNAME
					   and CMSUS.SVR = CS.SVR
		  INNER JOIN dbo.FACT_CMS_UserSettings AS CUS WITH ( NOLOCK )
                          ON CU.UserID = CUS.UserSettingsUserID
					   and CUS.HFitUserMpiNumber > 0 and CUS.HFitUserMpiNumber is not null
					   and CU.DBNAME = CUS.DBNAME
					   and CU.SVR = CUS.SVR
		  LEFT JOIN CHANGETABLE(CHANGES FACT_CMS_User , NULL)AS CT_CMS_User
			 ON CU.UserID = CT_CMS_User.UserID 
			 AND CU.SVR = CT_CMS_User.SVR
			 AND CU.DBNAME = CT_CMS_User.DBNAME
		  LEFT JOIN CHANGETABLE(CHANGES FACT_CMS_UserSite , NULL) AS CT_CMS_UserSite
			 ON CMSUS.UserSiteID = CT_CMS_UserSite.UserSiteID
			 AND CMSUS.SVR = CT_CMS_UserSite.SVR
			 AND CMSUS.DBNAME = CT_CMS_UserSite.DBNAME
		  LEFT JOIN CHANGETABLE(CHANGES FACT_HFit_Account , NULL)AS CT_HFit_Account
			 ON HFA.AccountID = CT_HFit_Account.AccountID
			 AND HFA.SVR = CT_HFit_Account.SVR
			 AND HFA.DBNAME = CT_HFit_Account.DBNAME
		  LEFT JOIN CHANGETABLE(CHANGES FACT_CMS_Site , NULL)AS CT_CMS_Site
			 ON CS.SiteID = CT_CMS_Site.SiteID
			 			 AND CS.SVR = CT_CMS_Site.SVR
			 AND CS.DBNAME = CT_CMS_Site.DBNAME
		  LEFT JOIN CHANGETABLE(CHANGES FACT_CMS_UserSettings , NULL)AS CT_CMS_UserSettings
			 ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
			 			 AND CUS.SVR = CT_CMS_UserSettings.SVR
			 AND CUS.DBNAME = CT_CMS_UserSettings.DBNAME
GO

--  
--  
GO
PRINT 'Created/Updated: view_EDW_Participant_CT ';
PRINT '***** FROM: view_EDW_Participant_CT.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_RewardTriggerParameters_AddUpdatedRecs.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_RewardTriggerParameters_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardTriggerParameters_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardTriggerParameters_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardTriggerParameters_AddUpdatedRecs
AS
BEGIN

    DECLARE
       @RUNDATE AS  datetime2 ( 7 ) = GETDATE ( );

       UPDATE S
              SET
                  S.SiteGUID = T.SiteGUID
                  ,S.RewardTriggerID = T.RewardTriggerID
                  ,S.TriggerName = T.TriggerName
                  ,S.RewardTriggerParameterOperatorLKPDisplayName = T.RewardTriggerParameterOperatorLKPDisplayName
                  ,S.ParameterDisplayName = T.ParameterDisplayName
                  ,S.RewardTriggerParameterOperator = T.RewardTriggerParameterOperator
                  ,S.Value = T.Value
                  ,S.AccountID = T.AccountID
                  ,S.AccountCD = T.AccountCD
                  ,S.ChangeType = T.ChangeType
                  ,S.DocumentGuid = T.DocumentGuid
                  ,S.NodeGuid = T.NodeGuid
                  ,S.DocumentCreatedWhen = T.DocumentCreatedWhen
                  ,S.DocumentModifiedWhen = T.DocumentModifiedWhen
                  ,S.RewardTriggerParameter_DocumentModifiedWhen = T.RewardTriggerParameter_DocumentModifiedWhen
                  ,S.documentculture_VHFRTPJ = T.documentculture_VHFRTPJ
                  ,S.documentculture_VHFRTJ = T.documentculture_VHFRTJ
                  ,S.HashCode = T.HashCode
                  ,S.LastModifiedDate = GETDATE ( )
                  ,S.DeletedFlg = NULL
                  ,S.ConvertedToCentralTime = NULL

              FROM DIM_EDW_RewardTriggerParameters AS S JOIN ##TEMP_RewardTriggerParameters AS T
                   ON
                   S.SiteGUID = T.SiteGUID
               AND S.RewardTriggerID = T.RewardTriggerID
               AND S.ParameterDisplayName = T.ParameterDisplayName
               AND S.RewardTriggerParameterOperator = T.RewardTriggerParameterOperator
               AND S.Value = T.Value
               AND S.AccountID = T.AccountID
               AND S.AccountCD = T.AccountCD
               AND S.DocumentGuid = T.DocumentGuid
               AND S.NodeGuid = T.NodeGuid
              WHERE
                            S.HashCode != T.HashCode and S.DeletedFlg is null;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardTriggerParameters_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_RewardTriggerParameters_AddDeletedRecs.sql" \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_RewardTriggerParameters_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardTriggerParameters_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardTriggerParameters_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardTriggerParameters_AddDeletedRecs
AS
BEGIN

    WITH CTE (
         SiteGUID
       , RewardTriggerID
       , ParameterDisplayName
       , RewardTriggerParameterOperator
       , [Value]
       , AccountID
       , AccountCD
       , DocumentGuid
       , NodeGuid) 
        AS (
        SELECT
               SiteGUID
             , RewardTriggerID
             , ParameterDisplayName
             , RewardTriggerParameterOperator
             , [Value]
             , AccountID
             , AccountCD
             , DocumentGuid
             , NodeGuid
               FROM DIM_EDW_RewardTriggerParameters
        EXCEPT
        SELECT
               SiteGUID
             , RewardTriggerID
             , ParameterDisplayName
             , RewardTriggerParameterOperator
             , [Value]
             , AccountID
             , AccountCD
             , DocumentGuid
             , NodeGuid
               FROM ##TEMP_RewardTriggerParameters
        ) 
        UPDATE S
          SET
              S.DeletedFlg = 1
              FROM CTE AS T
                        JOIN DIM_EDW_RewardTriggerParameters AS S
                        ON
                        S.SiteGUID = T.SiteGUID AND
                        S.RewardTriggerID = T.RewardTriggerID AND
                        S.ParameterDisplayName = T.ParameterDisplayName AND
                        S.RewardTriggerParameterOperator = T.RewardTriggerParameterOperator AND
                        S.Value = T.Value AND
                        S.AccountID = T.AccountID AND
                        S.AccountCD = T.AccountCD AND
                        S.DocumentGuid = T.DocumentGuid AND
                        S.NodeGuid = T.NodeGuid AND
                        S.DeletedFlg IS NULL;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    UPDATE DIM_EDW_RewardTriggerParameters
      SET
          LastModifiedDate = GETDATE () 
           WHERE
                 LastModifiedDate IS NULL AND
                 DeletedFlg IS NOT NULL;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardTriggerParameters_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_RewardTriggerParameters_AddNewRecs.sql" \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_RewardTriggerParameters_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardTriggerParameters_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardTriggerParameters_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardTriggerParameters_AddNewRecs
AS
BEGIN

    WITH CTE (
         SiteGUID
       , RewardTriggerID
       , ParameterDisplayName
       , RewardTriggerParameterOperator
       , [Value]
       , AccountID
       , AccountCD
       , DocumentGuid
       , NodeGuid
    ) 
        AS (
        SELECT
               SiteGUID
             , RewardTriggerID
             , ParameterDisplayName
             , RewardTriggerParameterOperator
             , [Value]
             , AccountID
             , AccountCD
             , DocumentGuid
             , NodeGuid
               FROM ##TEMP_RewardTriggerParameters
        EXCEPT
        SELECT
               SiteGUID
             , RewardTriggerID
             , ParameterDisplayName
             , RewardTriggerParameterOperator
             , [Value]
             , AccountID
             , AccountCD
             , DocumentGuid
             , NodeGuid
               FROM DIM_EDW_RewardTriggerParameters
               WHERE LastModifiedDate IS NULL
        ) 
        INSERT INTO dbo.DIM_EDW_RewardTriggerParameters
        (
               SiteGUID
             , RewardTriggerID
             , TriggerName
             , RewardTriggerParameterOperatorLKPDisplayName
             , ParameterDisplayName
             , RewardTriggerParameterOperator
             , [Value]
             , AccountID
             , AccountCD
             , ChangeType
             , DocumentGuid
             , NodeGuid
             , DocumentCreatedWhen
             , DocumentModifiedWhen
             , RewardTriggerParameter_DocumentModifiedWhen
             , documentculture_VHFRTPJ
             , documentculture_VHFRTJ
             , HashCode
             , LastModifiedDate
             , DeletedFlg
        ) 
        SELECT
               T.SiteGUID
             , T.RewardTriggerID
             , T.TriggerName
             , T.RewardTriggerParameterOperatorLKPDisplayName
             , T.ParameterDisplayName
             , T.RewardTriggerParameterOperator
             , T.[Value]
             , T.AccountID
             , T.AccountCD
             , T.ChangeType
             , T.DocumentGuid
             , T.NodeGuid
             , T.DocumentCreatedWhen
             , T.DocumentModifiedWhen
             , T.RewardTriggerParameter_DocumentModifiedWhen
             , T.documentculture_VHFRTPJ
             , T.documentculture_VHFRTJ
             , T.HashCode
             , NULL AS LastModifiedDate
             , NULL AS DeletedFlg
               FROM
                    ##TEMP_RewardTriggerParameters AS T
                         JOIN CTE AS S
                         ON
                            S.SiteGUID = T.SiteGUID AND
                            S.RewardTriggerID = T.RewardTriggerID AND
                            S.ParameterDisplayName = T.ParameterDisplayName AND
                            S.RewardTriggerParameterOperator = T.RewardTriggerParameterOperator AND
                            S.Value = T.Value AND
                            S.AccountID = T.AccountID AND
                            S.AccountCD = T.AccountCD AND
                            S.DocumentGuid = T.DocumentGuid AND
                            S.NodeGuid = T.NodeGuid;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardTriggerParameters_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_HA_Definition_AddUpdatedRecs.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_HA_Definition_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HA_Definition_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_Definition_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HA_Definition_AddUpdatedRecs
AS
BEGIN

    DECLARE
       @RUNDATE AS  datetime2 ( 7 ) = GETDATE ( );

            UPDATE S
              SET
                  S.SiteGUID = T.SiteGUID
                ,S.AccountCD = T.AccountCD
                ,S.HANodeID = T.HANodeID
                ,S.HANodeName = T.HANodeName
                ,S.HADocumentID = T.HADocumentID
                ,S.HANodeSiteID = T.HANodeSiteID
                ,S.HADocPubVerID = T.HADocPubVerID
                ,S.ModTitle = T.ModTitle
                ,S.IntroText = T.IntroText
                ,S.ModDocGuid = T.ModDocGuid
                ,S.ModWeight = T.ModWeight
                ,S.ModIsEnabled = T.ModIsEnabled
                ,S.ModCodeName = T.ModCodeName
                ,S.ModDocPubVerID = T.ModDocPubVerID
                ,S.RCTitle = T.RCTitle
                ,S.RCWeight = T.RCWeight
                ,S.RCDocumentGUID = T.RCDocumentGUID
                ,S.RCIsEnabled = T.RCIsEnabled
                ,S.RCCodeName = T.RCCodeName
                ,S.RCDocPubVerID = T.RCDocPubVerID
                ,S.RATytle = T.RATytle
                ,S.RAWeight = T.RAWeight
                ,S.RADocumentGuid = T.RADocumentGuid
                ,S.RAIsEnabled = T.RAIsEnabled
                ,S.RACodeName = T.RACodeName
                ,S.RAScoringStrategyID = T.RAScoringStrategyID
                ,S.RADocPubVerID = T.RADocPubVerID
                ,S.QuestionType = T.QuestionType
                ,S.QuesTitle = T.QuesTitle
                ,S.QuesWeight = T.QuesWeight
                ,S.QuesIsRequired = T.QuesIsRequired
                ,S.QuesDocumentGuid = T.QuesDocumentGuid
                ,S.QuesIsEnabled = T.QuesIsEnabled
                ,S.QuesIsVisible = T.QuesIsVisible
                ,S.QuesIsSTaging = T.QuesIsSTaging
                ,S.QuestionCodeName = T.QuestionCodeName
                ,S.QuesDocPubVerID = T.QuesDocPubVerID
                ,S.AnsValue = T.AnsValue
                ,S.AnsPoints = T.AnsPoints
                ,S.AnsDocumentGuid = T.AnsDocumentGuid
                ,S.AnsIsEnabled = T.AnsIsEnabled
                ,S.AnsCodeName = T.AnsCodeName
                ,S.AnsUOM = T.AnsUOM
                ,S.AnsDocPUbVerID = T.AnsDocPUbVerID
                ,S.ChangeType = T.ChangeType
                ,S.DocumentCreatedWhen = T.DocumentCreatedWhen
                ,S.DocumentModifiedWhen = T.DocumentModifiedWhen
                ,S.CmsTreeNodeGuid = T.CmsTreeNodeGuid
                ,S.HANodeGUID = T.HANodeGUID
                ,S.SiteLastModified = T.SiteLastModified
                ,S.Account_ItemModifiedWhen = T.Account_ItemModifiedWhen
                ,S.Campaign_DocumentModifiedWhen = T.Campaign_DocumentModifiedWhen
                ,S.Assessment_DocumentModifiedWhen = T.Assessment_DocumentModifiedWhen
                ,S.Module_DocumentModifiedWhen = T.Module_DocumentModifiedWhen
                ,S.RiskCategory_DocumentModifiedWhen = T.RiskCategory_DocumentModifiedWhen
                ,S.RiskArea_DocumentModifiedWhen = T.RiskArea_DocumentModifiedWhen
                ,S.Question_DocumentModifiedWhen = T.Question_DocumentModifiedWhen
                ,S.Answer_DocumentModifiedWhen = T.Answer_DocumentModifiedWhen
                ,S.AllowMultiSelect = T.AllowMultiSelect
                ,S.LocID = T.LocID
                ,S.CMS_Class_CtID = T.CMS_Class_CtID
                ,S.CMS_Class_SCV = T.CMS_Class_SCV
                ,S.CMS_Document_CtID = T.CMS_Document_CtID
                ,S.CMS_Document_SCV = T.CMS_Document_SCV
                ,S.CMS_Site_CtID = T.CMS_Site_CtID
                ,S.CMS_Site_SCV = T.CMS_Site_SCV
                ,S.CMS_Tree_CtID = T.CMS_Tree_CtID
                ,S.CMS_Tree_SCV = T.CMS_Tree_SCV
                ,S.CMS_User_CtID = T.CMS_User_CtID
                ,S.CMS_User_SCV = T.CMS_User_SCV
                ,S.COM_SKU_CtID = T.COM_SKU_CtID
                ,S.COM_SKU_SCV = T.COM_SKU_SCV
                ,S.HFit_HealthAssesmentMatrixQuestion_CtID = T.HFit_HealthAssesmentMatrixQuestion_CtID
                ,S.HFit_HealthAssesmentMatrixQuestion_SCV = T.HFit_HealthAssesmentMatrixQuestion_SCV
                ,S.HFit_HealthAssesmentModule_CtID = T.HFit_HealthAssesmentModule_CtID
                ,S.HFit_HealthAssesmentModule_SCV = T.HFit_HealthAssesmentModule_SCV
                ,S.HFit_HealthAssesmentMultipleChoiceQuestion_CtID = T.HFit_HealthAssesmentMultipleChoiceQuestion_CtID
                ,S.HFit_HealthAssesmentMultipleChoiceQuestion_SCV = T.HFit_HealthAssesmentMultipleChoiceQuestion_SCV
                ,S.HFit_HealthAssesmentRiskArea_CtID = T.HFit_HealthAssesmentRiskArea_CtID
                ,S.HFit_HealthAssesmentRiskArea_SCV = T.HFit_HealthAssesmentRiskArea_SCV
                ,S.HFit_HealthAssesmentRiskCategory_CtID = T.HFit_HealthAssesmentRiskCategory_CtID
                ,S.HFit_HealthAssesmentRiskCategory_SCV = T.HFit_HealthAssesmentRiskCategory_SCV
                ,S.HFit_HealthAssessment_CtID = T.HFit_HealthAssessment_CtID
                ,S.HFit_HealthAssessment_SCV = T.HFit_HealthAssessment_SCV
                ,S.HFit_HealthAssessmentFreeForm_CtID = T.HFit_HealthAssessmentFreeForm_CtID
                ,S.HFit_HealthAssessmentFreeForm_SCV = T.HFit_HealthAssessmentFreeForm_SCV
                ,S.CMS_Class_CHANGE_OPERATION = T.CMS_Class_CHANGE_OPERATION
                ,S.CMS_Document_CHANGE_OPERATION = T.CMS_Document_CHANGE_OPERATION
                ,S.CMS_Site_CHANGE_OPERATION = T.CMS_Site_CHANGE_OPERATION
                ,S.CMS_Tree_CHANGE_OPERATION = T.CMS_Tree_CHANGE_OPERATION
                ,S.CMS_User_CHANGE_OPERATION = T.CMS_User_CHANGE_OPERATION
                ,S.COM_SKU_CHANGE_OPERATION = T.COM_SKU_CHANGE_OPERATION
                ,S.HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION = T.HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
                ,S.HFit_HealthAssesmentModule_CHANGE_OPERATION = T.HFit_HealthAssesmentModule_CHANGE_OPERATION
                ,S.HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION = T.HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
                ,S.HFit_HealthAssesmentRiskArea_CHANGE_OPERATION = T.HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
                ,S.HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION = T.HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
                ,S.HFit_HealthAssessment_CHANGE_OPERATION = T.HFit_HealthAssessment_CHANGE_OPERATION
                ,S.HFit_HealthAssessmentFreeForm_CHANGE_OPERATION = T.HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
                ,S.CHANGED_FLG = T.CHANGED_FLG
                ,S.CHANGE_TYPE_CODE = T.CHANGE_TYPE_CODE
                ,S.HashCode = T.HashCode
                ,S.LastModifiedDate = GETDATE () 
                ,S.DeletedFlg = NULL
                ,S.ConvertedToCentralTime = NULL
                  FROM STAGING_EDW_HA_Definition AS S
                            JOIN ##TEMP_EDW_HealthDefinition_DATA AS T
                            ON
                            S.RCDocumentGuid = T.RCDocumentGuid AND
                            S.RADocumentGuid = T.RADocumentGuid AND
                            S.RACodeName = T.RACodeName AND
                            S.QuesDocumentGuid = T.QuesDocumentGuid AND
                            S.AnsDocumentGuid = T.AnsDocumentGuid AND
                            S.HANodeSiteID = T.HANodeSiteID
              WHERE
                            S.HashCode != T.HashCode and S.DeletedFlg is null;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HA_Definition_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_HA_Definition_AddNewRecs.sql" \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HA_Definition_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HA_Definition_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_Definition_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HA_Definition_AddNewRecs
AS
BEGIN

WITH CTE (
                 RCDocumentGuid
               , RADocumentGuid
               , RACodeName
               , QuesDocumentGuid
               , AnsDocumentGuid
               , HANodeSiteID) 
                AS ( SELECT
                            RCDocumentGuid
                          , RADocumentGuid
                          , RACodeName
                          , QuesDocumentGuid
                          , AnsDocumentGuid
                          , HANodeSiteID
                            FROM ##TEMP_EDW_HealthDefinition_DATA
                     EXCEPT
                     SELECT
                            RCDocumentGuid
                          , RADocumentGuid
                          , RACodeName
                          , QuesDocumentGuid
                          , AnsDocumentGuid
                          , HANodeSiteID
                     --HANodeID
                     --HADocumentID
                     --RCDocPubVerID
                     --QuesDocPubVerID
                            FROM STAGING_EDW_HA_Definition
                            WHERE LastModifiedDate IS NULL) 
                INSERT INTO dbo.STAGING_EDW_HA_Definition (
                       SiteGUID
                     , AccountCD
                     , HANodeID
                     , HANodeName
                     , HADocumentID
                     , HANodeSiteID
                     , HADocPubVerID
                     , ModTitle
                     , IntroText
                     , ModDocGuid
                     , ModWeight
                     , ModIsEnabled
                     , ModCodeName
                     , ModDocPubVerID
                     , RCTitle
                     , RCWeight
                     , RCDocumentGUID
                     , RCIsEnabled
                     , RCCodeName
                     , RCDocPubVerID
                     , RATytle
                     , RAWeight
                     , RADocumentGuid
                     , RAIsEnabled
                     , RACodeName
                     , RAScoringStrategyID
                     , RADocPubVerID
                     , QuestionType
                     , QuesTitle
                     , QuesWeight
                     , QuesIsRequired
                     , QuesDocumentGuid
                     , QuesIsEnabled
                     , QuesIsVisible
                     , QuesIsSTaging
                     , QuestionCodeName
                     , QuesDocPubVerID
                     , AnsValue
                     , AnsPoints
                     , AnsDocumentGuid
                     , AnsIsEnabled
                     , AnsCodeName
                     , AnsUOM
                     , AnsDocPUbVerID
                     , ChangeType
                     , DocumentCreatedWhen
                     , DocumentModifiedWhen
                     , CmsTreeNodeGuid
                     , HANodeGUID
                     , SiteLastModified
                     , Account_ItemModifiedWhen
                     , Campaign_DocumentModifiedWhen
                     , Assessment_DocumentModifiedWhen
                     , Module_DocumentModifiedWhen
                     , RiskCategory_DocumentModifiedWhen
                     , RiskArea_DocumentModifiedWhen
                     , Question_DocumentModifiedWhen
                     , Answer_DocumentModifiedWhen
                     , AllowMultiSelect
                     , LocID
                     , CMS_Class_CtID
                     , CMS_Class_SCV
                     , CMS_Document_CtID
                     , CMS_Document_SCV
                     , CMS_Site_CtID
                     , CMS_Site_SCV
                     , CMS_Tree_CtID
                     , CMS_Tree_SCV
                     , CMS_User_CtID
                     , CMS_User_SCV
                     , COM_SKU_CtID
                     , COM_SKU_SCV
                     , HFit_HealthAssesmentMatrixQuestion_CtID
                     , HFit_HealthAssesmentMatrixQuestion_SCV
                     , HFit_HealthAssesmentModule_CtID
                     , HFit_HealthAssesmentModule_SCV
                     , HFit_HealthAssesmentMultipleChoiceQuestion_CtID
                     , HFit_HealthAssesmentMultipleChoiceQuestion_SCV
                     , HFit_HealthAssesmentRiskArea_CtID
                     , HFit_HealthAssesmentRiskArea_SCV
                     , HFit_HealthAssesmentRiskCategory_CtID
                     , HFit_HealthAssesmentRiskCategory_SCV
                     , HFit_HealthAssessment_CtID
                     , HFit_HealthAssessment_SCV
                     , HFit_HealthAssessmentFreeForm_CtID
                     , HFit_HealthAssessmentFreeForm_SCV
                     , CMS_Class_CHANGE_OPERATION
                     , CMS_Document_CHANGE_OPERATION
                     , CMS_Site_CHANGE_OPERATION
                     , CMS_Tree_CHANGE_OPERATION
                     , CMS_User_CHANGE_OPERATION
                     , COM_SKU_CHANGE_OPERATION
                     , HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
                     , HFit_HealthAssesmentModule_CHANGE_OPERATION
                     , HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
                     , HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
                     , HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
                     , HFit_HealthAssessment_CHANGE_OPERATION
                     , HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
                     , CHANGED_FLG
                     , CHANGE_TYPE_CODE
                     , LastModifiedDate
                       --,[RowNbr]
                     ,
                       DeletedFlg) 
                SELECT
                       T.SiteGUID
                     , T.AccountCD
                     , T.HANodeID
                     , T.HANodeName
                     , T.HADocumentID
                     , T.HANodeSiteID
                     , T.HADocPubVerID
                     , T.ModTitle
                     , T.IntroText
                     , T.ModDocGuid
                     , T.ModWeight
                     , T.ModIsEnabled
                     , T.ModCodeName
                     , T.ModDocPubVerID
                     , T.RCTitle
                     , T.RCWeight
                     , T.RCDocumentGUID
                     , T.RCIsEnabled
                     , T.RCCodeName
                     , T.RCDocPubVerID
                     , T.RATytle
                     , T.RAWeight
                     , T.RADocumentGuid
                     , T.RAIsEnabled
                     , T.RACodeName
                     , T.RAScoringStrategyID
                     , T.RADocPubVerID
                     , T.QuestionType
                     , T.QuesTitle
                     , T.QuesWeight
                     , T.QuesIsRequired
                     , T.QuesDocumentGuid
                     , T.QuesIsEnabled
                     , T.QuesIsVisible
                     , T.QuesIsSTaging
                     , T.QuestionCodeName
                     , T.QuesDocPubVerID
                     , T.AnsValue
                     , T.AnsPoints
                     , T.AnsDocumentGuid
                     , T.AnsIsEnabled
                     , T.AnsCodeName
                     , T.AnsUOM
                     , T.AnsDocPUbVerID
                     , T.ChangeType
                     , T.DocumentCreatedWhen
                     , T.DocumentModifiedWhen
                     , T.CmsTreeNodeGuid
                     , T.HANodeGUID
                     , T.SiteLastModified
                     , T.Account_ItemModifiedWhen
                     , T.Campaign_DocumentModifiedWhen
                     , T.Assessment_DocumentModifiedWhen
                     , T.Module_DocumentModifiedWhen
                     , T.RiskCategory_DocumentModifiedWhen
                     , T.RiskArea_DocumentModifiedWhen
                     , T.Question_DocumentModifiedWhen
                     , T.Answer_DocumentModifiedWhen
                     , T.AllowMultiSelect
                     , T.LocID
                     , T.CMS_Class_CtID
                     , T.CMS_Class_SCV
                     , T.CMS_Document_CtID
                     , T.CMS_Document_SCV
                     , T.CMS_Site_CtID
                     , T.CMS_Site_SCV
                     , T.CMS_Tree_CtID
                     , T.CMS_Tree_SCV
                     , T.CMS_User_CtID
                     , T.CMS_User_SCV
                     , T.COM_SKU_CtID
                     , T.COM_SKU_SCV
                     , T.HFit_HealthAssesmentMatrixQuestion_CtID
                     , T.HFit_HealthAssesmentMatrixQuestion_SCV
                     , T.HFit_HealthAssesmentModule_CtID
                     , T.HFit_HealthAssesmentModule_SCV
                     , T.HFit_HealthAssesmentMultipleChoiceQuestion_CtID
                     , T.HFit_HealthAssesmentMultipleChoiceQuestion_SCV
                     , T.HFit_HealthAssesmentRiskArea_CtID
                     , T.HFit_HealthAssesmentRiskArea_SCV
                     , T.HFit_HealthAssesmentRiskCategory_CtID
                     , T.HFit_HealthAssesmentRiskCategory_SCV
                     , T.HFit_HealthAssessment_CtID
                     , T.HFit_HealthAssessment_SCV
                     , T.HFit_HealthAssessmentFreeForm_CtID
                     , T.HFit_HealthAssessmentFreeForm_SCV
                     , T.CMS_Class_CHANGE_OPERATION
                     , T.CMS_Document_CHANGE_OPERATION
                     , T.CMS_Site_CHANGE_OPERATION
                     , T.CMS_Tree_CHANGE_OPERATION
                     , T.CMS_User_CHANGE_OPERATION
                     , T.COM_SKU_CHANGE_OPERATION
                     , T.HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
                     , T.HFit_HealthAssesmentModule_CHANGE_OPERATION
                     , T.HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
                     , T.HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
                     , T.HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
                     , T.HFit_HealthAssessment_CHANGE_OPERATION
                     , T.HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
                     , T.CHANGED_FLG
                     , T.CHANGE_TYPE_CODE
                     , NULL AS LastModifiedDate
                       --, T.[RowNbr]
                     ,
                       NULL AS DeletedFlg
                       FROM
                            ##TEMP_EDW_HealthDefinition_DATA AS T --JOIN TEMPXX AS S
                                 JOIN CTE AS S
                                 ON
                                 S.RCDocumentGuid = T.RCDocumentGuid AND
                                 S.RADocumentGuid = T.RADocumentGuid AND
                                 S.RACodeName = T.RACodeName AND
                                 S.QuesDocumentGuid = T.QuesDocumentGuid AND
                                 S.AnsDocumentGuid = T.AnsDocumentGuid AND
                                 S.HANodeSiteID = T.HANodeSiteID;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HA_Definition_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_HA_Definition_AddDeletedRecs.sql" \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HA_Definition_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HA_Definition_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_Definition_AddDeletedRecs;
    END;
GO
-- exec proc_CT_HA_Definition_AddDeletedRecs
CREATE PROCEDURE proc_CT_HA_Definition_AddDeletedRecs
AS
BEGIN

    WITH CTE (
                 RCDocumentGuid
               , RADocumentGuid
               , RACodeName
               , QuesDocumentGuid
               , AnsDocumentGuid
               , HANodeSiteID) 
                AS ( SELECT
                            RCDocumentGuid
                          , RADocumentGuid
                          , RACodeName
                          , QuesDocumentGuid
                          , AnsDocumentGuid
                          , HANodeSiteID
                            FROM STAGING_EDW_HA_Definition
                            WHERE DeletedFlg IS NULL
                     EXCEPT
                     SELECT
                            RCDocumentGuid
                          , RADocumentGuid
                          , RACodeName
                          , QuesDocumentGuid
                          , AnsDocumentGuid
                          , HANodeSiteID
                            FROM ##TEMP_EDW_HealthDefinition_DATA) 
                UPDATE S
                  SET
                      S.DeletedFlg = 1
                      FROM CTE AS T
                                JOIN STAGING_EDW_HA_Definition AS S
                                ON
                                S.RCDocumentGuid = T.RCDocumentGuid AND
                                S.RADocumentGuid = T.RADocumentGuid AND
                                S.RACodeName = T.RACodeName AND
                                S.QuesDocumentGuid = T.QuesDocumentGuid AND
                                S.AnsDocumentGuid = T.AnsDocumentGuid AND
                                S.HANodeSiteID = T.HANodeSiteID and S.DeletedFlg is null;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    UPDATE STAGING_EDW_HA_Definition
      SET
          LastModifiedDate = GETDATE () 
           WHERE
                 LastModifiedDate IS NULL AND
                 DeletedFlg IS NOT NULL;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HA_Definition_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_RewardsDefinition_AddNewRecs.sql" \n 
--------------------------------------------------------------- 

go
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_RewardsDefinition_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardsDefinition_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardsDefinition_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardsDefinition_AddNewRecs
AS
BEGIN

WITH CTE (
                 SiteGUID
                 ,AccountID
                 ,AccountCD
                 ,RewardProgramGUID
                 ,RewardGroupGuid
                 ,RewardLevelGuid
                 ,RewardActivityGuid
                 ,RewardTriggerGuid
                 ,RewardTriggerParmGUID )
                AS ( SELECT
                            SiteGUID
                            ,AccountID
                            ,AccountCD
                            ,RewardProgramGUID
                            ,RewardGroupGuid
                            ,RewardLevelGuid
                            ,RewardActivityGuid
                            ,RewardTriggerGuid
                            ,RewardTriggerParmGUID
                       FROM ##TEMP_EDW_RewardsDefinition_DATA
                     EXCEPT
                     SELECT
                            SiteGUID
                            ,AccountID
                            ,AccountCD
                            ,RewardProgramGUID
                            ,RewardGroupGuid
                            ,RewardLevelGuid
                            ,RewardActivityGuid
                            ,RewardTriggerGuid
                            ,RewardTriggerParmGUID
                       FROM DIM_EDW_RewardsDefinition
                       WHERE LastModifiedDate IS NULL )
                INSERT INTO dbo.DIM_EDW_RewardsDefinition (
                       SiteGUID
                       ,AccountID
                       ,AccountCD
                       ,RewardProgramGUID
                       ,RewardProgramName
                       ,RewardProgramPeriodStart
                       ,RewardProgramPeriodEnd
                       ,RewardGroupGuid
                       ,GroupName
                       ,RewardLevelGuid
                       ,Level
                       ,RewardLevelTypeLKPName
                       ,AwardDisplayName
                       ,AwardType
                       ,AwardThreshold1
                       ,AwardThreshold2
                       ,AwardThreshold3
                       ,AwardThreshold4
                       ,AwardValue1
                       ,AwardValue2
                       ,AwardValue3
                       ,AwardValue4
                       ,ExternalFulfillmentRequired
                       ,RewardActivityGuid
                       ,ActivityName
                       ,ActivityFreqOrCrit
                       ,ActivityPoints
                       ,IsBundle
                       ,IsRequired
                       ,MaxThreshold
                       ,AwardPointsIncrementally
                       ,AllowMedicalExceptions
                       ,RewardTriggerGuid
                       ,RewardTriggerDynamicValue
                       ,TriggerName
                       ,RewardTriggerParameterOperator
                       ,RewardTriggerParmGUID
                       ,[Value]
                       ,ChangeType
                       ,DocumentCulture_VHFRAJ
                       ,DocumentCulture_VHFRPJ
                       ,DocumentCulture_VHFRGJ
                       ,DocumentCulture_VHFRLJ
                       ,DocumentCulture_VHFRTPJ
                       ,LevelName
                       ,HashCode
                       ,LastModifiedDate
                       ,DeletedFlg )
                SELECT
                       T.SiteGUID
                       ,T.AccountID
                       ,T.AccountCD
                       ,T.RewardProgramGUID
                       ,T.RewardProgramName
                       ,T.RewardProgramPeriodStart
                       ,T.RewardProgramPeriodEnd
                       ,T.RewardGroupGuid
                       ,T.GroupName
                       ,T.RewardLevelGuid
                       ,T.Level
                       ,T.RewardLevelTypeLKPName
                       ,T.AwardDisplayName
                       ,T.AwardType
                       ,T.AwardThreshold1
                       ,T.AwardThreshold2
                       ,T.AwardThreshold3
                       ,T.AwardThreshold4
                       ,T.AwardValue1
                       ,T.AwardValue2
                       ,T.AwardValue3
                       ,T.AwardValue4
                       ,T.ExternalFulfillmentRequired
                       ,T.RewardActivityGuid
                       ,T.ActivityName
                       ,T.ActivityFreqOrCrit
                       ,T.ActivityPoints
                       ,T.IsBundle
                       ,T.IsRequired
                       ,T.MaxThreshold
                       ,T.AwardPointsIncrementally
                       ,T.AllowMedicalExceptions
                       ,T.RewardTriggerGuid
                       ,T.RewardTriggerDynamicValue
                       ,T.TriggerName
                       ,T.RewardTriggerParameterOperator
                       ,T.RewardTriggerParmGUID
                       ,T.[Value]
                       ,T.ChangeType
                       ,T.DocumentCulture_VHFRAJ
                       ,T.DocumentCulture_VHFRPJ
                       ,T.DocumentCulture_VHFRGJ
                       ,T.DocumentCulture_VHFRLJ
                       ,T.DocumentCulture_VHFRTPJ
                       ,T.LevelName
                       ,T.HashCode
                       ,NULL AS LastModifiedDate
                       ,NULL AS DeletedFlg
                  FROM
                       ##TEMP_EDW_RewardsDefinition_DATA AS T JOIN CTE AS S
                       ON
                       S.SiteGUID = T.SiteGUID
                   AND S.AccountID = T.AccountID
                   AND S.AccountCD = T.AccountCD
                   AND S.RewardProgramGUID = T.RewardProgramGUID
                   AND S.RewardGroupGuid = T.RewardGroupGuid
                   AND S.RewardLevelGuid = T.RewardLevelGuid
                   AND S.RewardActivityGuid = T.RewardActivityGuid
                   AND S.RewardTriggerGuid = T.RewardTriggerGuid
                   AND S.RewardTriggerParmGUID = T.RewardTriggerParmGUID;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardsDefinition_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_RewardsDefinition_AddDeletedRecs.sql" \n 
--------------------------------------------------------------- 

go
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_RewardsDefinition_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardsDefinition_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardsDefinition_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardsDefinition_AddDeletedRecs
AS
BEGIN

     WITH CTE (
                 SiteGUID
                 ,AccountID
                 ,AccountCD
                 ,RewardProgramGUID
                 ,RewardGroupGuid
                 ,RewardLevelGuid
                 ,RewardActivityGuid
                 ,RewardTriggerGuid
                 ,RewardTriggerParmGUID )
                AS ( SELECT
                            SiteGUID
                            ,AccountID
                            ,AccountCD
                            ,RewardProgramGUID
                            ,RewardGroupGuid
                            ,RewardLevelGuid
                            ,RewardActivityGuid
                            ,RewardTriggerGuid
                            ,RewardTriggerParmGUID
                       FROM DIM_EDW_RewardsDefinition
                     EXCEPT
                     SELECT
                            SiteGUID
                            ,AccountID
                            ,AccountCD
                            ,RewardProgramGUID
                            ,RewardGroupGuid
                            ,RewardLevelGuid
                            ,RewardActivityGuid
                            ,RewardTriggerGuid
                            ,RewardTriggerParmGUID
                       FROM ##TEMP_EDW_RewardsDefinition_DATA )
                UPDATE S
                  SET
                      S.DeletedFlg = 1
                  FROM CTE AS T JOIN DIM_EDW_RewardsDefinition AS S
                       ON
                       S.SiteGUID = T.SiteGUID
                   AND S.AccountID = T.AccountID
                   AND S.AccountCD = T.AccountCD
                   AND S.RewardProgramGUID = T.RewardProgramGUID
                   AND S.RewardGroupGuid = T.RewardGroupGuid
                   AND S.RewardLevelGuid = T.RewardLevelGuid
                   AND S.RewardActivityGuid = T.RewardActivityGuid
                   AND S.RewardTriggerGuid = T.RewardTriggerGuid
                   AND S.RewardTriggerParmGUID = T.RewardTriggerParmGUID AND S.DeletedFlg is null;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    update DIM_EDW_RewardsDefinition set LastModifiedDate = getdate() where LastModifiedDate is null and DeletedFlg is NOT null ;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardsDefinition_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_RewardsDefinition_AddUpdatedRecs.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_RewardsDefinition_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardsDefinition_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardsDefinition_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardsDefinition_AddUpdatedRecs
AS
BEGIN

    DECLARE
       @RUNDATE AS  datetime2 ( 7 ) = GETDATE ( );

    UPDATE S
                      SET
                          S.SiteGUID = T.SiteGUID
                          ,S.AccountID = T.AccountID
                          ,S.AccountCD = T.AccountCD
                          ,S.RewardProgramGUID = T.RewardProgramGUID
                          ,S.RewardProgramName = T.RewardProgramName
                          ,S.RewardProgramPeriodStart = T.RewardProgramPeriodStart
                          ,S.RewardProgramPeriodEnd = T.RewardProgramPeriodEnd
                          ,S.RewardGroupGuid = T.RewardGroupGuid
                          ,S.GroupName = T.GroupName
                          ,S.RewardLevelGuid = T.RewardLevelGuid
                          ,S.Level = T.Level
                          ,S.RewardLevelTypeLKPName = T.RewardLevelTypeLKPName
                          ,S.AwardDisplayName = T.AwardDisplayName
                          ,S.AwardType = T.AwardType
                          ,S.AwardThreshold1 = T.AwardThreshold1
                          ,S.AwardThreshold2 = T.AwardThreshold2
                          ,S.AwardThreshold3 = T.AwardThreshold3
                          ,S.AwardThreshold4 = T.AwardThreshold4
                          ,S.AwardValue1 = T.AwardValue1
                          ,S.AwardValue2 = T.AwardValue2
                          ,S.AwardValue3 = T.AwardValue3
                          ,S.AwardValue4 = T.AwardValue4
                          ,S.ExternalFulfillmentRequired = T.ExternalFulfillmentRequired
                          ,S.RewardActivityGuid = T.RewardActivityGuid
                          ,S.ActivityName = T.ActivityName
                          ,S.ActivityFreqOrCrit = T.ActivityFreqOrCrit
                          ,S.ActivityPoints = T.ActivityPoints
                          ,S.IsBundle = T.IsBundle
                          ,S.IsRequired = T.IsRequired
                          ,S.MaxThreshold = T.MaxThreshold
                          ,S.AwardPointsIncrementally = T.AwardPointsIncrementally
                          ,S.AllowMedicalExceptions = T.AllowMedicalExceptions
                          ,S.RewardTriggerGuid = T.RewardTriggerGuid
                          ,S.RewardTriggerDynamicValue = T.RewardTriggerDynamicValue
                          ,S.TriggerName = T.TriggerName
                          ,S.RewardTriggerParameterOperator = T.RewardTriggerParameterOperator
                          ,S.RewardTriggerParmGUID = T.RewardTriggerParmGUID
                          ,S.Value = T.Value
                          ,S.ChangeType = T.ChangeType
                          ,S.DocumentCulture_VHFRAJ = T.DocumentCulture_VHFRAJ
                          ,S.DocumentCulture_VHFRPJ = T.DocumentCulture_VHFRPJ
                          ,S.DocumentCulture_VHFRGJ = T.DocumentCulture_VHFRGJ
                          ,S.DocumentCulture_VHFRLJ = T.DocumentCulture_VHFRLJ
                          ,S.DocumentCulture_VHFRTPJ = T.DocumentCulture_VHFRTPJ
                          ,S.LevelName = T.LevelName
                          ,S.HashCode = T.HashCode
                          ,S.LastModifiedDate = GETDATE ( )
                          ,S.DeletedFlg = NULL
                          ,S.ConvertedToCentralTime = NULL
                      FROM DIM_EDW_RewardsDefinition AS S JOIN ##TEMP_EDW_RewardsDefinition_DATA AS T
                           ON
                           S.SiteGUID = T.SiteGUID
                       AND S.AccountID = T.AccountID
                       AND S.AccountCD = T.AccountCD
                       AND S.RewardProgramGUID = T.RewardProgramGUID
                       AND S.RewardGroupGuid = T.RewardGroupGuid
                       AND S.RewardLevelGuid = T.RewardLevelGuid
                       AND S.RewardActivityGuid = T.RewardActivityGuid
                       AND S.RewardTriggerGuid = T.RewardTriggerGuid
                       AND S.RewardTriggerParmGUID = T.RewardTriggerParmGUID
                      WHERE
                            S.HashCode != T.HashCode and S.DeletedFlg is null;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardsDefinition_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_TrackerComposite_AddNewRecs.sql" \n 
--------------------------------------------------------------- 

go 
print 'Executing proc_CT_TrackerComposite_AddNewRecs.SQL'
go

if exists (select name from sys.procedures where name = 'proc_CT_TrackerComposite_AddNewRecs')    
    drop procedure proc_CT_TrackerComposite_AddNewRecs;
go
--exec proc_CT_TrackerComposite_AddNewRecs
create procedure proc_CT_TrackerComposite_AddNewRecs
as
WITH CTE_NEW (
                 TrackerNameAggregateTable
                 ,ItemID )
                AS
                (
                SELECT
                       TrackerNameAggregateTable
                       ,ItemID
                  FROM DIM_TEMPTBL_Staging_EDW_Tracker_DATA
                EXCEPT
                SELECT
                       TrackerNameAggregateTable
                       ,ItemID
                  FROM DIM_EDW_Trackers
			 where deletedflg is null
                )
                INSERT INTO dbo.DIM_EDW_Trackers (
                       TrackerNameAggregateTable
                       ,ItemID
                       ,EventDate
                       ,IsProfessionallyCollected
                       ,TrackerCollectionSourceID
                       ,Notes
                       ,UserID
                       ,CollectionSourceName_Internal
                       ,CollectionSourceName_External
                       ,EventName
                       ,UOM
                       ,KEY1
                       ,VAL1
                       ,KEY2
                       ,VAL2
                       ,KEY3
                       ,VAL3
                       ,KEY4
                       ,VAL4
                       ,KEY5
                       ,VAL5
                       ,KEY6
                       ,VAL6
                       ,KEY7
                       ,VAL7
                       ,KEY8
                       ,VAL8
                       ,KEY9
                       ,VAL9
                       ,KEY10
                       ,VAL10
                       ,ItemCreatedBy
                       ,ItemCreatedWhen
                       ,ItemModifiedBy
                       ,ItemModifiedWhen
                       ,IsProcessedForHa
                       ,TXTKEY1
                       ,TXTVAL1
                       ,TXTKEY2
                       ,TXTVAL2
                       ,TXTKEY3
                       ,TXTVAL3
                       ,ItemOrder
                       ,ItemGuid
                       ,UserGuid
                       ,MPI
                       ,ClientCode
                       ,SiteGUID
                       ,AccountID
                       ,AccountCD
                       ,IsAvailable
                       ,IsCustom
                       ,UniqueName
                       ,ColDesc
                       ,VendorID
                       ,VendorName
                       ,CT_ItemID
                       ,CT_ChangeVersion
                       ,CMS_Operation
                       ,ItemLastUpdated )
                SELECT
                       T1.TrackerNameAggregateTable
                       ,T1.ItemID
                       ,T1.EventDate
                       ,T1.IsProfessionallyCollected
                       ,T1.TrackerCollectionSourceID
                       ,T1.Notes
                       ,T1.UserID
                       ,T1.CollectionSourceName_Internal
                       ,T1.CollectionSourceName_External
                       ,T1.EventName
                       ,T1.UOM
                       ,T1.KEY1
                       ,T1.VAL1
                       ,T1.KEY2
                       ,T1.VAL2
                       ,T1.KEY3
                       ,T1.VAL3
                       ,T1.KEY4
                       ,T1.VAL4
                       ,T1.KEY5
                       ,T1.VAL5
                       ,T1.KEY6
                       ,T1.VAL6
                       ,T1.KEY7
                       ,T1.VAL7
                       ,T1.KEY8
                       ,T1.VAL8
                       ,T1.KEY9
                       ,T1.VAL9
                       ,T1.KEY10
                       ,T1.VAL10
                       ,T1.ItemCreatedBy
                       ,T1.ItemCreatedWhen
                       ,T1.ItemModifiedBy
                       ,T1.ItemModifiedWhen
                       ,T1.IsProcessedForHa
                       ,T1.TXTKEY1
                       ,T1.TXTVAL1
                       ,T1.TXTKEY2
                       ,T1.TXTVAL2
                       ,T1.TXTKEY3
                       ,T1.TXTVAL3
                       ,T1.ItemOrder
                       ,T1.ItemGuid
                       ,T1.UserGuid
                       ,T1.MPI
                       ,T1.ClientCode
                       ,T1.SiteGUID
                       ,T1.AccountID
                       ,T1.AccountCD
                       ,T1.IsAvailable
                       ,T1.IsCustom
                       ,T1.UniqueName
                       ,T1.ColDesc
                       ,T1.VendorID
                       ,T1.VendorName
                       ,T1.CT_ItemID
                       ,T1.CT_ChangeVersion
                       ,T1.CMS_Operation
                       ,GETDATE ( )
                  FROM
                       DIM_TEMPTBL_Staging_EDW_Tracker_DATA AS T1 INNER JOIN
                            CTE_NEW AS T2
                                                           ON
                       T1.TrackerNameAggregateTable = T2.TrackerNameAggregateTable
                   AND T1.ItemId = T2.ItemId;

        DECLARE
           @iInserted AS int = @@ROWCOUNT;
	   PRINT 'Records Added: ' + CAST ( @iInserted AS nvarchar( 5 ));
	   return @iInserted ;
go 
print 'Executed proc_CT_TrackerComposite_AddNewRecs.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_TrackerComposite_AddDeletedRecs.sql" \n 
--------------------------------------------------------------- 

GO

PRINT 'Executing proc_CT_TrackerComposite_AddDeletedRecs.sql';

GO

IF EXISTS ( SELECT
			    name
		    FROM sys.procedures
		    WHERE name = 'proc_CT_TrackerComposite_AddDeletedRecs' )

    BEGIN

	   DROP PROCEDURE
		   proc_CT_TrackerComposite_AddDeletedRecs;
    END;

GO

-- select * from ##TempCompositeData
-- select top 100 * from STAGING_EDW_TrackerComposite
-- exec proc_CT_TrackerComposite_AddDeletedRecs

CREATE PROCEDURE proc_CT_TrackerComposite_AddDeletedRecs
AS

BEGIN

    IF NOT EXISTS ( SELECT
					  name
				  FROM tempdb.dbo.sysobjects
				  WHERE id = OBJECT_ID ( N'tempdb..##TempCompositeData'))

	   BEGIN

		  PRINT 'Reading changed data, standby...';
		  EXEC proc_CkTrackerDataChanged;
	   END;

    UPDATE S
    SET
	   S.DeletedFlg = 1
	 ,S.LastModifiedDate = GETDATE( )
	 FROM DIM_EDW_Trackers AS S
		 JOIN
		 ##TempCompositeData AS T
			ON
			T.TGTTBL = S.TrackerNameAggregateTable		 
		 AND T.ItemID = S.ItemID
		 AND T.SYS_CHANGE_OPERATION = 'D'
		 AND S.DeletedFlg IS NULL;

    DECLARE
	  @iCnt AS int = @@ROWCOUNT;

    PRINT 'Deleted Count: ' + CAST ( @iCnt AS nvarchar(50));

    RETURN @iCnt;
END;

GO

PRINT 'Executed proc_CT_TrackerComposite_AddDeletedRecs.sql';

GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_TrackerComposite_AddUpdatedRecs.sql" \n 
--------------------------------------------------------------- 

GO

PRINT 'Executing proc_CT_TrackerComposite_AddUpdatedRecs.SQL';

GO

IF EXISTS ( SELECT
			    name
		    FROM sys.procedures
		    WHERE name = 'proc_CT_TrackerComposite_AddUpdatedRecs' )

    BEGIN

	   DROP PROCEDURE
		   proc_CT_TrackerComposite_AddUpdatedRecs;
    END;

GO

--select top 100 * from DIM_EDW_Trackers
-- exec proc_CT_TrackerComposite_AddUpdatedRecs

CREATE PROCEDURE proc_CT_TrackerComposite_AddUpdatedRecs
AS

BEGIN

    IF NOT EXISTS ( SELECT
					  name
				  FROM tempdb.dbo.sysobjects
				  WHERE id = OBJECT_ID ( N'tempdb..##TempCompositeData' ))

	   BEGIN

		  PRINT 'Reading changed data, standby...';
		  EXEC proc_CkTrackerDataChanged;
	   END;

    DECLARE
	  @RUNDATE AS datetime2 ( 7 ) = GETDATE ( );

    DECLARE
	  @CurrentChgVersion AS  bigint = CHANGE_TRACKING_CURRENT_VERSION ( );

    PRINT 'Processing Current Change Version: ' + CAST( @CurrentChgVersion AS nvarchar(50));

    UPDATE S
    SET
	   S.TrackerNameAggregateTable = T.TrackerNameAggregateTable
	 ,S.ItemID = T.ItemID
	 ,S.EventDate = T.EventDate
	 ,S.IsProfessionallyCollected = T.IsProfessionallyCollected
	 ,S.TrackerCollectionSourceID = T.TrackerCollectionSourceID
	 ,S.Notes = T.Notes
	 ,S.UserID = T.UserID
	 ,S.CollectionSourceName_Internal = T.CollectionSourceName_Internal
	 ,S.CollectionSourceName_External = T.CollectionSourceName_External
	 ,S.EventName = T.EventName
	 ,S.UOM = T.UOM
	 ,S.KEY1 = T.KEY1
	 ,S.VAL1 = T.VAL1
	 ,S.KEY2 = T.KEY2
	 ,S.VAL2 = T.VAL2
	 ,S.KEY3 = T.KEY3
	 ,S.VAL3 = T.VAL3
	 ,S.KEY4 = T.KEY4
	 ,S.VAL4 = T.VAL4
	 ,S.KEY5 = T.KEY5
	 ,S.VAL5 = T.VAL5
	 ,S.KEY6 = T.KEY6
	 ,S.VAL6 = T.VAL6
	 ,S.KEY7 = T.KEY7
	 ,S.VAL7 = T.VAL7
	 ,S.KEY8 = T.KEY8
	 ,S.VAL8 = T.VAL8
	 ,S.KEY9 = T.KEY9
	 ,S.VAL9 = T.VAL9
	 ,S.KEY10 = T.KEY10
	 ,S.VAL10 = T.VAL10
	 ,S.ItemCreatedBy = T.ItemCreatedBy
	 ,S.ItemCreatedWhen = T.ItemCreatedWhen
	 ,S.ItemModifiedBy = T.ItemModifiedBy
	 ,S.ItemModifiedWhen = T.ItemModifiedWhen
	 ,S.IsProcessedForHa = T.IsProcessedForHa
	 ,S.TXTKEY1 = T.TXTKEY1
	 ,S.TXTVAL1 = T.TXTVAL1
	 ,S.TXTKEY2 = T.TXTKEY2
	 ,S.TXTVAL2 = T.TXTVAL2
	 ,S.TXTKEY3 = T.TXTKEY3
	 ,S.TXTVAL3 = T.TXTVAL3
	 ,S.ItemOrder = T.ItemOrder
	 ,S.ItemGuid = T.ItemGuid
	 ,S.UserGuid = T.UserGuid
	 ,S.MPI = T.MPI
	 ,S.ClientCode = T.ClientCode
	 ,S.SiteGUID = T.SiteGUID
	 ,S.AccountID = T.AccountID
	 ,S.AccountCD = T.AccountCD
	 ,S.IsAvailable = T.IsAvailable
	 ,S.IsCustom = T.IsCustom
	 ,S.UniqueName = T.UniqueName
	 ,S.ColDesc = T.ColDesc
	 ,S.VendorID = T.VendorID
	 ,S.VendorName = T.VendorName
	 ,S.CT_ItemID = T.CT_ItemID
	 ,S.CT_ChangeVersion = @CurrentChgVersion
	 ,S.CMS_Operation = T.CMS_Operation
	 ,S.LastModifiedDate = GETDATE ( )
	 ,S.ConvertedToCentralTime = NULL
	 FROM DIM_EDW_Trackers AS S
		 JOIN
		 ##TempCompositeData AS TTEMP
			ON
			TTEMP.TGTTBL = S.TrackerNameAggregateTable
		 AND TTEMP.ItemID = S.ItemID
		 AND TTEMP.SYS_CHANGE_OPERATION = 'U'
		 JOIN
		 DIM_TEMPTBL_Staging_EDW_Tracker_DATA AS T
			ON
			T.ItemID = S.ItemID
		 AND T.TrackerNameAggregateTable = S.TrackerNameAggregateTable
		 AND T.DeletedFlg IS NULL;

    --AND T.CMS_Operation = 'U' 

    DECLARE
	  @iUpdated AS int = + @@ROWCOUNT;

    RETURN @iUpdated;
END;

GO

PRINT 'Executed proc_CT_TrackerComposite_AddUpdatedRecs.SQL';

GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "view_EDW_RewardTriggerParameters_CT.sql" \n 
--------------------------------------------------------------- 

GO
USE KenticoCMS_DataMart;

GO
PRINT 'Processing: view_EDW_RewardTriggerParameters_CT ';
PRINT 'FROM: view_EDW_RewardTriggerParameters_CT.sql ';
GO

IF EXISTS (SELECT
                  NAME
                  FROM sys.VIEWS
                  WHERE NAME = 'view_EDW_RewardTriggerParameters_CT') 
    BEGIN
        DROP VIEW
             view_EDW_RewardTriggerParameters_CT;
    END;
GO

--*******************************************************************************************************************
--8/7/2014  VHFRTJ.DocumentGuid		  --WDM Added in case needed
--8/7/2014  VHFRTJ.NodeGuid			  --WDM Added in case needed
--09.11.2014 : (wdm) Verified last mod date available to EDW - RewardTriggerParameter_DocumentModifiedWhen
--11.17.2014 : (wdm) John C. found that Spanish was being brought across in TriggerName and 
--				ParameterDisplayName. Found that View_HFit_RewardTrigger_Joined has no way to limit the 
--				returned data to Spanish. Created a new view, View_EDW_RewardProgram_Joined, and provided 
--				a FILTER on Document Culture. The, added Launguage fitlers as: 
--					where VHFRTJ.DocumentCulture = 'en-US' AND VHFRTPJ.DocumentCulture = 'en-US'
--				This appears to have eliminated the Spanish.
-- 03.03.2015 : (Dale/Natahn) no changes required.
-- 04.12.2015 : (WDM) In order to implement change tracking on this view, a STAGING table will simply be 
--			 dropped and recreated everytime using this view. It is too small to worry about otherwise.
-- 04.12.2015 : created view view_EDW_RewardTriggerParameters_CT so that change tracking would be consistent.
--SELECT * FROM [view_EDW_RewardTriggerParameters_CT]
--*******************************************************************************************************************
/*
select count(*), SiteGUID, RewardTriggerID, ParameterDisplayName, RewardTriggerParameterOperator, [Value], AccountID, AccountCD, DocumentGuid, NodeGuid
from [view_EDW_RewardTriggerParameters_CT]
group by SiteGUID
                    , RewardTriggerID
                    , ParameterDisplayName
                    , RewardTriggerParameterOperator
                    , [Value]
                    , AccountID
                    , AccountCD
                    , DocumentGuid
                    , NodeGuid
having count(*) > 1

select distinct count(*), SiteGUID,RewardTriggerID,AccountID,AccountCD,DocumentGuid,NodeGuid,RewardTriggerParameterOperatorLKPDisplayName
from [view_EDW_RewardTriggerParameters_CT]
group by SiteGUID,RewardTriggerID,AccountID,AccountCD,DocumentGuid,NodeGuid,RewardTriggerParameterOperatorLKPDisplayName
having count(*) > 1
go
*/

CREATE VIEW dbo.view_EDW_RewardTriggerParameters_CT
AS
--8/7/2014 - added and commented out DocumentGuid and NodeGuid in case needed later
--8/8/2014 - Generated corrected view in DEV (WDM)
SELECT DISTINCT
       cs.SiteGUID															 --CMS_Site
     , VHFRTJ.RewardTriggerID													 --HFit_RewardTrigger
     , VHFRTJ.TriggerName													 --HFit_RewardTrigger
     , HFLRTPO.RewardTriggerParameterOperatorLKPDisplayName							 --HFit_LKP_RewardTriggerParameterOperator 
     , VHFRTPJ.ParameterDisplayName											 --HFit_RewardTriggerParameter
     , VHFRTPJ.RewardTriggerParameterOperator									 --HFit_RewardTriggerParameter
     , VHFRTPJ.Value														 --HFit_RewardTriggerParameter
     , hfa.AccountID														 --HFit_Account
     , hfa.AccountCD														 --HFit_Account
     , CASE	WHEN CAST (VHFRTJ.DocumentCreatedWhen AS DATE) = CAST (VHFRTJ.DocumentModifiedWhen AS DATE) 
               THEN 'I'
           ELSE 'U'
       END AS ChangeType
     , VHFRTJ.DocumentGuid													 --CMS_Document
     , VHFRTJ.NodeGuid														 --CMS_Document
     , VHFRTJ.DocumentCreatedWhen												 --CMS_Document
     , VHFRTJ.DocumentModifiedWhen												 --CMS_Document
     , VHFRTPJ.DocumentModifiedWhen AS RewardTriggerParameter_DocumentModifiedWhen	  	 --CMS_Document
     , VHFRTPJ.documentculture AS documentculture_VHFRTPJ							 --CMS_Document
     , VHFRTJ.documentculture AS documentculture_VHFRTJ								 --CMS_Document
     , HASHBYTES ('sha1',
       ISNULL (CAST (cs.SiteGUID AS NVARCHAR (50)) , '-') + ISNULL (CAST (VHFRTJ.RewardTriggerID AS NVARCHAR (50)) , '-') + ISNULL (CAST (VHFRTJ.TriggerName AS NVARCHAR (250)) , '-') + ISNULL (CAST (HFLRTPO.RewardTriggerParameterOperatorLKPDisplayName AS NVARCHAR (250)) , '-') + ISNULL (CAST (VHFRTPJ.ParameterDisplayName AS NVARCHAR (250)) , '-') + ISNULL (CAST (VHFRTPJ.RewardTriggerParameterOperator AS NVARCHAR (50)) , '-') + ISNULL (CAST (VHFRTPJ.Value AS NVARCHAR (50)) , '-') + ISNULL (CAST (VHFRTJ.DocumentGuid AS NVARCHAR (50)) , '-') + ISNULL (CAST (VHFRTJ.NodeGuid AS NVARCHAR (50)) , '-') + ISNULL (CAST (VHFRTJ.DocumentCreatedWhen AS NVARCHAR (50)) , '-') + ISNULL (CAST (VHFRTJ.DocumentModifiedWhen AS NVARCHAR (50)) , '-') + ISNULL (CAST (VHFRTPJ.DocumentModifiedWhen AS NVARCHAR (50)) , '-') 
       ) AS HashCode

     , @@SERVERNAME AS SVR
     , DB_NAME () AS DBNAME
       FROM dbo.View_HFit_RewardTrigger_Joined AS VHFRTJ --dbo.[View_EDW_RewardProgram_Joined] AS VHFRTJ 		
                INNER JOIN dbo.View_HFit_RewardTriggerParameter_Joined AS VHFRTPJ
                    ON vhfrtj.NodeID = VHFRTPJ.NodeParentID
                   AND vhfrtj.SVR = VHFRTPJ.SVR
                   AND vhfrtj.DBNAME = VHFRTPJ.DBNAME
                INNER JOIN dbo.BASE_HFit_LKP_RewardTriggerParameterOperator AS HFLRTPO
                    ON VHFRTPJ.RewardTriggerParameterOperator = HFLRTPO.RewardTriggerParameterOperatorLKPID
                   AND VHFRTPJ.SVR = HFLRTPO.SVR
                   AND VHFRTPJ.DBNAME = HFLRTPO.DBNAME
                INNER JOIN dbo.BASE_CMS_Site AS CS
                    ON VHFRTJ.NodeSiteID = cs.SiteID
                   AND VHFRTJ.SVR = cs.SVR
                   AND VHFRTJ.DBNAME = cs.DBNAME
                INNER JOIN dbo.BASE_HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                   AND cs.SVR = HFA.SVR
                   AND cs.DBNAME = HFA.DBNAME

       WHERE VHFRTJ.DocumentCulture = 'en-US'
         AND VHFRTPJ.DocumentCulture = 'en-US';

GO

--  
--  
GO
PRINT '***** Created: view_EDW_RewardTriggerParameters_CT.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "PrintImmediate.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing PrintImmediate.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'PrintImmediate') 
    BEGIN
        DROP PROCEDURE
             PrintImmediate
    END;
GO

CREATE PROCEDURE PrintImmediate (
       @MSG AS NVARCHAR (MAX)) 
AS
BEGIN
    RAISERROR (@MSG , 10, 1) WITH NOWAIT;
END;
GO
PRINT 'Executed PrintImmediate.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\QuickCount.sql" \n 
--------------------------------------------------------------- 



GO
PRINT 'Creating QuickCount.sql';

GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'QuickCount' )
    BEGIN
        DROP PROCEDURE
             QuickCount
    END;
GO

/*
declare @i as bigint = 0 ;
EXEC @i = QuickCount 'Device_RawNotification' ;
print @i ;

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = QuickCount 'STAGING_EDW_RewardUserDetail';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

*/

CREATE PROCEDURE QuickCount ( @TblName AS nvarchar( 254 ))
AS
BEGIN

    /*********************************************
    Author:	  Dale Miller
    Date:	  02.02.2008
    Copyright:  DMA, Ltd., Chicago, IL
    **********************************************/

    DECLARE
   @i AS bigint = 0;

    SET @i = ( SELECT
                      SUM ( row_count )
                 FROM sys.dm_db_partition_stats
                 WHERE
                      object_id = OBJECT_ID( @TblName )
                  AND (
                      index_id = 0
                   OR index_id = 1));
    if @i is null
	   set @i = 0 ;
    PRINT @i;
    return @i ;
END;

GO
PRINT 'Created QuickCount.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CREATE_STAGING_EDW_HealthAssessment_TABLE.sql" \n 
--------------------------------------------------------------- 


GO
PRINT 'Create proc_CREATE_EDW_HealthAssessment_TABLE.SQL';
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CREATE_EDW_HealthAssessment_TABLE') 
    BEGIN
        DROP PROCEDURE
             proc_CREATE_EDW_HealthAssessment_TABLE;
    END;
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthAssessment') 
    BEGIN
       drop table DIM_EDW_HealthAssessment;
    END;
GO

-- drop table DIM_EDW_HealthAssessment
-- exec proc_CREATE_EDW_HealthAssessment_TABLE
CREATE PROCEDURE proc_CREATE_EDW_HealthAssessment_TABLE
AS
BEGIN
    IF NOT EXISTS ( SELECT
                           name
                           FROM sys.tables
                           WHERE name = 'DIM_EDW_HealthAssessment') 
        BEGIN
            PRINT 'CREATING DIM_EDW_HealthAssessment ';

            CREATE TABLE dbo.DIM_EDW_HealthAssessment (
                         USERSTARTEDITEMID int NULL
                       , HEALTHASSESMENTUSERSTARTEDNODEGUID uniqueidentifier NULL
                       , USERID bigint NULL
                       , USERGUID uniqueidentifier NULL
                       , HFITUSERMPINUMBER bigint NULL
                       , SITEGUID uniqueidentifier NULL
                       , ACCOUNTID int NULL
                       , ACCOUNTCD nvarchar (8) NULL
                       , ACCOUNTNAME nvarchar (200) NULL
                       , HASTARTEDDT datetime NULL
                       , HACOMPLETEDDT datetime NULL
                       , USERMODULEITEMID int NULL
                       , USERMODULECODENAME nvarchar (100) NULL
                       , HAMODULENODEGUID uniqueidentifier NULL
                       , CMSNODEGUID uniqueidentifier NULL
                       , HAMODULEVERSIONID int NULL
                       , USERRISKCATEGORYITEMID int NULL
                       , USERRISKCATEGORYCODENAME nvarchar (100) NULL
                       , HARISKCATEGORYNODEGUID uniqueidentifier NULL
                       , HARISKCATEGORYVERSIONID int NULL
                       , USERRISKAREAITEMID int NULL
                       , USERRISKAREACODENAME nvarchar (100) NULL
                       , HARISKAREANODEGUID uniqueidentifier NULL
                       , HARISKAREAVERSIONID int NULL
                       , USERQUESTIONITEMID int NULL
                       , TITLE varchar (max) NULL
                       , HAQUESTIONGUID uniqueidentifier NULL
                       , USERQUESTIONCODENAME nvarchar (100) NULL
                       , HAQUESTIONDOCUMENTID int NULL
                       , HAQUESTIONVERSIONID int NULL
                       , HAQUESTIONNODEGUID uniqueidentifier NULL
                       , USERANSWERITEMID int NULL
                       , HAANSWERNODEGUID uniqueidentifier NULL
                       , HAANSWERVERSIONID int NULL
                       , USERANSWERCODENAME nvarchar (100) NULL
                       , HAANSWERVALUE nvarchar (255) NULL
                       , HAMODULESCORE float NULL
                       , HARISKCATEGORYSCORE float NULL
                       , HARISKAREASCORE float NULL
                       , HAQUESTIONSCORE float NULL
                       , HAANSWERPOINTS int NULL
                       , POINTRESULTS int NULL
                       , UOMCODE nvarchar (10) NULL
                       , HASCORE int NULL
                       , MODULEPREWEIGHTEDSCORE float NULL
                       , RISKCATEGORYPREWEIGHTEDSCORE float NULL
                       , RISKAREAPREWEIGHTEDSCORE float NULL
                       , QUESTIONPREWEIGHTEDSCORE float NULL
                       , QUESTIONGROUPCODENAME nvarchar (100) NULL
                       , ITEMCREATEDWHEN datetime NULL
                       , ITEMMODIFIEDWHEN datetime NULL
                       , ISPROFESSIONALLYCOLLECTED bit NULL
                       , HARISKCATEGORY_ITEMMODIFIEDWHEN datetime NULL
                       , HAUSERRISKAREA_ITEMMODIFIEDWHEN datetime NULL
                       , HAUSERQUESTION_ITEMMODIFIEDWHEN datetime NULL
                       , HAUSERANSWERS_ITEMMODIFIEDWHEN datetime NULL
                       , HAPAPERFLG bit NULL
                       , HATELEPHONICFLG bit NULL
                       , HASTARTEDMODE int NULL
                       , HACOMPLETEDMODE int NULL
                       , DOCUMENTCULTURE_VHCJ nvarchar (10) NULL
                       , DOCUMENTCULTURE_HAQUESTIONSVIEW nvarchar (10) NULL
                       , CAMPAIGNNODEGUID uniqueidentifier NULL
                       , HACAMPAIGNID int NULL
                       , HASHCODE varchar (100) NULL
                       , PKHASHCODE varchar (100) NULL
                       , CHANGED_FLG int NULL
                       , LastModifiedDATE datetime NULL
                       , HEALTHASSESSMENTTYPE varchar (9) NULL
                       , HAUSERSTARTED_LASTMODIFIED datetime NULL
                       , CMSUSER_LASTMODIFIED datetime NULL
                       , USERSETTINGS_LASTMODIFIED datetime NULL
                       , USERSITE_LASTMODIFIED datetime NULL
                       , CMSSITE_LASTMODIFIED datetime NULL
                       , ACCT_LASTMODIFIED datetime NULL
                       , HAUSERMODULE_LASTMODIFIED datetime NULL
                       , VHCJ_LASTMODIFIED datetime NULL
                       , VHAJ_LASTMODIFIED datetime NULL
                       , HARISKCATEGORY_LASTMODIFIED datetime NULL
                       , HAUSERRISKAREA_LASTMODIFIED datetime NULL
                       , HAUSERQUESTION_LASTMODIFIED datetime NULL
                       , HAQUESTIONSVIEW_LASTMODIFIED datetime NULL
                       , HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED datetime NULL
                       , HAUSERANSWERS_LASTMODIFIED datetime NULL
                       , HAUSERSTARTED_LastUpdateID int NULL
                       , CMSUSER_LastUpdateID int NULL
                       , USERSETTINGS_LastUpdateID int NULL
                       , USERSITE_LastUpdateID int NULL
                       , CMSSITE_LastUpdateID datetime NULL
                       , ACCT_LastUpdateID datetime NULL
                       , HAUSERMODULE_LastUpdateID int NULL
                       , VHCJ_LastUpdateID int NULL
                       , VHAJ_LastUpdateID int NULL
                       , HARISKCATEGORY_LastUpdateID int NULL
                       , HAUSERRISKAREA_LastUpdateID int NULL
                       , HAUSERQUESTION_LastUpdateID int NULL
                       , HAQUESTIONSVIEW_LastUpdateID int NULL
                       , HAUSERQUESTIONGROUPRESULTS_LastUpdateID int NULL
                       , HAUSERANSWERS_LastUpdateID int NULL
                       , LASTUPDATEID int NULL
                       , DELETEFLG int NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DELETEDFLG int NULL
                       , RowNbr int NULL
                       , TimeZone nvarchar (10) NULL
                       , ConvertedToCentralTime bit NULL
                       , ChangeType nchar (1) NULL
            ) 
            ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_CDT ON dbo.DIM_EDW_HealthAssessment
            (
            ConvertedToCentralTime ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_Dates ON dbo.DIM_EDW_HealthAssessment
            (
            ITEMMODIFIEDWHEN ASC,
            HAUSERSTARTED_LASTMODIFIED ASC,
            CMSUSER_LASTMODIFIED ASC,
            USERSETTINGS_LASTMODIFIED ASC,
            USERSITE_LASTMODIFIED ASC,
            CMSSITE_LASTMODIFIED ASC,
            ACCT_LASTMODIFIED ASC,
            HAUSERMODULE_LASTMODIFIED ASC,
            VHCJ_LASTMODIFIED ASC,
            VHAJ_LASTMODIFIED ASC,
            HARISKCATEGORY_LASTMODIFIED ASC,
            HAUSERRISKAREA_LASTMODIFIED ASC,
            HAUSERQUESTION_LASTMODIFIED ASC,
            HAQUESTIONSVIEW_LASTMODIFIED ASC,
            HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED ASC,
            HAUSERANSWERS_LASTMODIFIED ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE CLUSTERED INDEX PI_EDW_HealthAssessment_NATKEY ON dbo.DIM_EDW_HealthAssessment
            (
            USERSTARTEDITEMID ASC,
            USERGUID ASC,
            PKHASHCODE ASC,
            DeletedFlg, ChangeType
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;
    ELSE
        BEGIN
            PRINT 'DIM_EDW_HealthAssessment ALREADY exists, skipping.';
        END;
END;
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\createDayLightSavingsTimeFunctions.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'FROM: createDayLightSavingsTimeFunctions.sql';

GO
IF EXISTS ( SELECT
                   *
                   FROM    dbo.sysobjects
                   WHERE
                   id = OBJECT_ID (N'[dbo].[udfGetDstStart]') 
               AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT')) 
    BEGIN
        PRINT 'Replacing udfGetDstStart';
        DROP FUNCTION
             udfGetDstStart;
    END;

GO

CREATE FUNCTION udfGetDstStart (
     @Year AS int) 
RETURNS datetime
AS
--Author: W. Dale Miller
--Date  : Jan 15, 2009
BEGIN
    DECLARE
    @StartOfMarch datetime
  ,@DstStart datetime;

    SET @StartOfMarch = DATEADD (MONTH, 2,
    DATEADD (YEAR, @year - 1900, 0)) ;
    SET @DstStart = DATEADD (HOUR, 2,
    DATEADD (day, ( 15 - DATEPART (dw,
                    @StartOfMarch) ) % 7 + 7, @StartOfMarch)) ;
    RETURN @DstStart;
END;

GO
IF EXISTS ( SELECT
                   *
                   FROM    dbo.sysobjects
                   WHERE
                   id = OBJECT_ID (N'[dbo].[udfGetDstEnd]') 
               AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT')) 
    BEGIN
        PRINT 'Replacing udfGetDstEnd';
        DROP FUNCTION
             dbo.udfGetDstEnd;
    END;
GO
CREATE FUNCTION dbo.udfGetDstEnd (
     @Year AS int) 
RETURNS datetime
AS
--Author: W. Dale Miller
--Date  : Jan 15, 2009
BEGIN
    DECLARE
    @StartOfNovember datetime
  ,@DstEnd datetime;

    SET @StartOfNovember = DATEADD (MONTH, 10,
    DATEADD (YEAR, @year - 1900, 0)) ;
    SET @DstEnd = DATEADD (HOUR, 2,
    DATEADD (day,
    ( 8 - DATEPART (dw,
      @StartOfNovember) ) % 7, @StartOfNovember)) ;
    RETURN @DstEnd;
END;

GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_EDW_Procedure_Performance_Monitor.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating PROC proc_EDW_Procedure_Performance_Monitor.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EDW_Procedure_Performance_Monitor') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_Procedure_Performance_Monitor;
    END;
GO

CREATE PROCEDURE proc_EDW_Procedure_Performance_Monitor
       @Action AS CHAR (1) = 'I'
     , @TraceName NVARCHAR (100) 
     , @TrackID AS NVARCHAR (50) = NULL
AS
BEGIN
    SET NOCOUNT ON;

/*---------------------------------------------------------------------------------------------
I = insert new record
E = add enddate to specified record by TraceName and TrackID
D = delete all occurances of records by TraceName
T = total the elapsed and accumulated time for the specified TraceName

select * from EDW_Proc_Performance_Monitor where TraceName = 'proc_Staging_EDW_Data' order by RowNbr
exec proc_EDW_Procedure_Performance_Monitor 'D', 'proc_Staging_EDW_Data'
exec proc_EDW_Procedure_Performance_Monitor 'I', 'TestRun', '001'
exec proc_EDW_Procedure_Performance_Monitor 'I', 'TestRun', '002'
exec proc_EDW_Procedure_Performance_Monitor 'I', 'TestRun', '003'
exec proc_EDW_Procedure_Performance_Monitor 'I', 'TestRun', '004'
exec proc_EDW_Procedure_Performance_Monitor 'I', 'TestRun', '005'
exec proc_EDW_Procedure_Performance_Monitor 'T', 'proc_Staging_EDW_Data'

update EDW_Proc_Performance_Monitor set ElapsedSecs = cast(ElapsedTime as float)/ 1000 
update EDW_Proc_Performance_Monitor set ElapsedMin = cast(ElapsedTime as float) / 1000 / 60 
update EDW_Proc_Performance_Monitor set ElapsedHrs = cast(ElapsedTime as float) / 1000 / 60 /60
*/
    DECLARE
           @TimeNow AS DATETIME2 = GETDATE () ;

    IF @TrackID IS NULL
        BEGIN
            SET @TrackID = CAST (@TimeNow AS NVARCHAR (50)) 
        END;

    IF @Action = 'D'
        BEGIN
            DELETE FROM EDW_Proc_Performance_Monitor
                   WHERE
                         TraceName = @TraceName;
            RETURN;
        END;

    IF @Action = 'I'
        BEGIN
            INSERT INTO dbo.EDW_Proc_Performance_Monitor
            (
                   TraceName
                 , TrackID
                 , StartTime
                 , EndTime
                 , ElapsedTime
                 , ElapsedTimeUnits) 
            VALUES
            (
            @TraceName
            , @TrackID
            , @TimeNow
            , NULL
            , NULL
            , 'ms') ;
        END;
    IF @Action = 'E'
        BEGIN
            DECLARE
                   @sd AS DATETIME = (SELECT
                                             StartTime
                                             FROM EDW_Proc_Performance_Monitor
                                             WHERE
                                             TraceName = @TraceName AND
                                             TrackID = @TrackID) ;
            DECLARE
                   @Dstring AS NVARCHAR (50) = CAST (@sd AS NVARCHAR (50)) ;
            DECLARE
                   @ms AS INT = DATEDIFF (millisecond , @Dstring , @Dstring) ;

            UPDATE dbo.EDW_Proc_Performance_Monitor
              SET
                  EndTime = GETDATE () 
                ,ElapsedTime = @ms
                   WHERE
                         TraceName = @TraceName AND
                         TrackID = @TrackID;
        END;
    IF @Action = 'T'
        BEGIN

            DECLARE
                   @ST AS DATETIME2 (7) = NULL;
            DECLARE
                   @ET AS DATETIME2 (7) = NULL;
            DECLARE
                   @ElapsedTime AS INT = 0;
            DECLARE
                   @RN AS INT = 0;
            DECLARE
                   @PrevRN AS INT = 0;
            DECLARE
                   @i AS INT = 0;
            DECLARE
                   @initTime AS DATETIME2 = NULL;
            DECLARE
                   @accumTime AS INT = 0;

            SET @ElapsedTime = DATEDIFF (microsecond , @ET , @ST) ;
            PRINT @ElapsedTime;

            DECLARE db_cursor CURSOR
                FOR
                    SELECT
                           TraceName
                         , RowNbr
                         , StartTime
                           FROM dbo.EDW_Proc_Performance_Monitor
                           WHERE TraceName = @TraceName
                           ORDER BY
                                    RowNbr;

            OPEN db_cursor;
            FETCH NEXT FROM db_cursor INTO @TraceName , @RN , @ST;

            WHILE @@FETCH_STATUS = 0
                BEGIN
                    SET @ST = (SELECT
                                      StartTime
                                      FROM EDW_Proc_Performance_Monitor
                                      WHERE RowNbr = @RN) ;
                    SET @PrevRN = (SELECT
                                          MAX (Rownbr) 
                                          FROM EDW_Proc_Performance_Monitor
                                          WHERE RowNbr < @RN) ;
                    SET @ET = (SELECT
                                      StartTime
                                      FROM EDW_Proc_Performance_Monitor
                                      WHERE RowNbr = @PrevRN) ;

                    IF @i = 0
                        BEGIN
                            SET @initTime = @ST;
                            SET @accumTime = 0;
                            SET @ElapsedTime = 0;
                        END;
                    ELSE
                        BEGIN
                            SET @ElapsedTime = DATEDIFF (MILLISECOND , @ET , @ST) ;
                            SET @accumTime = DATEDIFF (MILLISECOND , @initTime , @ST) ;
                        END;

                    --if @i > 100 and @i < 150 
                    --print @RN, @PrevRN, @ET, @accumTime ;

                    UPDATE dbo.EDW_Proc_Performance_Monitor
                      SET
                          ElapsedTime = @ElapsedTime
                        ,AccumulatedTime = @accumTime
                        ,ElapsedSecs = CAST (@ElapsedTime AS FLOAT) / 1000
                        ,ElapsedMin = CAST (@ElapsedTime AS FLOAT) / 1000 / 60
                        ,ElapsedHrs = CAST (@ElapsedTime AS FLOAT) / 1000 / 60 / 60
                           WHERE
                                 RowNbr = @RN;
                    SET @i = @i + 1;
                    FETCH NEXT FROM db_cursor INTO @TraceName , @RN , @ST;
                END;

            CLOSE db_cursor;
            DEALLOCATE db_cursor;
        END;

END;  --Procedure

GO
PRINT 'Created PROC proc_EDW_Procedure_Performance_Monitor.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "create_TEMP_Staging_EDW_HealthAssessment_DATA.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'create_TEMP_EDW_HealthAssessment_DATA.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'TEMP_EDW_HealthAssessment_DATA') 
    BEGIN
        DROP TABLE
             dbo.TEMP_EDW_HealthAssessment_DATA
    END;

GO

CREATE TABLE dbo.TEMP_EDW_HealthAssessment_DATA (
		  SVR NVARCHAR (100) NULL
		  ,DBNAME NVARCHAR (100) NULL
           ,UserStartedItemID INT NULL
           ,HealthAssesmentUserStartedNodeGUID UNIQUEIDENTIFIER NULL
           ,UserID BIGINT NULL
           ,UserGUID UNIQUEIDENTIFIER NULL
           ,HFitUserMpiNumber BIGINT NULL
           ,SiteGUID UNIQUEIDENTIFIER NULL
           ,AccountID INT NULL
           ,AccountCD NVARCHAR (8) NULL
           ,AccountName NVARCHAR (200) NULL
           ,HAStartedDt DATETIME NULL
           ,HACompletedDt DATETIME NULL
           ,UserModuleItemId INT NULL
           ,UserModuleCodeName NVARCHAR (100) NULL
           ,HAModuleNodeGUID UNIQUEIDENTIFIER NULL
           ,CMSNodeGuid UNIQUEIDENTIFIER NULL
           ,HAModuleVersionID INT NULL
           ,UserRiskCategoryItemID INT NULL
           ,UserRiskCategoryCodeName NVARCHAR (100) NULL
           ,HARiskCategoryNodeGUID UNIQUEIDENTIFIER NULL
           ,HARiskCategoryVersionID INT NULL
           ,UserRiskAreaItemID INT NULL
           ,UserRiskAreaCodeName NVARCHAR (100) NULL
           ,HARiskAreaNodeGUID UNIQUEIDENTIFIER NULL
           ,HARiskAreaVersionID INT NULL
           ,UserQuestionItemID INT NULL
           ,Title VARCHAR (MAX) NULL
           ,HAQuestionGuid UNIQUEIDENTIFIER NULL
           ,UserQuestionCodeName NVARCHAR (100) NULL
           ,HAQuestionDocumentID INT NULL
           ,HAQuestionVersionID INT NULL
           ,HAQuestionNodeGUID UNIQUEIDENTIFIER NULL
           ,UserAnswerItemID INT NULL
           ,HAAnswerNodeGUID UNIQUEIDENTIFIER NULL
           ,HAAnswerVersionID INT NULL
           ,UserAnswerCodeName NVARCHAR (100) NULL
           ,HAAnswerValue NVARCHAR (255) NULL
           ,HAModuleScore FLOAT NULL
           ,HARiskCategoryScore FLOAT NULL
           ,HARiskAreaScore FLOAT NULL
           ,HAQuestionScore FLOAT NULL
           ,HAAnswerPoints INT NULL
           ,PointResults INT NULL
           ,UOMCode NVARCHAR (10) NULL
           ,HAScore INT NULL
           ,ModulePreWeightedScore FLOAT NULL
           ,RiskCategoryPreWeightedScore FLOAT NULL
           ,RiskAreaPreWeightedScore FLOAT NULL
           ,QuestionPreWeightedScore FLOAT NULL
           ,QuestionGroupCodeName NVARCHAR (100) NULL
           ,ItemCreatedWhen DATETIME NULL
           ,ItemModifiedWhen DATETIME NULL
           ,IsProfessionallyCollected BIT NULL
           ,HARiskCategory_ItemModifiedWhen DATETIME NULL
           ,HAUserRiskArea_ItemModifiedWhen DATETIME NULL
           ,HAUserQuestion_ItemModifiedWhen DATETIME NULL
           ,HAUserAnswers_ItemModifiedWhen DATETIME NULL
           ,HAPaperFlg BIT NULL
           ,HATelephonicFlg BIT NULL
           ,HAStartedMode INT NULL
           ,HACompletedMode INT NULL
           ,DocumentCulture_VHCJ NVARCHAR (10) NULL
           ,DocumentCulture_HAQuestionsView NVARCHAR (10) NULL
           ,CampaignNodeGUID UNIQUEIDENTIFIER NULL
           ,HACampaignID INT NULL
           ,HashCode VARCHAR (100) NULL
           ,ChangeType NCHAR (1) NULL
           ,CHANGED_FLG INT NULL
           ,DeleteFlg INT NULL
           ,CT_CMS_User_UserID INT NULL
           ,CT_CMS_User_CHANGE_OPERATION NCHAR (1) NULL
           ,CT_UserSettingsID INT NULL
           ,CT_UserSettingsID_CHANGE_OPERATION NCHAR (1) NULL
           ,SiteID_CtID INT NULL
           ,SiteID_CHANGE_OPERATION NCHAR (1) NULL
           ,UserSiteID_CtID INT NULL
           ,UserSiteID_CHANGE_OPERATION NCHAR (1) NULL
           ,AccountID_CtID INT NULL
           ,AccountID__CHANGE_OPERATION NCHAR (1) NULL
           ,HAUserAnswers_CtID INT NULL
           ,HAUserAnswers_CHANGE_OPERATION NCHAR (1) NULL
           ,HFit_HealthAssesmentUserModule_CtID INT NULL
           ,HFit_HealthAssesmentUserModule_CHANGE_OPERATION NCHAR (1) NULL
           ,HFit_HealthAssesmentUserQuestion_CtID INT NULL
           ,HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION NCHAR (1) NULL
           ,HFit_HealthAssesmentUserQuestionGroupResults_CtID INT NULL
           ,HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION NCHAR (1) NULL
           ,HFit_HealthAssesmentUserRiskArea_CtID INT NULL
           ,HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION NCHAR (1) NULL
           ,HFit_HealthAssesmentUserRiskCategory_CtID INT NULL
           ,HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION NCHAR (1) NULL
           ,HFit_HealthAssesmentUserStarted_CtID INT NULL
           ,HFit_HealthAssesmentUserStarted_CHANGE_OPERATION NCHAR (1) NULL
           ,CT_CMS_User_SCV BIGINT NULL
           ,CT_CMS_UserSettings_SCV BIGINT NULL
           ,CT_CMS_Site_SCV BIGINT NULL
           ,CT_CMS_UserSite_SCV BIGINT NULL
           ,CT_HFit_Account_SCV BIGINT NULL
           ,CT_HFit_HealthAssesmentUserAnswers_SCV BIGINT NULL
           ,CT_HFit_HealthAssesmentUserModule_SCV BIGINT NULL
           ,CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV BIGINT NULL
           ,CT_HFit_HealthAssesmentUserRiskArea_SCV BIGINT NULL
           ,CT_HFit_HealthAssesmentUserRiskCategory_SCV BIGINT NULL
           ,CT_HFit_HealthAssesmentUserStarted_SCV BIGINT NULL
           ,CT_HFit_HealthAssesmentUserQuestion_SCV BIGINT NULL
           ,ConvertedToCentralTime BIT NULL
           ,LastModifiedDate DATETIME NULL
           ,RowNbr INT NULL
           ,DeletedFlg BIT NULL
           ,TimeZone NVARCHAR (10) NULL
           ,PKHashCode VARCHAR (100) NULL
) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

IF NOT EXISTS ( SELECT
                       name
                       FROM sys.indexes
                       WHERE name = 'Temp_PI_EDW_HealthAssessment_Dates') 
    BEGIN
        PRINT 'Adding INDEX Temp_PI_EDW_HealthAssessment_Dates at: ' + CAST ( GETDATE () AS NVARCHAR ( 50)) ;

        CREATE NONCLUSTERED INDEX Temp_PI_EDW_HealthAssessment_Dates ON dbo.TEMP_EDW_HealthAssessment_DATA (
	   SVR, DBNAME, ItemCreatedWhen ASC ,
        ItemModifiedWhen ASC) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
        DROP_EXISTING = OFF , ONLINE = OFF ,
        ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
    END;

IF NOT EXISTS
( SELECT
         name
         FROM sys.indexes
         WHERE name = 'Temp_CI_EDW_HealthAssessment_NATKEY') 
    BEGIN
        PRINT 'Adding INDEX Temp_CI_EDW_HealthAssessment_NATKEY at: ' + CAST ( GETDATE () AS NVARCHAR ( 50)) ;
        CREATE nonclustered INDEX Temp_CI_EDW_HealthAssessment_NATKEY ON dbo.TEMP_EDW_HealthAssessment_DATA (
        SVR, DBNAME, UserStartedItemID
        , UserGUID)
        include( PKHashCode, DeletedFlg, LastModifiedDate);
    END;

--IF NOT EXISTS ( SELECT
--                       name
--                  FROM sys.indexes
--                  WHERE name = 'Temp_PI_EDW_HealthAssessment_IDs' )
--    BEGIN
--        EXEC PrintNow 'Adding INDEX Temp_PI_EDW_HealthAssessment_IDs';
--        CREATE INDEX Temp_PI_EDW_HealthAssessment_IDs ON dbo.[TEMP_EDW_HealthAssessment_DATA] (
--        UserStartedItemID
--        , HealthAssesmentUserStartedNodeGUID
--        , UserGUID
--        , SiteGUID
--        , AccountCD
--        , HAModuleNodeGUID
--        , CMSNodeGuid
--        , HARiskCategoryNodeGUID
--        , UserRiskAreaItemID
--        , HARiskAreaNodeGUID
--        , UserQuestionItemID
--        , HAQuestionGuid
--        , HAQuestionNodeGUID
--        , UserAnswerItemID
--        , HAAnswerNodeGUID
--        , CampaignNodeGUID
--        )
--        INCLUDE ( AccountID , UserModuleItemId , UserRiskCategoryItemID , DeletedFlg , HASHCODE , LastModifiedDate )
--        WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
--        ALLOW_ROW_LOCKS = ON ,
--        ALLOW_PAGE_LOCKS = ON );
--    END;
GO

GO
PRINT 'Created TEMP_EDW_HealthAssessment_DATA.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_EDW_ChangeGmtToCentralTime.sql" \n 
--------------------------------------------------------------- 
--SELECT
--       *
--       FROM information_schema.tables
--       WHERE table_name LIKE 'staging_edw%';

/* HOW TO USE THIS PROCEDURE:
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_BioMetrics'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Coaches'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_CoachingDetail'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthAssesmentClientView'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthAssessment'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthDefinition'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestDetail'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestList'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardAwardDetail'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardsDefinition'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardTriggerParameters'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserDetail'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserLevel'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_SmallSteps'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Trackers'
*/

/*
SELECT
       table_name
     , column_name
       FROM information_schema.columns
       WHERE
    data_type = 'datetime'
   AND table_name = 'DIM_EDW_Coaches'
       ORDER BY
                table_name, column_name;
*/

/* EXAMPLE:
    Update DIM_EDW_BioMetrics SET 
    CreatedDate = DateAdd(hour, -5, CreatedDate) ,
    EventDate = DateAdd(hour, -5, EventDate) ,
    ItemCreatedWhen = DateAdd(hour, -5, ItemCreatedWhen) ,
    ItemModifiedWhen = DateAdd(hour, -5, ItemModifiedWhen) ,
    LastModifiedDate = DateAdd(hour, -5, LastModifiedDate) ,
    ModifiedDate = DateAdd(hour, -5, ModifiedDate) ,
	ConvertedToCentralTime = 1 
    where ConvertedToCentralTime is null 
*/

GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EDW_ChangeGmtToCentralTime') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_ChangeGmtToCentralTime;
    END;
GO

CREATE PROCEDURE proc_EDW_ChangeGmtToCentralTime (
     @TblName AS nvarchar (100)) 
AS
BEGIN
    BEGIN
	   --Author:  W. Dale Miller
	   --Date  :  05.21.2015
	   --Purpose: Converts a GMT date to Central time considering whether DST or not. Done specificially for the EDW, expressly, laura B.
	   --		Adds a column to track whether the date is converted to central time or not to provide easy fallback if deemed unneeded.
	   
        --DECLARE @TblName AS nvarchar (100) = 'DIM_EDW_RewardUserDetail';

	   DECLARE @CurrTZ nvarchar (250) = null ;
        DECLARE @dstStart AS datetime;
        DECLARE @dstEnd AS datetime;
        DECLARE @currYear AS int = DATEPART (year, GETDATE ()) ;
        DECLARE @t nvarchar (250) ;
        DECLARE @c nvarchar (250) ;
        DECLARE @offset int;
        DECLARE @localDateTime datetime;
        DECLARE @utcDateTime datetime = null ;
	   

        SET @dstStart = dbo.udfGetDstStart ( @currYear) ;
        SET @dstEnd = dbo.udfGetDstEnd ( @currYear) ;
        --PRINT @dstStart;
        --PRINT @dstEnd;

        DECLARE @isDst AS int = 0;

        IF GETDATE () BETWEEN @dstStart AND @dstEnd
            BEGIN
                SET @isDst = 1;
            END;

        --PRINT @isDst;

        DECLARE @CT_Offset AS nvarchar (50) = NULL;
        IF @isDst = 1
            BEGIN
                SET @offset = -5;
                SET @CT_Offset = '-05:00';
			 set @CurrTZ = 'CDT' ;
            END ;
        ELSE
            BEGIN
                SET @offset = -6;
                SET @CT_Offset = '-06:00';
			 set @CurrTZ = 'CST' ;
            END;

        DECLARE @i AS int = 0;
        DECLARE @MySql AS nvarchar (max) = NULL;
        DECLARE db_cursor CURSOR
            FOR
                SELECT
                       column_name
                       FROM information_schema.columns
                       WHERE
                       table_name = @TblName
                   AND data_type = 'datetime'
                       ORDER BY
                                column_name;

        --SELECT SYSDATETIMEOFFSET() ;
        --SELECT SWITCHOFFSET(SYSDATETIMEOFFSET(), @CT_Offset) AS 'US Central Time';

        --SET @offset = DATEDIFF (hour, GETUTCDATE () , GETDATE ()) ;
        --SET @localDateTime = DATEADD (hour, @offset, @utcDateTime) ;

        --PRINT @offset;
        --PRINT @localDateTime;

        IF NOT EXISTS (SELECT
                              column_name
                              FROM information_schema.columns
                              WHERE
                              table_name = @TblName
                          AND column_name = 'ConvertedToCentralTime') 
            BEGIN
                DECLARE @s AS nvarchar (500) ;
                SET @s = 'alter table ' + @TblName + ' add ConvertedToCentralTime bit null ';
                EXEC (@s) ;
                PRINT 'Added column ConvertedToCentralTime to ' + @TblName;
            END;
        DECLARE @idxname AS nvarchar (250) = NULL;
        SET @idxname = 'PI_' + @TblName + '_CDT';
        IF NOT EXISTS (SELECT
                              name
                              FROM sys.indexes
                              WHERE
                              name = @idxname) 
            BEGIN
		      declare @idxsql as nvarchar(max) = '
                CREATE NONCLUSTERED INDEX PI_'+@TblName+'_CDT ON ' + @TblName + ' (ConvertedToCentralTime ASC)';
			 exec (@idxsql ) ;
                PRINT 'Added index ConvertedToCentralTime to ' + @TblName;
            END;

        SET @MySql = 'Update ' + @TblName + ' SET ';
        --PRINT @MySql;

        OPEN db_cursor;
        FETCH NEXT FROM db_cursor INTO  @c;
        WHILE @@FETCH_STATUS = 0
            BEGIN
                SET @i = @i + 1;
                --print '@i = ' + cast(@i as nvarchar(50)) ;
                --            PRINT 'Column: ' + @c;
                SET @MySql = @MySql + CHAR (10) + @c + ' = DateAdd(hour, ' + CAST (@offset AS nvarchar (50)) + ', ' + @c + ') ,';
                --PRINT  @MySql;
                --PRINT '_______________________________________________';
                FETCH NEXT FROM db_cursor INTO @c;
            END;

        CLOSE db_cursor;
        DEALLOCATE db_cursor;

        SET @MySql = @MySql + CHAR (10) + ' ConvertedToCentralTime = 1, TimeZone = ''' + @CurrTZ + '''' + CHAR (10) + '    where ConvertedToCentralTime is null ';

	   --print @MySql ;

        exec( @MySql ) ;
	   declare @iCnt as bigint = @@ROWCOUNT ;
	   print 'Records Updated: ' + cast(@iCnt as nvarchar(50)) ;
    END;
END;
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CkHaDataChanged.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating proc_CkHaDataChanged';
PRINT 'FROM proc_CkHaDataChanged.sql';

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CkHaDataChanged') 
    BEGIN
        DROP PROCEDURE
             proc_CkHaDataChanged;
    END;
GO

/*
 exec proc_CkHaDataChanged 0
declare @i bigint = 0 
exec proc_CkHaDataChanged 12550, @i out
*/
CREATE PROC proc_CkHaDataChanged
     @CTVersionID AS int,@NbrDetectedChanges bigint OUTPUT
AS
BEGIN
/*----------------------------------------
--------------------------------------
Author:	  Dale Miller
Returns:	  @b = 0 - no changes
		  @b = 1 - updates only
		  @b = 2 - deletes only
		  @b = 3 - deletes and updates
		  @b = 4 - inserts only
		  @b = 5 - inserts and updates
		  @b = 6 - inserts and deletes
		  @b = 7 - inserts, updates, and deletes
*/
    DECLARE
    @UpdatesFound TABLE (
                        ChangeType nvarchar (10) NULL) ;
    DECLARE
    @b AS int = 0;

    INSERT INTO @UpdatesFound
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_CMS_Class, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_CMS_Document, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_CMS_Site, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_CMS_Tree, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_CMS_User, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_CMS_UserSettings, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_CMS_UserSite, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_COM_SKU, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_Account, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HACampaign, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentMatrixQuestion, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentMultipleChoiceQuestion, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserAnswers, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserModule, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestion, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestionGroupResults, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskCategory, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserStarted, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssessment, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_HealthAssessmentFreeForm, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES BASE_HFit_LKP_EDW_RejectMPI, @CTVersionID) AS CT;

    set @NbrDetectedChanges = @@ROWCOUNT;
    DECLARE @iInsert AS int = 0;
    DECLARE @iUpdate AS int = 0;
    DECLARE @iDel AS int = 0;

    IF @NbrDetectedChanges = 0
        BEGIN
            PRINT 'No changes found';
            SET @b = 0;
        END;
    ELSE
        BEGIN

            SET @iInsert = (SELECT
                                   COUNT (*) 
                                   FROM @UpdatesFound
                                   WHERE ChangeType = 'I');
            SET @iUpdate = (SELECT
                                   COUNT (*) 
                                   FROM @UpdatesFound
                                   WHERE ChangeType = 'U');
            SET @iDel = (SELECT
                                COUNT (*) 
                                FROM @UpdatesFound
                                WHERE ChangeType = 'D');
            
		  PRINT 'Print Total Changes found in version: ' +cast(@CTVersionID as nvarchar(50)) + ' is '  + CAST (@iInsert AS nvarchar (50)) + CAST (@iDel AS nvarchar (50)) + CAST (@iUpdate AS nvarchar (50)) ;
            PRINT CAST (@NbrDetectedChanges AS nvarchar (50)) + ' TOTAL Changes found: proc_CkHaDataChanged';
            PRINT CAST (@iInsert AS nvarchar (50)) + ' : Inserts found';
            PRINT CAST (@iUpdate AS nvarchar (50)) + ' : Updates found';
            PRINT CAST (@iDel AS nvarchar (50)) + ' : Deletes found';

            IF @iInsert > 0
                BEGIN
                    PRINT CAST (@iInsert AS nvarchar (50)) + ' Inserts found: proc_CkHaDataChanged';
                    SET @b = 1;
                END;
            IF @iUpdate > 0
                BEGIN
                    PRINT CAST (@iUpdate AS nvarchar (50)) + ' Updates found: proc_CkHaDataChanged';
                    SET @b = 1;
                END;
            PRINT CAST (@iDel AS nvarchar (50)) + ' Deletes found: proc_CkHaDataChanged';

            IF @iInsert = 0
           AND @iDel = 0
           AND @iUpdate = 0
                BEGIN
                    PRINT '@b = 0 - no changes';
                    SET @b = 0;
                END;
            IF @iInsert = 0
           AND @iDel = 0
           AND @iUpdate > 0
                BEGIN
                    PRINT '@b > 0 - updates only';
                    SET @b = 1;
                END;
            IF @iInsert = 0
           AND @iDel > 0
           AND @iUpdate = 0
                BEGIN
                    SET @b = 2;
                    PRINT '@b = 2 - deletes only';
                END;
            IF @iInsert = 0
           AND @iDel > 0
           AND @iUpdate > 0
                BEGIN
                    SET @b = 3;
                    PRINT '@b = 3 - deletes and updates';
                END;
            IF @iInsert > 0
           AND @iDel = 0
           AND @iUpdate = 0
                BEGIN
                    SET @b = 4;
                    PRINT '@b = 4 - inserts only';
                END;
            IF @iInsert > 0
           AND @iDel = 0
           AND @iUpdate > 0
                BEGIN
                    SET @b = 5;
                    PRINT '@b = 5 - inserts and updates';
                END;
            IF @iInsert > 0
           AND @iDel > 0
           AND @iUpdate = 0
                BEGIN
                    SET @b = 6;
                    PRINT '@b = 6 - inserts and deletes';
                END;
            IF @iInsert > 0
           AND @iDel > 0
           AND @iUpdate > 0
                BEGIN
                    SET @b = 7;
                    PRINT '@b = 7 - inserts, updates, and deletes';
                END;

		  print 'Returned Value: ' + cast(@b as nvarchar(50)) ;

            RETURN @b;
        END;
END;
GO
PRINT 'Created proc_CkHaDataChanged';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_Add_EDW_CT_StdCols.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating proc_Add_EDW_CT_StdCols.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Add_EDW_CT_StdCols') 
    BEGIN
        DROP PROCEDURE
             proc_Add_EDW_CT_StdCols;
    END;
GO

-- EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthAssessment';
CREATE PROCEDURE proc_Add_EDW_CT_StdCols (
       @tname AS nvarchar (100)) 
AS
BEGIN
    DECLARE @MySql AS nvarchar (2000) = NULL;
    declare @DBN as nvarchar(100) = DB_NAME() ;
    IF @tname LIKE '#%'
        BEGIN
            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'LastModifiedDate') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' ADD LastModifiedDate datetime NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'RowNbr') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' ADD RowNbr int NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'DeletedFlg') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add DeletedFlg bit NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'TimeZone') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add TimeZone nvarchar (10) NULL; ';
                    EXEC (@MySql) ;
                END;
            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'ConvertedToCentralTime') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add ConvertedToCentralTime bit NULL; ';
                    EXEC (@MySql) ;
                END;
			 IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'SVR') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add SVR nvarchar(100) not NULL default(@@SERVERNAME); ';
                    EXEC (@MySql) ;
                END;
			 IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'DBNAME') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add DBNAME nvarchar(100) not NULL default('''+@DBN+'''); ';
                    EXEC (@MySql) ;
                END;
			 IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'HashCode') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add HashCode nvarchar(75) NULL; ';
                    EXEC (@MySql) ;
                END;
        END ;
    ELSE
        BEGIN

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'LastModifiedDate') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' ADD LastModifiedDate datetime NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'RowNbr') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' ADD RowNbr int NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'DeletedFlg') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add DeletedFlg bit NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'TimeZone') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add TimeZone nvarchar (10) NULL; ';
                    EXEC (@MySql) ;
                END;
            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'ConvertedToCentralTime') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add ConvertedToCentralTime bit NULL; ';
                    EXEC (@MySql) ;
                END;

		  IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'SVR') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add SVR nvarchar(100) not NULL default(@@SERVERNAME); ';
                    EXEC (@MySql) ;
                END;
			 IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'DBNAME') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add DBNAME nvarchar(100) not NULL default('''+@DBN+'''); ';
                    EXEC (@MySql) ;
                END;

		  IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'HashCode') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add HashCode nvarchar(75) NULL ; ';
                    EXEC (@MySql) ;
                END;


        END;
--*************************************************************************

END;

GO
PRINT 'Created proc_Add_EDW_CT_StdCols.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\PrintNow.sql" \n 
--------------------------------------------------------------- 


go
print 'Creating procedure PrintNow' ;
print 'FROM PrintNow.sql' ;
go
if exists (select name from sys.procedures where name = 'PrintNow')
    drop procedure PrintNow;

go

create procedure PrintNow (@msg as nvarchar(500))
as
begin
raiserror (@msg, 10,1) with nowait;
end 

go
print 'Created procedure PrintNow' ;

go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "Create_CT_Performance_History.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating CT_Performance_History';
PRINT 'FROM CT_Performance_History.sql';
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.tables
                      WHERE name = 'CT_Performance_History') 
    BEGIN
        PRINT 'CT_Performance_History missing - created now.';
        CREATE TABLE dbo.CT_Performance_History (
           RowGuid uniqueidentifier NOT NULL
         ,RowNbr int IDENTITY (1, 1) 
                     NOT NULL
         ,CALLING_PROC nvarchar (100) NOT NULL
         ,PROC_LOCATION nvarchar (100) NOT NULL
         ,starttime datetime2 (7) NOT NULL
         ,endtime datetime2 (7) NULL
         ,elapsedsecs decimal (18, 2) NULL
         ,elapsedmin decimal (18, 2) NULL
         ,elapsedhr decimal (18, 2) NULL
         ,RowsProcessed bigint NULL
         ,CreateDate datetime NULL
         ,LastModifiedDate datetime NULL
         ,CONSTRAINT PK_CT_Performance_History PRIMARY KEY CLUSTERED
           (
           RowGuid ASC,
           RowNbr ASC
           ) 
              WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
        ) 
        ON [PRIMARY];

        ALTER TABLE dbo.CT_Performance_History
        ADD
           CONSTRAINT DF_CT_Performance_History_CreateDate  DEFAULT GETDATE () FOR CreateDate;

	   PRINT 'Created CT_Performance_History';
    END;
else 
    PRINT 'CT_Performance_History already exists, skipping create.';
GO

PRINT 'FROM CT_Performance_History.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_Performance_History.sql" \n 
--------------------------------------------------------------- 


GO
PRINT 'Creating proc_CT_Performance_History';
PRINT 'FROM proc_CT_Performance_History.sql';
GO

IF EXISTS (SELECT
              name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_Performance_History') 
    BEGIN
        DROP PROCEDURE
           proc_CT_Performance_History;
    END;
GO

/*
Author: W. Dale Miller
Created: 05.06.2015
Purpose: Track ongoing performance of selected procs and functions

exec proc_CT_Performance_History @RowGuid, @CALLING_PROC, @PROC_LOCATION, @starttime, @endtime, @elapsedsecs, @RowsProcessed ;

*/

CREATE PROCEDURE proc_CT_Performance_History
       @RowGuid AS uniqueidentifier
     , @CALLING_PROC AS nvarchar (100) 
     , @PROC_LOCATION AS nvarchar (100) 
     , @starttime AS datetime2 = NULL
     , @endtime  AS datetime2 = NULL
     , @elapsedsecs AS bigint = NULL
     , @RowsProcessed AS bigint = NULL
AS
BEGIN

    DECLARE @iCnt AS int = 0
          , @elapsedmin AS decimal (10, 2) 
          , @elapsedhr AS decimal (10, 2) ;

    SET @iCnt = (SELECT
                    COUNT (*) 
                        FROM CT_Performance_History
                        WHERE RowGuid = @RowGuid );

    IF @iCnt = 0
        BEGIN
            IF @starttime IS NULL
                BEGIN
                    SET @starttime = GETDATE () ;
                END;

            INSERT INTO dbo.CT_Performance_History
            (
               RowGuid
             , CALLING_PROC
             , PROC_LOCATION
             , starttime
             , endtime
             , elapsedsecs
             , elapsedmin
             , elapsedhr
             , RowsProcessed
             , CreateDate
             , LastModifiedDate) 
            VALUES
                   (
                   @RowGuid
                   , @CALLING_PROC
                   , @PROC_LOCATION
                   , @starttime
                   , @endtime
                   , @elapsedsecs
                   , @elapsedmin
                   , @elapsedhr
                   , @RowsProcessed
                   , GETDATE () 
                   , GETDATE ()) ;
        END;

    --IF @starttime IS NOT NULL
    --        BEGIN
    --            UPDATE CT_Performance_History
    --                   SET
    --               starttime = @starttime;
    --        END;
    IF @endtime IS NOT NULL
        BEGIN
            UPDATE CT_Performance_History
                   SET
               endtime = @endtime
            WHERE
               RowGuid = @RowGuid;
        END;
    IF
           @endtime IS NOT NULL
       AND @starttime IS NOT NULL
        BEGIN
            SET @elapsedsecs = DATEDIFF ( second , @starttime , @endtime) ;

            UPDATE CT_Performance_History
                   SET
               elapsedsecs = @elapsedsecs
            WHERE
               RowGuid = @RowGuid;
        END;
    IF @elapsedsecs IS NOT NULL
        BEGIN
            UPDATE CT_Performance_History
                   SET
               elapsedsecs = @elapsedsecs
            WHERE
               RowGuid = @RowGuid;
            DECLARE @m AS decimal (10, 2) = @elapsedsecs / 60;
            UPDATE CT_Performance_History
                   SET
               elapsedmin = @m
            WHERE
               RowGuid = @RowGuid;
            DECLARE @h AS decimal (10, 2) = @m / 60;
            UPDATE CT_Performance_History
                   SET
               elapsedhr = @h
            WHERE
               RowGuid = @RowGuid;
        END;
    IF @RowsProcessed IS NOT NULL
        BEGIN
            UPDATE CT_Performance_History
                   SET
               RowsProcessed = @RowsProcessed
            WHERE
               RowGuid = @RowGuid;
        END;
    UPDATE CT_Performance_History
           SET
       LastModifiedDate = GETDATE () 
    WHERE
       RowGuid = @RowGuid;

END;

GO
PRINT 'Created proc_CT_Performance_History';
PRINT 'FROM proc_CT_Performance_History.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "isJobRunning.sql" \n 
--------------------------------------------------------------- 

/*-------------------------------------------------------------------
exec isJobRunning 'job_EDW_GetStagingData_HA_KenticoCMS_Prod1'
exec isJobRunning 'job_EDW_GetStagingData_HA_KenticoCMS_Prod3'
exec isJobRunning 'job_EDW_GetStagingData_HADefinition_KenticoCMS_QA'

declare @b as int = 0 ;
exec @b = isJobRunning 'job_EDW_GetStagingData_HA_KenticoCMS_Prod1' ;
print @b
*/

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'isJobRunning') 
    BEGIN
        DROP PROCEDURE
             isJobRunning;
    END;
GO

CREATE PROCEDURE isJobRunning (
       @jobname AS NVARCHAR (100)) 
AS
BEGIN
    --DECLARE @jobname sysname  ='job_EDW_GetStagingData_HA_KenticoCMS_Prod1' -- Enter the job name here
    SET NOCOUNT ON;
    IF NOT EXISTS (SELECT
                          *
                          FROM msdb..sysjobs
                          WHERE Name = @jobname) 
        BEGIN
            PRINT @jobname + ' Job does not exists';
        END;
    ELSE
        BEGIN
            DECLARE
                   @State AS INT = 0;
            CREATE TABLE #xp_results
            (
                         job_id                UNIQUEIDENTIFIER NOT NULL
                       , last_run_date         INT              NOT NULL
                       , last_run_time         INT              NOT NULL
                       , next_run_date         INT              NOT NULL
                       , next_run_time         INT              NOT NULL
                       , next_run_schedule_id  INT              NOT NULL
                       , requested_to_run      INT              NOT NULL
                       , request_source        INT              NOT NULL
                       , request_source_id     SYSNAME          COLLATE database_default NULL
                       , running               INT              NOT NULL
                       , current_step          INT              NOT NULL
                       , current_retry_attempt INT              NOT NULL
                       , job_state             INT              NOT NULL
            );
            INSERT INTO  #xp_results
            EXECUTE DFINAnalytics.dbo.xp_sqlagent_enum_jobs 1 , 'sa';
            IF EXISTS (
            SELECT
                   1
                   FROM
                        #xp_results AS X
                             INNER JOIN
                             msdb..sysjobs AS J
                             ON X.job_id = J.job_id
                   WHERE
                   x.running = 1 AND
                   j.name = @jobname) 
                BEGIN
                    PRINT @jobname + ' : Job is Running';
                    SET @State = 1;
                END;
            ELSE
                BEGIN
                    PRINT @jobname + ' : Job is NOT Running';
                    SET @State = 0;
                END;
            DROP TABLE
                 #xp_results;
            RETURN @State;
        END;
END;--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_CoachingDefinition_CT.sql" \n 
--------------------------------------------------------------- 

go
-- use KenticoCMS_Prod1

print ('Processing: view_EDW_CoachingDefinition_CT ') ;
go

if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_CoachingDefinition_CT')
BEGIN
	drop view view_EDW_CoachingDefinition_CT ;
END
GO


--GRANT SELECT
--	ON [dbo].[view_EDW_CoachingDefinition_CT]
--	TO [EDWReader_PRD]
--GO


CREATE VIEW [dbo].[view_EDW_CoachingDefinition_CT]
AS
--********************************************************************************************************
--8/7/2014 - added DocumentGuid 
--8/8/2014 - Generated corrected view in DEV (WDM)
-- Verified last mod date available to EDW 9.10.2014
--11.17.2014 - (wdm) John Croft found an issue with multiple languages being returned.
--		view_EDW_CoachingDefinition_CT pulls its data from a nested view View_HFit_Tobacco_Goal_Joined. I added 
--		a Document Culture filter on the SELECT STATEMENT pulling the data from View_HFit_Tobacco_Goal_Joined.
--		In LAB DB, when the view is executed W/O the filter, I get 90 rows. When executed with the filter, I 
--		get 89 rows. This would indicate the filter can be applied at the SELCT statement level. The view has 
--		the change applied and is ready to be regenerated. Also, I needed to add a language filter to 
--		View_HFit_Goal_Joined. Additionally, I allow the view to return the Document Culture as a column so 
--		that we can see the associated language. This can be removed if not wanted, but for troubleshooting 
--		it is useful.
--********************************************************************************************************
/*
drop table TEMPXX;
go
select * 
into TEMPXX
from view_EDW_CoachingDefinition_CT

select count(*) from [view_EDW_CoachingDefinition_CT]
select * from [view_EDW_CoachingDefinition_CT]
*/
SELECT
	GJ.GoalID
	, GJ.DocumentGuid
	, GJ.NodeSiteID
	, cs.SiteGUID
	, GJ.GoalImage
	, GJ.Goal
	, dbo.udf_StripHTML(GJ.GoalText) GoalText --
	, dbo.udf_StripHTML(GJ.GoalSummary) GoalSummary --
	, GJ.TrackerAssociation
	, GJ.GoalFrequency
	, HFLF.FrequencySingular
	, HFLF.FrequencyPlural
	, GJ.GoalUnitOfMeasure
	, HFLUOM.UnitOfMeasure
	, GJ.GoalDirection
	, GJ.GoalPrecision
	, GJ.GoalAbsoluteMin
	, GJ.GoalAbsoluteMax
	, dbo.udf_StripHTML(GJ.SetGoalText) SetGoalText --
	, dbo.udf_StripHTML(GJ.HelpText) HelpText --
	, GJ.EvaluationType
	, GJ.CatalogDisplay
	, GJ.AllowModification
	, GJ.ActivityText
	, dbo.udf_StripHTML(GJ.SetGoalModifyText) SetgoalModifyText
	, GJ.IsLifestyleGoal
	, GJ.CodeName
	, CASE	WHEN CAST(gj.DocumentCreatedWhen AS DATE) = CAST(gj.DocumentModifiedWhen AS DATE)
			THEN 'I'
			ELSE 'U'
		END AS ChangeType
	, GJ.DocumentCreatedWhen
	, GJ.DocumentModifiedWhen
	, GJ.DocumentCulture
	,hashbytes('sha1',
		   isNull(cast(GJ.GoalID as nvarchar(50)),'-')
		   + isNull(cast( GJ.DocumentGuid as nvarchar(50)),'-')
		   + isNull(cast( GJ.NodeSiteID as nvarchar(50)),'-')
		   + isNull(cast( cs.SiteGUID as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalImage as nvarchar(50)),'-')
		   + isNull(cast( GJ.Goal as nvarchar(50)),'-')
		   + isnull(LEFT(GJ.GoalText,1000),'-')
		   + isnull(left(GJ.GoalSummary,1000),'-')
		   + isNull(cast( GJ.TrackerAssociation as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalFrequency as nvarchar(50)),'-')
		   + isNull(cast( HFLF.FrequencySingular as nvarchar(50)),'-')
		   + isNull(cast( HFLF.FrequencyPlural as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalUnitOfMeasure as nvarchar(50)),'-')
		   + isNull(cast( HFLUOM.UnitOfMeasure as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalDirection as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalPrecision as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalAbsoluteMin as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalAbsoluteMax as nvarchar(50)),'-')
		   + isnull(left(GJ.SetGoalText,1000),'-')
		   + isnull(left(GJ.HelpText,1000),'-')
		   + isNull(cast( GJ.EvaluationType as nvarchar(50)),'-')
		   + isNull(cast( GJ.CatalogDisplay as nvarchar(50)),'-')
		   + isNull(cast( GJ.AllowModification as nvarchar(50)),'-')
		   + isnull(left(GJ.ActivityText, 1000),'-')
		   + isnull(left(GJ.SetGoalModifyText,1000),'-')
		   + isNull(cast( GJ.IsLifestyleGoal as nvarchar(50)),'-')
		   + isNUll( GJ.CodeName, '-')
		   + isNull(cast( GJ.DocumentCreatedWhen as nvarchar(50)),'-')
		   + isNull(cast( GJ.DocumentModifiedWhen as nvarchar(50)),'-')
		   + isNull( GJ.DocumentCulture, '-')
	   ) as HashCode
, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
	(
		SELECT
			VHFGJ.GoalID
			, VHFGJ.DocumentGuid	--, VHFGJ.DocumentID
			, VHFGJ.NodeSiteID
			, VHFGJ.GoalImage
			, VHFGJ.Goal
			, VHFGJ.GoalText
			, VHFGJ.GoalSummary
			, VHFGJ.TrackerNodeGUID as TrackerAssociation  --VHFGJ.TrackerAssociation
			, VHFGJ.GoalFrequency
			, VHFGJ.GoalUnitOfMeasure
			, VHFGJ.GoalDirection
			, VHFGJ.GoalPrecision
			, VHFGJ.GoalAbsoluteMin
			, VHFGJ.GoalAbsoluteMax
			, VHFGJ.SetGoalText
			, VHFGJ.HelpText
			, VHFGJ.EvaluationType
			, VHFGJ.CatalogDisplay
			, VHFGJ.AllowModification
			, VHFGJ.ActivityText
			, VHFGJ.SetGoalModifyText
			, VHFGJ.IsLifestyleGoal
			, VHFGJ.CodeName
			, VHFGJ.DocumentCreatedWhen
			, VHFGJ.DocumentModifiedWhen
			, VHFGJ.DocumentCulture
		, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
			dbo.View_HFit_Goal_Joined AS VHFGJ
			where VHFGJ.DocumentCulture = 'en-US'
		UNION ALL
		SELECT
			VHFTGJ.GoalID
			, VHFTGJ.DocumentGuid	--, VHFTGJ.DocumentID
			, VHFTGJ.NodeSiteID
			, VHFTGJ.GoalImage
			, VHFTGJ.Goal
			, NULL AS GoalText
			, VHFTGJ.GoalSummary
			, VHFTGJ.TrackerNodeGUID as TrackerAssociation  --VHFTGJ.TrackerAssociation
			, VHFTGJ.GoalFrequency
			, NULL AS GoalUnitOfMeasure
			, VHFTGJ.GoalDirection
			, VHFTGJ.GoalPrecision
			, VHFTGJ.GoalAbsoluteMin
			, VHFTGJ.GoalAbsoluteMax
			, NULL AS SetGoalText
			, NULL AS HelpText
			, VHFTGJ.EvaluationType
			, VHFTGJ.CatalogDisplay
			, VHFTGJ.AllowModification
			, VHFTGJ.ActivityText
			, NULL SetGoalModifyText
			, VHFTGJ.IsLifestyleGoal
			, VHFTGJ.CodeName
			, VHFTGJ.DocumentCreatedWhen
			, VHFTGJ.DocumentModifiedWhen
			, VHFTGJ.DocumentCulture
		, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
			dbo.View_HFit_Tobacco_Goal_Joined AS VHFTGJ
			where VHFTGJ.DocumentCulture = 'en-US'
	) AS GJ
LEFT OUTER JOIN dbo.HFit_LKP_UnitOfMeasure AS HFLUOM ON GJ.GoalUnitOfMeasure = HFLUOM.UnitOfMeasureID
LEFT OUTER JOIN dbo.HFit_LKP_Frequency AS HFLF ON GJ.GoalFrequency = HFLF.FrequencyID
INNER JOIN cms_site AS CS ON gj.nodesiteid = cs.siteid
--INNER JOIN cms_site AS CS ON gj.siteguid = cs.siteguid
WHERE
	gj.DocumentCreatedWhen IS NOT NULL
	AND gj.DocumentModifiedWhen IS NOT NULL 

GO

--select * from view_EDW_CoachingDefinition_CT  --  
  --  
GO 
print('Completed: view_EDW_CoachingDefinition_CT.sql'); 
print('***** FROM: view_EDW_CoachingDefinition_CT.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "Create_STAGING_EDW_RewardTriggerParameters.SQL" \n 
--------------------------------------------------------------- 


go

print 'Creating the DIM_EDW_RewardTriggerParameters table.';
go

if exists (select name from sys.tables where name = 'DIM_EDW_RewardTriggerParameters')
BEGIN
    drop table DIM_EDW_RewardTriggerParameters;
END

select * 
into DIM_EDW_RewardTriggerParameters
from
view_EDW_RewardTriggerParameters;

GO
SET ANSI_PADDING ON
GO

CREATE CLUSTERED INDEX [PI_EDW_RewardTriggerParameters] ON [dbo].[DIM_EDW_RewardTriggerParameters]
(
	  [SiteGUID]
      ,[RewardTriggerID]
     ,[ParameterDisplayName]
      ,[RewardTriggerParameterOperator]
      ,[Value]
      ,[AccountID]
      ,[AccountCD]
      ,[DocumentGuid]
      ,[NodeGuid]
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)

 ALTER TABLE DIM_EDW_RewardTriggerParameters
                    ADD
                                LastModifiedDate datetime NULL;
                    ALTER TABLE DIM_EDW_RewardTriggerParameters
                    ADD
                                RowNbr  int IDENTITY (1, 1) ;
                    ALTER TABLE DIM_EDW_RewardTriggerParameters
                    ADD
                                DeletedFlg  bit NULL;


go
print 'Created the DIM_EDW_RewardTriggerParameters table.';
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "create_StagingTables.sql" \n 
--------------------------------------------------------------- 

GO

--select top 10 * into XX_TEMP from view_EDW_HealthAssesment_CT

PRINT 'Creating the STAGING tables';

GO

/*-------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------
*********************************************************************************************************************
=============================================================
DATE:      04-17-2015 16:49:54
SERVER:    hfit-tgt.cloudapp.net,2
Author:	  Dale Miller
Tables:
		DIM_EDW_HealthAssessmentDefinition, DIM_EDW_Coaches, DIM_EDW_CoachingDetail
		DIM_EDW_HealthAssesmentClientView, DIM_EDW_HealthAssessment, DIM_EDW_HealthDefinition
		DIM_EDW_HealthInterestDetail, DIM_EDW_HealthInterestList, DIM_EDW_RewardAwardDetail
		DIM_EDW_RewardTriggerParameters, DIM_EDW_RewardUserDetail, DIM_EDW_RewardUserLevel
		DIM_EDW_SmallSteps, DIM_EDW_Trackers, TEMP_EDW_Coaches_DATA
		TEMP_EDW_CoachingDetail_DATA, TEMP_EDW_HealthDefinition_DATA, TEMP_EDW_RewardAwardDetail_DATA
		TEMP_EDW_RewardTriggerParameters_DATA, TEMP_EDW_RewardUserLevel_DATA, TEMP_EDW_Tracker_DATA


=============================================================
*********************************************************************************************************************
*/

--IF EXISTS ( SELECT
--                   name
--              FROM sys.procedures
--              WHERE name = 'spPullEdwCompositeTracker' )

--    BEGIN

--        DROP PROCEDURE
--             spPullEdwCompositeTracker;
--    END;

--GO

--IF EXISTS ( SELECT
--                   name
--              FROM sys.procedures
--              WHERE name = 'proc_EDW_HA_Changes' )

--    BEGIN

--        DROP PROCEDURE
--             proc_EDW_HA_Changes;
--    END;

--GO

--IF EXISTS ( SELECT
--                   name
--              FROM sys.procedures
--              WHERE name = 'spPullEdwHaDefinition' )

--    BEGIN

--        DROP PROCEDURE
--             spPullEdwHaDefinition;
--    END;

--GO

PRINT 'Creating DIM_EDW_RewardsDefinition';

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_RewardsDefinition') 

    BEGIN

        DROP TABLE
             DIM_EDW_RewardsDefinition;
    END;

GO

CREATE TABLE dbo.DIM_EDW_RewardsDefinition (
             SiteGUID uniqueidentifier NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , RewardProgramGUID uniqueidentifier NOT NULL
           , RewardProgramName nvarchar (100) NOT NULL
           , RewardProgramPeriodStart datetime NOT NULL
           , RewardProgramPeriodEnd datetime NOT NULL
           , RewardGroupGuid uniqueidentifier NOT NULL
           , GroupName nvarchar (100) NOT NULL
           , RewardLevelGuid uniqueidentifier NOT NULL
           , Level nvarchar (50) NOT NULL
           , RewardLevelTypeLKPName nvarchar (25) NOT NULL
           , AwardDisplayName nvarchar (255) NULL
           , AwardType int NOT NULL
           , AwardThreshold1 int NOT NULL
           , AwardThreshold2 int NOT NULL
           , AwardThreshold3 int NOT NULL
           , AwardThreshold4 int NOT NULL
           , AwardValue1 float NOT NULL
           , AwardValue2 float NOT NULL
           , AwardValue3 float NOT NULL
           , AwardValue4 float NOT NULL
           , ExternalFulfillmentRequired bit NOT NULL
           , RewardActivityGuid uniqueidentifier NOT NULL
           , ActivityName nvarchar (150) NOT NULL
           , ActivityFreqOrCrit int NULL
           , ActivityPoints float NOT NULL
           , IsBundle bit NOT NULL
           , IsRequired bit NULL
           , MaxThreshold int NOT NULL
           , AwardPointsIncrementally bit NOT NULL
           , AllowMedicalExceptions bit NOT NULL
           , RewardTriggerGuid uniqueidentifier NOT NULL
           , RewardTriggerDynamicValue bit NULL
           , TriggerName nvarchar (100) NOT NULL
           , RewardTriggerParameterOperator int NOT NULL
           , RewardTriggerParmGUID uniqueidentifier NOT NULL
           , [Value] float NOT NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentCulture_VHFRAJ nvarchar (10) NOT NULL
           , DocumentCulture_VHFRPJ nvarchar (10) NOT NULL
           , DocumentCulture_VHFRGJ nvarchar (10) NOT NULL
           , DocumentCulture_VHFRLJ nvarchar (10) NOT NULL
           , DocumentCulture_VHFRTPJ nvarchar (10) NOT NULL
           , LevelName nvarchar (128) NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10) 
) 
ON [PRIMARY];

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardsDefinition';

GO

PRINT 'CREATED DIM_EDW_RewardsDefinition';

GO

SET ANSI_WARNINGS ON;

SET XACT_ABORT ON;

SET ARITHABORT ON;

SET NOCOUNT ON;

SET NUMERIC_ROUNDABORT OFF;

SET CONCAT_NULL_YIELDS_NULL ON;

GO

-- Create Table [dbo].[DIM_EDW_HealthAssessment]

PRINT 'Create Table [dbo].[DIM_EDW_HealthAssessment]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthAssessment') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthAssessment;
    END;

GO

SET ANSI_NULLS ON;

GO

SET QUOTED_IDENTIFIER ON;

GO

SET ANSI_PADDING ON;

GO

--ALTER TABLE DIM_EDW_HealthAssessment ALTER COLUMN DeleteFlg INT NULL
CREATE TABLE dbo.DIM_EDW_HealthAssessment (
             USERSTARTEDITEMID int NULL
           , HEALTHASSESMENTUSERSTARTEDNODEGUID uniqueidentifier NULL
           , USERID bigint NULL
           , USERGUID uniqueidentifier NULL
           , HFITUSERMPINUMBER bigint NULL
           , SITEGUID uniqueidentifier NULL
           , ACCOUNTID int NULL
           , ACCOUNTCD nvarchar (8) NULL
           , ACCOUNTNAME nvarchar (200) NULL
           , HASTARTEDDT datetime NULL
           , HACOMPLETEDDT datetime NULL
           , USERMODULEITEMID int NULL
           , USERMODULECODENAME nvarchar (100) NULL
           , HAMODULENODEGUID uniqueidentifier NULL
           , CMSNODEGUID uniqueidentifier NULL
           , HAMODULEVERSIONID int NULL
           , USERRISKCATEGORYITEMID int NULL
           , USERRISKCATEGORYCODENAME nvarchar (100) NULL
           , HARISKCATEGORYNODEGUID uniqueidentifier NULL
           , HARISKCATEGORYVERSIONID int NULL
           , USERRISKAREAITEMID int NULL
           , USERRISKAREACODENAME nvarchar (100) NULL
           , HARISKAREANODEGUID uniqueidentifier NULL
           , HARISKAREAVERSIONID int NULL
           , USERQUESTIONITEMID int NULL
           , TITLE varchar (max) NULL
           , HAQUESTIONGUID uniqueidentifier NULL
           , USERQUESTIONCODENAME nvarchar (100) NULL
           , HAQUESTIONDOCUMENTID int NULL
           , HAQUESTIONVERSIONID int NULL
           , HAQUESTIONNODEGUID uniqueidentifier NULL
           , USERANSWERITEMID int NULL
           , HAANSWERNODEGUID uniqueidentifier NULL
           , HAANSWERVERSIONID int NULL
           , USERANSWERCODENAME nvarchar (100) NULL
           , HAANSWERVALUE nvarchar (255) NULL
           , HAMODULESCORE float NULL
           , HARISKCATEGORYSCORE float NULL
           , HARISKAREASCORE float NULL
           , HAQUESTIONSCORE float NULL
           , HAANSWERPOINTS int NULL
           , POINTRESULTS int NULL
           , UOMCODE nvarchar (10) NULL
           , HASCORE int NULL
           , MODULEPREWEIGHTEDSCORE float NULL
           , RISKCATEGORYPREWEIGHTEDSCORE float NULL
           , RISKAREAPREWEIGHTEDSCORE float NULL
           , QUESTIONPREWEIGHTEDSCORE float NULL
           , QUESTIONGROUPCODENAME nvarchar (100) NULL
           , ITEMCREATEDWHEN datetime NULL
           , ITEMMODIFIEDWHEN datetime NULL
           , ISPROFESSIONALLYCOLLECTED bit NULL
           , HARISKCATEGORY_ITEMMODIFIEDWHEN datetime NULL
           , HAUSERRISKAREA_ITEMMODIFIEDWHEN datetime NULL
           , HAUSERQUESTION_ITEMMODIFIEDWHEN datetime NULL
           , HAUSERANSWERS_ITEMMODIFIEDWHEN datetime NULL
           , HAPAPERFLG bit NULL
           , HATELEPHONICFLG bit NULL
           , HASTARTEDMODE int NULL
           , HACOMPLETEDMODE int NULL
           , DOCUMENTCULTURE_VHCJ nvarchar (10) NULL
           , DOCUMENTCULTURE_HAQUESTIONSVIEW nvarchar (10) NULL
           , CAMPAIGNNODEGUID uniqueidentifier NULL
           , HACAMPAIGNID int NULL
           , HASHCODE varchar (100) NULL
           , PKHASHCODE varchar (100) NULL
           , CHANGED_FLG int NULL
           , LASTMODIFIEDDATE datetime NULL
           , HEALTHASSESSMENTTYPE varchar (9) NULL
           , HAUSERSTARTED_LASTMODIFIED datetime NULL
           , CMSUSER_LASTMODIFIED datetime NULL
           , USERSETTINGS_LASTMODIFIED datetime NULL
           , USERSITE_LASTMODIFIED datetime NULL
           , CMSSITE_LASTMODIFIED datetime NULL
           , ACCT_LASTMODIFIED datetime NULL
           , HAUSERMODULE_LASTMODIFIED datetime NULL
           , VHCJ_LASTMODIFIED datetime NULL
           , VHAJ_LASTMODIFIED datetime NULL
           , HARISKCATEGORY_LASTMODIFIED datetime NULL
           , HAUSERRISKAREA_LASTMODIFIED datetime NULL
           , HAUSERQUESTION_LASTMODIFIED datetime NULL
           , HAQUESTIONSVIEW_LASTMODIFIED datetime NULL
           , HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED datetime NULL
           , HAUSERANSWERS_LASTMODIFIED datetime NULL
           , HAUSERSTARTED_LastUpdateID int NULL
           , CMSUSER_LastUpdateID int NULL
           , USERSETTINGS_LastUpdateID int NULL
           , USERSITE_LastUpdateID int NULL
           , CMSSITE_LastUpdateID datetime NULL
           , ACCT_LastUpdateID datetime NULL
           , HAUSERMODULE_LastUpdateID int NULL
           , VHCJ_LastUpdateID int NULL
           , VHAJ_LastUpdateID int NULL
           , HARISKCATEGORY_LastUpdateID int NULL
           , HAUSERRISKAREA_LastUpdateID int NULL
           , HAUSERQUESTION_LastUpdateID int NULL
           , HAQUESTIONSVIEW_LastUpdateID int NULL
           , HAUSERQUESTIONGROUPRESULTS_LastUpdateID int NULL
           , HAUSERANSWERS_LastUpdateID int NULL
           , LASTUPDATEID int NULL
           , DELETEFLG int NULL
           , SVR nvarchar (128) NULL
           , DBNAME nvarchar (128) NULL
           , DELETEDFLG int NULL
           , RowNbr int NULL
           , TimeZone nvarchar (10) NULL
           , ConvertedToCentralTime bit NULL
) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

SET ANSI_PADDING OFF;

GO

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE name = 'PI_EDW_HealthAssessment_Dates') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_Dates ON dbo.DIM_EDW_HealthAssessment ( ItemCreatedWhen , ItemModifiedWhen , HARiskCategory_ItemModifiedWhen , HAUserRiskArea_ItemModifiedWhen , HAUserQuestion_ItemModifiedWhen , HAUserAnswers_ItemModifiedWhen) ON [PRIMARY];
    END;

GO
IF NOT EXISTS
( SELECT
         name
         FROM sys.indexes
         WHERE name = 'PI_EDW_HealthAssessment_NATKEY') 
    BEGIN
        PRINT 'Adding INDEX PI_EDW_HealthAssessment_NATKEY at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
        CREATE CLUSTERED INDEX PI_EDW_HealthAssessment_NATKEY ON dbo.DIM_EDW_HealthAssessment (
        UserStartedItemID
        , UserGUID
        , PKHashCode , HashCode , DeletedFlg) ;
    END;

GO

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE name = 'PI_EDW_HealthAssessment_Dates') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_Dates ON dbo.DIM_EDW_HealthAssessment
        (
        ITEMMODIFIEDWHEN ASC,
        HAUSERSTARTED_LASTMODIFIED ASC,
        CMSUSER_LASTMODIFIED ASC,
        USERSETTINGS_LASTMODIFIED ASC,
        USERSITE_LASTMODIFIED ASC,
        CMSSITE_LASTMODIFIED ASC,
        ACCT_LASTMODIFIED ASC,
        HAUSERMODULE_LASTMODIFIED ASC,
        VHCJ_LASTMODIFIED ASC,
        VHAJ_LASTMODIFIED ASC,
        HARISKCATEGORY_LASTMODIFIED ASC,
        HAUSERRISKAREA_LASTMODIFIED ASC,
        HAUSERQUESTION_LASTMODIFIED ASC,
        HAQUESTIONSVIEW_LASTMODIFIED ASC,
        HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED ASC,
        HAUSERANSWERS_LASTMODIFIED ASC
        )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
    END;
GO
--ALTER TABLE dbo.DIM_EDW_HealthAssessment SET ( LOCK_ESCALATION = TABLE) ;

GO

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthAssessment';

PRINT 'Create Table [dbo].[TEMP_EDW_RewardUserLevel_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_RewardUserLevel_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_RewardUserLevel_DATA;
    END;
GO

CREATE TABLE dbo.TEMP_EDW_RewardUserLevel_DATA (
             UserId int NOT NULL
           , LevelCompletedDt datetime NOT NULL
           , LevelName nvarchar (100) NOT NULL
           , SiteName nvarchar (100) NOT NULL
           , nodeguid uniqueidentifier NOT NULL
           , SiteGuid uniqueidentifier NOT NULL
           , LevelHeader nvarchar (256) NULL
           , GroupHeadingText nvarchar (40) NULL
           , GroupHeadingDescription nvarchar (1024) NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_RewardUserLevel_IDs ON dbo.TEMP_EDW_RewardUserLevel_DATA ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_RewardUserLevel_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO
-- Create Table [dbo].[DIM_EDW_HealthDefinition]

PRINT 'Create Table [dbo].[DIM_EDW_HealthDefinition]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthDefinition') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthDefinition;
    END;

go

CREATE TABLE dbo.DIM_EDW_HealthDefinition (
             SiteGUID int NULL
           , AccountCD int NULL
           , HANodeID int NOT NULL
           , HANodeName nvarchar (100) NOT NULL
           , HADocumentID int NULL
           , HANodeSiteID int NOT NULL
           , HADocPubVerID int NULL
           , ModTitle varchar (max) NULL
           , IntroText varchar (max) NULL
           , ModDocGuid uniqueidentifier NOT NULL
           , ModWeight int NOT NULL
           , ModIsEnabled bit NOT NULL
           , ModCodeName nvarchar (100) NOT NULL
           , ModDocPubVerID int NULL
           , RCTitle varchar (max) NULL
           , RCWeight int NOT NULL
           , RCDocumentGUID uniqueidentifier NOT NULL
           , RCIsEnabled bit NOT NULL
           , RCCodeName nvarchar (100) NOT NULL
           , RCDocPubVerID int NULL
           , RATytle varchar (max) NULL
           , RAWeight int NOT NULL
           , RADocumentGuid uniqueidentifier NOT NULL
           , RAIsEnabled bit NOT NULL
           , RACodeName nvarchar (100) NOT NULL
           , RAScoringStrategyID int NOT NULL
           , RADocPubVerID int NULL
           , QuestionType nvarchar (100) NOT NULL
           , QuesTitle varchar (max) NULL
           , QuesWeight int NOT NULL
           , QuesIsRequired bit NOT NULL
           , QuesDocumentGuid uniqueidentifier NOT NULL
           , QuesIsEnabled bit NOT NULL
           , QuesIsVisible nvarchar (max) NULL
           , QuesIsSTaging bit NOT NULL
           , QuestionCodeName nvarchar (100) NOT NULL
           , QuesDocPubVerID int NULL
           , AnsValue nvarchar (150) NULL
           , AnsPoints int NULL
           , AnsDocumentGuid uniqueidentifier NULL
           , AnsIsEnabled bit NULL
           , AnsCodeName nvarchar (100) NULL
           , AnsUOM nvarchar (5) NULL
           , AnsDocPUbVerID int NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , CmsTreeNodeGuid uniqueidentifier NOT NULL
           , HANodeGUID uniqueidentifier NOT NULL
           , SiteLastModified int NULL
           , Account_ItemModifiedWhen int NULL
           , Campaign_DocumentModifiedWhen int NULL
           , Assessment_DocumentModifiedWhen datetime NULL
           , Module_DocumentModifiedWhen datetime NULL
           , RiskCategory_DocumentModifiedWhen datetime NULL
           , RiskArea_DocumentModifiedWhen datetime NULL
           , Question_DocumentModifiedWhen datetime NULL
           , Answer_DocumentModifiedWhen datetime NULL
           , AllowMultiSelect bit NULL
           , LocID varchar (5) NOT NULL
           , HashCode nvarchar (75) NULL
           , CMS_Class_CtID int NULL
           , CMS_Class_SCV bigint NULL
           , CMS_Document_CtID int NULL
           , CMS_Document_SCV bigint NULL
           , CMS_Site_CtID int NULL
           , CMS_Site_SCV bigint NULL
           , CMS_Tree_CtID int NULL
           , CMS_Tree_SCV bigint NULL
           , CMS_User_CtID int NULL
           , CMS_User_SCV bigint NULL
           , COM_SKU_CtID int NULL
           , COM_SKU_SCV bigint NULL
           , HFit_HealthAssesmentMatrixQuestion_CtID int NULL
           , HFit_HealthAssesmentMatrixQuestion_SCV bigint NULL
           , HFit_HealthAssesmentModule_CtID int NULL
           , HFit_HealthAssesmentModule_SCV bigint NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CtID int NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_SCV bigint NULL
           , HFit_HealthAssesmentRiskArea_CtID int NULL
           , HFit_HealthAssesmentRiskArea_SCV bigint NULL
           , HFit_HealthAssesmentRiskCategory_CtID int NULL
           , HFit_HealthAssesmentRiskCategory_SCV bigint NULL
           , HFit_HealthAssessment_CtID int NULL
           , HFit_HealthAssessment_SCV bigint NULL
           , HFit_HealthAssessmentFreeForm_CtID int NULL
           , HFit_HealthAssessmentFreeForm_SCV bigint NULL
           , CMS_Class_CHANGE_OPERATION nchar (1) NULL
           , CMS_Document_CHANGE_OPERATION nchar (1) NULL
           , CMS_Site_CHANGE_OPERATION nchar (1) NULL
           , CMS_Tree_CHANGE_OPERATION nchar (1) NULL
           , CMS_User_CHANGE_OPERATION nchar (1) NULL
           , COM_SKU_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentModule_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskArea_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessment_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessmentFreeForm_CHANGE_OPERATION nchar (1) NULL
           , CHANGED_FLG int NULL
           , CHANGE_TYPE_CODE nchar (1) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

-- Create Table [dbo].[DIM_EDW_HealthInterestList]

PRINT 'Create Table [dbo].[DIM_EDW_HealthInterestList]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthInterestList') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthInterestList;
    END;
GO

CREATE TABLE dbo.DIM_EDW_HealthInterestList (
             HealthAreaID int NOT NULL
           , NodeID int NOT NULL
           , NodeGuid uniqueidentifier NOT NULL
           , AccountCD nvarchar (8) NULL
           , HealthAreaName nvarchar (100) NOT NULL
           , HealthAreaDescription nvarchar (255) NULL
           , CodeName nvarchar (20) NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime2 (7) NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_HealthInterestList ON dbo.DIM_EDW_HealthInterestList ( HealthAreaID , NodeID , NodeGuid , AccountCD) ON [PRIMARY];

GO

CREATE NONCLUSTERED INDEX PI_EDW_HealthInterestList_RowNbrCDate ON dbo.DIM_EDW_HealthInterestList ( RowNbr , LastModifiedDate , DeletedFlg) ON [PRIMARY];
--ALTER TABLE dbo.DIM_EDW_HealthInterestList SET ( LOCK_ESCALATION = TABLE) ;

GO

PRINT 'Create Table [dbo].[TEMP_EDW_Coaches_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_Coaches_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_Coaches_DATA;
    END;
go

CREATE TABLE dbo.TEMP_EDW_Coaches_DATA (
             UserGUID uniqueidentifier NULL
           , SiteGUID uniqueidentifier NULL
           , AccountID int NULL
           , AccountCD nvarchar (8) NULL
           , CoachID int NOT NULL
           , LastName nvarchar (20) NOT NULL
           , FirstName nvarchar (20) NOT NULL
           , StartDate datetime NOT NULL
           , Phone nvarchar (15) NOT NULL
           , email nvarchar (50) NOT NULL
           , Supervisor int NOT NULL
           , SuperCoach bit NOT NULL
           , MaxParticipants int NOT NULL
           , Inactive bit NOT NULL
           , MaxRiskLevel nvarchar (10) NOT NULL
           , Locked bit NOT NULL
           , TimeLocked datetime NULL
           , terminated bit NOT NULL
           , APMaxParticipants int NULL
           , RNMaxParticipants int NULL
           , RNPMaxParticipants int NULL
           , Change_Type nvarchar (1) NULL
           , Last_Update_Dt datetime NULL
           , HashCode nvarchar (75) NULL) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_Coaches_IDs ON dbo.TEMP_EDW_Coaches_DATA ( UserGUID , SiteGUID , AccountID , AccountCD , CoachID , email) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_Coaches_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO
-- Create Table [dbo].[DIM_EDW_Trackers]

PRINT 'Create Table [dbo].[DIM_EDW_Trackers]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_Trackers') 

    BEGIN

        DROP TABLE
             DIM_EDW_Trackers;
    END;

GO

CREATE TABLE dbo.DIM_EDW_Trackers (
             TrackerNameAggregateTable varchar (32) NOT NULL
           , ItemID int NOT NULL
           , EventDate datetime NOT NULL
           , IsProfessionallyCollected bit NOT NULL
           , TrackerCollectionSourceID int NOT NULL
           , Notes nvarchar (1000) NULL
           , UserID int NOT NULL
           , CollectionSourceName_Internal nvarchar (100) NULL
           , CollectionSourceName_External nvarchar (100) NULL
           , EventName varchar (7) NOT NULL
           , UOM varchar (10) NOT NULL
           , KEY1 varchar (18) NOT NULL
           , VAL1 float NULL
           , KEY2 varchar (13) NOT NULL
           , VAL2 float NULL
           , KEY3 varchar (12) NOT NULL
           , VAL3 float NULL
           , KEY4 varchar (9) NOT NULL
           , VAL4 float NULL
           , KEY5 varchar (12) NOT NULL
           , VAL5 float NULL
           , KEY6 varchar (11) NOT NULL
           , VAL6 float NULL
           , KEY7 varchar (10) NOT NULL
           , VAL7 float NULL
           , KEY8 varchar (3) NOT NULL
           , VAL8 float NULL
           , KEY9 varchar (2) NOT NULL
           , VAL9 int NULL
           , KEY10 varchar (2) NOT NULL
           , VAL10 int NULL
           , ItemCreatedBy int NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedBy int NULL
           , ItemModifiedWhen datetime NULL
           , IsProcessedForHa bit NULL
           , TXTKEY1 varchar (10) NOT NULL
           , TXTVAL1 nvarchar (500) NULL
           , TXTKEY2 varchar (8) NOT NULL
           , TXTVAL2 nvarchar (255) NULL
           , TXTKEY3 varchar (2) NOT NULL
           , TXTVAL3 int NULL
           , ItemOrder int NULL
           , ItemGuid uniqueidentifier NULL
           , UserGuid uniqueidentifier NOT NULL
           , MPI varchar (50) NOT NULL
           , ClientCode varchar (12) NULL
           , SiteGUID uniqueidentifier NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , IsAvailable bit NULL
           , IsCustom bit NULL
           , UniqueName nvarchar (50) NULL
           , ColDesc nvarchar (50) NULL
           , VendorID int NULL
           , VendorName nvarchar (32) NULL
           , CT_ItemID int NULL
           , CT_ChangeVersion bigint NULL
           , CMS_Operation nchar (1) NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10) 
           , ItemLastUpdated datetime NULL
) 
ON [PRIMARY];

GO

CREATE NONCLUSTERED INDEX PI_EDW_Tracker_Dates ON dbo.DIM_EDW_Trackers ( TrackerNameAggregateTable , ItemID , ItemModifiedWhen) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_Trackers SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_RewardAwardDetail]

PRINT 'Create Table [dbo].[DIM_EDW_RewardAwardDetail]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_RewardAwardDetail') 

    BEGIN

        DROP TABLE
             DIM_EDW_RewardAwardDetail;
    END;
go

CREATE TABLE dbo.DIM_EDW_RewardAwardDetail (
             UserGUID uniqueidentifier NOT NULL
           , SiteGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , RewardLevelGUID uniqueidentifier NOT NULL
           , AwardType int NOT NULL
           , AwardDisplayName nvarchar (100) NOT NULL
           , RewardValue float NULL
           , ThresholdNumber int NOT NULL
           , UserNotified bit NOT NULL
           , IsFulfilled bit NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO


CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_IDs ON dbo.DIM_EDW_RewardAwardDetail ( UserGUID , SiteGUID , HFitUserMpiNumber , RewardLevelGUID , AwardType , AwardDisplayName , RewardValue , ThresholdNumber , UserNotified , IsFulfilled , AccountID , AccountCD) ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_RewardAwardDetail_IDs ON dbo.DIM_EDW_RewardAwardDetail ( UserGUID , SiteGUID , HFitUserMpiNumber , RewardLevelGUID , AwardType , AwardDisplayName , RewardValue , ThresholdNumber , UserNotified , IsFulfilled , AccountID , AccountCD) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_RewardAwardDetail SET ( LOCK_ESCALATION = TABLE) ;

GO
-- Create Table [dbo].[DIM_EDW_HealthInterestDetail]

PRINT 'Create Table [dbo].[DIM_EDW_HealthInterestDetail]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthInterestDetail') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthInterestDetail;
    END;
GO

CREATE TABLE dbo.DIM_EDW_HealthInterestDetail (
             UserID int NULL
           , UserGUID uniqueidentifier NULL
           , HFitUserMpiNumber bigint NULL
           , SiteGUID uniqueidentifier NULL
           , CoachingHealthInterestID int NULL
           , FirstHealthAreaID int NULL
           , FirstNodeID int NULL
           , FirstNodeGuid uniqueidentifier NULL
           , FirstHealthAreaName nvarchar (100) NULL
           , FirstHealthAreaDescription nvarchar (255) NULL
           , FirstCodeName nvarchar (20) NULL
           , SecondHealthAreaID int NULL
           , SecondNodeID int NULL
           , SecondNodeGuid uniqueidentifier NULL
           , SecondHealthAreaName nvarchar (100) NULL
           , SecondHealthAreaDescription nvarchar (255) NULL
           , SecondCodeName nvarchar (20) NULL
           , ThirdHealthAreaID int NULL
           , ThirdNodeID int NULL
           , ThirdNodeGuid uniqueidentifier NULL
           , ThirdHealthAreaName nvarchar (100) NULL
           , ThirdHealthAreaDescription nvarchar (255) NULL
           , ThirdCodeName nvarchar (20) NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedWhen datetime NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime2 (7) NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10) NULL) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_HealthInterestDetail ON dbo.DIM_EDW_HealthInterestDetail ( UserID , UserGUID , HFitUserMpiNumber , SiteGUID , CoachingHealthInterestID , FirstNodeID , SecondNodeGuid , ThirdNodeGuid) ON [PRIMARY];

GO
CREATE NONCLUSTERED INDEX PI_EDW_HealthInterestDetail_RowNbrCDate ON dbo.DIM_EDW_HealthInterestDetail ( LastModifiedDate , DeletedFlg) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_HealthInterestDetail SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_HealthAssesmentClientView]

PRINT 'Create Table [dbo].[DIM_EDW_HealthAssesmentClientView]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthAssesmentClientView') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthAssesmentClientView;
    END;

GO

CREATE TABLE dbo.DIM_EDW_HealthAssesmentClientView (
             AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , AccountName nvarchar (200) NULL
           , ClientGuid uniqueidentifier NOT NULL
           , SiteGUID uniqueidentifier NOT NULL
           , CompanyID int NULL
           , CompanyGUID int NULL
           , CompanyName int NULL
           , DocumentName nvarchar (100) NOT NULL
           , HAStartDate datetime NULL
           , HAEndDate datetime NULL
           , NodeSiteID int NOT NULL
           , Title nvarchar (150) NOT NULL
           , CodeName nvarchar (100) NOT NULL
           , IsEnabled bit NOT NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , AssesmentModule_DocumentModifiedWhen datetime NULL
           , DocumentCulture_HAAssessmentMod nvarchar (10) NOT NULL
           , DocumentCulture_HACampaign nvarchar (10) NOT NULL
           , DocumentCulture_HAJoined nvarchar (10) NOT NULL
           , BiometricCampaignStartDate datetime NULL
           , BiometricCampaignEndDate datetime NULL
           , CampaignStartDate datetime NOT NULL
           , CampaignEndDate datetime NOT NULL
           , Name nvarchar (200) NOT NULL
           , CampaignNodeGuid uniqueidentifier NOT NULL
           , HACampaignID int NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime2 (7) NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_HealthAssesmentClientView ON dbo.DIM_EDW_HealthAssesmentClientView ( AccountID , AccountCD , AccountName , ClientGuid , SiteGUID , NodeSiteID , CampaignNodeGuid , HACampaignID , CodeName) ON [PRIMARY];

GO
CREATE NONCLUSTERED INDEX PI_EDW_HealthAssesmentClientView_RowNbrCDate ON dbo.DIM_EDW_HealthAssesmentClientView ( RowNbr , LastModifiedDate , DeletedFlg) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_HealthAssesmentClientView SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_CoachingDetail]

PRINT 'Create Table [dbo].[DIM_EDW_CoachingDetail]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_CoachingDetail') 

    BEGIN

        DROP TABLE
             DIM_EDW_CoachingDetail;
    END;

GO

CREATE TABLE dbo.DIM_EDW_CoachingDetail (
             ItemID int NOT NULL
           , ItemGUID uniqueidentifier NOT NULL
           , GoalID int NOT NULL
           , UserID int NOT NULL
           , UserGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , SiteGUID uniqueidentifier NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , AccountName nvarchar (200) NULL
           , IsCreatedByCoach bit NOT NULL
           , BaselineAmount float NOT NULL
           , GoalAmount float NOT NULL
           , DocumentID int NULL
           , GoalStatusLKPID int NOT NULL
           , GoalStatusLKPName nvarchar (100) NOT NULL
           , EvaluationStartDate datetime NULL
           , EvaluationEndDate datetime NULL
           , GoalStartDate datetime NOT NULL
           , CoachDescription nvarchar (500) NULL
           , EvaluationDate datetime NULL
           , Passed bit NULL
           , WeekendDate datetime NULL
           , ChangeType varchar (1) NOT NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedWhen datetime NULL
           , NodeGUID uniqueidentifier NOT NULL
           , CloseReasonLKPID int NOT NULL
           , CloseReason varchar (250) NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_CoachingDetail_IDs ON dbo.DIM_EDW_CoachingDetail ( ItemID , ItemGUID , GoalID , UserID , UserGUID , HFitUserMpiNumber , SiteGUID , AccountID , AccountCD , WeekendDate) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_CoachingDetail SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_RewardUserDetail]

PRINT 'Create Table [dbo].[DIM_EDW_RewardUserDetail]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_RewardUserDetail') 

    BEGIN

        DROP TABLE
             DIM_EDW_RewardUserDetail;
    END;

CREATE TABLE dbo.DIM_EDW_RewardUserDetail (
             UserGUID uniqueidentifier NOT NULL
           , SiteGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , RewardActivityGUID uniqueidentifier NULL
           , RewardProgramName nvarchar (100) NOT NULL
           , RewardModifiedDate datetime NULL
           , RewardGroupGUID uniqueidentifier NULL
           , RewardLevelModifiedDate datetime NULL
           , LevelCompletedDt datetime NOT NULL
           , ActivityPointsEarned int NOT NULL
           , ActivityCompletedDt datetime NOT NULL
           , RewardActivityModifiedDate datetime NULL
           , ActivityPoints float NULL
           , UserAccepted int NULL
           , UserExceptionAppliedTo int NULL
           , RewardTriggerGUID uniqueidentifier NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , HashCode nvarchar (75) NULL
           , DeletedFlg int NULL
           , LastModifiedDate datetime2 (7) NULL
           , RowNbr int NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10) 
           , RewardExceptionModifiedDate datetime NULL) ;

GO

CREATE CLUSTERED INDEX PI_EDW_RewardUserDetail ON dbo.DIM_EDW_RewardUserDetail ( UserGUID , AccountID , AccountCD , SiteGUID , HFitUserMpiNumber , RewardActivityGUID , RewardTriggerGUID) ON [PRIMARY];

GO

CREATE NONCLUSTERED INDEX PI_EDW_RewardUserDetail_RowNbrCDate ON dbo.DIM_EDW_RewardUserDetail ( RowNbr , LastModifiedDate , DeletedFlg) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_RewardUserDetail SET ( LOCK_ESCALATION = TABLE) ;

GO
-- Create Table [dbo].[DIM_EDW_Coaches]

PRINT 'Create Table [dbo].[DIM_EDW_Coaches]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_Coaches') 

    BEGIN

        DROP TABLE
             DIM_EDW_Coaches;
    END;
GO

CREATE TABLE dbo.DIM_EDW_Coaches (
             UserGUID uniqueidentifier NULL
           , SiteGUID uniqueidentifier NULL
           , AccountID int NULL
           , AccountCD nvarchar (8) NULL
           , CoachID int NOT NULL
           , LastName nvarchar (20) NOT NULL
           , FirstName nvarchar (20) NOT NULL
           , StartDate datetime NOT NULL
           , Phone nvarchar (15) NOT NULL
           , email nvarchar (50) NOT NULL
           , Supervisor int NOT NULL
           , SuperCoach bit NOT NULL
           , MaxParticipants int NOT NULL
           , Inactive bit NOT NULL
           , MaxRiskLevel nvarchar (10) NOT NULL
           , Locked bit NOT NULL
           , TimeLocked datetime NULL
           , terminated bit NOT NULL
           , APMaxParticipants int NULL
           , RNMaxParticipants int NULL
           , RNPMaxParticipants int NULL
           , Change_Type nvarchar (1) NULL
           , Last_Update_Dt datetime NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO
CREATE CLUSTERED INDEX PI_EDW_Coaches_IDs ON dbo.DIM_EDW_Coaches ( UserGUID , SiteGUID , AccountID , AccountCD , CoachID , email) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_Coaches SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_RewardTriggerParameters]

PRINT 'Create Table [dbo].[DIM_EDW_RewardTriggerParameters]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_RewardTriggerParameters') 

    BEGIN

        DROP TABLE
             DIM_EDW_RewardTriggerParameters;
    END;
GO

CREATE TABLE dbo.DIM_EDW_RewardTriggerParameters (
             SiteGUID uniqueidentifier NOT NULL
           , RewardTriggerID int NOT NULL
           , TriggerName nvarchar (100) NOT NULL
           , RewardTriggerParameterOperatorLKPDisplayName nvarchar (255) NOT NULL
           , ParameterDisplayName nvarchar (250) NOT NULL
           , RewardTriggerParameterOperator int NOT NULL
           , [Value] float NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentGuid uniqueidentifier NULL
           , NodeGuid uniqueidentifier NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , RewardTriggerParameter_DocumentModifiedWhen datetime NULL
           , documentculture_VHFRTPJ nvarchar (10) NOT NULL
           , documentculture_VHFRTJ nvarchar (10) NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_RewardTriggerParameters_IDs ON dbo.DIM_EDW_RewardTriggerParameters ( SiteGUID , RewardTriggerID , ParameterDisplayName , RewardTriggerParameterOperator , [Value] , AccountID , AccountCD , DocumentGuid , NodeGuid) ON [PRIMARY];

GO
--ALTER TABLE dbo.DIM_EDW_RewardTriggerParameters SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[TEMP_EDW_RewardTriggerParameters_DATA]

PRINT 'Create Table [dbo].[TEMP_EDW_RewardTriggerParameters_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_RewardTriggerParameters_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_RewardTriggerParameters_DATA;
    END;

GO

CREATE TABLE dbo.TEMP_EDW_RewardTriggerParameters_DATA (
             SiteGUID uniqueidentifier NOT NULL
           , RewardTriggerID int NOT NULL
           , TriggerName nvarchar (100) NOT NULL
           , RewardTriggerParameterOperatorLKPDisplayName nvarchar (255) NOT NULL
           , ParameterDisplayName nvarchar (250) NOT NULL
           , RewardTriggerParameterOperator int NOT NULL
           , [Value] float NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentGuid uniqueidentifier NULL
           , NodeGuid uniqueidentifier NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , RewardTriggerParameter_DocumentModifiedWhen datetime NULL
           , documentculture_VHFRTPJ nvarchar (10) NOT NULL
           , documentculture_VHFRTJ nvarchar (10) NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_HealthAssessment_IDs ON dbo.TEMP_EDW_RewardTriggerParameters_DATA ( SiteGUID , RewardTriggerID , ParameterDisplayName , RewardTriggerParameterOperator , [Value] , AccountID , AccountCD , DocumentGuid , NodeGuid) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_RewardTriggerParameters_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[TEMP_EDW_CoachingDetail_DATA]

PRINT 'Create Table [dbo].[TEMP_EDW_CoachingDetail_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_CoachingDetail_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_CoachingDetail_DATA;
    END;
GO

CREATE TABLE dbo.TEMP_EDW_CoachingDetail_DATA (
             ItemID int NOT NULL
           , ItemGUID uniqueidentifier NOT NULL
           , GoalID int NOT NULL
           , UserID int NOT NULL
           , UserGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , SiteGUID uniqueidentifier NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , AccountName nvarchar (200) NULL
           , IsCreatedByCoach bit NOT NULL
           , BaselineAmount float NOT NULL
           , GoalAmount float NOT NULL
           , DocumentID int NULL
           , GoalStatusLKPID int NOT NULL
           , GoalStatusLKPName nvarchar (100) NOT NULL
           , EvaluationStartDate datetime NULL
           , EvaluationEndDate datetime NULL
           , GoalStartDate datetime NOT NULL
           , CoachDescription nvarchar (500) NULL
           , EvaluationDate datetime NULL
           , Passed bit NULL
           , WeekendDate datetime NULL
           , ChangeType varchar (1) NOT NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedWhen datetime NULL
           , NodeGUID uniqueidentifier NOT NULL
           , CloseReasonLKPID int NOT NULL
           , CloseReason varchar (250) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_CoachingDetail_IDs ON dbo.TEMP_EDW_CoachingDetail_DATA ( ItemID , ItemGUID , GoalID , UserID , UserGUID , HFitUserMpiNumber , SiteGUID , AccountID , AccountCD , WeekendDate) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_CoachingDetail_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[TEMP_EDW_HealthDefinition_DATA]

PRINT 'Create Table [dbo].[TEMP_EDW_HealthDefinition_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_HealthDefinition_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_HealthDefinition_DATA;
    END;
GO

CREATE TABLE dbo.TEMP_EDW_HealthDefinition_DATA (
             SiteGUID int NULL
           , AccountCD int NULL
           , HANodeID int NOT NULL
           , HANodeName nvarchar (100) NOT NULL
           , HADocumentID int NULL
           , HANodeSiteID int NOT NULL
           , HADocPubVerID int NULL
           , ModTitle varchar (max) NULL
           , IntroText varchar (max) NULL
           , ModDocGuid uniqueidentifier NOT NULL
           , ModWeight int NOT NULL
           , ModIsEnabled bit NOT NULL
           , ModCodeName nvarchar (100) NOT NULL
           , ModDocPubVerID int NULL
           , RCTitle varchar (max) NULL
           , RCWeight int NOT NULL
           , RCDocumentGUID uniqueidentifier NOT NULL
           , RCIsEnabled bit NOT NULL
           , RCCodeName nvarchar (100) NOT NULL
           , RCDocPubVerID int NULL
           , RATytle varchar (max) NULL
           , RAWeight int NOT NULL
           , RADocumentGuid uniqueidentifier NOT NULL
           , RAIsEnabled bit NOT NULL
           , RACodeName nvarchar (100) NOT NULL
           , RAScoringStrategyID int NOT NULL
           , RADocPubVerID int NULL
           , QuestionType nvarchar (100) NOT NULL
           , QuesTitle varchar (max) NULL
           , QuesWeight int NOT NULL
           , QuesIsRequired bit NOT NULL
           , QuesDocumentGuid uniqueidentifier NOT NULL
           , QuesIsEnabled bit NOT NULL
           , QuesIsVisible nvarchar (max) NULL
           , QuesIsSTaging bit NOT NULL
           , QuestionCodeName nvarchar (100) NOT NULL
           , QuesDocPubVerID int NULL
           , AnsValue nvarchar (150) NULL
           , AnsPoints int NULL
           , AnsDocumentGuid uniqueidentifier NULL
           , AnsIsEnabled bit NULL
           , AnsCodeName nvarchar (100) NULL
           , AnsUOM nvarchar (5) NULL
           , AnsDocPUbVerID int NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , CmsTreeNodeGuid uniqueidentifier NOT NULL
           , HANodeGUID uniqueidentifier NOT NULL
           , SiteLastModified int NULL
           , Account_ItemModifiedWhen int NULL
           , Campaign_DocumentModifiedWhen int NULL
           , Assessment_DocumentModifiedWhen datetime NULL
           , Module_DocumentModifiedWhen datetime NULL
           , RiskCategory_DocumentModifiedWhen datetime NULL
           , RiskArea_DocumentModifiedWhen datetime NULL
           , Question_DocumentModifiedWhen datetime NULL
           , Answer_DocumentModifiedWhen datetime NULL
           , AllowMultiSelect bit NULL
           , LocID varchar (5) NOT NULL
           , HashCode nvarchar (75) NULL
           , CMS_Class_CtID int NULL
           , CMS_Class_SCV bigint NULL
           , CMS_Document_CtID int NULL
           , CMS_Document_SCV bigint NULL
           , CMS_Site_CtID int NULL
           , CMS_Site_SCV bigint NULL
           , CMS_Tree_CtID int NULL
           , CMS_Tree_SCV bigint NULL
           , CMS_User_CtID int NULL
           , CMS_User_SCV bigint NULL
           , COM_SKU_CtID int NULL
           , COM_SKU_SCV bigint NULL
           , HFit_HealthAssesmentMatrixQuestion_CtID int NULL
           , HFit_HealthAssesmentMatrixQuestion_SCV bigint NULL
           , HFit_HealthAssesmentModule_CtID int NULL
           , HFit_HealthAssesmentModule_SCV bigint NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CtID int NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_SCV bigint NULL
           , HFit_HealthAssesmentRiskArea_CtID int NULL
           , HFit_HealthAssesmentRiskArea_SCV bigint NULL
           , HFit_HealthAssesmentRiskCategory_CtID int NULL
           , HFit_HealthAssesmentRiskCategory_SCV bigint NULL
           , HFit_HealthAssessment_CtID int NULL
           , HFit_HealthAssessment_SCV bigint NULL
           , HFit_HealthAssessmentFreeForm_CtID int NULL
           , HFit_HealthAssessmentFreeForm_SCV bigint NULL
           , CMS_Class_CHANGE_OPERATION nchar (1) NULL
           , CMS_Document_CHANGE_OPERATION nchar (1) NULL
           , CMS_Site_CHANGE_OPERATION nchar (1) NULL
           , CMS_Tree_CHANGE_OPERATION nchar (1) NULL
           , CMS_User_CHANGE_OPERATION nchar (1) NULL
           , COM_SKU_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentModule_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskArea_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessment_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessmentFreeForm_CHANGE_OPERATION nchar (1) NULL
           , CHANGED_FLG int NULL
           , CHANGE_TYPE_CODE nchar (1) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_HealthAssessment_IDs ON dbo.TEMP_EDW_HealthDefinition_DATA ( RCDocumentGUID , RADocumentGuid , RACodeName , QuesDocumentGuid , AnsDocumentGuid , HANodeSiteID) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_HealthDefinition_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[TEMP_EDW_Tracker_DATA]

PRINT 'Create Table [dbo].[TEMP_EDW_Tracker_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_Tracker_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_Tracker_DATA;
    END;
GO

CREATE TABLE dbo.TEMP_EDW_Tracker_DATA (
             TrackerNameAggregateTable varchar (32) NOT NULL
           , ItemID int NOT NULL
           , EventDate datetime NOT NULL
           , IsProfessionallyCollected bit NOT NULL
           , TrackerCollectionSourceID int NOT NULL
           , Notes nvarchar (1000) NULL
           , UserID int NOT NULL
           , CollectionSourceName_Internal nvarchar (100) NULL
           , CollectionSourceName_External nvarchar (100) NULL
           , EventName varchar (7) NOT NULL
           , UOM varchar (10) NOT NULL
           , KEY1 varchar (18) NOT NULL
           , VAL1 float NULL
           , KEY2 varchar (13) NOT NULL
           , VAL2 float NULL
           , KEY3 varchar (12) NOT NULL
           , VAL3 float NULL
           , KEY4 varchar (9) NOT NULL
           , VAL4 float NULL
           , KEY5 varchar (12) NOT NULL
           , VAL5 float NULL
           , KEY6 varchar (11) NOT NULL
           , VAL6 float NULL
           , KEY7 varchar (10) NOT NULL
           , VAL7 float NULL
           , KEY8 varchar (3) NOT NULL
           , VAL8 float NULL
           , KEY9 varchar (2) NOT NULL
           , VAL9 int NULL
           , KEY10 varchar (2) NOT NULL
           , VAL10 int NULL
           , ItemCreatedBy int NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedBy int NULL
           , ItemModifiedWhen datetime NULL
           , IsProcessedForHa bit NULL
           , TXTKEY1 varchar (10) NOT NULL
           , TXTVAL1 nvarchar (500) NULL
           , TXTKEY2 varchar (8) NOT NULL
           , TXTVAL2 nvarchar (255) NULL
           , TXTKEY3 varchar (2) NOT NULL
           , TXTVAL3 int NULL
           , ItemOrder int NULL
           , ItemGuid uniqueidentifier NULL
           , UserGuid uniqueidentifier NOT NULL
           , MPI varchar (50) NOT NULL
           , ClientCode varchar (12) NULL
           , SiteGUID uniqueidentifier NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , IsAvailable bit NULL
           , IsCustom bit NULL
           , UniqueName nvarchar (50) NULL
           , ColDesc nvarchar (50) NULL
           , VendorID int NULL
           , VendorName nvarchar (32) NULL
           , CT_ItemID int NULL
           , CT_ChangeVersion bigint NULL
           , CMS_Operation nchar (1) NULL
           , DeleteFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10) 
           , ItemLastUpdated datetime NULL) 
ON [PRIMARY];

GO

ALTER TABLE dbo.TEMP_EDW_Tracker_DATA
ADD
            CONSTRAINT DF__TEMP_Stag__ItemL__251061DB DEFAULT GETDATE () FOR ItemLastUpdated;

GO

CREATE CLUSTERED INDEX temp_PI_EDW_Tracker_IDs ON dbo.TEMP_EDW_Tracker_DATA ( TrackerNameAggregateTable , ItemID , ItemModifiedWhen) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_Tracker_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO
-- Create Table [dbo].[DIM_EDW_HealthAssessmentDefinition]

PRINT 'Create Table [dbo].[DIM_EDW_HealthAssessmentDefinition]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthAssessmentDefinition') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthAssessmentDefinition;
    END;
GO

CREATE TABLE dbo.DIM_EDW_HealthAssessmentDefinition (
             SiteGUID int NULL
           , AccountCD int NULL
           , HANodeID int NOT NULL
           , HANodeName nvarchar (100) NOT NULL
           , HADocumentID int NULL
           , HANodeSiteID int NOT NULL
           , HADocPubVerID int NULL
           , ModTitle varchar (max) NULL
           , IntroText varchar (max) NULL
           , ModDocGuid uniqueidentifier NOT NULL
           , ModWeight int NOT NULL
           , ModIsEnabled bit NOT NULL
           , ModCodeName nvarchar (100) NOT NULL
           , ModDocPubVerID int NULL
           , RCTitle varchar (max) NULL
           , RCWeight int NOT NULL
           , RCDocumentGUID uniqueidentifier NOT NULL
           , RCIsEnabled bit NOT NULL
           , RCCodeName nvarchar (100) NOT NULL
           , RCDocPubVerID int NULL
           , RATytle varchar (max) NULL
           , RAWeight int NOT NULL
           , RADocumentGuid uniqueidentifier NOT NULL
           , RAIsEnabled bit NOT NULL
           , RACodeName nvarchar (100) NOT NULL
           , RAScoringStrategyID int NOT NULL
           , RADocPubVerID int NULL
           , QuestionType nvarchar (100) NOT NULL
           , QuesTitle varchar (max) NULL
           , QuesWeight int NOT NULL
           , QuesIsRequired bit NOT NULL
           , QuesDocumentGuid uniqueidentifier NOT NULL
           , QuesIsEnabled bit NOT NULL
           , QuesIsVisible nvarchar (max) NULL
           , QuesIsSTaging bit NOT NULL
           , QuestionCodeName nvarchar (100) NOT NULL
           , QuesDocPubVerID int NULL
           , AnsValue nvarchar (150) NULL
           , AnsPoints int NULL
           , AnsDocumentGuid uniqueidentifier NULL
           , AnsIsEnabled bit NULL
           , AnsCodeName nvarchar (100) NULL
           , AnsUOM nvarchar (5) NULL
           , AnsDocPUbVerID int NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , CmsTreeNodeGuid uniqueidentifier NOT NULL
           , HANodeGUID uniqueidentifier NOT NULL
           , SiteLastModified int NULL
           , Account_ItemModifiedWhen int NULL
           , Campaign_DocumentModifiedWhen int NULL
           , Assessment_DocumentModifiedWhen datetime NULL
           , Module_DocumentModifiedWhen datetime NULL
           , RiskCategory_DocumentModifiedWhen datetime NULL
           , RiskArea_DocumentModifiedWhen datetime NULL
           , Question_DocumentModifiedWhen datetime NULL
           , Answer_DocumentModifiedWhen datetime NULL
           , AllowMultiSelect bit NULL
           , LocID varchar (5) NOT NULL
           , CMS_Class_CtID int NULL
           , CMS_Class_SCV bigint NULL
           , CMS_Document_CtID int NULL
           , CMS_Document_SCV bigint NULL
           , CMS_Site_CtID int NULL
           , CMS_Site_SCV bigint NULL
           , CMS_Tree_CtID int NULL
           , CMS_Tree_SCV bigint NULL
           , CMS_User_CtID int NULL
           , CMS_User_SCV bigint NULL
           , COM_SKU_CtID int NULL
           , COM_SKU_SCV bigint NULL
           , HFit_HealthAssesmentMatrixQuestion_CtID int NULL
           , HFit_HealthAssesmentMatrixQuestion_SCV bigint NULL
           , HFit_HealthAssesmentModule_CtID int NULL
           , HFit_HealthAssesmentModule_SCV bigint NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CtID int NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_SCV bigint NULL
           , HFit_HealthAssesmentRiskArea_CtID int NULL
           , HFit_HealthAssesmentRiskArea_SCV bigint NULL
           , HFit_HealthAssesmentRiskCategory_CtID int NULL
           , HFit_HealthAssesmentRiskCategory_SCV bigint NULL
           , HFit_HealthAssessment_CtID int NULL
           , HFit_HealthAssessment_SCV bigint NULL
           , HFit_HealthAssessmentFreeForm_CtID int NULL
           , HFit_HealthAssessmentFreeForm_SCV bigint NULL
           , CMS_Class_CHANGE_OPERATION nchar (1) NULL
           , CMS_Document_CHANGE_OPERATION nchar (1) NULL
           , CMS_Site_CHANGE_OPERATION nchar (1) NULL
           , CMS_Tree_CHANGE_OPERATION nchar (1) NULL
           , CMS_User_CHANGE_OPERATION nchar (1) NULL
           , COM_SKU_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentModule_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskArea_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessment_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessmentFreeForm_CHANGE_OPERATION nchar (1) NULL
           , CHANGED_FLG int NULL
           , CHANGE_TYPE_CODE nchar (1) NULL) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_HealthAssessmentDefinition SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_SmallSteps]

PRINT 'Create Table [dbo].[DIM_EDW_SmallSteps]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_SmallSteps') 

    BEGIN

        DROP TABLE
             dbo.DIM_EDW_SmallSteps;
    END;

GO

SET ANSI_NULLS ON;

GO

SET QUOTED_IDENTIFIER ON;

GO

SET ANSI_PADDING ON;

GO

CREATE TABLE dbo.DIM_EDW_SmallSteps (
             UserID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , SiteGUID uniqueidentifier NOT NULL
           , SSItemID int NOT NULL
           , SSItemCreatedBy int NULL
           , SSItemCreatedWhen datetime NULL
           , SSItemModifiedBy int NULL
           , SSItemModifiedWhen datetime NULL
           , SSItemOrder int NULL
           , SSItemGUID uniqueidentifier NOT NULL
           , SSHealthAssesmentUserStartedItemID int NOT NULL
           , SSOutcomeMessageGuid uniqueidentifier NOT NULL
           , SSOutcomeMessage nvarchar (max) NULL
           , HACampaignNodeGUID uniqueidentifier NOT NULL
           , HACampaignName nvarchar (200) NOT NULL
           , HACampaignStartDate datetime NOT NULL
           , HACampaignEndDate datetime NOT NULL
           , HAStartedDate datetime NOT NULL
           , HACompletedDate datetime NULL
           , HAStartedMode int NOT NULL
           , HACompletedMode int NOT NULL
           , HaCodeName nvarchar (100) NULL
           , HFitUserMPINumber bigint NULL
           , HashCode nvarchar (75) NULL
           , ChangeType nchar (1) NULL
           , CT_UserSettingsID int NULL
           , CT_UserSettings_CHANGE_OPERATION nchar (1) NULL
           , CT_CMS_UserSettings_SCV bigint NULL
           , SiteID_CtID int NULL
           , SiteID_CHANGE_OPERATION nchar (1) NULL
           , SITE_SCV bigint NULL
           , Campaign_CtID int NULL
           , Campaign_CHANGE_OPERATION nchar (1) NULL
           , Campaign_SCV bigint NULL
           , HealthAssesmentUserStarted_CtID int NULL
           , HealthAssesmentUserStarted_CHANGE_OPERATION nchar (1) NULL
           , HealthAssesmentUserStarted_SCV bigint NULL
           , OutComeMessages_CtID int NULL
           , OutComeMessages_CHANGE_OPERATION nchar (1) NULL
           , OutComeMessages_SCV bigint NULL
           , HFit_Account_CtID int NULL
           , HFit_Account_CHANGE_OPERATION nchar (1) NULL
           , HFit_Account_SCV bigint NULL
           , ToDoSmallSteps_CtID int NULL
           , ToDoSmallSteps_CHANGE_OPERATION nchar (1) NULL
           , ToDoSmallSteps_SCV bigint NULL
           , LastModifiedDate datetime2 (7) NULL
           , RowNbr uniqueidentifier NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_SmallSteps ON dbo.DIM_EDW_SmallSteps ( AccountCD , SiteGUID , SSItemID , SSItemGUID , SSHealthAssesmentUserStartedItemID , SSOutcomeMessageGuid , HFitUserMPINumber , HACampaignNodeGUID , HAStartedMode , HACompletedMode , HaCodeName , HACampaignStartDate , HACampaignEndDate) ON [PRIMARY];

GO

IF NOT EXISTS ( SELECT
                       name
                       FROM sys.indexes
                       WHERE name = 'PI_BASE_Hfit_SmallStepResponses') 
AND EXISTS (SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'BASE_Hfit_SmallStepResponses') 
    BEGIN

        CREATE NONCLUSTERED INDEX PI_BASE_Hfit_SmallStepResponses
        ON dbo.BASE_Hfit_SmallStepResponses ( UserID , HealthAssesmentUserStartedItemID) 
        INCLUDE ( ItemID , OutComeMessageGUID , ItemCreatedBy , ItemCreatedWhen , ItemModifiedBy , ItemModifiedWhen , ItemOrder , ItemGUID) ;
    END;
GO

CREATE NONCLUSTERED INDEX PI_EDW_SmallSteps_RowNbrCDate ON dbo.DIM_EDW_SmallSteps ( RowNbr , LastModifiedDate , DeletedFlg) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_SmallSteps SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[TEMP_EDW_RewardAwardDetail_DATA]

PRINT 'Create Table [dbo].[TEMP_EDW_RewardAwardDetail_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_RewardAwardDetail_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_RewardAwardDetail_DATA;
    END;
GO

CREATE TABLE dbo.TEMP_EDW_RewardAwardDetail_DATA (
             UserGUID uniqueidentifier NOT NULL
           , SiteGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , RewardLevelGUID uniqueidentifier NOT NULL
           , AwardType int NOT NULL
           , AwardDisplayName nvarchar (100) NOT NULL
           , RewardValue float NULL
           , ThresholdNumber int NOT NULL
           , UserNotified bit NOT NULL
           , IsFulfilled bit NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_HealthAssessment_IDs ON dbo.TEMP_EDW_RewardAwardDetail_DATA ( UserGUID , SiteGUID , HFitUserMpiNumber , RewardLevelGUID , AwardType , AwardDisplayName , RewardValue , ThresholdNumber , UserNotified , IsFulfilled , AccountID , AccountCD) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_RewardAwardDetail_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_RewardUserLevel]

PRINT 'Create Table [dbo].[DIM_EDW_RewardUserLevel]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_RewardUserLevel') 

    BEGIN

        DROP TABLE
             DIM_EDW_RewardUserLevel;
    END;
GO

CREATE TABLE dbo.DIM_EDW_RewardUserLevel (
             UserId int NOT NULL
           , LevelCompletedDt datetime NOT NULL
           , LevelName nvarchar (100) NOT NULL
           , SiteName nvarchar (100) NOT NULL
           , nodeguid uniqueidentifier NOT NULL
           , SiteGuid uniqueidentifier NOT NULL
           , LevelHeader nvarchar (256) NULL
           , GroupHeadingText nvarchar (40) NULL
           , GroupHeadingDescription nvarchar (1024) NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_RewardUserLevel_IDs ON dbo.DIM_EDW_RewardUserLevel ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_RewardUserLevel SET ( LOCK_ESCALATION = TABLE) ;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_BioMetrics') 
    BEGIN
        DROP TABLE
             DIM_EDW_BioMetrics;
    END;
GO

CREATE TABLE dbo.DIM_EDW_BioMetrics (
             UserID int NOT NULL
           , UserGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , SiteID int NOT NULL
           , SiteGUID uniqueidentifier NOT NULL
           , CreatedDate datetime NULL
           , ModifiedDate datetime NULL
           , Notes nvarchar (1000) NULL
           , IsProfessionallyCollected bit NULL
           , EventDate datetime NULL
           , EventName varchar (13) NOT NULL
           , PPTWeight float NULL
           , PPTHbA1C float NULL
           , Fasting bit NULL
           , HDL float NULL
           , LDL float NULL
           , Ratio float NULL
           , Total float NULL
           , Triglycerides int NULL
           , Glucose int NULL
           , FastingState bit NULL
           , Systolic int NULL
           , Diastolic int NULL
           , PPTBodyFatPCT float NULL
           , BMI float NULL
           , WaistInches float NULL
           , HipInches float NULL
           , ThighInches float NULL
           , ArmInches float NULL
           , ChestInches float NULL
           , CalfInches float NULL
           , NeckInches float NULL
           , Height float NULL
           , HeartRate int NULL
           , FluShot bit NULL
           , PneumoniaShot bit NULL
           , PSATest bit NULL
           , OtherExam bit NULL
           , TScore float NULL
           , DRA float NULL
           , CotinineTest bit NULL
           , ColoCareKit bit NULL
           , CustomTest float NULL
           , CustomDesc varchar (500) NULL
           , CollectionSource nvarchar (100) NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedWhen datetime NULL
           , TrackerCollectionSourceID int NOT NULL
           , itemid int NOT NULL
           , TBL varchar (32) NOT NULL
           , VendorID int NULL
           , VendorName nvarchar (32) NULL
           , HashCode nvarchar (75) NULL
           , CMS_Site_CtID int NULL
           , CMS_Site_SCV bigint NULL
           , CMS_UserSettings_CtID int NULL
           , CMS_UserSettings_SCV bigint NULL
           , CMS_UserSite_CtID int NULL
           , CMS_UserSite_SCV bigint NULL
           , HFit_Account_CtID int NULL
           , HFit_Account_SCV bigint NULL
           , HFit_UserTracker_CtID int NULL
           , HFit_UserTracker_SCV bigint NULL
           , CMS_Site_CHGTYPE nchar (1) NULL
           , CMS_UserSettings_CHGTYPE nchar (1) NULL
           , CMS_UserSite_CHGTYPE nchar (1) NULL
           , HFit_Account_CHGTYPE nchar (1) NULL
           , HFit_UserTracker_CHGTYPE nchar (1) NULL
           , HFit_TrackerSource_CHGTYPE nchar (1) NULL
           , CT_ChangeType nchar (1) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
) 
ON [PRIMARY];

GO

--Add needed columns to temp tables
IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'Temp_HealthInterestDetail') 
    BEGIN
        EXEC proc_Add_EDW_CT_StdCols 'Temp_HealthInterestDetail';
    END;

GO

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardsDefinition';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthAssessment';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_RewardUserLevel_DATA';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthDefinition';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthInterestList';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_Coaches_DATA';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_Trackers';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardAwardDetail';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthInterestDetail';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthAssesmentClientView';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_CoachingDetail';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardUserDetail';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_Coaches';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardTriggerParameters';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_RewardTriggerParameters_DATA';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_CoachingDetail_DATA';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_HealthDefinition_DATA';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_Tracker_DATA';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthAssessmentDefinition';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_SmallSteps';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_RewardAwardDetail_DATA';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardUserLevel';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_BioMetrics';

GO

PRINT 'Created the STAGING tables';

GO 

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: CreateTable_CT_VersionTracking.Sql \n 
--------------------------------------------------------------- 

GO
PRINT 'FROM CreateTable_CT_VersionTracking.Sql';
PRINT 'Creating table CT_VersionTracking';
IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE
                  name = 'CT_VersionTracking') 
    BEGIN
        DROP TABLE
             CT_VersionTracking;
    END;
GO
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE
                      name = 'CT_VersionTracking') 
    BEGIN
        CREATE TABLE dbo.CT_VersionTracking (
                     SVRName nvarchar (100) NOT NULL
                   , DBName nvarchar (100) NOT NULL
                   , TgtView nvarchar ( 100) NOT NULL
                   , ExtractionDate datetime2 (7) NOT NULL
                   , ExtractedVersion int NOT NULL
                   , CurrentDbVersion int NULL
                   , ExtractedRowCnt int NOT NULL
                   , StartTime datetime2 ( 7) NOT NULL
                   , EndTime datetime2 ( 7) NULL
                   , CNT_Insert int NULL
                   , CNT_Update int NULL
                   , CNT_Delete int NULL
                   , CNT_StagingTable bigint NULL
                   , CNT_PulledRecords bigint NULL
                   , RowNbr int IDENTITY (1, 1) NOT NULL
                   , CONSTRAINT PK_CT_VersionTracking PRIMARY KEY CLUSTERED
                     (
                     SVRName, DBName, ExtractedVersion , TgtView, ExtractionDate ASC
                     ) 
                         WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , IGNORE_DUP_KEY = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
        ) 
        ON [PRIMARY];

        ALTER TABLE dbo.CT_VersionTracking
        ADD
                    CONSTRAINT DF_CT_VersionTracking_StartTime  DEFAULT GETDATE () FOR StartTime;
    END;

GO
PRINT 'Created table CT_VersionTracking';
GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: createTable_EDW_CT_ExecutionLog.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating Table EDW_CT_ExecutionLog';
PRINT 'FROM: createTable_EDW_CT_ExecutionLog.sql';
GO
--drop table EDW_CT_ExecutionLog

/*---------------------------------------------------------
alter table EDW_CT_ExecutionLog add CT_Inserts bigint NULL
alter table EDW_CT_ExecutionLog add CT_Updates bigint NULL
alter table EDW_CT_ExecutionLog add CT_Deletes bigint NULL	
*/

SET QUOTED_IDENTIFIER ON;

IF NOT EXISTS ( SELECT
                       name
                       FROM sys.tables
                       WHERE
                       name = 'EDW_CT_ExecutionLog') 
    BEGIN

        CREATE TABLE dbo.EDW_CT_ExecutionLog (
                     CT_NAME NVARCHAR ( 80) NOT NULL
                   , CT_Start DATETIME NOT NULL
                   , CT_End DATETIME NULL
                   , CT_TotalMinutes INT NULL
                   , CT_RecordsProcessed BIGINT NULL
                   , CT_Inserts BIGINT NULL
                   , CT_Updates BIGINT NULL
                   , CT_Deletes BIGINT NULL
                   , RecordID UNIQUEIDENTIFIER NOT NULL
                   , CONSTRAINT PK_EDW_CT_ExecutionLog PRIMARY KEY CLUSTERED ( RecordID ASC)) ;

        ALTER TABLE dbo.EDW_CT_ExecutionLog
        ADD
                    CONSTRAINT DF_EDW_CT_ExecutionLog_RecordID DEFAULT NEWID () FOR RecordID;
        EXEC proc_Add_EDW_CT_StdCols EDW_CT_ExecutionLog;
    END;
ELSE
    BEGIN
        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               column_name = 'CT_Inserts' AND
                               table_name = 'EDW_CT_ExecutionLog') 
            BEGIN
                ALTER TABLE EDW_CT_ExecutionLog
                ADD
                            CT_Inserts BIGINT NULL;
            END;
        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               column_name = 'CT_Updates' AND
                               table_name = 'EDW_CT_ExecutionLog') 
            BEGIN
                ALTER TABLE EDW_CT_ExecutionLog
                ADD
                            CT_Updates BIGINT NULL;
            END;
        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               column_name = 'CT_Deletes' AND
                               table_name = 'EDW_CT_ExecutionLog') 
            BEGIN
                ALTER TABLE EDW_CT_ExecutionLog
                ADD
                            CT_Deletes BIGINT NULL;
            END;
    END;
GO

PRINT 'CREATED Table EDW_CT_ExecutionLog';
GO

PRINT 'CREATING PROC proc_EDW_CT_ExecutionLog_Update';
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE
                   name = 'proc_EDW_CT_ExecutionLog_Update') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_CT_ExecutionLog_Update;
    END;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE
                   name = 'proc_EDW_CT_ExecutionLog_Update_Counts') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_CT_ExecutionLog_Update_Counts;
    END;

GO

CREATE PROCEDURE proc_EDW_CT_ExecutionLog_Update_Counts (
       @RecordID AS UNIQUEIDENTIFIER
     , @TypeAction AS CHAR (1) 
     , @iCnt AS BIGINT = 0) 
AS
BEGIN

/*---------------------------------------------------
    @TypeAction:
    T = Total of processed records.
    I = Update the count of inserted records
    U = Update the count of updated records
    D = Update the count of flaged as deleted records
*/

    IF
       @TypeAction = 'T'
        BEGIN
            DECLARE
                   @TotRecs AS BIGINT = (SELECT
                                                ISNULL (CT_INSERTs , 0) + ISNULL (CT_Updates , 0) + ISNULL (CT_Deletes , 0) 
                                                FROM EDW_CT_ExecutionLog
                                                WHERE
                                                RecordID = @RecordID) ;

            IF @iCnt > 0
                BEGIN
                    PRINT 'Executing Log Update T0 on ' + CAST (@iCnt AS NVARCHAR (50)) + ' records.';
                    UPDATE dbo.EDW_CT_ExecutionLog
                      SET
                          CT_RecordsProcessed = @iCnt
                           WHERE
                           RecordID = @RecordID;
                END;
            ELSE
                BEGIN
                    PRINT 'Executing Log Update T1 on ' + CAST (@TotRecs AS NVARCHAR (50)) + ' records.';
                    UPDATE dbo.EDW_CT_ExecutionLog
                      SET
                          CT_RecordsProcessed = @TotRecs
                           WHERE
                           RecordID = @RecordID;
                END;
        END;
    IF
           @TypeAction = 'I'
        BEGIN
            UPDATE dbo.EDW_CT_ExecutionLog
              SET
                  CT_Inserts = @iCnt
                   WHERE
                   RecordID = @RecordID;
        END;
    IF
           @TypeAction = 'U'
        BEGIN
            UPDATE dbo.EDW_CT_ExecutionLog
              SET
                  CT_Updates = @iCnt
                   WHERE
                   RecordID = @RecordID;
        END;
    IF
           @TypeAction = 'D'
        BEGIN
            UPDATE dbo.EDW_CT_ExecutionLog
              SET
                  CT_Deletes = @iCnt
                   WHERE
                   RecordID = @RecordID;
        END;
END;
GO
CREATE PROCEDURE proc_EDW_CT_ExecutionLog_Update (
       @RecordID AS UNIQUEIDENTIFIER
     , @CT_NAME AS NVARCHAR (80) 
     , @CT_DateTimeNow AS DATETIME
     , @CT_RecordsProcessed AS BIGINT = 0
     , @Action AS NVARCHAR (5)) 
AS
BEGIN
    IF @Action = 'I'
        BEGIN
            INSERT INTO dbo.EDW_CT_ExecutionLog (
                   CT_NAME
                 , CT_Start
                 , CT_End
                 , CT_TotalMinutes
                 , CT_RecordsProcessed
                 , RecordID) 
            VALUES
            (
            @CT_NAME , @CT_DateTimeNow , NULL , NULL , NULL , @RecordID) ;
        END;
    IF @Action = 'U'
        BEGIN
            --declare @STime as datetime = getdate() -1 ;
            --declare @CT_DateTimeNow as datetime = getdate();
            --select DATEDIFF (MINUTE, @STime , @CT_DateTimeNow);
            DECLARE
                   @STime AS DATETIME = ( SELECT
                                                 CT_Start
                                                 FROM EDW_CT_ExecutionLog
                                                 WHERE
                                                 RecordID = @RecordID) ;

            PRINT '@Stime = ' + CAST ( @Stime AS NVARCHAR ( 50)) ;
            DECLARE
                   @Mins AS INT = DATEDIFF ( MINUTE , @STime , @CT_DateTimeNow) ;
            PRINT '@Mins = ' + CAST ( @Mins AS NVARCHAR ( 50)) ;
            UPDATE dbo.EDW_CT_ExecutionLog
              SET
                  CT_End = @CT_DateTimeNow
                ,CT_TotalMinutes = DATEDIFF ( MINUTE , @STime , @CT_DateTimeNow) 
                ,CT_RecordsProcessed = @CT_RecordsProcessed
                   WHERE
                   RecordID = @RecordID;

        END;

END;

GO
PRINT 'CREATED PROC proc_EDW_CT_ExecutionLog_Update';
GO

--Test the PROC

/*---------------------------------------------------------------------------------------------------
declare @RecordID AS uniqueidentifier = newid();
declare @CT_NAME as nvarchar(50) = 'TESTRUN' ;
declare @CT_DateTimeNow as datetime = getdate() -1 ;
declare @CT_RecordsProcessed as bigint = 0 ; 
declare @Action AS nvarchar (5) = 'I';

exec proc_EDW_CT_ExecutionLog_Update @RecordID, @CT_NAME, @CT_DateTimeNow, @CT_RecordsProcessed, 'I';
select * from EDW_CT_ExecutionLog ;
set @CT_DateTimeNow = getdate() ;
set @CT_RecordsProcessed = 9999;
exec proc_EDW_CT_ExecutionLog_Update @RecordID, @CT_NAME, @CT_DateTimeNow, @CT_RecordsProcessed, 'U';
select * from EDW_CT_ExecutionLog ;
truncate table EDW_CT_ExecutionLog;
*/--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_STAGING_EDW_HA_Definition.sql" \n 
--------------------------------------------------------------- 

GO

-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

/*----------------------------------------------------------------------------
exec proc_STAGING_EDW_HA_Definition 0   --Process Changed Data only
exec proc_STAGING_EDW_HA_Definition 1   --Reload ALL
exec proc_STAGING_EDW_HA_Definition 0,7

select * from ##TEMP_EDW_HealthDefinition_DATA
select  * from CT_VersionTracking ; 
select * from view_EDW_HealthAssessmentDefinition_CT

PULLING Changes for versions between: 42944  and 43281
PULLING Changes for versions between: 43284  and 43287
PULLING Changes for versions between: 43455  and 43468
PULLING Changes for versions between: 43625  and 43627
PULLING Changes for versions between: 43629  and 43632
PULLING Changes for versions between: 43635  and 43691

PULLING Changes for versions between: 11  and 14

SELECT
       COUNT (*) 
       FROM STAGING_EDW_HA_Definition;

SELECT COUNT(*) FROM [view_EDW_HealthAssessmentDefinition_CT]	  --00:01:47
SELECT top 10 * FROM [view_EDW_HealthAssessmentDefinition_CT]
SELECT TOP 100 * FROM [STAGING_EDW_HA_Definition];
SELECT COUNT (*) FROM [STAGING_EDW_HA_Definition]; 

PERF Measurements
03.26.2015 : 4681580 rows - 01:26:36 run time / PROD 1 @ LAB - full reload
03.27.2015 : 4681580 rows - 01:01:20 run time / PROD 1 @ LAB - full reload
03.27.2015 : Prod2  @ LAB : (3711933 row(s) affected) : 01:56:01 - full reload
03.28.2015 : Prod3  @ LAB : (5697805 row(s) affected) : 05:45:57 - full reload
03.29.2015 : Prod2  @ LAB : (xx row(s) affected) : 01:56:01 - Changed Records

04.16.2015 : WDM - complted the SP and started testing.
05.28.2015 : WDM - completed unit testing 
*/

GO
PRINT 'FROM proc_STAGING_EDW_HA_Definition.SQL';
PRINT 'Creating proc_STAGING_EDW_HA_Definition';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_STAGING_EDW_HA_Definition') 
    BEGIN
        PRINT 'Replacing proc_STAGING_EDW_HA_Definition proc';
        DROP PROCEDURE
             proc_STAGING_EDW_HA_Definition;
    END;
GO

CREATE PROCEDURE proc_STAGING_EDW_HA_Definition
       @Reloadall int = 0
AS
BEGIN

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/
    SET NOCOUNT ON;
    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'STAGING_EDW_HA_Definition';

    IF @iTotal <= 1
        BEGIN
            PRINT 'NO RECORDS FOUND IN STAGING TABLE - Reloading all.';
            SET @Reloadall = 1;
        END;

    DECLARE
    @Synchronization_Version bigint = 0
  , @iVersion AS int
  , @Lastviewpull_Version AS bigint
  , @Lastpullversion AS bigint
  , @CurrentDbVersion AS int
  , @STime AS datetime
  , @TgtView AS nvarchar ( 100) = 'view_EDW_HealthDeffinition'
  , @ExtractionDate AS datetime
  , @ExtractedVersion AS int
  , @ExtractedRowCnt AS int
  , @EndTime AS datetime
  , @CNT_PulledRecords AS int = 0
  , @iCnt AS int = 0
  , @RowNbr AS int = 0
  , @StartTime AS datetime = GETDATE () 
  , @SVRName AS nvarchar ( 100) 
  , @DBName AS nvarchar ( 100) = DB_NAME () 
  , @CNT_Insert AS int = 0
  , @CNT_Update AS int = 0
  , @CNT_Delete AS int = 0
  , @CNT_StagingTable int = 0
  , @VersionNBR int = 0
  , @TrackProgress int = 1;

    SET @SVRName = ( SELECT
                            @@SERVERNAME) ;

    SET @STime = GETDATE () ;

    DECLARE
    @RecordID AS uniqueidentifier = NEWID () ;
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_HA_Definition' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                               FROM sys.tables
                               WHERE name = 'STAGING_EDW_HA_Definition') 
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping STAGING_EDW_HA_Definition for FULL reload.';
                        END;
                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    DROP TABLE
                         STAGING_EDW_HA_Definition;
                END;
            ELSE
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading STAGING_EDW_HA_Definition.';
                        END;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE
                          () AS nvarchar ( 50)) ;
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL EDW HA Data.';

                    SELECT
                           * INTO
                                  STAGING_EDW_HA_Definition
                           FROM view_EDW_HealthAssessmentDefinition_CT;
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @@ROWCOUNT;

                    EXEC proc_Add_EDW_CT_StdCols 'STAGING_EDW_HA_Definition';

                    SET @iCnt = ( SELECT
                                         COUNT ( *) 
                                         FROM STAGING_EDW_HA_Definition) ;
                    PRINT DB_NAME () + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) + ' , loaded ' + CAST ( @iCnt
                          AS nvarchar ( 50)) + ' records.';

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( *) 
                                                      FROM STAGING_EDW_HA_Definition) ;
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                           FROM sys.indexes
                                           WHERE name = 'PI_EDW_HealthAssessment_IDs') 
                        BEGIN
                            PRINT 'Adding INDEX PI_EDW_HealthAssessment_IDs at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                            CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_IDs ON dbo.STAGING_EDW_HA_Definition ( RCDocumentGuid ,
                            RADocumentGuid , RACodeName , QuesDocumentGuid , AnsDocumentGuid , HANodeSiteID) WITH ( PAD_INDEX = OFF ,
                            STATISTICS_NORECOMPUTE = OFF ,
                            SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                        END;

                    SET @ExtractionDate = GETDATE () ;
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( *) 
                                                    FROM STAGING_EDW_HA_Definition) ;
                    --SET @TgtView = 'view_EDW_HealthDeffinition';
                    SET @EndTime = GETDATE () ;

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                         , ExtractedVersion
                         , CurrentDbVersion
                         , ExtractedRowCnt
                         , TgtView
                         , StartTime
                         , EndTime
                         , SVRName
                         , DBName
                         , CNT_Insert
                         , CNT_Update
                         , CNT_delete
                         , CNT_PulledRecords
                         , CNT_StagingTable) 
                    VALUES
                    (
                    @ExtractionDate , @ExtractedVersion , @CurrentDbVersion , @ExtractedRowCnt , @TgtView , @StartTime , @EndTime , @SVRName ,
                    @DBName , @CNT_Insert , @CNT_Update , @CNT_delete , @CNT_PulledRecords , @CNT_StagingTable) ;

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                        END;

                END;
            -- SELECT * INTO [STAGING_EDW_HA_Definition] FROM [view_EDW_HealthAssessmentDefinition_CT];
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            SET @STime = GETDATE () ;

            EXEC proc_EDW_ChangeGmtToCentralTime 'STAGING_EDW_HA_Definition';
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_HA_Definition' , @STime , @CNT_PulledRecords , 'U';
            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                           FROM sys.tables
                           WHERE name = 'STAGING_EDW_HA_Definition') 
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table STAGING_EDW_HA_Definition was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            --IF NOT EXISTS ( SELECT
            --                name
            --                  FROM sys.indexes
            --                  WHERE name = 'PI_EDW_HealthAssessment_IDs') 
            --    BEGIN
            --        IF @TrackProgress = 1
            --            BEGIN
            --                PRINT 'Adding INDEX PI_EDW_HealthAssessment_IDs';
            --            END;
            --        CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_IDs ON dbo.STAGING_EDW_HA_Definition ( ItemCreatedWhen ASC , ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC , HAUserQuestion_ItemModifiedWhen ASC , HAUserAnswers_ItemModifiedWhen ASC) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
            --    END;

            IF NOT EXISTS ( SELECT
                                   name
                                   FROM sys.indexes
                                   WHERE name = 'PI_EDW_HealthAssessment_IDs') 
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_HealthAssessment_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_HealthAssessment_IDs ON dbo.STAGING_EDW_HA_Definition ( RCDocumentGuid , RADocumentGuid ,
                    RACodeName , QuesDocumentGuid , AnsDocumentGuid , HANodeSiteID) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF ,
                    SORT_IN_TEMPDB = OFF ,
                    DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                               FROM tempdb.dbo.sysobjects
                               WHERE id = OBJECT_ID ( N'tempdb..##TEMP_EDW_HealthDefinition_DATA')) 
                --FROM sys.tables
                --WHERE name = '##TEMP_EDW_HealthDefinition_DATA') 
                BEGIN
                    PRINT 'Dropping ##TEMP_EDW_HealthDefinition_DATA';
                    DROP TABLE
                         ##TEMP_EDW_HealthDefinition_DATA;
                END;

--*****************************************************************************************

            SELECT
                   * INTO
                          ##TEMP_EDW_HealthDefinition_DATA
                   FROM view_EDW_HealthAssessmentDefinition_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

            EXEC proc_Add_EDW_CT_StdCols '##TEMP_EDW_HealthDefinition_DATA';

            CREATE CLUSTERED INDEX temp_PI_EDW_HealthAssessment_IDs ON dbo.##TEMP_EDW_HealthDefinition_DATA
            (	 RCDocumentGuid ,
            RADocumentGuid ,
            RACodeName ,
            QuesDocumentGuid ,
            AnsDocumentGuid ,
            HANodeSiteID) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF ,
            SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM ##TEMP_EDW_HealthDefinition_DATA) ;

--*****************************************************************************************
-- ADD NEW RECORDS
--*****************************************************************************************
            DECLARE
            @iNewInserts AS int = 0;
            EXEC @iNewInserts = proc_CT_HA_Definition_AddNewRecs ;
            PRINT 'new inserts: ' + CAST ( @iNewInserts AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iNewInserts;

--*****************************************************************************************
-- ADD UPDATED RECORDS
--*****************************************************************************************
            --select top 100 * from ##TEMP_EDW_HealthDefinition_DATA
            DECLARE
            @iUpdates AS int = 0;
            EXEC @iUpdates = proc_CT_HA_Definition_AddUpdatedRecs ;
            PRINT 'Updated Records: ' + CAST ( @iUpdates AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdates;

--*****************************************************************************************
--		  FIND ANY DELETED ROWS
--*****************************************************************************************
            DECLARE
            @iDeleted AS int = 0;
            EXEC @iDeleted = proc_CT_HA_Definition_AddDeletedRecs ;
            PRINT 'MARKED Deleted Records: ' + CAST ( @iDeleted AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDeleted;

--*****************************************************************************************
            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( *) 
                                             FROM STAGING_EDW_HA_Definition) ;
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
                   WHERE
                         RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
                   WHERE
                         RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM ##TEMP_EDW_HealthDefinition_DATA) ;

            EXEC proc_EDW_ChangeGmtToCentralTime 'STAGING_EDW_HA_Definition';
            SET @STime = GETDATE () ;
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_HA_Definition' , @STime , @CNT_PulledRecords , 'U';

        END;
    SET NOCOUNT OFF;
END;

GO
PRINT 'Created proc_STAGING_EDW_HA_Definition';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_HealthAssessment_Staged.sql" \n 
--------------------------------------------------------------- 


GO
PRINT 'Processing view_EDW_HealthAssessment_STAGED';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_HealthAssessment_STAGED') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessment_STAGED;
    END;
GO
--select top 100 * from [view_EDW_HealthAssessment_STAGED]
CREATE VIEW dbo.view_EDW_HealthAssessment_STAGED
AS SELECT
          UserStartedItemID
        , HealthAssesmentUserStartedNodeGUID
        , UserID
        , UserGUID
        , HFitUserMpiNumber
        , SiteGUID
        , AccountID
        , AccountCD
        , AccountName
        , cast(HAStartedDt as datetime) as HAStartedDt 
        , cast(HACompletedDt as datetime) as HACompletedDt
        , UserModuleItemId
        , UserModuleCodeName
        , HAModuleNodeGUID
        , CMSNodeGuid
        , HAModuleVersionID
        , UserRiskCategoryItemID
        , UserRiskCategoryCodeName
        , HARiskCategoryNodeGUID						--WDM 8/7/2014 as HARiskCategoryDocumentID
        , HARiskCategoryVersionID			--WDM 10.02.2014 place holder for EDW ETL
        , UserRiskAreaItemID
        , UserRiskAreaCodeName
        , HARiskAreaNodeGUID							--WDM 8/7/2014 as HARiskAreaDocumentID
        , HARiskAreaVersionID			--WDM 10.02.2014 place holder for EDW ETL
        , UserQuestionItemID
        , Title			--WDM 47619 12.29.2014
        , HAQuestionGuid		--WDM 9.2.2014	This is a repeat field but had to stay to match the previous view - this is the NODE GUID and matches to the definition file to get the question. This tells you the question, language agnostic.
        , UserQuestionCodeName
        , HAQuestionDocumentID	--WDM 10.1.2014 - this is GOING AWAY 		--WDM 10.02.2014 place holder for EDW ETL
        , HAQuestionVersionID			--WDM 10.1.2014 - this is GOING AWAY - no versions across environments 		--WDM 10.02.2014 place holder for EDW ETL
        , HAQuestionNodeGUID		--WDM 10.01.2014	Left this in place to preserve column structure.		
        , UserAnswerItemID
        , HAAnswerNodeGUID								--WDM 8/7/2014 as HAAnswerDocumentID
        , HAAnswerVersionID		--WDM 10.1.2014 - this is GOING AWAY - no versions across environments		--WDM 10.02.2014 place holder for EDW ETL
        , UserAnswerCodeName
        , HAAnswerValue
        , HAModuleScore
        , HARiskCategoryScore
        , HARiskAreaScore
        , HAQuestionScore
        , HAAnswerPoints
        , PointResults
        , UOMCode
        , HAScore
        , ModulePreWeightedScore
        , RiskCategoryPreWeightedScore
        , RiskAreaPreWeightedScore
        , QuestionPreWeightedScore
        , QuestionGroupCodeName
        --, ChangeType
        , cast(ItemCreatedWhen as datetime) as ItemCreatedWhen
        , cast(ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProfessionallyCollected
        , cast(HARiskCategory_ItemModifiedWhen as datetime) as HARiskCategory_ItemModifiedWhen
        , cast(HAUserRiskArea_ItemModifiedWhen as datetime) as HAUserRiskArea_ItemModifiedWhen
        , cast(HAUserQuestion_ItemModifiedWhen as datetime) as HAUserQuestion_ItemModifiedWhen
        , cast(HAUserAnswers_ItemModifiedWhen as datetime) as HAUserAnswers_ItemModifiedWhen
        , HAPaperFlg
        , HATelephonicFlg
        , HAStartedMode		--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 
        , HACompletedMode	--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 

        , DocumentCulture_VHCJ
        , DocumentCulture_HAQuestionsView
        , CampaignNodeGUID
	   ,cast(LastModifiedDate as datetime) as LastModifiedDate
          FROM Staging_EDW_HealthAssessment;

GO

PRINT 'Processed view_EDW_HealthAssessment_STAGED';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthAssessment_STAGED.sql';
GO 


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_STAGING_EDW_CompositeTracker.sql \n 
--------------------------------------------------------------- 

/*
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
07.08.2015 : WDM - competed validation testing 
*/

/****************************************************************************
select top 1000 * from DIM_EDW_Trackers

exec proc_STAGING_EDW_CompositeTracker 0   --Process Changed Data only
exec proc_STAGING_EDW_CompositeTracker 1   --Reload ALL
exec proc_STAGING_EDW_CompositeTracker 0,7

select * from DIM_TEMPTBL_Staging_EDW_Tracker_DATA
select  * from CT_VersionTracking ; 
PULLING Changes for versions between: 0  and 36


SELECT COUNT(*) FROM DIM_EDW_Trackers
SELECT COUNT(*) FROM [view_EDW_TrackerCompositeDetails_CT]
SELECT top 10 * FROM [view_EDW_TrackerCompositeDetails_CT]
SELECT TOP 100 * FROM [DIM_EDW_Trackers];
SELECT COUNT (*) FROM [DIM_EDW_Trackers]; 

PERF Measurements
03.26.2015 : 4681580 rows - 01:26:36 run time / PROD 1 @ LAB - full reload
03.29.2015 : Prod2  @ LAB : (xx row(s) affected) : 01:56:01 - Changed Records
04.23.2015 : 00 rows - 00:00:00 run time / PROD 1 @ LAB - full reload
****************************************************************************/

GO
PRINT 'FROM proc_STAGING_EDW_CompositeTracker.SQL';
PRINT 'Creating proc_STAGING_EDW_CompositeTracker';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_STAGING_EDW_CompositeTracker' )
    BEGIN
        PRINT 'Replacing proc_STAGING_EDW_CompositeTracker proc';
        DROP PROCEDURE
             proc_STAGING_EDW_CompositeTracker;
    END;
GO

IF EXISTS ( SELECT
                   table_name
              FROM information_schema.tables
              WHERE table_name = 'DIM_TEMPTBL_Staging_EDW_Tracker_DATA' )
    BEGIN
        IF NOT EXISTS ( SELECT
                               column_name
                          FROM information_schema.columns
                          WHERE
                               column_name = 'DeletedFlg'
                           AND table_name = 'DIM_TEMPTBL_Staging_EDW_Tracker_DATA' )
            BEGIN
                ALTER TABLE DIM_TEMPTBL_Staging_EDW_Tracker_DATA
                ADD
                            DeletedFlg bit NULL;
            END;
    END ;
ELSE
    BEGIN
        PRINT 'Creating DIM_TEMPTBL_Staging_EDW_Tracker_DATA Table';
        CREATE TABLE dbo.DIM_TEMPTBL_Staging_EDW_Tracker_DATA(
                     TrackerNameAggregateTable varchar( 32 ) NOT NULL ,
                     ItemID int NOT NULL ,
                     EventDate datetime NOT NULL ,
                     IsProfessionallyCollected bit NOT NULL ,
                     TrackerCollectionSourceID int NOT NULL ,
                     Notes nvarchar( 1000 ) NULL ,
                     UserID int NOT NULL ,
                     CollectionSourceName_Internal nvarchar( 100 ) NULL ,
                     CollectionSourceName_External nvarchar( 100 ) NULL ,
                     EventName varchar( 7 ) NOT NULL ,
                     UOM varchar( 10 ) NOT NULL ,
                     KEY1 varchar( 18 ) NOT NULL ,
                     VAL1 float NULL ,
                     KEY2 varchar( 13 ) NOT NULL ,
                     VAL2 float NULL ,
                     KEY3 varchar( 12 ) NOT NULL ,
                     VAL3 float NULL ,
                     KEY4 varchar( 9 ) NOT NULL ,
                     VAL4 float NULL ,
                     KEY5 varchar( 12 ) NOT NULL ,
                     VAL5 float NULL ,
                     KEY6 varchar( 11 ) NOT NULL ,
                     VAL6 float NULL ,
                     KEY7 varchar( 10 ) NOT NULL ,
                     VAL7 float NULL ,
                     KEY8 varchar( 3 ) NOT NULL ,
                     VAL8 float NULL ,
                     KEY9 varchar( 2 ) NOT NULL ,
                     VAL9 int NULL ,
                     KEY10 varchar( 2 ) NOT NULL ,
                     VAL10 int NULL ,
                     ItemCreatedBy int NULL ,
                     ItemCreatedWhen datetime NULL ,
                     ItemModifiedBy int NULL ,
                     ItemModifiedWhen datetime NULL ,
                     IsProcessedForHa bit NULL ,
                     TXTKEY1 varchar( 10 ) NOT NULL ,
                     TXTVAL1 nvarchar( 500 ) NULL ,
                     TXTKEY2 varchar( 8 ) NOT NULL ,
                     TXTVAL2 nvarchar( 255 ) NULL ,
                     TXTKEY3 varchar( 2 ) NOT NULL ,
                     TXTVAL3 int NULL ,
                     ItemOrder int NULL ,
                     ItemGuid uniqueidentifier NULL ,
                     UserGuid uniqueidentifier NOT NULL ,
                     MPI varchar( 50 ) NOT NULL ,
                     ClientCode varchar( 12 ) NULL ,
                     SiteGUID uniqueidentifier NOT NULL ,
                     AccountID int NOT NULL ,
                     AccountCD nvarchar( 8 ) NULL ,
                     IsAvailable bit NULL ,
                     IsCustom bit NULL ,
                     UniqueName nvarchar( 50 ) NULL ,
                     ColDesc nvarchar( 50 ) NULL ,
                     VendorID int NULL ,
                     VendorName nvarchar( 32 ) NULL ,
                     CT_ItemID int NULL ,
                     CT_ChangeVersion bigint NULL ,
                     CMS_Operation nchar( 1 ) NULL ,
                     DeleteFlg bit NULL ,
                     ConvertedToCentralTime bit NULL ,
                     TimeZone nvarchar( 10 ) NULL ,
                     ItemLastUpdated datetime NULL ,
                     DeletedFlg bit NULL
        )
        ON [PRIMARY];
    END;
GO

CREATE PROCEDURE proc_STAGING_EDW_CompositeTracker
@Reloadall int = 0
, @VersionNBR AS int = NULL
, @TrackProgress AS bit = 0
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE
       @iChangesFound AS int = 0;
    EXEC @iChangesFound = proc_CkTrackerDataChanged ;
    IF @iChangesFound = 0
        BEGIN
            PRINT 'No tracker changes found, run compete.';
		  set nocount off;
            RETURN;
        END;
    IF @iChangesFound = 1
        BEGIN
            PRINT 'Tracker changes found, UPDATES or INSERTS only - no deletes.';
        END;
    IF @iChangesFound = 2
        BEGIN
            PRINT 'Tracker changes found, UPDATES or INSERTS and DELETES.';
        END;

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_Trackers';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

    DECLARE
       @Synchronization_Version bigint = 0
       ,@iVersion AS int
       ,@Lastviewpull_Version AS bigint
       ,@Lastpullversion AS bigint
       ,@CurrentDbVersion AS int
       ,@STime AS datetime
       ,@TgtView AS nvarchar ( 100 ) = 'view_EDW_TrackerCompositeDetails'
       ,@ExtractionDate AS datetime
       ,@ExtractedVersion AS int
       ,@ExtractedRowCnt AS int
       ,@EndTime AS datetime
       ,@CNT_PulledRecords AS int = 0
       ,@iCnt AS int = 0
       ,@RowNbr AS int = 0
       ,@StartTime AS datetime = GETDATE ( )
       ,@SVRName AS nvarchar ( 100 )
       ,@DBName AS nvarchar ( 100 ) = DB_NAME ( )
       ,@CNT_Insert AS int = 0
       ,@CNT_Update AS int = 0
       ,@CNT_Delete AS int = 0
       ,@CNT_StagingTable int = 0;

    PRINT '*******************************************************************************************';
    PRINT '********** NOTICE *************************************************************************';
    PRINT 'ONLY RECORDS WITH A CORRESPONDING CHANGE TRACKING RECORD WILL BE RETURNED BY THIS PROC.';
    PRINT '*******************************************************************************************';

    SET @SVRName = ( SELECT
                            @@SERVERNAME );
    DECLARE
       @RecordID AS uniqueidentifier = NEWID ( );
    SET @STime = GETDATE ( );
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_CompositeTracker' , @STime , 0 , 'I';
    IF @Reloadall = NULL
        BEGIN
            SET @Reloadall = 0;
        END;
    IF @Reloadall = 1
        BEGIN

            --print 'Loc #01' ;

            SET @VersionNBR = NULL;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'RELOAD is ON: ' + CAST ( @Reloadall AS nvarchar ( 50 ));
                    PRINT 'Change Version is: ' + CAST ( @VersionNBR AS nvarchar ( 50 ));
                END;
        END;
    ELSE
        BEGIN

            --print 'Loc #02' ;

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'RELOAD is OFF: ' + CAST ( @Reloadall AS nvarchar ( 50 ));
                    PRINT 'Change Version is: ' + CAST ( @VersionNBR AS nvarchar ( 50 ));
                END;
        END;
    SET @CurrentDbVersion = CHANGE_TRACKING_CURRENT_VERSION ( );

    --print 'Loc #03' ;

    IF @Reloadall = 1
        BEGIN

            --print 'Loc #04' ;

            IF EXISTS ( SELECT
                               NAME
                          FROM sys.tables
                          WHERE name = 'DIM_EDW_Trackers' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_EDW_Trackers for FULL reload.';
                        END;
                    DROP TABLE
                         DIM_EDW_Trackers;
                END;
            ELSE
                BEGIN

                    --print 'Loc #05' ;

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading DIM_EDW_Trackers.';
                        END;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA data - this could take several hours, Started at: ' + CAST ( GETDATE ( ) AS
                          nvarchar ( 50 ));
                END;
            IF @Reloadall = 1
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'RELOADING ALL EDW HA Data.';
                        END;

                    --print 'Loc #06' ;

                    SELECT
                           * INTO
                                  DIM_EDW_Trackers
                      FROM view_EDW_TrackerCompositeDetails_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_Trackers';

                    ALTER TABLE DIM_EDW_Trackers
                    ADD
                                ItemLastUpdated datetime NULL;

                    IF @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( * )
                                            FROM DIM_EDW_Trackers );
                            PRINT DB_NAME ( ) + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt
                                  AS nvarchar ( 50 )) + ' records.';
                        END;

                    --print 'Loc #10' ;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( * )
                                                 FROM DIM_EDW_Trackers );
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                      FROM sys.indexes
                                      WHERE name = 'PI_Staging_EDW_Tracker_Dates' )
                        BEGIN
                            IF @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_Staging_EDW_Tracker_Dates at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                                END;
                            CREATE NONCLUSTERED INDEX PI_Staging_EDW_Tracker_Dates ON dbo.DIM_EDW_Trackers ( TrackerNameAggregateTable , itemID ,
                            ItemModifiedWhen ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
                            ONLINE = OFF ,
                            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                        END;
                    SET @ExtractionDate = GETDATE ( );
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( * )
                                               FROM DIM_EDW_Trackers );
                    SET @EndTime = GETDATE ( );
                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                           ,ExtractedVersion
                           ,CurrentDbVersion
                           ,ExtractedRowCnt
                           ,TgtView
                           ,StartTime
                           ,EndTime
                           ,SVRName
                           ,DBName
                           ,CNT_Insert
                           ,CNT_Update
                           ,CNT_delete
                           ,CNT_PulledRecords
                           ,CNT_StagingTable )
                    VALUES
                    (
                    @ExtractionDate ,
                    @ExtractedVersion ,
                    @CurrentDbVersion ,
                    @ExtractedRowCnt ,
                    @TgtView ,
                    @StartTime ,
                    @EndTime ,
                    @SVRName ,
                    @DBName ,
                    @CNT_Insert ,
                    @CNT_Update ,
                    @CNT_delete ,
                    @CNT_PulledRecords ,
                    @CNT_StagingTable );
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;

                    --print 'Loc #12' ;

                    SET @iCnt = @@ROWCOUNT;
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt;
                END;

            -- SELECT * INTO [DIM_EDW_Trackers] FROM [view_EDW_TrackerCompositeDetails_CT];

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;
            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_Staging_EDW_Tracker_Dates' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Adding INDEX PI_Staging_EDW_Tracker_Dates at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;
                    CREATE NONCLUSTERED INDEX PI_Staging_EDW_Tracker_Dates ON dbo.DIM_EDW_Trackers ( TrackerNameAggregateTable , itemID ,
                    ItemModifiedWhen ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
                    ONLINE = OFF ,
                    ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            --print 'Loc #13' ;

            SET @STime = GETDATE ( );

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Trackers';

            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_CompositeTracker' , @STime , @CNT_PulledRecords , 'U';
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @iCnt;

            --print 'Loc #15' ;        
            SET NOCOUNT OFF;
            RETURN;
        END;

    --print 'Loc #16' ;

    IF NOT EXISTS ( SELECT
                           NAME
                      FROM sys.tables
                      WHERE name = 'DIM_EDW_Trackers' )
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_Trackers was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            --print 'Loc #17' ;

            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_Staging_EDW_Tracker_Dates' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Adding INDEX PI_Staging_EDW_Tracker_Dates';
                        END;
                    CREATE NONCLUSTERED INDEX PI_Staging_EDW_Tracker_Dates ON dbo.DIM_EDW_Trackers ( TrackerNameAggregateTable , itemID ,
                    ItemModifiedWhen ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
                    ONLINE = OFF ,
                    ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;
            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_Staging_EDW_Tracker_IDs' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Adding INDEX PI_Staging_EDW_Tracker_IDs';
                        END;
                    CREATE CLUSTERED INDEX PI_Staging_EDW_Tracker_IDs ON dbo.DIM_EDW_Trackers ( TrackerNameAggregateTable , itemID ) WITH ( PAD_INDEX = OFF ,
                    STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON ,
                    ALLOW_PAGE_LOCKS = ON );
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name

                        --FROM tempdb.dbo.sysobjects
                        --WHERE id = OBJECT_ID ( N'tempdb..#DIM_TEMPTBL_Staging_EDW_Tracker_DATA')) 

                          FROM sys.tables
                          WHERE name = 'DIM_TEMPTBL_Staging_EDW_Tracker_DATA' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_TEMPTBL_Staging_EDW_Tracker_DATA';
                        END;
                    DROP TABLE
                         DIM_TEMPTBL_Staging_EDW_Tracker_DATA;
                END;
            PRINT 'Standby, PULL HA changes- this could take several hours: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
            SET @LastpullVersion = ( SELECT
                                            MAX ( CurrentDbVersion )
                                       FROM CT_VersionTracking
                                       WHERE
                                            SVRname = @@ServerName
                                        AND DBName = DB_NAME ( )
                                        AND TgtView = @TgtView );
            SET @LastViewPull_Version = ( SELECT
                                                 MAX ( ExtractedVersion )
                                            FROM CT_VersionTracking
                                            WHERE
                                                 SVRname = @@ServerName
                                             AND DBName = DB_NAME ( )
                                             AND TgtView = @TgtView );
            IF
                   @LastpullVersion < 0
                OR @LastpullVersion IS NULL
                BEGIN
                    SET @LastpullVersion = 0;
                END;
            IF
                   @LastViewPull_Version < 0
                OR @LastpullVersion IS NULL
                BEGIN
                    SET @LastViewPull_Version = 0;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Pulling @LastpullVersion ' + CAST ( @LastpullVersion AS nvarchar ( 50 ));
                    PRINT 'Pulling @LastViewPull_Version ' + CAST ( @LastViewPull_Version AS nvarchar ( 50 ));
                END;

            --****************************************************************************
            --FILL THE TEMP TABLE WITH DATA
            --****************************************************************************

            SELECT
                   * INTO
                          DIM_TEMPTBL_Staging_EDW_Tracker_DATA
              FROM view_EDW_TrackerCompositeDetails_CT
              WHERE CMS_Operation IS NOT NULL;

            EXEC proc_Add_EDW_CT_StdCols 'DIM_TEMPTBL_Staging_EDW_Tracker_DATA';

            SET @CNT_PulledRecords = @@ROWCOUNT;

            IF NOT EXISTS ( SELECT
                                   column_name
                              FROM information_schema.columns
                              WHERE
                                   column_name = 'DeletedFlg'
                               AND table_name = 'DIM_TEMPTBL_Staging_EDW_Tracker_DATA' )
                BEGIN
                    ALTER TABLE DIM_TEMPTBL_Staging_EDW_Tracker_DATA
                    ADD
                                DeletedFlg bit NULL;
                END;

            --ALTER TABLE DIM_TEMPTBL_Staging_EDW_Tracker_DATA
            --ADD
            --            DeletedFlg bit NULL;

            ALTER TABLE DIM_TEMPTBL_Staging_EDW_Tracker_DATA
            ADD
                        ItemLastUpdated datetime NULL;
            UPDATE DIM_TEMPTBL_Staging_EDW_Tracker_DATA
              SET
                  ItemLastUpdated = GETDATE ( );
            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'temp_PI_Staging_EDW_Tracker_IDs' )
                BEGIN
                    CREATE CLUSTERED INDEX temp_PI_Staging_EDW_Tracker_IDs ON dbo.DIM_TEMPTBL_Staging_EDW_Tracker_DATA ( TrackerNameAggregateTable , itemID ,
                    ItemModifiedWhen ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
                    ONLINE = OFF ,
                    ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;

            IF @TrackProgress = 1
                BEGIN
                    SET @iCnt = ( SELECT
                                         COUNT ( * )
                                    FROM DIM_TEMPTBL_Staging_EDW_Tracker_DATA );
                    PRINT DB_NAME ( ) + ' - Completed PULL at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50 )) + ' records.';
                END;
            SET @STime = GETDATE ( );
            SET @CurrentDbVersion = CHANGE_TRACKING_CURRENT_VERSION ( );
            IF @TrackProgress = 1
                BEGIN
                    PRINT '@CurrentDbVersion: ' + CAST ( @CurrentDbVersion AS nvarchar ( 50 ));
                END;
            SET @ExtractionDate = GETDATE ( );
            SET @ExtractedRowCnt = ( SELECT
                                            COUNT ( * )
                                       FROM DIM_TEMPTBL_Staging_EDW_Tracker_DATA );

            --SET @TgtView = 'view_EDW_TrackerCompositeDetails';

            SET @EndTime = GETDATE ( );
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'ADDING THE TRACKING RECORD.';
                END;
            INSERT INTO CT_VersionTracking (
                   ExtractionDate
                   ,ExtractedVersion
                   ,CurrentDbVersion
                   ,ExtractedRowCnt
                   ,TgtView
                   ,StartTime
                   ,EndTime
                   ,SVRName
                   ,DBName
                   ,CNT_Insert
                   ,CNT_Update
                   ,CNT_delete
                   ,CNT_PulledRecords )
            VALUES
            (
            @ExtractionDate ,

            --@LastpullVersion ,

            @CurrentDbVersion ,
            @CurrentDbVersion ,
            @ExtractedRowCnt ,
            @TgtView ,
            @StartTime ,
            @EndTime ,
            @SVRName ,
            @DBName ,
            @CNT_Insert ,
            @CNT_Update ,
            @CNT_delete ,
            @CNT_PulledRecords );
            SET @RowNbr = ( SELECT
                                   MAX ( RowNbr )
                              FROM CT_VersionTracking
                              WHERE
                                   SVRName = @SVRName
                               AND DBName = @DBName
                               AND TgtView = @TgtView );
            --SET @CNT_PulledRecords = ( SELECT
            --                              COUNT ( *) 
            --                                  FROM DIM_TEMPTBL_Staging_EDW_Tracker_DATA );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            --SELECT * FROM CT_VersionTracking
            --The temp table is loaded.
            --Check to see if NEW records exist and if not, insert them into the staging table

            SET @iCnt = ( SELECT
                                 COUNT ( * )
                            FROM
                                 DIM_TEMPTBL_Staging_EDW_Tracker_DATA AS T1 LEFT JOIN
                                      DIM_EDW_Trackers AS T2
                                                                     ON
                                 T1.TrackerNameAggregateTable = T2.TrackerNameAggregateTable
                             AND T1.ItemId = T2.ItemId
                            WHERE T2.ItemID IS NULL );
            IF @TrackProgress = 1
                BEGIN
                    PRINT '#New Records found: ' + CAST ( @iCnt AS nvarchar ( 50 )) + '. Updating VersionTracking RowNbr: ' + CAST ( @RowNbr AS
                          nvarchar ( 5 ));
                END;
            UPDATE CT_VersionTracking
              SET
                  CNT_Insert = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            --***************************************************
            --FIND AND PROCESS NEW RECORDS
            --***************************************************
            EXEC @iCnt = proc_CT_TrackerComposite_AddNewRecs ;
            --***************************************************            

            PRINT 'NEW RECORDS FOUND : ' + CAST ( @iCnt AS nvarchar ( 50 ));
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @iCnt;

            --Check to see if CURRENT records have differnet HASH codes and if so, update the staging table

            SET @iCnt = ( SELECT
                                 COUNT ( * )
                            FROM
                                 DIM_EDW_Trackers AS T2 JOIN
                                      DIM_TEMPTBL_Staging_EDW_Tracker_DATA AS T1
                                                            ON
                                 T1.TrackerNameAggregateTable = T2.TrackerNameAggregateTable
                             AND T1.ItemId = T2.ItemId
                            WHERE T1.CMS_Operation IS NOT NULL );
            IF @TrackProgress = 1
                BEGIN
                    PRINT '#Records found to update: ' + CAST ( @iCnt AS nvarchar ( 50 )) + '. Updating VersionTracking RowNbr: ' + CAST ( @RowNbr AS
                          nvarchar ( 5 ));
                END;
            UPDATE CT_VersionTracking
              SET
                  CNT_Update = @iCnt
              WHERE
                    RowNbr = @RowNbr;

		  /**********************************************************************************************
		  FIND AND PROCESS UPDATED ROWS
		  Set and record the Current DB change version and use it to prevent updating the data twice.
		  **********************************************************************************************/
            EXEC @iCnt = proc_CT_TrackerComposite_AddUpdatedRecs ;            
            PRINT 'UPDATED RECORDS FOUND : ' + CAST ( @iCnt AS nvarchar ( 50 ));

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iCnt;
            --EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iCnt;
            

            /* update DIM_TEMPTBL_Staging_EDW_Tracker_DATA Set CMS_Operation = 'D' where ItemID in (Select top 100 ItemID from DIM_TEMPTBL_Staging_EDW_Tracker_DATA) */
		  --***************************************
		  -- MARK Delted records
		  exec @iCnt = proc_CT_TrackerComposite_AddDeletedRecs ;            
            PRINT 'DELETED RECORDS FLAGGED : ' + CAST ( @iCnt AS nvarchar ( 50 ));

		  UPDATE CT_VersionTracking
              SET
                  CNT_delete = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iCnt;
            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( * )
                                        FROM DIM_EDW_Trackers );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;
            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
              WHERE
                    RowNbr = @RowNbr;
            SET @STime = GETDATE ( );

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Trackers';
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_CompositeTracker' , @STime , @CNT_PulledRecords , 'U';

            --EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D', @iCnt;

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @CNT_PulledRecords;
        END;
    SET NOCOUNT OFF;
END;
GO
PRINT 'Created proc_STAGING_EDW_CompositeTracker';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_TrackerCompositeDetails.sql" \n 
--------------------------------------------------------------- 

--IF EXISTS (SELECT name FROM sys.triggers where name = 'trgSchemaMonitor')    
--DISABLE TRIGGER trgSchemaMonitor ON DATABASE;

GO
PRINT '***** FROM: view_EDW_TrackerCompositeDetails.sql';
PRINT 'Processing: view_EDW_TrackerCompositeDetails ';
GO
--SELECT top 10 * from view_EDW_TrackerCompositeDetails
IF EXISTS ( SELECT DISTINCT
                   TABLE_NAME
                   FROM INFORMATION_SCHEMA.VIEWS
                   WHERE
                   TABLE_NAME = 'view_EDW_TrackerCompositeDetails') 
    BEGIN
        DROP VIEW
             view_EDW_TrackerCompositeDetails;
    END;
GO
--count with UNION ALL xx @ 00:00:24
--count with UNION ALL and DISTINCT xx @ 00:00:24
--count with UNION 3,218,556 @ 00:00:24
--SELECT count(*) from view_EDW_TrackerCompositeDetails;
GO
CREATE VIEW dbo.view_EDW_TrackerCompositeDetails
AS
--************************************************************************************************************************************
-- NOTES:
--************************************************************************************************************************************
--WDM 6/26/2014
--This view is needed by EDW in order to process the Tracker tables' data.
--As of now, the Tracker tables are representative of objects and that would cause 
--	large volumes of ETL to be devloped and maintained. 
--This view represents a columnar representation of all tracker tables in a Key/Value pair representation.
--Each tracker table to be processed into the EDW must be represented in this view.
--ALL new tracker tables need only be entered once using the structure contained within this view
--	and the same EDW ETL should be able to process it.
--If there is a change to the strucuture of any one query in this view, then all have to be modified 
--	to be support the change.
--Column TrackerNameAggregratetable (AggregateTableName) will be NULL if the Tracker is not a member 
--		of the DISPLAYED Trackers. This allows us to capture all trackers, displayed or not.
--EventDate is the qualifier to pull a date or between dates.
--7/29/2014
--ISSUE: HFit_TrackerBMI,  HFit_TrackerCholesterol, and HFit_TrackerHeight are not in the HFIT_Tracker
--		table. This causes T.IsAvailable, T.IsCustom, T.UniqueName to be NULL. 
--		This raises the need for the Tracker Definition Table.

--NOTE: It is a goal to keep this view using BASE tables in order to gain max performance. Nested views will 
--		be avoided here if possible.

--**************** SPECIFIC TRACKER DATA **********************
--**************** on 7/29/2014          **********************
--Tracker GUID or Unique ID across all DB Instances (ItemGuid)
--Tracker NodeID (we use it for the External ID for Audit and error Triage)  (John: can use ItemID in this case)
--Tracker Table Name or Value Group Name (e.g. Body Measurements) - Categorization (TrackerNameAggregateTable)
--Tracker Column Unique Name ( In English)  Must be consistent across all DB Instances  ([UniqueName] will be 
--		the TABLE NAME if tracker name not found in the HFIT_Tracker table)
--Tracker Column Description (In English) (???)
--Tracker Column Data Type (e.g. Character, Numeric, Date, Bit or Yes/No)  so that we can set up the answer type
--	NULLS accepted for No Answer?	(KEY1, KEY2, VAL1, VAL2, etc)
--Tracker Active flag (IsAvailable will be null if tracker name not found in the HFIT_Tracker table)
--Tracker Unit of Measure (character) (Currently, the UOM is supplied in the view based on the table and type of Tracker)
--Tracker Insert Date ([ItemCreatedWhen])
--Tracker Last Update Date ([ItemModifiedWhen])
--NOTE: Convert all numerics to floats 7/30/2104 John/Dale
--****************************************************************************************************************************
-- 12.21.2014 - Added Select Distincts to avoid possible dups.
-- 12.23.2014 - Added the Vendor ID and Vendor name to the view via the HFit_LKP_TrackerVendor table
-- 12.25.2014 - Tested the view to see that it returned the correct VendorID description
--****************************************************************************************************************************
-- NEW ADDITIONS: 02.01.2015	Need for the updates to be completed and then we add.
--	  HFit_TrackerTobaccoAttestation
--	  HFit_TrackerPreventiveCare
--	  HFit_TrackerCotinine
--(03.20.2015) - (WDM) The DISTINCT in this qry in should eliminate duplicate rows found by John C.
--			 All worked correctly in 12.25.2014, NO changes effected since then, and unexplicably rows stated to 
--			 duplicate in three tables (tracker views) Shots, Tests, and TrackerInstance
--(03.20.2015) - WDM : HFit_TrackerInstance_Tracker has a problem that will require developer help - it is still OPEN.
--			    John C. and I looked at the issue and the LEFT join is causing a cartisian as there is no KEY 
--			    on which to join.
-- TGT (PRod1) NO DISTINCT: 
--  SELECT DISTINCT count(*) from view_EDW_TrackerCompositeDetails 00:08:36 @ 3,210,081
--- TGT (PRod1) WITH DISTINCT and Union all: 
--  SELECT DISTINCT count(*) from view_EDW_TrackerCompositeDetails 00:00:30 @ 3,210,081
--- TGT (PRod1) No DISTINCT and UNion all: 
--  SELECT DISTINCT count(*) from view_EDW_TrackerCompositeDetails 00:00:14 @ 3,218,556
--(03.21.2015) - WDM : Implemented bew code for TrackerInstance and it returns data properly now.
--(03.22.2015) - WDM : Found and corrected the Shots and Tests duplicate rows. No DUPS at this point.
--(
--****************************************************************************************************************************
--Best USE is:		(however, I do not believe Laura is allowing this view to be called in this fashion)
--SELECT * from view_EDW_TrackerCompositeDetails where EventDate between '2013-11-04 00:00:00' and '2013-11-04 23:59:59'

--Set statistics IO ON
--GO

SELECT DISTINCT
       'HFit_TrackerBloodPressure' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mm/Hg' AS UOM
     , 'Systolic' AS KEY1
     , CAST ( Systolic AS float) AS VAL1
     , 'Diastolic' AS KEY2
     , CAST ( Diastolic AS float) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'bp') AS UniqueName
     , ISNULL ( T.UniqueName , 'bp') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerBloodPressure AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBloodPressure'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBloodSugarAndGlucose' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/L' AS UOM
     , 'Units' AS KEY1
     , CAST ( Units AS float) AS VAL1
     , 'FastingState' AS KEY2
     , CAST ( FastingState AS float) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'glucose') AS UniqueName
     , ISNULL ( T.UniqueName , 'glucose') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerBloodSugarAndGlucose AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBMI' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'kg/m2' AS UOM
     , 'BMI' AS KEY1
     , CAST ( BMI AS float) AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerBMI AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBMI'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBodyFat' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'PCT' AS UOM
     , 'Value' AS KEY1
     , CAST ( [Value] AS float) AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerBodyFat AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBodyFat'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
--******************************************************************************
SELECT DISTINCT
       'HFit_TrackerBodyMeasurements' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Inch' AS UOM
     , 'WaistInches' AS KEY1
     , CAST ( WaistInches AS float) AS VAL1
     , 'HipInches' AS KEY2
     , CAST ( HipInches AS float) AS VAL2
     , 'ThighInches' AS KEY3
     , CAST ( ThighInches AS float) AS VAL3
     , 'ArmInches' AS KEY4
     , CAST ( ArmInches AS float) AS VAL4
     , 'ChestInches' AS KEY5
     , CAST ( ChestInches AS float) AS VAL5
     , 'CalfInches' AS KEY6
     , CAST ( CalfInches AS float) AS VAL6
     , 'NeckInches' AS KEY7
     , CAST ( NeckInches AS float) AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerBodyMeasurements AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
--******************************************************************************
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCardio' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'Minutes' AS KEY1
     , CAST ( Minutes AS float) AS VAL1
     , 'Distance' AS KEY2
     , CAST ( Distance AS float) AS VAL2
     , 'DistanceUnit' AS KEY3
     , CAST ( DistanceUnit AS float) AS VAL3
     , 'Intensity' AS KEY4
     , CAST ( Intensity AS float) AS VAL4
     , 'ActivityID' AS KEY5
     , CAST ( ActivityID AS float) AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerCardio AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCardio'
--the following where clause was added on 11/23/2015 as a result of BAD DATA from the PPT
where EventDate > '01/01/1960'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCholesterol' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mg/dL' AS UOM
     , 'HDL' AS KEY1
     , CAST ( HDL AS float) AS VAL1
     , 'LDL' AS KEY2
     , CAST ( LDL AS float) AS VAL2
     , 'Total' AS KEY3
     , CAST ( Total AS float) AS VAL3
     , 'Tri' AS KEY4
     , CAST ( Tri AS float) AS VAL4
     , 'Ratio' AS KEY5
     , CAST ( Ratio AS float) AS VAL5
     , 'Fasting' AS KEY6
     , CAST ( Fasting AS float) AS VAL6
     , 'VLDL' AS VLDL
     , CAST ( VLDL AS float) AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerCholesterol AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCholesterol'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerDailySteps' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Step' AS UOM
     , 'Steps' AS KEY1
     , CAST ( Steps AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerDailySteps AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerDailySteps'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFlexibility' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasStretched' AS KEY1
     , CAST ( HasStretched AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerFlexibility AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerFlexibility'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFruits' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST ( Cups AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerFruits AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerFruits'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/mol' AS UOM
     , 'Value' AS KEY1
     , CAST ( [Value] AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerHbA1c AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHbA1c'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHeight' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'inch' AS UOM
     , 'Height' AS KEY1
     , Height AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerHeight AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHeight'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighFatFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerHighFatFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHighFatFoods'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighSodiumFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerHighSodiumFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHighSodiumFoods'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
--w/o  distinct 00:02:07 @ 477120 PRD1
--with distinct 00:03:20 @ 475860 PRD1
--(03.20.2015) - (WDM) verified SELECT DISTINCT to this qry in order to eliminate duplicate rows found by John C.
SELECT DISTINCT 'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable ,
                     TT.ItemID ,
                     cast(EventDate as datetime) as EventDate ,
                     TT.IsProfessionallyCollected ,
                     TT.TrackerCollectionSourceID ,
                     Notes ,
                     TT.UserID ,
                     CollectionSourceName_Internal ,
                     CollectionSourceName_External ,
                     'MISSING' AS EventName ,
                     'Y/N' AS UOM ,
                     'TrackerDefID' AS KEY1 ,
                     CAST (TrackerDefID AS float) AS VAL1 ,
                     'YesNoValue' AS KEY2 ,
                     CAST (YesNoValue AS float) AS VAL2 ,
                     'NA' AS KEY3 ,
                     NULL AS VAL3 ,
                     'NA' AS KEY4 ,
                     NULL AS VAL4 ,
                     'NA' AS KEY5 ,
                     NULL AS VAL5 ,
                     'NA' AS KEY6 ,
                     NULL AS VAL6 ,
                     'NA' AS KEY7 ,
                     NULL AS VAL7 ,
                     'NA' AS KEY8 ,
                     NULL AS VAL8 ,
                     'NA' AS KEY9 ,
                     NULL AS VAL9 ,
                     'NA' AS KEY10 ,
                     NULL AS VAL10 ,
                     TT.ItemCreatedBy ,
                     cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen ,
                     TT.ItemModifiedBy ,
                     cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen ,
                     NULL AS IsProcessedForHa ,
                     'NA' AS TXTKEY1 ,
                     NULL AS TXTVAL1 ,
                     'NA' AS TXTKEY2 ,
                     NULL AS TXTVAL2 ,
                     'NA' AS TXTKEY3 ,
                     NULL AS TXTVAL3 ,
                     NULL AS ItemOrder ,
                     NULL AS ItemGuid ,
                     C.UserGuid ,
                     PP.MPI ,
                     PP.ClientCode ,
                     S.SiteGUID ,
                     ACCT.AccountID ,
                     ACCT.AccountCD ,
                     T.IsAvailable ,
                     T.IsCustom ,
                     T.UniqueName ,
                     T.UniqueName AS ColDesc ,
                     NULL AS VendorID,
                     NULL AS VendorName
          FROM dbo.HFit_TrackerInstance_Tracker AS TT
                              INNER JOIN dbo.HFit_TrackerDef_Tracker TDT     
                                  ON TDT.trackerid = TT.trackerDefID
                           INNER JOIN dbo.CMS_User AS C
                                  ON C.UserID = TT.UserID
                           INNER JOIN dbo.hfit_ppteligibility AS PP
                                  ON TT.UserID = PP.userID
                           INNER JOIN dbo.HFit_Account AS ACCT
                                  ON PP.ClientCode = ACCT.AccountCD
                           INNER JOIN dbo.CMS_Site AS S
                                  ON ACCT.SiteID = S.SiteID
                           INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                                  ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                                  ON T.AggregateTableName = 'HFit_TrackerInstance_Tracker'
                                                         AND T.uniquename = TDT.name
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST ( Portions AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerMealPortions AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerMealPortions'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FollowedPlan' AS KEY1
     , CAST ( FollowedPlan AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerMedicalCarePlan AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerMedicalCarePlan'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRegularMeals' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Units' AS KEY1
     , CAST ( Units AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerRegularMeals AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerRegularMeals'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRestingHeartRate' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'BPM' AS UOM
     , 'HeartRate' AS KEY1
     , CAST ( HeartRate AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerRestingHeartRate AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
--With DISTINCT 00:14 @ 40041
--With NO DISTINCT 00:14 @ 40060
--(03.20.2015) - (WDM) added a SELECT DISTINCT to this qry in order to eliminate duplicate rows found by John C.
SELECT DISTINCT
       'HFit_TrackerShots' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FluShot' AS KEY1
     , CAST ( FluShot AS float) AS VAL1
     , 'PneumoniaShot' AS KEY2
     , CAST ( PneumoniaShot AS float) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerShots AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerShots'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSitLess' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerSitLess AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSitLess'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSleepPlan' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'HR' AS UOM
     , 'DidFollow' AS KEY1
     , CAST ( DidFollow AS float) AS VAL1
     , 'HoursSlept' AS KEY2
     , HoursSlept AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Techniques' AS TXTKEY1
     , Techniques AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerSleepPlan AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSleepPlan'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStrength' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasTrained' AS KEY1
     , CAST ( HasTrained AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerStrength AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStrength'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStress' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'Intensity' AS KEY1
     , CAST ( Intensity AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Awareness' AS TXTKEY1
     , Awareness AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerStress AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStress'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStressManagement' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'HasPracticed' AS KEY1
     , CAST ( HasPracticed AS float) AS VAL1
     , 'Effectiveness' AS KEY2
     , CAST ( Effectiveness AS float) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerStressManagement AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStressManagement'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryDrinks' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST ( Ounces AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerSugaryDrinks AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSugaryDrinks'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST ( Portions AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerSugaryFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSugaryFoods'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
--Using DISTINCT PROD1 - 00:08:41 @ 40313
--Using DISTINCT PRD1 - 00:00:09 @ 45502
--Using NO DISTINCT PRD1 00:19 @ 40332
--Using DISTINCT PRD1 - 00:00:11 @ 44483
--(03.20.2015) - (WDM) added a SELECT DISTINCT to this qry in order to eliminate duplicate rows found by John C.
SELECT DISTINCT
       'HFit_TrackerTests' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PSATest' AS KEY1
     , CAST ( PSATest AS float) AS VAL1
     , 'OtherExam' AS KEY1
     , CAST ( OtherExam AS float) AS VAL2
     , 'TScore' AS KEY3
     , CAST ( TScore AS float) AS VAL3
     , 'DRA' AS KEY4
     , CAST ( DRA AS float) AS VAL4
     , 'CotinineTest' AS KEY5
     , CAST ( CotinineTest AS float) AS VAL5
     , 'ColoCareKit' AS KEY6
     , CAST ( ColoCareKit AS float) AS VAL6
     , 'CustomTest' AS KEY7
     , CAST ( CustomTest AS float) AS VAL7
     , 'TSH' AS KEY8
     , CAST ( TSH AS float) AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'CustomDesc' AS TXTKEY1
     , CustomDesc AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerTests AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTests'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoFree' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'WasTobaccoFree' AS KEY1
     , CAST ( WasTobaccoFree AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'QuitAids' AS TXTKEY1
     , QuitAids AS TXTVAL1
     , 'QuitMeds' AS TXTKEY2
     , QuitMeds AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerTobaccoFree AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTobaccoFree'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerVegetables' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST ( Cups AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerVegetables AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerVegetables'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWater' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST ( Ounces AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerWater AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWater'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWeight' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'LBS' AS UOM
     , 'Value' AS KEY1
     , [Value] AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerWeight AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWeight'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWholeGrains' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-serving' AS UOM
     , 'Servings' AS KEY1
     , CAST ( Servings AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerWholeGrains AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWholeGrains'
			 --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL

SELECT DISTINCT
       'HFit_TrackerCotinine' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'NicotineAssessment' AS KEY1
     , CAST ( NicotineAssessment AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
       FROM
            dbo.HFit_TrackerCotinine AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCotinine'
--LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.VendorID = VENDOR.ItemID;

UNION ALL
SELECT DISTINCT
       'HFit_TrackerPreventiveCare' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PreventiveCare' AS KEY1
     , CAST ( PreventiveCare AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
       FROM
            dbo.HFit_TrackerPreventiveCare AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerPreventiveCare'
--LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.VendorID = VENDOR.ItemID;
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoAttestation' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'TobaccoAttestation' AS KEY1
     , CAST ( TobaccoAttestation AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
       FROM
            dbo.HFit_TrackerTobaccoAttestation AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTobaccoAttestation';
--LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.VendorID = VENDOR.ItemID;

GO

--  
--  
GO
PRINT '***** CREATED: view_EDW_TrackerCompositeDetails.sql';
GO 

--IF EXISTS (SELECT name FROM sys.triggers where name = 'trgSchemaMonitor')    
--enable TRIGGER trgSchemaMonitor ON DATABASE;

GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: CreateJobPullEdwData.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'From CreateJobPullEdwData.sql';
PRINT 'Creating : job_EDW_GetStagingData_HA_' + DB_NAME();
GO

/****** Object:  Job [job_EDW_GetStagingData]    Script Date: 3/28/2015 12:29:16 PM ******/

BEGIN TRANSACTION;
DECLARE
   @DB  AS nvarchar (100) = DB_NAME (),
   @JobName AS nvarchar (100) = '',
    @JNAME AS nvarchar (100) = '',
   @ReturnCode int;

SELECT
       @ReturnCode = 0;

SET @JobName = 'job_EDW_GetStagingData_HA_' + @DB;
print('CREATING Procedure ' + @JobName) ;
set @JNAME = @JobName ;
IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
	   print('UPDATING Procedure ' + @JobName) ;
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/28/2015 12:29:16 PM ******/

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JobName,
@enabled = 1,
@notify_level_eventlog = 0,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'DMiller',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [PullThedata]    Script Date: 3/28/2015 12:29:17 PM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'PullThedata',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_STAGING_EDW_HA_Changes 0 ',
@database_name = @DB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Edw Staging Data Schedule',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150328,
@active_end_date = 99991231,
@active_start_time = 0,
@active_end_time = 235959
--@schedule_uid = N'1de52534-38dc-4155-baf3-0eb7259df6c1';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

GO

PRINT 'CREATED : job_EDW_GetStagingData_HA_ ' + DB_NAME();;

GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_STAGING_EDW_RewardUserDetail.sql \n 
--------------------------------------------------------------- 

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'creating proc_EDW_RewardUserDetail';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_RewardUserDetail') 
    BEGIN
        PRINT 'Replacing proc_EDW_RewardUserDetail';
        DROP PROCEDURE
             proc_EDW_RewardUserDetail;
    END;

GO

/*---------------------------------------
exec proc_EDW_RewardUserDetail 0 
exec proc_EDW_RewardUserDetail 1
*/

CREATE PROCEDURE proc_EDW_RewardUserDetail
       @Reloadall int = 0
AS
BEGIN
    --declare @Reloadall as int = 1 ; 
    SET NOCOUNT ON;

/*-------------------------------------------------
RETURNS:	  Integer -   0 = no changes
				    1 = updates or inserts, no deletes
				    2 = DELETES and possibly updates or inserts
*/
    DECLARE @iChanges AS int = 0;
    EXEC @iChanges = proc_CkRewardUserDetailHasChanged ;
    IF @iChanges = 0
        BEGIN
            PRINT 'NO Changes found for Reward USer Details, competed.';
            RETURN;
        END;

    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardUserDetail';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

    DECLARE
    @RecordID AS uniqueidentifier = NEWID () 
  , @CT_DateTimeNow AS datetime = GETDATE () 
  , @CT_NAME AS nvarchar ( 50) = 'proc_EDW_RewardUserDetail';

    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            PRINT 'RELOADING all proc_EDW_RewardUserDetail data';
            IF EXISTS ( SELECT
                               name
                               FROM sys.tables
                               WHERE name = 'DIM_EDW_RewardUserDetail') 
                BEGIN
                    DROP TABLE
                         DIM_EDW_RewardUserDetail;
                END;

            IF NOT EXISTS ( SELECT
                                   name
                                   FROM sys.tables
                                   WHERE name = 'DIM_EDW_RewardUserDetail') 
                BEGIN
                    SELECT
                           * INTO
                                  DIM_EDW_RewardUserDetail
                           FROM view_EDW_RewardUserDetail_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardUserDetail';

                    DECLARE
                    @iCnt2 AS int = @@ROWCOUNT;
                    PRINT 'Processed ' + CAST ( @iCnt2 AS nvarchar ( 50)) ;

                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt2;
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @iCnt2;
                    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @iCnt2 , 'U';

                    SET ANSI_PADDING ON;

                    CREATE CLUSTERED INDEX PI_EDW_RewardUserDetail ON dbo.
                    DIM_EDW_RewardUserDetail
                    (
                    UserGUID ASC ,
                    AccountID ASC ,
                    AccountCD ASC ,
                    SiteGUID ASC ,
                    HFitUserMpiNumber ASC ,
                    RewardActivityGUID ASC ,
                    RewardTriggerGUID ASC
                    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
                    DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                    CREATE NONCLUSTERED INDEX PI_EDW_RewardUserDetail_RowNbrCDate ON dbo.
                    DIM_EDW_RewardUserDetail
                    (
                    RowNbr , LastModifiedDate , DeletedFlg
                    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
                    DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                    PRINT 'ALL Records reloaded successfully';
                    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserDetail';

                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt2;
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @iCnt2;

                    SET NOCOUNT OFF;

                    RETURN;
                END;
        END;

    PRINT 'RELOADING Changes Only';
    IF EXISTS ( SELECT
                       name
                       FROM tempdb.dbo.sysobjects
                       WHERE id = OBJECT_ID ( N'tempdb..##Temp_RewardUserDetail')) 
        BEGIN
            PRINT 'Dropping ##Temp_RewardUserDetail';
            DROP TABLE
                 ##Temp_RewardUserDetail;
        END;

if @iChanges = 1
begin
    print 'Changes and NO DELETES Found, loading only changed data.';
    SELECT
           *
    INTO
         ##Temp_RewardUserDetail
           FROM view_EDW_RewardUserDetail_CT;
end ;
if @iChanges = 2
begin
    print 'DELETES Found, loading all data for compare.';
    declare @MySql as nvarchar(2000) = 'SELECT * INTO ##Temp_RewardUserDetail FROM view_EDW_RewardUserDetail_CT ' ; 
    exec (@MySql) ;
end ;

    DECLARE
    @iCnt AS int = @@ROWCOUNT;

    ALTER TABLE ##Temp_RewardUserDetail
    ADD
                LastModifiedDate datetime2 (7) NULL;
    ALTER TABLE ##Temp_RewardUserDetail
    ADD
                RowNbr int IDENTITY ( 1 , 1) ;

    ALTER TABLE ##Temp_RewardUserDetail
    ADD
                DeletedFlg bit NULL;

    ALTER TABLE ##Temp_RewardUserDetail
    ADD
                ConvertedToCentralTime bit NULL;

    ALTER TABLE ##Temp_RewardUserDetail
    ADD
                TimeZone nvarchar (10) NULL;

    CREATE CLUSTERED INDEX PI_TEMP_EDW_RewardUserDetail ON ##Temp_RewardUserDetail
    (
    UserGUID ASC ,
    AccountID ASC ,
    AccountCD ASC ,
    SiteGUID ASC ,
    HFitUserMpiNumber ASC ,
    RewardActivityGUID ASC ,
    RewardTriggerGUID ASC
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
    DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @iCnt , 'U';
    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @iCnt;

    --************************************************
    --get the NEW records and insert them
    --************************************************
    DECLARE
    @iIns AS int = 0;
    EXEC @iIns = proc_CT_RewardUserDetail_AddNewRecs ;
    PRINT 'INSERTED Count: ' + CAST ( @iIns AS nvarchar (50)) ;
    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iIns;

    --************************************************
    --get the changed records and update them
    --************************************************
    DECLARE
    @iUpdt AS int = 0;
    EXEC @iUpdt = proc_CT_RewardUserDetail_AddUpdatedRecs ;
    PRINT 'Records Updated: ' + CAST ( @iUpdt AS nvarchar (5)) ;
    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdt;

/*---------------------------------------------
***********************************************
    FIND DELETED ROWS
***********************************************
*/
    DECLARE
    @iDel AS int = 0;
    EXEC @iDel = proc_CT_RewardUserDetail_AddDeletedRecs ;
    PRINT 'Records Marked As Deleted: ' + CAST ( @iDel AS nvarchar (50)) ;

    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDel;
    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserDetail';

    SET NOCOUNT OFF;

END;

GO
PRINT 'Created proc_EDW_RewardUserDetail';
PRINT GETDATE () ;

--select top 100 * from DIM_EDW_RewardUserDetail

GO
PRINT 'CREATED proc_EDW_RewardUserDetail';
PRINT GETDATE () ;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_HealthAssesment_CT.sql" \n 
--------------------------------------------------------------- 


GO
-- use KenticoCMS_Prod1

GO

PRINT ' FROM view_EDW_HealthAssesment_CT.sql';

PRINT 'Processing view_EDW_HealthAssesment_CT';

/*-------------------------------------------------------------------------------------------------------------------
*******************************************************************************************************************
SELECT count(*) FROM view_EDW_HealthAssesment_CT  WHERE [ChangeType] IS NOT NULL group by [ChangeType] ;	   --6587671
SELECT count(*) FROM view_EDW_HealthAssesment_CT  group by [ChangeType] ;
SELECT count(*) FROM view_EDW_HealthAssesment_CT WHERE [ChangeType] = 'U';    
SELECT top 100 * FROM view_EDW_HealthAssesment_CT WHERE [ChangeType] = 'U';  
*******************************************************************************************************************
*/

GO

IF NOT EXISTS ( SELECT
                       name
                       FROM sys.indexes
                       WHERE name = 'CI_HFit_HealthAssesmentUserRiskArea_HARiskCategoryItemID') 

    BEGIN

        CREATE NONCLUSTERED INDEX CI_HFit_HealthAssesmentUserRiskArea_HARiskCategoryItemID ON dbo.HFit_HealthAssesmentUserRiskArea (
        HARiskCategoryItemID) INCLUDE (
        ItemID
        , HARiskAreaScore
        , ItemModifiedWhen
        , CodeName
        , PreWeightedScore
        , HARiskAreaNodeGUID) ;
    END;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.views
                   WHERE name = 'view_EDW_HealthAssesment_CT') 

    BEGIN

        DROP VIEW
             view_EDW_HealthAssesment_CT;
    END;

GO

/*------------------------------------------------------------------------
************************************************************************
**************************************************************************
select top 100 * from [view_EDW_HealthAssesment_CT] 

select * 
into #TEMP_HA
from [view_EDW_HealthAssesment_CT] 
where CHANGED_FLG is not null

select * from #TEMP_HA

--07.09.2015 (WDM) - Dea and I discussed the need to capture and present the Health Assessment Type.
--				Mark and I discussed how best to do this and the data, basically, was already in 
--				the view. I added the field HealthAssessmentType to the view.

**************************************************************************
************************************************************************
*/
CREATE VIEW dbo.view_EDW_HealthAssesment_CT
AS SELECT
          HAUserStarted.ItemID AS UserStartedItemID
        , VHAJ.NodeGUID AS HealthAssesmentUserStartedNodeGUID
        , HAUserStarted.UserID
        , CMSUser.UserGUID
        , UserSettings.HFitUserMpiNumber
        , CMSSite.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , ACCT.AccountName
        , HAUserStarted.HAStartedDt
        , HAUserStarted.HACompletedDt
        , HAUserModule.ItemID AS UserModuleItemId
        , HAUserModule.CodeName AS UserModuleCodeName
        , HAUserModule.HAModuleNodeGUID
        , VHAJ.NodeGUID AS CMSNodeGuid
        , NULL AS HAModuleVersionID
        , HARiskCategory.ItemID AS UserRiskCategoryItemID
        , HARiskCategory.CodeName AS UserRiskCategoryCodeName
        , HARiskCategory.HARiskCategoryNodeGUID
        , NULL AS HARiskCategoryVersionID
        , HAUserRiskArea.ItemID AS UserRiskAreaItemID
        , HAUserRiskArea.CodeName AS UserRiskAreaCodeName
        , HAUserRiskArea.HARiskAreaNodeGUID
        , NULL AS HARiskAreaVersionID
        , HAUserQuestion.ItemID AS UserQuestionItemID
        , dbo.udf_StripHTML ( HAQuestionsView.Title) AS Title
        , HAUserQuestion.HAQuestionNodeGUID AS HAQuestionGuid
        , HAUserQuestion.CodeName AS UserQuestionCodeName
        , NULL AS HAQuestionDocumentID
        , NULL AS HAQuestionVersionID
        , HAUserQuestion.HAQuestionNodeGUID
        , HAUserAnswers.ItemID AS UserAnswerItemID
        , HAUserAnswers.HAAnswerNodeGUID
        , NULL AS HAAnswerVersionID
        , HAUserAnswers.CodeName AS UserAnswerCodeName
        , HAUserAnswers.HAAnswerValue
        , HAUserModule.HAModuleScore
        , HARiskCategory.HARiskCategoryScore
        , HAUserRiskArea.HARiskAreaScore
        , HAUserQuestion.HAQuestionScore
        , HAUserAnswers.HAAnswerPoints
        , HAUserQuestionGroupResults.PointResults
        , HAUserAnswers.UOMCode
        , HAUserStarted.HAScore
        , HAUserModule.PreWeightedScore AS ModulePreWeightedScore
        , HARiskCategory.PreWeightedScore AS RiskCategoryPreWeightedScore
        , HAUserRiskArea.PreWeightedScore AS RiskAreaPreWeightedScore
        , HAUserQuestion.PreWeightedScore AS QuestionPreWeightedScore
        , HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName

          --, CASE
          --	 WHEN [HAUserAnswers].[ItemCreatedWhen] = [HAUserAnswers].[ItemModifiedWhen]
          --	 THEN 'I'
          --	 ELSE 'U'
          --  END AS [ChangeType]

        , COALESCE ( CT_CMS_User.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION , CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION) AS ChangeType

        , HAUserAnswers.ItemCreatedWhen
        , HAUserAnswers.ItemModifiedWhen
        , HAUserQuestion.IsProfessionallyCollected
        , HARiskCategory.ItemModifiedWhen AS HARiskCategory_ItemModifiedWhen
        , HAUserRiskArea.ItemModifiedWhen AS HAUserRiskArea_ItemModifiedWhen
        , HAUserQuestion.ItemModifiedWhen AS HAUserQuestion_ItemModifiedWhen
        , HAUserAnswers.ItemModifiedWhen AS HAUserAnswers_ItemModifiedWhen
        , HAUserStarted.HAPaperFlg
        , HAUserStarted.HATelephonicFlg
        , HAUserStarted.HAStartedMode
        , HAUserStarted.HACompletedMode
        , VHCJ.DocumentCulture AS DocumentCulture_VHCJ
        , HAQuestionsView.DocumentCulture AS DocumentCulture_HAQuestionsView
        , HAUserStarted.HACampaignNodeGUID AS CampaignNodeGUID
        , VHCJ.HACampaignID
        , CAST ( HASHBYTES ( 'sha1' ,
          ISNULL ( CAST ( HAUserStarted.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserStarted.UserID AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSUser.UserGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( UserSettings.HFitUserMpiNumber AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSSite.SiteGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountCD AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountName AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserStarted.HAStartedDt AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACompletedDt AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserModule.ItemID  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.CodeName  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.HAModuleNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.CodeName AS nvarchar (100)) ,
          '-') + ISNULL ( CAST ( HAUserRiskArea.HARiskAreaNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemID AS nvarchar (100)) , '-') + ISNULL ( LEFT ( HAQuestionsView.Title , 1000) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserQuestion.CodeName  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.HAAnswerNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.HAAnswerValue AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.HAModuleScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryScore AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserRiskArea.HARiskAreaScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionScore AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.HAAnswerPoints AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestionGroupResults.PointResults AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserAnswers.UOMCode AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.PreWeightedScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserRiskArea.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST
          ( HAUserQuestionGroupResults.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemCreatedWhen AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.IsProfessionallyCollected AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAPaperFlg AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HATelephonicFlg AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserStarted.HAStartedMode AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACompletedMode AS nvarchar (100)) , '-') + ISNULL ( CAST
          ( HAUserStarted.HACampaignNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHCJ.HACampaignID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-')) AS varchar (100)) AS HashCode
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS varchar (50)) , '-') + ISNULL ( CAST ( UserGUID AS varchar (50)) , '-') + ISNULL ( CAST ( SiteGUID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.AccountID AS varchar (50)) , '-') + ISNULL ( CAST ( AccountCD AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserModule.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAModuleNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategoryNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategory.CodeName AS varchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskAreaNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserRiskArea.CodeName AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.CodeName AS varchar (50)) , '-') + ISNULL ( CAST ( HAQuestionNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAAnswerNodeGUID   AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserStarted.HACampaignNodeGUID AS varchar (50)) , '-')) AS varchar (100)) AS PKHashCode
        , COALESCE ( CT_CMS_User.UserID , CT_CMS_UserSettings.UserSettingsID , CT_CMS_Site.SiteID , CT_CMS_UserSite.UserSiteID , CT_HFit_Account.AccountID , CT_HFit_HealthAssesmentUserAnswers.ItemID , CT_HFit_HealthAssesmentUserModule.ItemID , CT_HFit_HealthAssesmentUserQuestion.ItemID , CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID , CT_HFit_HealthAssesmentUserRiskArea.ItemID , CT_HFit_HealthAssesmentUserRiskCategory.ItemID , CT_HFit_HealthAssesmentUserStarted.ItemID) AS CHANGED_FLG

/*---------------------------------------
***************************************
*****************************************
join changes to the records 
*****************************************
***************************************
*/

        , CT_CMS_User.UserID AS CT_CMS_User_UserID
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CT_CMS_User_CHANGE_OPERATION
        , CT_CMS_UserSettings.UserSettingsID AS CT_UserSettingsID
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CT_UserSettingsID_CHANGE_OPERATION
        , CT_CMS_Site.SiteID AS SiteID_CtID
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS SiteID_CHANGE_OPERATION
        , CT_CMS_UserSite.UserSiteID AS UserSiteID_CtID
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS UserSiteID_CHANGE_OPERATION
        , CT_HFit_Account.AccountID AS AccountID_CtID
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS AccountID__CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserAnswers.ItemID AS HAUserAnswers_CtID
        , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION AS HAUserAnswers_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserModule.ItemID AS HFit_HealthAssesmentUserModule_CtID
        , CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserQuestion.ItemID AS HFit_HealthAssesmentUserQuestion_CtID
        , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID AS HFit_HealthAssesmentUserQuestionGroupResults_CtID
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserRiskArea.ItemID AS HFit_HealthAssesmentUserRiskArea_CtID
        , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserRiskCategory.ItemID AS HFit_HealthAssesmentUserRiskCategory_CtID
        , CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserStarted.ItemID AS HFit_HealthAssesmentUserStarted_CtID
        , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserStarted_CHANGE_OPERATION

          --Get the TYPE of change ID NUMBER

        , CT_CMS_User.SYS_CHANGE_VERSION AS CT_CMS_User_SCV
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CT_CMS_UserSettings_SCV
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CT_CMS_Site_SCV
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CT_CMS_UserSite_SCV
        , CT_HFit_Account.SYS_CHANGE_VERSION AS CT_HFit_Account_SCV
        , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserAnswers_SCV
        , CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserModule_SCV
        , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserQuestion_SCV
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV
        , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserRiskArea_SCV
        , CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserRiskCategory_SCV
        , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserStarted_SCV
        , HAUserAnswers.ItemModifiedWhen AS LastModifiedDate
        , 0 AS DeleteFlg
        , CASE
              WHEN HAUserStarted.HADocumentConfigID IS NULL
                  THEN 'SHORT_VER'
              WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
                  THEN 'LONG_VER'
              ELSE 'UNKNOWN'
          END AS HealthAssessmentType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_HealthAssesmentUserStarted AS HAUserStarted
                    INNER JOIN dbo.CMS_User AS CMSUser
                    ON HAUserStarted.UserID = CMSUser.UserID
                    INNER JOIN dbo.CMS_UserSettings AS UserSettings
                    ON
                       UserSettings.UserSettingsUserID = CMSUser.UserID AND
                       HFitUserMpiNumber >= 0 AND
                       HFitUserMpiNumber IS NOT NULL
                    INNER JOIN dbo.CMS_UserSite AS UserSite
                    ON CMSUser.UserID = UserSite.UserID
                    INNER JOIN dbo.CMS_Site AS CMSSite
                    ON UserSite.SiteID = CMSSite.SiteID
                    INNER JOIN dbo.HFit_Account AS ACCT
                    ON ACCT.SiteID = CMSSite.SiteID
                    INNER JOIN dbo.HFit_HealthAssesmentUserModule AS HAUserModule
                    ON HAUserStarted.ItemID = HAUserModule.HAStartedItemID
                    INNER JOIN dbo.View_HFit_HACampaign_Joined AS VHCJ
                    ON
                       VHCJ.NodeGUID = HAUserStarted.HACampaignNodeGUID AND
                       VHCJ.NodeSiteID = UserSite.SiteID AND
                       VHCJ.DocumentCulture = 'en-US'
                    INNER JOIN dbo.View_HFit_HealthAssessment_Joined AS VHAJ
                    ON VHAJ.DocumentID = VHCJ.HealthAssessmentID
                    INNER JOIN dbo.HFit_HealthAssesmentUserRiskCategory AS HARiskCategory
                    ON HAUserModule.ItemID = HARiskCategory.HAModuleItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
                    ON HARiskCategory.ItemID = HAUserRiskArea.HARiskCategoryItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserQuestion AS HAUserQuestion
                    ON HAUserRiskArea.ItemID = HAUserQuestion.HARiskAreaItemID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS HAQuestionsView
                    ON
                       HAUserQuestion.HAQuestionNodeGUID = HAQuestionsView.NodeGUID AND
                       HAQuestionsView.DocumentCulture = 'en-US'
                    LEFT OUTER JOIN dbo.HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
                    ON HAUserRiskArea.ItemID = HAUserQuestionGroupResults.HARiskAreaItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserAnswers AS HAUserAnswers
                    ON HAUserQuestion.ItemID = HAUserAnswers.HAQuestionItemID

/*-----------------------------
*****************************
Add in the change tracking data
*****************************
*/
                    LEFT JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON UserSettings.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT JOIN CHANGETABLE (CHANGES CMS_User , NULL) AS CT_CMS_User
                    ON CMSUser.UserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CMSSite.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON UserSite.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON ACCT.AccountID = CT_HFit_Account.AccountID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HACampaign , NULL) AS CT_HFit_HACampaign
                    ON VHCJ.HACampaignID = CT_HFit_HACampaign.HACampaignID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserAnswers , NULL) AS CT_HFit_HealthAssesmentUserAnswers
                    ON HAUserAnswers.ItemID = CT_HFit_HealthAssesmentUserAnswers.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserModule , NULL) AS CT_HFit_HealthAssesmentUserModule
                    ON HAUserModule.ItemID = CT_HFit_HealthAssesmentUserModule.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestion , NULL) AS CT_HFit_HealthAssesmentUserQuestion
                    ON HAUserQuestion.ItemID = CT_HFit_HealthAssesmentUserQuestion.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults , NULL) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                    ON HAUserQuestionGroupResults.ItemID = CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea , NULL) AS CT_HFit_HealthAssesmentUserRiskArea
                    ON HAUserRiskArea.ItemID = CT_HFit_HealthAssesmentUserRiskArea.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskCategory , NULL) AS CT_HFit_HealthAssesmentUserRiskCategory
                    ON HARiskCategory.ItemID = CT_HFit_HealthAssesmentUserRiskCategory.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted , NULL) AS CT_HFit_HealthAssesmentUserStarted
                    ON HAUserStarted.ItemID = CT_HFit_HealthAssesmentUserStarted.ItemID
          WHERE UserSettings.HFitUserMpiNumber NOT IN (
          SELECT
                 RejectMPICode
                 FROM HFit_LKP_EDW_RejectMPI) ;
GO

PRINT 'Processed view_EDW_HealthAssesment_CT';

GO

PRINT ' FROM view_EDW_HealthAssesment_CT.sql';

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_HealthAssesmentDefinition_CT.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1


GO
PRINT 'Processing: view_EDW_HealthAssessmentDefinition_CT ' + CAST (GETDATE () AS nvarchar (50)) ;
GO

/*
select count(*), HashCode 
from view_EDW_HealthAssessmentDefinition_CT
group by HashCode 
having count(*) > 1

select * from view_EDW_HealthAssessmentDefinition_CT
select top 100 lastModifiedDate,* from view_EDW_HealthAssessmentDefinition_CT
select count(*) from view_EDW_HealthAssessmentDefinition_CT
select count(*) from view_EDW_HealthAssessmentDefinition_CT
--RCDocPubVerID
Select * from HFit_HealthAssesmentMultipleChoiceQuestion where HealthAssesmentMultipleChoiceQuestionID = 495
update HFit_HealthAssesmentMultipleChoiceQuestion set AllowMultiSelect = -1  where HealthAssesmentMultipleChoiceQuestionID = 495
update HFit_HealthAssesmentMultipleChoiceQuestion set AllowMultiSelect = 0  where HealthAssesmentMultipleChoiceQuestionID = 495

select * 
into STAGED_EDW_HealthAssessmentDefinition
from view_EDW_HealthAssessmentDefinition_CT
where
CHANGED_FLG IS NOT NULL

PK: SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID

select count(*) SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID 
from view_EDW_HealthAssessmentDefinition_CT
group by SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID
having count(*)  >1

*/

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
             WHERE TABLE_NAME = 'view_EDW_HealthAssessmentDefinition_CT') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessmentDefinition_CT;
    END;
GO

/*
select * 
into Staging_EDW_HealthAssesmentDeffinition
from view_EDW_HealthAssessmentDefinition_CT
select * from Staging_EDW_HealthAssesmentDeffinition
*/

--**************************************************************************************************************
--NOTE: The column DocumentModifiedWhen comes from the CMS_TREE join - it was left 
--		unchanged when other dates added for the Last Mod Date additions. 
--		Therefore, the 'ChangeType' was left dependent upon this date only. 09.12.2014 (wdm)
--*****************************************************************************************************************************************************
--Test Queries:
--select * from view_EDW_HealthAssessmentDefinition_CT where AnsDocumentGuid is not NULL
--Changes:
--WDM - 6/25/2014
--Query was returning a NULL dataset. Found that it is being caused by the AccountCD join.
--Worked with Shane to discover the CMS Tree had been modified.
--Modified the code so that reads it reads the CMS tree correctly - working.
--7/14/2014 1:29 time to run - 79024 rows - DEV
--7/14/2014 0:58 time to run - 57472 rows - PROD1
--7/15/2014 - Query was returning NodeName of 'Campaigns' only
--	Found the issue in view View_HFit_HACampaign_Joined. Documented the change in the view.
--7/16/2014 - Full Select: Using a DocumentModifiedWhen filter 00:17:28 - Record Cnt: 793,520
--8/7/2014 - Executed in DEV with GUID changes and returned 1.13M Rows in 23:14.
--8/8/2014 - Executed in DEV with GUID changes, new views, and returned 1.13M Rows in 20:16.
--8/8/2014 - Generated corrected view in DEV
--8/12/2014 - John C. explained that Account Code and Site Guid are not needed, NULLED
--				them out. With them in the QRY, returned 43104 rows, with them nulled
--				out, returned 43104 rows. Using a DISTINCT, 28736 rows returned and execution
--				time doubled approximately.
--				Has to add a DISTINCT to all the queries - .
--				Original Query 0:25 @ 43104
--				Original Query 0:46 @ 28736 (distinct)
--				Filter added - VHFHAQ.DocumentCulture 0:22 @ 14368
--				Filter added - and VHFHARCJ.DocumentCulture = 'en-us'	 0:06 @ 3568
--				Filter added - and VHFHARAJ.DocumentCulture = 'en-us'	 0:03 @ 1784
--8/12/2014 - Applied the language filters with John C. and performance improved, as expected,
--				such that when running the view in QA: 
--8/12/2014 - select * from [view_EDW_HealthAssessmentDefinition_CT] where DocumentModifiedWhen between '2000-11-14' and 
--				'2014-11-15' now runs exceptionally fast
--08/12/2014 - ProdStaging 00:21:52 @ 2442
--08/12/2014 - ProdStaging 00:21:09 @ 13272 (UNION ALL   --UNION)
--08/12/2014 - ProdStaging 00:21:37 @ 13272 (UNION ONLY)
--08/12/2014 - ProdStaging 00:06:26 @ 1582 (UNION ONLY & Select Filters Added for Culture)
--08/12/2014 - ProdStaging 00:10:07 @ 6636 (UNION ALL   --UNION) and all selected
--08/12/2014 - ProdStaging added PI PI_View_CMS_Tree_Joined_Regular_DocumentCulture: 00:2:34 @ 6636 
--08/12/2014 - DEV 00:00:58 @ 3792
--09.11.2014 - (wdm) added the needed date fields to help EDW in determining the last mod date of a row.
--10.01.2014 - Dale and Mark reworked this view to use NodeGUIDS and eliminated the CMS_TREE View from participating as 
--				well as Site and Account data
--11.25.2014 - (wdm) added multi-select column capability. The values can be 0,1, NULL
--12.29.2014 - (wdm) Added HTML stripping to two columns #47619, the others mentioned already had stripping applied
--12.31.2014 - (wdm) Started the review to apply CR-47517: Eliminate Matrix Questions with NULL Answer GUID's
--01.07.2014 - (wdm) 47619 The Health Assessment Definition interface view contains HTML tags - corrected with udf_StripHTML
--************************************************************************************************************************************************************
CREATE VIEW dbo.view_EDW_HealthAssessmentDefinition_CT
AS SELECT DISTINCT

          NULL AS SiteGUID --cs.SiteGUID								--WDM 08.12.2014 per John C.
        , NULL AS AccountCD	 --, HFA.AccountCD						--WDM 08.07.2014 per John C.
        , HA.NodeID AS HANodeID										--WDM 08.07.2014
        , HA.NodeName AS HANodeName									--WDM 08.07.2014
          --, HA.DocumentID AS HADocumentID								--WDM 08.07.2014 commented out and left in place for history
        , NULL AS HADocumentID										--WDM 08.07.2014; 09.29.2014: Mark and Dale discussed that NODEGUID should be used such that the multi-language/culture is not a problem.
        , HA.NodeSiteID AS HANodeSiteID								--WDM 08.07.2014
        , HA.DocumentPublishedVersionHistoryID AS HADocPubVerID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) AS ModTitle              --WDM 47619
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText              --WDM 47619
        , VHFHAMJ.NodeGuid AS ModDocGuid	--, VHFHAMJ.DocumentID AS ModDocID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHAMJ.Weight AS ModWeight
        , VHFHAMJ.IsEnabled AS ModIsEnabled
        , VHFHAMJ.CodeName AS ModCodeName
        , VHFHAMJ.DocumentPublishedVersionHistoryID AS ModDocPubVerID
        , dbo.udf_StripHTML (VHFHARCJ.Title) AS RCTitle              --WDM 47619
        , VHFHARCJ.Weight AS RCWeight
        , VHFHARCJ.NodeGuid AS RCDocumentGUID	--, VHFHARCJ.DocumentID AS RCDocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHARCJ.IsEnabled AS RCIsEnabled
        , VHFHARCJ.CodeName AS RCCodeName
        , VHFHARCJ.DocumentPublishedVersionHistoryID AS RCDocPubVerID
        , dbo.udf_StripHTML (VHFHARAJ.Title) AS RATytle              --WDM 47619
        , VHFHARAJ.Weight AS RAWeight
        , VHFHARAJ.NodeGuid AS RADocumentGuid	--, VHFHARAJ.DocumentID AS RADocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHARAJ.IsEnabled AS RAIsEnabled
        , VHFHARAJ.CodeName AS RACodeName
        , VHFHARAJ.ScoringStrategyID AS RAScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID AS RADocPubVerID
        , VHFHAQ.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ.Title, 4000)) AS QuesTitle              --WDM 47619
        , VHFHAQ.Weight AS QuesWeight
        , VHFHAQ.IsRequired AS QuesIsRequired

          --, VHFHAQ.DocumentGuid AS QuesDocumentGuid	--, VHFHAQ.DocumentID AS QuesDocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHAQ.NodeGuid AS QuesDocumentGuid	--, VHFHAQ.DocumentID AS QuesDocumentID	--WDM 08.07.2014

        , VHFHAQ.IsEnabled AS QuesIsEnabled
        , LEFT (VHFHAQ.IsVisible, 4000) AS QuesIsVisible
        , VHFHAQ.IsStaging AS QuesIsSTaging
        , VHFHAQ.CodeName AS QuestionCodeName
        , VHFHAQ.DocumentPublishedVersionHistoryID AS QuesDocPubVerID
        , VHFHAA.Value AS AnsValue
        , VHFHAA.Points AS AnsPoints
        , VHFHAA.NodeGuid AS AnsDocumentGuid		--ref: #47517
        , VHFHAA.IsEnabled AS AnsIsEnabled
        , VHFHAA.CodeName AS AnsCodeName
        , VHFHAA.UOM AS AnsUOM
        , VHFHAA.DocumentPublishedVersionHistoryID AS AnsDocPUbVerID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014 ADDED TO the returned Columns
        , HA.NodeGUID AS HANodeGUID
          --, NULL as SiteLastModified
        , NULL AS SiteLastModified
          --, NULL as Account_ItemModifiedWhen
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID01' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ.CodeName, '-') + ISNULL (CAST (VHFHAQ.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA.CodeName , '-') + ISNULL (CAST (VHFHAA.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID01' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ.IsVisible, 1000) , '-') 
          ) AS HashCode

          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US'

/*
		  --** ADD THE CHANGE TRACKING Tables
		  */

                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHARAJ.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'		--WDM 08.12.2014	
       AND VHFHAA.NodeGuid IS NOT NULL		--ref: #47517

   UNION ALL   --UNION
   --WDM Retrieve Matrix Level 1 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title)              --WDM 47619
        , dbo.udf_StripHTML (LEFT (LEFT (VHFHAMJ.IntroText, 4000) , 4000)) AS IntroText              --WDM 47619
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title)              --WDM 47619
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title)              --WDM 47619
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ2.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ2.Title, 4000)) AS QuesTitle              --WDM 47619
        , VHFHAQ2.Weight
        , VHFHAQ2.IsRequired
        , VHFHAQ2.NodeGuid
        , VHFHAQ2.IsEnabled
        , LEFT (VHFHAQ2.IsVisible, 4000) 
        , VHFHAQ2.IsStaging
        , VHFHAQ2.CodeName AS QuestionCodeName
          --,VHFHAQ2.NodeAliasPath
        , VHFHAQ2.DocumentPublishedVersionHistoryID
        , VHFHAA2.Value
        , VHFHAA2.Points
        , VHFHAA2.NodeGuid		--ref: #47517
        , VHFHAA2.IsEnabled
        , VHFHAA2.CodeName
        , VHFHAA2.UOM
          --,VHFHAA2.NodeAliasPath
        , VHFHAA2.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID02' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ2.CodeName, '-') + ISNULL (CAST (VHFHAQ2.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA2.CodeName , '-') + ISNULL (CAST (VHFHAA2.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID02' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ2.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ2.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2
                      ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2
                      ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA2.NodeGuid IS NOT NULL		--ref: #47517

   UNION ALL   --UNION
   --WDM Retrieve Branching Level 1 Question and Matrix Level 1 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ3.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ3.Title, 4000)) AS QuesTitle
        , VHFHAQ3.Weight
        , VHFHAQ3.IsRequired
        , VHFHAQ3.NodeGuid
        , VHFHAQ3.IsEnabled
        , LEFT (VHFHAQ3.IsVisible, 4000) 
        , VHFHAQ3.IsStaging
        , VHFHAQ3.CodeName AS QuestionCodeName
          --,VHFHAQ3.NodeAliasPath
        , VHFHAQ3.DocumentPublishedVersionHistoryID
        , VHFHAA3.Value
        , VHFHAA3.Points
        , VHFHAA3.NodeGuid		--ref: #47517
        , VHFHAA3.IsEnabled
        , VHFHAA3.CodeName
        , VHFHAA3.UOM
          --,VHFHAA3.NodeAliasPath
        , VHFHAA3.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID03' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ3.CodeName, '-') + ISNULL (CAST (VHFHAQ3.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA3.CodeName , '-') + ISNULL (CAST (VHFHAA3.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID03' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ3.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ3.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA3.NodeGuid IS NOT NULL		--ref: #47517
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM Retrieve Branching Level 1 Question and Matrix Level 2 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ7.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ7.Title, 4000)) AS QuesTitle
        , VHFHAQ7.Weight
        , VHFHAQ7.IsRequired
        , VHFHAQ7.NodeGuid
        , VHFHAQ7.IsEnabled
        , LEFT (VHFHAQ7.IsVisible, 4000) 
        , VHFHAQ7.IsStaging
        , VHFHAQ7.CodeName AS QuestionCodeName
          --,VHFHAQ7.NodeAliasPath
        , VHFHAQ7.DocumentPublishedVersionHistoryID
        , VHFHAA7.Value
        , VHFHAA7.Points
        , VHFHAA7.NodeGuid		--ref: #47517
        , VHFHAA7.IsEnabled
        , VHFHAA7.CodeName
        , VHFHAA7.UOM
          --,VHFHAA7.NodeAliasPath
        , VHFHAA7.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID04' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ7.CodeName, '-') + ISNULL (CAST (VHFHAQ7.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA7.CodeName , '-') + ISNULL (CAST (VHFHAA7.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID04' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ7.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ7.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID --LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3 ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID

              --Matrix Level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7
                      ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7
                      ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA7.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************

   UNION ALL   --UNION
   --****************************************************
   --WDM 6/25/2014 Retrieve the Branching level 1 Question Group
   --THE PROBLEM LIES HERE in this part of query : 1:40 minute
   -- Added two perf indexes to the first query: 25 Sec
   --****************************************************
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ8.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ8.Title, 4000)) AS QuesTitle
        , VHFHAQ8.Weight
        , VHFHAQ8.IsRequired
        , VHFHAQ8.NodeGuid
        , VHFHAQ8.IsEnabled
        , LEFT (VHFHAQ8.IsVisible, 4000) 
        , VHFHAQ8.IsStaging
        , VHFHAQ8.CodeName AS QuestionCodeName
          --,VHFHAQ8.NodeAliasPath
        , VHFHAQ8.DocumentPublishedVersionHistoryID
        , VHFHAA8.Value
        , VHFHAA8.Points
        , VHFHAA8.NodeGuid		--ref: #47517
        , VHFHAA8.IsEnabled
        , VHFHAA8.CodeName
        , VHFHAA8.UOM
          --,VHFHAA8.NodeAliasPath
        , VHFHAA8.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID05' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ8.CodeName, '-') + ISNULL (CAST (VHFHAQ8.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA8.CodeName , '-') + ISNULL (CAST (VHFHAA8.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID05' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ8.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ8.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************	

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID --LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3 ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID

              --Matrix Level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7
                      ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7
                      ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID --Matrix branching level 1 question group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8
                      ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8
                      ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA8.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************

   UNION ALL   --UNION
   --****************************************************
   --WDM 6/25/2014 Retrieve the Branching level 2 Question Group
   --THE PROBLEM LIES HERE in this part of query : 1:48  minutes
   --With the new indexes: 29 Secs
   --****************************************************
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ4.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ4.Title, 4000)) AS QuesTitle
        , VHFHAQ4.Weight
        , VHFHAQ4.IsRequired
        , VHFHAQ4.NodeGuid
        , VHFHAQ4.IsEnabled
        , LEFT (VHFHAQ4.IsVisible, 4000) 
        , VHFHAQ4.IsStaging
        , VHFHAQ4.CodeName AS QuestionCodeName
          --,VHFHAQ4.NodeAliasPath
        , VHFHAQ4.DocumentPublishedVersionHistoryID
        , VHFHAA4.Value
        , VHFHAA4.Points
        , VHFHAA4.NodeGuid		--ref: #47517
        , VHFHAA4.IsEnabled
        , VHFHAA4.CodeName
        , VHFHAA4.UOM
          --,VHFHAA4.NodeAliasPath
        , VHFHAA4.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID06' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ4.CodeName, '-') + ISNULL (CAST (VHFHAQ4.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA4.CodeName , '-') + ISNULL (CAST (VHFHAA4.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID06' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ4.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ4.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA4.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 3 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ5.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ5.Title, 4000)) AS QuesTitle
        , VHFHAQ5.Weight
        , VHFHAQ5.IsRequired
        , VHFHAQ5.NodeGuid
        , VHFHAQ5.IsEnabled
        , LEFT (VHFHAQ5.IsVisible, 4000) 
        , VHFHAQ5.IsStaging
        , VHFHAQ5.CodeName AS QuestionCodeName
          --,VHFHAQ5.NodeAliasPath
        , VHFHAQ5.DocumentPublishedVersionHistoryID
        , VHFHAA5.Value
        , VHFHAA5.Points
        , VHFHAA5.NodeGuid		--ref: #47517
        , VHFHAA5.IsEnabled
        , VHFHAA5.CodeName
        , VHFHAA5.UOM
          --,VHFHAA5.NodeAliasPath
        , VHFHAA5.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID07' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ5.CodeName, '-') + ISNULL (CAST (VHFHAQ5.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA5.CodeName , '-') + ISNULL (CAST (VHFHAA5.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID07' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ5.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ5.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA5.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 4 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ6.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ6.Title, 4000)) AS QuesTitle
        , VHFHAQ6.Weight
        , VHFHAQ6.IsRequired
        , VHFHAQ6.NodeGuid
        , VHFHAQ6.IsEnabled
        , LEFT (VHFHAQ6.IsVisible, 4000) 
        , VHFHAQ6.IsStaging
        , VHFHAQ6.CodeName AS QuestionCodeName
          --,VHFHAQ6.NodeAliasPath
        , VHFHAQ6.DocumentPublishedVersionHistoryID
        , VHFHAA6.Value
        , VHFHAA6.Points
        , VHFHAA6.NodeGuid		--ref: #47517
        , VHFHAA6.IsEnabled
        , VHFHAA6.CodeName
        , VHFHAA6.UOM
          --,VHFHAA6.NodeAliasPath
        , VHFHAA6.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID08' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ6.CodeName, '-') + ISNULL (CAST (VHFHAQ6.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA6.CodeName , '-') + ISNULL (CAST (VHFHAA6.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID08' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ6.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ6.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
              --select count(*) from dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID --Branching level 4 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ6
                      ON VHFHAA5.NodeID = VHFHAQ6.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA6
                      ON VHFHAQ6.NodeID = VHFHAA6.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE  VHFHAQ.DocumentCulture = 'en-us'
        AND (VHFHAA.DocumentCulture = 'en-us'
          OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
        AND VHFHARCJ.DocumentCulture = 'en-us'
        AND VHFHARAJ.DocumentCulture = 'en-us'
        AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
        AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
        AND VHFHAA6.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 5 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ9.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ9.Title, 4000)) AS QuesTitle
        , VHFHAQ9.Weight
        , VHFHAQ9.IsRequired
        , VHFHAQ9.NodeGuid
        , VHFHAQ9.IsEnabled
        , LEFT (VHFHAQ9.IsVisible, 4000) 
        , VHFHAQ9.IsStaging
        , VHFHAQ9.CodeName AS QuestionCodeName
          --,VHFHAQ9.NodeAliasPath
        , VHFHAQ9.DocumentPublishedVersionHistoryID
        , VHFHAA9.Value
        , VHFHAA9.Points
        , VHFHAA9.NodeGuid		--ref: #47517
        , VHFHAA9.IsEnabled
        , VHFHAA9.CodeName
        , VHFHAA9.UOM
          --,VHFHAA9.NodeAliasPath
        , VHFHAA9.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID09' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ.CodeName, '-') + ISNULL (CAST (VHFHAQ.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA.CodeName , '-') + ISNULL (CAST (VHFHAA.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID09' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
              --select count(*) from dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID --Branching level 4 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ6
                      ON VHFHAA5.NodeID = VHFHAQ6.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA6
                      ON VHFHAQ6.NodeID = VHFHAA6.NodeParentID --Branching level 5 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ9
                      ON VHFHAA6.NodeID = VHFHAQ9.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA9
                      ON VHFHAQ9.NodeID = VHFHAA9.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE  VHFHAQ.DocumentCulture = 'en-us'
        AND (VHFHAA.DocumentCulture = 'en-us'
          OR VHFHAA.DocumentCulture IS NULL) 
        AND VHFHARCJ.DocumentCulture = 'en-us'
        AND VHFHARAJ.DocumentCulture = 'en-us'
        AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
        AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
        AND VHFHAA9.NodeGuid IS NOT NULL;		--ref: #47517
--********************************************
--AND (
--    CT_CMS_Class.ClassID IS NOT NULL
-- OR CT_CMS_Document.DocumentID IS NOT NULL
-- OR CT_CMS_Site.SiteID IS NOT NULL
-- OR CT_CMS_Tree.NodeID IS NOT NULL
-- OR CT_CMS_User.UserID IS NOT NULL
-- OR CT_COM_SKU.SKUID IS NOT NULL
-- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
-- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
-- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
-- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
-- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
-- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
-- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
-- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
--    );

GO

PRINT 'Processed: view_EDW_HealthAssessmentDefinition_CT ';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthAssessmentDefinition_CT.sql';
GO

--select * 
--into STAGED_EDW_HealthAssessmentDefinition
--from view_EDW_HealthAssessmentDefinition_CT
--go--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_HealthInterestDetail_CT.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1


GO 
print('***** FROM: view_EDW_HealthInterestDetail_CT.sql'); 
GO 
print ('Creating view_EDW_HealthInterestDetail_CT');
GO
--select count(*) from view_EDW_HealthInterestDetail
--select TOP 100 * from view_EDW_HealthInterestDetail_CT order by HashCode
if exists(select name from sys.views where name = 'view_EDW_HealthInterestDetail_CT')
BEGIN 
	drop view view_EDW_HealthInterestDetail_CT ;
END
go

/*  {Potential Natural Key}
select count(*), UserID,UserGUID,HFitUserMpiNumber,SiteGUID,CoachingHealthInterestID,FirstNodeID,SecondNodeGuid,ThirdNodeGuid
from 
view_EDW_HealthInterestDetail_CT
group by UserID,UserGUID,HFitUserMpiNumber,SiteGUID,CoachingHealthInterestID,FirstNodeID,SecondNodeGuid,ThirdNodeGuid
having Count(*) > 1
*/


CREATE VIEW [dbo].[view_EDW_HealthInterestDetail_CT]
AS
	SELECT
		HI.UserID
		,U.UserGUID
		,US.HFitUserMpiNumber
		,S.SiteGUID
		,HI.CoachingHealthInterestID

		,HA1.CoachingHealthAreaID AS FirstHealthAreaID
		,HA1.NodeID AS FirstNodeID
		,HA1.NodeGuid AS FirstNodeGuid
		,HA1.DocumentName AS FirstHealthAreaName
		,HA1.HealthAreaDescription AS FirstHealthAreaDescription
		,HA1.CodeName AS FirstCodeName
	
		,HA2.CoachingHealthAreaID AS SecondHealthAreaID
		,HA2.NodeID AS SecondNodeID
		,HA2.NodeGuid AS SecondNodeGuid
		,HA2.DocumentName AS SecondHealthAreaName
		,HA2.HealthAreaDescription AS SecondHealthAreaDescription
		,HA2.CodeName AS SecondCodeName
	
		,HA3.CoachingHealthAreaID AS ThirdHealthAreaID
		,HA3.NodeID AS ThirdNodeID
		,HA3.NodeGuid AS ThirdNodeGuid
		,HA3.DocumentName AS ThirdHealthAreaName
		,HA3.HealthAreaDescription AS ThirdHealthAreaDescription
		,HA3.CodeName AS ThirdCodeName

		,HI.ItemCreatedWhen
		,HI.ItemModifiedWhen
		,coalesce(HI.IsDeleted,0) as IsDeleted
		, HASHBYTES ('sha1',
				    isNull(HA1.DocumentName,'-')
				    + isNull(left(HA1.HealthAreaDescription,1000),'-')
				    + isNull(HA1.CodeName,'-')
				    + isNull(HA2.DocumentName,'-')
				    + isNull(left(HA2.HealthAreaDescription,1000),'-')
				    + isNull(HA2.CodeName,'-')
				    + isNull(HA3.DocumentName,'-')
				    + isNull(left(HA3.HealthAreaDescription,1000),'-')
				    + isNull(HA3.CodeName,'-')
		  ) as HashCode		  
	, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
		HFit_CoachingHealthInterest AS HI
		JOIN CMS_User AS U ON HI.UserID = U.UserID
		JOIN CMS_UserSettings AS US ON HI.UserID = US.UserSettingsUserID
		JOIN CMS_UserSite AS US1 ON HI.UserID = US1.UserID
		JOIN CMS_Site AS S ON US1.SiteID = S.SiteID	 --Used only to find SiteGuid
		LEFT JOIN View_HFit_CoachingHealthArea_Joined AS HA1 ON HI.FirstInterest = HA1.NodeID
			AND HA1.DocumentCulture = 'en-us'
		LEFT JOIN View_HFit_CoachingHealthArea_Joined AS HA2 ON HI.SecondInterest = HA2.NodeID	
			AND HA2.DocumentCulture = 'en-us'
		LEFT JOIN View_HFit_CoachingHealthArea_Joined AS HA3 ON HI.ThirdInterest = HA3.NodeID
			AND HA3.DocumentCulture = 'en-us'
GO

print ('Created view_EDW_HealthInterestDetail_CT');
GO


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_HealthInterestDetail_STAGED.sql" \n 
--------------------------------------------------------------- 
GO
PRINT 'Creating view_EDW_HealthInterestDetail_STAGED';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE name = 'view_EDW_HealthInterestDetail_STAGED') 
    BEGIN
        DROP VIEW
             view_EDW_HealthInterestDetail_STAGED;
    END;
GO

/*
STAGING_EDW_HealthInterestDetail
select count(*) from view_EDW_HealthInterestDetail_STAGED

select count(*),  HealthAreaID
		,NodeID
		,NodeGuid
		,AccountCD
from view_EDW_HealthInterestDetail_STAGED
group by HealthAreaID
		,NodeID
		,NodeGuid
		,AccountCD
having count(*) > 1
*/

CREATE VIEW dbo.view_EDW_HealthInterestDetail_STAGED
AS SELECT
          UserID
        , UserGUID
        , HFitUserMpiNumber
        , SiteGUID
        , CoachingHealthInterestID
        , FirstHealthAreaID
        , FirstNodeID
        , FirstNodeGuid
        , FirstHealthAreaName
        , FirstHealthAreaDescription
        , FirstCodeName
        , SecondHealthAreaID
        , SecondNodeID
        , SecondNodeGuid
        , SecondHealthAreaName
        , SecondHealthAreaDescription
        , SecondCodeName
        , ThirdHealthAreaID
        , ThirdNodeID
        , ThirdNodeGuid
        , ThirdHealthAreaName
        , ThirdHealthAreaDescription
        , ThirdCodeName
        , ItemCreatedWhen
        , ItemModifiedWhen
          FROM STAGING_EDW_HealthInterestDetail;

GO
PRINT 'Created view_EDW_HealthInterestDetail_STAGED';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthInterestDetail_STAGED.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_STAGING_EDW_HealthInterestDetail.sql \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO

/*---------------------------------------------------------------------------------------------------------------------------
{Potential Natural Key}
select count(*), UserID,UserGUID,HFitUserMpiNumber,SiteGUID,CoachingHealthInterestID,FirstNodeID,SecondNodeGuid,ThirdNodeGuid
from 
view_EDW_HealthInterestDetail_CT
group by UserID,UserGUID,HFitUserMpiNumber,SiteGUID,CoachingHealthInterestID,FirstNodeID,SecondNodeGuid,ThirdNodeGuid
having Count(*) > 1

exec proc_EDW_HealthInterestDetail 1
exec proc_EDW_HealthInterestDetail 0
*/

GO
PRINT 'creating proc_EDW_HealthInterestDetail';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_HealthInterestDetail') 
    BEGIN
        PRINT 'Replacing proc_EDW_HealthInterestDetail';
        DROP PROCEDURE
             proc_EDW_HealthInterestDetail;
    END;

GO

CREATE PROCEDURE proc_EDW_HealthInterestDetail (
       @ReloadAll AS int = 0) 
AS
BEGIN
    BEGIN
        SET NOCOUNT ON;

        DECLARE
        @iTotal AS bigint = 0;

        EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_HealthInterestDetail';

        IF @iTotal <= 1
            BEGIN
                SET @Reloadall = 1;
            END;

        DECLARE
        @RecordID AS uniqueidentifier = NEWID () ;
        DECLARE
        @CT_DateTimeNow AS datetime = GETDATE () ;
        DECLARE
        @CT_NAME AS nvarchar ( 50) = 'proc_EDW_HealthInterestDetail';
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'I';
        IF @ReloadAll = 1
            BEGIN
                PRINT 'RELOADING ALL EDW_HealthInterestDetail records';
                DROP TABLE
                     DIM_EDW_HealthInterestDetail;
            END;
        IF
        @ReloadAll = 0 OR
        @ReloadAll IS NULL
            BEGIN
                PRINT 'RELOADING only changed EDW_HealthInterestDetail records';
            END;

        IF NOT EXISTS ( SELECT
                               name
                               FROM sys.tables
                               WHERE name = 'DIM_EDW_HealthInterestDetail') 
            BEGIN
                SELECT
                       * INTO
                              DIM_EDW_HealthInterestDetail
                       FROM view_EDW_HealthInterestDetail_CT;
                DECLARE
                @irecs AS int = @@ROWCOUNT;
                PRINT 'RECORDS Loaded: ' + CAST ( @irecs AS nvarchar ( 50)) ;

                EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthInterestDetail';

                EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @irecs;
                EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @irecs , 'U';

                SET ANSI_PADDING ON;

                CREATE CLUSTERED INDEX PI_EDW_HealthInterestDetail ON dbo.DIM_EDW_HealthInterestDetail ( UserID , UserGUID , HFitUserMpiNumber , SiteGUID , CoachingHealthInterestID , FirstNodeID , SecondNodeGuid , ThirdNodeGuid) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                CREATE NONCLUSTERED INDEX PI_EDW_HealthInterestDetail_RowNbrCDate ON dbo.DIM_EDW_HealthInterestDetail ( LastModifiedDate , DeletedFlg) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestDetail';

                IF @ReloadAll = 1
                    BEGIN
                        RETURN;
                    END;
            END;

        IF EXISTS ( SELECT
                           table_name
                           FROM tempdb.information_schema.tables
                           WHERE table_name = '##Temp_HealthInterestDetail'
        ) 
            BEGIN
                PRINT 'Dropping ##Temp_HealthInterestDetail';
                DROP TABLE
                     ##Temp_HealthInterestDetail;
            END;

        SELECT
               * INTO
                      ##Temp_HealthInterestDetail
               FROM view_EDW_HealthInterestDetail_CT;

        EXEC proc_Add_EDW_CT_StdCols '##Temp_HealthInterestDetail';
        EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthInterestDetail';

        CREATE CLUSTERED INDEX PI_TEMP_EDW_HealthInterestDetail
        ON ##Temp_HealthInterestDetail
        ( UserID , UserGUID , HFitUserMpiNumber , SiteGUID , CoachingHealthInterestID , FirstNodeID , SecondNodeGuid , ThirdNodeGuid) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

        DECLARE
        @irecs2 AS int = @@ROWCOUNT;
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @irecs2 , 'U';

        --************************************************
        --	   get the NEW records and insert them
        --	   TEST: Truncate table DIM_EDW_HealthInterestDetail
        --************************************************
        --SET IDENTITY_INSERT DIM_EDW_HealthInterestDetail ON ;

        DECLARE
        @inew AS int = 0;
        EXEC @inew = proc_CT_HealthInterestDetail_AddNewRecs ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @inew;
        PRINT 'Records Added: ' + CAST ( @inew AS nvarchar (5)) ;

        --************************************************
        --get the changed records and update them
        --************************************************
        DECLARE
        @iupdate AS int = 0;
        EXEC @iupdate = proc_CT_HealthInterestDetail_AddUpdatedRecs ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iupdate;
        PRINT 'Records Updated: ' + CAST ( @iupdate AS nvarchar (5)) ;

        --************************************************
        --get the deleted records flag them
        --************************************************
        DECLARE
        @idel AS int = 0;
        EXEC @idel = proc_CT_HealthInterestDetail_AddDeletedRecs ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @idel;
        PRINT 'Records Marked As Deleted: ' + CAST ( @idel AS nvarchar (5)) ;

    END;

    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestDetail';
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @irecs , 'U';
    PRINT 'Created proc_EDW_HealthInterestDetail';
    PRINT GETDATE () ;
    SET NOCOUNT OFF;
--select top 100 * from DIM_EDW_HealthInterestDetail
END;

GO
PRINT 'CREATED proc_EDW_HealthInterestDetail';
PRINT GETDATE () ;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_HealthInterestList_CT.sql" \n 
--------------------------------------------------------------- 
go
-- use KenticoCMS_Prod1

GO
print('Creating view_EDW_HealthInterestList_CT'); 
GO

if exists(select name from sys.views where name = 'view_EDW_HealthInterestList_CT')
BEGIN 
	drop view view_EDW_HealthInterestList_CT ;
END
go

/*
select count(*) from view_EDW_HealthInterestList_CT

select count(*),  HealthAreaID
		,NodeID
		,NodeGuid
		,AccountCD
from view_EDW_HealthInterestList_CT
group by HealthAreaID
		,NodeID
		,NodeGuid
		,AccountCD
having count(*) > 1
*/
CREATE VIEW [dbo].[view_EDW_HealthInterestList_CT]
AS
	--12/03/2014 (wdm) this view was created by Chad Gurka and passed over to Team P to include into the build
	SELECT
		CHA.CoachingHealthAreaID AS HealthAreaID
		,CHA.NodeID
		,CHA.NodeGuid
		,A.AccountCD
		,CHA.NodeName AS HealthAreaName
		,CHA.HealthAreaDescription
		,CHA.CodeName
		,CHA.DocumentCreatedWhen
		,CHA.DocumentModifiedWhen
		   , HASHBYTES ('sha1',
				    isNull(CHA.NodeName,'-')
				    + isNull(CHA.CodeName,'-')
				    + isNull(cast(CHA.DocumentCreatedWhen as nvarchar(50)),'-')
				    + isNull(cast(CHA.DocumentModifiedWhen as nvarchar(50)),'-')
					+ isNull(left(CHA.HealthAreaDescription,1000),'-')
		  ) as HashCode		  
	, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
		View_HFit_CoachingHealthArea_Joined AS CHA
		JOIN HFit_Account AS A ON A.SiteID = CHA.NodeSiteID
	WHERE DocumentCulture = 'en-us'

GO
print('Created view_EDW_HealthInterestList_CT'); 
GO
  --  
  --  
GO 
print('***** FROM: view_EDW_HealthInterestList_CT.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_STAGING_EDW_HealthInterestList.sql \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'creating proc_EDW_HealthInterestList';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_HealthInterestList') 
    BEGIN
        PRINT 'UPDATING proc_EDW_HealthInterestList';
        DROP PROCEDURE
             proc_EDW_HealthInterestList;
    END;

GO

/*-------------------------------------------------------------
{Potential Natural Key}
select count(*) as CNT,  HealthAreaID,NodeID,NodeGuid,AccountCD
from 
view_EDW_HealthInterestList_CT
group by HealthAreaID,NodeID,NodeGuid,AccountCD
having Count(*) > 1

exec proc_EDW_HealthInterestList 0
exec proc_EDW_HealthInterestList 1
*/

CREATE PROCEDURE proc_EDW_HealthInterestList (
       @ReloadAll AS int = 0) 
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_HealthInterestList';

    IF @iTotal <= 1
        BEGIN
            SET @Reloadall = 1;
        END;

    --******************************************************************************************************************************
    -- This procedure is added to the job job_EDW_GetStagingData_RewardUserDetail and set to run automatically on a schedule.
    --******************************************************************************************************************************

    BEGIN

        IF @ReloadAll IS NULL
            BEGIN
                SET @ReloadAll = 0;
            END;

        DECLARE
        @RecordID AS uniqueidentifier = NEWID () ;
        DECLARE
        @CT_DateTimeNow AS datetime = GETDATE () ;
        DECLARE
        @CT_NAME AS nvarchar ( 50) = 'proc_EDW_HealthInterestList';
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'I';

        IF @ReloadAll = 1
            BEGIN
                PRINT 'RELOADING ALL EDW_HealthInterestList records';
                PRINT 'Droppoing table DIM_EDW_HealthInterestList';
                IF EXISTS ( SELECT
                                   name
                                   FROM sys.tables
                                   WHERE name = 'DIM_EDW_HealthInterestList') 
                    BEGIN
                        DROP TABLE
                             DIM_EDW_HealthInterestList;
                    END;
            END;

        DECLARE
        @iFound AS int = ( SELECT
                                  COUNT ( *) 
                                  FROM sys.tables
                                  WHERE name = 'DIM_EDW_HealthInterestList') ;

        PRINT '@iFound: ' + CAST ( @iFound AS nvarchar (50)) ;

        IF @iFound = 0
            BEGIN
                PRINT 'CREATING DIM_EDW_HealthInterestList';
                SELECT
                       * INTO
                              DIM_EDW_HealthInterestList
                       FROM view_EDW_HealthInterestList_CT;

                EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthInterestList';

                DECLARE
                @iReloadCnt AS int = @@ROWCOUNT;
                EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @iReloadCnt , 'U';
                EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iReloadCnt;
                --PRINT 'LOC 003';

                SET ANSI_PADDING ON;

                CREATE CLUSTERED INDEX PI_EDW_HealthInterestList ON dbo.DIM_EDW_HealthInterestList ( HealthAreaID , NodeID , NodeGuid , AccountCD) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                CREATE NONCLUSTERED INDEX PI_EDW_HealthInterestList_RowNbrCDate ON dbo.DIM_EDW_HealthInterestList ( RowNbr , LastModifiedDate , DeletedFlg) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                --PRINT 'LOC 004a';
                EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestList';
                SET NOCOUNT OFF;
                RETURN;
            END;

        IF EXISTS ( SELECT
                           table_name
                           FROM tempdb.information_schema.tables
                           WHERE table_name = '##Temp_HealthInterestList'
        ) 
            BEGIN
                PRINT 'Dropping ##Temp_HealthInterestList';
                DROP TABLE
                     ##Temp_HealthInterestList;
            END;

        SELECT
               * INTO
                      ##Temp_HealthInterestList
               FROM view_EDW_HealthInterestList_CT;

        EXEC proc_Add_EDW_CT_StdCols '##Temp_HealthInterestList';
        CREATE CLUSTERED INDEX PI_TEMP_EDW_HealthInterestList ON ##Temp_HealthInterestList ( HealthAreaID , NodeID , NodeGuid , AccountCD) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

        --************************************************
        --get the NEW records and insert them
        --************************************************
        DECLARE
        @iInserts AS int = 0;
        EXEC @iInserts = proc_CT_HealthInterestList_AddNewRecs ;
        PRINT 'NEW Records Added: ' + CAST ( @iInserts AS nvarchar (5)) ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iInserts;

        --************************************************
        --get the changed records and update them
        --************************************************

        DECLARE
        @iUpdates AS int = 0;
        EXEC @iUpdates = proc_CT_HealthInterestList_AddUpdatedRecs ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdates;

        PRINT 'Records Updated: ' + CAST ( @iUpdates AS nvarchar (5)) ;

        --************************************************
        --Mark deleted records
        --************************************************
        DECLARE
        @iDeletes AS int = @@ROWCOUNT;
        EXEC @iDeletes = proc_CT_HealthInterestList_AddDeletedRecs ;
        PRINT 'Records Marked As Deleted: ' + CAST ( @iDeletes AS nvarchar (5)) ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDeletes;
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @iReloadCnt , 'U';

    END;

    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestList';
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @iReloadCnt , 'U';
    PRINT 'Created proc_EDW_HealthInterestList';
    PRINT GETDATE () ;
    SET NOCOUNT OFF;
--select top 100 * from DIM_EDW_HealthInterestList
END;

GO
PRINT 'CREATED proc_EDW_HealthInterestList';
PRINT GETDATE () ;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: create_job_EDW_getStaging_RewardUserDetail.sql \n 
--------------------------------------------------------------- 

go
PRINT 'Creating JOB job_EDW_GetStagingData_RewardUserDetail' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_RewardUserDetail_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_EDW_RewardUserDetail]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_RewardUserDetail',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_RewardUserDetail; 
		  exec proc_EDW_HealthAssesmentClientView;
		  exec proc_EDW_HealthInterestDetail;
		  exec proc_EDW_HealthInterestList;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_RewardUserDetail',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_SmallStepResponses.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating view view_EDW_SmallStepResponses';
PRINT 'Generated FROM: view_EDW_SmallStepResponses.SQL';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_SmallStepResponses') 
    BEGIN
        PRINT 'VIEW view_EDW_SmallStepResponses, replacing.';
        DROP VIEW
             view_EDW_SmallStepResponses;
    END;
GO

CREATE VIEW dbo.view_EDW_SmallStepResponses
AS

--********************************************************************************************************
--IVP Version NO: 1.0
--02.13.2014 : (Sowmiya Venkiteswaran) : Updated the view to include  the fields:
--AccountCD, SiteGUID,SSOutcomeMessage as info. text,
-- Small Steps Program Info( HACampaignNodeGUID,HACampaignName,HACampaignStartDate,HACampaignEndDate)
-- HAUserStartedRecord Info (HAStartedDate,HACompletedDate,HAStartedMode,HACompletedMode)
-- Added filters by document culture and replacing HTML quote with a SQL single quote
--********************************************************************************************************
--02.23.2014 : (Dale Miller & Sowmiya V) : Performance tuning - removed the following WHERE clause and 
--			incorporated them into the JOIN statements for perfoamnce enhancement.
--			 WHERE vwOutcome.DocumentCulture = 'en-US' AND vwCamp.DocumentCulture = 'en-US';
--********************************************************************************************************
--02.23.2014 : (Dale Miller & Sowmiya V) : Performance tuning
--	Prod1, 2 and 3 Labs - Incorporated doc. culture to the Joins
-- 1 - executed DBCC dropcleanbuffers everytime
-- 2 - Tested REPLACE against No REPLACE, insignificant perf. hit.
-- Test Controls:
-- Prod1 Lab - NO SQL DISTINCT - 184311 ( rows) - 14 (seconds) 
-- Prod1 Lab - WITH SQL DISTINCT - 184311 ( rows) - 32 (seconds) 
-- Prod2 Lab - NO SQL DISTINCT -  81120( rows) -  10(seconds) 
-- Prod2 Lab - WITH SQL DISTINCT - 81120 ( rows) -  22(seconds) 
-- Prod3 Lab - NO SQL DISTINCT - 136763 ( rows) - 10 (seconds) 
-- Prod3 Lab - WITH SQL DISTINCT - 136763 ( rows) -  21(seconds)  
--02.24.2015 (SV) - Added column SSHealthAssesmentUserStartedItemID per request from John C.
--02.24.2015 (WDM) - Verified changes applied correctly from within the IVP
--02.24.2015 (WDM) - Verified changes are tracked from within the Schema Change Monitor
--02.24.2015 (WDM) - Add the view to the Data/View IVP
--03.02.2015 (WDM) - The view got out of sync most likely due to multiple users with CRUD capability.
--		Re-executed the master DDL.
--03.03.2015 (WDM/SV) - Added new columns HaCodeName and HFitUserMPINumber.
--03.04.2015 (WDM/SV) - Tested view and reviewed output - added DISTINCT and tuned for perf.
--03.04.2015 (WDM/Ashwin) - Ashwin started testing. Modified the JOIN for UserID - now returns expected MPI.
--03.04.2015 (WDM/Ashwin) - Ashwin certified the view as tested.
--04.06.2015 (WDM/JC) John found an error in the JOIN of user ID - changed to CMS_US.UserSettingsUserID = ss.UserID
--04.15.2015 (WDM/Shane) Found an issue with duplicate rows. Added the SiteID to the JOIN (eg.
--			  vwCamp.NodeSiteID = usrste.SiteID and moved the join down in the list.)
--04.16.2015 (WDM) completed CR-51962
--********************************************************************************************************

SELECT DISTINCT
       ss.UserID
     , acct.AccountCD
     , ste.SiteGUID
     , ss.ItemID AS SSItemID
     , ss.ItemCreatedBy AS SSItemCreatedBy
     , cast(ss.ItemCreatedWhen as datetime)  AS SSItemCreatedWhen
     , ss.ItemModifiedBy AS SSItemModifiedBy
     , cast(ss.ItemModifiedWhen  as datetime) AS SSItemModifiedWhen
     , ss.ItemOrder AS SSItemOrder
     , ss.ItemGUID AS SSItemGUID
     , ss.HealthAssesmentUserStartedItemID AS SSHealthAssesmentUserStartedItemID
     , ss.OutComeMessageGUID AS SSOutcomeMessageGuid
     , REPLACE (vwOutcome.Message, '&#39;', '''') AS SSOutcomeMessage
     , usrstd.HACampaignNodeGUID
     , vwCamp.Name AS HACampaignName
     , cast(vwCamp.CampaignStartDate  as datetime) AS HACampaignStartDate
     , cast(vwCamp.CampaignEndDate  as datetime) AS HACampaignEndDate
     , cast(usrstd.HAStartedDt  as datetime) AS HAStartedDate
     , cast(usrstd.HACompletedDt  as datetime) AS HACompletedDate
     , usrstd.HAStartedMode
     , usrstd.HACompletedMode
     , TODO.HaCodeName
     , CMS_US.HFitUserMPINumber

       FROM
           dbo.Hfit_SmallStepResponses AS ss
               JOIN HFit_HealthAssesmentUserStarted AS usrstd
                   ON usrstd.UserID = ss.UserID
                  AND usrstd.ItemID = ss.HealthAssesmentUserStartedItemID
                 JOIN View_HFit_OutComeMessages_Joined AS vwOutcome
                   ON vwOutcome.NodeGUID = ss.OutComeMessageGUID
                  AND vwOutcome.DocumentCulture = 'en-US'
                 JOIN CMS_UserSite AS usrste
                   ON usrste.UserID = ss.UserID
                 JOIN CMS_Site AS ste
                   ON ste.SiteID = usrste.SiteID
                 JOIN View_HFit_HACampaign_Joined AS vwCamp
                   ON vwCamp.NodeGuid = usrstd.HACampaignNodeGUID
                  AND vwCamp.DocumentCulture = 'en-US'
                  AND vwCamp.NodeSiteID = usrste.SiteID
                 JOIN HFit_Account AS acct
                   ON acct.SiteID = usrste.SiteID
                 JOIN HFit_ToDoSmallSteps AS TODO
                   ON ss.OutComeMessageGUID = TODO.OutComeMessageGUID
                 JOIN CMS_UserSettings AS CMS_US
                   ON CMS_US.UserSettingsUserID = ss.UserID
                  AND CMS_US.HFitUserMPINumber > 0
                  AND CMS_US.HFitUserMPINumber IS NOT NULL;

GO
PRINT 'Created view view_EDW_SmallStepResponses';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_STAGING_EDW_SmallSteps.sql \n 
--------------------------------------------------------------- 

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'creating proc_EDW_SmallSteps';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_SmallSteps') 
    BEGIN
        PRINT 'UPDATING proc_EDW_SmallSteps';
        DROP PROCEDURE
             proc_EDW_SmallSteps;
    END;
GO
-- exec proc_EDW_SmallSteps 0
-- exec proc_EDW_SmallSteps 1
CREATE PROCEDURE proc_EDW_SmallSteps (
       @ReloadAll AS int = 0) 
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_SmallSteps';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

/*------------------------------------------------------------------------------------------------------------------------
    This procedure is added to the job job_EDW_GetStagingData_RewardUserDetail and set to run automatically on a schedule.
*/

    BEGIN
        DECLARE
        @STime AS datetime = GETDATE () 
      , @CNT_PulledRecords AS bigint = 0
      , @RecordID AS uniqueidentifier = NEWID () 
      , @CT_NAME AS nvarchar ( 100) = 'proc_EDW_SmallSteps';

        DECLARE
        @isNullable AS nvarchar ( 20) = NULL;

        SET @STime = GETDATE () ;
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_SmallSteps' , @STime , @CNT_PulledRecords , 'I';
        EXEC proc_EDW_Procedure_Performance_Monitor 'D' , @CT_NAME;
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '001 - start up';

        IF @ReloadAll = 1
            BEGIN
                PRINT 'RELOADING ALL EDW_SmallSteps records';

                IF EXISTS ( SELECT
                                   name
                                   FROM sys.tables
                                   WHERE name = 'DIM_EDW_SmallSteps') 
                    BEGIN
                        PRINT 'Dropping DIM_EDW_SmallSteps';
                        DROP TABLE
                             DIM_EDW_SmallSteps;
                    END;
            END;
        IF
        @ReloadAll = 0 OR
        @ReloadAll IS NULL
            BEGIN
                PRINT 'RELOADING only changed EDW_SmallSteps records';
            END;
        IF NOT EXISTS ( SELECT
                               name
                               FROM sys.tables
                               WHERE name = 'DIM_EDW_SmallSteps') 
            BEGIN
                EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '002 - Starting Data Pulled';
                SELECT
                       * INTO
                              DIM_EDW_SmallSteps
                       FROM view_EDW_SmallStepResponses_CT;
                DECLARE
                @iPulled AS int = @@ROWCOUNT;

                EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_SmallSteps';

                EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '002a - Data Pulled';

                EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @CNT_PulledRecords;
                IF NOT EXISTS ( SELECT
                                       column_name
                                       FROM information_schema.columns
                                       WHERE
                                       table_name = 'DIM_EDW_SmallSteps' AND
                                       column_name = 'LastModifiedDate') 
                    BEGIN
                        ALTER TABLE DIM_EDW_SmallSteps
                        ADD
                                    LastModifiedDate datetime2 ( 7) NULL;
                    END;

                SET @isNullable = ( SELECT
                                           IS_NULLABLE
                                           FROM information_schema.columns
                                           WHERE
                                           table_name = 'DIM_EDW_SmallSteps' AND
                                           column_name = 'LastModifiedDate') ;
                IF @isNullable != 'YES'
                    BEGIN
                        ALTER TABLE dbo.DIM_EDW_SmallSteps ALTER COLUMN LastModifiedDate datetime2 NULL;
                        PRINT 'set LastModifiedDate to be NULLABLE.';
                    END;

                IF NOT EXISTS ( SELECT
                                       column_name
                                       FROM information_schema.columns
                                       WHERE
                                       table_name = 'DIM_EDW_SmallSteps' AND
                                       column_name = 'DeletedFlg') 
                    BEGIN
                        ALTER TABLE DIM_EDW_SmallSteps
                        ADD
                                    DeletedFlg bit NULL;
                    END;

                IF NOT EXISTS ( SELECT
                                       column_name
                                       FROM information_schema.columns
                                       WHERE
                                       table_name = 'DIM_EDW_SmallSteps' AND
                                       column_name = 'ChangeType') 
                    BEGIN
                        ALTER TABLE DIM_EDW_SmallSteps
                        ADD
                                    ChangeType nvarchar ( 5) NULL;
                    END;
                EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '003 - Starting Data indexed';

                SET ANSI_PADDING ON;
                CREATE CLUSTERED INDEX PI_EDW_SmallSteps ON dbo.DIM_EDW_SmallSteps ( AccountCD , SiteGUID , SSItemID , SSItemGUID ,
                SSHealthAssesmentUserStartedItemID , SSOutcomeMessageGuid , HFitUserMPINumber , HACampaignNodeGUID , HAStartedMode , HACompletedMode ,
                HaCodeName ,
                HACampaignStartDate , HACampaignEndDate) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
                DROP_EXISTING = OFF ,
                ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                CREATE NONCLUSTERED INDEX PI_EDW_SmallSteps_RowNbrCDate ON dbo.DIM_EDW_SmallSteps ( SSItemID , LastModifiedDate ,
                DeletedFlg) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
                ALLOW_ROW_LOCKS = ON ,
                ALLOW_PAGE_LOCKS = ON) ;

                CREATE NONCLUSTERED INDEX PI_EDW_SmallSteps_ItemID ON dbo.DIM_EDW_SmallSteps ( SSItemID) 
                WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
                ALLOW_ROW_LOCKS = ON ,
                ALLOW_PAGE_LOCKS = ON) ;

                CREATE NONCLUSTERED INDEX PI_EDW_SmallSteps_HashCode ON dbo.DIM_EDW_SmallSteps ( HFitUserMPINumber , HashCode) 
                WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
                ALLOW_ROW_LOCKS = ON ,
                ALLOW_PAGE_LOCKS = ON) ;

                SET @STime = GETDATE () ;
                EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_SmallSteps' , @STime , @iPulled , 'U';
                EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '003a - Data indexed';
                EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '002a - reload complete';

                EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_SmallSteps';
                SET NOCOUNT OFF;
                EXEC proc_CT_EDW_SmallSteps_NoDups ;
                RETURN;
            END;

        --IF EXISTS ( SELECT
        --                   name
        --              FROM temp..sys.tables
        --              WHERE name = '##Temp_SmallSteps' )
        IF OBJECT_ID ('tempdb..##Temp_SmallSteps') IS NOT NULL
            BEGIN
                PRINT 'Dropping ##Temp_SmallSteps';
                DROP TABLE
                     ##Temp_SmallSteps;
            END;

        DECLARE
        @iChgType AS int = 0;
        EXEC @iChgType = proc_CkSmallStepsHasChanged ;
        PRINT '@iChgType = ' + CAST ( @iChgType AS nvarchar (50)) ;

        IF @iChgType = 0
            BEGIN
                PRINT 'NO CHANGES FOUND, returning.';
                SET @STime = GETDATE () ;
                EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_SmallSteps' , @STime , @iPulled , 'U';
                EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '00Z1 - NO CHANGES';
                EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '00Z2 - reload complete';

                RETURN;
            END;

        DECLARE
        @iCnt AS bigint = 0;

        --select top 10 * from ##Temp_SmallSteps
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '004 - get changes';
        IF @iChgType = 2
            BEGIN
                PRINT 'PULLING ALL records as deletes were detected.';
                SELECT
                       * INTO
                              ##Temp_SmallSteps
                       FROM view_EDW_SmallStepResponses_CT;
            END;
        IF @iChgType = 1
            BEGIN
                DECLARE @S1 AS nvarchar (2000) = '';
                PRINT 'PULLING only changed records as NO deletes were detected.';
                SET @S1 = 'SELECT
                       * INTO
                              ##Temp_SmallSteps
                  FROM view_EDW_SmallStepResponses_CT
                  WHERE ChangeType IS NOT NULL ';
                EXEC (@S1) ;
            END;
        --WHERE ChangeType IS NOT NULL;
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '005 - changes retrieved';
        SET @iCnt = @@ROWCOUNT;
        IF @iCnt = 0
            BEGIN
                PRINT 'No changes detected.';
                EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '005 - NO CHANGES';

                EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_SmallSteps';
                SET NOCOUNT OFF;
                RETURN;
            END;
        ELSE
            BEGIN
                PRINT 'PROCESSING ' + CAST ( @iCnt AS nvarchar ( 50)) + ' rows.';
            END;

        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               table_name = 'DIM_EDW_SmallSteps' AND
                               column_name = 'LastModifiedDate') 
            BEGIN
                ALTER TABLE ##Temp_SmallSteps
                ADD
                            LastModifiedDate datetime2 ( 7) NULL;
            END;

        SET @isNullable = ( SELECT
                                   IS_NULLABLE
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = 'DIM_EDW_SmallSteps' AND
                                   column_name = 'LastModifiedDate') ;
        IF @isNullable != 'YES'
            BEGIN
                ALTER TABLE dbo.DIM_EDW_SmallSteps ALTER COLUMN LastModifiedDate datetime2 NULL;
                PRINT 'set LastModifiedDate to be NULLABLE.';
            END;

        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               table_name = 'DIM_EDW_SmallSteps' AND
                               column_name = 'DeletedFlg') 
            BEGIN
                ALTER TABLE ##Temp_SmallSteps
                ADD
                            DeletedFlg bit NULL;
            END;

        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               table_name = 'DIM_EDW_SmallSteps' AND
                               column_name = 'ChangeType') 
            BEGIN
                ALTER TABLE ##Temp_SmallSteps
                ADD
                            ChangeType nvarchar ( 5) NULL;
            END;

        CREATE CLUSTERED INDEX PI_TEMP_EDW_SmallSteps ON ##Temp_SmallSteps ( AccountCD , SiteGUID , SSItemID , SSItemGUID ,
        SSHealthAssesmentUserStartedItemID , SSOutcomeMessageGuid , HFitUserMPINumber , HACampaignNodeGUID , HAStartedMode , HACompletedMode ,
        HaCodeName ,
        HACampaignStartDate , HACampaignEndDate) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
        ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

        CREATE NONCLUSTERED INDEX PI_TEMP_EDW_SmallSteps_ItemID ON ##Temp_SmallSteps ( SSItemID) 
        WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
        ALLOW_ROW_LOCKS = ON ,
        ALLOW_PAGE_LOCKS = ON) ;

        CREATE NONCLUSTERED INDEX PI_TEMP_EDW_SmallSteps_Hashcode ON ##Temp_SmallSteps ( HFitUserMPINumber , HashCode) 
        WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
        ALLOW_ROW_LOCKS = ON ,
        ALLOW_PAGE_LOCKS = ON) ;

        EXEC proc_CT_EDW_SmallSteps_Temp_NoDups ;

        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '006 - indexes applied';
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '007 - get new records';

        DECLARE
        @iInserted AS int = 0;

        --************************************************************
        --** APPLY ANY NEW RECORDS TO THE STAGING TABLE
        EXEC @iInserted = proc_CT_SmallSteps_AddNewRecs ;
        --************************************************************

        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iInserted;
        PRINT 'Records Added: ' + CAST ( @iInserted AS nvarchar (5)) ;
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '007a - new records added';

        DECLARE
        @RUNDATE AS datetime2 ( 7) = GETDATE () ;

/*-------------------------------------------------
***********************************************
	   get the changed records and update them
	   ***********************************************
*/
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '008 - get changed records';

        DECLARE @iUpdated AS int = 0;
        --************************************************************
        --** APPLY ANY NEW RECORDS TO THE STAGING TABLE
        EXEC @iUpdated = proc_CT_SmallSteps_AddUpdatedRecs ;
        --************************************************************

        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '008a - retrieved changed records';
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdated;
        PRINT 'Records Updated: ' + CAST ( @iUpdated  AS nvarchar (5)) ;
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '009 - retrieve deleted records';

        DECLARE @iDeleted AS int = @@ROWCOUNT;
        --************************************************************
        --** MARK DELETED RECORDS
        EXEC @iDeleted = proc_CT_SmallSteps_AddDeletedRecords ;
        --************************************************************

        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '009a - retrieved deleted records';
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDeleted;
        PRINT 'Records Marked As Deleted: ' + CAST ( @iDeleted AS nvarchar (5)) ;
        SET @STime = GETDATE () ;
        SET @CNT_PulledRecords = ( SELECT
                                          COUNT ( *) 
                                          FROM ##Temp_SmallSteps) ;
    END;
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_SmallSteps' , @STime , @CNT_PulledRecords , 'U';

    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_SmallSteps';

    PRINT 'Executed proc_EDW_SmallSteps';
    PRINT GETDATE () ;

    EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '010 - retrieved deleted records';
    EXEC proc_CT_EDW_SmallSteps_NoDups;

    SET NOCOUNT OFF;
END;
GO
PRINT 'CREATED proc_EDW_SmallSteps';
PRINT GETDATE () ;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_HealthAssesmentDefinition_CT.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1


GO
PRINT 'Processing: view_EDW_HealthAssessmentDefinition_CT ' + CAST (GETDATE () AS nvarchar (50)) ;
GO

/*
select count(*), HashCode 
from view_EDW_HealthAssessmentDefinition_CT
group by HashCode 
having count(*) > 1

select * from view_EDW_HealthAssessmentDefinition_CT
select top 100 lastModifiedDate,* from view_EDW_HealthAssessmentDefinition_CT
select count(*) from view_EDW_HealthAssessmentDefinition_CT
select count(*) from view_EDW_HealthAssessmentDefinition_CT
--RCDocPubVerID
Select * from HFit_HealthAssesmentMultipleChoiceQuestion where HealthAssesmentMultipleChoiceQuestionID = 495
update HFit_HealthAssesmentMultipleChoiceQuestion set AllowMultiSelect = -1  where HealthAssesmentMultipleChoiceQuestionID = 495
update HFit_HealthAssesmentMultipleChoiceQuestion set AllowMultiSelect = 0  where HealthAssesmentMultipleChoiceQuestionID = 495

select * 
into STAGED_EDW_HealthAssessmentDefinition
from view_EDW_HealthAssessmentDefinition_CT
where
CHANGED_FLG IS NOT NULL

PK: SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID

select count(*) SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID 
from view_EDW_HealthAssessmentDefinition_CT
group by SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID
having count(*)  >1

*/

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
             WHERE TABLE_NAME = 'view_EDW_HealthAssessmentDefinition_CT') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessmentDefinition_CT;
    END;
GO

/*
select * 
into Staging_EDW_HealthAssesmentDeffinition
from view_EDW_HealthAssessmentDefinition_CT
select * from Staging_EDW_HealthAssesmentDeffinition
*/

--**************************************************************************************************************
--NOTE: The column DocumentModifiedWhen comes from the CMS_TREE join - it was left 
--		unchanged when other dates added for the Last Mod Date additions. 
--		Therefore, the 'ChangeType' was left dependent upon this date only. 09.12.2014 (wdm)
--*****************************************************************************************************************************************************
--Test Queries:
--select * from view_EDW_HealthAssessmentDefinition_CT where AnsDocumentGuid is not NULL
--Changes:
--WDM - 6/25/2014
--Query was returning a NULL dataset. Found that it is being caused by the AccountCD join.
--Worked with Shane to discover the CMS Tree had been modified.
--Modified the code so that reads it reads the CMS tree correctly - working.
--7/14/2014 1:29 time to run - 79024 rows - DEV
--7/14/2014 0:58 time to run - 57472 rows - PROD1
--7/15/2014 - Query was returning NodeName of 'Campaigns' only
--	Found the issue in view View_HFit_HACampaign_Joined. Documented the change in the view.
--7/16/2014 - Full Select: Using a DocumentModifiedWhen filter 00:17:28 - Record Cnt: 793,520
--8/7/2014 - Executed in DEV with GUID changes and returned 1.13M Rows in 23:14.
--8/8/2014 - Executed in DEV with GUID changes, new views, and returned 1.13M Rows in 20:16.
--8/8/2014 - Generated corrected view in DEV
--8/12/2014 - John C. explained that Account Code and Site Guid are not needed, NULLED
--				them out. With them in the QRY, returned 43104 rows, with them nulled
--				out, returned 43104 rows. Using a DISTINCT, 28736 rows returned and execution
--				time doubled approximately.
--				Has to add a DISTINCT to all the queries - .
--				Original Query 0:25 @ 43104
--				Original Query 0:46 @ 28736 (distinct)
--				Filter added - VHFHAQ.DocumentCulture 0:22 @ 14368
--				Filter added - and VHFHARCJ.DocumentCulture = 'en-us'	 0:06 @ 3568
--				Filter added - and VHFHARAJ.DocumentCulture = 'en-us'	 0:03 @ 1784
--8/12/2014 - Applied the language filters with John C. and performance improved, as expected,
--				such that when running the view in QA: 
--8/12/2014 - select * from [view_EDW_HealthAssessmentDefinition_CT] where DocumentModifiedWhen between '2000-11-14' and 
--				'2014-11-15' now runs exceptionally fast
--08/12/2014 - ProdStaging 00:21:52 @ 2442
--08/12/2014 - ProdStaging 00:21:09 @ 13272 (UNION ALL   --UNION)
--08/12/2014 - ProdStaging 00:21:37 @ 13272 (UNION ONLY)
--08/12/2014 - ProdStaging 00:06:26 @ 1582 (UNION ONLY & Select Filters Added for Culture)
--08/12/2014 - ProdStaging 00:10:07 @ 6636 (UNION ALL   --UNION) and all selected
--08/12/2014 - ProdStaging added PI PI_View_CMS_Tree_Joined_Regular_DocumentCulture: 00:2:34 @ 6636 
--08/12/2014 - DEV 00:00:58 @ 3792
--09.11.2014 - (wdm) added the needed date fields to help EDW in determining the last mod date of a row.
--10.01.2014 - Dale and Mark reworked this view to use NodeGUIDS and eliminated the CMS_TREE View from participating as 
--				well as Site and Account data
--11.25.2014 - (wdm) added multi-select column capability. The values can be 0,1, NULL
--12.29.2014 - (wdm) Added HTML stripping to two columns #47619, the others mentioned already had stripping applied
--12.31.2014 - (wdm) Started the review to apply CR-47517: Eliminate Matrix Questions with NULL Answer GUID's
--01.07.2014 - (wdm) 47619 The Health Assessment Definition interface view contains HTML tags - corrected with udf_StripHTML
--************************************************************************************************************************************************************
CREATE VIEW dbo.view_EDW_HealthAssessmentDefinition_CT
AS SELECT DISTINCT

          NULL AS SiteGUID --cs.SiteGUID								--WDM 08.12.2014 per John C.
        , NULL AS AccountCD	 --, HFA.AccountCD						--WDM 08.07.2014 per John C.
        , HA.NodeID AS HANodeID										--WDM 08.07.2014
        , HA.NodeName AS HANodeName									--WDM 08.07.2014
          --, HA.DocumentID AS HADocumentID								--WDM 08.07.2014 commented out and left in place for history
        , NULL AS HADocumentID										--WDM 08.07.2014; 09.29.2014: Mark and Dale discussed that NODEGUID should be used such that the multi-language/culture is not a problem.
        , HA.NodeSiteID AS HANodeSiteID								--WDM 08.07.2014
        , HA.DocumentPublishedVersionHistoryID AS HADocPubVerID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) AS ModTitle              --WDM 47619
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText              --WDM 47619
        , VHFHAMJ.NodeGuid AS ModDocGuid	--, VHFHAMJ.DocumentID AS ModDocID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHAMJ.Weight AS ModWeight
        , VHFHAMJ.IsEnabled AS ModIsEnabled
        , VHFHAMJ.CodeName AS ModCodeName
        , VHFHAMJ.DocumentPublishedVersionHistoryID AS ModDocPubVerID
        , dbo.udf_StripHTML (VHFHARCJ.Title) AS RCTitle              --WDM 47619
        , VHFHARCJ.Weight AS RCWeight
        , VHFHARCJ.NodeGuid AS RCDocumentGUID	--, VHFHARCJ.DocumentID AS RCDocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHARCJ.IsEnabled AS RCIsEnabled
        , VHFHARCJ.CodeName AS RCCodeName
        , VHFHARCJ.DocumentPublishedVersionHistoryID AS RCDocPubVerID
        , dbo.udf_StripHTML (VHFHARAJ.Title) AS RATytle              --WDM 47619
        , VHFHARAJ.Weight AS RAWeight
        , VHFHARAJ.NodeGuid AS RADocumentGuid	--, VHFHARAJ.DocumentID AS RADocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHARAJ.IsEnabled AS RAIsEnabled
        , VHFHARAJ.CodeName AS RACodeName
        , VHFHARAJ.ScoringStrategyID AS RAScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID AS RADocPubVerID
        , VHFHAQ.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ.Title, 4000)) AS QuesTitle              --WDM 47619
        , VHFHAQ.Weight AS QuesWeight
        , VHFHAQ.IsRequired AS QuesIsRequired

          --, VHFHAQ.DocumentGuid AS QuesDocumentGuid	--, VHFHAQ.DocumentID AS QuesDocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHAQ.NodeGuid AS QuesDocumentGuid	--, VHFHAQ.DocumentID AS QuesDocumentID	--WDM 08.07.2014

        , VHFHAQ.IsEnabled AS QuesIsEnabled
        , LEFT (VHFHAQ.IsVisible, 4000) AS QuesIsVisible
        , VHFHAQ.IsStaging AS QuesIsSTaging
        , VHFHAQ.CodeName AS QuestionCodeName
        , VHFHAQ.DocumentPublishedVersionHistoryID AS QuesDocPubVerID
        , VHFHAA.Value AS AnsValue
        , VHFHAA.Points AS AnsPoints
        , VHFHAA.NodeGuid AS AnsDocumentGuid		--ref: #47517
        , VHFHAA.IsEnabled AS AnsIsEnabled
        , VHFHAA.CodeName AS AnsCodeName
        , VHFHAA.UOM AS AnsUOM
        , VHFHAA.DocumentPublishedVersionHistoryID AS AnsDocPUbVerID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014 ADDED TO the returned Columns
        , HA.NodeGUID AS HANodeGUID
          --, NULL as SiteLastModified
        , NULL AS SiteLastModified
          --, NULL as Account_ItemModifiedWhen
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID01' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ.CodeName, '-') + ISNULL (CAST (VHFHAQ.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA.CodeName , '-') + ISNULL (CAST (VHFHAA.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID01' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ.IsVisible, 1000) , '-') 
          ) AS HashCode

          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US'

/*
		  --** ADD THE CHANGE TRACKING Tables
		  */

                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHARAJ.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'		--WDM 08.12.2014	
       AND VHFHAA.NodeGuid IS NOT NULL		--ref: #47517

   UNION ALL   --UNION
   --WDM Retrieve Matrix Level 1 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title)              --WDM 47619
        , dbo.udf_StripHTML (LEFT (LEFT (VHFHAMJ.IntroText, 4000) , 4000)) AS IntroText              --WDM 47619
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title)              --WDM 47619
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title)              --WDM 47619
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ2.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ2.Title, 4000)) AS QuesTitle              --WDM 47619
        , VHFHAQ2.Weight
        , VHFHAQ2.IsRequired
        , VHFHAQ2.NodeGuid
        , VHFHAQ2.IsEnabled
        , LEFT (VHFHAQ2.IsVisible, 4000) 
        , VHFHAQ2.IsStaging
        , VHFHAQ2.CodeName AS QuestionCodeName
          --,VHFHAQ2.NodeAliasPath
        , VHFHAQ2.DocumentPublishedVersionHistoryID
        , VHFHAA2.Value
        , VHFHAA2.Points
        , VHFHAA2.NodeGuid		--ref: #47517
        , VHFHAA2.IsEnabled
        , VHFHAA2.CodeName
        , VHFHAA2.UOM
          --,VHFHAA2.NodeAliasPath
        , VHFHAA2.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID02' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ2.CodeName, '-') + ISNULL (CAST (VHFHAQ2.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA2.CodeName , '-') + ISNULL (CAST (VHFHAA2.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID02' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ2.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ2.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2
                      ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2
                      ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA2.NodeGuid IS NOT NULL		--ref: #47517

   UNION ALL   --UNION
   --WDM Retrieve Branching Level 1 Question and Matrix Level 1 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ3.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ3.Title, 4000)) AS QuesTitle
        , VHFHAQ3.Weight
        , VHFHAQ3.IsRequired
        , VHFHAQ3.NodeGuid
        , VHFHAQ3.IsEnabled
        , LEFT (VHFHAQ3.IsVisible, 4000) 
        , VHFHAQ3.IsStaging
        , VHFHAQ3.CodeName AS QuestionCodeName
          --,VHFHAQ3.NodeAliasPath
        , VHFHAQ3.DocumentPublishedVersionHistoryID
        , VHFHAA3.Value
        , VHFHAA3.Points
        , VHFHAA3.NodeGuid		--ref: #47517
        , VHFHAA3.IsEnabled
        , VHFHAA3.CodeName
        , VHFHAA3.UOM
          --,VHFHAA3.NodeAliasPath
        , VHFHAA3.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID03' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ3.CodeName, '-') + ISNULL (CAST (VHFHAQ3.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA3.CodeName , '-') + ISNULL (CAST (VHFHAA3.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID03' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ3.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ3.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA3.NodeGuid IS NOT NULL		--ref: #47517
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM Retrieve Branching Level 1 Question and Matrix Level 2 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ7.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ7.Title, 4000)) AS QuesTitle
        , VHFHAQ7.Weight
        , VHFHAQ7.IsRequired
        , VHFHAQ7.NodeGuid
        , VHFHAQ7.IsEnabled
        , LEFT (VHFHAQ7.IsVisible, 4000) 
        , VHFHAQ7.IsStaging
        , VHFHAQ7.CodeName AS QuestionCodeName
          --,VHFHAQ7.NodeAliasPath
        , VHFHAQ7.DocumentPublishedVersionHistoryID
        , VHFHAA7.Value
        , VHFHAA7.Points
        , VHFHAA7.NodeGuid		--ref: #47517
        , VHFHAA7.IsEnabled
        , VHFHAA7.CodeName
        , VHFHAA7.UOM
          --,VHFHAA7.NodeAliasPath
        , VHFHAA7.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID04' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ7.CodeName, '-') + ISNULL (CAST (VHFHAQ7.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA7.CodeName , '-') + ISNULL (CAST (VHFHAA7.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID04' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ7.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ7.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID --LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3 ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID

              --Matrix Level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7
                      ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7
                      ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA7.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************

   UNION ALL   --UNION
   --****************************************************
   --WDM 6/25/2014 Retrieve the Branching level 1 Question Group
   --THE PROBLEM LIES HERE in this part of query : 1:40 minute
   -- Added two perf indexes to the first query: 25 Sec
   --****************************************************
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ8.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ8.Title, 4000)) AS QuesTitle
        , VHFHAQ8.Weight
        , VHFHAQ8.IsRequired
        , VHFHAQ8.NodeGuid
        , VHFHAQ8.IsEnabled
        , LEFT (VHFHAQ8.IsVisible, 4000) 
        , VHFHAQ8.IsStaging
        , VHFHAQ8.CodeName AS QuestionCodeName
          --,VHFHAQ8.NodeAliasPath
        , VHFHAQ8.DocumentPublishedVersionHistoryID
        , VHFHAA8.Value
        , VHFHAA8.Points
        , VHFHAA8.NodeGuid		--ref: #47517
        , VHFHAA8.IsEnabled
        , VHFHAA8.CodeName
        , VHFHAA8.UOM
          --,VHFHAA8.NodeAliasPath
        , VHFHAA8.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID05' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ8.CodeName, '-') + ISNULL (CAST (VHFHAQ8.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA8.CodeName , '-') + ISNULL (CAST (VHFHAA8.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID05' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ8.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ8.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************	

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID --LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3 ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID

              --Matrix Level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7
                      ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7
                      ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID --Matrix branching level 1 question group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8
                      ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8
                      ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA8.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************

   UNION ALL   --UNION
   --****************************************************
   --WDM 6/25/2014 Retrieve the Branching level 2 Question Group
   --THE PROBLEM LIES HERE in this part of query : 1:48  minutes
   --With the new indexes: 29 Secs
   --****************************************************
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ4.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ4.Title, 4000)) AS QuesTitle
        , VHFHAQ4.Weight
        , VHFHAQ4.IsRequired
        , VHFHAQ4.NodeGuid
        , VHFHAQ4.IsEnabled
        , LEFT (VHFHAQ4.IsVisible, 4000) 
        , VHFHAQ4.IsStaging
        , VHFHAQ4.CodeName AS QuestionCodeName
          --,VHFHAQ4.NodeAliasPath
        , VHFHAQ4.DocumentPublishedVersionHistoryID
        , VHFHAA4.Value
        , VHFHAA4.Points
        , VHFHAA4.NodeGuid		--ref: #47517
        , VHFHAA4.IsEnabled
        , VHFHAA4.CodeName
        , VHFHAA4.UOM
          --,VHFHAA4.NodeAliasPath
        , VHFHAA4.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID06' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ4.CodeName, '-') + ISNULL (CAST (VHFHAQ4.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA4.CodeName , '-') + ISNULL (CAST (VHFHAA4.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID06' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ4.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ4.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA4.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 3 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ5.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ5.Title, 4000)) AS QuesTitle
        , VHFHAQ5.Weight
        , VHFHAQ5.IsRequired
        , VHFHAQ5.NodeGuid
        , VHFHAQ5.IsEnabled
        , LEFT (VHFHAQ5.IsVisible, 4000) 
        , VHFHAQ5.IsStaging
        , VHFHAQ5.CodeName AS QuestionCodeName
          --,VHFHAQ5.NodeAliasPath
        , VHFHAQ5.DocumentPublishedVersionHistoryID
        , VHFHAA5.Value
        , VHFHAA5.Points
        , VHFHAA5.NodeGuid		--ref: #47517
        , VHFHAA5.IsEnabled
        , VHFHAA5.CodeName
        , VHFHAA5.UOM
          --,VHFHAA5.NodeAliasPath
        , VHFHAA5.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID07' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ5.CodeName, '-') + ISNULL (CAST (VHFHAQ5.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA5.CodeName , '-') + ISNULL (CAST (VHFHAA5.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID07' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ5.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ5.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA5.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 4 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ6.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ6.Title, 4000)) AS QuesTitle
        , VHFHAQ6.Weight
        , VHFHAQ6.IsRequired
        , VHFHAQ6.NodeGuid
        , VHFHAQ6.IsEnabled
        , LEFT (VHFHAQ6.IsVisible, 4000) 
        , VHFHAQ6.IsStaging
        , VHFHAQ6.CodeName AS QuestionCodeName
          --,VHFHAQ6.NodeAliasPath
        , VHFHAQ6.DocumentPublishedVersionHistoryID
        , VHFHAA6.Value
        , VHFHAA6.Points
        , VHFHAA6.NodeGuid		--ref: #47517
        , VHFHAA6.IsEnabled
        , VHFHAA6.CodeName
        , VHFHAA6.UOM
          --,VHFHAA6.NodeAliasPath
        , VHFHAA6.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID08' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ6.CodeName, '-') + ISNULL (CAST (VHFHAQ6.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA6.CodeName , '-') + ISNULL (CAST (VHFHAA6.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID08' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ6.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ6.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
              --select count(*) from dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID --Branching level 4 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ6
                      ON VHFHAA5.NodeID = VHFHAQ6.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA6
                      ON VHFHAQ6.NodeID = VHFHAA6.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE  VHFHAQ.DocumentCulture = 'en-us'
        AND (VHFHAA.DocumentCulture = 'en-us'
          OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
        AND VHFHARCJ.DocumentCulture = 'en-us'
        AND VHFHARAJ.DocumentCulture = 'en-us'
        AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
        AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
        AND VHFHAA6.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 5 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ9.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ9.Title, 4000)) AS QuesTitle
        , VHFHAQ9.Weight
        , VHFHAQ9.IsRequired
        , VHFHAQ9.NodeGuid
        , VHFHAQ9.IsEnabled
        , LEFT (VHFHAQ9.IsVisible, 4000) 
        , VHFHAQ9.IsStaging
        , VHFHAQ9.CodeName AS QuestionCodeName
          --,VHFHAQ9.NodeAliasPath
        , VHFHAQ9.DocumentPublishedVersionHistoryID
        , VHFHAA9.Value
        , VHFHAA9.Points
        , VHFHAA9.NodeGuid		--ref: #47517
        , VHFHAA9.IsEnabled
        , VHFHAA9.CodeName
        , VHFHAA9.UOM
          --,VHFHAA9.NodeAliasPath
        , VHFHAA9.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID09' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ.CodeName, '-') + ISNULL (CAST (VHFHAQ.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA.CodeName , '-') + ISNULL (CAST (VHFHAA.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID09' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
              --select count(*) from dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID --Branching level 4 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ6
                      ON VHFHAA5.NodeID = VHFHAQ6.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA6
                      ON VHFHAQ6.NodeID = VHFHAA6.NodeParentID --Branching level 5 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ9
                      ON VHFHAA6.NodeID = VHFHAQ9.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA9
                      ON VHFHAQ9.NodeID = VHFHAA9.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE  VHFHAQ.DocumentCulture = 'en-us'
        AND (VHFHAA.DocumentCulture = 'en-us'
          OR VHFHAA.DocumentCulture IS NULL) 
        AND VHFHARCJ.DocumentCulture = 'en-us'
        AND VHFHARAJ.DocumentCulture = 'en-us'
        AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
        AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
        AND VHFHAA9.NodeGuid IS NOT NULL;		--ref: #47517
--********************************************
--AND (
--    CT_CMS_Class.ClassID IS NOT NULL
-- OR CT_CMS_Document.DocumentID IS NOT NULL
-- OR CT_CMS_Site.SiteID IS NOT NULL
-- OR CT_CMS_Tree.NodeID IS NOT NULL
-- OR CT_CMS_User.UserID IS NOT NULL
-- OR CT_COM_SKU.SKUID IS NOT NULL
-- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
-- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
-- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
-- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
-- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
-- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
-- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
-- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
--    );

GO

PRINT 'Processed: view_EDW_HealthAssessmentDefinition_CT ';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthAssessmentDefinition_CT.sql';
GO

--select * 
--into STAGED_EDW_HealthAssessmentDefinition
--from view_EDW_HealthAssessmentDefinition_CT
--go--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: create_job_PullEdwHaDefinition.sql \n 
--------------------------------------------------------------- 

go
PRINT 'Creating JOB job_EDW_GetStagingData_HADefinition' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_HADefinition_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled=1, 
		@notify_level_eventlog=2, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'dmiller', @job_id = @jobId OUTPUT
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_STAGING_EDW_HADefinition]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_STAGING_EDW_HADefinition',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_STAGING_EDW_HA_Definition;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_STAGING_EDW_HADefinition',
@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=8, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20150611, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959
		--@schedule_uid=N'1de52534-38dc-4155-baf3-0eb7259df6c1'
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_HealthAssessmentDefinition_Staged.sql" \n 
--------------------------------------------------------------- 

GO
print ('Processing: view_EDW_HealthAssessmentDefinition_STAGED ') ;
go

--select top 100 * from [view_EDW_HealthAssessmentDefinition_STAGED]
--select * from [view_EDW_HealthAssessmentDefinition_STAGED]

if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_HealthAssessmentDefinition_STAGED')
BEGIN
	drop view view_EDW_HealthAssessmentDefinition_STAGED ;
END
GO

create view [dbo].[view_EDW_HealthAssessmentDefinition_STAGED]
as
--****************************************************************************
--09/04/2014 WDM
--The view Health Assessment Definition runs very poorly. This view/table is 
--created as as a staging table allowing the data to already exist when the 
--EDW needs it. This is the view that data from the staging table 
--(EDW_HealthAssessmentDefinition) allowing the EDW to launch a much faster 
--start when processing Health Assessment Definition data.
--04.16.2015 - (WDM) Converted to run against the staging table.
--****************************************************************************
SELECT [SiteGUID]
      ,[AccountCD]
      ,[HANodeID]
      ,[HANodeName]
      ,[HADocumentID]
      ,[HANodeSiteID]
      ,[HADocPubVerID]
      ,[ModTitle]
      ,[IntroText]
      ,[ModDocGuid]
      ,[ModWeight]
      ,[ModIsEnabled]
      ,[ModCodeName]
      ,[ModDocPubVerID]
      ,[RCTitle]
      ,[RCWeight]
      ,[RCDocumentGUID]
      ,[RCIsEnabled]
      ,[RCCodeName]
      ,[RCDocPubVerID]
      ,[RATytle]
      ,[RAWeight]
      ,[RADocumentGuid]
      ,[RAIsEnabled]
      ,[RACodeName]
      ,[RAScoringStrategyID]
      ,[RADocPubVerID]
      ,[QuestionType]
      ,[QuesTitle]
      ,[QuesWeight]
      ,[QuesIsRequired]
      ,[QuesDocumentGuid]
      ,[QuesIsEnabled]
      ,[QuesIsVisible]
      ,[QuesIsSTaging]
      ,[QuestionCodeName]
      ,[QuesDocPubVerID]
      ,[AnsValue]
      ,[AnsPoints]
      ,[AnsDocumentGuid]
      ,[AnsIsEnabled]
      ,[AnsCodeName]
      ,[AnsUOM]
      ,[AnsDocPUbVerID]
      ,[ChangeType]
      ,cast([DocumentCreatedWhen] as datetime) as [DocumentCreatedWhen]
      ,cast([DocumentModifiedWhen] as datetime) as [DocumentModifiedWhen]
      ,[CmsTreeNodeGuid]
      ,[HANodeGUID]
      ,[SiteLastModified]
      ,[Account_ItemModifiedWhen]
      ,[Campaign_DocumentModifiedWhen]
      ,[Assessment_DocumentModifiedWhen]
      ,[Module_DocumentModifiedWhen]
      ,[RiskCategory_DocumentModifiedWhen]
      ,[RiskArea_DocumentModifiedWhen]
      ,[Question_DocumentModifiedWhen]
      ,[Answer_DocumentModifiedWhen]
      ,[AllowMultiSelect]
      ,[LocID]
      ,[HashCode]
      ,[CMS_Class_CtID]
      ,[CMS_Class_SCV]
      ,[CMS_Document_CtID]
      ,[CMS_Document_SCV]
      ,[CMS_Site_CtID]
      ,[CMS_Site_SCV]
      ,[CMS_Tree_CtID]
      ,[CMS_Tree_SCV]
      ,[CMS_User_CtID]
      ,[CMS_User_SCV]
      ,[COM_SKU_CtID]
      ,[COM_SKU_SCV]
      ,[HFit_HealthAssesmentMatrixQuestion_CtID]
      ,[HFit_HealthAssesmentMatrixQuestion_SCV]
      ,[HFit_HealthAssesmentModule_CtID]
      ,[HFit_HealthAssesmentModule_SCV]
      ,[HFit_HealthAssesmentMultipleChoiceQuestion_CtID]
      ,[HFit_HealthAssesmentMultipleChoiceQuestion_SCV]
      ,[HFit_HealthAssesmentRiskArea_CtID]
      ,[HFit_HealthAssesmentRiskArea_SCV]
      ,[HFit_HealthAssesmentRiskCategory_CtID]
      ,[HFit_HealthAssesmentRiskCategory_SCV]
      ,[HFit_HealthAssessment_CtID]
      ,[HFit_HealthAssessment_SCV]
      ,[HFit_HealthAssessmentFreeForm_CtID]
      ,[HFit_HealthAssessmentFreeForm_SCV]
      ,[CMS_Class_CHANGE_OPERATION]
      ,[CMS_Document_CHANGE_OPERATION]
      ,[CMS_Site_CHANGE_OPERATION]
      ,[CMS_Tree_CHANGE_OPERATION]
      ,[CMS_User_CHANGE_OPERATION]
      ,[COM_SKU_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentModule_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentRiskArea_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION]
      ,[HFit_HealthAssessment_CHANGE_OPERATION]
      ,[HFit_HealthAssessmentFreeForm_CHANGE_OPERATION]
      ,[CHANGED_FLG]
      ,[CHANGE_TYPE_CODE]
      ,[LastModifiedDate]
      ,[RowNbr]
      ,[DeletedFlg]
  FROM [Staging_EDW_HealthDefinition]


GO
print('***** FROM: view_EDW_HealthAssessmentDefinition_STAGED.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_RewardTriggerParameters_STAGED.sql" \n 
--------------------------------------------------------------- 

GO
print ('Processing: view_EDW_RewardTriggerParameters_STAGED ') ;
go

if exists(select NAME from sys.VIEWS where NAME = 'view_EDW_RewardTriggerParameters_STAGED')
BEGIN
	drop view view_EDW_RewardTriggerParameters_STAGED ;
END
GO

create VIEW [dbo].[view_EDW_RewardTriggerParameters_STAGED]
AS
select * from STAGING_EDW_RewardTriggerParameters
      

GO


  --  
  --  
GO 
print('***** Created: view_EDW_RewardTriggerParameters_STAGED.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_STAGING_EDW_RewardTriggerParameters.sql" \n 
--------------------------------------------------------------- 
-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

/*-----------------------------------------------------------------------------
exec proc_EDW_RewardTriggerParameters 0 ,1  --Process Changed Data only
exec proc_EDW_RewardTriggerParameters 1 ,1  --Reload ALL

select * from TEMP_EDW_RewardTriggerParameters_DATA
select  * from CT_VersionTracking ; 
select * from view_EDW_RewardTriggerParameters_CT
select * from [view_EDW_HealthAssessmentDefinition_Staged]

PULLING Changes for versions between: 42944  and 43281
PULLING Changes for versions between: 43284  and 43287
PULLING Changes for versions between: 43455  and 43468
PULLING Changes for versions between: 43625  and 43627
PULLING Changes for versions between: 43629  and 43632
PULLING Changes for versions between: 43635  and 43691

PULLING Changes for versions between: 11  and 14

SELECT
       COUNT (*) 
       FROM DIM_EDW_RewardTriggerParameters;

SELECT COUNT(*) FROM [view_EDW_RewardTriggerParameters_CT]	  --00:01:47
SELECT top 10 * FROM [view_EDW_RewardTriggerParameters_CT]
SELECT TOP 100 * FROM [DIM_EDW_RewardTriggerParameters];
SELECT COUNT (*) FROM [DIM_EDW_RewardTriggerParameters]; 

PERF Measurements
03.26.2015 : 4681580 rows - 01:26:36 run time / PROD 1 @ LAB - full reload
03.27.2015 : 4681580 rows - 01:01:20 run time / PROD 1 @ LAB - full reload
03.27.2015 : Prod2  @ LAB : (3711933 row(s) affected) : 01:56:01 - full reload
03.28.2015 : Prod3  @ LAB : (5697805 row(s) affected) : 05:45:57 - full reload
03.29.2015 : Prod2  @ LAB : (xx row(s) affected) : 01:56:01 - Changed Records

04.16.2015 : WDM - complted the SP and started testing.
*/

GO
PRINT 'FROM proc_EDW_RewardTriggerParameters.SQL';
PRINT 'Creating proc_EDW_RewardTriggerParameters';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE
                   name = 'proc_EDW_RewardTriggerParameters') 
    BEGIN
        PRINT 'Replacing proc_EDW_RewardTriggerParameters proc';
        DROP PROCEDURE
             proc_EDW_RewardTriggerParameters;
    END;
GO

CREATE PROCEDURE proc_EDW_RewardTriggerParameters
       @Reloadall int = 0
     , @TrackProgress int = 0
     , @KeepData AS bit = 0
AS
BEGIN

    SET NOCOUNT ON;

    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardTriggerParameters';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

    DECLARE
    @Synchronization_Version bigint = 0
  , @CurrentDbVersion AS int
  , @STime AS datetime
  , @TgtView AS nvarchar ( 100) = 'view_EDW_RewardTriggerParameters'
  , @ExtractionDate AS datetime
  , @ExtractedVersion AS int
  , @ExtractedRowCnt AS int
  , @EndTime AS datetime
  , @CNT_PulledRecords AS int = 0
  , @iCnt AS int = 0
  , @RowNbr AS int = 0
  , @StartTime AS datetime = GETDATE () 
  , @SVRName AS nvarchar ( 100) 
  , @DBName AS nvarchar ( 100) = DB_NAME () 
  , @CNT_Insert AS int = 0
  , @CNT_Update AS int = 0
  , @CNT_Delete AS int = 0
  , @CNT_StagingTable int = 0
  , @VersionNBR int = 0;

    DECLARE
    @proc_RowGuid AS uniqueidentifier = NEWID () 
  , @CALLING_PROC AS nvarchar ( 100) = 'proc_EDW_RewardTriggerParameters'
  , @PROC_LOCATION AS nvarchar ( 100) = ''
  , @proc_starttime AS datetime = GETDATE () 
  , @proc_endtime AS datetime = NULL
  , @proc_elapsedsecs AS bigint = 0
  , @proc_RowsProcessed AS bigint = 0
  , @PulledCnt AS bigint;

    DECLARE
    @HRPART AS int
  , @MINPART AS int
  , @SECPART AS int
  , @TOTSECS AS int = 0;

    SET @SVRName = ( SELECT
                            @@SERVERNAME) ;

    SET @STime = GETDATE () ;

    EXEC proc_EDW_CT_ExecutionLog_Update @proc_RowGuid , 'proc_EDW_RewardTriggerParameters' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                               FROM sys.tables
                               WHERE
                               name = 'DIM_EDW_RewardTriggerParameters') 
                BEGIN
                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    PRINT 'Dropping DIM_EDW_RewardTriggerParameters for FULL reload.';
                    DROP TABLE
                         DIM_EDW_RewardTriggerParameters;
                END;
            ELSE
                BEGIN
                            PRINT 'Reloading DIM_EDW_RewardTriggerParameters.';                    
                END;
            IF
            @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL EDW HA Data.';

                    SELECT
                           * INTO
                                  DIM_EDW_RewardTriggerParameters
                           FROM view_EDW_RewardTriggerParameters_CT;
				SET @PulledCnt = @@ROWCOUNT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardTriggerParameters';
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @proc_RowGuid , 'I' , @PulledCnt;
                    PRINT 'TOTAL RECORDS PULLED: ' + CAST ( @PulledCnt AS nvarchar ( 50)) ;

                    IF
                    @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( *) 
                                                 FROM DIM_EDW_RewardTriggerParameters) ;
                            PRINT DB_NAME () + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50)) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( *) 
                                                      FROM DIM_EDW_RewardTriggerParameters) ;
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                           FROM sys.indexes
                                           WHERE
                                           name = 'PI_EDW_RewardTriggerParameters_IDs') 
                        BEGIN
                            IF
                            @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_RewardTriggerParameters_IDs at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                                END;
                            CREATE NONCLUSTERED INDEX PI_EDW_RewardTriggerParameters_IDs ON dbo.DIM_EDW_RewardTriggerParameters ( SiteGUID , RewardTriggerID , ParameterDisplayName , RewardTriggerParameterOperator , [Value] , AccountID , AccountCD , DocumentGuid , NodeGuid) 
                            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                        END;

                    SET @ExtractionDate = GETDATE () ;
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( *) 
                                                    FROM DIM_EDW_RewardTriggerParameters) ;
                    --SET @TgtView = 'view_EDW_RewardTriggerParameters';
                    SET @EndTime = GETDATE () ;

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                        END;

                END;
            -- SELECT * INTO [DIM_EDW_RewardTriggerParameters] FROM [view_EDW_RewardTriggerParameters_CT];
            IF
            @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            IF
            @TrackProgress = 1
                BEGIN
                    PRINT
                    'Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            SET @STime = GETDATE () ;
            EXEC proc_EDW_CT_ExecutionLog_Update @proc_RowGuid , 'proc_EDW_RewardTriggerParameters' , @STime , @PulledCnt , 'U';

            SET @HRPART = DATEDIFF ( hour , @proc_starttime , GETDATE ()) ;
            SET @MINPART = DATEDIFF ( minute , @proc_starttime , GETDATE ()) % 60;
            SET @SECPART = DATEDIFF ( second , @proc_starttime , GETDATE ()) % 60;
            SET @TOTSECS = DATEDIFF ( second , @proc_starttime , GETDATE ()) ;

            PRINT 'TIME TO EXECUTE: ' + CAST ( @TOTSECS AS nvarchar ( 10)) + ' Seconds';
            PRINT 'TOTAL RECORDS PULLED: ' + CAST ( @PulledCnt AS nvarchar ( 20)) ;

            SET @proc_RowsProcessed = @PulledCnt;
            SET @PROC_LOCATION = 'End Of Run';
            SET @proc_endtime = GETDATE () ;
            EXEC proc_CT_Performance_History @proc_RowGuid , @CALLING_PROC , @PROC_LOCATION , @proc_starttime , @proc_endtime , @proc_elapsedsecs , @proc_RowsProcessed;

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardTriggerParameters';

            SET NOCOUNT OFF;

            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                           FROM sys.tables
                           WHERE
                           name = 'DIM_EDW_RewardTriggerParameters') 
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_RewardTriggerParameters was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            IF NOT EXISTS ( SELECT
                                   name
                                   FROM sys.indexes
                                   WHERE
                                   name = 'PI_EDW_RewardTriggerParameters_IDs') 
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_RewardTriggerParameters_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_RewardTriggerParameters_IDs ON dbo.DIM_EDW_RewardTriggerParameters (
                    SiteGUID
                    , RewardTriggerID
                    , ParameterDisplayName
                    , RewardTriggerParameterOperator
                    , [Value]
                    , AccountID
                    , AccountCD
                    , DocumentGuid
                    , NodeGuid) 
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                               FROM tempdb.dbo.sysobjects
                               WHERE id = OBJECT_ID ( N'tempdb..##TEMP_RewardTriggerParameters')) 

                BEGIN
                    PRINT 'Dropping ##TEMP_RewardTriggerParameters';
                    DROP TABLE
                         ##TEMP_RewardTriggerParameters;
                END;

/*---------------------------------------------------------------------------
*****************************************************************************
*/

            SELECT
                   * INTO
                          ##TEMP_RewardTriggerParameters
                   FROM view_EDW_RewardTriggerParameters_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

            SET @PulledCnt = @@ROWCOUNT;

            --select * from ##TEMP_RewardTriggerParameters
            --ALTER TABLE ##TEMP_RewardTriggerParameters add SVR nvarchar(100) not NULL default(@@SERVERNAME)
            --ALTER TABLE ##TEMP_RewardTriggerParameters add DBNAME nvarchar(100) not NULL default(DB_NAME())

            EXEC proc_Add_EDW_CT_StdCols '##TEMP_RewardTriggerParameters';

            CREATE CLUSTERED INDEX temp_PI_EDW_RewardTriggerParameters_IDs ON dbo.##TEMP_RewardTriggerParameters (
            SiteGUID
            , RewardTriggerID
            , ParameterDisplayName
            , RewardTriggerParameterOperator
            , [Value]
            , AccountID
            , AccountCD
            , DocumentGuid
            , NodeGuid) 
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

            IF @KeepData = 1
                BEGIN
                    PRINT 'KEEPING TEMP DATA IN TABLE TEMP_EDW_RewardTriggerParameters_DATA';
                    IF EXISTS ( SELECT
                                       name
                                       FROM sys.tables
                                       WHERE
                                       name = 'TEMP_EDW_RewardTriggerParameters_DATA') 
                        BEGIN
                            DROP TABLE
                                 TEMP_EDW_RewardTriggerParameters_DATA;
                        END;

                    SELECT
                           * INTO
                                  TEMP_EDW_RewardTriggerParameters_DATA
                           FROM view_EDW_RewardTriggerParameters_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_RewardTriggerParameters_DATA';

                    CREATE CLUSTERED INDEX temp_PI_EDW_RewardTriggerParameters_IDs ON TEMP_EDW_RewardTriggerParameters_DATA (
                    SiteGUID
                    , RewardTriggerID
                    , ParameterDisplayName
                    , RewardTriggerParameterOperator
                    , [Value]
                    , AccountID
                    , AccountCD
                    , DocumentGuid
                    , NodeGuid) 
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM ##TEMP_RewardTriggerParameters) ;

            --*******************************************************
            -- ADD NEW RECORDS
            --*******************************************************    
            DECLARE
            @iInserts AS int = 0;
            EXEC @iInserts = proc_CT_RewardTriggerParameters_AddNewRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @proc_RowGuid , 'I' , @iInserts;
            PRINT 'TOTAL RECORDS INSERTED: ' + CAST ( @iInserts AS nvarchar ( 50)) ;

            --*******************************************************
            -- ADD UPDATED RECORDS
            --*******************************************************    	   
            DECLARE
            @iUpdates AS int = 0;
            EXEC @iUpdates = proc_CT_RewardTriggerParameters_AddUpdatedRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @proc_RowGuid , 'U' , @iUpdates;
            PRINT 'TOTAL RECORDS UPDATED: ' + CAST ( @iUpdates AS nvarchar ( 50)) ;

            --*******************************************************
            -- FIND DELETED ROWS
            --*******************************************************
            DECLARE
            @iDeletes AS int = 0;
            EXEC @iDeletes = proc_CT_RewardTriggerParameters_AddDeletedRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @proc_RowGuid , 'D' , @iDeletes;
            PRINT 'TOTAL RECORDS DELETED: ' + CAST ( @iDeletes AS nvarchar ( 50)) ;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM ##TEMP_RewardTriggerParameters) ;
            SET @STime = GETDATE () ;
            EXEC proc_EDW_CT_ExecutionLog_Update @proc_RowGuid , 'proc_EDW_RewardTriggerParameters' , @STime , @CNT_PulledRecords , 'U';

            SET @HRPART = DATEDIFF ( hour , @proc_starttime , GETDATE ()) ;
            SET @MINPART = DATEDIFF ( minute , @proc_starttime , GETDATE ()) % 60;
            SET @SECPART = DATEDIFF ( second , @proc_starttime , GETDATE ()) % 60;
            SET @TOTSECS = DATEDIFF ( second , @proc_starttime , GETDATE ()) ;

            PRINT 'TIME TO EXECUTE: ' + CAST ( @TOTSECS AS nvarchar ( 10)) ;
            PRINT 'TOTAL RECORDS ANALYZED: ' + CAST ( @PulledCnt AS nvarchar ( 20)) ;

            SET @proc_RowsProcessed = @PulledCnt;
            SET @PROC_LOCATION = 'End Of Run';
            SET @proc_endtime = GETDATE () ;
            EXEC proc_CT_Performance_History @proc_RowGuid , @CALLING_PROC , @PROC_LOCATION , @proc_starttime , @proc_endtime , @proc_elapsedsecs , @proc_RowsProcessed;

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardTriggerParameters';

            SET NOCOUNT OFF;

        END;
END;

GO
PRINT 'Created proc_EDW_RewardTriggerParameters';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "create_job_EDW_GetStagingData_RewardTriggerParameters.sql" \n 
--------------------------------------------------------------- 


--proc_EDW_RewardTriggerParameters
go
PRINT 'Creating JOB job_EDW_GetStagingData_RewardTriggerParameters' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_RewardTriggerParameters_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_EDW_RewardTriggerParameters]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_RewardTriggerParameters',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_RewardTriggerParameters',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_RewardTriggerParameters',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_RewardAwardDetail_CT.sql" \n 
--------------------------------------------------------------- 

go
-- use KenticoCMS_Prod1

GO
PRINT 'Processing: view_EDW_RewardAwardDetail_CT ';
PRINT '***** FROM: view_EDW_RewardAwardDetail_CT.sql';
GO
IF EXISTS (SELECT
				  TABLE_NAME
				  FROM INFORMATION_SCHEMA.VIEWS
				  WHERE TABLE_NAME = 'view_EDW_RewardAwardDetail_CT') 
	BEGIN
		DROP VIEW
			 view_EDW_RewardAwardDetail_CT;
	END;
GO
CREATE VIEW dbo.view_EDW_RewardAwardDetail_CT
AS

--*************************************************************************************************
--(WDM) 03.17.2015 modified for change tracking
--select * from view_EDW_RewardAwardDetail_CT
--*************************************************************************************************

SELECT DISTINCT
	   cu.UserGUID
	 , cs.SiteGUID
	 , cus.HFitUserMpiNumber
	 , RL_Joined.NodeGuid AS RewardLevelGUID
	 , RL_Joined.AwardType
	 , HFRAUD.AwardDisplayName
	 , HFRAUD.RewardValue
	 , HFRAUD.ThresholdNumber
	 , HFRAUD.UserNotified
	 , HFRAUD.IsFulfilled
	 , hfa.AccountID
	 , HFA.AccountCD
	 , CASE
		   WHEN CAST (HFRAUD.ItemCreatedWhen AS date) = CAST (HFRAUD.ItemModifiedWhen AS date) 
		   THEN 'I'
		   ELSE 'U'
	   END AS                ChangeType
	   ,hashbytes ('sha1',
		    + isnull(cast(cu.UserGUID as nvarchar(50)),'-')
		    + isnull(cast(cs.SiteGUID as nvarchar(50)),'-')
		    + isnull(cast(cus.HFitUserMpiNumber as nvarchar(50)),'-')
		    + isnull(cast(RL_Joined.NodeGuid as nvarchar(50)),'-')
		    + isnull(cast(RL_Joined.AwardType as nvarchar(100)),'-')
		    + isnull(cast(HFRAUD.AwardDisplayName as nvarchar(250)),'-')
		    + isnull(cast(HFRAUD.RewardValue as nvarchar(50)),'-')
		    + isnull(cast(HFRAUD.ThresholdNumber as nvarchar(50)),'-')
		    + isnull(cast(HFRAUD.UserNotified as nvarchar(50)),'-')
		    + isnull(cast(HFRAUD.IsFulfilled as nvarchar(50)),'-')
		    + isnull(cast(hfa.AccountID as nvarchar(50)),'-')
		    + isnull(cast(HFA.AccountCD as nvarchar(50)),'-')
		  ) as HashCode
	   , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM dbo.HFit_RewardsAwardUserDetail AS HFRAUD
				INNER JOIN dbo.View_HFit_RewardLevel_Joined AS RL_Joined
					ON hfraud.RewardLevelNodeId = RL_Joined.NodeID
				   AND RL_Joined.DocumentCulture = 'en-US'
				   AND HFRAUD.CultureCode = 'en-US'
				 INNER JOIN dbo.CMS_User AS CU
					ON hfraud.UserId = cu.UserID
				 INNER JOIN dbo.CMS_UserSite AS CUS2
					ON cu.UserID = cus2.UserID
				 INNER JOIN dbo.HFit_Account AS HFA
					ON cus2.SiteID = HFA.SiteID
				 INNER JOIN dbo.CMS_Site AS CS
					ON CUS2.SiteID = CS.SiteID
				 INNER JOIN dbo.CMS_UserSettings AS CUS
					ON cu.UserID = cus.UserSettingsUserID;
GO
PRINT 'Processed: view_EDW_RewardAwardDetail_CT ';

GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_STAGING_EDW_RewardAwardDetail.sql" \n 
--------------------------------------------------------------- 

/*---------------------------------------
***************************************
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
***************************************
*/

/*---------------------------------------
***************************************
exec proc_EDW_RewardAwardDetail 0
exec proc_EDW_RewardAwardDetail 1
***************************************
*/

GO

PRINT 'FROM proc_EDW_RewardAwardDetail.SQL';

PRINT 'Creating proc_EDW_RewardAwardDetail';

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE
                   name = 'proc_EDW_RewardAwardDetail') 

    BEGIN

        PRINT 'Replacing proc_EDW_RewardAwardDetail proc';

        DROP PROCEDURE
             proc_EDW_RewardAwardDetail;
    END;

GO

CREATE PROCEDURE proc_EDW_RewardAwardDetail
       @Reloadall int = 0
     , @TrackProgress int = 0
     , @KeepData AS bit = 0
AS
BEGIN

    SET NOCOUNT ON;

    DECLARE
    @Synchronization_Version bigint = 0
  , @CurrentDbVersion AS int
  , @STime AS datetime
  , @TgtView AS nvarchar ( 100) = 'view_EDW_RewardAwardDetail_CT'
  , @ExtractionDate AS datetime
  , @ExtractedVersion AS int
  , @ExtractedRowCnt AS int
  , @EndTime AS datetime
  , @CNT_PulledRecords AS int = 0
  , @iCnt AS int = 0
  , @RowNbr AS int = 0
  , @StartTime AS datetime = GETDATE () 
  , @SVRName AS nvarchar ( 100) 
  , @DBName AS nvarchar ( 100) = DB_NAME () 
  , @CNT_Insert AS int = 0
  , @CNT_Update AS int = 0
  , @CNT_Delete AS int = 0
  , @CNT_StagingTable int = 0
  , @VersionNBR int = 0;

    DECLARE
    @iTotal AS bigint = 0;
    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardAwardDetail';

    IF @iTotal = 1

        BEGIN

            SET @Reloadall = 1;
        END;

    SET @SVRName = ( SELECT
                            @@SERVERNAME) ;

    SET @STime = GETDATE () ;

    DECLARE
    @RecordID AS uniqueidentifier = NEWID () ;
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardAwardDetail' , @STime , 0 , 'I';

    IF @Reloadall = 1

        BEGIN

            IF EXISTS ( SELECT
                               NAME
                               FROM sys.tables
                               WHERE
                               name = 'DIM_EDW_RewardAwardDetail') 

                BEGIN

                    PRINT 'Dropping DIM_EDW_RewardAwardDetail for FULL reload.';

                    DROP TABLE
                         DIM_EDW_RewardAwardDetail;
                END;
            ELSE

                BEGIN

                    IF
                    @TrackProgress = 1

                        BEGIN

                            PRINT 'Reloading DIM_EDW_RewardAwardDetail.';
                        END;
                END;

            IF
            @TrackProgress = 1

                BEGIN

                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            IF @Reloadall = 1

                BEGIN

                    PRINT 'RELOADING ALL EDW HA Data.';

                    SELECT
                           * INTO
                                  DIM_EDW_RewardAwardDetail
                           FROM view_EDW_RewardAwardDetail_CT;
                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardAwardDetail';
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @@ROWCOUNT;

                    IF
                    @TrackProgress = 1

                        BEGIN

                            SET @iCnt = ( SELECT
                                                 COUNT ( *) 
                                                 FROM DIM_EDW_RewardAwardDetail) ;

                            PRINT DB_NAME () + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50)) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( *) 
                                                      FROM DIM_EDW_RewardAwardDetail) ;

                    SET @CNT_StagingTable = @CNT_PulledRecords;

                    IF NOT EXISTS ( SELECT
                                           name
                                           FROM sys.indexes
                                           WHERE
                                           name = 'PI_EDW_RewardAwardDetail_IDs') 

                        BEGIN

                            IF
                            @TrackProgress = 1

                                BEGIN

                                    PRINT 'Adding INDEX PI_EDW_RewardAwardDetail_IDs at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                                END;

                            CREATE NONCLUSTERED INDEX PI_EDW_RewardAwardDetail_IDs ON dbo.DIM_EDW_RewardAwardDetail ( UserGUID
                            , SiteGUID
                            , HFitUserMpiNumber
                            , RewardLevelGUID
                            , AwardType
                            , AwardDisplayName
                            , RewardValue
                            , ThresholdNumber
                            , UserNotified
                            , IsFulfilled
                            , AccountID
                            , AccountCD) 
                            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                        END;

                    SET @ExtractionDate = GETDATE () ;

                    SET @ExtractedVersion = -1;

                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( *) 
                                                    FROM DIM_EDW_RewardAwardDetail) ;

                    --SET @TgtView = 'view_EDW_RewardAwardDetail';

                    SET @EndTime = GETDATE () ;

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                         , ExtractedVersion
                         , CurrentDbVersion
                         , ExtractedRowCnt
                         , TgtView
                         , StartTime
                         , EndTime
                         , SVRName
                         , DBName
                         , CNT_Insert
                         , CNT_Update
                         , CNT_delete
                         , CNT_PulledRecords
                         , CNT_StagingTable
                    ) 
                    VALUES
                    (
                    @ExtractionDate ,
                    @ExtractedVersion ,
                    @CurrentDbVersion ,
                    @ExtractedRowCnt ,
                    @TgtView ,
                    @StartTime ,
                    @EndTime ,
                    @SVRName ,
                    @DBName ,
                    @CNT_Insert ,
                    @CNT_Update ,
                    @CNT_delete ,
                    @CNT_PulledRecords ,
                    @CNT_StagingTable) ;

                    IF
                    @TrackProgress = 1

                        BEGIN

                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                        END;
                END;

            -- SELECT * INTO [DIM_EDW_RewardAwardDetail] FROM [view_EDW_RewardAwardDetail_CT];

            IF
            @TrackProgress = 1

                BEGIN

                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            IF
            @TrackProgress = 1

                BEGIN

                    PRINT
                    'Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            SET @STime = GETDATE () ;
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardAwardDetail';
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardAwardDetail' , @STime , @CNT_PulledRecords , 'U';

            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                           FROM sys.tables
                           WHERE
                           name = 'DIM_EDW_RewardAwardDetail') 

        BEGIN

            PRINT '****************************************************************************';

            PRINT 'FATAL ERROR: table DIM_EDW_RewardAwardDetail was NOT found, aborting.';

            PRINT '****************************************************************************';
        END;
    ELSE

        BEGIN
            IF NOT EXISTS ( SELECT
                                   name
                                   FROM sys.indexes
                                   WHERE
                                   name = 'PI_EDW_RewardAwardDetail_IDs') 

                BEGIN

                    PRINT 'Adding INDEX PI_EDW_RewardAwardDetail_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_RewardAwardDetail_IDs ON dbo.DIM_EDW_RewardAwardDetail (
                    UserGUID
                    , SiteGUID
                    , HFitUserMpiNumber
                    , RewardLevelGUID
                    , AwardType
                    , AwardDisplayName
                    , RewardValue
                    , ThresholdNumber
                    , UserNotified
                    , IsFulfilled
                    , AccountID
                    , AccountCD) 
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                               FROM tempdb.dbo.sysobjects
                               WHERE
                               id = OBJECT_ID ( N'tempdb..#TEMP_EDW_RewardAwardDetail_DATA')) 

                BEGIN

                    PRINT 'Dropping #TEMP_EDW_RewardAwardDetail_DATA';

                    DROP TABLE
                         #TEMP_EDW_RewardAwardDetail_DATA;
                END;

/*---------------------------------------------------------------------------
***************************************************************************
*****************************************************************************
***************************************************************************
*/

            IF EXISTS ( SELECT
                               name
                               FROM sys.tables
                               WHERE
                               name = '#TEMP_EDW_RewardAwardDetail_DATA') 

                BEGIN

                    DROP TABLE
                         #TEMP_EDW_RewardAwardDetail_DATA;
                END;

            SELECT
                   * INTO
                          #TEMP_EDW_RewardAwardDetail_DATA
                   FROM view_EDW_RewardAwardDetail_CT;

            --WHERE CHANGED_FLG IS NOT NULL;

            ALTER TABLE #TEMP_EDW_RewardAwardDetail_DATA
            ADD
                        LastModifiedDate datetime NULL;

            ALTER TABLE #TEMP_EDW_RewardAwardDetail_DATA
            ADD
                        RowNbr  int NULL;

            ALTER TABLE #TEMP_EDW_RewardAwardDetail_DATA
            ADD
                        DeletedFlg  bit NULL;

            ALTER TABLE #TEMP_EDW_RewardAwardDetail_DATA
            ADD
                        ConvertedToCentralTime bit NULL;

            ALTER TABLE #TEMP_EDW_RewardAwardDetail_DATA
            ADD
                        TimeZone nvarchar ( 10) NULL;

            CREATE CLUSTERED INDEX temp_PI_EDW_RewardAwardDetail_IDs ON dbo.#TEMP_EDW_RewardAwardDetail_DATA (
            UserGUID
            , SiteGUID
            , HFitUserMpiNumber
            , RewardLevelGUID
            , AwardType
            , AwardDisplayName
            , RewardValue
            , ThresholdNumber
            , UserNotified
            , IsFulfilled
            , AccountID
            , AccountCD) 
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

            IF @KeepData = 1

                BEGIN

                    PRINT 'KEEPING TEMP DATA IN TABLE TEMP_EDW_RewardAwardDetail_DATA';

                    IF EXISTS ( SELECT
                                       name
                                       FROM sys.tables
                                       WHERE
                                       name = 'TEMP_EDW_RewardAwardDetail_DATA') 

                        BEGIN

                            DROP TABLE
                                 TEMP_EDW_RewardAwardDetail_DATA;
                        END;

                    SELECT
                           * INTO
                                  TEMP_EDW_RewardAwardDetail_DATA
                           FROM #TEMP_EDW_RewardAwardDetail_DATA;

                    CREATE CLUSTERED INDEX temp_PI_EDW_RewardAwardDetail_IDs ON TEMP_EDW_RewardAwardDetail_DATA (
                    UserGUID
                    , SiteGUID
                    , HFitUserMpiNumber
                    , RewardLevelGUID
                    , AwardType
                    , AwardDisplayName
                    , RewardValue
                    , ThresholdNumber
                    , UserNotified
                    , IsFulfilled
                    , AccountID
                    , AccountCD) 
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM #TEMP_EDW_RewardAwardDetail_DATA) ;

/*------------------------------------------------------------------------------------------------------------------------------------------------------------------
            delete from DIM_EDW_RewardAwardDetail where Hashcode  = (select top 1 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode desc)
*/
            DECLARE
            @iIns AS int = 0;
            EXEC @iIns = proc_CT_RewardAwardDetail_AddNewRecs ;
            PRINT 'ROWS Inserted: ' + CAST ( @iIns AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iIns;

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------
*****************************************************************************************************************************************************************
					   --declare oldhash varbinary(8000) = (select top 1 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode); 
					   --declare tgthash varbinary(8000) = (select top 1 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode desc);
					   update #TEMP_EDW_RewardAwardDetail_DATA set hashcode = (select top 1 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode desc)
					   where hashcode =  (select top 1 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode) ;

            --Check to see if CURRENT records have differnet HASH codes and if so, update the staging table
*****************************************************************************************************************************************************************
*/
exec @Icnt = proc_CT_RewardAwardDetail_AddUpdatedRecs ;

 

            DECLARE
            @iUpdt AS int = @@ROWCOUNT;

            PRINT 'UPDATE Count: ' + CAST ( @iUpdt  AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @@ROWCOUNT;

/*----------------------------------------------------------------------------------------------------------------------------------------------------------------
****************************************************************************************************************************************************************
************************************************************************************************
FIND DELETED ROWS
delete from #TEMP_EDW_RewardAwardDetail_DATA where hashcode in (select top 5 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode) ;
******************************************************************************************************************************************************************
****************************************************************************************************************************************************************
*/
            DECLARE
            @idel AS int = @@ROWCOUNT;
		  exec @idel = proc_CT_RewardAwardDetail_AddNewRecs ;

            PRINT 'DELETED Count: ' + CAST ( @idel AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @@ROWCOUNT;

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( *) 
                                             FROM DIM_EDW_RewardAwardDetail) ;

            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
                   WHERE
                         RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
                   WHERE
                         RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM #TEMP_EDW_RewardAwardDetail_DATA) ;
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardAwardDetail';

            SET @STime = GETDATE () ;
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardAwardDetail' , @STime , @CNT_PulledRecords , 'U';
        END;

    SET NOCOUNT OFF;
END;

GO

PRINT 'Created proc_EDW_RewardAwardDetail';

GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "create_job_EDW_GetStagingData_RewardAwardDetail.sql" \n 
--------------------------------------------------------------- 


--proc_EDW_RewardAwardDetail
GO
PRINT 'Creating JOB job_EDW_GetStagingData_RewardAwardDetail';
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE
                      name = N'[Uncategorized (Local)]'
                  AND
                      category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF
               @@ERROR <> 0
            OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback;
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_RewardAwardDetail_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1;
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;

/****** Object:  Step [Load_EDW_RewardAwardDetail]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_RewardAwardDetail',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_RewardAwardDetail',
@database_name = @TGTDB,
@flags = 0;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_RewardAwardDetail',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_RewardAwardDetail_STAGED.sql" \n 
--------------------------------------------------------------- 

go
print 'Creating view_EDW_RewardAwardDetail_STAGED';
go
if exists (select name from sys.views where name = 'view_EDW_RewardAwardDetail_STAGED')
begin
    drop view view_EDW_RewardAwardDetail_STAGED;
end
go
create view view_EDW_RewardAwardDetail_STAGED
as 
SELECT [UserGUID]
      ,[SiteGUID]
      ,[HFitUserMpiNumber]
      ,[RewardLevelGUID]
      ,[AwardType]
      ,[AwardDisplayName]
      ,[RewardValue]
      ,[ThresholdNumber]
      ,[UserNotified]
      ,[IsFulfilled]
      ,[AccountID]
      ,[AccountCD]
      ,[ChangeType]
      ,[HashCode]
      ,[LastModifiedDate]
      ,[RowNbr]
      ,[DeletedFlg]
  FROM [STAGING_EDW_RewardAwardDetail]
GO
print 'Created view_EDW_RewardAwardDetail_STAGED';
go


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_RewardUserLevel_CT.SQL" \n 
--------------------------------------------------------------- 

go
-- use KenticoCMS_Prod1

GO
PRINT 'Creating view view_EDW_RewardUserLevel_CT';
PRINT '***** FROM: view_EDW_RewardUserLevel_CT.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE
                   name = 'view_EDW_RewardUserLevel_CT') 
    BEGIN
        DROP VIEW
             view_EDW_RewardUserLevel_CT;
    END;
GO

CREATE VIEW view_EDW_RewardUserLevel_CT
AS

/***************************************************************************************************
Changes:
04.17.2015 (WDM) Converted to provide Change Tracking

select top 1000 * from view_EDW_RewardUserLevel_CT

select count(*), HashCode from view_EDW_RewardUserLevel_CT group by HashCode having count(*) > 1

select count(*), 
       UserId
     , LevelCompletedDt
     , LevelName
     , SiteName
     , nodeguid
     , SiteGuid
     --, LevelHeader
     --, GroupHeadingText
     --, GroupHeadingDescription
from view_EDW_RewardUserLevel_CT 
group by UserId
     , LevelCompletedDt
     , LevelName
     , SiteName
     , nodeguid
     , SiteGuid
     --, LevelHeader
     --, GroupHeadingText
     --, GroupHeadingDescription
having count(*) > 1

***************************************************************************************************/

SELECT DISTINCT
       us.UserId
     , dl.LevelCompletedDt
     , RL_Joined.NodeName AS LevelName
     , s.SiteName
     , RL_Joined.nodeguid
     , s.SiteGuid
     , RL_Joined.LevelHeader
     , RL_Joined.GroupHeadingText
     , RL_Joined.GroupHeadingDescription
     , HASHBYTES ('sha1',
       ISNULL (CAST (us.UserId AS nvarchar (50)) , '--') + ISNULL (CAST (dl.LevelCompletedDt AS nvarchar (50)) , '--') + ISNULL (CAST (RL_Joined.NodeName AS nvarchar (250)) , '--') + ISNULL (CAST (s.SiteName AS nvarchar (250)) , '--') + ISNULL (CAST (RL_Joined.nodeguid AS nvarchar (50)) , '--') + ISNULL (CAST (s.SiteGuid AS nvarchar (50)) , '--') + ISNULL (CAST (RL_Joined.LevelHeader  AS nvarchar (250)) , '--') + ISNULL (CAST (LEFT (RL_Joined.GroupHeadingText, 1000) AS nvarchar (2000)) , '-') + ISNULL (CAST (LEFT (RL_Joined.GroupHeadingDescription, 2000) AS nvarchar (2000)) , '-') 
       ) AS HashCode
       , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
           HFit_RewardsUserLevelDetail AS dl
               INNER JOIN View_HFit_RewardLevel_Joined AS RL_Joined
                   ON
                      RL_Joined.NodeId = dl.LevelNodeId
				    AND RL_Joined.DocumentCulture= 'EN-US'
                 JOIN CMS_UserSite AS us
                   ON
                      us.UserId = dl.UserId
                 JOIN CMS_Site AS s
                   ON
                      s.SiteId = us.SiteId;

GO

PRINT 'Created view view_EDW_RewardUserLevel_CT';

GO 

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_STAGING_EDW_RewardUserLevel.SQL" \n 
--------------------------------------------------------------- 

/*
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'FROM proc_EDW_RewardUserLevel.SQL';
PRINT 'Creating proc_EDW_RewardUserLevel';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_RewardUserLevel' )
    BEGIN
        PRINT 'Replacing proc_EDW_RewardUserLevel proc';
        DROP PROCEDURE
             proc_EDW_RewardUserLevel;
    END;
GO

/*
exec proc_EDW_RewardUserLevel 1,1,0
exec proc_EDW_RewardUserLevel 1,1,1
exec proc_EDW_RewardUserLevel 1,0,1

exec proc_EDW_RewardUserLevel 0,1,0
exec proc_EDW_RewardUserLevel 0,1,1
exec proc_EDW_RewardUserLevel 0,0,1
*/

CREATE PROCEDURE proc_EDW_RewardUserLevel
@Reloadall int = 0
, @TrackProgress int = 0
, @KeepData AS bit = 0
AS
BEGIN


    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardUserLevel';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;


    DECLARE
       @Synchronization_Version bigint = 0
       ,@CurrentDbVersion AS int
       ,@STime AS datetime
       ,@TgtView AS nvarchar ( 100 ) = 'view_EDW_RewardUserLevel_CT'
       ,@ExtractionDate AS datetime
       ,@ExtractedVersion AS int
       ,@ExtractedRowCnt AS int
       ,@EndTime AS datetime
       ,@CNT_PulledRecords AS int = 0
       ,@iCnt AS int = 0
       ,@RowNbr AS int = 0
       ,@StartTime AS datetime = GETDATE ( )
       ,@SVRName AS nvarchar ( 100 )
       ,@DBName AS nvarchar ( 100 ) = DB_NAME ( )
       ,@CNT_Insert AS int = 0
       ,@CNT_Update AS int = 0
       ,@CNT_Delete AS int = 0
       ,@CNT_StagingTable int = 0
       ,@VersionNBR int = 0;

    SET @SVRName = ( SELECT
                            @@SERVERNAME );

    SET @STime = GETDATE ( );

    DECLARE
       @RecordID AS uniqueidentifier = NEWID ( );
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardUserLevel' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                          FROM sys.tables
                          WHERE name = 'DIM_EDW_RewardUserLevel' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_EDW_RewardUserLevel for FULL reload.';
                        END;
                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    DROP TABLE
                         DIM_EDW_RewardUserLevel;
                END;
            ELSE
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading DIM_EDW_RewardUserLevel.';
                        END;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL EDW HA Data.';

                    SELECT
                           * INTO
                                  DIM_EDW_RewardUserLevel
                      FROM view_EDW_RewardUserLevel_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardUserLevel';

                    IF @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( * )
                                            FROM DIM_EDW_RewardUserLevel );
                            PRINT DB_NAME ( ) + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50 )) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( * )
                                                 FROM DIM_EDW_RewardUserLevel );
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @@ROWCOUNT;
                    SET @CNT_StagingTable = @CNT_PulledRecords;

                    IF NOT EXISTS ( SELECT
                                           name
                                      FROM sys.indexes
                                      WHERE name = 'PI_EDW_RewardUserLevel_IDs' )
                        BEGIN
                            IF @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_RewardUserLevel_IDs at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                                END;
                            CREATE CLUSTERED INDEX PI_EDW_RewardUserLevel_IDs ON dbo.DIM_EDW_RewardUserLevel ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                        END;

                    SET @ExtractionDate = GETDATE ( );
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( * )
                                               FROM DIM_EDW_RewardUserLevel );
                    --SET @TgtView = 'view_EDW_RewardUserLevel';
                    SET @EndTime = GETDATE ( );

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                           ,ExtractedVersion
                           ,CurrentDbVersion
                           ,ExtractedRowCnt
                           ,TgtView
                           ,StartTime
                           ,EndTime
                           ,SVRName
                           ,DBName
                           ,CNT_Insert
                           ,CNT_Update
                           ,CNT_delete
                           ,CNT_PulledRecords
                           ,CNT_StagingTable )
                    VALUES
                    (
                    @ExtractionDate , @ExtractedVersion , @CurrentDbVersion , @ExtractedRowCnt , @TgtView , @StartTime , @EndTime , @SVRName , @DBName , @CNT_Insert , @CNT_Update , @CNT_delete , @CNT_PulledRecords , @CNT_StagingTable );

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;

                END;
            -- SELECT * INTO [DIM_EDW_RewardUserLevel] FROM [view_EDW_RewardUserLevel_CT];
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserLevel';
            SET @STime = GETDATE ( );
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardUserLevel' , @STime , @CNT_PulledRecords , 'U';
            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                      FROM sys.tables
                      WHERE name = 'DIM_EDW_RewardUserLevel' )
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_RewardUserLevel was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            --IF NOT EXISTS ( SELECT
            --                name
            --                  FROM sys.indexes
            --                  WHERE name = 'PI_EDW_RewardUserLevel_IDs') 
            --    BEGIN
            --        IF @TrackProgress = 1
            --            BEGIN
            --                PRINT 'Adding INDEX PI_EDW_RewardUserLevel_IDs';
            --            END;
            --        CREATE NONCLUSTERED INDEX PI_EDW_RewardUserLevel_IDs ON dbo.DIM_EDW_RewardUserLevel ( ItemCreatedWhen ASC , ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC , HAUserQuestion_ItemModifiedWhen ASC , HAUserAnswers_ItemModifiedWhen ASC) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
            --    END;

            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_EDW_RewardUserLevel_IDs' )
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_RewardUserLevel_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_RewardUserLevel_IDs ON dbo.DIM_EDW_RewardUserLevel ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                          FROM tempdb.dbo.sysobjects
                          WHERE id = OBJECT_ID ( N'tempdb..#DIM_TEMPTBL_EDW_RewardUserLevel_DATA' ))

                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping #DIM_TEMPTBL_EDW_RewardUserLevel_DATA';
                        END;
                    DROP TABLE
                         #DIM_TEMPTBL_EDW_RewardUserLevel_DATA;
                END;

            /*******************************************************************************/

            SELECT
                   * INTO
                          #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
              FROM view_EDW_RewardUserLevel_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

            ALTER TABLE #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
            ADD
                        LastModifiedDate datetime NULL;
            ALTER TABLE #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
            ADD
                        RowNbr int NULL;
            ALTER TABLE #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
            ADD
                        DeletedFlg bit NULL;

            CREATE CLUSTERED INDEX temp_PI_EDW_RewardUserLevel_IDs ON dbo.#DIM_TEMPTBL_EDW_RewardUserLevel_DATA ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

            IF @KeepData = 1
                BEGIN
                    PRINT 'KEEPING TEMP DATA IN TABLE DIM_TEMPTBL_EDW_RewardUserLevel_DATA';
                    IF EXISTS ( SELECT
                                       name
                                  FROM sys.tables
                                  WHERE name = 'DIM_TEMPTBL_EDW_RewardUserLevel_DATA' )
                        BEGIN
                            DROP TABLE
                                 DIM_TEMPTBL_EDW_RewardUserLevel_DATA;
                        END;

                    SELECT
                           * INTO
                                  DIM_TEMPTBL_EDW_RewardUserLevel_DATA
                      FROM #DIM_TEMPTBL_EDW_RewardUserLevel_DATA;

                    CREATE CLUSTERED INDEX temp_PI_EDW_RewardUserLevel_IDs ON DIM_TEMPTBL_EDW_RewardUserLevel_DATA ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM #DIM_TEMPTBL_EDW_RewardUserLevel_DATA );

            --select * from #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
            --update #DIM_TEMPTBL_EDW_RewardUserLevel_DATA set AnsDocumentGuid = '1B8A2611-B0BF-4555-B609-56CC7D4EFC38' where AnsDocumentGuid = '001FBF56-C327-490F-AA15-4EB6F595D47A' and AnsPOints = 15
            --update #DIM_TEMPTBL_EDW_RewardUserLevel_DATA set AnsDocumentGuid = newid() where AnsDocumentGuid = 'C1D9949E-786D-42F7-8E31-0619D8ED60BD' and AnsPOints = 0
            WITH CTE (
                 UserId
                 ,LevelCompletedDt
                 ,LevelName
                 ,SiteName
                 ,nodeguid
                 ,SiteGuid )
                AS ( SELECT
                            UserId
                            ,LevelCompletedDt
                            ,LevelName
                            ,SiteName
                            ,nodeguid
                            ,SiteGuid
                       FROM #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
                     EXCEPT
                     SELECT
                            UserId
                            ,LevelCompletedDt
                            ,LevelName
                            ,SiteName
                            ,nodeguid
                            ,SiteGuid
                       FROM DIM_EDW_RewardUserLevel
                       WHERE LastModifiedDate IS NULL )
                INSERT INTO dbo.DIM_EDW_RewardUserLevel (
                       UserId
                       ,LevelCompletedDt
                       ,LevelName
                       ,SiteName
                       ,nodeguid
                       ,SiteGuid
                       ,LevelHeader
                       ,GroupHeadingText
                       ,GroupHeadingDescription
                       ,HashCode
                       ,LastModifiedDate
                       ,DeletedFlg )
                SELECT
                       T.UserId
                       ,T.LevelCompletedDt
                       ,T.LevelName
                       ,T.SiteName
                       ,T.nodeguid
                       ,T.SiteGuid
                       ,T.LevelHeader
                       ,T.GroupHeadingText
                       ,T.GroupHeadingDescription
                       ,T.HashCode
                       ,NULL AS LastModifiedDate
                       ,NULL AS DeletedFlg
                  FROM
                       #DIM_TEMPTBL_EDW_RewardUserLevel_DATA AS T JOIN CTE AS S
                       ON
                       S.UserId = T.UserId
                   AND S.LevelCompletedDt = T.LevelCompletedDt
                   AND S.LevelName = T.LevelName
                   AND S.SiteName = T.SiteName
                   AND S.nodeguid = T.nodeguid
                   AND S.SiteGuid = T.SiteGuid;

            DECLARE
               @iIns AS int = @@ROWCOUNT;
            PRINT 'Inset Count: ' + CAST ( @iIns AS nvarchar ( 50 ));
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iIns;

            --Check to see if CURRENT records have differnet HASH codes and if so, update the staging table
            SET @iCnt = ( SELECT
                                 COUNT ( * )
                            FROM
                                 DIM_EDW_RewardUserLevel AS S JOIN #DIM_TEMPTBL_EDW_RewardUserLevel_DATA AS T
                                 ON
                                 S.UserId = T.UserId
                             AND S.LevelCompletedDt = T.LevelCompletedDt
                             AND S.LevelName = T.LevelName
                             AND S.SiteName = T.SiteName
                             AND S.nodeguid = T.nodeguid
                             AND S.SiteGuid = T.SiteGuid
                            WHERE S.HashCode != T.HashCode );
            IF @iCnt > 0
                BEGIN
                    UPDATE S
                      SET
                          S.UserId = T.UserId
                          ,S.LevelCompletedDt = T.LevelCompletedDt
                          ,S.LevelName = T.LevelName
                          ,S.SiteName = T.SiteName
                          ,S.nodeguid = T.nodeguid
                          ,S.SiteGuid = T.SiteGuid
                          ,S.LevelHeader = T.LevelHeader
                          ,S.GroupHeadingText = T.GroupHeadingText
                          ,S.GroupHeadingDescription = T.GroupHeadingDescription
                          ,S.HashCode = T.HashCode
                          ,S.LastModifiedDate = GETDATE ( )
                          ,S.DeletedFlg = NULL
                          ,S.ConvertedToCentralTime = NULL
                      FROM DIM_EDW_RewardUserLevel AS S JOIN #DIM_TEMPTBL_EDW_RewardUserLevel_DATA AS T
                           ON
                           S.UserId = T.UserId
                       AND S.LevelCompletedDt = T.LevelCompletedDt
                       AND S.LevelName = T.LevelName
                       AND S.SiteName = T.SiteName
                       AND S.nodeguid = T.nodeguid
                       AND S.SiteGuid = T.SiteGuid
                      WHERE
                            T.HashCode != S.HashCode;

                    DECLARE
                       @iUpdt AS int = @@ROWCOUNT;
                    PRINT 'Update Count: ' + CAST ( @iUpdt AS nvarchar ( 50 ));
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdt;
                END;

/************************************************
		  FIND DELETED ROWS
		  ************************************************/

            WITH CTE (
                 UserId
                 ,LevelCompletedDt
                 ,LevelName
                 ,SiteName
                 ,nodeguid
                 ,SiteGuid )
                AS ( SELECT
                            UserId
                            ,LevelCompletedDt
                            ,LevelName
                            ,SiteName
                            ,nodeguid
                            ,SiteGuid
                       FROM DIM_EDW_RewardUserLevel
                     EXCEPT
                     SELECT
                            UserId
                            ,LevelCompletedDt
                            ,LevelName
                            ,SiteName
                            ,nodeguid
                            ,SiteGuid
                       FROM #DIM_TEMPTBL_EDW_RewardUserLevel_DATA )
                UPDATE S
                  SET
                      S.DeletedFlg = 1
                  FROM CTE AS T JOIN DIM_EDW_RewardUserLevel AS S
                       ON
                       S.UserId = T.UserId
                   AND S.LevelCompletedDt = T.LevelCompletedDt
                   AND S.LevelName = T.LevelName
                   AND S.SiteName = T.SiteName
                   AND S.nodeguid = T.nodeguid
                   AND S.SiteGuid = T.SiteGuid;

            DECLARE
               @iDel AS int = @@ROWCOUNT;
            PRINT 'Update Count: ' + CAST ( @iDel AS nvarchar ( 50 ));
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDel;

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( * )
                                        FROM DIM_EDW_RewardUserLevel );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
              WHERE
                    RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM #DIM_TEMPTBL_EDW_RewardUserLevel_DATA );
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserLevel';
            SET @STime = GETDATE ( );
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardUserLevel' , @STime , @CNT_PulledRecords , 'U';

        END;
END;

GO
PRINT 'Created proc_EDW_RewardUserLevel';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "create_job_EDW_GetStagingData_RewardUserLevel.SQL" \n 
--------------------------------------------------------------- 


--proc_EDW_RewardUserLevel
GO
PRINT 'Creating JOB job_EDW_GetStagingData_RewardUserLevel';
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE
                      name = N'[Uncategorized (Local)]'
                  AND
                      category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF
               @@ERROR <> 0
            OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback;
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_RewardUserLevel_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1;
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;

/****** Object:  Step [Load_EDW_RewardUserLevel]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_RewardUserLevel',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_RewardUserLevel',
@database_name = @TGTDB,
@flags = 0;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_RewardUserLevel',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_RewardUserLevel_STAGED.sql" \n 
--------------------------------------------------------------- 


GO
PRINT 'Creating view_EDW_RewardUserLevel_STAGED';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE
                        name = 'view_EDW_RewardUserLevel_STAGED') 
    BEGIN
        DROP VIEW
             view_EDW_RewardUserLevel_STAGED;
    END;
GO

CREATE VIEW view_EDW_RewardUserLevel_STAGED
AS SELECT
 [UserId]
      ,[LevelCompletedDt]
      ,[LevelName]
      ,[SiteName]
      ,[nodeguid]
      ,[SiteGuid]
      ,[LevelHeader]
      ,[GroupHeadingText]
      ,[GroupHeadingDescription]
          FROM dbo.STAGING_EDW_RewardUserLevel;
GO

PRINT 'Created view_EDW_RewardUserLevel_STAGED';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_Coaches_CT.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1

print ('Processing: view_EDW_Coaches_CT ') ;
go

if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_Coaches_CT')
BEGIN
	drop view view_EDW_Coaches_CT ;
END
GO

/****************************************************
WDM Verified last mod date available to EDW 9.10.2014

select count(*) from view_EDW_Coaches_CT
select * from view_EDW_Coaches_CT

select count(*), HashCode
from view_EDW_Coaches_CT
group by HashCode 
having count(*) > 1

select * from view_EDW_Coaches_CT
where UserGuid in ('92281FC6-565B-4657-BBC0-D250BE87F59A','DC60654C-8796-4789-B0A0-FC359215BB7B')

select count(*), 
    UserGUID
    ,SiteGUID
    ,AccountID
    ,AccountCD
    ,CoachID
    ,email   
from [view_EDW_Coaches_CT]
group by 
UserGUID
   ,SiteGUID
   ,AccountID
   ,AccountCD
   ,CoachID
   ,email   
having count(*) > 1

****************************************************/
CREATE VIEW [dbo].[view_EDW_Coaches_CT]

AS

SELECT distinct
    cu.UserGUID
   ,cs.SiteGUID
   ,HFA.AccountID
   ,HFA.AccountCD
   ,CoachID
   ,hfc.LastName
   ,hfc.FirstName
   ,hfc.StartDate
   ,hfc.Phone
   ,hfc.email
   ,hfc.Supervisor
   ,hfc.SuperCoach
   ,hfc.MaxParticipants
   ,hfc.Inactive
   ,hfc.MaxRiskLevel
   ,hfc.Locked
   ,hfc.TimeLocked
   ,hfc.terminated
   ,hfc.APMaxParticipants
   ,hfc.RNMaxParticipants
   ,hfc.RNPMaxParticipants
   ,hfc.Change_Type
   ,hfc.Last_Update_Dt
,hashbytes ('sha1',
    isnull(cast(cu.UserGUID as nvarchar(100)),'-')
   + isnull(cast(cs.SiteGUID as nvarchar(100)),'-')
   + isnull(cast(HFA.AccountID as nvarchar(100)),'-')
   + isnull(cast(HFA.AccountCD as nvarchar(100)),'-')
   + isnull(cast(CoachID as nvarchar(100)),'-')
   + isnull(cast(hfc.LastName as nvarchar(250)),'-')
   + isnull(cast(hfc.FirstName as nvarchar(250)),'-')
   + isnull(cast(hfc.StartDate as nvarchar(100)),'-')
   + isnull(cast(hfc.Phone as nvarchar(100)),'-')
   + isnull(cast(hfc.email as nvarchar(250)),'-')
   + isnull(cast(hfc.Supervisor as nvarchar(100)),'-')
   + isnull(cast(hfc.SuperCoach as nvarchar(100)),'-')
   + isnull(cast(hfc.MaxParticipants as nvarchar(100)),'-')
   + isnull(cast(hfc.Inactive as nvarchar(100)),'-')
   + isnull(cast(hfc.MaxRiskLevel as nvarchar(100)),'-')
   + isnull(cast(hfc.Locked as nvarchar(100)),'-')
   + isnull(cast(hfc.TimeLocked as nvarchar(100)),'-')
   + isnull(cast(hfc.terminated as nvarchar(100)),'-')
   + isnull(cast(hfc.APMaxParticipants as nvarchar(100)),'-')
   + isnull(cast(hfc.RNMaxParticipants as nvarchar(100)),'-')
   + isnull(cast(hfc.RNPMaxParticipants as nvarchar(100)),'-')
   + isnull(cast(hfc.Last_Update_Dt as nvarchar(100)),'-')
) as HashCode
, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
    dbo.HFit_Coaches AS HFC
LEFT OUTER JOIN dbo.CMS_User AS CU ON hfc.KenticoUserID = cu.UserID
LEFT OUTER JOIN dbo.CMS_UserSite AS CUS ON cu.userid = cus.UserID
LEFT OUTER JOIN dbo.CMS_Site AS CS ON CS.SiteID = CUS.SiteID
LEFT OUTER JOIN dbo.HFit_Account AS HFA ON cs.SiteID = hfa.SiteID

GO


  --  
  --  
GO 
print('***** FROM: view_EDW_Coaches_CT.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_STAGING_EDW_Coaches.sql" \n 
--------------------------------------------------------------- 

/*
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'FROM proc_EDW_Coaches.SQL';
PRINT 'Creating proc_EDW_Coaches';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE
              name = 'proc_EDW_Coaches' )
    BEGIN
        PRINT 'Replacing proc_EDW_Coaches proc';
        DROP PROCEDURE
             proc_EDW_Coaches;
    END;
GO

/*
exec proc_EDW_Coaches 1,1,0
exec proc_EDW_Coaches 1,1,1
exec proc_EDW_Coaches 1,0,1

exec proc_EDW_Coaches 0,1,0
exec proc_EDW_Coaches 0,1,1
exec proc_EDW_Coaches 0,0,1
*/

CREATE PROCEDURE proc_EDW_Coaches
@Reloadall int = 0
, @TrackProgress int = 0
, @KeepData AS bit = 0
AS
BEGIN
set nocount on ;
    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_Coaches';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

    DECLARE
       @Synchronization_Version bigint = 0
       ,@CurrentDbVersion AS int
       ,@STime AS datetime
       ,@TgtView AS nvarchar ( 100 ) = 'view_EDW_Coaches_CT'
       ,@ExtractionDate AS datetime
       ,@ExtractedVersion AS int
       ,@ExtractedRowCnt AS int
       ,@EndTime AS datetime
       ,@CNT_PulledRecords AS int = 0
       ,@iCnt AS int = 0
       ,@RowNbr AS int = 0
       ,@StartTime AS datetime = GETDATE ( )
       ,@SVRName AS nvarchar ( 100 )
       ,@DBName AS nvarchar ( 100 ) = DB_NAME ( )
       ,@CNT_Insert AS int = 0
       ,@CNT_Update AS int = 0
       ,@CNT_Delete AS int = 0
       ,@CNT_StagingTable int = 0
       ,@VersionNBR int = 0;

    SET @SVRName = ( SELECT
                            @@SERVERNAME );

    SET @STime = GETDATE ( );

    DECLARE
       @RecordID AS uniqueidentifier = NEWID ( );
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_Coaches' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                          FROM sys.tables
                          WHERE
                          name = 'DIM_EDW_Coaches' )
                BEGIN
                    IF
                    @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_EDW_Coaches for FULL reload.';
                        END;
                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    DROP TABLE
                         DIM_EDW_Coaches;
                END;
            ELSE
                BEGIN
                    IF
                    @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading DIM_EDW_Coaches.';
                        END;
                END;
            IF
            @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL Coaches.';

                    SELECT
                           * INTO
                                  DIM_EDW_Coaches
                      FROM view_EDW_Coaches_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_Coaches';

                    IF
                    @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( * )
                                            FROM DIM_EDW_Coaches );
                            PRINT DB_NAME ( ) + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50 )) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( * )
                                                 FROM DIM_EDW_Coaches );
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                      FROM sys.indexes
                                      WHERE
                                      name = 'PI_EDW_Coaches_IDs' )
                        BEGIN
                            IF
                            @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_Coaches_IDs at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                                END;
                            CREATE CLUSTERED INDEX PI_EDW_Coaches_IDs ON dbo.DIM_EDW_Coaches (
                            UserGUID
                            , SiteGUID
                            , AccountID
                            , AccountCD
                            , CoachID
                            , email
                            )
                            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                        END;

                    SET @ExtractionDate = GETDATE ( );
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( * )
                                               FROM DIM_EDW_Coaches );
                    --SET @TgtView = 'view_EDW_Coaches';
                    SET @EndTime = GETDATE ( );

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                           ,ExtractedVersion
                           ,CurrentDbVersion
                           ,ExtractedRowCnt
                           ,TgtView
                           ,StartTime
                           ,EndTime
                           ,SVRName
                           ,DBName
                           ,CNT_Insert
                           ,CNT_Update
                           ,CNT_delete
                           ,CNT_PulledRecords
                           ,CNT_StagingTable
                    )
                    VALUES
                    (
                    @ExtractionDate ,
                    @ExtractedVersion ,
                    @CurrentDbVersion ,
                    @ExtractedRowCnt ,
                    @TgtView ,
                    @StartTime ,
                    @EndTime ,
                    @SVRName ,
                    @DBName ,
                    @CNT_Insert ,
                    @CNT_Update ,
                    @CNT_delete ,
                    @CNT_PulledRecords ,
                    @CNT_StagingTable );

                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @@ROWCOUNT;

                    IF
                    @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;

                END;
            -- SELECT * INTO [DIM_EDW_Coaches] FROM [view_EDW_Coaches_CT];
            IF
            @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF
            @TrackProgress = 1
                BEGIN
                    PRINT
                    'Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Coaches';
            SET @STime = GETDATE ( );
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_Coaches' , @STime , @CNT_PulledRecords , 'U';
	   set nocount off ;
            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                      FROM sys.tables
                      WHERE
                      name = 'DIM_EDW_Coaches' )
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_Coaches was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            --IF NOT EXISTS ( SELECT
            --                name
            --                  FROM sys.indexes
            --                  WHERE name = 'PI_EDW_Coaches_IDs') 
            --    BEGIN
            --        IF @TrackProgress = 1
            --            BEGIN
            --                PRINT 'Adding INDEX PI_EDW_Coaches_IDs';
            --            END;
            --        CREATE NONCLUSTERED INDEX PI_EDW_Coaches_IDs ON dbo.DIM_EDW_Coaches ( ItemCreatedWhen ASC , ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC , HAUserQuestion_ItemModifiedWhen ASC , HAUserAnswers_ItemModifiedWhen ASC) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
            --    END;

            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE
                              name = 'PI_EDW_Coaches_IDs' )
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_Coaches_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_Coaches_IDs ON dbo.DIM_EDW_Coaches (
                    UserGUID
                    , SiteGUID
                    , AccountID
                    , AccountCD
                    , CoachID
                    , email )
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                          FROM tempdb.dbo.sysobjects
                          WHERE
                          id = OBJECT_ID ( N'tempdb..##DIM_TEMPTBL_EDW_Coaches_DATA' ))

                BEGIN
                    IF
                    @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping ##DIM_TEMPTBL_EDW_Coaches_DATA';
                        END;
                    DROP TABLE
                         ##DIM_TEMPTBL_EDW_Coaches_DATA;
                END;

            /*******************************************************************************/

            SELECT
                   * INTO
                          ##DIM_TEMPTBL_EDW_Coaches_DATA
              FROM view_EDW_Coaches_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

            ALTER TABLE ##DIM_TEMPTBL_EDW_Coaches_DATA
            ADD
                        LastModifiedDate datetime NULL;
            ALTER TABLE ##DIM_TEMPTBL_EDW_Coaches_DATA
            ADD
                        RowNbr  int NULL;
            ALTER TABLE ##DIM_TEMPTBL_EDW_Coaches_DATA
            ADD
                        DeletedFlg  bit NULL;

            CREATE CLUSTERED INDEX temp_PI_EDW_Coaches_IDs ON dbo.##DIM_TEMPTBL_EDW_Coaches_DATA (
            UserGUID
            , SiteGUID
            , AccountID
            , AccountCD
            , CoachID
            , email )
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

            IF @KeepData = 1
                BEGIN
                    PRINT 'KEEPING TEMP DATA IN TABLE DIM_TEMPTBL_EDW_Coaches_DATA';
                    IF EXISTS ( SELECT
                                       name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_TEMPTBL_EDW_Coaches_DATA' )
                        BEGIN
                            DROP TABLE
                                 DIM_TEMPTBL_EDW_Coaches_DATA;
                        END;

                    SELECT
                           * INTO
                                  DIM_TEMPTBL_EDW_Coaches_DATA
                      FROM ##DIM_TEMPTBL_EDW_Coaches_DATA;

                    CREATE CLUSTERED INDEX temp_PI_EDW_Coaches_IDs ON DIM_TEMPTBL_EDW_Coaches_DATA (
                    UserGUID
                    , SiteGUID
                    , AccountID
                    , AccountCD
                    , CoachID
                    , email )
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##DIM_TEMPTBL_EDW_Coaches_DATA );

/************************************************/
declare @iInserts as int = 0 ;
exec @iInserts = proc_CT_Coaching_AddNewRecs ;
EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iInserts;
/************************************************/
declare @iUpdates as int = 0 
exec @iUpdates = proc_CT_Coaching_AddUpdatedRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdates;
/************************************************/
declare @idels as int = 0 ;
exec @iUpdates = proc_CT_Coaching_AddDeletedRecs ;
/************************************************/

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( * )
                                        FROM DIM_EDW_Coaches );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
              WHERE
                    RowNbr = @RowNbr;

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @idels;
            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##DIM_TEMPTBL_EDW_Coaches_DATA );

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Coaches';
            SET @STime = GETDATE ( );
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_Coaches' , @STime , @CNT_PulledRecords , 'U';
set nocount off ;
        END;
END;

GO
PRINT 'Created proc_EDW_Coaches';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_Coaches_STAGED.sql" \n 
--------------------------------------------------------------- 


go
print ('Creating view_EDW_Coaches_STAGED');
go
if exists (select name from sys.views where name = 'view_EDW_Coaches_STAGED')
begin
    drop view view_EDW_Coaches_STAGED;
end
go

create view view_EDW_Coaches_STAGED
as
SELECT [UserGUID]
      ,[SiteGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[CoachID]
      ,[LastName]
      ,[FirstName]
      ,[StartDate]
      ,[Phone]
      ,[email]
      ,[Supervisor]
      ,[SuperCoach]
      ,[MaxParticipants]
      ,[Inactive]
      ,[MaxRiskLevel]
      ,[Locked]
      ,[TimeLocked]
      ,[terminated]
      ,[APMaxParticipants]
      ,[RNMaxParticipants]
      ,[RNPMaxParticipants]
      ,[Change_Type]
      ,[Last_Update_Dt]
      ,[HashCode]
      ,[LastModifiedDate]
      ,[RowNbr]
      ,[DeletedFlg]
  FROM [dbo].[STAGING_EDW_Coaches]
GO
print ('Created view_EDW_Coaches_STAGED');
go


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_CoachingDetail.sql" \n 
--------------------------------------------------------------- 

GO
print('***** FROM: view_EDW_CoachingDetail.sql'); 
go

print ('Processing: view_EDW_CoachingDetail ') ;
go

if exists(select NAME from sys.indexes where NAME = 'CI2_View_CMS_Tree_Joined_Regular')
BEGIN
    print ('ANALYZING index CI2_View_CMS_Tree_Joined_Regular');
	drop index View_CMS_Tree_Joined_Regular.CI2_View_CMS_Tree_Joined_Regular;
END
GO

if not exists(select NAME from sys.indexes where NAME = 'CI2_View_CMS_Tree_Joined_Regular')
BEGIN
    print ('Updating index CI2_View_CMS_Tree_Joined_Regular');

	SET ARITHABORT ON
	SET CONCAT_NULL_YIELDS_NULL ON
	SET QUOTED_IDENTIFIER ON
	SET ANSI_NULLS ON
	SET ANSI_PADDING ON
	SET ANSI_WARNINGS ON
	SET NUMERIC_ROUNDABORT OFF

	CREATE NONCLUSTERED INDEX [CI2_View_CMS_Tree_Joined_Regular] ON [dbo].[View_CMS_Tree_Joined_Regular]
(
	[ClassName] ASC,
	[DocumentForeignKeyValue],
	[DocumentCulture] ASC
)
INCLUDE ( 	[NodeID], [NodeGUID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

END
GO

-- select count(*) from view_EDW_CoachingDetail
if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_CoachingDetail')
BEGIN
	drop view view_EDW_CoachingDetail ;
END
GO

--GRANT SELECT
--	ON [dbo].[[view_EDW_CoachingDetail]]
--	TO [EDWReader_PRD]
--GO

/* TEST Queries
select * from [view_EDW_CoachingDetail]
select * from [view_EDW_CoachingDetail] where CloseReasonLKPID != 0
select count(*) from [view_EDW_CoachingDetail]
*/

create VIEW [dbo].[view_EDW_CoachingDetail]
AS
--********************************************************************************************
--8/7/2014 - added and commented out DocumentGuid in case needed later
--8/8/2014 - Generated corrected view in DEV (WDM)
-- Verified last mod date available to EDW 9.10.2014
-- 01.02.2014 (WDM) added column HFUG.CloseReasonLKPID in order to satisfy Story #47923
-- 01.06.2014 (WDM) Tested with team B and found that the data was being returned. Stipulating that 
--					we converted the inner join to left outer join dbo.HFit_GoalOutcome. This 
--					allows data to be returned with the meaning that if NULL HFGO.EvaluationDate
--					is returned, the GOAL may exist without any input/update from the coach or
--					PPT
-- 01.07.2014 (WDM) This also takes care of 47976
--********************************************************************************************
	SELECT	DISTINCT
		HFUG.ItemID
		, HFUG.ItemGUID
		, GJ.GoalID
		, HFUG.UserID
		, cu.UserGUID
		, cus.HFitUserMpiNumber
		, cs.SiteGUID
		, hfa.AccountID
		, hfa.AccountCD
		, hfa.AccountName
		, HFUG.IsCreatedByCoach
		, HFUG.BaselineAmount
		, HFUG.GoalAmount
		, Null As DocumentID
		, HFUG.GoalStatusLKPID
		, HFLGS.GoalStatusLKPName
		, cast(HFUG.EvaluationStartDate as datetime) as EvaluationStartDate
		, cast(HFUG.EvaluationEndDate as datetime) as EvaluationEndDate
		, cast(HFUG.GoalStartDate as datetime) as GoalStartDate
		, HFUG.CoachDescription
		, cast(HFGO.EvaluationDate as datetime) as EvaluationDate
		, HFGO.Passed
		, cast(HFGO.WeekendDate as datetime) as WeekendDate
		, CASE	WHEN CAST(HFUG.ItemCreatedWhen AS DATE) = CAST(HFUG.ItemModifiedWhen AS DATE)
				THEN 'I'
				ELSE 'U'
			END AS ChangeType
		, cast(HFUG.ItemCreatedWhen as datetime) as ItemCreatedWhen
		, cast(HFUG.ItemModifiedWhen as datetime) as ItemModifiedWhen
		, GJ.NodeGUID
		, HFUG.CloseReasonLKPID
		, GRC.CloseReason

	FROM
		dbo.HFit_UserGoal AS HFUG WITH ( NOLOCK )
	INNER JOIN (
					SELECT
						VHFGJ.GoalID
						, VHFGJ.NodeID
						, VHFGJ.NodeGUID
						, VHFGJ.DocumentCulture
						, VHFGJ.DocumentGuid
						, VHFGJ.DocumentModifiedWhen	--WDM added 9.10.2014
					FROM
						dbo.View_HFit_Goal_Joined AS VHFGJ WITH ( NOLOCK )
					UNION ALL
					SELECT
						VHFTGJ.GoalID
						, VHFTGJ.NodeID
						, VHFTGJ.NodeGUID
						, VHFTGJ.DocumentCulture
						, VHFTGJ.DocumentGuid
						, VHFTGJ.DocumentModifiedWhen	--WDM added 9.10.2014
					FROM
						dbo.View_HFit_Tobacco_Goal_Joined AS VHFTGJ WITH ( NOLOCK )
				) AS GJ ON hfug.NodeID = gj.NodeID and GJ.DocumentCulture = 'en-us'		
	left outer join dbo.HFit_GoalOutcome AS HFGO WITH ( NOLOCK ) ON HFUG.ItemID = HFGO.UserGoalItemID	
	INNER JOIN dbo.HFit_LKP_GoalStatus AS HFLGS WITH ( NOLOCK ) ON HFUG.GoalStatusLKPID = HFLGS.GoalStatusLKPID	
	INNER JOIN dbo.CMS_User AS CU WITH ( NOLOCK ) ON HFUG.UserID = cu.UserID
	INNER JOIN dbo.CMS_UserSettings AS CUS WITH ( NOLOCK ) ON CU.UserGUID = CUS.UserSettingsUserGUID
	INNER JOIN dbo.CMS_UserSite AS CUS2 WITH ( NOLOCK ) ON cu.UserID = CUS2.UserID	
	INNER JOIN dbo.CMS_Site AS CS WITH ( NOLOCK ) ON CUS2.SiteID = CS.SiteID
	INNER JOIN dbo.HFit_Account AS HFA WITH ( NOLOCK ) ON cs.SiteID = hfa.SiteID
	left outer join HFit_LKP_GoalCloseReason as GRC on GRC.CloseReasonID = HFUG.CloseReasonLKPID
GO

  --  
  --  
GO 
print('***** Created: view_EDW_CoachingDetail'); 
GO 

--Testing History
--1.1.2015: WDM Tested table creation, data entry, and view join
--Testing Criteria
--select * from HFit_LKP_GoalCloseReason
--select * from view_EDW_CoachingDetail
--select * from view_EDW_CoachingDetail where userid in (13470, 107, 13299) and CloseReasonLKPID != 0 
--select * from view_EDW_CoachingDetail where UserGUID = '9C7F1657-8568-4D5D-A797-C6AEEA86834F'
--select * from view_EDW_CoachingDetail where EvaluationDate is null 
--select * from view_EDW_CoachingDetail  where HFitUserMpiNumber in (6238677) and CloseReasonLKPID != 0 
--select * from HFit_UserGoal where UserGUID = '9C7F1657-8568-4D5D-A797-C6AEEA86834F'
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_CoachingDetail_CT.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1


GO
PRINT '***** FROM: view_EDW_CoachingDetail_CT.sql';
GO

PRINT 'Processing: view_EDW_CoachingDetail_CT ';
GO

--if exists(select NAME from sys.indexes where NAME = 'CI2_View_CMS_Tree_Joined_Regular')
--BEGIN
--    print ('ANALYZING index CI2_View_CMS_Tree_Joined_Regular');
--	drop index View_CMS_Tree_Joined_Regular.CI2_View_CMS_Tree_Joined_Regular;
--END
--GO

--if not exists(select NAME from sys.indexes where NAME = 'CI2_View_CMS_Tree_Joined_Regular')
--BEGIN
--    print ('Updating index CI2_View_CMS_Tree_Joined_Regular');

--	SET ARITHABORT ON
--	SET CONCAT_NULL_YIELDS_NULL ON
--	SET QUOTED_IDENTIFIER ON
--	SET ANSI_NULLS ON
--	SET ANSI_PADDING ON
--	SET ANSI_WARNINGS ON
--	SET NUMERIC_ROUNDABORT OFF

--	CREATE NONCLUSTERED INDEX [CI2_View_CMS_Tree_Joined_Regular] ON [dbo].[View_CMS_Tree_Joined_Regular]
--(
--	[ClassName] ASC,
--	[DocumentForeignKeyValue],
--	[DocumentCulture] ASC
--)
--INCLUDE ( 	[NodeID], [NodeGUID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--END
--GO

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
                  WHERE
                  TABLE_NAME = 'view_EDW_CoachingDetail_CT') 
    BEGIN
        DROP VIEW
             view_EDW_CoachingDetail_CT;
    END;
GO

--GRANT SELECT
--	ON [dbo].[[view_EDW_CoachingDetail_CT]]
--	TO [EDWReader_PRD]
--GO

/* TEST Queries
select * from [view_EDW_CoachingDetail_CT]
select * from [view_EDW_CoachingDetail_CT] where CloseReasonLKPID != 0
select count(*) from [view_EDW_CoachingDetail_CT]
*/

CREATE VIEW dbo.view_EDW_CoachingDetail_CT
AS

--********************************************************************************************

/*
select count(*),
	   ItemID
	   , ItemGUID
	   , GoalID
	   , UserID
	   , UserGUID
	   , HFitUserMpiNumber
	   , SiteGUID
	   , AccountID
	   , AccountCD
	   --, IsCreatedByCoach
	   , WeekendDate
	   , NodeGUID		
from [view_EDW_CoachingDetail_CT]
group by 
	   ItemID
	   , ItemGUID
	   , GoalID
	   , UserID
	   , UserGUID
	   , HFitUserMpiNumber
	   , SiteGUID
	   , AccountID
	   , AccountCD
	   --, IsCreatedByCoach
	   , WeekendDate
	   , NodeGUID		
having count(*) > 1
*/

SELECT	DISTINCT
       HFUG.ItemID
     , HFUG.ItemGUID
     , GJ.GoalID
     , HFUG.UserID
     , cu.UserGUID
     , cus.HFitUserMpiNumber
     , cs.SiteGUID
     , hfa.AccountID
     , hfa.AccountCD
     , hfa.AccountName
     , HFUG.IsCreatedByCoach
     , HFUG.BaselineAmount
     , HFUG.GoalAmount
     , NULL AS DocumentID
     , HFUG.GoalStatusLKPID
     , HFLGS.GoalStatusLKPName
     , HFUG.EvaluationStartDate
     , HFUG.EvaluationEndDate
     , HFUG.GoalStartDate
     , HFUG.CoachDescription
     , HFGO.EvaluationDate
     , HFGO.Passed
     , HFGO.WeekendDate
     , CASE
           WHEN
       CAST (HFUG.ItemCreatedWhen AS date) = CAST (HFUG.ItemModifiedWhen AS date) 
               THEN 'I'
           ELSE 'U'
       END AS ChangeType
     , HFUG.ItemCreatedWhen
     , HFUG.ItemModifiedWhen
     , GJ.NodeGUID
     , HFUG.CloseReasonLKPID
     , GRC.CloseReason
     , HASHBYTES ('sha1',
		  ISNULL (CAST (HFUG.ItemID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.ItemGUID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( GJ.GoalID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.UserID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( cu.UserGUID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( cus.HFitUserMpiNumber AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( cs.SiteGUID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( hfa.AccountID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( hfa.AccountCD AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( hfa.AccountName AS nvarchar (500)) , '-') 
		  + ISNULL (CAST ( HFUG.IsCreatedByCoach AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.BaselineAmount AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.GoalAmount AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.GoalStatusLKPID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFLGS.GoalStatusLKPName AS nvarchar (500)) , '-') 
		  + ISNULL (CAST ( HFUG.EvaluationStartDate AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.EvaluationEndDate AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.GoalStartDate AS nvarchar (100)) , '-') 
		  + ISNULL (LEFT (HFUG.CoachDescription, 1000) , '-') 
		  + ISNULL (CAST ( HFGO.EvaluationDate AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFGO.Passed AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFGO.WeekendDate AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.ItemCreatedWhen AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.ItemModifiedWhen AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( GJ.NodeGUID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.CloseReasonLKPID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( GRC.CloseReason AS nvarchar (100)) , '-') 
       ) AS HashCode
, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  
       FROM dbo.HFit_UserGoal AS HFUG WITH (NOLOCK) 
            INNER JOIN(
            SELECT
                   VHFGJ.GoalID
                 , VHFGJ.NodeID
                 , VHFGJ.NodeGUID
                 , VHFGJ.DocumentCulture
                 , VHFGJ.DocumentGuid
                 , VHFGJ.DocumentModifiedWhen	--WDM added 9.10.2014
                   FROM dbo.View_HFit_Goal_Joined AS VHFGJ WITH (NOLOCK) 
            UNION ALL
            SELECT
                   VHFTGJ.GoalID
                 , VHFTGJ.NodeID
                 , VHFTGJ.NodeGUID
                 , VHFTGJ.DocumentCulture
                 , VHFTGJ.DocumentGuid
                 , VHFTGJ.DocumentModifiedWhen	--WDM added 9.10.2014
                   FROM dbo.View_HFit_Tobacco_Goal_Joined AS VHFTGJ WITH (NOLOCK))AS GJ
                    ON
       hfug.NodeID = gj.NodeID
   AND GJ.DocumentCulture = 'en-us'
            LEFT OUTER JOIN dbo.HFit_GoalOutcome AS HFGO WITH (NOLOCK) 
                    ON HFUG.ItemID = HFGO.UserGoalItemID
            INNER JOIN dbo.HFit_LKP_GoalStatus AS HFLGS WITH (NOLOCK) 
                    ON HFUG.GoalStatusLKPID = HFLGS.GoalStatusLKPID
            INNER JOIN dbo.CMS_User AS CU WITH (NOLOCK) 
                    ON HFUG.UserID = cu.UserID
            INNER JOIN dbo.CMS_UserSettings AS CUS WITH (NOLOCK) 
                    ON CU.UserGUID = CUS.UserSettingsUserGUID
            INNER JOIN dbo.CMS_UserSite AS CUS2 WITH (NOLOCK) 
                    ON cu.UserID = CUS2.UserID
            INNER JOIN dbo.CMS_Site AS CS WITH (NOLOCK) 
                    ON CUS2.SiteID = CS.SiteID
            INNER JOIN dbo.HFit_Account AS HFA WITH (NOLOCK) 
                    ON cs.SiteID = hfa.SiteID
            LEFT OUTER JOIN HFit_LKP_GoalCloseReason AS GRC
                    ON GRC.CloseReasonID = HFUG.CloseReasonLKPID;
GO

--  
--  
GO
PRINT '***** Created: view_EDW_CoachingDetail_CT';
GO

--Testing History
--1.1.2015: WDM Tested table creation, data entry, and view join
--Testing Criteria
--select * from HFit_LKP_GoalCloseReason
--select * from view_EDW_CoachingDetail_CT
--select * from view_EDW_CoachingDetail_CT where userid in (13470, 107, 13299) and CloseReasonLKPID != 0 
--select * from view_EDW_CoachingDetail_CT where UserGUID = '9C7F1657-8568-4D5D-A797-C6AEEA86834F'
--select * from view_EDW_CoachingDetail_CT where EvaluationDate is null 
--select * from view_EDW_CoachingDetail_CT  where HFitUserMpiNumber in (6238677) and CloseReasonLKPID != 0 
--select * from HFit_UserGoal where UserGUID = '9C7F1657-8568-4D5D-A797-C6AEEA86834F'
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_STAGING_EDW_CoachingDetail.sql" \n 
--------------------------------------------------------------- 


go

--use KenticoCMS_Prod1

/*
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'FROM proc_EDW_CoachingDetail.SQL';
PRINT 'Creating proc_EDW_CoachingDetail';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_CoachingDetail' )
    BEGIN
        PRINT 'Replacing proc_EDW_CoachingDetail proc';
        DROP PROCEDURE
             proc_EDW_CoachingDetail;
    END;
GO

/*
exec proc_EDW_CoachingDetail 1,1,0
exec proc_EDW_CoachingDetail 1,1,1
exec proc_EDW_CoachingDetail 1,0,1

exec proc_EDW_CoachingDetail 0,1,0
exec proc_EDW_CoachingDetail 0,1,1
exec proc_EDW_CoachingDetail 0,0,1
*/

CREATE PROCEDURE proc_EDW_CoachingDetail
@Reloadall int = 0
, @TrackProgress int = 0
, @KeepData AS bit = 0
AS
BEGIN

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_CoachingDetail';

    IF @iTotal = 1
        BEGIN
            PRINT 'NO RECORDS FOUND IN STAGING TABLE - Reloading all.';
            SET @Reloadall = 1;
        END;

    DECLARE
       @Synchronization_Version bigint = 0
       ,@CurrentDbVersion AS int
       ,@STime AS datetime
       ,@TgtView AS nvarchar ( 100 ) = 'view_EDW_CoachingDetail_CT'
       ,@ExtractionDate AS datetime
       ,@ExtractedVersion AS int
       ,@ExtractedRowCnt AS int
       ,@EndTime AS datetime
       ,@CNT_PulledRecords AS int = 0
       ,@iCnt AS int = 0
       ,@RowNbr AS int = 0
       ,@StartTime AS datetime = GETDATE ( )
       ,@SVRName AS nvarchar ( 100 )
       ,@DBName AS nvarchar ( 100 ) = DB_NAME ( )
       ,@CNT_Insert AS int = 0
       ,@CNT_Update AS int = 0
       ,@CNT_Delete AS int = 0
       ,@CNT_StagingTable int = 0
       ,@VersionNBR int = 0;

    SET @SVRName = ( SELECT
                            @@SERVERNAME );

    SET @STime = GETDATE ( );

    DECLARE
       @RecordID AS uniqueidentifier = NEWID ( );
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_CoachingDetail' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                          FROM sys.tables
                          WHERE name = 'DIM_EDW_CoachingDetail' )
                BEGIN

                    PRINT 'Dropping DIM_EDW_CoachingDetail for FULL reload.';
                    DROP TABLE
                         DIM_EDW_CoachingDetail;
                END;
            ELSE
                BEGIN
                    PRINT 'Reloading DIM_EDW_CoachingDetail.';
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE
                          ( ) AS nvarchar ( 50 ));
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL EDW HA Data.';
                    SELECT
                           * INTO
                                  DIM_EDW_CoachingDetail
                      FROM view_EDW_CoachingDetail_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_CoachingDetail';

                    IF @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( * )
                                            FROM DIM_EDW_CoachingDetail );
                            PRINT DB_NAME ( ) + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt
                                  AS nvarchar ( 50 )) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( * )
                                                 FROM DIM_EDW_CoachingDetail );
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                      FROM sys.indexes
                                      WHERE name = 'PI_EDW_CoachingDetail_IDs' )
                        BEGIN
                            IF @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_CoachingDetail_IDs at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                                END;
                            CREATE CLUSTERED INDEX PI_EDW_CoachingDetail_IDs ON dbo.DIM_EDW_CoachingDetail ( ItemID
                            , ItemGUID
                            , GoalID
                            , UserGUID
                            , SiteGUID
                            , AccountID
                            , AccountCD
                            , WeekendDate
                            , NodeGUID )
                            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
                            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                        END;

                    SET @ExtractionDate = GETDATE ( );
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( * )
                                               FROM DIM_EDW_CoachingDetail );
                    --SET @TgtView = 'view_EDW_CoachingDetail';
                    SET @EndTime = GETDATE ( );

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                           ,ExtractedVersion
                           ,CurrentDbVersion
                           ,ExtractedRowCnt
                           ,TgtView
                           ,StartTime
                           ,EndTime
                           ,SVRName
                           ,DBName
                           ,CNT_Insert
                           ,CNT_Update
                           ,CNT_delete
                           ,CNT_PulledRecords
                           ,CNT_StagingTable )
                    VALUES
                    (
                    @ExtractionDate , @ExtractedVersion , @CurrentDbVersion , @ExtractedRowCnt , @TgtView , @StartTime , @EndTime , @SVRName ,
                    @DBName , @CNT_Insert , @CNT_Update , @CNT_delete , @CNT_PulledRecords , @CNT_StagingTable );

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;

                END;
            -- SELECT * INTO [DIM_EDW_CoachingDetail] FROM [view_EDW_CoachingDetail_CT];
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            SET @STime = GETDATE ( );
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_CoachingDetail';
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_CoachingDetail' , @STime , @CNT_PulledRecords , 'U';
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @CNT_PulledRecords;

            EXEC proc_CT_EDW_CoachingDetail_NoDups ;
            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                      FROM sys.tables
                      WHERE name = 'DIM_EDW_CoachingDetail' )
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_CoachingDetail was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            --IF NOT EXISTS ( SELECT
            --                name
            --                  FROM sys.indexes
            --                  WHERE name = 'PI_EDW_CoachingDetail_IDs') 
            --    BEGIN
            --        IF @TrackProgress = 1
            --            BEGIN
            --                PRINT 'Adding INDEX PI_EDW_CoachingDetail_IDs';
            --            END;
            --        CREATE NONCLUSTERED INDEX PI_EDW_CoachingDetail_IDs ON dbo.DIM_EDW_CoachingDetail ( ItemCreatedWhen ASC , ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC , HAUserQuestion_ItemModifiedWhen ASC , HAUserAnswers_ItemModifiedWhen ASC) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
            --    END;

            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_EDW_CoachingDetail_IDs' )
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_CoachingDetail_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_CoachingDetail_IDs ON dbo.DIM_EDW_CoachingDetail ( ItemID
                    , ItemGUID
                    , GoalID
                    , UserGUID
                    , SiteGUID
                    , AccountID
                    , AccountCD
                    , WeekendDate
                    , NodeGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF ,
                    SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                          FROM tempdb.dbo.sysobjects
                          WHERE id = OBJECT_ID ( N'tempdb..##TEMP_EDW_CoachingDetail_DATA' ))

                BEGIN
                            PRINT 'Dropping ##TEMP_EDW_CoachingDetail_DATA';
                    DROP TABLE
                         ##TEMP_EDW_CoachingDetail_DATA;
                END;

            /*******************************************************************************/

            SELECT
                   * INTO
                          ##TEMP_EDW_CoachingDetail_DATA
              FROM view_EDW_CoachingDetail_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

		  --EXEC proc_Add_EDW_CT_StdCols '##TEMP_EDW_CoachingDetail_DATA';
		  ALTER TABLE ##TEMP_EDW_CoachingDetail_DATA ADD LastModifiedDate datetime NULL;  
		  ALTER TABLE ##TEMP_EDW_CoachingDetail_DATA ADD RowNbr int NULL;  
		  ALTER TABLE ##TEMP_EDW_CoachingDetail_DATA add DeletedFlg bit NULL; 
		  ALTER TABLE ##TEMP_EDW_CoachingDetail_DATA add TimeZone nvarchar (10) NULL;  
		  ALTER TABLE ##TEMP_EDW_CoachingDetail_DATA add ConvertedToCentralTime bit NULL; 

            CREATE CLUSTERED INDEX temp_PI_EDW_CoachingDetail_IDs ON dbo.##TEMP_EDW_CoachingDetail_DATA ( ItemID
            , ItemGUID
            , GoalID
            , UserGUID
            , SiteGUID
            , AccountID
            , AccountCD
            , WeekendDate
            , NodeGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF ,
            SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

            IF @KeepData = 1
                BEGIN
                    PRINT 'KEEPING TEMP DATA IN TABLE TEMP_EDW_CoachingDetail_DATA';
                    IF EXISTS ( SELECT
                                       name
                                  FROM sys.tables
                                  WHERE name = 'TEMP_EDW_CoachingDetail_DATA' )
                        BEGIN
                            DROP TABLE
                                 TEMP_EDW_CoachingDetail_DATA;
                        END;

                    SELECT
                           * INTO
                                  TEMP_EDW_CoachingDetail_DATA
                      FROM ##TEMP_EDW_CoachingDetail_DATA;

                    CREATE CLUSTERED INDEX temp_PI_EDW_CoachingDetail_IDs ON TEMP_EDW_CoachingDetail_DATA ( ItemID
                    , ItemGUID
                    , GoalID
                    , UserGUID
                    , SiteGUID
                    , AccountID
                    , AccountCD
                    , WeekendDate
                    , NodeGUID ) WITH ( PAD_INDEX = OFF ,
                    STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##TEMP_EDW_CoachingDetail_DATA );

            --***************************************************************
            -- ADD NEW INSERTS
            DECLARE
               @iInsert AS int = 0;
            EXEC @iInsert = proc_CT_CoachingDetail_AddNewRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iInsert;

            --***************************************************************
            -- FIND UPDATES
            DECLARE
               @iUpdt AS int = 0;
            EXEC @iUpdt = proc_CT_CoachingDetail_AddUpdatedRecs ;
            PRINT 'Updated Count: ' + CAST ( @iUpdt AS nvarchar ( 50 ));

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdt;

            --***********************************************
            --FIND DELETED ROWS
            DECLARE
               @iDels AS int = 0;
            EXEC @iDels = proc_CT_CoachingDetail_AddDeletedRecs ;

            PRINT 'Deleted Count: ' + CAST ( @iDels AS nvarchar ( 50 ));

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDels;

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( * )
                                        FROM DIM_EDW_CoachingDetail );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
              WHERE
                    RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##TEMP_EDW_CoachingDetail_DATA );

            EXEC proc_CT_EDW_CoachingDetail_NoDups ;
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_CoachingDetail';
            SET @STime = GETDATE ( );
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_CoachingDetail' , @STime , @CNT_PulledRecords , 'U';

        END;
END;

GO
PRINT 'Created proc_EDW_CoachingDetail';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_CoachingDetail_STAGE.sql" \n 
--------------------------------------------------------------- 

GO
PRINT '***** FROM: view_EDW_CoachingDetail_STAGE.sql';
GO

PRINT 'Processing: view_EDW_CoachingDetail_STAGED ';
GO

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
                  WHERE TABLE_NAME = 'view_EDW_CoachingDetail_STAGED') 
    BEGIN
        DROP VIEW
             view_EDW_CoachingDetail_STAGED;
    END;
GO

--GRANT SELECT
--	ON [dbo].[[view_EDW_CoachingDetail_STAGED]]
--	TO [EDWReader_PRD]
--GO

/* TEST Queries
select * from [view_EDW_CoachingDetail_STAGED]
select * from [view_EDW_CoachingDetail_STAGED] where CloseReasonLKPID != 0
select count(*) from [view_EDW_CoachingDetail_STAGED]
*/

CREATE VIEW dbo.view_EDW_CoachingDetail_STAGED
AS SELECT
          ItemID
        , ItemGUID
        , GoalID
        , UserID
        , UserGUID
        , HFitUserMpiNumber
        , SiteGUID
        , AccountID
        , AccountCD
        , AccountName
        , IsCreatedByCoach
        , BaselineAmount
        , GoalAmount
        , DocumentID
        , GoalStatusLKPID
        , GoalStatusLKPName
        , EvaluationStartDate
        , EvaluationEndDate
        , GoalStartDate
        , CoachDescription
        , EvaluationDate
        , Passed
        , WeekendDate
        , ChangeType
        , ItemCreatedWhen
        , ItemModifiedWhen
        , NodeGUID
        , CloseReasonLKPID
        , CloseReason
          FROM STAGING_EDW_CoachingDetail;
GO
PRINT '***** Created: view_EDW_CoachingDetail_STAGED';
GO 

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "create_job_EDW_GetStagingData_CoachingDetail.sql" \n 
--------------------------------------------------------------- 


--proc_EDW_CoachingDetail
GO
PRINT 'Creating JOB job_EDW_GetStagingData_CoachingDetail';
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE
                      name = N'[Uncategorized (Local)]'
                  AND
                      category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF
               @@ERROR <> 0
            OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback;
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_CoachingDetail_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1;
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;

/****** Object:  Step [Load_EDW_CoachingDetail]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_CoachingDetail',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_CoachingDetail',
@database_name = @TGTDB,
@flags = 0;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_CoachingDetail',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_CT_ExecutionLog.sql" \n 
--------------------------------------------------------------- 

GO 
PRINT 'Creating view_EDW_CT_ExecutionLog';
PRINT 'FROM view_EDW_CT_ExecutionLog.sql';
GO
--exec sp_depends 'EDW_CT_ExecutionLog'
IF EXISTS( SELECT
                  name
             FROM sys.views
             WHERE name = 'view_EDW_CT_ExecutionLog' )
    BEGIN
        DROP VIEW
             view_EDW_CT_ExecutionLog
    END;
GO
CREATE VIEW view_EDW_CT_ExecutionLog
AS SELECT
          *
     FROM EDW_CT_ExecutionLog;
GO
PRINT 'CREATED view_EDW_CT_ExecutionLog';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_RewardsDefinition_CT.sql" \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_Prod1

GO
PRINT '***** FROM: view_EDW_RewardsDefinition_CT.sql';
GO
PRINT 'Processing: view_EDW_RewardsDefinition_CT:';
GO
IF EXISTS (SELECT
                  NAME
                  FROM sys.VIEWS
                  WHERE NAME = 'view_EDW_RewardsDefinition_CT') 
    BEGIN
        DROP VIEW
             view_EDW_RewardsDefinition_CT;
    END;
GO

--GRANT SELECT
--	ON [dbo].[view_EDW_RewardsDefinition_CT]
--	TO [EDWReader_PRD]
--GO

/*-------------------------------------------------

select top 100 * from view_EDW_RewardsDefinition_CT

select * 
into TEMP_view_EDW_RewardsDefinition_CT
from view_EDW_RewardsDefinition_CT
*/

CREATE VIEW dbo.view_EDW_RewardsDefinition_CT
AS
--select count(*) from view_EDW_RewardsDefinition_CT
SELECT DISTINCT
       cs.SiteGUID
     , HFA.AccountID
     , hfa.AccountCD
     , VHFRPJ.NodeGuid AS RewardProgramGUID
     , RewardProgramName
     , RewardProgramPeriodStart
     , RewardProgramPeriodEnd
     , VHFRGJ.NodeGuid AS RewardGroupGuid
     , GroupName
     , VHFRLJ.NodeGuid AS RewardLevelGuid
     , Level
     , RewardLevelTypeLKPName
     , AwardDisplayName
     , AwardType
     , AwardThreshold1
     , AwardThreshold2
     , AwardThreshold3
     , AwardThreshold4
     , AwardValue1
     , AwardValue2
     , AwardValue3
     , AwardValue4
     , ExternalFulfillmentRequired
     , VHFRAJ.NodeGuid AS RewardActivityGuid
     , VHFRAJ.ActivityName
     , VHFRAJ.ActivityFreqOrCrit
     , VHFRAJ.ActivityPoints
     , VHFRAJ.IsBundle
     , VHFRAJ.IsRequired
     , VHFRAJ.MaxThreshold
     , VHFRAJ.AwardPointsIncrementally
     , VHFRAJ.AllowMedicalExceptions
     , VHFRTJ.NodeGuid AS RewardTriggerGuid
     , HFLRT.RewardTriggerDynamicValue
     , TriggerName
     , VHFRTPJ.RewardTriggerParameterOperator
     , VHFRTPJ.NodeGuid AS RewardTriggerParmGUID --(WDM/NJ) added 03.03.2015     
     , VHFRTPJ.Value
     , CASE
           WHEN CAST (VHFRPJ.DocumentCreatedWhen AS date) = CAST (VHFRPJ.DocumentModifiedWhen AS date) 
               THEN 'I'
           ELSE 'U'
       END AS ChangeType
     , VHFRAJ.DocumentCulture AS DocumentCulture_VHFRAJ
     , VHFRPJ.DocumentCulture AS DocumentCulture_VHFRPJ
     , VHFRGJ.DocumentCulture AS DocumentCulture_VHFRGJ
     , VHFRLJ.DocumentCulture AS DocumentCulture_VHFRLJ
     , VHFRTPJ.DocumentCulture AS DocumentCulture_VHFRTPJ
     , LevelName
     , HASHBYTES ('sha1',
       ISNULL (CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL (CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL (CAST ( hfa.AccountCD AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRPJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (LEFT ( RewardProgramName, 250) , '-') + ISNULL (CAST ( RewardProgramPeriodStart AS nvarchar (50)) , '-') + ISNULL (CAST ( RewardProgramPeriodEnd AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRGJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (LEFT ( GroupName, 250) , '-') + ISNULL (CAST ( VHFRLJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST ( Level AS nvarchar (50)) , '-') + ISNULL (LEFT ( RewardLevelTypeLKPName, 250) , '-') + ISNULL (LEFT ( AwardDisplayName, 250) , '-') + ISNULL (CAST ( AwardType AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardThreshold1 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardThreshold2 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardThreshold3 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardThreshold4 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardValue1 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardValue2 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardValue3 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardValue4 AS nvarchar (50)) , '-') + ISNULL (CAST ( ExternalFulfillmentRequired AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (LEFT ( VHFRAJ.ActivityName, 250) , '-') + ISNULL (CAST ( VHFRAJ.ActivityFreqOrCrit AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.ActivityPoints AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.IsBundle AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.MaxThreshold AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.AwardPointsIncrementally AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.AllowMedicalExceptions AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRTJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST ( HFLRT.RewardTriggerDynamicValue AS nvarchar (50)) , '-') + ISNULL (LEFT ( TriggerName, 250) , '-') + ISNULL (CAST ( VHFRTPJ.RewardTriggerParameterOperator AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRTPJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRTPJ.Value AS nvarchar (50)) , '-') 
       ) AS HashCode
       FROM
           dbo.View_EDW_RewardProgram_Joined AS VHFRPJ
               INNER JOIN dbo.View_HFit_RewardGroup_Joined AS VHFRGJ
                   ON VHFRPJ.NodeID = VHFRGJ.NodeParentID
                  AND VHFRPJ.DocumentCulture = 'en-US'
                  AND VHFRGJ.DocumentCulture = 'en-US'
               INNER JOIN dbo.View_HFit_RewardLevel_Joined AS VHFRLJ
                   ON VHFRGJ.NodeID = VHFRLJ.NodeParentID
                  AND VHFRLJ.DocumentCulture = 'en-US'
               INNER JOIN dbo.HFit_LKP_RewardLevelType AS HFLRLT
                   ON VHFRLJ.LevelType = HFLRLT.RewardLevelTypeLKPID
               INNER JOIN dbo.View_HFit_RewardActivity_Joined AS VHFRAJ
                   ON VHFRLJ.NodeID = VHFRAJ.NodeParentID
                  AND VHFRAJ.DocumentCulture = 'en-US'
               LEFT OUTER JOIN HFit_LKP_RewardActivity AS LKPRA
                   ON LKPRA.RewardActivityLKPID = VHFRAJ.RewardActivityLKPID --Added 1.2.2015 for SR-47520
               INNER JOIN dbo.View_HFit_RewardTrigger_Joined AS VHFRTJ
                   ON VHFRAJ.NodeID = VHFRTJ.NodeParentID
                  AND VHFRTJ.DocumentCulture = 'en-US'
               INNER JOIN dbo.View_HFit_RewardTriggerParameter_Joined AS VHFRTPJ
                   ON vhfrtj.nodeid = vhfrtpj.nodeparentid
                  AND VHFRTPJ.DocumentCulture = 'en-US'
               INNER JOIN dbo.HFit_LKP_RewardTrigger AS HFLRT
                   ON VHFRTJ.RewardTriggerLKPID = HFLRT.RewardTriggerLKPID
               INNER JOIN dbo.CMS_Site AS CS
                   ON VHFRPJ.NodeSiteID = cs.SiteID
               INNER JOIN dbo.HFit_Account AS HFA
                   ON cs.SiteID = HFA.SiteID
               LEFT JOIN HFit_LKP_RewardTriggerParameterOperator AS LKPRTP
                   ON LKPRTP.RewardTriggerParameterOperatorLKPID = VHFRTPJ.RewardTriggerParameterOperator;

GO
PRINT 'Processed: view_EDW_RewardsDefinition_CT ';
GO
/*-------------------------------------------------
(WDM) Kept only these coulmns IAW CR-51005
SiteGUID 
AccountID
AccountCD 
RewardProgramGUID
RewardProgramName
RewardProgramPeriodStart
RewardProgramPeriodEnd
RewardGroupGUID
GroupName
RewardLevelGUID
Level
RewardLevelTypeLKPName
AwardDisplayName
AwardType
AwardThreshold1
AwardThreshold2
AwardThreshold3
AwardThreshold4
AwardValue1
AwardValue2
AwardValue3
AwardValue4
ExternalFulfillmentRequired
RewardActivityGUID
RewardActivityName	--VHFRAJ.ActivityName
ActivityFreqOrCrit
ActivityPoints
IsBundle
IsRequired
MaxThreshold
AwardPointsIncrementally
AllowMedicalExceptions
RewardTriggerGUID
RewardTriggerDynamicValue
TriggerName
RewardTriggerParameterOperator
RewardTriggerParameterGUID  --RewardTriggerParmGUID
Value
ChangeType
DocumentCulture_VHFRAJ
DocumentCulture_VHFRPJ
DocumentCulture_VHFRGJ
DocumentCulture_
DocumentCulture_VHFRTPJ
LevelName
*/
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_STAGING_EDW_RewardsDefinition.sql" \n 
--------------------------------------------------------------- 

go
-- use KenticoCMS_Prod1

/*
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'FROM proc_EDW_RewardsDefinition.SQL';
PRINT 'Creating proc_EDW_RewardsDefinition';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_RewardsDefinition' )
    BEGIN
        PRINT 'Replacing proc_EDW_RewardsDefinition proc';
        DROP PROCEDURE
             proc_EDW_RewardsDefinition;
    END;
GO

/*
exec proc_EDW_RewardsDefinition 1,1,0
exec proc_EDW_RewardsDefinition 1,1,1
exec proc_EDW_RewardsDefinition 1,0,1

exec proc_EDW_RewardsDefinition 0,1,0
exec proc_EDW_RewardsDefinition 0,1,1
exec proc_EDW_RewardsDefinition 0,0,1
*/

CREATE PROCEDURE proc_EDW_RewardsDefinition
@Reloadall int = 0
, @TrackProgress int = 0
, @KeepData AS bit = 0
AS
BEGIN

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardsDefinition';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;


    DECLARE
       @Synchronization_Version bigint = 0
       ,@CurrentDbVersion AS int
       ,@STime AS datetime
       ,@TgtView AS nvarchar ( 100 ) = 'view_EDW_RewardsDefinition_CT'
       ,@ExtractionDate AS datetime
       ,@ExtractedVersion AS int
       ,@ExtractedRowCnt AS int
       ,@EndTime AS datetime
       ,@CNT_PulledRecords AS int = 0
       ,@iCnt AS int = 0
       ,@RowNbr AS int = 0
       ,@StartTime AS datetime = GETDATE ( )
       ,@SVRName AS nvarchar ( 100 )
       ,@DBName AS nvarchar ( 100 ) = DB_NAME ( )
       ,@CNT_Insert AS int = 0
       ,@CNT_Update AS int = 0
       ,@CNT_Delete AS int = 0
       ,@CNT_StagingTable int = 0
       ,@VersionNBR int = 0;

    SET @SVRName = ( SELECT
                            @@SERVERNAME );

    SET @STime = GETDATE ( );

    DECLARE
       @RecordID AS uniqueidentifier = NEWID ( );
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardsDefinition' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                          FROM sys.tables
                          WHERE name = 'DIM_EDW_RewardsDefinition' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_EDW_RewardsDefinition for FULL reload.';
                        END;
                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    DROP TABLE
                         DIM_EDW_RewardsDefinition;
                END;
            ELSE
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading DIM_EDW_RewardsDefinition.';
                        END;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL RewardsDefinition Data.';

                    SELECT
                           * INTO
                                  DIM_EDW_RewardsDefinition
                      FROM view_EDW_RewardsDefinition_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardsDefinition';

                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @@ROWCOUNT;

                    IF @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( * )
                                            FROM DIM_EDW_RewardsDefinition );
                            PRINT DB_NAME ( ) + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50 )) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( * )
                                                 FROM DIM_EDW_RewardsDefinition );
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                      FROM sys.indexes
                                      WHERE name = 'PI_EDW_RewardsDefinition_IDs' )
                        BEGIN
                            IF @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_RewardsDefinition_IDs at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                                END;
                            CREATE CLUSTERED INDEX PI_EDW_RewardsDefinition_IDs ON dbo.DIM_EDW_RewardsDefinition ( SiteGUID , AccountID , AccountCD , RewardProgramGUID , RewardGroupGuid , RewardLevelGuid , RewardActivityGuid , RewardTriggerGuid , RewardTriggerParmGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                        END;

                    SET @ExtractionDate = GETDATE ( );
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( * )
                                               FROM DIM_EDW_RewardsDefinition );
                    --SET @TgtView = 'view_EDW_RewardsDefinition';
                    SET @EndTime = GETDATE ( );

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                           ,ExtractedVersion
                           ,CurrentDbVersion
                           ,ExtractedRowCnt
                           ,TgtView
                           ,StartTime
                           ,EndTime
                           ,SVRName
                           ,DBName
                           ,CNT_Insert
                           ,CNT_Update
                           ,CNT_delete
                           ,CNT_PulledRecords
                           ,CNT_StagingTable )
                    VALUES
                    (
                    @ExtractionDate , @ExtractedVersion , @CurrentDbVersion , @ExtractedRowCnt , @TgtView , @StartTime , @EndTime , @SVRName , @DBName , @CNT_Insert , @CNT_Update , @CNT_delete , @CNT_PulledRecords , @CNT_StagingTable );

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;

                END;
            -- SELECT * INTO [DIM_EDW_RewardsDefinition] FROM [view_EDW_RewardsDefinition_CT];
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            SET @STime = GETDATE ( );

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardsDefinition';

            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardsDefinition' , @STime , @CNT_PulledRecords , 'U';
            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                      FROM sys.tables
                      WHERE name = 'DIM_EDW_RewardsDefinition' )
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_RewardsDefinition was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN
            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_EDW_RewardsDefinition_IDs' )
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_RewardsDefinition_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_RewardsDefinition_IDs ON dbo.DIM_EDW_RewardsDefinition ( SiteGUID , AccountID , AccountCD , RewardProgramGUID , RewardGroupGuid , RewardLevelGuid , RewardActivityGuid , RewardTriggerGuid , RewardTriggerParmGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                          FROM tempdb.dbo.sysobjects
                          WHERE id = OBJECT_ID ( N'tempdb..##TEMP_EDW_RewardsDefinition_DATA' ))

                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping ##TEMP_EDW_RewardsDefinition_DATA';
                        END;
                    DROP TABLE
                         ##TEMP_EDW_RewardsDefinition_DATA;
                END;

            /*******************************************************************************/

            SELECT
                   * INTO
                          ##TEMP_EDW_RewardsDefinition_DATA
              FROM view_EDW_RewardsDefinition_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

		  EXEC proc_Add_EDW_CT_StdCols '##TEMP_EDW_RewardsDefinition_DATA';

            CREATE CLUSTERED INDEX temp_PI_EDW_RewardsDefinition_IDs ON dbo.##TEMP_EDW_RewardsDefinition_DATA ( SiteGUID , AccountID , AccountCD , RewardProgramGUID , RewardGroupGuid , RewardLevelGuid , RewardActivityGuid , RewardTriggerGuid , RewardTriggerParmGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

            IF @KeepData = 1
                BEGIN
                    PRINT 'KEEPING TEMP DATA IN TABLE TEMP_EDW_RewardsDefinition_DATA';
                    IF EXISTS ( SELECT
                                       name
                                  FROM sys.tables
                                  WHERE name = 'TEMP_EDW_RewardsDefinition_DATA' )
                        BEGIN
                            DROP TABLE
                                 TEMP_EDW_RewardsDefinition_DATA;
                        END;

                    SELECT
                           * INTO
                                  TEMP_EDW_RewardsDefinition_DATA
                      FROM ##TEMP_EDW_RewardsDefinition_DATA;

                    CREATE CLUSTERED INDEX temp_PI_EDW_RewardsDefinition_IDs ON TEMP_EDW_RewardsDefinition_DATA ( SiteGUID , AccountID , AccountCD , RewardProgramGUID , RewardGroupGuid , RewardLevelGuid , RewardActivityGuid , RewardTriggerGuid , RewardTriggerParmGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##TEMP_EDW_RewardsDefinition_DATA );

            --select * from ##TEMP_EDW_RewardsDefinition_DATA
            --update ##TEMP_EDW_RewardsDefinition_DATA set AnsDocumentGuid = '1B8A2611-B0BF-4555-B609-56CC7D4EFC38' where AnsDocumentGuid = '001FBF56-C327-490F-AA15-4EB6F595D47A' and AnsPOints = 15
            --update ##TEMP_EDW_RewardsDefinition_DATA set AnsDocumentGuid = newid() where AnsDocumentGuid = 'C1D9949E-786D-42F7-8E31-0619D8ED60BD' and AnsPOints = 0
		  --*********************************************************
		  -- ADD NEW RECORDS
		  --*********************************************************
            DECLARE
               @iIns AS int = 0;
		  exec @iIns = proc_CT_RewardsDefinition_AddNewRecs ;
            PRINT 'Insert Count: ' + CAST ( @iIns AS nvarchar ( 50 ));
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iIns;

            --*********************************************************
		  -- ADD UPDATED RECORDS
		  --*********************************************************            
                    DECLARE
                       @iUpdt AS int = 0;
		  exec @iUpdt = proc_CT_RewardsDefinition_AddUpdatedRecs;
                    PRINT 'Update Count: ' + CAST ( @iUpdt AS nvarchar ( 50 ));
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdt;


		  --*********************************************************
		  -- FIND DELETED ROWS
		  --*********************************************************            
            DECLARE
               @idel AS int = 0;
		  exec @idel = proc_CT_RewardsDefinition_AddDeletedRecs ;
            PRINT 'Delete Count: ' + CAST ( @idel AS nvarchar ( 50 ));
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @idel;

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( * )
                                        FROM DIM_EDW_RewardsDefinition );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
              WHERE
                    RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##TEMP_EDW_RewardsDefinition_DATA );
            SET @STime = GETDATE ( );

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardsDefinition';
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardsDefinition' , @STime , @CNT_PulledRecords , 'U';

        END;
END;

GO
PRINT 'Created proc_EDW_RewardsDefinition';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_RewardsDefinition_STAGE.sql" \n 
--------------------------------------------------------------- 

go
-- select top 100 * from view_EDW_RewardsDefinition_STAGED
print 'Creating view_EDW_RewardsDefinition_STAGED' ;
print 'FROM view_EDW_RewardsDefinition_STAGE.sql' ;
go
if exists (select name from sys.views where name = 'view_EDW_RewardsDefinition_STAGED')
    drop view view_EDW_RewardsDefinition_STAGED;
go
create view view_EDW_RewardsDefinition_STAGED
as
SELECT [SiteGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[RewardProgramGUID]
      ,[RewardProgramName]
      ,[RewardProgramPeriodStart]
      ,[RewardProgramPeriodEnd]
      ,[RewardGroupGuid]
      ,[GroupName]
      ,[RewardLevelGuid]
      ,[Level]
      ,[RewardLevelTypeLKPName]
      ,[AwardDisplayName]
      ,[AwardType]
      ,[AwardThreshold1]
      ,[AwardThreshold2]
      ,[AwardThreshold3]
      ,[AwardThreshold4]
      ,[AwardValue1]
      ,[AwardValue2]
      ,[AwardValue3]
      ,[AwardValue4]
      ,[ExternalFulfillmentRequired]
      ,[RewardActivityGuid]
      ,[ActivityName]
      ,[ActivityFreqOrCrit]
      ,[ActivityPoints]
      ,[IsBundle]
      ,[IsRequired]
      ,[MaxThreshold]
      ,[AwardPointsIncrementally]
      ,[AllowMedicalExceptions]
      ,[RewardTriggerGuid]
      ,[RewardTriggerDynamicValue]
      ,[TriggerName]
      ,[RewardTriggerParameterOperator]
      ,[RewardTriggerParmGUID]
      ,[Value]
      ,[ChangeType]
      ,[DocumentCulture_VHFRAJ]
      ,[DocumentCulture_VHFRPJ]
      ,[DocumentCulture_VHFRGJ]
      ,[DocumentCulture_VHFRLJ]
      ,[DocumentCulture_VHFRTPJ]
      ,[LevelName]
      ,[HashCode]
      ,[LastModifiedDate]
      ,[RowNbr]
      ,[DeletedFlg]
  FROM [dbo].[STAGING_EDW_RewardsDefinition]
GO
print 'CREATED view_EDW_RewardsDefinition_STAGED' ;
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "create_job_EDW_GetStagingData_RewardsDefinition.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating JOB job_EDW_GetStagingData_RewardsDefinition';
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS( SELECT
                      name
                 FROM msdb.dbo.syscategories
                 WHERE
                      name = N'[Uncategorized (Local)]'
                  AND category_class = 1 )
    BEGIN EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB' , @type = N'LOCAL' , @name = N'[Uncategorized (Local)]';
        IF
               @@ERROR <> 0
            OR @ReturnCode <> 0
            BEGIN
                GOTO QuitWithRollback;
            END;

    END;

DECLARE
   @TGTDB AS nvarchar( 50 ) = DB_NAME( );
DECLARE
   @JNAME AS nvarchar( 100 ) = 'job_EDW_GetStagingData_RewardsDefinition_' + @TGTDB;

IF EXISTS( SELECT
                  job_id
             FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME )
    BEGIN EXEC msdb.dbo.sp_delete_job @job_name = @JNAME , @delete_unused_schedule = 1;
    END;

DECLARE
   @jobId binary( 16 );
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME , @enabled = 1 , @notify_level_eventlog = 2 , @notify_level_email = 2 , @notify_level_netsend = 0 , @notify_level_page = 0 , @delete_level = 0 , @description = N'No description available.' , @category_name = N'[Uncategorized (Local)]' , @owner_login_name = N'sa' , @notify_email_operator_name = N'DBA_Notify' , @job_id = @jobId OUTPUT;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;

/****** Object:  Step [Load_EDW_RewardsDefinition]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId , @step_name = N'Load_EDW_RewardsDefinition' , @step_id = 1 , @cmdexec_success_code = 0 , @on_success_action = 1 , @on_success_step_id = 0 , @on_fail_action = 2 , @on_fail_step_id = 0 , @retry_attempts = 0 , @retry_interval = 0 , @os_run_priority = 0 , @subsystem = N'TSQL' , @command = N'exec proc_EDW_RewardsDefinition;' , @database_name = @TGTDB , @flags = 0;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId , @start_step_id = 1;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId , @name = N'Schedule_EDW_RewardsDefinition' , @enabled = 1 , @freq_type = 4 , @freq_interval = 1 , @freq_subday_type = 8 , @freq_subday_interval = 8 , @freq_relative_interval = 0 , @freq_recurrence_factor = 0 , @active_start_date = 20150412 , @active_end_date = 99991231 , @active_start_time = 10000 , 
@active_end_time = 235959 
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId , @server_name = N'(local)';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN
        ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_TrackerTests.sql" \n 
--------------------------------------------------------------- 

print ('Processing: view_EDW_TrackerTests ') ;

GO


if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_TrackerTests')
BEGIN
	drop view view_EDW_TrackerTests ;
END

GO


--********************************************************************************************************
--09.11.2014 : (wdm) Verified last mod date available to EDW 
-- Select count(*) from [view_EDW_TrackerTests] 40322 vs. 40313 with distinct 44502 / 44483 on TGT P1
--									   44502 vs. 44483 with distinct on Prod5 / P1
--********************************************************************************************************
CREATE VIEW [dbo].[view_EDW_TrackerTests]
AS
	SELECT 
		HFTT.UserID
		, cus.UserSettingsUserGUID
		, CUS.HFitUserMpiNumber
		, CS.SiteID
		, cs.SiteGUID
		, cast(HFTT.EventDate as datetime) as EventDate
		, HFTT.IsProfessionallyCollected
		, HFTT.TrackerCollectionSourceID
		, HFTT.Notes
		, HFTT.PSATest
		, HFTT.OtherExam
		, HFTT.TScore
		, HFTT.DRA
		, HFTT.CotinineTest
		, HFTT.ColoCareKit
		, HFTT.CustomTest
		, HFTT.CustomDesc
		, HFTT.TSH
		, cast(HFTT.ItemCreatedWhen as datetime) as ItemCreatedWhen
		, cast(HFTT.ItemModifiedWhen as datetime) as ItemModifiedWhen
		, HFTT.ItemGUID
	FROM
		dbo.HFit_TrackerTests AS HFTT
	INNER JOIN dbo.HFit_PPTEligibility AS HFPE WITH ( NOLOCK ) ON HFTT.UserID = HFPE.UserID
	INNER JOIN dbo.CMS_UserSettings AS CUS WITH ( NOLOCK ) ON HFTT.UserID = cus.UserSettingsUserID
	INNER JOIN dbo.CMS_UserSite AS CUS2 WITH ( NOLOCK ) ON cus.UserSettingsUserID = cus2.UserID
	INNER JOIN dbo.CMS_Site AS CS WITH ( NOLOCK ) ON cus2.SiteID = CS.SiteID
	INNER JOIN dbo.HFit_Account AS HFA WITH ( NOLOCK ) ON CS.SiteID = HFA.SiteID
GO


  --  
  --  
GO 
print('***** FROM: view_EDW_TrackerTests.sql'); 
GO 

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_TrackerShots.sql" \n 
--------------------------------------------------------------- 

print ('Processing: view_EDW_TrackerShots ') ;



if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_TrackerShots')
BEGIN
	drop view view_EDW_TrackerShots ;
END
go

/****** Object:  View [dbo].[view_EDW_TrackerShots]    Script Date: 9/11/2014 11:14:43 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
--********************************************************************************************************
--09.11.2014 : (wdm) Verified last mod date available to EDW 
--********************************************************************************************************
CREATE VIEW [dbo].[view_EDW_TrackerShots]
AS
	SELECT DISTINCT
		HFTS.UserID
		, cus.UserSettingsUserGUID
		, CUS.HFitUserMpiNumber
		, CS.SiteID
		, cs.SiteGUID
		, HFTS.ItemID
		, cast(HFTS.EventDate as datetime ) as EventDate
		, HFTS.IsProfessionallyCollected
		, HFTS.TrackerCollectionSourceID
		, HFTS.Notes
		, HFTS.FluShot
		, HFTS.PneumoniaShot
		, cast(HFTS.ItemCreatedWhen as datetime ) as ItemCreatedWhen
		, cast(HFTS.ItemModifiedWhen as datetime ) as ItemModifiedWhen
		, HFTS.ItemGUID
	FROM
		dbo.HFit_TrackerShots AS HFTS
	INNER JOIN dbo.HFit_PPTEligibility AS HFPE WITH ( NOLOCK ) ON HFTS.UserID = HFPE.UserID
	INNER JOIN dbo.CMS_UserSettings AS CUS WITH ( NOLOCK ) ON HFTS.UserID = cus.UserSettingsUserID
	INNER JOIN dbo.CMS_UserSite AS CUS2 WITH ( NOLOCK ) ON cus.UserSettingsUserID = cus2.UserID
	INNER JOIN dbo.CMS_Site AS CS WITH ( NOLOCK ) ON cus2.SiteID = CS.SiteID
	INNER JOIN dbo.HFit_Account AS HFA WITH ( NOLOCK ) ON CS.SiteID = HFA.SiteID

GO


  --  
  --  
GO 
print('***** FROM: view_EDW_TrackerShots.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "create_job_EDW_GetStagingData_Trackers.sql" \n 
--------------------------------------------------------------- 
go
PRINT 'Creating JOB job_EDW_GetStagingData_Trackers' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_Trackers_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_EDW_Trackers]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_Trackers',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_STAGING_EDW_CompositeTracker;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_Trackers',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_SmallStepResponses.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating view view_EDW_SmallStepResponses';
PRINT 'Generated FROM: view_EDW_SmallStepResponses.SQL';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_SmallStepResponses') 
    BEGIN
        PRINT 'VIEW view_EDW_SmallStepResponses, replacing.';
        DROP VIEW
             view_EDW_SmallStepResponses;
    END;
GO

CREATE VIEW dbo.view_EDW_SmallStepResponses
AS

--********************************************************************************************************
--IVP Version NO: 1.0
--02.13.2014 : (Sowmiya Venkiteswaran) : Updated the view to include  the fields:
--AccountCD, SiteGUID,SSOutcomeMessage as info. text,
-- Small Steps Program Info( HACampaignNodeGUID,HACampaignName,HACampaignStartDate,HACampaignEndDate)
-- HAUserStartedRecord Info (HAStartedDate,HACompletedDate,HAStartedMode,HACompletedMode)
-- Added filters by document culture and replacing HTML quote with a SQL single quote
--********************************************************************************************************
--02.23.2014 : (Dale Miller & Sowmiya V) : Performance tuning - removed the following WHERE clause and 
--			incorporated them into the JOIN statements for perfoamnce enhancement.
--			 WHERE vwOutcome.DocumentCulture = 'en-US' AND vwCamp.DocumentCulture = 'en-US';
--********************************************************************************************************
--02.23.2014 : (Dale Miller & Sowmiya V) : Performance tuning
--	Prod1, 2 and 3 Labs - Incorporated doc. culture to the Joins
-- 1 - executed DBCC dropcleanbuffers everytime
-- 2 - Tested REPLACE against No REPLACE, insignificant perf. hit.
-- Test Controls:
-- Prod1 Lab - NO SQL DISTINCT - 184311 ( rows) - 14 (seconds) 
-- Prod1 Lab - WITH SQL DISTINCT - 184311 ( rows) - 32 (seconds) 
-- Prod2 Lab - NO SQL DISTINCT -  81120( rows) -  10(seconds) 
-- Prod2 Lab - WITH SQL DISTINCT - 81120 ( rows) -  22(seconds) 
-- Prod3 Lab - NO SQL DISTINCT - 136763 ( rows) - 10 (seconds) 
-- Prod3 Lab - WITH SQL DISTINCT - 136763 ( rows) -  21(seconds)  
--02.24.2015 (SV) - Added column SSHealthAssesmentUserStartedItemID per request from John C.
--02.24.2015 (WDM) - Verified changes applied correctly from within the IVP
--02.24.2015 (WDM) - Verified changes are tracked from within the Schema Change Monitor
--02.24.2015 (WDM) - Add the view to the Data/View IVP
--03.02.2015 (WDM) - The view got out of sync most likely due to multiple users with CRUD capability.
--		Re-executed the master DDL.
--03.03.2015 (WDM/SV) - Added new columns HaCodeName and HFitUserMPINumber.
--03.04.2015 (WDM/SV) - Tested view and reviewed output - added DISTINCT and tuned for perf.
--03.04.2015 (WDM/Ashwin) - Ashwin started testing. Modified the JOIN for UserID - now returns expected MPI.
--03.04.2015 (WDM/Ashwin) - Ashwin certified the view as tested.
--04.06.2015 (WDM/JC) John found an error in the JOIN of user ID - changed to CMS_US.UserSettingsUserID = ss.UserID
--04.15.2015 (WDM/Shane) Found an issue with duplicate rows. Added the SiteID to the JOIN (eg.
--			  vwCamp.NodeSiteID = usrste.SiteID and moved the join down in the list.)
--04.16.2015 (WDM) completed CR-51962
--********************************************************************************************************

SELECT DISTINCT
       ss.UserID
     , acct.AccountCD
     , ste.SiteGUID
     , ss.ItemID AS SSItemID
     , ss.ItemCreatedBy AS SSItemCreatedBy
     , cast(ss.ItemCreatedWhen as datetime)  AS SSItemCreatedWhen
     , ss.ItemModifiedBy AS SSItemModifiedBy
     , cast(ss.ItemModifiedWhen  as datetime) AS SSItemModifiedWhen
     , ss.ItemOrder AS SSItemOrder
     , ss.ItemGUID AS SSItemGUID
     , ss.HealthAssesmentUserStartedItemID AS SSHealthAssesmentUserStartedItemID
     , ss.OutComeMessageGUID AS SSOutcomeMessageGuid
     , REPLACE (vwOutcome.Message, '&#39;', '''') AS SSOutcomeMessage
     , usrstd.HACampaignNodeGUID
     , vwCamp.Name AS HACampaignName
     , cast(vwCamp.CampaignStartDate  as datetime) AS HACampaignStartDate
     , cast(vwCamp.CampaignEndDate  as datetime) AS HACampaignEndDate
     , cast(usrstd.HAStartedDt  as datetime) AS HAStartedDate
     , cast(usrstd.HACompletedDt  as datetime) AS HACompletedDate
     , usrstd.HAStartedMode
     , usrstd.HACompletedMode
     , TODO.HaCodeName
     , CMS_US.HFitUserMPINumber

       FROM
           dbo.Hfit_SmallStepResponses AS ss
               JOIN HFit_HealthAssesmentUserStarted AS usrstd
                   ON usrstd.UserID = ss.UserID
                  AND usrstd.ItemID = ss.HealthAssesmentUserStartedItemID
                 JOIN View_HFit_OutComeMessages_Joined AS vwOutcome
                   ON vwOutcome.NodeGUID = ss.OutComeMessageGUID
                  AND vwOutcome.DocumentCulture = 'en-US'
                 JOIN CMS_UserSite AS usrste
                   ON usrste.UserID = ss.UserID
                 JOIN CMS_Site AS ste
                   ON ste.SiteID = usrste.SiteID
                 JOIN View_HFit_HACampaign_Joined AS vwCamp
                   ON vwCamp.NodeGuid = usrstd.HACampaignNodeGUID
                  AND vwCamp.DocumentCulture = 'en-US'
                  AND vwCamp.NodeSiteID = usrste.SiteID
                 JOIN HFit_Account AS acct
                   ON acct.SiteID = usrste.SiteID
                 JOIN HFit_ToDoSmallSteps AS TODO
                   ON ss.OutComeMessageGUID = TODO.OutComeMessageGUID
                 JOIN CMS_UserSettings AS CMS_US
                   ON CMS_US.UserSettingsUserID = ss.UserID
                  AND CMS_US.HFitUserMPINumber > 0
                  AND CMS_US.HFitUserMPINumber IS NOT NULL;

GO
PRINT 'Created view view_EDW_SmallStepResponses';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_SmallStepResponses_CT.sql" \n 
--------------------------------------------------------------- 

GO

-- use KenticoCMS_Prod1

PRINT 'Creating view view_EDW_SmallStepResponses_CT';
PRINT 'Generated FROM: view_EDW_SmallStepResponses_CT.SQL';

GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_SmallStepResponses_CT') 
    BEGIN
        PRINT 'VIEW view_EDW_SmallStepResponses_CT, replacing.';
        DROP VIEW
             view_EDW_SmallStepResponses_CT;
    END;
GO

CREATE VIEW dbo.view_EDW_SmallStepResponses_CT
AS
/*
select top 100 * from view_EDW_SmallStepResponses_CT

select distinct count(*), SSItemID
from view_EDW_SmallStepResponses_CT
group by SSItemID 
having count(*) > 1

drop table ##Temp_SmallSteps
go
select  TOP 10 *
into STAGING_EDW_SmallSteps
from view_EDW_SmallStepResponses_CT
select * from ##Temp_SmallSteps
*/

SELECT  
       SS.UserID
     , ACCT.AccountCD
     , CMSSITE.SiteGUID
     , SS.ItemID AS SSItemID
     , SS.ItemCreatedBy AS SSItemCreatedBy
     , SS.ItemCreatedWhen AS SSItemCreatedWhen
     , SS.ItemModifiedBy AS SSItemModifiedBy
     , SS.ItemModifiedWhen AS SSItemModifiedWhen
     , SS.ItemOrder AS SSItemOrder
     , SS.ItemGUID AS SSItemGUID
     , SS.HealthAssesmentUserStartedItemID AS SSHealthAssesmentUserStartedItemID
     , SS.OutComeMessageGUID AS SSOutcomeMessageGuid
     , REPLACE (OutcomeMSG.Message, '&#39;', '''') AS SSOutcomeMessage
     , HAUS.HACampaignNodeGUID
       --, HAUS.ItemID AS HAUSItemID
     , vwCamp.Name AS HACampaignName
     , vwCamp.CampaignStartDate AS HACampaignStartDate
     , vwCamp.CampaignEndDate AS HACampaignEndDate
     , HAUS.HAStartedDt AS HAStartedDate
     , HAUS.HACompletedDt AS HACompletedDate
     , HAUS.HAStartedMode
     , HAUS.HACompletedMode
     , TODO.HaCodeName
     , CMS_US.HFitUserMPINumber
     , null AS DeletedFlg
	, getdate() as LastModifiedDate
     , cast( HASHBYTES ('sha1', ISNULL (LEFT (OutcomeMSG.Message, 2000) , '-') 
			 + ISNULL ( CAST (SS.ItemModifiedBy AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (SS.ItemModifiedWhen AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (SS.ItemOrder AS nvarchar (50)) , '-') 
			 + ISNULL (vwCamp.Name, '-') 
			 + ISNULL ( CAST (vwCamp.CampaignStartDate AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (vwCamp.CampaignEndDate AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (HAUS.HAStartedDt AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (HAUS.HACompletedDt AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (HAUS.HAStartedMode AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (HAUS.HACompletedMode AS nvarchar (50)) , '-') 
			 + ISNULL ( TODO.HaCodeName, '-') 
			 + ISNULL ( CAST (SS.ItemGUID AS nvarCHAR (50)) , '-') 
			 + ISNULL ( CAST (vwCamp.CampaignStartDate AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (vwCamp.CampaignEndDate AS nvarchar (50)) , '-') 
			 + ISNULL(CAST(CMS_US.HFitUserMPINumber AS NVARCHAR(50)),'-')
			 ) as nvarchar(100)) AS HashCode
     , COALESCE ( 
		  --CT_Hfit_SmallStepResponses.SYS_CHANGE_OPERATION,
				CT_HFit_ToDoSmallSteps.SYS_CHANGE_OPERATION,
				CT_HFit_Account.SYS_CHANGE_OPERATION,
				CT_HFit_OutComeMessages.SYS_CHANGE_OPERATION,
				CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION,
				CT_HFit_HACampaign.SYS_CHANGE_OPERATION,
				CT_CMS_Site.SYS_CHANGE_OPERATION,
				CT_CMS_UserSettings.SYS_CHANGE_OPERATION
       ) AS ChangeType

    --   /********************************************/

     , CT_CMS_UserSettings.UserSettingsID AS CT_UserSettingsID     
     , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CT_CMS_UserSettings_SCV

     , CT_CMS_Site.SiteID AS SiteID_CtID
     , CT_CMS_Site.SYS_CHANGE_OPERATION AS SiteID_CHANGE_OPERATION
     , CT_CMS_Site.SYS_CHANGE_VERSION AS SITE_SCV

     , CT_HFit_HACampaign.HACampaignID AS Campaign_CtID
     , CT_HFit_HACampaign.SYS_CHANGE_VERSION AS Campaign_SCV

     , CT_HFit_HealthAssesmentUserStarted.ItemID AS HealthAssesmentUserStarted_CtID
     , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_VERSION AS HealthAssesmentUserStarted_SCV

     , CT_HFit_OutComeMessages.OutComeMessagesID AS OutComeMessages_CtID
     , CT_HFit_OutComeMessages.SYS_CHANGE_VERSION AS OutComeMessages_SCV

     , CT_HFit_Account.AccountID AS HFit_Account_CtID
     , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV

     , CT_HFit_ToDoSmallSteps.ItemID AS ToDoSmallSteps_CtID
     , CT_HFit_ToDoSmallSteps.SYS_CHANGE_VERSION AS ToDoSmallSteps_SCV

	, CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CT_UserSettings_CHANGE_OPERATION
     , CT_HFit_HACampaign.SYS_CHANGE_OPERATION AS Campaign_CHANGE_OPERATION
     , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION AS HealthAssesmentUserStarted_CHANGE_OPERATION
     , CT_HFit_OutComeMessages.SYS_CHANGE_OPERATION AS OutComeMessages_CHANGE_OPERATION
     , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHANGE_OPERATION
     , CT_HFit_ToDoSmallSteps.SYS_CHANGE_OPERATION AS ToDoSmallSteps_CHANGE_OPERATION

    /* THE BELOW CAUSES A MASSIVE PERFORMANCE HIT - SO IT IS COMMENTED OUT (WDM) */
    , CT_Hfit_SmallStepResponses.ItemID AS SmallStepResponses_CtID
    , CT_Hfit_SmallStepResponses.SYS_CHANGE_VERSION AS SmallStepResponses_SCV
    , CT_Hfit_SmallStepResponses.SYS_CHANGE_OPERATION AS SmallStepResponses_CHANGE_OPERATION

    --, newid() AS RowNbr

       , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
           dbo.Hfit_SmallStepResponses AS SS
               JOIN HFit_HealthAssesmentUserStarted AS HAUS
                   ON HAUS.UserID = SS.UserID
                  AND HAUS.ItemID = SS.HealthAssesmentUserStartedItemID
                 JOIN View_HFit_OutComeMessages_Joined AS OutcomeMSG
                   ON OutcomeMSG.NodeGUID = SS.OutComeMessageGUID
                  AND OutcomeMSG.DocumentCulture = 'en-US'
                 JOIN CMS_UserSite AS USERSITE
                   ON USERSITE.UserID = SS.UserID
                 JOIN CMS_Site AS CMSSITE
                   ON CMSSITE.SiteID = USERSITE.SiteID
                 JOIN View_HFit_HACampaign_Joined AS vwCamp
                   ON vwCamp.NodeGuid = HAUS.HACampaignNodeGUID
                  AND vwCamp.DocumentCulture = 'en-US'
                  AND vwCamp.NodeSiteID = USERSITE.SiteID
                 JOIN HFit_Account AS ACCT
                   ON ACCT.SiteID = USERSITE.SiteID
                 JOIN HFit_ToDoSmallSteps AS TODO
                   ON SS.OutComeMessageGUID = TODO.OutComeMessageGUID
                 JOIN CMS_UserSettings AS CMS_US
                   ON CMS_US.UserSettingsUserID = SS.UserID
                  AND CMS_US.HFitUserMPINumber > 0
                  AND CMS_US.HFitUserMPINumber IS NOT NULL

           /*********************************************/
			 LEFT JOIN CHANGETABLE (CHANGES Hfit_SmallStepResponses, NULL) AS CT_Hfit_SmallStepResponses
                   ON SS.ItemID = CT_Hfit_SmallStepResponses.ItemID
                 LEFT JOIN CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT_CMS_UserSettings
                   ON CMS_US.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                   ON CMSSite.SiteID = CT_CMS_Site.SiteID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HACampaign, NULL) AS CT_HFit_HACampaign
                   ON vwCamp.HACampaignID = CT_HFit_HACampaign.HACampaignID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted, NULL) AS CT_HFit_HealthAssesmentUserStarted
                   ON HAUS.ItemID = CT_HFit_HealthAssesmentUserStarted.ItemID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_OutComeMessages, NULL) AS CT_HFit_OutComeMessages
                   ON OutcomeMSG.OutComeMessagesID = CT_HFit_OutComeMessages.OutComeMessagesID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account, NULL) AS CT_HFit_Account
                   ON ACCT.AccountID = CT_HFit_Account.AccountID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_ToDoSmallSteps, NULL) AS CT_HFit_ToDoSmallSteps
                   ON TODO.ItemID = CT_HFit_ToDoSmallSteps.ItemID

			 --where 
			 --CT_UserSettings_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null 
				-- Campaign_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null OR
				-- HealthAssesmentUserStarted_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null OR
				-- OutComeMessages_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null OR
				-- HFit_Account_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null OR
				-- ToDoSmallSteps_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null OR
				-- SmallStepResponses_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null


GO
PRINT 'Created view view_EDW_SmallStepResponses_CT';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_BioMetrics.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Processing view_EDW_BioMetrics: ' + CAST (GETDATE () AS nvarchar (50)) + '  *** view_EDW_BioMetrics.sql (CR11690)';
GO
--drop table [EDW_BiometricViewRejectCriteria]
IF NOT EXISTS (SELECT [name]
			  FROM [sys].[tables]
			  WHERE [name] = 'EDW_BiometricViewRejectCriteria') 
    BEGIN
	   PRINT 'EDW_BiometricViewRejectCriteria NOT found, creating';
	   --This table contains the REJECT specifications for Biometric data. An entry causes all records before a date for a Client or SITE to be ignored.
	   --Use AccountCD and ItemCreatedWhen together OR SiteID and ItemCreatedWhen together. They work and reject in pairs.
	   CREATE TABLE [dbo].[EDW_BiometricViewRejectCriteria]
	   (
	   [AccountCD] nvarchar (8) NOT NULL
	 , [ItemCreatedWhen] datetime2 (7) NOT NULL
	 , [SiteID] int NOT NULL
	 , [RejectGUID] uniqueidentifier NULL
	   );

	   ALTER TABLE [dbo].[EDW_BiometricViewRejectCriteria]
	   ADD CONSTRAINT
		  [DF_EDW_BiometricViewRejectCriteria_RejectGUID] DEFAULT NEWID () FOR [RejectGUID];

	   ALTER TABLE [dbo].[EDW_BiometricViewRejectCriteria] SET (LOCK_ESCALATION = TABLE) ;

	   EXEC [sp_addextendedproperty]
	   @name = N'PURPOSE' , @value = 'This table contains the REJECT specifications for Biometric data. An entry causes all records before a date for a Client or SITE to be ignored. The data is entered as SiteID and Rejection Date OR AccountCD and Rejection Date. All dates prior to the rejection date wil be ignored.' ,
	   @level0type = N'Schema' , @level0name = 'dbo' ,
	   @level1type = N'Table' , @level1name = 'EDW_BiometricViewRejectCriteria';
	   --@level2type = N'Column', @level2name = NULL

	   EXEC [sp_addextendedproperty]
	   @name = N'MS_Description' , @value = 'Use AccountCD and ItemCreatedWhen together, entering a non-existant value for SiteID. They work and reject in pairs and this type of entry will only take AccountCD and ItemCreatedWhen date into consideration.' ,
	   @level0type = N'Schema' , @level0name = 'dbo' ,
	   @level1type = N'Table' , @level1name = 'EDW_BiometricViewRejectCriteria' ,
	   @level2type = N'Column' , @level2name = 'AccountCD';

	   EXEC [sp_addextendedproperty]
	   @name = N'USAGE' , @value = 'Use SiteID and ItemCreatedWhen together, entering a non-existant value for AccountCD. They work and reject in pairs.' ,
	   @level0type = N'Schema' , @level0name = 'dbo' ,
	   @level1type = N'Table' , @level1name = 'EDW_BiometricViewRejectCriteria' ,
	   @level2type = N'Column' , @level2name = 'SiteID';

	   EXEC [sp_addextendedproperty]
	   @name = N'USAGE' , @value = 'Use AccountCD or SiteID and ItemCreatedWhen together. They work and reject in pairs. Any date before this date will NOT be retrieved.' ,
	   @level0type = N'Schema' , @level0name = 'dbo' ,
	   @level1type = N'Table' , @level1name = 'EDW_BiometricViewRejectCriteria' ,
	   @level2type = N'Column' , @level2name = 'ItemCreatedWhen';
    END;
GO

IF EXISTS (SELECT [name]
		   FROM [sys].[views]
		   WHERE [name] = 'view_EDW_BiometricViewRejectCriteria') 
    BEGIN
	   PRINT 'view_EDW_BiometricViewRejectCriteria found, updating';
	   DROP VIEW [view_EDW_BiometricViewRejectCriteria];
    END;
GO

CREATE VIEW [view_EDW_BiometricViewRejectCriteria]
AS SELECT [AccountCD]
	   , [ItemCreatedWhen]
	   , [SiteID]
	   , [RejectGUID]
	FROM [dbo].[EDW_BiometricViewRejectCriteria];
GO
PRINT 'view_EDW_BiometricViewRejectCriteria, updated';
GO

IF NOT EXISTS (SELECT [name]
			  FROM [sys].[indexes]
			  WHERE [name] = 'PKI_EDW_BiometricViewRejectCriteria') 
    BEGIN
	   PRINT 'PKI_EDW_BiometricViewRejectCriteria NOT found, creating';
	   CREATE UNIQUE CLUSTERED INDEX [PKI_EDW_BiometricViewRejectCriteria] ON [dbo].[EDW_BiometricViewRejectCriteria]
	   (
	   [AccountCD] ASC ,
	   [ItemCreatedWhen] ASC ,
	   [SiteID] ASC
	   );
    END;
ELSE
    BEGIN
	   PRINT 'PKI_EDW_BiometricViewRejectCriteria created';
    END;

GO

IF EXISTS (SELECT [name]
		   FROM [sys].[procedures]
		   WHERE [name] = 'proc_Insert_EDW_BiometricViewRejectCriteria') 
    BEGIN
	   PRINT 'proc_Insert_EDW_BiometricViewRejectCriteria found, updating.';
	   DROP PROCEDURE [proc_Insert_EDW_BiometricViewRejectCriteria];
    END;
ELSE
    BEGIN
	   PRINT 'Creating proc_Insert_EDW_BiometricViewRejectCriteria';
    END;
GO

CREATE PROC [proc_Insert_EDW_BiometricViewRejectCriteria] (
	  @AccountCD AS nvarchar (50) , @ItemCreatedWhen AS datetime , @SiteID AS int) 
AS
BEGIN

    IF @SiteID IS NULL
	   BEGIN
		  SET @SiteID = -1;
	   END;

    DECLARE @iCnt integer = 0;
    SET @iCnt = (SELECT COUNT (*) 
			    FROM [EDW_BiometricViewRejectCriteria]
			    WHERE [AccountCD] = @AccountCD
				 AND [SiteID] = @SiteID) ;
    IF @iCnt <= 0
	   BEGIN
		  INSERT INTO [dbo].[EDW_BiometricViewRejectCriteria]
		  ([AccountCD]
		 , [ItemCreatedWhen]
		 , [SiteID]
		  ) 
		  VALUES
		  (@AccountCD
		  , @ItemCreatedWhen
		  , @SiteID
		  );
		  PRINT 'ADDED ' + @AccountCD + ' to EDW_BiometricViewRejectCriteria.';
	   END;
    ELSE
	   BEGIN
		  PRINT 'Account ' + @AccountCD + ' already defined to EDW_BiometricViewRejectCriteria.';
	   END;
END;

GO

IF EXISTS (SELECT [name]
		   FROM [sys].[procedures]
		   WHERE [name] = 'proc_Delete_EDW_BiometricViewRejectCriteria_Acct') 
    BEGIN
	   PRINT 'proc_Delete_EDW_BiometricViewRejectCriteria_Acct  found, updating.';
	   DROP PROCEDURE [proc_Delete_EDW_BiometricViewRejectCriteria_Acct];
    END;
ELSE
    BEGIN
	   PRINT 'Creating proc_Delete_EDW_BiometricViewRejectCriteria_Acct';
    END;

GO

CREATE PROC [proc_Delete_EDW_BiometricViewRejectCriteria_Acct] (
	  @AccountCD AS nvarchar (50) , @ItemCreatedWhen AS datetime) 
AS
BEGIN
    DELETE FROM [dbo].[EDW_BiometricViewRejectCriteria]
	 WHERE [AccountCD] = @AccountCD
	   AND [ItemCreatedWhen] = @ItemCreatedWhen;
END;

GO
IF EXISTS (SELECT [name]
		   FROM [sys].[procedures]
		   WHERE [name] = 'proc_Delete_EDW_BiometricViewRejectCriteria_Site') 
    BEGIN
	   PRINT 'proc_Delete_EDW_BiometricViewRejectCriteria_Site  found, updating.';
	   DROP PROCEDURE [proc_Delete_EDW_BiometricViewRejectCriteria_Site];
    END;
ELSE
    BEGIN
	   PRINT 'Creating proc_Delete_EDW_BiometricViewRejectCriteria_Site';
    END;

GO

CREATE PROC [proc_Delete_EDW_BiometricViewRejectCriteria_Site] (
	  @SiteID AS int , @ItemCreatedWhen AS datetime) 
AS
BEGIN
    DELETE FROM [dbo].[EDW_BiometricViewRejectCriteria]
	 WHERE [SiteID] = @SiteID
	   AND [ItemCreatedWhen] = @ItemCreatedWhen;

END;
GO

IF EXISTS (SELECT [name]
		   FROM [sys].[views]
		   WHERE [name] = 'view_EDW_BioMetrics') 
    BEGIN
	   PRINT 'Removing current view_EDW_BioMetrics.';
	   DROP VIEW [view_EDW_BioMetrics];
    END;
GO
PRINT 'Creating view_EDW_BioMetrics.';
GO

CREATE VIEW [dbo].[view_EDW_BioMetrics]
AS
--*****************************************************************************************************************************************
--************** TEST Criteria and Results for view_EDW_BioMetrics ************************************************************************
--INSERT INTO [dbo].[EDW_BiometricViewRejectCriteria] ([AccountCD],[ItemCreatedWhen],[SiteID]) VALUES('XX','2013-12-01',17  )  
--NOTE:		XX is used so that the AccountCD is NOT taken into account and only SiteID and ItemCreatedWhen is used.
--GO	--Tested by wdm on 11.21.2014

-- select count(*) from view_EDW_BioMetrics		--(wdm) & (jc) : testing on {ProdStaging = 136348} / With reject on 136339 = 9

--select * from view_EDW_BioMetrics	 where AccountCD = 'peabody' AND COALESCE (EventDate,ItemCreatedWhen) is not NULL and COALESCE (EventDate,ItemCreatedWhen) < '2013-12-01'	: 9 
--select * from view_Hfit_BioMetrics where AccountCD = 'peabody' AND COALESCE (EventDate,ItemCreatedWhen) is not NULL and COALESCE (EventDate,ItemCreatedWhen) < '2013-12-01'	: 9 

--select * from view_EDW_BioMetrics	where AccountCD = 'peabody' and ItemCreatedWhen < '2013-12-01 00:00:00.000'		: 7 
--select * from view_EDW_BioMetrics	where AccountCD = 'peaboOK dy' and EventDate < '2013-12-01 00:00:00.000'		: 9 

--select count(*) from view_EDW_BioMetrics		--NO REJECT FILTER : 136348
--select count(*) from view_EDW_BioMetrics		--REJECT FILTER ON : 136339 == 9 GOOD TEST

--select count(*) from view_Hfit_BioMetrics	:136393
--select count(*) from view_Hfit_BioMetrics where COALESCE (EventDate,ItemCreatedWhen) is not NULL 	:136348

--NOTE: All tests passed 11.21.2014, 11.23.2014, 12.2.2014, 12,4,2014

--truncate table EDW_BiometricViewRejectCriteria

--INSERT INTO [dbo].[EDW_BiometricViewRejectCriteria]([AccountCD],[ItemCreatedWhen],[SiteID])VALUES('peabody','2013-12-01',-1)         
--NOTE:		-1 is used so that the SiteID is NOT taken into account and only AccountCD and ItemCreatedWhen is used.
--GO	--Tested by wdm on 11.21.2014

--select * from view_EDW_BioMetrics where ItemCreatedWhen < '2013-12-01' and AccountCD = 'peabody' returns 1034
--		so the number should be 43814 - 1034 = 42780 with AccountCD = 'peabody' and ItemCreatedWhen = '2014-03-19'
--		in table EDW_BiometricViewRejectCriteria. And it worked (wdm) 11.21.2014
--GO	--Tested by wdm on 11.21.2014

--select * from view_EDW_BioMetrics where SiteID = 17 and ItemCreatedWhen < '2014-03-19' returns 22,974
--		so the number should be 43814 - 22974 = 20840 with SIteID = 17 and ItemCreatedWhen = '2014-03-19'
--		in table EDW_BiometricViewRejectCriteria. And it worked (wdm) 11.21.2014
--GO	--Tested by wdm on 11.21.2014

--	11.24.2014 (wdm) -	requested a review of this code and validation with EDW.

-- 12.22.2014 - Received an SR from John C. via Richard to add two fields to the view, Table name and Item ID.
-- 12.23.2014 - Added the Vendor ID and Vendor name to the view via the HFit_LKP_TrackerVendor table
-- 12.25.2014 - Added the EDW_BiometricViewRejectCriteria to allow selective rejection of historical records
-- 01.19.2014 - Prepared for Simpson Willams

--*****************************************************************************************************************************************
SELECT DISTINCT
--HFit_UserTracker
[HFUT].[UserID]
, [cus].[UserSettingsUserGUID] AS [UserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast(NULL as datetime) AS [CreatedDate]
, cast(NULL as datetime) AS [ModifiedDate]
, NULL AS [Notes]
, NULL AS [IsProfessionallyCollected]
, NULL AS [EventDate]
, 'Not Build Yet' AS [EventName]

--HFit_TrackerWeight
, NULL AS [PPTWeight]

--HFit_TrackerHbA1C
, NULL AS [PPTHbA1C]

--HFit_TrackerCholesterol
, NULL AS [Fasting]
, NULL AS [HDL]
, NULL AS [LDL]
, NULL AS [Ratio]
, NULL AS [Total]
, NULL AS [Triglycerides]

--HFit_TrackerBloodSugarandGlucose
, NULL AS [Glucose]
, NULL AS [FastingState]

--HFit_TrackerBloodPressure
, NULL AS [Systolic]
, NULL AS [Diastolic]

--HFit_TrackerBodyFat
, NULL AS [PPTBodyFatPCT]

--HFit_TrackerBMI
, NULL AS [BMI]

--HFit_TrackerBodyMeasurements
, NULL AS [WaistInches]
, NULL AS [HipInches]
, NULL AS [ThighInches]
, NULL AS [ArmInches]
, NULL AS [ChestInches]
, NULL AS [CalfInches]
, NULL AS [NeckInches]

--HFit_TrackerHeight
, NULL AS [Height]

--HFit_TrackerRestingHeartRate
, NULL AS [HeartRate]
, --HFit_TrackerShots
NULL AS [FluShot]
, NULL AS [PneumoniaShot]

--HFit_TrackerTests
, NULL AS [PSATest]
, NULL AS [OtherExam]
, NULL AS [TScore]
, NULL AS [DRA]
, NULL AS [CotinineTest]
, NULL AS [ColoCareKit]
, NULL AS [CustomTest]
, NULL AS [CustomDesc]
, NULL AS [CollectionSource]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFUT].[ItemCreatedWhen] = COALESCE ([HFUT].[ItemModifiedWhen] , [hfut].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFUT].[ItemCreatedWhen] as datetime) as ItemCreatedWhen
, cast([HFUT].[ItemModifiedWhen] as datetime) as ItemModifiedWhen
, 0   AS [TrackerCollectionSourceID]
, [HFUT].[itemid]
, 'HFit_UserTracker' AS [TBL]
, NULL AS [VendorID]		--VENDOR.ItemID as VendorID
, NULL AS [VendorName]		--VENDOR.VendorName
  FROM
	  [dbo].[HFit_UserTracker] AS [HFUT]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [hfut].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
  --left outer join HFit_LKP_TrackerVendor as VENDOR on HFUT.VendorID = VENDOR.ItemID
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE [HFUT].[ItemCreatedWhen] < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND [HFUT].[ItemCreatedWhen] < [ItemCreatedWhen]) 
	   --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified within table EDW_BiometricViewRejectCriteria
    AND [HFUT].[ItemCreatedWhen] IS NOT NULL		--Add per Robert and Laura 12.4.2014

UNION ALL
SELECT distinct
[hftw].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTW].[ItemCreatedWhen] as datetime) as ItemCreatedWhen
, cast([HFTW].[ItemModifiedWhen] as datetime) as ItemModifiedWhen
, [HFTW].[Notes]
, [HFTW].[IsProfessionallyCollected]
, cast([HFTW].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, [hftw].Value AS [PPTWeight]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTW].[ItemCreatedWhen] = COALESCE ([HFTW].[ItemModifiedWhen] , [HFTW].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTW].[ItemCreatedWhen] as datetime) as ItemCreatedWhen
, cast([HFTW].[ItemModifiedWhen] as datetime) as ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTW].[itemid]
, 'HFit_TrackerWeight' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerWeight] AS [HFTW]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTW].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTW].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTW].[VendorID] = [VENDOR].[ItemID]
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTW].[EventDate] , [HFTW].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTW].[EventDate] , [HFTW].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTW].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTW].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014			

UNION ALL
SELECT distinct
[HFTHA].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTHA].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTHA].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTHA].[Notes]
, [HFTHA].[IsProfessionallyCollected]
, cast([HFTHA].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, [HFTHA].Value AS [PPTHbA1C]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTHA].[ItemCreatedWhen] = COALESCE ([HFTHA].[ItemModifiedWhen] , [HFTHA].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTHA].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTHA].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTHA].[itemid]
, 'HFit_TrackerHbA1c' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerHbA1c] AS [HFTHA]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTHA].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTHA].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTHA].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTHA].[EventDate] , [HFTHA].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTHA].[EventDate] , [HFTHA].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTHA].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTHA].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTC].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTC].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTC].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTC].[Notes]
, [HFTC].[IsProfessionallyCollected]
, cast([HFTC].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, [HFTC].[Fasting]
, [HFTC].[HDL]
, [HFTC].[LDL]
, [HFTC].[Ratio]
, [HFTC].[Total]
, [HFTC].[Tri]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTC].[ItemCreatedWhen] = COALESCE ([HFTC].[ItemModifiedWhen] , [HFTC].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTC].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTC].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTC].[itemid]
, 'HFit_TrackerCholesterol' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerCholesterol] AS [HFTC]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTC].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTC].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTC].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTC].[EventDate] , [HFTC].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTC].[EventDate] , [HFTC].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTC].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTC].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTBSAG].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTBSAG].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBSAG].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTBSAG].[Notes]
, [HFTBSAG].[IsProfessionallyCollected]
, cast([HFTBSAG].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTBSAG].[Units]
, [HFTBSAG].[FastingState]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTBSAG].[ItemCreatedWhen] = COALESCE ([HFTBSAG].[ItemModifiedWhen] , [HFTBSAG].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTBSAG].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBSAG].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTBSAG].[itemid]
, 'HFit_TrackerBloodSugarAndGlucose' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerBloodSugarAndGlucose] AS [HFTBSAG]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTBSAG].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTBSAG].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTBSAG].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTBSAG].[EventDate] , [HFTBSAG].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTBSAG].[EventDate] , [HFTBSAG].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTBSAG].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTBSAG].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTBP].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTBP].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBP].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTBP].[Notes]
, [HFTBP].[IsProfessionallyCollected]
, cast([HFTBP].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTBP].[Systolic]
, [HFTBP].[Diastolic]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTBP].[ItemCreatedWhen] = COALESCE ([HFTBP].[ItemModifiedWhen] , [HFTBP].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTBP].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBP].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTBP].[itemid]
, 'HFit_TrackerBloodPressure' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerBloodPressure] AS [HFTBP]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTBP].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTBP].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTBP].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTBP].[EventDate] , [HFTBP].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTBP].[EventDate] , [HFTBP].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTBP].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTBP].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTBF].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTBF].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBF].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTBF].[Notes]
, [HFTBF].[IsProfessionallyCollected]
, cast([HFTBF].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTBF].Value AS [PPTBodyFatPCT]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTBF].[ItemCreatedWhen] = COALESCE ([HFTBF].[ItemModifiedWhen] , [HFTBF].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTBF].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBF].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTBF].[itemid]
, 'HFit_TrackerBodyFat' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerBodyFat] AS [HFTBF]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTBF].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTBF].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTBF].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTBF].[EventDate] , [HFTBF].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTBF].[EventDate] , [HFTBF].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTBF].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTBF].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTB].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTB].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTB].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTB].[Notes]
, [HFTB].[IsProfessionallyCollected]
, cast([HFTB].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTB].[BMI]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTB].[ItemCreatedWhen] = COALESCE ([HFTB].[ItemModifiedWhen] , [HFTB].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTB].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTB].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTB].[itemid]
, 'HFit_TrackerBMI' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerBMI] AS [HFTB]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTB].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTB].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTB].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified within table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTB].[EventDate] , [HFTB].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTB].[EventDate] , [HFTB].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTB].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTB].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTBM].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTBM].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBM].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTBM].[Notes]
, [HFTBM].[IsProfessionallyCollected]
, cast([HFTBM].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTBM].[WaistInches]
, [HFTBM].[HipInches]
, [HFTBM].[ThighInches]
, [HFTBM].[ArmInches]
, [HFTBM].[ChestInches]
, [HFTBM].[CalfInches]
, [HFTBM].[NeckInches]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTBM].[ItemCreatedWhen] = COALESCE ([HFTBM].[ItemModifiedWhen] , [HFTBM].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTBM].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBM].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTBM].[itemid]
, 'HFit_TrackerBodyMeasurements' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerBodyMeasurements] AS [HFTBM]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTBM].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTBM].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTBM].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTBM].[EventDate] , [HFTBM].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTBM].[EventDate] , [HFTBM].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTBM].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTBM].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTH].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTH].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTH].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTH].[Notes]
, [HFTH].[IsProfessionallyCollected]
, cast([HFTH].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTH].[Height]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTH].[ItemCreatedWhen] = COALESCE ([HFTH].[ItemModifiedWhen] , [HFTH].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTH].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTH].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTH].[itemid]
, 'HFit_TrackerHeight' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerHeight] AS [HFTH]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTH].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTH].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTH].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria		
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTH].[EventDate] , [HFTH].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTH].[EventDate] , [HFTH].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTH].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTH].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014
UNION ALL
SELECT distinct
[HFTRHR].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTRHR].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTRHR].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTRHR].[Notes]
, [HFTRHR].[IsProfessionallyCollected]
, cast([HFTRHR].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTRHR].[HeartRate]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTRHR].[ItemCreatedWhen] = COALESCE ([HFTRHR].[ItemModifiedWhen] , [HFTRHR].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTRHR].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTRHR].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTRHR].[itemid]
, 'HFit_TrackerRestingHeartRate' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerRestingHeartRate] AS [HFTRHR]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTRHR].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTRHR].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTRHR].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTRHR].[EventDate] , [HFTRHR].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTRHR].[EventDate] , [HFTRHR].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTRHR].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTRHR].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTS].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTS].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTS].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTS].[Notes]
, [HFTS].[IsProfessionallyCollected]
, cast([HFTS].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTS].[FluShot]
, [HFTS].[PneumoniaShot]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTS].[ItemCreatedWhen] = COALESCE ([HFTS].[ItemModifiedWhen] , [HFTS].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTS].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTS].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTS].[itemid]
, 'HFit_TrackerShots' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerShots] AS [HFTS]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTS].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTS].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTS].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTS].[EventDate] , [HFTS].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTS].[EventDate] , [HFTS].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTS].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTS].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTT].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTT].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTT].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTT].[Notes]
, [HFTT].[IsProfessionallyCollected]
, cast([HFTT].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTT].[PSATest]
, [HFTT].[OtherExam]
, [HFTT].[TScore]
, [HFTT].[DRA]
, [HFTT].[CotinineTest]
, [HFTT].[ColoCareKit]
, [HFTT].[CustomTest]
, [HFTT].[CustomDesc]
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTT].[ItemCreatedWhen] = COALESCE ([HFTT].[ItemModifiedWhen] , [HFTT].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTT].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTT].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTT].[itemid]
, 'HFit_TrackerTests' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerTests] AS [HFTT]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTT].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTT].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTT].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTT].[EventDate] , [HFTT].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTT].[EventDate] , [HFTT].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTT].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTT].[EventDate] IS NOT NULL);		--Add per RObert and Laura 12.4.2014

--HFit_TrackerBMI
--HFit_TrackerBodyMeasurements
--HFit_TrackerHeight
--HFit_TrackerRestingHeartRate
--HFit_TrackerShots
--HFit_TrackerTests

GO

PRINT 'Created view_EDW_BioMetrics: ' + CAST (GETDATE () AS nvarchar (50)) ;
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_BioMetrics.sql';
GO

----***************************************************************************************************************************
----** REMOVE THE INSERTS AFTER INTITAL LOAD
----***************************************************************************************************************************
--truncate table EDW_BiometricViewRejectCriteria ;
--go 
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'trstmark','11/4/2013',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'entergy','1/6/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'mcwp','1/27/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'stateneb','4/1/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'jnj','5/28/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'coopers','7/1/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'cnh','8/4/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'amat','8/4/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'dupont','8/18/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'ejones','9/3/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'avera','9/15/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'sprvalu','9/18/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'firstgrp','10/6/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'rexnord','12/2/2014',-1) ;
--GO
PRINT '***** COMPLETED : view_EDW_BioMetrics.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_BioMetrics_CT.sql" \n 
--------------------------------------------------------------- 


GO
-- use KenticoCMS_Prod1

GO

PRINT 'Creating view_EDW_BioMetrics_CT: ' + CAST ( GETDATE () AS nvarchar (50)) + '  *** FROM: view_EDW_BioMetrics_CT.sql';

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.views
                   WHERE name = 'view_EDW_BioMetrics_CT') 

    BEGIN

        DROP VIEW
             view_EDW_BioMetrics_CT;
    END;

GO

/*-----------------------------------------------------------------
******************************************
--select * from HFit_UserTracker
--update HFit_UserTracker set UserID = 71 where ItemID in (1,2,4,5)
--update HFit_UserTracker set UserID = 70 where ItemID in (1,2,4,5)

1160148
select count(*) from view_EDW_BioMetrics_CT
WHERE CT_ChangeType IS NOT NULL

0
select count(*) from view_EDW_BioMetrics_CT
WHERE CT_ChangeType IS NULL

select top 100 * from view_EDW_BioMetrics_CT
******************************************
*/

CREATE VIEW dbo.view_EDW_BioMetrics_CT
AS SELECT DISTINCT
          HFUT.UserID
        , cus.UserSettingsUserGUID AS UserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , NULL AS CreatedDate
        , NULL AS ModifiedDate
        , NULL AS Notes
        , NULL AS IsProfessionallyCollected
        , NULL AS EventDate
        , 'Not Build Yet' AS EventName
        , NULL AS PPTWeight
        , NULL AS PPTHbA1C
        , NULL AS Fasting
        , NULL AS HDL
        , NULL AS LDL
        , NULL AS Ratio
        , NULL AS Total
        , NULL AS Triglycerides
        , NULL AS Glucose
        , NULL AS FastingState
        , NULL AS Systolic
        , NULL AS Diastolic
        , NULL AS PPTBodyFatPCT
        , NULL AS BMI
        , NULL AS WaistInches
        , NULL AS HipInches
        , NULL AS ThighInches
        , NULL AS ArmInches
        , NULL AS ChestInches
        , NULL AS CalfInches
        , NULL AS NeckInches
        , NULL AS Height
        , NULL AS HeartRate
        , NULL AS FluShot
        , NULL AS PneumoniaShot
        , NULL AS PSATest
        , NULL AS OtherExam
        , NULL AS TScore
        , NULL AS DRA
        , NULL AS CotinineTest
        , NULL AS ColoCareKit
        , NULL AS CustomTest
        , NULL AS CustomDesc
        , NULL AS CollectionSource
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFUT.ItemCreatedWhen = COALESCE ( HFUT.ItemModifiedWhen , hfut.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFUT.ItemCreatedWhen
        , HFUT.ItemModifiedWhen
        , 0 AS TrackerCollectionSourceID
        , HFUT.itemid
        , 'HFit_UserTracker' AS TBL
        , NULL AS VendorID
        , NULL AS VendorName

        , HASHBYTES ( 'SHA1' ,
          ISNULL ( CAST ( HFUT.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID  AS nvarchar (50)) , '-') + ISNULL ( CAST (
          cus.HFitUserMpiNumber  AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( cs.SiteGUID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD  AS nvarchar (50)) , '-') + ISNULL (
          CAST (
          HFUT.ItemCreatedWhen  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFUT.ItemModifiedWhen  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFUT.itemid  AS nvarchar (50)) , '-') + 'HFit_UserTracker') 
          AS HashCode

        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , NULL AS HFit_TrackerSource_CHGTYPE

          --**********************************************************************************************************
          --	   THE FOLLOWING COALESCE STATEMENT IS DIFFERENT FROM ALL OTHERS IN THAT TRACKER SOURCE IS NOT NEEDED 
          --**********************************************************************************************************
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_UserTracker AS HFUT
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON hfut.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_UserTracker , NULL) AS CT_TrackerTable
                    ON HFUT.ItemID = CT_TrackerTable.ItemID --NOT Needed in this instance only
               --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource, NULL) AS [CT_TrackerSource] 
               --    ON HFTCS.[ItemID] = CT_TrackerTable.[ItemID]   
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE HFUT.ItemCreatedWhen < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 HFUT.ItemCreatedWhen < ItemCreatedWhen) AND
          HFUT.ItemCreatedWhen IS NOT NULL

/*------------------------------------------------------------------------------------------------------------------------------------------------
************************************************************************************************************************************************
11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified within table EDW_BiometricViewRejectCriteria
12.04.2014  (wdm) Add per Robert and Laura 
************************************************************************************************************************************************
*/

   UNION ALL
   SELECT DISTINCT
          hftw.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTW.ItemCreatedWhen
        , HFTW.ItemModifiedWhen
        , HFTW.Notes
        , HFTW.IsProfessionallyCollected
        , HFTW.EventDate
        , 'Not Build Yet' AS EventName
        , hftw.Value AS PPTWeight
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTW.ItemCreatedWhen = COALESCE ( HFTW.ItemModifiedWhen , HFTW.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTW.ItemCreatedWhen
        , HFTW.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTW.itemid
        , 'HFit_TrackerWeight' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , +ISNULL ( CAST ( hftw.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTW.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTW.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTW.Notes , 1000) , '-') + ISNULL ( CAST ( HFTW.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTW.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( hftw.Value AS nvarchar (50)) , '-') + ISNULL ( HFTCS.CollectionSourceName_External , '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTW.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTW.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTW.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 500) , '-') + 'HFit_TrackerWeight') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerWeight AS HFTW
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTW.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTW.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTW.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerWeight , NULL) AS CT_TrackerTable
                    ON HFTW.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTW.EventDate , HFTW.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTW.EventDate , HFTW.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTW.ItemCreatedWhen IS NOT NULL OR
            HFTW.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014			

   UNION ALL
   SELECT DISTINCT
          HFTHA.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTHA.ItemCreatedWhen
        , HFTHA.ItemModifiedWhen
        , HFTHA.Notes
        , HFTHA.IsProfessionallyCollected
        , HFTHA.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , HFTHA.Value AS PPTHbA1C
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTHA.ItemCreatedWhen = COALESCE ( HFTHA.ItemModifiedWhen , HFTHA.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTHA.ItemCreatedWhen
        , HFTHA.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTHA.itemid
        , 'HFit_TrackerHbA1c' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , +ISNULL ( CAST ( HFTHA.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTHA.Notes , 1000) , '-') + ISNULL ( CAST ( HFTHA.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.Value AS nvarchar (250)) , '-') + ISNULL ( LEFT (
                               HFTCS.CollectionSourceName_External , 1000) , '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTHA.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 250) , '-') + 'HFit_TrackerHbA1c') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerHbA1c AS HFTHA
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTHA.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTHA.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTHA.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHbA1c , NULL) AS CT_TrackerTable
                    ON HFTHA.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTHA.EventDate , HFTHA.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTHA.EventDate , HFTHA.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTHA.ItemCreatedWhen IS NOT NULL OR
            HFTHA.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTC.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTC.ItemCreatedWhen
        , HFTC.ItemModifiedWhen
        , HFTC.Notes
        , HFTC.IsProfessionallyCollected
        , HFTC.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , HFTC.Fasting
        , HFTC.HDL
        , HFTC.LDL
        , HFTC.Ratio
        , HFTC.Total
        , HFTC.Tri
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTC.ItemCreatedWhen = COALESCE ( HFTC.ItemModifiedWhen , HFTC.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTC.ItemCreatedWhen
        , HFTC.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTC.itemid
        , 'HFit_TrackerCholesterol' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' ,
          + ISNULL ( CAST ( HFTC.UserID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID  AS nvarchar (50)) , '-') + ISNULL (
          CAST ( cus.HFitUserMpiNumber  AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( cs.SiteGUID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.ItemCreatedWhen  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.ItemModifiedWhen  AS nvarchar (50)) ,
          '-') + ISNULL ( LEFT ( HFTC.Notes , 1000) , '-') + ISNULL ( CAST ( HFTC.IsProfessionallyCollected  AS nvarchar (50)) , '-') + ISNULL ( CAST
          ( HFTC.EventDate  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.Fasting  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.HDL  AS nvarchar (50)) ,
          '-') + ISNULL ( CAST ( HFTC.LDL  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.Ratio  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.Total  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.Tri  AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 250) , '-') + ISNULL ( CAST
          ( HFA.AccountID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.ItemCreatedWhen
          AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.ItemModifiedWhen  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.itemid  AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID  AS nvarchar (50)) , '-') + ISNULL (
          LEFT ( VENDOR.VendorName , 250) , '-') + 'HFit_TrackerCholesterol') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerCholesterol AS HFTC
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTC.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTC.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTC.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCholesterol , NULL) AS CT_TrackerTable
                    ON HFTC.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTC.EventDate , HFTC.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTC.EventDate , HFTC.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTC.ItemCreatedWhen IS NOT NULL OR
            HFTC.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTBSAG.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTBSAG.ItemCreatedWhen
        , HFTBSAG.ItemModifiedWhen
        , HFTBSAG.Notes
        , HFTBSAG.IsProfessionallyCollected
        , HFTBSAG.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTBSAG.Units
        , HFTBSAG.FastingState
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTBSAG.ItemCreatedWhen = COALESCE ( HFTBSAG.ItemModifiedWhen , HFTBSAG.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTBSAG.ItemCreatedWhen
        , HFTBSAG.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTBSAG.itemid
        , 'HFit_TrackerBloodSugarAndGlucose' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , +ISNULL ( CAST ( HFTBSAG.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBSAG.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTBSAG.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTBSAG.Notes , 250) , '-') + ISNULL ( CAST ( HFTBSAG.IsProfessionallyCollected
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBSAG.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBSAG.Units AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBSAG.FastingState AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 250) , '-') + ISNULL ( CAST (
                               HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBSAG.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTBSAG.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTBSAG.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT (
                               VENDOR.VendorName , 250) , '-') + 'HFit_TrackerBloodSugarAndGlucose') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerBloodSugarAndGlucose AS HFTBSAG
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTBSAG.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTBSAG.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTBSAG.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodSugarAndGlucose , NULL) AS CT_TrackerTable
                    ON HFTBSAG.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTBSAG.EventDate , HFTBSAG.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTBSAG.EventDate , HFTBSAG.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTBSAG.ItemCreatedWhen IS NOT NULL OR
            HFTBSAG.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTBP.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTBP.ItemCreatedWhen
        , HFTBP.ItemModifiedWhen
        , HFTBP.Notes
        , HFTBP.IsProfessionallyCollected
        , HFTBP.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTBP.Systolic
        , HFTBP.Diastolic
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTBP.ItemCreatedWhen = COALESCE ( HFTBP.ItemModifiedWhen , HFTBP.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTBP.ItemCreatedWhen
        , HFTBP.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTBP.itemid
        , 'HFit_TrackerBloodPressure' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , +ISNULL ( CAST ( HFTBP.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBP.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBP.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTBP.Notes , 500) , '-') + ISNULL ( CAST ( HFTBP.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL
                               ( CAST ( HFTBP.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBP.Systolic AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTBP.Diastolic AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 500) , '-') + ISNULL ( CAST ( HFA.AccountID
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBP.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBP.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTBP.itemid
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName ,
                               500) , '-') + 'HFit_TrackerBloodPressure') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerBloodPressure AS HFTBP
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTBP.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTBP.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTBP.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodPressure , NULL) AS CT_TrackerTable
                    ON HFTBP.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTBP.EventDate , HFTBP.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTBP.EventDate , HFTBP.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTBP.ItemCreatedWhen IS NOT NULL OR
            HFTBP.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTBF.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTBF.ItemCreatedWhen
        , HFTBF.ItemModifiedWhen
        , HFTBF.Notes
        , HFTBF.IsProfessionallyCollected
        , HFTBF.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTBF.Value AS PPTBodyFatPCT
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTBF.ItemCreatedWhen = COALESCE ( HFTBF.ItemModifiedWhen , HFTBF.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTBF.ItemCreatedWhen
        , HFTBF.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTBF.itemid
        , 'HFit_TrackerBodyFat' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTBF.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTBF.Notes , 1000) , '-') + ISNULL ( CAST ( HFTBF.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.Value AS nvarchar (50)) , '-') + ISNULL ( LEFT (
                               HFTCS.CollectionSourceName_External , 250) , '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTBF.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 250) , '-') + 'HFit_TrackerBodyFat') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerBodyFat AS HFTBF
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTBF.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTBF.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTBF.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyFat , NULL) AS CT_TrackerTable
                    ON HFTBF.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTBF.EventDate , HFTBF.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTBF.EventDate , HFTBF.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTBF.ItemCreatedWhen IS NOT NULL OR
            HFTBF.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTB.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTB.ItemCreatedWhen
        , HFTB.ItemModifiedWhen
        , HFTB.Notes
        , HFTB.IsProfessionallyCollected
        , HFTB.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTB.BMI
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTB.ItemCreatedWhen = COALESCE ( HFTB.ItemModifiedWhen , HFTB.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTB.ItemCreatedWhen
        , HFTB.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTB.itemid
        , 'HFit_TrackerBMI' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTB.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cs.SiteGUID
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.ItemModifiedWhen AS nvarchar (50)) ,
                               '-') + ISNULL ( LEFT ( HFTB.Notes , 1000) , '-') + ISNULL ( CAST ( HFTB.IsProfessionallyCollected AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTB.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.BMI AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 1000) ,
                               '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerBMI') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerBMI AS HFTB
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTB.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTB.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTB.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBMI , NULL) AS CT_TrackerTable
                    ON HFTB.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTB.EventDate , HFTB.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTB.EventDate , HFTB.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTB.ItemCreatedWhen IS NOT NULL OR
            HFTB.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTBM.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTBM.ItemCreatedWhen
        , HFTBM.ItemModifiedWhen
        , HFTBM.Notes
        , HFTBM.IsProfessionallyCollected
        , HFTBM.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTBM.WaistInches
        , HFTBM.HipInches
        , HFTBM.ThighInches
        , HFTBM.ArmInches
        , HFTBM.ChestInches
        , HFTBM.CalfInches
        , HFTBM.NeckInches
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTBM.ItemCreatedWhen = COALESCE ( HFTBM.ItemModifiedWhen , HFTBM.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTBM.ItemCreatedWhen
        , HFTBM.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTBM.itemid
        , 'HFit_TrackerBodyMeasurements' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTBM.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTBM.Notes , 1000) , '-') + ISNULL ( CAST ( HFTBM.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.WaistInches AS nvarchar (50)) , '-') + ISNULL ( CAST
                               ( HFTBM.HipInches AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.ThighInches AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.ArmInches AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTBM.ChestInches AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.CalfInches AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTBM.NeckInches AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 1000) , '-') + ISNULL ( CAST
                               ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTBM.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTBM.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT (
                               VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerBodyMeasurements') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerBodyMeasurements AS HFTBM
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTBM.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTBM.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTBM.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyMeasurements , NULL) AS CT_TrackerTable
                    ON HFTBM.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTBM.EventDate , HFTBM.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTBM.EventDate , HFTBM.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTBM.ItemCreatedWhen IS NOT NULL OR
            HFTBM.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTH.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTH.ItemCreatedWhen
        , HFTH.ItemModifiedWhen
        , HFTH.Notes
        , HFTH.IsProfessionallyCollected
        , HFTH.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTH.Height
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTH.ItemCreatedWhen = COALESCE ( HFTH.ItemModifiedWhen , HFTH.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTH.ItemCreatedWhen
        , HFTH.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTH.itemid
        , 'HFit_TrackerHeight' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTH.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cs.SiteGUID
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTH.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTH.ItemModifiedWhen AS nvarchar (50)) ,
                               '-') + ISNULL ( LEFT ( HFTH.Notes , 1000) , '-') + ISNULL ( CAST ( HFTH.IsProfessionallyCollected AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTH.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTH.Height AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External ,
                               1000) , '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTH.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTH.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST
                               ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTH.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerHeight') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerHeight AS HFTH
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTH.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTH.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTH.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHeight , NULL) AS CT_TrackerTable
                    ON HFTH.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTH.EventDate , HFTH.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTH.EventDate , HFTH.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTH.ItemCreatedWhen IS NOT NULL OR
            HFTH.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTRHR.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTRHR.ItemCreatedWhen
        , HFTRHR.ItemModifiedWhen
        , HFTRHR.Notes
        , HFTRHR.IsProfessionallyCollected
        , HFTRHR.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTRHR.HeartRate
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTRHR.ItemCreatedWhen = COALESCE ( HFTRHR.ItemModifiedWhen , HFTRHR.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTRHR.ItemCreatedWhen
        , HFTRHR.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTRHR.itemid
        , 'HFit_TrackerRestingHeartRate' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTRHR.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTRHR.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTRHR.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTRHR.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTRHR.EventDate AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTRHR.HeartRate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTRHR.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTRHR.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTRHR.itemid AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTRHR.Notes , 1000) , '-') + ISNULL (
                               LEFT ( HFTCS.CollectionSourceName_External , 1000) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerRestingHeartRate') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerRestingHeartRate AS HFTRHR
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTRHR.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTRHR.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTRHR.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerRestingHeartRate , NULL) AS CT_TrackerTable
                    ON HFTRHR.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTRHR.EventDate , HFTRHR.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTRHR.EventDate , HFTRHR.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTRHR.ItemCreatedWhen IS NOT NULL OR
            HFTRHR.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTS.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTS.ItemCreatedWhen
        , HFTS.ItemModifiedWhen
        , HFTS.Notes
        , HFTS.IsProfessionallyCollected
        , HFTS.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTS.FluShot
        , HFTS.PneumoniaShot
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTS.ItemCreatedWhen = COALESCE ( HFTS.ItemModifiedWhen , HFTS.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTS.ItemCreatedWhen
        , HFTS.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTS.itemid
        , 'HFit_TrackerShots' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTS.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cs.SiteGUID
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.ItemModifiedWhen AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTS.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.EventDate AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTS.FluShot AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.PneumoniaShot AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTS.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT (
                               HFTS.Notes , 1000) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 1000) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerShots') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerShots AS HFTS
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTS.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTS.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTS.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerShots , NULL) AS CT_TrackerTable
                    ON HFTS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTS.EventDate , HFTS.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTS.EventDate , HFTS.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTS.ItemCreatedWhen IS NOT NULL OR
            HFTS.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTT.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTT.ItemCreatedWhen
        , HFTT.ItemModifiedWhen
        , HFTT.Notes
        , HFTT.IsProfessionallyCollected
        , HFTT.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTT.PSATest
        , HFTT.OtherExam
        , HFTT.TScore
        , HFTT.DRA
        , HFTT.CotinineTest
        , HFTT.ColoCareKit
        , HFTT.CustomTest
        , HFTT.CustomDesc
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTT.ItemCreatedWhen = COALESCE ( HFTT.ItemModifiedWhen , HFTT.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTT.ItemCreatedWhen
        , HFTT.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTT.itemid
        , 'HFit_TrackerTests' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , +ISNULL ( CAST ( HFTT.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.EventDate
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.PSATest AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.OtherExam AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTT.TScore AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.DRA AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.CotinineTest AS nvarchar (50)) ,
                               '-') + ISNULL (
                               CAST ( HFTT.ColoCareKit AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.CustomTest AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTT.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT (
                               HFTCS.CollectionSourceName_External , 1000) , '-') + ISNULL ( LEFT ( HFTT.Notes , 1000) , '-') + ISNULL ( LEFT ( HFTT.CustomDesc , 1000) , '-') + ISNULL (
                               LEFT ( VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerTests') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerTests AS HFTT
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTT.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTT.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTT.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerTests , NULL) AS CT_TrackerTable
                    ON HFTT.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTT.EventDate , HFTT.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTT.EventDate , HFTT.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTT.ItemCreatedWhen IS NOT NULL OR
            HFTT.EventDate IS NOT NULL);

--Add per RObert and Laura 12.4.2014
--HFit_TrackerBMI
--HFit_TrackerBodyMeasurements
--HFit_TrackerHeight
--HFit_TrackerRestingHeartRate
--HFit_TrackerShots
--HFit_TrackerTests

GO

PRINT 'Created view_EDW_BioMetrics_CT: ' + CAST ( GETDATE () AS nvarchar (50)) ;

GO

--  
--  

GO

PRINT '***** FROM: view_EDW_BioMetrics_CT.sql';

GO

----***************************************************************************************************************************
----** REMOVE THE INSERTS AFTER INTITAL LOAD
----***************************************************************************************************************************
--truncate table EDW_BiometricViewRejectCriteria ;
--go 
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'trstmark','11/4/2013',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'entergy','1/6/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'mcwp','1/27/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'stateneb','4/1/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'jnj','5/28/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'coopers','7/1/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'cnh','8/4/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'amat','8/4/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'dupont','8/18/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'ejones','9/3/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'avera','9/15/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'sprvalu','9/18/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'firstgrp','10/6/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'rexnord','12/2/2014',-1) ;
--GO

PRINT '***** COMPLETED : view_EDW_BioMetrics_CT.sql';

GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_HealthAssesmentClientView_CT.sql" \n 
--------------------------------------------------------------- 


go
-- use KenticoCMS_Prod1


GO
PRINT 'Processing: view_EDW_HealthAssesmentClientView_CT ';
GO

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
             WHERE TABLE_NAME = 'view_EDW_HealthAssesmentClientView_CT') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssesmentClientView_CT;
    END;
GO

CREATE VIEW dbo.view_EDW_HealthAssesmentClientView_CT
AS SELECT 
          HFitAcct.AccountID
        , HFitAcct.AccountCD
        , HFitAcct.AccountName
        , HFitAcct.ItemGUID AS ClientGuid
        , CMSSite.SiteGUID
        , NULL AS CompanyID
        , NULL AS CompanyGUID
        , NULL AS CompanyName
        , HAJoined.DocumentName
        , HACampaign.DocumentPublishFrom AS HAStartDate
        , HACampaign.DocumentPublishTo AS HAEndDate
        , HACampaign.NodeSiteID
        , HAAssessmentMod.Title
        , HAAssessmentMod.CodeName
        , HAAssessmentMod.IsEnabled
        , CASE
              WHEN CAST (HACampaign.DocumentCreatedWhen AS date) = CAST (HACampaign.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HACampaign.DocumentCreatedWhen
        , HACampaign.DocumentModifiedWhen
        , HAAssessmentMod.DocumentModifiedWhen AS AssesmentModule_DocumentModifiedWhen     --09.11.2014 (wdm) added to facilitate EDW last mod date
        , HAAssessmentMod.DocumentCulture AS DocumentCulture_HAAssessmentMod
        , HACampaign.DocumentCulture AS DocumentCulture_HACampaign
        , HAJoined.DocumentCulture AS DocumentCulture_HAJoined
        , HACampaign.BiometricCampaignStartDate
        , HACampaign.BiometricCampaignEndDate
        , HACampaign.CampaignStartDate
        , HACampaign.CampaignEndDate
        , HACampaign.Name
        , HACampaign.NodeGuid AS CampaignNodeGuid
        , HACampaign.HACampaignID
,	   HASHBYTES ('sha1', isNull(cast(HFitAcct.AccountID as nvarchar(50)), '-') 
					+ isNull(cast(HFitAcct.AccountCD as nvarchar(50)), '-') 
					+ isNull(cast(HFitAcct.AccountName as nvarchar(50)), '-') 
					+ isNull(cast(HFitAcct.ItemGUID as nvarchar(50)), '-') 
					+ isNull(cast(CMSSite.SiteGUID as nvarchar(50)), '-') 
					+ isNull(cast(HAJoined.DocumentName as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.DocumentPublishFrom as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.DocumentPublishTo  as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.NodeSiteID as nvarchar(50)), '-') 
					+ isNull(cast(left(HAAssessmentMod.Title,2000) as nvarchar(50)), '-') 
					+ isNull(cast(HAAssessmentMod.CodeName as nvarchar(50)), '-') 
					+ isNull(cast(HAAssessmentMod.IsEnabled as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.DocumentCreatedWhen as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.DocumentModifiedWhen as nvarchar(50)), '-') 
					+ isNull(cast(HAAssessmentMod.DocumentModifiedWhen as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.BiometricCampaignStartDate as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.BiometricCampaignEndDate as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.CampaignStartDate as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.CampaignEndDate as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.Name as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.NodeGuid as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.HACampaignID as nvarchar(50)), '-') )as HashCode
         , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	   FROM
               dbo.View_HFit_HACampaign_Joined AS HACampaign
                   INNER JOIN dbo.CMS_Site AS CMSSite
                       ON HACampaign.NodeSiteID = CMSSite.SiteID
                   INNER JOIN dbo.HFit_Account AS HFitAcct
                       ON HACampaign.NodeSiteID = HFitAcct.SiteID
                   INNER JOIN dbo.View_HFit_HealthAssessment_Joined AS HAJoined
                       ON HACampaign.HealthAssessmentID = HAJoined.DocumentID      --  added line to handle    SR #51281   
                          -- ON CASE ----03.27.2015 - Commented code to release the SR #51281
                          --WHEN [HACampaign].[HealthAssessmentConfigurationID] < 0
                          --THEN [HACampaign].[HealthAssessmentID]
                          --ELSE [HACampaign].[HealthAssessmentConfigurationID]
                          --END = HAJoined.DocumentID
                      AND HAJoined.DocumentCulture = 'en-US'
                   INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS HAAssessmentMod
                       ON HAJoined.nodeid = HAAssessmentMod.NodeParentID
                      AND HAAssessmentMod.DocumentCulture = 'en-US'
     WHERE HACampaign.DocumentCulture = 'en-US';


GO

PRINT 'Created: view_EDW_HealthAssesmentClientView_CT ';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthAssesmentClientView_CT.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "udf_CkHaChanged.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating function udf_CkUserTrackerHasChanged.';
PRINT 'FROM udf_CkUserTrackerHasChanged.sql';
GO
IF EXISTS (SELECT
              *
                  FROM   sys.objects
                  WHERE
                  object_id = OBJECT_ID (N'[dbo].[udf_CkUserTrackerHasChanged]') 
              AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT')) 
    BEGIN
        DROP FUNCTION
           dbo.udf_CkUserTrackerHasChanged
    END;
GO
/*
declare @iChg as int = (select dbo.udf_CkUserTrackerHasChanged ()) ;
print @iChg;
*/
CREATE FUNCTION udf_CkUserTrackerHasChanged ()
                --@TF bit) 
RETURNS int
AS
BEGIN

/*
    If a 0 is returned, NO updates were found.
    If a 1 is returned, updates were found.
    If a 2 is returned, deletes were found.
*/

    DECLARE
           @UpdatesFound AS TABLE
           (
   chgFlg nvarchar (10) NULL) ;

    DECLARE
           @b AS int = 0;

    INSERT INTO @UpdatesFound (
       chgFlg)    
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_Class, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_Document, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_Site, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_User, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES COM_SKU, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_Account, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HACampaign, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserAnswers, NULL) AS CT
	   UNION ALL
	   
Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserModule, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestion, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskCategory, NULL) AS CT

	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_LKP_EDW_RejectMPI, NULL) AS CT ;

    DECLARE
           @iDel AS int = 0;
    DECLARE
           @iUpdt AS int = 0;

    SET @iUpdt = (SELECT
                     COUNT (*) 
                         FROM @UpdatesFound);
    SET @iDel = (SELECT
                    COUNT (*) 
                        FROM @UpdatesFound
                        WHERE chgFlg = 'D');

    IF @iUpdt > 0
        BEGIN
            SET @b = 1;
        END
    ELSE
        BEGIN
            SET @b = 0;
        END;

    IF @iDel > 0
        BEGIN
            SET @b = 2
        END;

    RETURN @b;

END;
GO
PRINT 'Created function udf_CkUserTrackerHasChanged.';
PRINT 'FROM udf_CkUserTrackerHasChanged.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\EDW_Proc_Performance_Monitor.sql" \n 
--------------------------------------------------------------- 

GO

PRINT 'Creating table EDW_Proc_Performance_Monitor';
PRINT 'FROM EDW_Proc_Performance_Monitor.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'EDW_Proc_Performance_Monitor') 
    BEGIN
        DROP TABLE
             dbo.EDW_Proc_Performance_Monitor
    END;

GO

/****** Object:  Table [dbo].[EDW_Proc_Performance_Monitor]    Script Date: 5/11/2015 2:07:52 PM ******/

SET ANSI_NULLS ON;
GO

SET QUOTED_IDENTIFIER ON;
GO
/*
alter table EDW_Proc_Performance_Monitor alter column ElapsedSecs float null 
alter table EDW_Proc_Performance_Monitor alter column ElapsedMin float null 
alter table EDW_Proc_Performance_Monitor alter column ElapsedHrs float null 
*/
CREATE TABLE dbo.EDW_Proc_Performance_Monitor (
TraceName nvarchar (100) NOT NULL
           ,TrackID nvarchar (50) NOT NULL
           ,StartTime datetime NOT NULL
           ,EndTime datetime NULL
           ,ElapsedTime int NULL
           ,ElapsedTimeUnits nvarchar (50) NULL
		  ,AccumulatedTime int NULL
		  ,ElapsedSecs float
		  ,ElapsedMin  float
		  ,ElapsedHrs  float
           ,Rownbr int IDENTITY (1, 1) 
                       NOT NULL
           ,CONSTRAINT PK_EDW_Proc_Performance_Monitor PRIMARY KEY CLUSTERED
             (
             TraceName ASC, TrackID asc, Rownbr
             ) 
                WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) 
ON [PRIMARY];

GO

ALTER TABLE dbo.EDW_Proc_Performance_Monitor
ADD
            CONSTRAINT DF_EDW_Proc_Performance_Monitor_StartTime  DEFAULT GETDATE () FOR StartTime;
GO

PRINT 'CREATED table EDW_Proc_Performance_Monitor';
PRINT 'FROM EDW_Proc_Performance_Monitor.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_BioMetrics_STAGE.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating view_EDW_BioMetrics_STAGED';
PRINT 'FROM: view_EDW_BioMetrics_STAGE.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE
                        name = 'view_EDW_BioMetrics_STAGED') 
    BEGIN
        DROP VIEW
             view_EDW_BioMetrics_STAGED
    END;

GO
CREATE VIEW view_EDW_BioMetrics_STAGED
AS SELECT
          [UserID]
      ,[UserGUID]
      ,[HFitUserMpiNumber]
      ,[SiteID]
      ,[SiteGUID]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[Notes]
      ,[IsProfessionallyCollected]
      ,[EventDate]
      ,[EventName]
      ,[PPTWeight]
      ,[PPTHbA1C]
      ,[Fasting]
      ,[HDL]
      ,[LDL]
      ,[Ratio]
      ,[Total]
      ,[Triglycerides]
      ,[Glucose]
      ,[FastingState]
      ,[Systolic]
      ,[Diastolic]
      ,[PPTBodyFatPCT]
      ,[BMI]
      ,[WaistInches]
      ,[HipInches]
      ,[ThighInches]
      ,[ArmInches]
      ,[ChestInches]
      ,[CalfInches]
      ,[NeckInches]
      ,[Height]
      ,[HeartRate]
      ,[FluShot]
      ,[PneumoniaShot]
      ,[PSATest]
      ,[OtherExam]
      ,[TScore]
      ,[DRA]
      ,[CotinineTest]
      ,[ColoCareKit]
      ,[CustomTest]
      ,[CustomDesc]
      ,[CollectionSource]
      ,[AccountID]
      ,[AccountCD]
      ,[ChangeType]
      ,[ItemCreatedWhen]
      ,[ItemModifiedWhen]
      ,[TrackerCollectionSourceID]
      ,[itemid]
      ,[TBL]
      ,[VendorID]
      ,[VendorName]
          FROM dbo.STAGING_EDW_BioMetrics;
GO
PRINT 'CREATED view_EDW_BioMetrics_STAGE.sql';
GO


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_SmallStepResponses_STAGED.sql" \n 
--------------------------------------------------------------- 


go
Print 'Creating view_EDW_SmallStepResponses_STAGED.sql' ;
go

if exists (select name from sys.views where name = 'view_EDW_SmallStepResponses_STAGED')
 drop view view_EDW_SmallStepResponses_STAGED ;
go

create view view_EDW_SmallStepResponses_STAGED as 
SELECT [UserID]
      ,[AccountCD]
      ,[SiteGUID]
      ,[SSItemID]
      ,[SSItemCreatedBy]
      ,[SSItemCreatedWhen]
      ,[SSItemModifiedBy]
      ,[SSItemModifiedWhen]
      ,[SSItemOrder]
      ,[SSItemGUID]
      ,[SSHealthAssesmentUserStartedItemID]
      ,[SSOutcomeMessageGuid]
      ,[SSOutcomeMessage]
      ,[HACampaignNodeGUID]
      ,[HACampaignName]
      ,[HACampaignStartDate]
      ,[HACampaignEndDate]
      ,[HAStartedDate]
      ,[HACompletedDate]
      ,[HAStartedMode]
      ,[HACompletedMode]
      ,[HaCodeName]
      ,[HFitUserMPINumber]
  FROM [dbo].STAGING_EDW_SmallSteps
GO


Print 'Created view_EDW_SmallStepResponses_STAGED' ;
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_TrackersComposite_STAGED.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating view view_EDW_TrackersComposite_STAGED';
PRINT 'Generated FROM: view_EDW_TrackersComposite_STAGED.SQL';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_TrackersComposite_STAGED') 
    BEGIN
        PRINT 'VIEW view_EDW_TrackersComposite_STAGED, replacing.';
        DROP VIEW
             view_EDW_TrackersComposite_STAGED;
    END;
GO

--select top 1000 * from view_EDW_TrackersComposite_STAGED

create view view_EDW_TrackersComposite_STAGED
as
SELECT [TrackerNameAggregateTable]
      ,[ItemID]
      ,[EventDate]
      ,[IsProfessionallyCollected]
      ,[TrackerCollectionSourceID]
      ,[Notes]
      ,[UserID]
      ,[CollectionSourceName_Internal]
      ,[CollectionSourceName_External]
      ,[EventName]
      ,[UOM]
      ,[KEY1]
      ,[VAL1]
      ,[KEY2]
      ,[VAL2]
      ,[KEY3]
      ,[VAL3]
      ,[KEY4]
      ,[VAL4]
      ,[KEY5]
      ,[VAL5]
      ,[KEY6]
      ,[VAL6]
      ,[KEY7]
      ,[VAL7]
      ,[KEY8]
      ,[VAL8]
      ,[KEY9]
      ,[VAL9]
      ,[KEY10]
      ,[VAL10]
      ,[ItemCreatedBy]
      ,[ItemCreatedWhen]
      ,[ItemModifiedBy]
      ,[ItemModifiedWhen]
      ,[IsProcessedForHa]
      ,[TXTKEY1]
      ,[TXTVAL1]
      ,[TXTKEY2]
      ,[TXTVAL2]
      ,[TXTKEY3]
      ,[TXTVAL3]
      ,[ItemOrder]
      ,[ItemGuid]
      ,[UserGuid]
      ,[MPI]
      ,[ClientCode]
      ,[SiteGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[IsAvailable]
      ,[IsCustom]
      ,[UniqueName]
      ,[ColDesc]
      ,[VendorID]
      ,[VendorName]
  FROM [dbo].Staging_EDW_Trackers
GO

PRINT 'Created view view_EDW_TrackersComposite_STAGED';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_HealthAssesmentClientView_STAGED.sql" \n 
--------------------------------------------------------------- 



GO
PRINT 'Creating view view_EDW_HealthAssesmentClientView_STAGED';
PRINT 'Generated FROM: view_EDW_HealthAssesmentClientView_STAGED.SQL';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_HealthAssesmentClientView_STAGED') 
    BEGIN
        PRINT 'VIEW view_EDW_HealthAssesmentClientView_STAGED, replacing.';
        DROP VIEW
             view_EDW_HealthAssesmentClientView_STAGED;
    END;
GO

create view view_EDW_HealthAssesmentClientView_STAGED
as 
SELECT [AccountID]
      ,[AccountCD]
      ,[AccountName]
      ,[ClientGuid]
      ,[SiteGUID]
      ,[CompanyID]
      ,[CompanyGUID]
      ,[CompanyName]
      ,[DocumentName]
      ,[HAStartDate]
      ,[HAEndDate]
      ,[NodeSiteID]
      ,[Title]
      ,[CodeName]
      ,[IsEnabled]
      ,[ChangeType]
      ,[DocumentCreatedWhen]
      ,[DocumentModifiedWhen]
      ,[AssesmentModule_DocumentModifiedWhen]
      ,[DocumentCulture_HAAssessmentMod]
      ,[DocumentCulture_HACampaign]
      ,[DocumentCulture_HAJoined]
      ,[BiometricCampaignStartDate]
      ,[BiometricCampaignEndDate]
      ,[CampaignStartDate]
      ,[CampaignEndDate]
      ,[Name]
      ,[CampaignNodeGuid]
      ,[HACampaignID]
  FROM [dbo].[view_EDW_HealthAssesmentClientView]
GO

PRINT 'Created view view_EDW_HealthAssesmentClientView_STAGED';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\HFit_Rewrite\CurrentWork\view_EDW_RewardUserDetail_STAGED.sql" \n 
--------------------------------------------------------------- 


go
print 'Creating view_EDW_RewardUserDetail_STAGED.sql'

go
if exists (select name from sys.views where name = 'view_EDW_RewardUserDetail_STAGED')
    drop view view_EDW_RewardUserDetail_STAGED;
go

create view view_EDW_RewardUserDetail_STAGED
as
SELECT [UserGUID]
      ,[SiteGUID]
      ,[HFitUserMpiNumber]
      ,[RewardActivityGUID]
      ,[RewardProgramName]
      ,[RewardModifiedDate]
      ,[RewardLevelModifiedDate]
      ,[LevelCompletedDt]
      ,[ActivityPointsEarned]
      ,[ActivityCompletedDt]
      ,[RewardActivityModifiedDate]
      ,[ActivityPoints]
      ,[UserAccepted]
      ,[UserExceptionAppliedTo]
      ,[RewardTriggerGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[ChangeType]
      ,[RewardExceptionModifiedDate]
  FROM [dbo].STAGING_EDW_RewardUserDetail
GO
print 'Created view_EDW_RewardUserDetail_STAGED.sql'
go--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "PROC_Staging_Pull_EDW_HealthAssesment_TEMPDATA.sql" \n 
--------------------------------------------------------------- 

/*
73 Changes found
0 Inserts found
73 Updates found
0 Deletes found
**Notice: Changes found, NO DELETES found, processing only new HA inserts and updates.
Jun  8 2015  7:14PM
TEMP RECORDS RETURNED:252021
ENDTIME: 
Jun  8 2015  8:28PM
**********
@secs = 4428.000
@mins = 73.800
@@hrs = 1.230
***INFO: Number of records that have changes: 252021
TIME TO PULL DATA in minutes: 74.00 minutes.
TIME TO PULL DATA in hours: 1.00 hours.
 

--*********************************************************
3 Changes found
0 Inserts found
3 Updates found
0 Deletes found
**Notice: NO DELETES found, processing only HA inserts and updates.
Jun  5 2015  2:54PM
TEMP RECORDS RETURNED:252021
ENDTIME: 
Jun  5 2015  3:53PM
**********
@secs = 3539.000
@mins = 58.983
@@hrs = 0.983
***INFO: Number of records that have changes: 252021
TIME TO PULL DATA in minutes: 59.00 minutes.
TIME TO PULL DATA in hours: 1.00 hours.
 --**********************************************************
2 Changes found
0 Inserts found
2 Updates found
0 Deletes found
**Notice: NO DELETES found, processing only inserts and updates.
TIME TO BUILD TEMP TABLES in seconds: 4
***INFO: Number of records to evaluate for changes: 221
***INFO: Number of records removed that do not have changes: 221
***INFO: Number of records left to process: 0
Time REMOVE non-changed: 0
TIME TO PULL DATA in seconds: 4 @ 0.00 minutes.
TIME TO CONVERT HASH in seconds: 0 @ Minutes = 0.00
TIME TOTAL Elapsed Time in seconds: 8 @ Minutes = 0.00
** LOADING STAGING Data to table DIM_EDW_HealthAssessment.
TIME TOTAL TO Load from @HARECS : 2 @ Minutes = 0.00
TOTAL RECORDS PULLED: 0
 

*/

GO

PRINT 'Creating procedure PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA';
PRINT 'FROM PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA.sql';

GO

/*    
    select * into TEMP_HA_DO_NOT_KEEP from TEMP_EDW_HealthAssessment_DATA
*/

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA' )

    BEGIN

        DROP PROCEDURE
             PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA;
    END;

GO

CREATE PROCEDURE PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA ( @ReloadAllData AS int = 0
                                                                , @StartID AS bigint = -1
                                                                , @EndID AS bigint = 0 )
AS
BEGIN

    --***********************************************************************
    --EXEC PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA 1 ;
    --EXEC PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA 0;
    --PullChangesOnly = 0; fills the TEMP table ONLY with data that has changed
    --PullChangesOnly = 1; fills the TEMP STAGING TABLE for FULL Reloads.
    --@StartID >= 0 and @EndID > 0 and PullChangesOnly = 0, then only changes 
    --		 between the Start and End ID will be pulled.
    --Select count(*) from TEMP_EDW_HealthAssessment_DATA
    --Select top 1000 * from TEMP_EDW_HealthAssessment_DATA
    --***********************************************************************
    --** CHANGES:
    --05.11.2015 - (WDM) Changed proc to FILL the TEMP table
    --***********************************************************************

    SET NOCOUNT ON;

    --declare @ReloadAllData as int  = 0 ;

    DECLARE
       @startdate datetime2 = GETDATE ( )
       ,@startPullDate datetime2 = GETDATE ( )
       ,@RecordsPulled AS int
       ,@HRPART AS decimal ( 10 , 2 )
       ,@MINPART AS decimal ( 10 , 2 )
       ,@SECPART AS decimal ( 10 , 2 )
       ,@TOTSECS AS decimal ( 10 , 2 ) = 0
       ,@proc_RowGuid AS uniqueidentifier = NEWID ( )
       ,@CALLING_PROC AS nvarchar ( 100 ) = 'PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA'
       ,@PROC_LOCATION AS nvarchar ( 100 ) = ''
       ,@proc_starttime AS datetime = GETDATE ( )
       ,@proc_endtime AS datetime = NULL
       ,@proc_elapsedsecs AS bigint = 0
       ,@proc_RowsProcessed AS bigint = 0
       ,@MINS AS decimal ( 10 , 2 ) = 0;

    EXEC proc_EDW_Procedure_Performance_Monitor 'D' , @CALLING_PROC;
    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , '001';

    --  exec proc_CT_Performance_History @proc_RowGuid, @CALLING_PROC, @PROC_LOCATION, @proc_starttime, @proc_endtime, @proc_elapsedsecs, @proc_RowsProcessed ;

    IF
           @ReloadAllData = 0
        OR @ReloadAllData IS NULL
        BEGIN
            SET @PROC_LOCATION = 'LOAD CHANGES ONLY';
        END;

    IF @ReloadAllData = 1
        BEGIN
            SET @PROC_LOCATION = 'FULL RELOAD';
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , 'START FULL RELOAD';
            --***************************************************
            EXEC @RecordsPulled = proc_Load_HA_CT_TempTable 2 , @StartID , @EndID;
            --***************************************************
            PRINT '***INFO: Number of records to evaluate: ' + CAST ( @RecordsPulled AS nvarchar ( 20 ));
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , 'FULL RELOAD';
            EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CALLING_PROC;
            PRINT '***MSG: ALL HA DATA RELOADED';
            RETURN @RecordsPulled;
        END;

    --********************************************************************************
    -- ** BEFORE WE DO ANYTHING, LET'S SEE IF THERE ARE CHANGES TO PROCESS
    --********************************************************************************
    -- 0 = no changes, 1 = changes found and no deletes, 2 = DELETES found


declare @iChgTypes as int = 0 ; 
declare @NbrOfDetectedChanges as bigint = 0 ; 
    EXEC @iChgTypes = proc_CkHaDataChanged NULL, @NbrOfDetectedChanges OUTPUT;
    PRINT 'iChgType is: ' + CAST (@iChgTypes AS nvarchar (50)) ;
    PRINT 'Total Number Of Changes to process is: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) ;

    IF
    @iChgTypes = 0
        BEGIN
            PRINT '**NO CHANGES FOUND, RETURNING.';
            EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CALLING_PROC;
            RETURN 0;
        END;

    IF
           @ReloadAllData = 0
       AND @StartID >= 0
       AND @EndID > 0
        BEGIN
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , 'PULLING CHANGES BETWEEN IDs';
            PRINT '***INFO: PULLING CHANGES BETWEEN CHANGE TRACKING IDs.';
            --***************************************************
            EXEC @RecordsPulled = proc_Load_HA_CT_TempTable 3 , @StartID , @EndID;
            --***************************************************
            PRINT '***INFO: PULLING CHANGES BETWEEN CHANGE TRACKING IDs.';
            PRINT '***INFO: Number of records to evaluate: ' + CAST ( @RecordsPulled AS nvarchar ( 20 ));
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , 'FULL RELOAD';
            EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CALLING_PROC;
            PRINT '***MSG: ALL HA DATA RELOADED';
            RETURN @RecordsPulled;
        END;

    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , '006 - Populate Table VAR';
    IF @iChgTypes = 2
        BEGIN
            PRINT '**Notice: DELETES found, processing ALL HA records.';
            SET @PROC_LOCATION = 'CHANGES WITH DELETES';

            --** Changes were found but no deletes, so remove NON-changed data
            EXEC @RecordsPulled = proc_Load_HA_CT_TempTable 1 , @StartID , @EndID;

            PRINT '***INFO: Number of records to evaluate: ' + CAST ( @RecordsPulled AS nvarchar ( 20 ));
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , '007 - DATA Extract DELETES found';
        END;
    IF @iChgTypes = 1
        BEGIN
            PRINT '**Notice: Changes found, NO DELETES found, processing only new HA inserts and updates.';
            SET @PROC_LOCATION = 'CHANGES ONLY No DELETES';

            DECLARE
               @START_CLEANUP_TIME AS datetime = GETDATE ( );

            --** Changes were found but no deletes
            EXEC @RecordsPulled = proc_Load_HA_CT_TempTable 0 , @StartID , @EndID;

            PRINT '***INFO: Number of records that have changes: ' + CAST ( @RecordsPulled AS nvarchar ( 20 ));
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , '007 - DATA Extract changes Only';
        END;
    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , '007 - DATA PULL';

    SET @HRPART = DATEDIFF ( hour , @startPullDate , GETDATE ( ));
    SET @MINPART = DATEDIFF ( minute , @startPullDate , GETDATE ( ));
    SET @SECPART = DATEDIFF ( second , @startPullDate , GETDATE ( ));
    SET @TOTSECS = DATEDIFF ( second , @startPullDate , GETDATE ( ));
    SET @MINS = @TOTSECS / 60;

    PRINT 'TIME TO PULL DATA in minutes: ' + CAST ( @MINPART AS nvarchar( 10 )) + ' minutes.';
    PRINT 'TIME TO PULL DATA in hours: ' + CAST ( @HRPART AS nvarchar( 10 )) + ' hours.';

    EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CALLING_PROC;
    RETURN @RecordsPulled;
END;

GO

PRINT 'Created procedure PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA';

GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\proc_genTableVar.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'FROM: proc_genTableVar.sql';
PRINT 'Creating proc_getPKeyCols';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_getPKeyCols') 
    BEGIN
        DROP PROCEDURE
             proc_getPKeyCols;
    END;
GO
-- exec proc_getPKeyCols FACT_HFit_UserTracker, a
CREATE PROCEDURE proc_getPKeyCols (
     @tblname AS nvarchar (250) 
   , @pkcols nvarchar (max) OUTPUT) 
AS
BEGIN

/*****************************************************************************************************************
Author:	  W. Dale Miller
Date:	  09.22.2003
Copyright:  DMA, Ltd.
Purpose:	  Returns a list of columns used to define the PRIMARY key associated with this table if any are defined.
*****************************************************************************************************************/

    DECLARE
    @collist nvarchar ( max) 
  , @col AS nvarchar ( 250) 
  , @i AS int = 0;
    DECLARE PK_Cur CURSOR
        FOR
            SELECT
                   column_name
                   FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
                   WHERE
                   OBJECTPROPERTY ( OBJECT_ID ( constraint_name) , 'IsPrimaryKey') = 1
               AND table_name = @tblname
                   ORDER BY
                            column_name;
    OPEN PK_Cur;
    FETCH NEXT FROM PK_Cur INTO @col;
    SET @collist = '';
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @i = 0
                BEGIN
                    SET @collist = @collist + @col;
                END;
            ELSE
                BEGIN
                    SET @collist = @collist + ', ' + @col;
                END;
            FETCH NEXT FROM PK_Cur INTO  @col;
            SET @i = @i + 1;
        END;

    --PRINT @collist;

    CLOSE PK_Cur;
    DEALLOCATE PK_Cur;
    SET @pkcols = @collist;

	   select @pkcols;

END;
GO
PRINT 'Created proc_getPKeyCols';
GO
PRINT 'Creating proc_genTableVar';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_genTableVar') 
    BEGIN
        DROP PROCEDURE
             proc_genTableVar;
    END;
GO

-- exec proc_genTableVar 'View_HFit_HealthAssessment_Joined'
-- exec proc_genTableVar 'TEMP_HA_HashKeys_2'
-- exec proc_genTableVar 'View_HFit_HACampaign_Joined'
-- exec proc_genTableVar 'HFit_HealthAssesmentUserQuestion'
-- exec proc_genTableVar 'CMS_SITE'
-- exec proc_genTableVar 'CMS_USER'
-- exec proc_genTableVar 'CMS_Document'

/********************************************************
    SELECT * FROM information_schema.columns
    WHERE table_name = 'CMS_Document'
    ORDER BY ORDINAL_POSITION;    --DocumentGroupWebParts
********************************************************/

-- exec proc_genTableVar FACT_HFit_UserTracker
CREATE PROCEDURE proc_genTableVar (
     @TBLNAME AS nvarchar (250)) 
AS
BEGIN

/*********************************************************************************
Author:	  W. Dale Miller
Date:	  09.22.2003
Copyright:  DMA, Ltd.
Purpose:	  Generates the SQL to create a TABLE VAR from an existing table or view.
*********************************************************************************/

    DECLARE
    @TBL nvarchar ( 100) 
  , @COL nvarchar ( 100) 
  , @DType AS nvarchar ( 50) 
  , @LEN AS int
  , @PRECISION AS int
  , @SCALE AS int
  , @mysql AS nvarchar ( max) 
  , @i AS int = 0
  , @IS_NULLABLE AS nvarchar ( 10) ;
    DECLARE db_cursor CURSOR
        FOR
            SELECT
                   table_name
                 , COLUMN_NAME
                 , DATA_TYPE
                 , character_maximum_length
                 , numeric_precision
                 , numeric_scale
                 , IS_NULLABLE
                   FROM information_schema.columns
                   WHERE table_name = @TBLNAME
                   ORDER BY
                            ORDINAL_POSITION;
    OPEN db_cursor;
    FETCH NEXT FROM db_cursor INTO @TBL , @COL , @DType , @LEN , @PRECISION , @SCALE , @IS_NULLABLE;
    SET @mysql = 'DECLARE' + CHAR ( 10) ;
    SET @mysql = @mysql + '@' + @TBL + CHAR ( 10) ;
    SET @mysql = @mysql + 'TABLE' + CHAR ( 10) ;
    SET @mysql = @mysql + '(' + CHAR ( 10) ;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            SET @i = @i + 1;
            IF @i = 1
                BEGIN
                    SET @mysql = @mysql + @col + ' ' + @DType + ' ';
                END;
            ELSE
                BEGIN
                    SET @mysql = @mysql + CHAR ( 10) + ', ';
                    SET @mysql = @mysql + @col + ' ' + @DType + ' ';
                END;

            IF @DType = 'decimal'
                BEGIN
                    SET @mysql = @mysql + '(' + CAST ( @PRECISION AS nvarchar ( 100)) + ',' + CAST ( @SCALE AS nvarchar ( 100)) + ')';
                END;
            IF @DType = 'datetime2'
                BEGIN
                    SET @mysql = @mysql + '(7)';
                END;
            IF @LEN IS NOT NULL
                BEGIN
                    IF @LEN < 0
                        BEGIN
                            SET @mysql = @mysql + '(max)';
                        END;
                    ELSE
                        BEGIN
                            SET @mysql = @mysql + ' (' + CAST ( @LEN AS nvarchar ( 100)) + ')';
                        END;
                END;

            IF @IS_NULLABLE = 'NO'
                BEGIN
                    SET @mysql = @mysql + ' NOT NULL ';
                END;
            ELSE
                BEGIN
                    SET @mysql = @mysql + ' NULL ';
                END;

            FETCH NEXT FROM db_cursor INTO  @TBL , @COL , @DType , @LEN , @PRECISION , @SCALE , @IS_NULLABLE;
        END;
    DECLARE
    @KCols AS nvarchar ( max) ;
    EXEC proc_getPKeyCols @TBL , @KCols OUTPUT;

    --PRINT '@KCols: ' + @KCols;

    SET @KCols = LTRIM ( RTRIM ( @KCols)) ;
    DECLARE
    @collen AS int = ( SELECT
                              DATALENGTH ( @KCols));
    IF @collen > 0
        BEGIN
            SET @mysql = @mysql + CHAR ( 10) + ' PRIMARY KEY ( ' + CAST ( @KCols AS nvarchar ( max)) + ' )' + CHAR ( 10) ;
        END;
    ELSE
        BEGIN
            SET @mysql = @mysql + CHAR ( 10) + ' -- PRIMARY KEY (col1, col2)' + CHAR ( 10) ;
        END;
    SET @mysql = @mysql + ')' + CHAR ( 10) ;

    --PRINT  '**************************';
    
    CLOSE db_cursor;
    DEALLOCATE db_cursor;

    PRINT @mysql;
    select @mysql;

END;
GO
PRINT 'Created proc_genTableVar';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\proc_genTempTable.sql" \n 
--------------------------------------------------------------- 

PRINT 'Creating proc_genTempTable';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_genTempTable' )
    BEGIN
        DROP PROCEDURE
             proc_genTempTable;
    END;
GO

    -- exec proc_genTempTable 'view_EDW_HealthAssesment_CT'
    -- exec proc_genTempTable 'CT_Performance_History'
    -- exec proc_genTempTable 'STAGING_EDW_HealthInterestDetail'
    -- exec proc_genTempTable 'CMS_TREE'
    -- exec proc_genTempTable 'CMS_SITE'
    -- exec proc_genTempTable 'CMS_USER'
    -- exec proc_genTempTable 'CMS_Document'
    /*
    SELECT * FROM information_schema.columns
    WHERE table_name = 'CMS_Document'
    ORDER BY ORDINAL_POSITION;    --DocumentGroupWebParts
    */

CREATE PROCEDURE proc_genTempTable ( @TBLNAME AS nvarchar( 250 ))
AS
BEGIN
/*
Author:	  W. Dale Miller
Date:	  09.22.2003
Copyright:  DMA, Ltd.
Purpose:	  Generates a temp table from another table or view.
*/

    DECLARE
       @TBL nvarchar( 100 )
       ,@COL nvarchar( 100 )
       ,@DType AS nvarchar( 50 )
       ,@LEN AS int
       ,@PRECISION AS int
       ,@SCALE AS int
       ,@mysql AS nvarchar( max )
       ,@i AS int = 0
       ,@IS_NULLABLE AS nvarchar( 10 );

    DECLARE db_cursor CURSOR
        FOR
            --select table_name, COLUMN_NAME,DATA_TYPE,character_maximum_length , numeric_precision, numeric_scale, IS_NULLABLE
            SELECT
                   table_name ,
                   COLUMN_NAME ,
                   DATA_TYPE ,
                   character_maximum_length ,
                   numeric_precision ,
                   numeric_scale ,
                   IS_NULLABLE
              FROM information_schema.columns
              WHERE table_name = @TBLNAME
              ORDER BY
                       ORDINAL_POSITION;

    OPEN db_cursor;
    FETCH NEXT FROM db_cursor INTO @TBL , @COL , @DType , @LEN , @PRECISION , @SCALE , @IS_NULLABLE;

    SET @mysql = 'IF EXISTS ( SELECT name FROM tempdb.dbo.sysobjects WHERE id = OBJECT_ID (N''tempdb..#TEMP_'+@TBL+''' )) ' + char(10) ;
    SET @mysql =  @mysql + '    BEGIN '  + char(10) ;
    SET @mysql =  @mysql + '        DROP TABLE '  + char(10) ;
    SET @mysql =  @mysql + '            #TEMP_'+@TBL + char(10) ;
    SET @mysql =  @mysql + '    END; '  + char(10) ;
    print @mysql ; 
    print ' ' ; 


    SET @mysql = 'CREATE TABLE ' + CHAR( 10 );
    SET @mysql = @mysql + '#TEMP_' + @TBL + CHAR( 10 );
    SET @mysql = @mysql + '(' + CHAR( 10 );
    WHILE @@FETCH_STATUS = 0
        BEGIN
            SET @i = @i + 1;
            IF @i = 1
                BEGIN
                    SET @mysql = @mysql + @col + ' ' + @DType + ' ';
                END;
            ELSE
                BEGIN
                    SET @mysql = @mysql + CHAR( 10 ) + ', ';
                    SET @mysql = @mysql + @col + ' ' + @DType + ' ';
                END;

            --PRINT '@TBL: ' + CAST( @TBL AS nvarchar( 100 ));
            --PRINT  '@@COL: ' + CAST( @COL AS nvarchar( 100 ));
            --PRINT  '@@DType: ' + CAST( @DType AS nvarchar( 100 ));
            --PRINT  '@@LEN: ' + CAST( @LEN AS nvarchar( 100 ));
            --PRINT  '@@PRECISION: ' + CAST( @PRECISION AS nvarchar( 100 ));
            --PRINT  '@@SCALE: ' + CAST( @SCALE AS nvarchar( 100 ));
            --PRINT  '@@IS_NULLABLE: ' + CAST( @IS_NULLABLE AS nvarchar( 100 ));
            --PRINT ' - ';
            IF @DType = 'decimal'
                BEGIN
                    SET @mysql = @mysql + '(' + CAST( @PRECISION AS nvarchar( 100 )) + ',' + CAST( @SCALE AS nvarchar( 100 )) + ')';
                END;
            IF @DType = 'datetime2'
                BEGIN
                    SET @mysql = @mysql + '(7)';
                END;

            IF @LEN IS NOT NULL
                BEGIN
				if @LEN < 0 
				    SET @mysql = @mysql + '(max)';
				else 
				    SET @mysql = @mysql + ' (' + CAST( @LEN AS nvarchar( 100 )) + ')';
                END;

            IF @IS_NULLABLE = 'NO'
                BEGIN
                    SET @mysql = @mysql + ' NOT NULL ';
                END;
            ELSE
                BEGIN
                    SET @mysql = @mysql + ' NULL ';
                END;

            --PRINT '@@mysql: ' + CAST( @mysql AS nvarchar( max ));
            --PRINT  '**************************';

            FETCH NEXT FROM db_cursor INTO  @TBL , @COL , @DType , @LEN , @PRECISION , @SCALE , @IS_NULLABLE;
        END;

    DECLARE
       @KCols AS nvarchar( max );
    EXEC proc_getPKeyCols @TBL , @KCols OUTPUT;

    --PRINT '@KCols: ' + @KCols;

    set @KCols = ltrim(rtrim(@KCols)) ;

    declare @collen as int = (select datalength(@KCols)) ;

    IF @collen > 0 
        BEGIN
            SET @mysql = @mysql + CHAR( 10 ) + ' PRIMARY KEY ( ' + CAST( @KCols AS nvarchar( max )) + ' )' + CHAR( 10 );
        END;
    ELSE
        BEGIN
            SET @mysql = @mysql + CHAR( 10 ) + ' -- PRIMARY KEY (col1, col2)' + CHAR( 10 );
        END;

    SET @mysql = @mysql + ')' + CHAR( 10 );
    --PRINT  '**************************';
    PRINT @mysql;
    select @mysql;
    CLOSE db_cursor;
    DEALLOCATE db_cursor;

END;

go

PRINT 'Created proc_genTempTable';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_EDW_HA_TempTable_Load_All_Data.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'proc_EDW_HA_TempTable_Load_All_Data.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_HA_TempTable_Load_All_Data' )
    BEGIN
        DROP PROCEDURE
             proc_EDW_HA_TempTable_Load_All_Data
    END;
GO

CREATE PROCEDURE proc_EDW_HA_TempTable_Load_All_Data
AS
BEGIN

    truncate TABLE TEMP_EDW_HealthAssessment_DATA;

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_Dates' )
        BEGIN
            PRINT 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_Dates at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));

            CREATE NONCLUSTERED INDEX PI_TEMP_EDW_HealthAssessment_DATA_Dates ON dbo.TEMP_EDW_HealthAssessment_DATA ( ItemCreatedWhen ASC ,
            ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC ,
            HAUserQuestion_ItemModifiedWhen ASC ,
            HAUserAnswers_ItemModifiedWhen ASC ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
            DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
        END;

    IF NOT EXISTS
    ( SELECT
             name
        FROM sys.indexes
        WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_NATKEY' )
        BEGIN
            PRINT 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_NATKEY at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
            CREATE INDEX PI_TEMP_EDW_HealthAssessment_DATA_NATKEY ON dbo.TEMP_EDW_HealthAssessment_DATA (
            UserStartedItemID
            , UserGUID
            , PKHashCode
            );
        END;

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_IDs' )
        BEGIN
            EXEC PrintNow 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_IDs';
            CREATE INDEX PI_TEMP_EDW_HealthAssessment_DATA_IDs ON dbo.TEMP_EDW_HealthAssessment_DATA (
            UserStartedItemID
            , HealthAssesmentUserStartedNodeGUID
            , UserGUID
            , SiteGUID
            , AccountCD
            , HAModuleNodeGUID
            , CMSNodeGuid
            , HARiskCategoryNodeGUID
            , UserRiskAreaItemID
            , HARiskAreaNodeGUID
            , UserQuestionItemID
            , HAQuestionGuid
            , HAQuestionNodeGUID
            , UserAnswerItemID
            , HAAnswerNodeGUID
            , CampaignNodeGUID
            )
            INCLUDE ( AccountID , UserModuleItemId , UserRiskCategoryItemID , DeletedFlg , HASHCODE , LastModifiedDate )
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON ,
            ALLOW_PAGE_LOCKS = ON );
        END;

    INSERT INTO TEMP_EDW_HealthAssessment_DATA
    (
           UserStartedItemID
           ,HealthAssesmentUserStartedNodeGUID
           ,UserID
           ,UserGUID
           ,HFitUserMpiNumber
           ,SiteGUID
           ,AccountID
           ,AccountCD
           ,AccountName
           ,HAStartedDt
           ,HACompletedDt
           ,UserModuleItemId
           ,UserModuleCodeName
           ,HAModuleNodeGUID
           ,CMSNodeGuid
           ,HAModuleVersionID
           ,UserRiskCategoryItemID
           ,UserRiskCategoryCodeName
           ,HARiskCategoryNodeGUID
           ,HARiskCategoryVersionID
           ,UserRiskAreaItemID
           ,UserRiskAreaCodeName
           ,HARiskAreaNodeGUID
           ,HARiskAreaVersionID
           ,UserQuestionItemID
           ,Title
           ,HAQuestionGuid
           ,UserQuestionCodeName
           ,HAQuestionDocumentID
           ,HAQuestionVersionID
           ,HAQuestionNodeGUID
           ,UserAnswerItemID
           ,HAAnswerNodeGUID
           ,HAAnswerVersionID
           ,UserAnswerCodeName
           ,HAAnswerValue
           ,HAModuleScore
           ,HARiskCategoryScore
           ,HARiskAreaScore
           ,HAQuestionScore
           ,HAAnswerPoints
           ,PointResults
           ,UOMCode
           ,HAScore
           ,ModulePreWeightedScore
           ,RiskCategoryPreWeightedScore
           ,RiskAreaPreWeightedScore
           ,QuestionPreWeightedScore
           ,QuestionGroupCodeName
           ,ChangeType
           ,ItemCreatedWhen
           ,ItemModifiedWhen
           ,IsProfessionallyCollected
           ,HARiskCategory_ItemModifiedWhen
           ,HAUserRiskArea_ItemModifiedWhen
           ,HAUserQuestion_ItemModifiedWhen
           ,HAUserAnswers_ItemModifiedWhen
           ,HAPaperFlg
           ,HATelephonicFlg
           ,HAStartedMode
           ,HACompletedMode
           ,DocumentCulture_VHCJ
           ,DocumentCulture_HAQuestionsView
           ,CampaignNodeGUID
           ,HACampaignID
           ,HashCode
           ,PKHashCode
           ,CHANGED_FLG
           ,CT_CMS_User_UserID
           ,CT_CMS_User_CHANGE_OPERATION
           ,CT_UserSettingsID
           ,CT_UserSettingsID_CHANGE_OPERATION
           ,SiteID_CtID
           ,SiteID_CHANGE_OPERATION
           ,UserSiteID_CtID
           ,UserSiteID_CHANGE_OPERATION
           ,AccountID_CtID
           ,AccountID__CHANGE_OPERATION
           ,HAUserAnswers_CtID
           ,HAUserAnswers_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserModule_CtID
           ,HFit_HealthAssesmentUserModule_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserQuestion_CtID
           ,HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserQuestionGroupResults_CtID
           ,HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserRiskArea_CtID
           ,HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserRiskCategory_CtID
           ,HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserStarted_CtID
           ,HFit_HealthAssesmentUserStarted_CHANGE_OPERATION
           --, CT_CMS_User_SCV 
           --, CT_CMS_UserSettings_SCV 
           --, CT_CMS_Site_SCV 
           --, CT_CMS_UserSite_SCV 
           --, CT_HFit_Account_SCV 
           --, CT_HFit_HealthAssesmentUserAnswers_SCV 
           --, CT_HFit_HealthAssesmentUserModule_SCV 
           --, CT_HFit_HealthAssesmentUserQuestion_SCV 
           --, CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV 
           --, CT_HFit_HealthAssesmentUserRiskArea_SCV 
           --, CT_HFit_HealthAssesmentUserRiskCategory_SCV 
           --, CT_HFit_HealthAssesmentUserStarted_SCV 
           ,LastModifiedDate
           ,DeleteFlg )
    SELECT
           UserStartedItemID
           ,HealthAssesmentUserStartedNodeGUID
           ,UserID
           ,UserGUID
           ,HFitUserMpiNumber
           ,SiteGUID
           ,AccountID
           ,AccountCD
           ,AccountName
           ,HAStartedDt
           ,HACompletedDt
           ,UserModuleItemId
           ,UserModuleCodeName
           ,HAModuleNodeGUID
           ,CMSNodeGuid
           ,HAModuleVersionID
           ,UserRiskCategoryItemID
           ,UserRiskCategoryCodeName
           ,HARiskCategoryNodeGUID
           ,HARiskCategoryVersionID
           ,UserRiskAreaItemID
           ,UserRiskAreaCodeName
           ,HARiskAreaNodeGUID
           ,HARiskAreaVersionID
           ,UserQuestionItemID
           ,Title
           ,HAQuestionGuid
           ,UserQuestionCodeName
           ,HAQuestionDocumentID
           ,HAQuestionVersionID
           ,HAQuestionNodeGUID
           ,UserAnswerItemID
           ,HAAnswerNodeGUID
           ,HAAnswerVersionID
           ,UserAnswerCodeName
           ,HAAnswerValue
           ,HAModuleScore
           ,HARiskCategoryScore
           ,HARiskAreaScore
           ,HAQuestionScore
           ,HAAnswerPoints
           ,PointResults
           ,UOMCode
           ,HAScore
           ,ModulePreWeightedScore
           ,RiskCategoryPreWeightedScore
           ,RiskAreaPreWeightedScore
           ,QuestionPreWeightedScore
           ,QuestionGroupCodeName
           ,ChangeType
           ,ItemCreatedWhen
           ,ItemModifiedWhen
           ,IsProfessionallyCollected
           ,HARiskCategory_ItemModifiedWhen
           ,HAUserRiskArea_ItemModifiedWhen
           ,HAUserQuestion_ItemModifiedWhen
           ,HAUserAnswers_ItemModifiedWhen
           ,HAPaperFlg
           ,HATelephonicFlg
           ,HAStartedMode
           ,HACompletedMode
           ,DocumentCulture_VHCJ
           ,DocumentCulture_HAQuestionsView
           ,CampaignNodeGUID
           ,HACampaignID
           ,HashCode
           ,PKHashCode
           ,CHANGED_FLG
           ,CT_CMS_User_UserID
           ,CT_CMS_User_CHANGE_OPERATION
           ,CT_UserSettingsID
           ,CT_UserSettingsID_CHANGE_OPERATION
           ,SiteID_CtID
           ,SiteID_CHANGE_OPERATION
           ,UserSiteID_CtID
           ,UserSiteID_CHANGE_OPERATION
           ,AccountID_CtID
           ,AccountID__CHANGE_OPERATION
           ,HAUserAnswers_CtID
           ,HAUserAnswers_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserModule_CtID
           ,HFit_HealthAssesmentUserModule_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserQuestion_CtID
           ,HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserQuestionGroupResults_CtID
           ,HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserRiskArea_CtID
           ,HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserRiskCategory_CtID
           ,HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserStarted_CtID
           ,HFit_HealthAssesmentUserStarted_CHANGE_OPERATION
           --, CT_CMS_User_SCV 
           --, CT_CMS_UserSettings_SCV 
           --, CT_CMS_Site_SCV 
           --, CT_CMS_UserSite_SCV 
           --, CT_HFit_Account_SCV 
           --, CT_HFit_HealthAssesmentUserAnswers_SCV 
           --, CT_HFit_HealthAssesmentUserModule_SCV 
           --, CT_HFit_HealthAssesmentUserQuestion_SCV 
           --, CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV 
           --, CT_HFit_HealthAssesmentUserRiskArea_SCV 
           --, CT_HFit_HealthAssesmentUserRiskCategory_SCV 
           --, CT_HFit_HealthAssesmentUserStarted_SCV 
           ,NULL AS LastModifiedDate
           ,NULL AS DeleteFlg
      FROM view_EDW_HealthAssesment_CT;

END;

GO
PRINT 'CREATED proc_EDW_HA_TempTable_Load_All_Data.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_EDW_HA_TempTable_Load_Changed_Data.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'proc_EDW_HA_TempTable_Load_Changed_Data.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_HA_TempTable_Load_Changed_Data' )
    BEGIN
        DROP PROCEDURE
             proc_EDW_HA_TempTable_Load_Changed_Data
    END;
GO

CREATE PROCEDURE proc_EDW_HA_TempTable_Load_Changed_Data
AS
BEGIN

    truncate TABLE TEMP_EDW_HealthAssessment_DATA;

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_Dates' )
        BEGIN
            PRINT 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_Dates at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));

            CREATE NONCLUSTERED INDEX PI_TEMP_EDW_HealthAssessment_DATA_Dates ON dbo.TEMP_EDW_HealthAssessment_DATA ( ItemCreatedWhen ASC ,
            ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC ,
            HAUserQuestion_ItemModifiedWhen ASC ,
            HAUserAnswers_ItemModifiedWhen ASC ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
            DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
        END;

    IF NOT EXISTS
    ( SELECT
             name
        FROM sys.indexes
        WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_NATKEY' )
        BEGIN
            PRINT 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_NATKEY at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
            CREATE INDEX PI_TEMP_EDW_HealthAssessment_DATA_NATKEY ON dbo.TEMP_EDW_HealthAssessment_DATA (
            UserStartedItemID
            , UserGUID
            , PKHashCode
            );
        END;

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_IDs' )
        BEGIN
            EXEC PrintNow 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_IDs';
            CREATE INDEX PI_TEMP_EDW_HealthAssessment_DATA_IDs ON dbo.TEMP_EDW_HealthAssessment_DATA (
            UserStartedItemID
            , HealthAssesmentUserStartedNodeGUID
            , UserGUID
            , SiteGUID
            , AccountCD
            , HAModuleNodeGUID
            , CMSNodeGuid
            , HARiskCategoryNodeGUID
            , UserRiskAreaItemID
            , HARiskAreaNodeGUID
            , UserQuestionItemID
            , HAQuestionGuid
            , HAQuestionNodeGUID
            , UserAnswerItemID
            , HAAnswerNodeGUID
            , CampaignNodeGUID
            )
            INCLUDE ( AccountID , UserModuleItemId , UserRiskCategoryItemID , DeletedFlg , HASHCODE , LastModifiedDate )
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON ,
            ALLOW_PAGE_LOCKS = ON );
        END;

    INSERT INTO TEMP_EDW_HealthAssessment_DATA
    (
          [UserStartedItemID]
      ,[HealthAssesmentUserStartedNodeGUID]
      ,[UserID]
      ,[UserGUID]
      ,[HFitUserMpiNumber]
      ,[SiteGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[AccountName]
      ,[HAStartedDt]
      ,[HACompletedDt]
      ,[UserModuleItemId]
      ,[UserModuleCodeName]
      ,[HAModuleNodeGUID]
      ,[CMSNodeGuid]
      ,[HAModuleVersionID]
      ,[UserRiskCategoryItemID]
      ,[UserRiskCategoryCodeName]
      ,[HARiskCategoryNodeGUID]
      ,[HARiskCategoryVersionID]
      ,[UserRiskAreaItemID]
      ,[UserRiskAreaCodeName]
      ,[HARiskAreaNodeGUID]
      ,[HARiskAreaVersionID]
      ,[UserQuestionItemID]
      ,[Title]
      ,[HAQuestionGuid]
      ,[UserQuestionCodeName]
      ,[HAQuestionDocumentID]
      ,[HAQuestionVersionID]
      ,[HAQuestionNodeGUID]
      ,[UserAnswerItemID]
      ,[HAAnswerNodeGUID]
      ,[HAAnswerVersionID]
      ,[UserAnswerCodeName]
      ,[HAAnswerValue]
      ,[HAModuleScore]
      ,[HARiskCategoryScore]
      ,[HARiskAreaScore]
      ,[HAQuestionScore]
      ,[HAAnswerPoints]
      ,[PointResults]
      ,[UOMCode]
      ,[HAScore]
      ,[ModulePreWeightedScore]
      ,[RiskCategoryPreWeightedScore]
      ,[RiskAreaPreWeightedScore]
      ,[QuestionPreWeightedScore]
      ,[QuestionGroupCodeName]
      ,[ItemCreatedWhen]
      ,[ItemModifiedWhen]
      ,[IsProfessionallyCollected]
      ,[HARiskCategory_ItemModifiedWhen]
      ,[HAUserRiskArea_ItemModifiedWhen]
      ,[HAUserQuestion_ItemModifiedWhen]
      ,[HAUserAnswers_ItemModifiedWhen]
      ,[HAPaperFlg]
      ,[HATelephonicFlg]
      ,[HAStartedMode]
      ,[HACompletedMode]
      ,[DocumentCulture_VHCJ]
      ,[DocumentCulture_HAQuestionsView]
      ,[CampaignNodeGUID]
      ,[HACampaignID]
      ,[HashCode]
      ,[ChangeType]
      ,[CHANGED_FLG]
      ,[LastModifiedDate]
      ,[DeleteFlg]
      ,[CT_CMS_User_UserID]
      ,[CT_CMS_User_CHANGE_OPERATION]
      ,[CT_UserSettingsID]
      ,[CT_UserSettingsID_CHANGE_OPERATION]
      ,[SiteID_CtID]
      ,[SiteID_CHANGE_OPERATION]
      ,[UserSiteID_CtID]
      ,[UserSiteID_CHANGE_OPERATION]
      ,[AccountID_CtID]
      ,[AccountID__CHANGE_OPERATION]
      ,[HAUserAnswers_CtID]
      ,[HAUserAnswers_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserModule_CtID]
      ,[HFit_HealthAssesmentUserModule_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserQuestion_CtID]
      ,[HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserQuestionGroupResults_CtID]
      ,[HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserRiskArea_CtID]
      ,[HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserRiskCategory_CtID]
      ,[HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserStarted_CtID]
      ,[HFit_HealthAssesmentUserStarted_CHANGE_OPERATION]
      ,[CT_CMS_User_SCV]
      ,[CT_CMS_UserSettings_SCV]
      ,[CT_CMS_Site_SCV]
      ,[CT_CMS_UserSite_SCV]
      ,[CT_HFit_Account_SCV]
      ,[CT_HFit_HealthAssesmentUserAnswers_SCV]
      ,[CT_HFit_HealthAssesmentUserModule_SCV]
      ,[CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV]
      ,[CT_HFit_HealthAssesmentUserRiskArea_SCV]
      ,[CT_HFit_HealthAssesmentUserRiskCategory_SCV]
      ,[CT_HFit_HealthAssesmentUserStarted_SCV]
      ,[PKHashCode])
    SELECT
           [UserStartedItemID]
      ,[HealthAssesmentUserStartedNodeGUID]
      ,[UserID]
      ,[UserGUID]
      ,[HFitUserMpiNumber]
      ,[SiteGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[AccountName]
      ,[HAStartedDt]
      ,[HACompletedDt]
      ,[UserModuleItemId]
      ,[UserModuleCodeName]
      ,[HAModuleNodeGUID]
      ,[CMSNodeGuid]
      ,[HAModuleVersionID]
      ,[UserRiskCategoryItemID]
      ,[UserRiskCategoryCodeName]
      ,[HARiskCategoryNodeGUID]
      ,[HARiskCategoryVersionID]
      ,[UserRiskAreaItemID]
      ,[UserRiskAreaCodeName]
      ,[HARiskAreaNodeGUID]
      ,[HARiskAreaVersionID]
      ,[UserQuestionItemID]
      ,[Title]
      ,[HAQuestionGuid]
      ,[UserQuestionCodeName]
      ,[HAQuestionDocumentID]
      ,[HAQuestionVersionID]
      ,[HAQuestionNodeGUID]
      ,[UserAnswerItemID]
      ,[HAAnswerNodeGUID]
      ,[HAAnswerVersionID]
      ,[UserAnswerCodeName]
      ,[HAAnswerValue]
      ,[HAModuleScore]
      ,[HARiskCategoryScore]
      ,[HARiskAreaScore]
      ,[HAQuestionScore]
      ,[HAAnswerPoints]
      ,[PointResults]
      ,[UOMCode]
      ,[HAScore]
      ,[ModulePreWeightedScore]
      ,[RiskCategoryPreWeightedScore]
      ,[RiskAreaPreWeightedScore]
      ,[QuestionPreWeightedScore]
      ,[QuestionGroupCodeName]
      ,[ItemCreatedWhen]
      ,[ItemModifiedWhen]
      ,[IsProfessionallyCollected]
      ,[HARiskCategory_ItemModifiedWhen]
      ,[HAUserRiskArea_ItemModifiedWhen]
      ,[HAUserQuestion_ItemModifiedWhen]
      ,[HAUserAnswers_ItemModifiedWhen]
      ,[HAPaperFlg]
      ,[HATelephonicFlg]
      ,[HAStartedMode]
      ,[HACompletedMode]
      ,[DocumentCulture_VHCJ]
      ,[DocumentCulture_HAQuestionsView]
      ,[CampaignNodeGUID]
      ,[HACampaignID]
      ,[HashCode]
      ,[ChangeType]
      ,[CHANGED_FLG]
      ,[LastModifiedDate]
      ,[DeleteFlg]
      ,[CT_CMS_User_UserID]
      ,[CT_CMS_User_CHANGE_OPERATION]
      ,[CT_UserSettingsID]
      ,[CT_UserSettingsID_CHANGE_OPERATION]
      ,[SiteID_CtID]
      ,[SiteID_CHANGE_OPERATION]
      ,[UserSiteID_CtID]
      ,[UserSiteID_CHANGE_OPERATION]
      ,[AccountID_CtID]
      ,[AccountID__CHANGE_OPERATION]
      ,[HAUserAnswers_CtID]
      ,[HAUserAnswers_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserModule_CtID]
      ,[HFit_HealthAssesmentUserModule_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserQuestion_CtID]
      ,[HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserQuestionGroupResults_CtID]
      ,[HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserRiskArea_CtID]
      ,[HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserRiskCategory_CtID]
      ,[HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserStarted_CtID]
      ,[HFit_HealthAssesmentUserStarted_CHANGE_OPERATION]
      ,[CT_CMS_User_SCV]
      ,[CT_CMS_UserSettings_SCV]
      ,[CT_CMS_Site_SCV]
      ,[CT_CMS_UserSite_SCV]
      ,[CT_HFit_Account_SCV]
      ,[CT_HFit_HealthAssesmentUserAnswers_SCV]
      ,[CT_HFit_HealthAssesmentUserModule_SCV]
      ,[CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV]
      ,[CT_HFit_HealthAssesmentUserRiskArea_SCV]
      ,[CT_HFit_HealthAssesmentUserRiskCategory_SCV]
      ,[CT_HFit_HealthAssesmentUserStarted_SCV]
      ,[PKHashCode]
      FROM view_EDW_HealthAssesment_CT
	   where ChangeType is not NULL ;
END;

GO
PRINT 'CREATED proc_EDW_HA_TempTable_Load_Changed_Data.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_GetHaDeletedDataIDS.SQL" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating proc_CT_GetHaDeletedDataIDS';
PRINT 'FROM proc_CT_GetHaDeletedDataIDS.sql';

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_GetHaDeletedDataIDS' )
    BEGIN
        DROP PROCEDURE
             proc_CT_GetHaDeletedDataIDS;
    END;
GO
-- exec proc_CT_GetHaDeletedDataIDS
-- drop table #HA_DELETES
CREATE PROC proc_CT_GetHaDeletedDataIDS
AS
BEGIN

    CREATE TABLE #HA_DELETES (
                 TABLE_NAME varchar( 100 ) NULL ,
                 SYS_CHANGE_VERSION bigint NULL ,
                 SYS_CHANGE_CREATION_VERSION bigint NULL ,
                 SYS_CHANGE_OPERATION nchar( 1 ) NULL ,
                 SYS_CHANGE_COLUMNS varbinary( 4100 ) NULL ,
                 SYS_CHANGE_CONTEXT varbinary( 128 ) NULL ,
                 ClassID int NOT NULL );

    DECLARE
       @b AS bit = 0;

    INSERT INTO #HA_DELETES
    SELECT
           'CMS_Class' ,
           *
      FROM CHANGETABLE( CHANGES CMS_Class , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'CMS_Document' ,
           *
      FROM CHANGETABLE( CHANGES CMS_Document , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'CMS_Site' ,
           *
      FROM CHANGETABLE( CHANGES CMS_Site , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'CMS_Tree' ,
           *
      FROM CHANGETABLE( CHANGES CMS_Tree , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from view_EDW_HealthAssesment_CT
    --select top 100 * from CMS_User
    --delete from CMS_User where 
    SELECT
           'CMS_User' ,
           *
      FROM CHANGETABLE( CHANGES CMS_User , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'CMS_UserSettings' ,
           *
      FROM CHANGETABLE( CHANGES CMS_UserSettings , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'CMS_UserSite' ,
           *
      FROM CHANGETABLE( CHANGES CMS_UserSite , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'COM_SKU' ,
           *
      FROM CHANGETABLE( CHANGES COM_SKU , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
--update HFit_Account set  AccountName = 'TrustMark' where AccountName = 'TrustMarl'
    SELECT
           'HFit_Account' ,
           *
      FROM CHANGETABLE( CHANGES HFit_Account , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HACampaign
    --update HFit_HACampaign set SocialProofID = -1 where SocialProofID is null
    SELECT
           'HFit_HACampaign' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HACampaign , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssesmentMatrixQuestion' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentMatrixQuestion , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssesmentMultipleChoiceQuestion' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentMultipleChoiceQuestion , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HealthAssesmentUserAnswers
    --update HFit_HealthAssesmentUserAnswers set HAAnswerValue = null where UserID = 662 and HAAnswerValue is null
    SELECT
           'HFit_HealthAssesmentUserAnswers' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserAnswers , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HealthAssesmentUserModule
    --delete from HFit_HealthAssesmentUserModule where ItemID = 1529
    SELECT
           'HFit_HealthAssesmentUserModule' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserModule , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HealthAssesmentUserQuestion
    --delete from HFit_HealthAssesmentUserModule where ItemID = 15054
    SELECT
           'HFit_HealthAssesmentUserQuestion' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserQuestion , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssesmentUserQuestionGroupResults' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserQuestionGroupResults , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssesmentUserRiskArea' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserRiskArea , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssesmentUserRiskCategory' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserRiskCategory , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HealthAssesmentUserStarted
    --delete from HFit_HealthAssesmentUserStarted where itemid = 823
    SELECT
           'HFit_HealthAssesmentUserStarted' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserStarted , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HealthAssessment
    SELECT
           'HFit_HealthAssessment' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssessment , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssessmentFreeForm' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssessmentFreeForm , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_LKP_EDW_RejectMPI' ,
           *
      FROM CHANGETABLE( CHANGES HFit_LKP_EDW_RejectMPI , NULL )AS CT;       ----where SYS_CHANGE_OPERATION = 'D';

    DECLARE
                                                                               @NbrUpdates AS int = @@ROWCOUNT;
    DECLARE
       @iInsert AS int = 0;
    DECLARE
       @iUpdate AS int = 0;
    DECLARE
       @iDel AS int = 0;

    IF @NbrUpdates = 0
        BEGIN
            PRINT 'No changes found';
            SET @b = 0;
        END;
    ELSE
        BEGIN
            SET @iInsert = ( SELECT
                                    COUNT ( * )
                               FROM #HA_DELETES
                               WHERE SYS_CHANGE_OPERATION = 'I' );
            SET @iUpdate = ( SELECT
                                    COUNT ( * )
                               FROM #HA_DELETES
                               WHERE SYS_CHANGE_OPERATION = 'U' );
            SET @iDel = ( SELECT
                                 COUNT ( * )
                            FROM #HA_DELETES
                            WHERE SYS_CHANGE_OPERATION = 'D' );
            PRINT CAST ( @NbrUpdates AS nvarchar ( 50 )) + ' Changes found';
            PRINT CAST ( @iInsert AS nvarchar ( 50 )) + ' Inserts found';
            PRINT CAST ( @iUpdate AS nvarchar ( 50 )) + ' Updates found';
            PRINT CAST ( @iDel AS nvarchar ( 50 )) + ' Deletes found';
            SET @b = 1;
            IF @iDel > 0
                BEGIN
                    SET @b = 2;
                END;
        END;
    SELECT
           *
      FROM #HA_DELETES;
END;
GO
PRINT 'Created proc_CT_GetHaDeletedDataIDS';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_clean_EDW_Staging.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating procedure proc_clean_EDW_Staging';
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_clean_EDW_Staging') 
    BEGIN
        PRINT 'Recreating procedure proc_clean_EDW_Staging';
        DROP PROCEDURE
             proc_clean_EDW_Staging;
    END;
GO
--exec proc_clean_EDW_Staging
CREATE PROCEDURE proc_clean_EDW_Staging
AS
BEGIN
    WITH CTE (
         SVR
       , DBNAME
       , UserStartedItemID
       , UserGUID
       , PKHashCode
       , DeletedFlg
       , LastModifiedDate
       , DuplicateCount) 
        AS (
        SELECT
               SVR
             , DBNAME
             ,UserStartedItemID
             , UserGUID
             , PKHashCode
             ,DeletedFlg
             ,LastModifiedDate
             ,ROW_NUMBER () OVER ( PARTITION BY  SVR
                                               , DBNAME
                                               , UserStartedItemID
                                               ,UserGUID
                                               ,PKHashCode ORDER BY  SVR, DBNAME, UserStartedItemID, UserGUID, PKHashCode , DeletedFlg , LastModifiedDate) AS DuplicateCount
               FROM DIM_EDW_HealthAssessment
        ) 
        DELETE
        FROM CTE
        WHERE
              DuplicateCount > 1;
END;

GO
PRINT 'Recreated procedure proc_clean_EDW_Staging';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "C:\Users\wmiller\Documents\SQL Server Management Studio\proc_MonitorLogStats.sql" \n 
--------------------------------------------------------------- 


go
print 'Creating proc_MonitorLogStats.SQL' ;
go

/*
DBCC SQLPERF( logspace );
*/

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'spSQLPerf' )
    BEGIN
        DROP PROCEDURE
             spSQLPerf
    END;
GO

CREATE PROC dbo.spSQLPerf
AS
BEGIN
    DBCC SQLPERF( logspace );
END;
GO

/*
exec spGetSQLPerfStats ;
go
select * from logSpaceStats order by id desc
*/
IF NOT EXISTS ( SELECT
                       name
                  FROM sys.tables
                  WHERE name = 'logSpaceStats' )
    BEGIN
        CREATE TABLE dbo.logSpaceStats
        (
                     id int IDENTITY ( 1 , 1 ) ,
                     logDate datetime DEFAULT GETDATE( ) ,
                     databaseName sysname ,
                     logSize decimal( 18 , 5 ) ,
                     logUsed decimal( 18 , 5 )
        );
    END;
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'spGetSQLPerfStats' )
    BEGIN
        DROP PROCEDURE
             spGetSQLPerfStats
    END;
GO

CREATE PROC dbo.spGetSQLPerfStats
AS
BEGIN
    SET NOCOUNT ON;

    CREATE TABLE #tFileList
    (
                 databaseName sysname ,
                 logSize decimal( 18 , 5 ) ,
                 logUsed decimal( 18 , 5 ) ,
                 status int
    );

    INSERT INTO #tFileList
    EXEC spSQLPerf;

    INSERT INTO logSpaceStats (
           databaseName ,
           logSize ,
           logUsed )
    SELECT
           databasename ,
           logSize ,
           logUsed
      FROM #tFileList;

    DROP TABLE
         #tFileList;
END;
GO

EXEC spGetSQLPerfStats;

--SELECT * FROM dbo.logSpaceStats;

GO

PRINT 'Creating JOB job_MonitorLogStats' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;


DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_MonitorLogStats_' + @TGTDB;

IF EXISTS (SELECT job_id 
            FROM msdb.dbo.sysjobs_view 
            WHERE name = @JNAME)
begin
    EXEC msdb..sp_delete_job @job_name = @JNAME;
end;


/****** Object:  Job [job_MonitorLogStats]    Script Date: 6/14/2015 8:10:16 AM ******/
BEGIN TRANSACTION
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 6/14/2015 8:10:16 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name= @JNAME, 
		@enabled=1, 
		@notify_level_eventlog=2, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Track the daily SQL log growth', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'dmiller', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [acquireStats]    Script Date: 6/14/2015 8:10:17 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'acquireStats', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXEC spGetSQLPerfStats;', 
		@database_name= @TGTDB, 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'LogMonitorSchedule', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20150614, 
		@active_end_date=99991231, 
		@active_start_time=210000, 
		@active_end_time=235959, 
		@schedule_uid=N'7fc5fb9d-207b-4814-97c2-0a512a65c47e'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:


go
--select * from view_logSpaceStats
if exists (select name from sys.views where name = 'view_logSpaceStats')
    drop view view_logSpaceStats ;
go
create view view_logSpaceStats
as
SELECT [id]
      ,[logDate] as LogEntryDate
      ,[databaseName]
      ,[logSize] as LogSizeMB
      ,[logUsed] as LogPctUsed
  FROM [dbo].[logSpaceStats]
GO

print 'Created proc_MonitorLogStats.SQL' ;

go

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_Denormalize_EDW_Views.sql" \n 
--------------------------------------------------------------- 


go
print 'Creating proc_Denormalize_EDW_Views.sql';
go

if exists (select name from sys.procedures where name = 'proc_Denormalize_EDW_Views')
    drop procedure proc_Denormalize_EDW_Views;
--exec proc_Denormalize_EDW_Views
go
CREATE PROCEDURE proc_Denormalize_EDW_Views
AS
BEGIN
/*
Author:	  W. Dale Miller
Created:	  06.15.2015
USE:		  exec proc_Denormalize_EDW_Views
PERF:	  Appox 50 minutes
*/
SET NOCOUNT ON;
    IF EXISTS ( SELECT
                       name
                  FROM tempdb.dbo.sysobjects
                  WHERE id = OBJECT_ID ( N'tempdb..##TEMP_HFit_HealthAssesmentUserQuestion' ))

        BEGIN

            DROP TABLE
                 ##TEMP_HFit_HealthAssesmentUserQuestion;
        END;

    SELECT
           USERQUES.ItemID
           ,USERQUES.HAQuestionNodeGUID
           ,USERQUES.CodeName
           ,USERQUES.HAQuestionScore
           ,USERQUES.PreWeightedScore
           ,USERQUES.IsProfessionallyCollected
           ,USERQUES.ItemModifiedWhen
           ,USERQUES.HARiskAreaItemID
           ,CT_HFit_HealthAssesmentUserQuestion.ItemID AS HFit_HealthAssesmentUserQuestion_CtID
           ,CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION
           ,CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserQuestion_SCV
		  
    INTO
         ##TEMP_HFit_HealthAssesmentUserQuestion
      FROM
           BASE_HFIT_HEALTHASSESMENTUSERQUESTION AS USERQUES LEFT OUTER JOIN
                CHANGETABLE( CHANGES BASE_HFIT_HEALTHASSESMENTUSERQUESTION , NULL )AS CT_HFit_HealthAssesmentUserQuestion
                                                        ON USERQUES.ItemID = CT_HFit_HealthAssesmentUserQuestion.ItemID;
    
    -- select top 100 * from ##TEMP_HFit_HealthAssesmentUserQuestion

    CREATE UNIQUE CLUSTERED INDEX TEMP_USERQUES ON ##TEMP_HFit_HealthAssesmentUserQuestion
    (
    ItemID
    , HARiskAreaItemID
    , HAQuestionNodeGUID
    , CodeName
    , HAQuestionScore
    , PreWeightedScore
    , ItemModifiedWhen
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , IGNORE_DUP_KEY = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

    CREATE NONCLUSTERED INDEX PI_USERQUES_RiskAreaID
    ON ##TEMP_HFit_HealthAssesmentUserQuestion ( HARiskAreaItemID )
    INCLUDE ( ItemID , HAQuestionNodeGUID , CodeName , HAQuestionScore , PreWeightedScore , IsProfessionallyCollected , ItemModifiedWhen );

    IF EXISTS ( SELECT
                       name
                  FROM tempdb.dbo.sysobjects
                  WHERE id = OBJECT_ID ( N'tempdb..##TEMP_View_HFit_HACampaign_Joined' ))

        BEGIN

            --PRINT 'Dropping ##TEMP_View_HFit_HACampaign_Joined';

            DROP TABLE
                 ##TEMP_View_HFit_HACampaign_Joined;
        END;

    SELECT
           campaign.DocumentCulture
           ,campaign.HACampaignID
           ,campaign.NodeGUID
           ,campaign.NodeSiteID
           ,campaign.HealthAssessmentID
    INTO
         ##TEMP_View_HFit_HACampaign_Joined
      FROM View_HFit_HACampaign_Joined AS campaign;

    CREATE UNIQUE CLUSTERED INDEX TEMP_campaign ON ##TEMP_View_HFit_HACampaign_Joined
    (
    DocumentCulture ASC ,
    HACampaignID ASC ,
    NodeGUID ASC ,
    HealthAssessmentID
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , IGNORE_DUP_KEY = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

    IF EXISTS ( SELECT
                       name
                  FROM tempdb.dbo.sysobjects
                  WHERE id = OBJECT_ID ( N'tempdb..##TEMP_View_HFit_HealthAssessment_Joined' ))

        BEGIN

            --PRINT 'Dropping ##TEMP_View_HFit_HealthAssessment_Joined';

            DROP TABLE
                 ##TEMP_View_HFit_HealthAssessment_Joined;
        END;

    SELECT
           HAJOINED.NodeGUID
           ,HAJOINED.DocumentID
    INTO
         ##TEMP_View_HFit_HealthAssessment_Joined
      FROM View_HFit_HealthAssessment_Joined AS HAJOINED;

    SET ANSI_PADDING ON;

    CREATE UNIQUE CLUSTERED INDEX TEMP_HAJOINED ON ##TEMP_View_HFit_HealthAssessment_Joined
    (
    NodeGUID ASC ,
    DocumentID ASC
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , IGNORE_DUP_KEY = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

    IF EXISTS ( SELECT
                       name
                  FROM tempdb.dbo.sysobjects
                  WHERE id = OBJECT_ID ( N'tempdb..##TEMP_View_EDW_HealthAssesmentQuestions' ))

        BEGIN

            --PRINT 'Dropping ##TEMP_View_EDW_HealthAssesmentQuestions';

            DROP TABLE
                 ##TEMP_View_EDW_HealthAssesmentQuestions;
        END;

    SELECT
           dbo.udf_StripHTML ( QUES.Title ) AS Title
           ,QUES.DocumentCulture
           ,QUES.NodeGUID
    INTO
         ##TEMP_View_EDW_HealthAssesmentQuestions
      FROM View_EDW_HealthAssesmentQuestions AS QUES;

    SET ANSI_PADDING ON;

    CREATE UNIQUE CLUSTERED INDEX TEMP_Ques ON ##TEMP_View_EDW_HealthAssesmentQuestions
    (
    DocumentCulture ASC ,
    NodeGUID ASC
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , IGNORE_DUP_KEY = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

END;

go
print 'Created proc_Denormalize_EDW_Views.sql';
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_Stage_EDW_Views.sql" \n 
--------------------------------------------------------------- 
--HFit_HealthAssesmentUserRiskCategory
--CREATE INDEX [CI_HFit_HealthAssesmentUserRiskCategory] ON [dbo].[HFit_HealthAssesmentUserRiskCategory]
--(
--	ItemID include(ItemModifiedWhen, HARiskCategoryScore, PreWeightedScore,HARiskCategoryNodeGUID)
--)

GO

PRINT 'Creating proc_Stage_EDW_Views.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_Stage_EDW_Views' )
    BEGIN
        DROP PROCEDURE
             proc_Stage_EDW_Views
    END;
GO
CREATE PROCEDURE proc_Stage_EDW_Views
AS
BEGIN

    IF EXISTS ( SELECT
                       name
                  FROM sys.tables
                  WHERE name = 'STAGED_View_HFit_HealthAssessment_Joined' )
        BEGIN
            DROP TABLE
                 STAGED_View_HFit_HealthAssessment_Joined
        END;

    SELECT
           * INTO
                  STAGED_View_HFit_HealthAssessment_Joined
      FROM View_HFit_HealthAssessment_Joined;
    CREATE CLUSTERED INDEX PI_STAGED_View_HFit_HealthAssessment_Joined ON dbo.STAGED_View_HFit_HealthAssessment_Joined
    (
    DocumentID
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON ) ON [PRIMARY];

    IF EXISTS ( SELECT
                       name
                  FROM sys.tables
                  WHERE name = 'STAGED_View_HFit_HACampaign_Joined' )
        BEGIN
            DROP TABLE
                 STAGED_View_HFit_HACampaign_Joined
        END;

    SELECT
           * INTO
                  STAGED_View_HFit_HACampaign_Joined
      FROM View_HFit_HACampaign_Joined
      WHERE DocumentCulture = 'en-US';
    CREATE CLUSTERED INDEX PI_STAGED_View_HFit_HACampaign_Joined ON dbo.STAGED_View_HFit_HACampaign_Joined
    (
    NodeGUID , NodeSiteID , DocumentCulture
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON ) ON [PRIMARY];

    IF EXISTS ( SELECT
                       name
                  FROM sys.tables
                  WHERE name = 'STAGED_View_EDW_HealthAssesmentQuestions' )
        BEGIN
            DROP TABLE
                 STAGED_View_EDW_HealthAssesmentQuestions
        END;

    SELECT
           * INTO
                  STAGED_View_EDW_HealthAssesmentQuestions
      FROM View_EDW_HealthAssesmentQuestions
      WHERE documentculture = 'en-US';
    CREATE CLUSTERED INDEX PI_STAGED_View_EDW_HealthAssesmentQuestions ON dbo.STAGED_View_EDW_HealthAssesmentQuestions
    (
    NodeGUID , DocumentCulture
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON ) ON [PRIMARY];
END;

GO
PRINT 'Created proc_Stage_EDW_Views.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "CI_ItemID_HealthAssesmentUserAnswers.sql" \n 
--------------------------------------------------------------- 

GO
PRINT 'Creating CI_ItemID_HealthAssesmentUserAnswers.sql';
GO

IF NOT EXISTS ( SELECT
                       name
                  FROM sys.indexes
                  WHERE name = 'CI_ItemID_HealthAssesmentUserAnswers' )
    BEGIN
        CREATE NONCLUSTERED INDEX CI_ItemID_HealthAssesmentUserAnswers ON dbo.BASE_HFit_HealthAssesmentUserAnswers
        ( SVR, DBNAME, ItemID , HAQuestionItemID )
        INCLUDE(
        HAAnswerNodeGUID ,
        CodeName ,
        HAAnswerValue ,
        HAAnswerPoints ,
        UOMCode ,
        ItemCreatedWhen ,
        ItemModifiedWhen
        )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON ) ON [PRIMARY]
    END;

GO
PRINT 'Created CI_ItemID_HealthAssesmentUserAnswers.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CkSmallStepsHasChanged.sql" \n 
--------------------------------------------------------------- 


GO
PRINT 'EXecuting proc_CkSmallStepsHasChanged.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CkSmallStepsHasChanged' )
    BEGIN
        DROP PROCEDURE
             proc_CkSmallStepsHasChanged
    END;

GO
--exec [proc_CkSmallStepsHasChanged]
CREATE PROCEDURE proc_CkSmallStepsHasChanged
AS
BEGIN
/*
Author:	  W. Dale Miller
RETURNS:	  Integer -   0 = no changes
				    1 = updates or inserts, no deletes
				    2 = DELETES and possibly updates or inserts
*/
    DECLARE
       @b AS int = 0,
       @dels AS int = 0,
       @ins AS int = 0,
       @updt AS int = 0;

    DECLARE
       @TempSmallSteps AS TABLE
       (
                                SYS_CHANGE_OPERATION nvarchar( 10 )
       );

    INSERT INTO @TempSmallSteps
    (
           SYS_CHANGE_OPERATION
    )
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_Class , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_Document , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_Site , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_Tree , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_User , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_UserSettings , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_UserSite , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES COM_SKU , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_Account , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_HACampaign , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserStarted , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_OutComeMessages , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES Hfit_SmallStepResponses , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_ToDoSmallSteps , NULL )AS CT;

    SET @b = ( SELECT
                      COUNT( * )
                 FROM @TempSmallSteps );
    PRINT 'Number of changes found: ' + CAST( @b AS nvarchar( 50 ));


    IF @b > 0
        BEGIN

            SET @dels = ( SELECT
                                 COUNT( * )
                            FROM @TempSmallSteps
                            WHERE SYS_CHANGE_OPERATION = 'D' );
            SET @ins = ( SELECT
                                COUNT( * )
                           FROM @TempSmallSteps
                           WHERE SYS_CHANGE_OPERATION = 'I' );
            SET @updt = ( SELECT
                                 COUNT( * )
                            FROM @TempSmallSteps
                            WHERE SYS_CHANGE_OPERATION = 'U' );

            PRINT 'Number of inserts: ' + CAST( @ins AS nvarchar( 50 ));
            PRINT 'Number of updates: ' + CAST( @updt AS nvarchar( 50 ));
            PRINT 'Number of deletes: ' + CAST( @dels AS nvarchar( 50 ));

            IF @dels > 0
                BEGIN
                    SET @b = 2 ;
                END
            ELSE
                BEGIN
                    SET @b = 1;
                END;
        END;
    print 'Returned Value: ' + cast(@b as nvarchar(50)) ;
    RETURN @b;

END;

GO
PRINT 'EXecuted proc_CkSmallStepsHasChanged.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_SmallSteps_AddDeletedRecods.sql" \n 
--------------------------------------------------------------- 

go 
print 'Executing proc_CT_SmallSteps_AddDeletedRecords.SQL'
go
if exists (select name from sys.procedures where name = 'proc_CT_SmallSteps_AddDeletedRecords')
    drop procedure proc_CT_SmallSteps_AddDeletedRecords;
go

create procedure proc_CT_SmallSteps_AddDeletedRecords
AS
DECLARE
           @DELDATE AS datetime2 ( 7 ) = GETDATE ( );
        WITH CTE_DEL (
             AccountCD
             ,SiteGUID
             ,SSItemID
             ,SSItemGUID
             ,SSHealthAssesmentUserStartedItemID
             ,SSOutcomeMessageGuid
             ,HFitUserMPINumber
             ,HACampaignNodeGUID
             ,HAStartedMode
             ,HACompletedMode
             ,HaCodeName
             ,HACampaignStartDate
             ,HACampaignEndDate )
            AS ( SELECT
                        AccountCD
                        ,SiteGUID
                        ,SSItemID
                        ,SSItemGUID
                        ,SSHealthAssesmentUserStartedItemID
                        ,SSOutcomeMessageGuid
                        ,HFitUserMPINumber
                        ,HACampaignNodeGUID
                        ,HAStartedMode
                        ,HACompletedMode
                        ,HaCodeName
                        ,HACampaignStartDate
                        ,HACampaignEndDate
                   FROM DIM_EDW_SmallSteps
                 EXCEPT
                 SELECT
                        AccountCD
                        ,SiteGUID
                        ,SSItemID
                        ,SSItemGUID
                        ,SSHealthAssesmentUserStartedItemID
                        ,SSOutcomeMessageGuid
                        ,HFitUserMPINumber
                        ,HACampaignNodeGUID
                        ,HAStartedMode
                        ,HACompletedMode
                        ,HaCodeName
                        ,HACampaignStartDate
                        ,HACampaignEndDate
                   FROM Temp_SmallSteps )
            UPDATE S
              SET
                  DeletedFlg = 1
                  ,LastModifiedDate = @DELDATE
              FROM DIM_EDW_SmallSteps AS S JOIN
                        CTE_DEL AS C
                                               ON
                   S.AccountCD = C.AccountCD
               AND S.SiteGUID = C.SiteGUID
               AND S.SSItemID = C.SSItemID
               AND S.SSItemGUID = C.SSItemGUID
               AND S.SSHealthAssesmentUserStartedItemID = C.SSHealthAssesmentUserStartedItemID
               AND S.SSOutcomeMessageGuid = C.SSOutcomeMessageGuid
               AND S.HFitUserMPINumber = C.HFitUserMPINumber
               AND S.HACampaignNodeGUID = C.HACampaignNodeGUID
               AND s.HACampaignStartDate = c.HACampaignStartDate
               AND s.HACampaignEndDate = C.HACampaignEndDate
               AND S.HAStartedMode = C.HAStartedMode
               AND S.HACompletedMode = C.HACompletedMode
               AND S.HaCodeName = C.HaCodeName;
        DECLARE
           @iDeleted AS int = @@ROWCOUNT;
    return @iDeleted ;
go 
print 'Executed proc_CT_SmallSteps_AddDeletedRecords.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_SmallSteps_AddUpdatedRecods.sql" \n 
--------------------------------------------------------------- 


go 
print 'Executing proc_CT_SmallSteps_AddUpdatedRecs.SQL'
go
if exists (select name from sys.procedures where name = 'proc_CT_SmallSteps_AddUpdatedRecs')    
    drop procedure proc_CT_SmallSteps_AddUpdatedRecs;
go

create procedure proc_CT_SmallSteps_AddUpdatedRecs
AS
DECLARE
		  @RUNDATE AS datetime2 ( 7 ) = GETDATE ( );

        UPDATE S
          SET
              S.UserID = T.UserID
              ,S.AccountCD = T.AccountCD
              ,S.SiteGUID = T.SiteGUID
              ,S.SSItemID = T.SSItemID
              ,S.SSItemCreatedBy = T.SSItemCreatedBy
              ,S.SSItemCreatedWhen = T.SSItemCreatedWhen
              ,S.SSItemModifiedBy = T.SSItemModifiedBy
              ,S.SSItemModifiedWhen = T.SSItemModifiedWhen
              ,S.SSItemOrder = T.SSItemOrder
              ,S.SSItemGUID = T.SSItemGUID
              ,S.SSHealthAssesmentUserStartedItemID = T.SSHealthAssesmentUserStartedItemID
              ,S.SSOutcomeMessageGuid = T.SSOutcomeMessageGuid
              ,S.SSOutcomeMessage = T.SSOutcomeMessage
              ,S.HACampaignNodeGUID = T.HACampaignNodeGUID
              ,S.HACampaignName = T.HACampaignName
              ,S.HACampaignStartDate = T.HACampaignStartDate
              ,S.HACampaignEndDate = T.HACampaignEndDate
              ,S.HAStartedDate = T.HAStartedDate
              ,S.HACompletedDate = T.HACompletedDate
              ,S.HAStartedMode = T.HAStartedMode
              ,S.HACompletedMode = T.HACompletedMode
              ,S.HaCodeName = T.HaCodeName
              ,S.HFitUserMPINumber = T.HFitUserMPINumber
              ,S.HashCode = T.HashCode
              ,S.ChangeType = 'U'
              ,S.LastModifiedDate = GETDATE ( )
              ,S.DeletedFlg = NULL
              ,S.ConvertedToCentralTime = NULL
          FROM ##Temp_SmallSteps AS T JOIN
                    DIM_EDW_SmallSteps AS S
                                    ON
                   S.AccountCD = T.AccountCD
               AND S.SiteGUID = T.SiteGUID
               AND S.SSItemID = T.SSItemID
               AND S.SSItemGUID = T.SSItemGUID
               AND S.SSHealthAssesmentUserStartedItemID = T.SSHealthAssesmentUserStartedItemID
               AND S.SSOutcomeMessageGuid = T.SSOutcomeMessageGuid
               AND S.HFitUserMPINumber = T.HFitUserMPINumber
               AND S.HACampaignNodeGUID = T.HACampaignNodeGUID
               AND S.HAStartedMode = T.HAStartedMode
               AND S.HACompletedMode = T.HACompletedMode
               AND S.HaCodeName = T.HaCodeName
               AND S.HACampaignStartDate = t.HACampaignStartDate
               AND S.HACampaignEndDate = t.HACampaignEndDate
           AND S.HASHCODE != T.HASHCODE
           AND S.DeletedFlg IS NULL;
        DECLARE
           @iUpdated AS int = + @@ROWCOUNT;
    RETURN @iUpdated  ;
go 
print 'Executed proc_CT_SmallSteps_AddUpdatedRecs.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: "proc_CT_SmallSteps_AddNewRecods.sql" \n 
--------------------------------------------------------------- 

go 
print 'Executing proc_CT_SmallSteps_AddNewRecs.SQL'
go

if exists (select name from sys.procedures where name = 'proc_CT_SmallSteps_AddNewRecs')    
    drop procedure proc_CT_SmallSteps_AddNewRecs;
go
--exec proc_CT_SmallSteps_AddNewRecs
create procedure proc_CT_SmallSteps_AddNewRecs
as
WITH CTE_NEW (HFitUserMPINumber, HashCode )
            AS ( SELECT
                        HFitUserMPINumber, HashCode
                   FROM ##Temp_SmallSteps
                 EXCEPT
                 SELECT
                        HFitUserMPINumber, HashCode
                   FROM dbo.DIM_EDW_SmallSteps
                   WHERE DeletedFlg is null )
            INSERT INTO DIM_EDW_SmallSteps
            (
                   UserID
                   ,AccountCD
                   ,SiteGUID
                   ,SSItemID
                   ,SSItemCreatedBy
                   ,SSItemCreatedWhen
                   ,SSItemModifiedBy
                   ,SSItemModifiedWhen
                   ,SSItemOrder
                   ,SSItemGUID
                   ,SSHealthAssesmentUserStartedItemID
                   ,SSOutcomeMessageGuid
                   ,SSOutcomeMessage
                   ,HACampaignNodeGUID
                   ,HACampaignName
                   ,HACampaignStartDate
                   ,HACampaignEndDate
                   ,HAStartedDate
                   ,HACompletedDate
                   ,HAStartedMode
                   ,HACompletedMode
                   ,HaCodeName
                   ,HFitUserMPINumber
                   ,DeletedFlg
                   ,LastModifiedDate
                   ,HashCode
                   ,ChangeType
                   ,CT_UserSettingsID
                   ,CT_CMS_UserSettings_SCV
                   ,SiteID_CtID
                   ,SiteID_CHANGE_OPERATION
                   ,SITE_SCV
                   ,Campaign_CtID
                   ,Campaign_SCV
                   ,HealthAssesmentUserStarted_CtID
                   ,HealthAssesmentUserStarted_SCV
                   ,OutComeMessages_CtID
                   ,OutComeMessages_SCV
                   ,HFit_Account_CtID
                   ,HFit_Account_SCV
                   ,ToDoSmallSteps_CtID
                   ,ToDoSmallSteps_SCV
                   ,CT_UserSettings_CHANGE_OPERATION
                   ,Campaign_CHANGE_OPERATION
                   ,HealthAssesmentUserStarted_CHANGE_OPERATION
                   ,OutComeMessages_CHANGE_OPERATION
                   ,HFit_Account_CHANGE_OPERATION
                   ,ToDoSmallSteps_CHANGE_OPERATION
                   ,SmallStepResponses_CtID
                   ,SmallStepResponses_SCV
                   ,SmallStepResponses_CHANGE_OPERATION
                   --,RowNbr
                   ,TimeZone
                   ,ConvertedToCentralTime )
            SELECT
                   T.UserID
                   ,T.AccountCD
                   ,T.SiteGUID
                   ,T.SSItemID
                   ,T.SSItemCreatedBy
                   ,T.SSItemCreatedWhen
                   ,T.SSItemModifiedBy
                   ,T.SSItemModifiedWhen
                   ,T.SSItemOrder
                   ,T.SSItemGUID
                   ,T.SSHealthAssesmentUserStartedItemID
                   ,T.SSOutcomeMessageGuid
                   ,T.SSOutcomeMessage
                   ,T.HACampaignNodeGUID
                   ,T.HACampaignName
                   ,T.HACampaignStartDate
                   ,T.HACampaignEndDate
                   ,T.HAStartedDate
                   ,T.HACompletedDate
                   ,T.HAStartedMode
                   ,T.HACompletedMode
                   ,T.HaCodeName
                   ,T.HFitUserMPINumber
                   ,null AS DeletedFlg
                   ,null as LastModifiedDate
                   ,T.HashCode
                   ,T.ChangeType
                   ,T.CT_UserSettingsID
                   ,T.CT_CMS_UserSettings_SCV
                   ,T.SiteID_CtID
                   ,T.SiteID_CHANGE_OPERATION
                   ,T.SITE_SCV
                   ,T.Campaign_CtID
                   ,T.Campaign_SCV
                   ,T.HealthAssesmentUserStarted_CtID
                   ,T.HealthAssesmentUserStarted_SCV
                   ,T.OutComeMessages_CtID
                   ,T.OutComeMessages_SCV
                   ,T.HFit_Account_CtID
                   ,T.HFit_Account_SCV
                   ,T.ToDoSmallSteps_CtID
                   ,T.ToDoSmallSteps_SCV
                   ,T.CT_UserSettings_CHANGE_OPERATION
                   ,T.Campaign_CHANGE_OPERATION
                   ,T.HealthAssesmentUserStarted_CHANGE_OPERATION
                   ,T.OutComeMessages_CHANGE_OPERATION
                   ,T.HFit_Account_CHANGE_OPERATION
                   ,T.ToDoSmallSteps_CHANGE_OPERATION
                   ,T.SmallStepResponses_CtID
                   ,T.SmallStepResponses_SCV
                   ,T.SmallStepResponses_CHANGE_OPERATION
                   --,NULL AS RowNbr
                   ,NULL AS TimeZone
                   ,NULL AS ConvertedToCentralTime
              FROM
                   ##Temp_SmallSteps AS T JOIN
                        CTE_NEW AS C
                                        ON
				T.HFitUserMPINumber = C.HFitUserMPINumber
				AND T.HashCode = C.HashCode;

        DECLARE
           @iInserted AS int = @@ROWCOUNT;
	   PRINT 'Records Added: ' + CAST ( @iInserted AS nvarchar( 5 ));
	   return @iInserted ;
go 
print 'Executed proc_CT_SmallSteps_AddNewRecs.SQL'
go
