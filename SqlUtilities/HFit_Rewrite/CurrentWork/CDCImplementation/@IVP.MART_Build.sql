--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




-- FATAL ERROR : FILE MISSING view_MART_HealthAssesment.SQL \n 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_MART_HealthAssesment_CT.sql \n 
--------------------------------------------------------------- 
USE KenticoCMS_DataMart_2;
GO


/*---------------------------------------------------------------------------
-----------------------------------------------------------
---------------------------------------------------
drop table ##TEMP_HA_DATA 
go
select count(*) from view_MART_HealthAssesment_CT
where CHANGETYPE is NOT NULL

set ROWCOUNT 500 ;
select * from view_MART_HealthAssesment_CT
where CHANGETYPE is NOT NULL

select * into FACT_MART_EDW_HealthAssesment from view_MART_HealthAssesment_CT
where CHANGETYPE is NOT NULL
*/
GO
PRINT 'Executing view_MART_HealthAssesment_CT.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE
                  name = 'view_MART_HealthAssesment_CT') 
    BEGIN
        DROP VIEW
             view_MART_HealthAssesment_CT;
    END;
GO

CREATE VIEW view_MART_HealthAssesment_CT
AS

--select * from FACT_View_EDW_HealthAssesmentQuestions
--select * from FACT_EDW_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS

SELECT
       HAUSERSTARTED.ITEMID AS USERSTARTEDITEMID
     , VHAJ.NODEGUID AS HEALTHASSESMENTUSERSTARTEDNODEGUID
     , HAUSERSTARTED.USERID
     , CMSUSER.USERGUID
     , USERSETTINGS.HFITUSERMPINUMBER
     , CMSSITE.SITEGUID
     , ACCT.ACCOUNTID
     , ACCT.ACCOUNTCD
     , ACCT.ACCOUNTNAME
     , HAUSERSTARTED.HASTARTEDDT
     , HAUSERSTARTED.HACOMPLETEDDT
     , HAUSERMODULE.ITEMID AS USERMODULEITEMID
     , HAUSERMODULE.CODENAME AS USERMODULECODENAME
     , HAUSERMODULE.HAMODULENODEGUID
     , VHAJ.NODEGUID AS CMSNODEGUID
     , NULL AS HAMODULEVERSIONID
     , HARISKCATEGORY.ITEMID AS USERRISKCATEGORYITEMID
     , HARISKCATEGORY.CODENAME AS USERRISKCATEGORYCODENAME
     , HARISKCATEGORY.HARISKCATEGORYNODEGUID
     , NULL AS HARISKCATEGORYVERSIONID
     , HAUSERRISKAREA.ITEMID AS USERRISKAREAITEMID
     , HAUSERRISKAREA.CODENAME AS USERRISKAREACODENAME
     , HAUSERRISKAREA.HARISKAREANODEGUID
     , NULL AS HARISKAREAVERSIONID
     , HAUSERQUESTION.ITEMID AS USERQUESTIONITEMID
     , HAQUESTIONSVIEW.TITLE
     , HAUSERQUESTION.HAQUESTIONNODEGUID AS HAQUESTIONGUID
     , HAUSERQUESTION.CODENAME AS USERQUESTIONCODENAME
     , NULL AS HAQUESTIONDOCUMENTID
     , NULL AS HAQUESTIONVERSIONID
     , HAUSERQUESTION.HAQUESTIONNODEGUID
     , HAUSERANSWERS.ITEMID AS USERANSWERITEMID
     , HAUSERANSWERS.HAANSWERNODEGUID
     , NULL AS HAANSWERVERSIONID
     , HAUSERANSWERS.CODENAME AS USERANSWERCODENAME
     , HAUSERANSWERS.HAANSWERVALUE
     , HAUSERMODULE.HAMODULESCORE
     , HARISKCATEGORY.HARISKCATEGORYSCORE
     , HAUSERRISKAREA.HARISKAREASCORE
     , HAUSERQUESTION.HAQUESTIONSCORE
     , HAUSERANSWERS.HAANSWERPOINTS
     , HAUSERQUESTIONGROUPRESULTS.POINTRESULTS
     , HAUSERANSWERS.UOMCODE
     , HAUSERSTARTED.HASCORE
     , HAUSERMODULE.PREWEIGHTEDSCORE AS MODULEPREWEIGHTEDSCORE
     , HARISKCATEGORY.PREWEIGHTEDSCORE AS RISKCATEGORYPREWEIGHTEDSCORE
     , HAUSERRISKAREA.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
     , HAUSERQUESTION.PREWEIGHTEDSCORE AS QUESTIONPREWEIGHTEDSCORE
     , HAUSERQUESTIONGROUPRESULTS.CODENAME AS QUESTIONGROUPCODENAME
     , COALESCE ( CT_CMS_USER.SYS_CHANGE_OPERATION , CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION , CT_CMS_SITE.SYS_CHANGE_OPERATION , CT_CMS_USERSITE.SYS_CHANGE_OPERATION , CT_HFIT_ACCOUNT.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_OPERATION) AS CHANGETYPE
     , HAUSERANSWERS.ITEMCREATEDWHEN
     , HAUSERANSWERS.ITEMMODIFIEDWHEN
     , HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED
     , HARISKCATEGORY.ITEMMODIFIEDWHEN AS HARISKCATEGORY_ITEMMODIFIEDWHEN
     , HAUSERRISKAREA.ITEMMODIFIEDWHEN AS HAUSERRISKAREA_ITEMMODIFIEDWHEN
     , HAUSERQUESTION.ITEMMODIFIEDWHEN AS HAUSERQUESTION_ITEMMODIFIEDWHEN
     , HAUSERANSWERS.ITEMMODIFIEDWHEN AS HAUSERANSWERS_ITEMMODIFIEDWHEN
     , HAUSERSTARTED.HAPAPERFLG
     , HAUSERSTARTED.HATELEPHONICFLG
     , HAUSERSTARTED.HASTARTEDMODE
     , HAUSERSTARTED.HACOMPLETEDMODE
     , VHCJ.DOCUMENTCULTURE AS DOCUMENTCULTURE_VHCJ
     , HAQUESTIONSVIEW.DOCUMENTCULTURE AS DOCUMENTCULTURE_HAQUESTIONSVIEW
     , HAUSERSTARTED.HACAMPAIGNNODEGUID AS CAMPAIGNNODEGUID
     , VHCJ.HACAMPAIGNID
     , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUSERSTARTED.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.USERID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( USERSETTINGS.HFITUSERMPINUMBER AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTNAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASTARTEDDT AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACOMPLETEDDT AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( LEFT ( HAQUESTIONSVIEW.TITLE , 1000) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERVALUE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULESCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREASCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERPOINTS AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.POINTRESULTS AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.UOMCODE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMCREATEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HAPAPERFLG AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HATELEPHONICFLG AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASTARTEDMODE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACOMPLETEDMODE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACAMPAIGNNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( VHCJ.HACAMPAIGNID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-')) AS VARCHAR (100)) AS HASHCODE
     , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUSERSTARTED.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( USERGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( SITEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( ACCOUNTCD AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAMODULENODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORYNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS VARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKAREANODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAQUESTIONNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAANSWERNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACAMPAIGNNODEGUID AS VARCHAR (50)) , '-')) AS VARCHAR (100)) AS PKHASHCODE
       --, COALESCE ( CT_CMS_USER.USERID , CT_CMS_USERSETTINGS.USERSETTINGSID , CT_CMS_SITE.SITEID , CT_CMS_USERSITE.USERSITEID , CT_HFIT_ACCOUNT.ACCOUNTID , CT_HFIT_HealthAssesmentUserAnswers.ITEMID , CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID , CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID , CT_HFIT_HEALTHASSESMENTUSERSTARTED.ITEMID) AS CHANGED_FLG
     , NULL AS CHANGED_FLG

       --*************************************
       --join changes to the records 

     , CT_CMS_USER.USERID AS CT_CMS_USER_USERID
     , CT_CMS_USER.SYS_CHANGE_OPERATION AS CT_CMS_USER_CHANGE_OPERATION
     , CT_CMS_USERSETTINGS.USERSETTINGSID AS CT_USERSETTINGSID
     , CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION AS CT_USERSETTINGSID_CHANGE_OPERATION
     , CT_CMS_SITE.SITEID AS SITEID_CTID
     , CT_CMS_SITE.SYS_CHANGE_OPERATION AS SITEID_CHANGE_OPERATION
     , CT_CMS_USERSITE.USERSITEID AS USERSITEID_CTID
     , CT_CMS_USERSITE.SYS_CHANGE_OPERATION AS USERSITEID_CHANGE_OPERATION
     , CT_HFIT_ACCOUNT.ACCOUNTID AS ACCOUNTID_CTID
     , CT_HFIT_ACCOUNT.SYS_CHANGE_OPERATION AS ACCOUNTID__CHANGE_OPERATION
     , CT_HFIT_HealthAssesmentUserAnswers.ITEMID AS HAUSERANSWERS_CTID
     , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION AS HAUSERANSWERS_CHANGE_OPERATION
     , CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID AS HFIT_HEALTHASSESMENTUSERMODULE_CTID
     , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERMODULE_CHANGE_OPERATION
     , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID AS HFIT_HEALTHASSESMENTUSERQUESTION_CTID
     , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
     , CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID AS HFIT_HealthAssesmentUserQuestionGroupResults_CTID
     , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION AS HFIT_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
     , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID AS HFIT_HEALTHASSESMENTUSERRISKAREA_CTID
     , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERRISKAREA_CHANGE_OPERATION
     , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID AS HFIT_HEALTHASSESMENTUSERRISKCATEGORY_CTID
     , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERRISKCATEGORY_CHANGE_OPERATION
     , CT_HFIT_HEALTHASSESMENTUSERSTARTED.ITEMID AS HFIT_HEALTHASSESMENTUSERSTARTED_CTID
     , CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERSTARTED_CHANGE_OPERATION

       --Get the TYPE of change ID NUMBER
     , CT_CMS_USER.SYS_CHANGE_VERSION AS CT_CMS_USER_SCV
     , CT_CMS_USERSETTINGS.SYS_CHANGE_VERSION AS CT_CMS_USERSETTINGS_SCV
     , CT_CMS_SITE.SYS_CHANGE_VERSION AS CT_CMS_SITE_SCV
     , CT_CMS_USERSITE.SYS_CHANGE_VERSION AS CT_CMS_USERSITE_SCV
     , CT_HFIT_ACCOUNT.SYS_CHANGE_VERSION AS CT_HFIT_ACCOUNT_SCV
     , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION AS CT_HFIT_HealthAssesmentUserAnswers_SCV
     , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERMODULE_SCV
     , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
     , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION AS CT_HFIT_HealthAssesmentUserQuestionGroupResults_SCV
     , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERRISKAREA_SCV
     , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY_SCV
     , CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERSTARTED_SCV

     , HAUSERANSWERS.ITEMMODIFIEDWHEN AS LastModifiedDATE
     , 0 AS DELETEFLG
     , CASE
       WHEN HAUserStarted.HADocumentConfigID IS NULL
               THEN 'SHORT_VER'
       WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
               THEN 'LONG_VER'
           ELSE 'UNKNOWN'
       END AS HealthAssessmentType
     , 0 AS LASTUPDATEID
       --, GETDATE () AS LASTLOADEDDATE
     , HAUSERSTARTED.SVR
     , HAUSERSTARTED.DBNAME
     , 0 AS DeletedFlg
     , NULL AS LASTLOADEDDATE
--, change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'SiteID', 'columnid') , CTE.sys_change_columns) AS [SiteID_cg] 
--, change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'UserID', 'columnid') , CTE.sys_change_columns) AS [UserID_cg] 
--, change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'UserPreferredCurrencyID', 'columnid') , CTE.sys_change_columns) AS [UserPreferredCurrencyID_cg] 
       FROM dbo.BASE_HFIT_HEALTHASSESMENTUSERSTARTED AS HAUSERSTARTED
                INNER JOIN DBO.BASE_CMS_USER AS CMSUSER
                    ON HAUSERSTARTED.USERID = CMSUSER.USERID
                   AND HAUSERSTARTED.SVR = CMSUSER.SVR
                   AND HAUSERSTARTED.DBNAME = CMSUSER.DBNAME
                INNER JOIN DBO.BASE_CMS_USERSETTINGS AS USERSETTINGS
                    ON USERSETTINGS.USERSETTINGSUSERID = CMSUSER.USERID
                   AND USERSETTINGS.HFITUSERMPINUMBER >= 0
                   AND USERSETTINGS.HFITUSERMPINUMBER IS NOT NULL
                   AND USERSETTINGS.SVR = CMSUSER.SVR
                   AND USERSETTINGS.DBNAME = CMSUSER.DBNAME
                INNER JOIN DBO.BASE_CMS_USERSITE AS USERSITE
                    ON CMSUSER.USERID = USERSITE.USERID
                   AND CMSUSER.SVR = USERSITE.SVR
                   AND CMSUSER.DBNAME = USERSITE.DBNAME
                INNER JOIN DBO.BASE_CMS_SITE AS CMSSITE
                    ON USERSITE.SITEID = CMSSITE.SITEID
                   AND USERSITE.SVR = CMSSITE.SVR
                   AND USERSITE.DBNAME = CMSSITE.DBNAME
                INNER JOIN DBO.BASE_HFIT_ACCOUNT AS ACCT
                    ON ACCT.SITEID = CMSSITE.SITEID
                   AND ACCT.SVR = CMSSITE.SVR
                   AND ACCT.DBNAME = CMSSITE.DBNAME
                INNER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE
                    ON HAUSERSTARTED.ITEMID = HAUSERMODULE.HASTARTEDITEMID
                   AND HAUSERSTARTED.SVR = HAUSERMODULE.SVR
                   AND HAUSERSTARTED.DBNAME = HAUSERMODULE.DBNAME
                INNER JOIN DBO.FACT_EDW_VIEW_HFIT_HACAMPAIGN_JOINED AS VHCJ
                    ON VHCJ.NODEGUID = HAUSERSTARTED.HACAMPAIGNNODEGUID
                   AND VHCJ.NODESITEID = USERSITE.SITEID
                   AND VHCJ.DOCUMENTCULTURE = 'en-US'
                   AND VHCJ.SVR = USERSITE.SVR
                   AND VHCJ.DBNAME = USERSITE.DBNAME
                INNER JOIN DBO.FACT_EDW_VIEW_HFIT_HEALTHASSESSMENT_JOINED AS VHAJ
                    ON VHAJ.DOCUMENTID = VHCJ.HEALTHASSESSMENTID
                   AND VHAJ.SVR = VHCJ.SVR
                   AND VHAJ.DBNAME = VHCJ.DBNAME
                INNER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY
                    ON HAUSERMODULE.ITEMID = HARISKCATEGORY.HAMODULEITEMID
                   AND HAUSERMODULE.SVR = HARISKCATEGORY.SVR
                   AND HAUSERMODULE.DBNAME = HARISKCATEGORY.DBNAME
                INNER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERRISKAREA AS HAUSERRISKAREA
                    ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
                   AND HARISKCATEGORY.SVR = HAUSERRISKAREA.SVR
                   AND HARISKCATEGORY.DBNAME = HAUSERRISKAREA.DBNAME
                INNER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERQUESTION AS HAUSERQUESTION
                    ON HAUSERRISKAREA.ITEMID = HAUSERQUESTION.HARISKAREAITEMID
                   AND HAUSERRISKAREA.SVR = HAUSERQUESTION.SVR
                   AND HAUSERRISKAREA.DBNAME = HAUSERQUESTION.DBNAME
                INNER JOIN DBO.FACT_View_EDW_HealthAssesmentQuestions AS HAQUESTIONSVIEW
                    ON HAUSERQUESTION.HAQUESTIONNODEGUID = HAQUESTIONSVIEW.NODEGUID
                   AND HAUSERQUESTION.SVR = HAQUESTIONSVIEW.SVR
                   AND HAUSERQUESTION.DBNAME = HAQUESTIONSVIEW.DBNAME
                LEFT OUTER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS AS HAUSERQUESTIONGROUPRESULTS
                    ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
                   AND HAUSERRISKAREA.SVR = HAUSERQUESTIONGROUPRESULTS.SVR
                   AND HAUSERRISKAREA.DBNAME = HAUSERQUESTIONGROUPRESULTS.DBNAME
                INNER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERANSWERS AS HAUSERANSWERS
                    ON HAUSERQUESTION.ITEMID = HAUSERANSWERS.HAQUESTIONITEMID
                   AND HAUSERQUESTION.SVR = HAUSERANSWERS.SVR
                   AND HAUSERQUESTION.DBNAME = HAUSERANSWERS.DBNAME
                LEFT JOIN CHANGETABLE (CHANGES BASE_CMS_USERSETTINGS, NULL) AS CT_CMS_USERSETTINGS
                    ON USERSETTINGS.USERSETTINGSID = CT_CMS_USERSETTINGS.USERSETTINGSID
                   AND USERSETTINGS.SVR = CT_CMS_USERSETTINGS.SVR
                   AND USERSETTINGS.DBNAME = CT_CMS_USERSETTINGS.DBNAME
                LEFT JOIN CHANGETABLE (CHANGES DBO.BASE_CMS_USER, NULL) AS CT_CMS_USER
                    ON CMSUSER.USERID = CT_CMS_USER.USERID
                   AND CMSUSER.SVR = CT_CMS_USER.SVR
                   AND CMSUSER.DBNAME = CT_CMS_USER.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_CMS_SITE, NULL) AS CT_CMS_SITE
                    ON CMSSITE.SITEID = CT_CMS_SITE.SITEID
                   AND CMSSITE.SVR = CT_CMS_SITE.SVR
                   AND CMSSITE.DBNAME = CT_CMS_SITE.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_CMS_USERSITE, NULL) AS CT_CMS_USERSITE
                    ON USERSITE.USERSITEID = CT_CMS_USERSITE.USERSITEID
                   AND USERSITE.SVR = CT_CMS_USERSITE.SVR
                   AND USERSITE.DBNAME = CT_CMS_USERSITE.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_ACCOUNT, NULL) AS CT_HFIT_ACCOUNT
                    ON ACCT.ACCOUNTID = CT_HFIT_ACCOUNT.ACCOUNTID
                   AND ACCT.SVR = CT_HFIT_ACCOUNT.SVR
                   AND ACCT.DBNAME = CT_HFIT_ACCOUNT.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HACAMPAIGN, NULL) AS CT_HFIT_HACAMPAIGN
                    ON VHCJ.HACAMPAIGNID = CT_HFIT_HACAMPAIGN.HACAMPAIGNID
                   AND VHCJ.SVR = CT_HFIT_HACAMPAIGN.SVR
                   AND VHCJ.DBNAME = CT_HFIT_HACAMPAIGN.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERANSWERS, NULL) AS CT_HFIT_HEALTHASSESMENTUSERANSWERS
                    ON HAUSERANSWERS.ITEMID = CT_HFIT_HEALTHASSESMENTUSERANSWERS.ITEMID
                   AND HAUSERANSWERS.SVR = CT_HFIT_HEALTHASSESMENTUSERANSWERS.SVR
                   AND HAUSERANSWERS.DBNAME = CT_HFIT_HEALTHASSESMENTUSERANSWERS.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERMODULE, NULL) AS CT_HFIT_HEALTHASSESMENTUSERMODULE
                    ON HAUSERMODULE.ITEMID = CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID
                   AND HAUSERMODULE.SVR = CT_HFIT_HEALTHASSESMENTUSERMODULE.SVR
                   AND HAUSERMODULE.DBNAME = CT_HFIT_HEALTHASSESMENTUSERMODULE.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERQUESTION, NULL) AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
                    ON HAUSERQUESTION.ITEMID = CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID
                   AND HAUSERQUESTION.SVR = CT_HFIT_HEALTHASSESMENTUSERQUESTION.SVR
                   AND HAUSERQUESTION.DBNAME = CT_HFIT_HEALTHASSESMENTUSERQUESTION.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS, NULL) AS CT_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS
                    ON HAUSERQUESTIONGROUPRESULTS.ITEMID = CT_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS.ITEMID
                   AND HAUSERQUESTIONGROUPRESULTS.SVR = CT_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS.SVR
                   AND HAUSERQUESTIONGROUPRESULTS.DBNAME = CT_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERRISKAREA, NULL) AS CT_HFIT_HEALTHASSESMENTUSERRISKAREA
                    ON HAUSERRISKAREA.ITEMID = CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID
                   AND HAUSERRISKAREA.SVR = CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SVR
                   AND HAUSERRISKAREA.DBNAME = CT_HFIT_HEALTHASSESMENTUSERRISKAREA.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY, NULL) AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
                    ON HARISKCATEGORY.ITEMID = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID
                   AND HARISKCATEGORY.SVR = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SVR
                   AND HARISKCATEGORY.DBNAME = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERSTARTED, NULL) AS CT_HFIT_HEALTHASSESMENTUSERSTARTED
                    ON HAUSERSTARTED.ITEMID = CT_HFIT_HEALTHASSESMENTUSERSTARTED.ITEMID
                   AND HAUSERSTARTED.SVR = CT_HFIT_HEALTHASSESMENTUSERSTARTED.SVR
                   AND HAUSERSTARTED.DBNAME = CT_HFIT_HEALTHASSESMENTUSERSTARTED.DBNAME
       WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
    SELECT
           BASE_HFIT_LKP_EDW_REJECTMPI.REJECTMPICODE
           FROM DBO.BASE_HFIT_LKP_EDW_REJECTMPI);

GO
PRINT 'GEN CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS00';
GO

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS00') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS00
        ON dbo.BASE_HFIT_HEALTHASSESMENTUSERANSWERS (SVR , DBNAME , HAQuestionItemID) 
        INCLUDE (HAAnswerPoints , ItemCreatedWhen , ItemModifiedWhen , HAAnswerValue , UOMCode , CodeName , HAAnswerNodeGUID , ItemID) ;
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS01') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS01
        ON dbo.BASE_HFit_HealthAssesmentUserRiskCategory (HAModuleItemID , SVR , DBNAME) 
        INCLUDE (ItemModifiedWhen , HARiskCategoryScore , CodeName , PreWeightedScore , HARiskCategoryNodeGUID , ItemID) ;
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS02') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS02
        ON dbo.BASE_HFit_HealthAssesmentUserRiskArea (HARiskCategoryItemID , ItemID , SVR , DBNAME) 
        INCLUDE (HARiskAreaScore , ItemModifiedWhen , CodeName , PreWeightedScore , HARiskAreaNodeGUID) ;
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS03') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS03
        ON dbo.BASE_HFit_HealthAssesmentUserModule (HAStartedItemID , SVR , DBNAME) 
        INCLUDE (HAModuleScore , CodeName , PreWeightedScore , HAModuleNodeGUID , ItemID) ;
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE
                      name = 'PI_BASE_HFit_HealthAssesmentUserStarted00') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_BASE_HFit_HealthAssesmentUserStarted00
        ON dbo.BASE_HFit_HealthAssesmentUserStarted (HACampaignNodeGUID , SVR , DBNAME) 
        INCLUDE (UserID , ItemID) ;
    END;
GO
PRINT 'Executed view_MART_HealthAssesment_CT.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_CoachEnrolledPPTCondition.sql \n 
--------------------------------------------------------------- 


---- use KenticoCMS_Datamart_2;
-- select top 100 * from view_CoachEnrolledPPTCondition
GO
PRINT 'Executing view_CoachEnrolledPPTCondition.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_CoachEnrolledPPTCondition') 
    BEGIN
        DROP VIEW
             view_CoachEnrolledPPTCondition;
    END;
GO
-- exec proc_UpdateSurrogateKeyDataBetweenParentAndChild "BASE_CMS_User", "SurrogateKey_CMS_User","BASE_HFit_LKP_CoachingCMConditions","UserID", "UserID",1

-- select top 100 * from view_CoachEnrolledPPTCondition
--Conditions assigned to user
--IsPrimary = Primary CM Condition (assigned by triage process)
--IsEnrolled = Coach must enroll PPT in Condition
CREATE VIEW view_CoachEnrolledPPTCondition
AS SELECT  
          usr.ItemModifiedWhen AS CoachEnrolledPPTConditionDate
        , USR.ItemID
        , USR.UserId
        , USR.ConditionItemID
        , USR.IsPrimary
        , USR.IsEnrolled
        , USR.ItemCreatedBy
        , USR.ItemCreatedWhen
        , USR.ItemModifiedBy
        , USR.ItemModifiedWhen
        , USR.ItemOrder
        , USR.ItemGUID
        , USR.HashCode
        , USR.SVR
        , USR.DBNAME
        , USR.LastModifiedDate
        , USR.[Action]
        , USR.SYS_CHANGE_VERSION
        , cond.[description] as CoachingCondition
	   , USR.SurrogateKey_Hfit_CoachingUserCMCondition        
        , CMSUSER.SurrogateKey_CMS_User
        , PPTEligibility.SurrogateKey_hfit_PPTEligibility
   FROM dbo.BASE_Hfit_CoachingUserCMCondition AS USR
        INNER JOIN BASE_HFit_LKP_CoachingCMConditions AS cond
        ON
          usr.ConditionItemID = cond.ItemID AND
          usr.SVR = cond.SVR AND
          usr.DBNAME = cond.DBNAME
        INNER JOIN BASE_CMS_User AS CMSUSER
        ON
          CMSUSER.SVR = CMSUSER.SVR AND
          CMSUSER.DBNAME = CMSUSER.DBNAME AND
          CMSUSER.UserId = CMSUSER.UserId
        inner JOIN BASE_hfit_PPTEligibility AS PPTEligibility
        ON
          PPTEligibility.SurrogateKey_CMS_User = CMSUSER.SurrogateKey_CMS_User;

GO
PRINT 'Executed CoachEnrolledPPTConditionDate.sql';
GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_ConditionManagement.sql \n 
--------------------------------------------------------------- 

-- use KenticoCMS_Datamart_2
-- select top 100 * from view_ConditionManagement
GO
PRINT 'Executing view_ConditionManagement.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_ConditionManagement') 
    BEGIN
        DROP VIEW
             view_ConditionManagement
    END;
GO

CREATE VIEW view_ConditionManagement
AS SELECT
          cusl.ItemCreatedWhen AS ConditionManagementStartDate
        , cusl.ItemID
        , cusl.UserId
        , cusl.ServiceLevelItemID
        , cusl.ServiceLevelStatusItemID
        , cusl.ItemCreatedBy
        , cusl.ItemCreatedWhen
        , cusl.ItemModifiedBy
        , cusl.ItemModifiedWhen
        , cusl.ItemOrder
        , cusl.ItemGUID
        , csls.[Description] AS CoachingServiceLevel
        , cusl.HashCode        
        , cusl.LastModifiedDate
        , cusl.[ACTION]
        , cusl.SYS_CHANGE_VERSION
        , cusl.SVR
        , cusl.DBNAME
	   , cusl.SurrogateKey_HFit_CoachingUserServiceLevel
	   , csls.SurrogateKey_HFit_LKP_CoachingServiceLevelStatus
        , CMSUSER.SurrogateKey_CMS_User
   FROM BASE_HFit_CoachingUserServiceLevel AS cusl ---This is coaching service level for the user
        INNER JOIN BASE_HFit_LKP_CoachingServiceLevel AS csl
        ON
          cusl.ServiceLevelItemID = csl.ItemID AND
          cusl.SVR = csl.SVR AND
          cusl.DBNAME = csl.DBNAME
        INNER JOIN BASE_CMS_user AS CMSUSER
        ON
          CMSUSER.SVR = cusl.SVR AND
          CMSUSER.DBNAME = cusl.DBNAME AND
          CMSUSER.UserID = cusl.UserID
        INNER JOIN BASE_HFit_LKP_CoachingServiceLevelStatus AS csls
        ON
          cusl.ServiceLevelStatusItemID = csls.ItemID AND
          cusl.SVR = csls.SVR AND
          cusl.DBNAME = csls.DBNAME
   WHERE
          csl.IsConditionManagement = 1 AND
          csls.[Description] = 'Enrolled';
GO
PRINT 'Executed view_ConditionManagement.sql';
GO

-- Service Levels
-- LM  = Lifestyle Management
-- AP  = Advanced Practice (Condition Management)
-- RN  = Registered Nurse (Condition Management)
-- select * from [BASE_HFit_LKP_CoachingServiceLevel]--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: VIEW_DIM_HA.sql \n 
--------------------------------------------------------------- 
-- use KenticoCMS_DataMart_2

GO
PRINT 'Executing VIEW_DIM_HA.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'VIEW_DIM_HA') 
    BEGIN
        DROP VIEW
             dbo.VIEW_DIM_HA;
    END;
GO

/*------------------------------------
select top 100 * from VIEW_DIM_HA
select count(*) from VIEW_DIM_HA
select * into #DIM_HA from VIEW_DIM_HA
*/
CREATE VIEW VIEW_DIM_HA
AS SELECT DISTINCT
          BASE_cms_user.SVR AS BASE_cms_user_SVR
        , BASE_HFit_HealthAssesmentUserQuestion.ItemID
        , BASE_HFit_HealthAssesmentUserQuestion.HAQuestionNodeGUID
        , BASE_cms_user.UserName
        , BASE_cms_user.FirstName
        , BASE_cms_user.MiddleName
        , BASE_cms_user.LastName
        , BASE_cms_user.FullName
        , BASE_cms_user.PreferredCultureCode
        , BASE_cms_user.PreferredUICultureCode
        , BASE_cms_user.UserID
        , BASE_cms_user.SurrogateKey_cms_user
        , BASE_cms_user.LASTMODIFIEDDATE AS BASE_cms_user_LASTMODIFIEDDATE
        , BASE_cms_user.DBNAME AS BASE_cms_user_DBNAME
        , BASE_cms_usersettings.UserDateOfBirth
        , BASE_cms_usersettings.UserGender
        , BASE_HFit_HealthAssesmentUserStarted.HAPaperFlg
        , BASE_HFit_HealthAssesmentUserStarted.HAStartedDt
        , BASE_HFit_HealthAssesmentUserStarted.HACompletedDt
        , BASE_HFit_HealthAssesmentUserStarted.LASTMODIFIEDDATE
        , BASE_CMS_Site.SiteName
        , BASE_CMS_Site.SiteStatus
        , BASE_CMS_Site.LASTMODIFIEDDATE AS BASE_CMS_Site_LASTMODIFIEDDATE
        , BASE_CMS_Site.SurrogateKey_CMS_Site
        , BASE_HFit_Account.SurrogateKey_HFit_Account
        , BASE_cms_usersite.SurrogateKey_cms_usersite
        , BASE_HFit_HealthAssesmentUserRiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
        , BASE_HFit_HealthAssesmentUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea
        , BASE_HFit_HealthAssesmentUserModule.SurrogateKey_HFit_HealthAssesmentUserModule
        , BASE_HFit_HealthAssesmentUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted
        , BASE_HFit_HealthAssesmentUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion
        , BASE_HFit_HealthAssesmentUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers
        , FACT_View_EDW_HealthAssesmentQuestions.TITLE
        , FACT_View_EDW_HealthAssesmentQuestions.RowNbr
        , FACT_View_EDW_HealthAssesmentQuestions.LastModifiedDate AS FACT_View_EDW_HealthAssesmentQuestions_LastModifiedDate
        , BASE_HFit_HealthAssesmentUserQuestion.LASTMODIFIEDDATE AS BASE_HFit_HealthAssesmentUserQuestion_LASTMODIFIEDDATE
        , BASE_HFit_HealthAssesmentUserAnswers.LASTMODIFIEDDATE AS BASE_HFit_HealthAssesmentUserAnswers_LASTMODIFIEDDATE
        , BASE_HFit_HealthAssesmentUserRiskArea.LASTMODIFIEDDATE AS BASE_HFit_HealthAssesmentUserRiskArea_LASTMODIFIEDDATE
        , BASE_HFit_HealthAssesmentUserRiskCategory.LASTMODIFIEDDATE AS BASE_HFit_HealthAssesmentUserRiskCategory_LASTMODIFIEDDATE
        , BASE_cms_usersite.LASTMODIFIEDDATE AS BASE_cms_usersite_LASTMODIFIEDDATE
        , BASE_HFit_Account.LASTMODIFIEDDATE AS BASE_HFit_Account_LASTMODIFIEDDATE
        , BASE_cms_usersettings.LASTMODIFIEDDATE AS BASE_cms_usersettings_LASTMODIFIEDDATE
        , BASE_HFit_HealthAssesmentUserModule.LASTMODIFIEDDATE AS BASE_HFit_HealthAssesmentUserModule_LASTMODIFIEDDATE
   FROM
        dbo.BASE_CMS_Site
        INNER JOIN dbo.BASE_cms_usersite
        ON
          BASE_CMS_Site.SiteID = BASE_cms_usersite.SiteID AND
          BASE_CMS_Site.SVR = BASE_cms_usersite.SVR AND
          BASE_CMS_Site.DBNAME = BASE_cms_usersite.DBNAME
        INNER JOIN dbo.BASE_cms_user
        ON
          BASE_cms_usersite.SVR = BASE_cms_user.SVR AND
          BASE_cms_usersite.DBNAME = BASE_cms_user.DBNAME AND
          BASE_cms_usersite.UserID = BASE_cms_user.UserID
        INNER JOIN dbo.BASE_HFit_Account
        ON
          BASE_CMS_Site.SiteID = BASE_HFit_Account.SiteID AND
          BASE_CMS_Site.SVR = BASE_HFit_Account.SVR AND
          BASE_CMS_Site.DBNAME = BASE_HFit_Account.DBNAME
        INNER JOIN dbo.BASE_cms_usersettings
        ON
          BASE_cms_user.SVR = BASE_cms_usersettings.SVR AND
          BASE_cms_user.DBNAME = BASE_cms_usersettings.DBNAME AND
          BASE_cms_user.UserID = BASE_cms_usersettings.UserSettingsID
        INNER JOIN dbo.BASE_HFit_HealthAssesmentUserStarted
        ON
          BASE_cms_usersite.UserID = BASE_HFit_HealthAssesmentUserStarted.UserID AND
          BASE_cms_usersite.SVR = BASE_HFit_HealthAssesmentUserStarted.SVR AND
          BASE_cms_usersite.DBNAME = BASE_HFit_HealthAssesmentUserStarted.DBNAME
        INNER JOIN dbo.BASE_HFit_HealthAssesmentUserModule
        ON
          BASE_HFit_HealthAssesmentUserStarted.ItemID = BASE_HFit_HealthAssesmentUserModule.HAStartedItemID AND
          BASE_HFit_HealthAssesmentUserStarted.SVR = BASE_HFit_HealthAssesmentUserModule.SVR AND
          BASE_HFit_HealthAssesmentUserStarted.DBNAME = BASE_HFit_HealthAssesmentUserModule.DBNAME
        INNER JOIN dbo.BASE_HFit_HealthAssesmentUserRiskCategory
        ON
          BASE_HFit_HealthAssesmentUserModule.ItemID = BASE_HFit_HealthAssesmentUserRiskCategory.HAModuleItemID AND
          BASE_HFit_HealthAssesmentUserModule.SVR = BASE_HFit_HealthAssesmentUserRiskCategory.SVR AND
          BASE_HFit_HealthAssesmentUserModule.DBNAME = BASE_HFit_HealthAssesmentUserRiskCategory.DBNAME
        INNER JOIN dbo.BASE_HFit_HealthAssesmentUserRiskArea
        ON
          BASE_HFit_HealthAssesmentUserRiskCategory.ItemID = BASE_HFit_HealthAssesmentUserRiskArea.HARiskCategoryItemID AND
          BASE_HFit_HealthAssesmentUserRiskCategory.SVR = BASE_HFit_HealthAssesmentUserRiskArea.SVR AND
          BASE_HFit_HealthAssesmentUserRiskCategory.DBNAME = BASE_HFit_HealthAssesmentUserRiskArea.DBNAME
        INNER JOIN dbo.BASE_HFit_HealthAssesmentUserQuestion
        ON
          BASE_HFit_HealthAssesmentUserRiskArea.ItemID = BASE_HFit_HealthAssesmentUserQuestion.HARiskAreaItemID AND
          BASE_HFit_HealthAssesmentUserRiskArea.SVR = BASE_HFit_HealthAssesmentUserQuestion.SVR AND
          BASE_HFit_HealthAssesmentUserRiskArea.DBNAME = BASE_HFit_HealthAssesmentUserQuestion.DBNAME
        INNER JOIN dbo.BASE_HFit_HealthAssesmentUserAnswers
        ON
          BASE_HFit_HealthAssesmentUserQuestion.ItemID = BASE_HFit_HealthAssesmentUserAnswers.HAQuestionItemID AND
          BASE_HFit_HealthAssesmentUserQuestion.SVR = BASE_HFit_HealthAssesmentUserAnswers.SVR AND
          BASE_HFit_HealthAssesmentUserQuestion.DBNAME = BASE_HFit_HealthAssesmentUserAnswers.DBNAME
        INNER JOIN dbo.FACT_View_EDW_HealthAssesmentQuestions
        ON
          BASE_HFit_HealthAssesmentUserQuestion.HAQuestionNodeGUID = FACT_View_EDW_HealthAssesmentQuestions.NODEGUID;
GO
PRINT 'Executed VIEW_DIM_HA.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_HealthAssesment_MART.sql \n 
--------------------------------------------------------------- 
USE KenticoCMS_DataMart_2;
GO
IF EXISTS ( SELECT
                   name
            FROM sys.views
            WHERE
                   name = 'view_HealthAssesment_MART'
) 
    BEGIN
        DROP VIEW
             view_HealthAssesment_MART;
    END;
GO
SET ANSI_NULLS ON;
GO
SET QUOTED_IDENTIFIER ON;
GO

-- WDM: 11/28/2015
-- This view is a test view used to develop a possible SSIS implementation of the HA dimension table.
/*
use KenticoCMS_Datamart_2
go
select top 100 * from [view_HealthAssesment_MART]
where (HAUserQuestion_ItemModifiedWhen > '2016-03-09'
or HAUserRiskArea_ItemModifiedWhen > '2016-03-09'
or HAUserQuestion_ItemModifiedWhen > '2016-03-09'
or HAUserAnswers_ItemModifiedWhen > '2016-03-09')
and CT_RowDataUpdated = 1  > '2016-03-09'
*/
-- select count(*) from [view_HealthAssesment_MART]

/*-----------------------------------------------------------------------------
use KenticoCMS_Datamart_2

drop table TEMP_view_MART_HealthAssesment
set rowcount 100 ;
select * into TEMP_view_MART_HealthAssesment from dbo.view_HealthAssesment_MART

select top 100 * from view_HealthAssesment_MART
*/

CREATE VIEW dbo.view_HealthAssesment_MART

--WITH SCHEMABINDING

AS SELECT
          HAUserStarted.ItemID AS UserStartedItemID
        , ISNULL ( VHAJ.NodeGUID , '00000000-0000-0000-0000-000000000000'
          ) AS HealthAssesmentUserStartedNodeGUID
        , HAUserStarted.UserID
        , ISNULL ( CMSUser.UserGUID , '00000000-0000-0000-0000-000000000000'
          ) AS UserGuid
        , ISNULL ( UserSettings.HFitUserMpiNumber , -1
          ) AS HFitUserMpiNumber
        , ISNULL ( CMSSite.SiteGUID , '00000000-0000-0000-0000-000000000000'
          ) AS SiteGuid
        , ACCT.AccountID
        , ISNULL ( ACCT.AccountCD , '?'
          ) AS AccountCD
        , ACCT.AccountName
        , CAST ( HAUserStarted.HAStartedDt AS DATETIME2
          ) AS HAStartedDt
        , ISNULL ( HAUserStarted.HACompletedDt , '1700-01-01'
          ) AS HACompletedDt
        , HAUserModule.ItemID AS UserModuleItemId
        , ISNULL ( HAUserModule.CodeName , '?'
          ) AS UserModuleCodeName
        , ISNULL ( HAUserModule.HAModuleNodeGUID , '00000000-0000-0000-0000-000000000000'
          ) AS HAModuleNodeGUID
        , ISNULL ( VHAJ.NodeGUID , '00000000-0000-0000-0000-000000000000'
          ) AS CMSNodeGuid
        , -1 AS HAModuleVersionID
        , ISNULL ( HARiskCategory.ItemID , -1
          ) AS UserRiskCategoryItemID
        , ISNULL ( HARiskCategory.CodeName , '?'
          ) AS UserRiskCategoryCodeName
        , ISNULL ( HARiskCategory.HARiskCategoryNodeGUID , '00000000-0000-0000-0000-000000000000'
          ) AS HARiskCategoryNodeGUID
        , -1 AS HARiskCategoryVersionID
        , ISNULL ( HAUserRiskArea.ItemID , -1
          ) AS UserRiskAreaItemID
        , ISNULL ( HAUserRiskArea.CodeName , '?'
          ) AS UserRiskAreaCodeName
        , ISNULL ( HAUserRiskArea.HARiskAreaNodeGUID , '00000000-0000-0000-0000-000000000000'
          ) AS HARiskAreaNodeGUID
        , -1 AS HARiskAreaVersionID
        , HAUserQuestion.ItemID AS UserQuestionItemID
        , dbo.udf_StripHTML ( HAQuestionsView.Title
          ) AS Title
        , ISNULL ( HAUserQuestion.HAQuestionNodeGUID , '00000000-0000-0000-0000-000000000000'
          ) AS HAQuestionGuid
        , ISNULL ( HAUserQuestion.CodeName , '?'
          ) AS UserQuestionCodeName
        , -1 AS HAQuestionDocumentID
        , -1 AS HAQuestionVersionID
        , ISNULL ( HAUserQuestion.HAQuestionNodeGUID , '00000000-0000-0000-0000-000000000000'
          ) AS HAQuestionNodeGUID
        , HAUserAnswers.ItemID AS UserAnswerItemID
        , ISNULL ( HAUserAnswers.HAAnswerNodeGUID , '00000000-0000-0000-0000-000000000000') AS HAAnswerNodeGUID
        , -1 AS HAAnswerVersionID
        , HAUserAnswers.CodeName AS UserAnswerCodeName
        , HAUserAnswers.HAAnswerValue
        , HAUserModule.HAModuleScore
        , HARiskCategory.HARiskCategoryScore
        , HAUserRiskArea.HARiskAreaScore
        , HAUserQuestion.HAQuestionScore
        , HAUserAnswers.HAAnswerPoints
        , ISNULL ( HAUserQuestionGroupResults.PointResults , -1) AS PointResults
        , HAUserAnswers.UOMCode
        , HAUserStarted.HAScore
        , HAUserModule.PreWeightedScore AS ModulePreWeightedScore
        , HARiskCategory.PreWeightedScore AS RiskCategoryPreWeightedScore
        , HAUserRiskArea.PreWeightedScore AS RiskAreaPreWeightedScore
        , HAUserQuestion.PreWeightedScore AS QuestionPreWeightedScore
        , ISNULL ( HAUserQuestionGroupResults.CodeName , '?') AS QuestionGroupCodeName
        , CASE
          WHEN
          HAUserAnswers.ItemCreatedWhen = HAUserAnswers.ItemModifiedWhen
              THEN 'I'
          ELSE 'U'
          END AS ChangeType
        , CAST ( HAUserAnswers.ItemCreatedWhen AS DATETIME2) AS ItemCreatedWhen
        , CAST ( HAUserAnswers.ItemModifiedWhen AS DATETIME2) AS ItemModifiedWhen
        , HAUserQuestion.IsProfessionallyCollected
        , CAST ( HARiskCategory.ItemModifiedWhen AS DATETIME2) AS HARiskCategory_ItemModifiedWhen
        , CAST ( HAUserRiskArea.ItemModifiedWhen AS DATETIME2) AS HAUserRiskArea_ItemModifiedWhen
        , CAST ( HAUserQuestion.ItemModifiedWhen AS DATETIME2) AS HAUserQuestion_ItemModifiedWhen
        , CAST ( HAUserAnswers.ItemModifiedWhen AS DATETIME2) AS HAUserAnswers_ItemModifiedWhen
        , HAUserStarted.HAPaperFlg
        , HAUserStarted.HATelephonicFlg
        , HAUserStarted.HAStartedMode
        , .HACompletedMode
        , VHCJ.DocumentCulture AS DocumentCulture_VHCJ
        , HAQuestionsView.DocumentCulture AS DocumentCulture_HAQuestionsView
        , ISNULL ( HAUserStarted.HACampaignNodeGUID , '00000000-0000-0000-0000-000000000000') AS CampaignNodeGUID
        , CASE
          WHEN HAUserStarted.HADocumentConfigID IS NULL
              THEN 'SHORT_VER'
          WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
              THEN 'LONG_VER'
          ELSE 'UNKNOWN'
          END AS HealthAssessmentType
        , HAUserStarted.SVR
        , HAUserStarted.DBNAME
   FROM
        dbo.HFit_HealthAssesmentUserStarted AS HAUserStarted
        INNER JOIN
        dbo.CMS_User AS CMSUser
        ON
          HAUserStarted.UserID = CMSUser.UserID AND
          HAUserStarted.SVR = CMSUser.SVR AND
          HAUserStarted.DBNAME = CMSUser.DBNAME
        INNER JOIN
        dbo.CMS_UserSettings AS UserSettings
        ON
          UserSettings.SVR = CMSUser.SVR AND
          UserSettings.DBNAME = CMSUser.DBNAME AND
          UserSettings.UserSettingsUserID = CMSUser.UserID AND
          HFitUserMpiNumber >= 0 AND
          HFitUserMpiNumber IS NOT NULL
        INNER JOIN
        dbo.CMS_UserSite AS UserSite
        ON
          CMSUser.UserID = UserSite.UserID AND
          CMSUser.SVR = UserSite.SVR AND
          CMSUser.DBNAME = UserSite.DBNAME
        INNER JOIN
        dbo.CMS_Site AS CMSSite
        ON
          UserSite.SiteID = CMSSite.SiteID AND
          UserSite.SVR = CMSSite.SVR AND
          UserSite.DBNAME = CMSSite.DBNAME
        INNER JOIN
        dbo.HFit_Account AS ACCT
        ON
          ACCT.SiteID = CMSSite.SiteID AND
          ACCT.SVR = CMSSite.SVR AND
          ACCT.DBNAME = CMSSite.DBNAME
        INNER JOIN
        dbo.HFit_HealthAssesmentUserModule AS HAUserModule
        ON
          HAUserStarted.ItemID = HAUserModule.HAStartedItemID AND
          HAUserStarted.SVR = HAUserModule.SVR AND
          HAUserStarted.DBNAME = HAUserModule.DBNAME
        INNER JOIN
        View_HFit_HACampaign_Joined AS VHCJ
        ON
          VHCJ.NodeGUID = HAUserStarted.HACampaignNodeGUID AND
          VHCJ.SVR = HAUserStarted.SVR AND
          VHCJ.DBNAME = HAUserStarted.DBNAME AND
          VHCJ.NodeSiteID = UserSite.SiteID AND
          VHCJ.DocumentCulture = 'en-US'
        INNER JOIN
        View_HFit_HealthAssessment_Joined AS VHAJ
        ON
          VHAJ.DocumentID = VHCJ.HealthAssessmentID AND
          VHAJ.SVR = VHCJ.SVR AND
          VHAJ.DBNAME = VHCJ.DBNAME
        INNER JOIN
        dbo.HFit_HealthAssesmentUserRiskCategory AS HARiskCategory
        ON
          HAUserModule.ItemID = HARiskCategory.HAModuleItemID AND
          HAUserModule.SVR = HARiskCategory.SVR AND
          HAUserModule.DBNAME = HARiskCategory.DBNAME
        INNER JOIN
        dbo.HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
        ON
          HARiskCategory.ItemID = HAUserRiskArea.HARiskCategoryItemID AND
          HARiskCategory.SVR = HAUserRiskArea.SVR AND
          HARiskCategory.DBNAME = HAUserRiskArea.DBNAME
        INNER JOIN
        dbo.HFit_HealthAssesmentUserQuestion AS HAUserQuestion
        ON
          HAUserRiskArea.ItemID = HAUserQuestion.HARiskAreaItemID AND
          HAUserRiskArea.SVR = HAUserQuestion.SVR AND
          HAUserRiskArea.DBNAME = HAUserQuestion.DBNAME
        INNER JOIN
        dbo.View_EDW_HealthAssesmentQuestions AS HAQuestionsView
        ON
          HAUserQuestion.HAQuestionNodeGUID = HAQuestionsView.NodeGUID AND
          HAUserQuestion.SVR = HAQuestionsView.SVR AND
          HAUserQuestion.DBNAME = HAQuestionsView.DBNAME AND
          HAQuestionsView.DocumentCulture = 'en-US'
        LEFT OUTER JOIN
        dbo.HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
        ON
          HAUserRiskArea.ItemID = HAUserQuestionGroupResults.HARiskAreaItemID AND
          HAUserRiskArea.SVR = HAUserQuestionGroupResults.SVR AND
          HAUserRiskArea.DBNAME = HAUserQuestionGroupResults.DBNAME
        INNER JOIN
        dbo.HFit_HealthAssesmentUserAnswers AS HAUserAnswers
        ON
          HAUserQuestion.ItemID = HAUserAnswers.HAQuestionItemID AND
          HAUserQuestion.SVR = HAUserAnswers.SVR AND
          HAUserQuestion.DBNAME = HAUserAnswers.DBNAME
   WHERE UserSettings.HFitUserMpiNumber NOT IN (
   SELECT
          RejectMPICode
   FROM HFit_LKP_EDW_RejectMPI
   );
GO

----Create an index on the view.
--CREATE UNIQUE CLUSTERED INDEX PKI_view_MART_HealthAssesment 
--    ON Sales.vOrders (OrderDate, ProductID);--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: View_HFit_HealthAssessment_Joined_MART.sql \n 
--------------------------------------------------------------- 
-- USE KenticoCMS_DataMart_2;
GO

--DROP VIEW dbo.View_HFit_HealthAssessment_Joined_MART;
GO


SET ANSI_NULLS ON;
GO

SET QUOTED_IDENTIFIER ON;
GO
-- select top 100 * from View_HFit_HealthAssessment_Joined_MART
CREATE VIEW dbo.View_HFit_HealthAssessment_Joined_MART
AS SELECT
          VJ.Published
        , VJ.SiteName
        , VJ.ClassName
        , VJ.ClassDisplayName
        , VJ.NodeID
        , VJ.NodeAliasPath
        , VJ.NodeName
        , VJ.NodeAlias
        , VJ.NodeClassID
        , VJ.NodeParentID
        , VJ.NodeLevel
        , VJ.NodeACLID
        , VJ.NodeSiteID
        , VJ.NodeGUID
        , VJ.NodeOrder
        , VJ.IsSecuredNode
        , VJ.NodeCacheMinutes
        , VJ.NodeSKUID
        , VJ.NodeDocType
        , VJ.NodeHeadTags
        , VJ.NodeBodyElementAttributes
        , VJ.NodeInheritPageLevels
        , VJ.RequiresSSL
        , VJ.NodeLinkedNodeID
        , VJ.NodeOwner
        , VJ.NodeCustomData
        , VJ.NodeGroupID
        , VJ.NodeLinkedNodeSiteID
        , VJ.NodeTemplateID
        , VJ.NodeWireframeTemplateID
        , VJ.NodeWireframeComment
        , VJ.NodeTemplateForAllCultures
        , VJ.NodeInheritPageTemplate
        , VJ.NodeWireframeInheritPageLevels
        , VJ.NodeAllowCacheInFileSystem
        , VJ.NodeHasChildren
        , VJ.NodeHasLinks
        , VJ.DocumentID
        , VJ.DocumentName
        , VJ.DocumentNamePath
        , VJ.DocumentModifiedWhen
        , VJ.DocumentModifiedByUserID
        , VJ.DocumentForeignKeyValue
        , VJ.DocumentCreatedByUserID
        , VJ.DocumentCreatedWhen
        , VJ.DocumentCheckedOutByUserID
        , VJ.DocumentCheckedOutWhen
        , VJ.DocumentCheckedOutVersionHistoryID
        , VJ.DocumentPublishedVersionHistoryID
        , VJ.DocumentWorkflowStepID
        , VJ.DocumentPublishFrom
        , VJ.DocumentPublishTo
        , VJ.DocumentUrlPath
        , VJ.DocumentCulture
        , VJ.DocumentNodeID
        , VJ.DocumentPageTitle
        , VJ.DocumentPageKeyWords
        , VJ.DocumentPageDescription
        , VJ.DocumentShowInSiteMap
        , VJ.DocumentMenuItemHideInNavigation
        , VJ.DocumentMenuCaption
        , VJ.DocumentMenuStyle
        , VJ.DocumentMenuItemImage
        , VJ.DocumentMenuItemLeftImage
        , VJ.DocumentMenuItemRightImage
        , VJ.DocumentPageTemplateID
        , VJ.DocumentMenuJavascript
        , VJ.DocumentMenuRedirectUrl
        , VJ.DocumentUseNamePathForUrlPath
        , VJ.DocumentStylesheetID
        , VJ.DocumentContent
        , VJ.DocumentMenuClass
        , VJ.DocumentMenuStyleOver
        , VJ.DocumentMenuClassOver
        , VJ.DocumentMenuItemImageOver
        , VJ.DocumentMenuItemLeftImageOver
        , VJ.DocumentMenuItemRightImageOver
        , VJ.DocumentMenuStyleHighlighted
        , VJ.DocumentMenuClassHighlighted
        , VJ.DocumentMenuItemImageHighlighted
        , VJ.DocumentMenuItemLeftImageHighlighted
        , VJ.DocumentMenuItemRightImageHighlighted
        , VJ.DocumentMenuItemInactive
        , VJ.DocumentCustomData
        , VJ.DocumentExtensions
        , VJ.DocumentCampaign
        , VJ.DocumentTags
        , VJ.DocumentTagGroupID
        , VJ.DocumentWildcardRule
        , VJ.DocumentWebParts
        , VJ.DocumentRatingValue
        , VJ.DocumentRatings
        , VJ.DocumentPriority
        , VJ.DocumentType
        , VJ.DocumentLastPublished
        , VJ.DocumentUseCustomExtensions
        , VJ.DocumentGroupWebParts
        , VJ.DocumentCheckedOutAutomatically
        , VJ.DocumentTrackConversionName
        , VJ.DocumentConversionValue
        , VJ.DocumentSearchExcluded
        , VJ.DocumentLastVersionName
        , VJ.DocumentLastVersionNumber
        , VJ.DocumentIsArchived
        , VJ.DocumentLastVersionType
        , VJ.DocumentLastVersionMenuRedirectUrl
        , VJ.DocumentHash
        , VJ.DocumentLogVisitActivity
        , VJ.DocumentGUID
        , VJ.DocumentWorkflowCycleGUID
        , VJ.DocumentSitemapSettings
        , VJ.DocumentIsWaitingForTranslation
        , VJ.DocumentSKUName
        , VJ.DocumentSKUDescription
        , VJ.DocumentSKUShortDescription
        , VJ.DocumentWorkflowActionStatus
        , VJ.DocumentMenuRedirectToFirstChild
          --,VJ.[SVR]
          --,VJ.[DBNAME]
        --, VJ.Document_LastModifiedDate
        --, VJ.SITE_LastModifiedDate
        --, VJ.CLASS_LastModifiedDate
        --, VJ.Tree_LastModifiedDate
        , VJ.SKUID
        , VJ.SKUNumber
        , VJ.SKUName
        , VJ.SKUDescription
        , VJ.SKUPrice
        , VJ.SKUEnabled
        , VJ.SKUDepartmentID
        , VJ.SKUManufacturerID
        , VJ.SKUInternalStatusID
        , VJ.SKUPublicStatusID
        , VJ.SKUSupplierID
        , VJ.SKUAvailableInDays
        , VJ.SKUGUID
        , VJ.SKUImagePath
        , VJ.SKUWeight
        , VJ.SKUWidth
        , VJ.SKUDepth
        , VJ.SKUHeight
        , VJ.SKUAvailableItems
        , VJ.SKUSellOnlyAvailable
        , VJ.SKUCustomData
        , VJ.SKUOptionCategoryID
        , VJ.SKUOrder
        , VJ.SKULastModified
        , VJ.SKUCreated
        , VJ.SKUSiteID
        , VJ.SKUPrivateDonation
        , VJ.SKUNeedsShipping
        , VJ.SKUMaxDownloads
        , VJ.SKUValidUntil
        , VJ.SKUProductType
        , VJ.SKUMaxItemsInOrder
        , VJ.SKUMaxPrice
        , VJ.SKUValidity
        , VJ.SKUValidFor
        , VJ.SKUMinPrice
        , VJ.SKUMembershipGUID
        , VJ.SKUConversionName
        , VJ.SKUConversionValue
        , VJ.SKUBundleInventoryType
        , VJ.SKUMinItemsInOrder
        , VJ.SKURetailPrice
        , VJ.SKUParentSKUID
        , VJ.SKUAllowAllVariants
        , VJ.SKUInheritsTaxClasses
        , VJ.SKUInheritsDiscounts
        , VJ.SKUTrackInventory
        , VJ.SKUShortDescription
        , VJ.SKUEproductFilesCount
        , VJ.SKUBundleItemsCount
        , VJ.SKUInStoreFrom
        , VJ.SKUReorderAt
        , VJ.NodeOwnerFullName
        , VJ.NodeOwnerUserName
        , VJ.NodeOwnerEmail
        , FT.QuestionTransformUrl
        , FT.ReviewText
        , FT.SubmitButtonText
        , FT.ReviewTitle
        , FT.SubmitRedirectUrl
        , FT.ReviewUrl
        , FT.ConfirmationTitle
        , FT.ConfirmationText
        , FT.ConfirmationUrl
        , FT.ConfirmationSubTitle
        , FT.ConfirmationEditButtonText
        , FT.SmallStepTitle
        , FT.SmallStepText
        , FT.SmallStepUrl
        , FT.MinimumOptOut
        , FT.MinimumSteps
        , FT.MaximumSteps
        , FT.IntroText
        , FT.Revision
        , FT.MyProfileConfirmationUrl
        , FT.MyProfileConfirmationTitle
        , FT.MyProfileConfirmationText
        , FT.HealthAssessmentConfigurationID
        , FT.DisplayName
        , FT.ReviewEditButtonText
        , FT.SmallStepOptoutText
        , FT.MinimumStepsError
        , FT.MaximumStepsError
        , FT.WaitMessage
        , FT.ErrorMessage
        , FT.ErrorTitle
        , FT.HealthAssessmentID
        , FT.SYS_CHANGE_VERSION
        , FT.LASTMODIFIEDDATE
        , FT.HashCode
        , FT.SVR
        , FT.DBNAME
   FROM BASE_View_CMS_Tree_Joined AS VJ
        INNER JOIN dbo.BASE_HFit_HealthAssessment AS FT
        ON
          VJ.DocumentForeignKeyValue = FT.HealthAssessmentID AND
          VJ.SVR = FT.SVR AND
          VJ.DBNAME = FT.DBNAME
   WHERE
          ClassName = 'HFit.HealthAssessment';
GO


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_MART_HealthAssesment_CT.sql \n 
--------------------------------------------------------------- 
USE KenticoCMS_DataMart_2;
GO


/*---------------------------------------------------------------------------
-----------------------------------------------------------
---------------------------------------------------
drop table ##TEMP_HA_DATA 
go
select count(*) from view_MART_HealthAssesment_CT
where CHANGETYPE is NOT NULL

set ROWCOUNT 500 ;
select * from view_MART_HealthAssesment_CT
where CHANGETYPE is NOT NULL

select * into FACT_MART_EDW_HealthAssesment from view_MART_HealthAssesment_CT
where CHANGETYPE is NOT NULL
*/
GO
PRINT 'Executing view_MART_HealthAssesment_CT.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE
                  name = 'view_MART_HealthAssesment_CT') 
    BEGIN
        DROP VIEW
             view_MART_HealthAssesment_CT;
    END;
GO

CREATE VIEW view_MART_HealthAssesment_CT
AS

--select * from FACT_View_EDW_HealthAssesmentQuestions
--select * from FACT_EDW_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS

SELECT
       HAUSERSTARTED.ITEMID AS USERSTARTEDITEMID
     , VHAJ.NODEGUID AS HEALTHASSESMENTUSERSTARTEDNODEGUID
     , HAUSERSTARTED.USERID
     , CMSUSER.USERGUID
     , USERSETTINGS.HFITUSERMPINUMBER
     , CMSSITE.SITEGUID
     , ACCT.ACCOUNTID
     , ACCT.ACCOUNTCD
     , ACCT.ACCOUNTNAME
     , HAUSERSTARTED.HASTARTEDDT
     , HAUSERSTARTED.HACOMPLETEDDT
     , HAUSERMODULE.ITEMID AS USERMODULEITEMID
     , HAUSERMODULE.CODENAME AS USERMODULECODENAME
     , HAUSERMODULE.HAMODULENODEGUID
     , VHAJ.NODEGUID AS CMSNODEGUID
     , NULL AS HAMODULEVERSIONID
     , HARISKCATEGORY.ITEMID AS USERRISKCATEGORYITEMID
     , HARISKCATEGORY.CODENAME AS USERRISKCATEGORYCODENAME
     , HARISKCATEGORY.HARISKCATEGORYNODEGUID
     , NULL AS HARISKCATEGORYVERSIONID
     , HAUSERRISKAREA.ITEMID AS USERRISKAREAITEMID
     , HAUSERRISKAREA.CODENAME AS USERRISKAREACODENAME
     , HAUSERRISKAREA.HARISKAREANODEGUID
     , NULL AS HARISKAREAVERSIONID
     , HAUSERQUESTION.ITEMID AS USERQUESTIONITEMID
     , HAQUESTIONSVIEW.TITLE
     , HAUSERQUESTION.HAQUESTIONNODEGUID AS HAQUESTIONGUID
     , HAUSERQUESTION.CODENAME AS USERQUESTIONCODENAME
     , NULL AS HAQUESTIONDOCUMENTID
     , NULL AS HAQUESTIONVERSIONID
     , HAUSERQUESTION.HAQUESTIONNODEGUID
     , HAUSERANSWERS.ITEMID AS USERANSWERITEMID
     , HAUSERANSWERS.HAANSWERNODEGUID
     , NULL AS HAANSWERVERSIONID
     , HAUSERANSWERS.CODENAME AS USERANSWERCODENAME
     , HAUSERANSWERS.HAANSWERVALUE
     , HAUSERMODULE.HAMODULESCORE
     , HARISKCATEGORY.HARISKCATEGORYSCORE
     , HAUSERRISKAREA.HARISKAREASCORE
     , HAUSERQUESTION.HAQUESTIONSCORE
     , HAUSERANSWERS.HAANSWERPOINTS
     , HAUSERQUESTIONGROUPRESULTS.POINTRESULTS
     , HAUSERANSWERS.UOMCODE
     , HAUSERSTARTED.HASCORE
     , HAUSERMODULE.PREWEIGHTEDSCORE AS MODULEPREWEIGHTEDSCORE
     , HARISKCATEGORY.PREWEIGHTEDSCORE AS RISKCATEGORYPREWEIGHTEDSCORE
     , HAUSERRISKAREA.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
     , HAUSERQUESTION.PREWEIGHTEDSCORE AS QUESTIONPREWEIGHTEDSCORE
     , HAUSERQUESTIONGROUPRESULTS.CODENAME AS QUESTIONGROUPCODENAME
     , COALESCE ( CT_CMS_USER.SYS_CHANGE_OPERATION , CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION , CT_CMS_SITE.SYS_CHANGE_OPERATION , CT_CMS_USERSITE.SYS_CHANGE_OPERATION , CT_HFIT_ACCOUNT.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_OPERATION) AS CHANGETYPE
     , HAUSERANSWERS.ITEMCREATEDWHEN
     , HAUSERANSWERS.ITEMMODIFIEDWHEN
     , HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED
     , HARISKCATEGORY.ITEMMODIFIEDWHEN AS HARISKCATEGORY_ITEMMODIFIEDWHEN
     , HAUSERRISKAREA.ITEMMODIFIEDWHEN AS HAUSERRISKAREA_ITEMMODIFIEDWHEN
     , HAUSERQUESTION.ITEMMODIFIEDWHEN AS HAUSERQUESTION_ITEMMODIFIEDWHEN
     , HAUSERANSWERS.ITEMMODIFIEDWHEN AS HAUSERANSWERS_ITEMMODIFIEDWHEN
     , HAUSERSTARTED.HAPAPERFLG
     , HAUSERSTARTED.HATELEPHONICFLG
     , HAUSERSTARTED.HASTARTEDMODE
     , HAUSERSTARTED.HACOMPLETEDMODE
     , VHCJ.DOCUMENTCULTURE AS DOCUMENTCULTURE_VHCJ
     , HAQUESTIONSVIEW.DOCUMENTCULTURE AS DOCUMENTCULTURE_HAQUESTIONSVIEW
     , HAUSERSTARTED.HACAMPAIGNNODEGUID AS CAMPAIGNNODEGUID
     , VHCJ.HACAMPAIGNID
     , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUSERSTARTED.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.USERID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( USERSETTINGS.HFITUSERMPINUMBER AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTNAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASTARTEDDT AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACOMPLETEDDT AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( LEFT ( HAQUESTIONSVIEW.TITLE , 1000) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERVALUE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULESCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREASCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERPOINTS AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.POINTRESULTS AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.UOMCODE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMCREATEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HAPAPERFLG AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HATELEPHONICFLG AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASTARTEDMODE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACOMPLETEDMODE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACAMPAIGNNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( VHCJ.HACAMPAIGNID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-')) AS VARCHAR (100)) AS HASHCODE
     , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUSERSTARTED.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( USERGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( SITEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( ACCOUNTCD AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAMODULENODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORYNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS VARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKAREANODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAQUESTIONNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAANSWERNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACAMPAIGNNODEGUID AS VARCHAR (50)) , '-')) AS VARCHAR (100)) AS PKHASHCODE
       --, COALESCE ( CT_CMS_USER.USERID , CT_CMS_USERSETTINGS.USERSETTINGSID , CT_CMS_SITE.SITEID , CT_CMS_USERSITE.USERSITEID , CT_HFIT_ACCOUNT.ACCOUNTID , CT_HFIT_HealthAssesmentUserAnswers.ITEMID , CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID , CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID , CT_HFIT_HEALTHASSESMENTUSERSTARTED.ITEMID) AS CHANGED_FLG
     , NULL AS CHANGED_FLG

       --*************************************
       --join changes to the records 

     , CT_CMS_USER.USERID AS CT_CMS_USER_USERID
     , CT_CMS_USER.SYS_CHANGE_OPERATION AS CT_CMS_USER_CHANGE_OPERATION
     , CT_CMS_USERSETTINGS.USERSETTINGSID AS CT_USERSETTINGSID
     , CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION AS CT_USERSETTINGSID_CHANGE_OPERATION
     , CT_CMS_SITE.SITEID AS SITEID_CTID
     , CT_CMS_SITE.SYS_CHANGE_OPERATION AS SITEID_CHANGE_OPERATION
     , CT_CMS_USERSITE.USERSITEID AS USERSITEID_CTID
     , CT_CMS_USERSITE.SYS_CHANGE_OPERATION AS USERSITEID_CHANGE_OPERATION
     , CT_HFIT_ACCOUNT.ACCOUNTID AS ACCOUNTID_CTID
     , CT_HFIT_ACCOUNT.SYS_CHANGE_OPERATION AS ACCOUNTID__CHANGE_OPERATION
     , CT_HFIT_HealthAssesmentUserAnswers.ITEMID AS HAUSERANSWERS_CTID
     , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION AS HAUSERANSWERS_CHANGE_OPERATION
     , CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID AS HFIT_HEALTHASSESMENTUSERMODULE_CTID
     , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERMODULE_CHANGE_OPERATION
     , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID AS HFIT_HEALTHASSESMENTUSERQUESTION_CTID
     , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
     , CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID AS HFIT_HealthAssesmentUserQuestionGroupResults_CTID
     , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION AS HFIT_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
     , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID AS HFIT_HEALTHASSESMENTUSERRISKAREA_CTID
     , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERRISKAREA_CHANGE_OPERATION
     , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID AS HFIT_HEALTHASSESMENTUSERRISKCATEGORY_CTID
     , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERRISKCATEGORY_CHANGE_OPERATION
     , CT_HFIT_HEALTHASSESMENTUSERSTARTED.ITEMID AS HFIT_HEALTHASSESMENTUSERSTARTED_CTID
     , CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERSTARTED_CHANGE_OPERATION

       --Get the TYPE of change ID NUMBER
     , CT_CMS_USER.SYS_CHANGE_VERSION AS CT_CMS_USER_SCV
     , CT_CMS_USERSETTINGS.SYS_CHANGE_VERSION AS CT_CMS_USERSETTINGS_SCV
     , CT_CMS_SITE.SYS_CHANGE_VERSION AS CT_CMS_SITE_SCV
     , CT_CMS_USERSITE.SYS_CHANGE_VERSION AS CT_CMS_USERSITE_SCV
     , CT_HFIT_ACCOUNT.SYS_CHANGE_VERSION AS CT_HFIT_ACCOUNT_SCV
     , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION AS CT_HFIT_HealthAssesmentUserAnswers_SCV
     , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERMODULE_SCV
     , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
     , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION AS CT_HFIT_HealthAssesmentUserQuestionGroupResults_SCV
     , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERRISKAREA_SCV
     , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY_SCV
     , CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERSTARTED_SCV

     , HAUSERANSWERS.ITEMMODIFIEDWHEN AS LastModifiedDATE
     , 0 AS DELETEFLG
     , CASE
       WHEN HAUserStarted.HADocumentConfigID IS NULL
               THEN 'SHORT_VER'
       WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
               THEN 'LONG_VER'
           ELSE 'UNKNOWN'
       END AS HealthAssessmentType
     , 0 AS LASTUPDATEID
       --, GETDATE () AS LASTLOADEDDATE
     , HAUSERSTARTED.SVR
     , HAUSERSTARTED.DBNAME
     , 0 AS DeletedFlg
     , NULL AS LASTLOADEDDATE
--, change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'SiteID', 'columnid') , CTE.sys_change_columns) AS [SiteID_cg] 
--, change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'UserID', 'columnid') , CTE.sys_change_columns) AS [UserID_cg] 
--, change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'UserPreferredCurrencyID', 'columnid') , CTE.sys_change_columns) AS [UserPreferredCurrencyID_cg] 
       FROM dbo.BASE_HFIT_HEALTHASSESMENTUSERSTARTED AS HAUSERSTARTED
                INNER JOIN DBO.BASE_CMS_USER AS CMSUSER
                    ON HAUSERSTARTED.USERID = CMSUSER.USERID
                   AND HAUSERSTARTED.SVR = CMSUSER.SVR
                   AND HAUSERSTARTED.DBNAME = CMSUSER.DBNAME
                INNER JOIN DBO.BASE_CMS_USERSETTINGS AS USERSETTINGS
                    ON USERSETTINGS.USERSETTINGSUSERID = CMSUSER.USERID
                   AND USERSETTINGS.HFITUSERMPINUMBER >= 0
                   AND USERSETTINGS.HFITUSERMPINUMBER IS NOT NULL
                   AND USERSETTINGS.SVR = CMSUSER.SVR
                   AND USERSETTINGS.DBNAME = CMSUSER.DBNAME
                INNER JOIN DBO.BASE_CMS_USERSITE AS USERSITE
                    ON CMSUSER.USERID = USERSITE.USERID
                   AND CMSUSER.SVR = USERSITE.SVR
                   AND CMSUSER.DBNAME = USERSITE.DBNAME
                INNER JOIN DBO.BASE_CMS_SITE AS CMSSITE
                    ON USERSITE.SITEID = CMSSITE.SITEID
                   AND USERSITE.SVR = CMSSITE.SVR
                   AND USERSITE.DBNAME = CMSSITE.DBNAME
                INNER JOIN DBO.BASE_HFIT_ACCOUNT AS ACCT
                    ON ACCT.SITEID = CMSSITE.SITEID
                   AND ACCT.SVR = CMSSITE.SVR
                   AND ACCT.DBNAME = CMSSITE.DBNAME
                INNER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE
                    ON HAUSERSTARTED.ITEMID = HAUSERMODULE.HASTARTEDITEMID
                   AND HAUSERSTARTED.SVR = HAUSERMODULE.SVR
                   AND HAUSERSTARTED.DBNAME = HAUSERMODULE.DBNAME
                INNER JOIN DBO.FACT_EDW_VIEW_HFIT_HACAMPAIGN_JOINED AS VHCJ
                    ON VHCJ.NODEGUID = HAUSERSTARTED.HACAMPAIGNNODEGUID
                   AND VHCJ.NODESITEID = USERSITE.SITEID
                   AND VHCJ.DOCUMENTCULTURE = 'en-US'
                   AND VHCJ.SVR = USERSITE.SVR
                   AND VHCJ.DBNAME = USERSITE.DBNAME
                INNER JOIN DBO.FACT_EDW_VIEW_HFIT_HEALTHASSESSMENT_JOINED AS VHAJ
                    ON VHAJ.DOCUMENTID = VHCJ.HEALTHASSESSMENTID
                   AND VHAJ.SVR = VHCJ.SVR
                   AND VHAJ.DBNAME = VHCJ.DBNAME
                INNER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY
                    ON HAUSERMODULE.ITEMID = HARISKCATEGORY.HAMODULEITEMID
                   AND HAUSERMODULE.SVR = HARISKCATEGORY.SVR
                   AND HAUSERMODULE.DBNAME = HARISKCATEGORY.DBNAME
                INNER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERRISKAREA AS HAUSERRISKAREA
                    ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
                   AND HARISKCATEGORY.SVR = HAUSERRISKAREA.SVR
                   AND HARISKCATEGORY.DBNAME = HAUSERRISKAREA.DBNAME
                INNER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERQUESTION AS HAUSERQUESTION
                    ON HAUSERRISKAREA.ITEMID = HAUSERQUESTION.HARISKAREAITEMID
                   AND HAUSERRISKAREA.SVR = HAUSERQUESTION.SVR
                   AND HAUSERRISKAREA.DBNAME = HAUSERQUESTION.DBNAME
                INNER JOIN DBO.FACT_View_EDW_HealthAssesmentQuestions AS HAQUESTIONSVIEW
                    ON HAUSERQUESTION.HAQUESTIONNODEGUID = HAQUESTIONSVIEW.NODEGUID
                   AND HAUSERQUESTION.SVR = HAQUESTIONSVIEW.SVR
                   AND HAUSERQUESTION.DBNAME = HAQUESTIONSVIEW.DBNAME
                LEFT OUTER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS AS HAUSERQUESTIONGROUPRESULTS
                    ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
                   AND HAUSERRISKAREA.SVR = HAUSERQUESTIONGROUPRESULTS.SVR
                   AND HAUSERRISKAREA.DBNAME = HAUSERQUESTIONGROUPRESULTS.DBNAME
                INNER JOIN DBO.BASE_HFIT_HEALTHASSESMENTUSERANSWERS AS HAUSERANSWERS
                    ON HAUSERQUESTION.ITEMID = HAUSERANSWERS.HAQUESTIONITEMID
                   AND HAUSERQUESTION.SVR = HAUSERANSWERS.SVR
                   AND HAUSERQUESTION.DBNAME = HAUSERANSWERS.DBNAME
                LEFT JOIN CHANGETABLE (CHANGES BASE_CMS_USERSETTINGS, NULL) AS CT_CMS_USERSETTINGS
                    ON USERSETTINGS.USERSETTINGSID = CT_CMS_USERSETTINGS.USERSETTINGSID
                   AND USERSETTINGS.SVR = CT_CMS_USERSETTINGS.SVR
                   AND USERSETTINGS.DBNAME = CT_CMS_USERSETTINGS.DBNAME
                LEFT JOIN CHANGETABLE (CHANGES DBO.BASE_CMS_USER, NULL) AS CT_CMS_USER
                    ON CMSUSER.USERID = CT_CMS_USER.USERID
                   AND CMSUSER.SVR = CT_CMS_USER.SVR
                   AND CMSUSER.DBNAME = CT_CMS_USER.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_CMS_SITE, NULL) AS CT_CMS_SITE
                    ON CMSSITE.SITEID = CT_CMS_SITE.SITEID
                   AND CMSSITE.SVR = CT_CMS_SITE.SVR
                   AND CMSSITE.DBNAME = CT_CMS_SITE.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_CMS_USERSITE, NULL) AS CT_CMS_USERSITE
                    ON USERSITE.USERSITEID = CT_CMS_USERSITE.USERSITEID
                   AND USERSITE.SVR = CT_CMS_USERSITE.SVR
                   AND USERSITE.DBNAME = CT_CMS_USERSITE.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_ACCOUNT, NULL) AS CT_HFIT_ACCOUNT
                    ON ACCT.ACCOUNTID = CT_HFIT_ACCOUNT.ACCOUNTID
                   AND ACCT.SVR = CT_HFIT_ACCOUNT.SVR
                   AND ACCT.DBNAME = CT_HFIT_ACCOUNT.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HACAMPAIGN, NULL) AS CT_HFIT_HACAMPAIGN
                    ON VHCJ.HACAMPAIGNID = CT_HFIT_HACAMPAIGN.HACAMPAIGNID
                   AND VHCJ.SVR = CT_HFIT_HACAMPAIGN.SVR
                   AND VHCJ.DBNAME = CT_HFIT_HACAMPAIGN.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERANSWERS, NULL) AS CT_HFIT_HEALTHASSESMENTUSERANSWERS
                    ON HAUSERANSWERS.ITEMID = CT_HFIT_HEALTHASSESMENTUSERANSWERS.ITEMID
                   AND HAUSERANSWERS.SVR = CT_HFIT_HEALTHASSESMENTUSERANSWERS.SVR
                   AND HAUSERANSWERS.DBNAME = CT_HFIT_HEALTHASSESMENTUSERANSWERS.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERMODULE, NULL) AS CT_HFIT_HEALTHASSESMENTUSERMODULE
                    ON HAUSERMODULE.ITEMID = CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID
                   AND HAUSERMODULE.SVR = CT_HFIT_HEALTHASSESMENTUSERMODULE.SVR
                   AND HAUSERMODULE.DBNAME = CT_HFIT_HEALTHASSESMENTUSERMODULE.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERQUESTION, NULL) AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
                    ON HAUSERQUESTION.ITEMID = CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID
                   AND HAUSERQUESTION.SVR = CT_HFIT_HEALTHASSESMENTUSERQUESTION.SVR
                   AND HAUSERQUESTION.DBNAME = CT_HFIT_HEALTHASSESMENTUSERQUESTION.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS, NULL) AS CT_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS
                    ON HAUSERQUESTIONGROUPRESULTS.ITEMID = CT_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS.ITEMID
                   AND HAUSERQUESTIONGROUPRESULTS.SVR = CT_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS.SVR
                   AND HAUSERQUESTIONGROUPRESULTS.DBNAME = CT_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERRISKAREA, NULL) AS CT_HFIT_HEALTHASSESMENTUSERRISKAREA
                    ON HAUSERRISKAREA.ITEMID = CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID
                   AND HAUSERRISKAREA.SVR = CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SVR
                   AND HAUSERRISKAREA.DBNAME = CT_HFIT_HEALTHASSESMENTUSERRISKAREA.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERRISKCATEGORY, NULL) AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
                    ON HARISKCATEGORY.ITEMID = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID
                   AND HARISKCATEGORY.SVR = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SVR
                   AND HARISKCATEGORY.DBNAME = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.DBNAME
                LEFT OUTER JOIN CHANGETABLE (CHANGES DBO.BASE_HFIT_HEALTHASSESMENTUSERSTARTED, NULL) AS CT_HFIT_HEALTHASSESMENTUSERSTARTED
                    ON HAUSERSTARTED.ITEMID = CT_HFIT_HEALTHASSESMENTUSERSTARTED.ITEMID
                   AND HAUSERSTARTED.SVR = CT_HFIT_HEALTHASSESMENTUSERSTARTED.SVR
                   AND HAUSERSTARTED.DBNAME = CT_HFIT_HEALTHASSESMENTUSERSTARTED.DBNAME
       WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
    SELECT
           BASE_HFIT_LKP_EDW_REJECTMPI.REJECTMPICODE
           FROM DBO.BASE_HFIT_LKP_EDW_REJECTMPI);

GO
PRINT 'GEN CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS00';
GO

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS00') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS00
        ON dbo.BASE_HFIT_HEALTHASSESMENTUSERANSWERS (SVR , DBNAME , HAQuestionItemID) 
        INCLUDE (HAAnswerPoints , ItemCreatedWhen , ItemModifiedWhen , HAAnswerValue , UOMCode , CodeName , HAAnswerNodeGUID , ItemID) ;
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS01') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS01
        ON dbo.BASE_HFit_HealthAssesmentUserRiskCategory (HAModuleItemID , SVR , DBNAME) 
        INCLUDE (ItemModifiedWhen , HARiskCategoryScore , CodeName , PreWeightedScore , HARiskCategoryNodeGUID , ItemID) ;
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS02') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS02
        ON dbo.BASE_HFit_HealthAssesmentUserRiskArea (HARiskCategoryItemID , ItemID , SVR , DBNAME) 
        INCLUDE (HARiskAreaScore , ItemModifiedWhen , CodeName , PreWeightedScore , HARiskAreaNodeGUID) ;
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS03') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_BASE_BASE_HFIT_HEALTHASSESMENTUSERANSWERS03
        ON dbo.BASE_HFit_HealthAssesmentUserModule (HAStartedItemID , SVR , DBNAME) 
        INCLUDE (HAModuleScore , CodeName , PreWeightedScore , HAModuleNodeGUID , ItemID) ;
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE
                      name = 'PI_BASE_HFit_HealthAssesmentUserStarted00') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_BASE_HFit_HealthAssesmentUserStarted00
        ON dbo.BASE_HFit_HealthAssesmentUserStarted (HACampaignNodeGUID , SVR , DBNAME) 
        INCLUDE (UserID , ItemID) ;
    END;
GO
PRINT 'Executed view_MART_HealthAssesment_CT.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_UserExcludedCondition.sql \n 
--------------------------------------------------------------- 


-- use KenticoCMS_Datamart_2;
-- select top 100 * from view_UserExcludedCondition
GO
PRINT 'Executing view_UserExcludedCondition.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_UserExcludedCondition') 
    BEGIN
        DROP VIEW
             view_UserExcludedCondition;
    END;
GO
-- exec proc_UpdateSurrogateKeyDataBetweenParentAndChild "BASE_CMS_User", "SurrogateKey_CMS_User","BASE_HFit_LKP_CoachingCMExclusions","UserID", "UserID",1
--select * from BASE_HFit_LKP_CoachingCMExclusions
--Excluding conditions assigned to user
CREATE VIEW view_UserExcludedCondition
AS 
    SELECT
          UserExclusion.ItemID
        , UserExclusion.UserId
        , UserExclusion.ExclusionItemID
        , UserExclusion.ItemCreatedBy
        , UserExclusion.ItemCreatedWhen
        , UserExclusion.ItemModifiedBy
        , UserExclusion.ItemModifiedWhen
        , UserExclusion.ItemOrder
        , UserExclusion.ItemGUID
        , exc.[Description] AS ExcludedCondition
        , UserExclusion.HashCode        
        , UserExclusion.LastModifiedDate
        , UserExclusion.[Action]
        , UserExclusion.SYS_CHANGE_VERSION
        , UserExclusion.SVR
        , UserExclusion.DBNAME
	   , UserExclusion.SurrogateKey_Hfit_CoachingUserCMExclusion
        , CMSUSER.SurrogateKey_CMS_User
   FROM dbo.BASE_Hfit_CoachingUserCMExclusion AS UserExclusion
        INNER JOIN BASE_HFit_LKP_CoachingCMExclusions AS exc
        ON
          UserExclusion.ExclusionItemID = exc.ItemID AND
          UserExclusion.SVR = exc.SVR AND
          UserExclusion.DBNAME = exc.DBNAME
        INNER JOIN BASE_CMS_User AS CMSUSER
        ON
          CMSUSER.SVR = UserExclusion.SVR AND
          CMSUSER.DBNAME = UserExclusion.DBNAME AND
          CMSUSER.UserId = UserExclusion.UserId;
GO
PRINT 'Executing view_UserExcludedCondition.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_EDW_HealthAssesment_MART.sql \n 
--------------------------------------------------------------- 


-- use KenticoCMS_Datamart_2

GO
PRINT 'Processing view_EDW_HealthAssesment_MART';
GO

IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_EDW_HealthAssesment_MART') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssesment_MART;
    END;
GO
-- use KenticoCMS_Datamart_2
-- select top 100 * from [view_EDW_HealthAssesment_MART] where CT_HATelephonicFlg !=0 or CT_CodeName != 0
-- select * from [view_EDW_HealthAssesment_MART] where CT_CodeName != 0
-- select * from information_schema.columns where table_name = 'view_EDW_HealthAssesment_MART' order by column_name 
CREATE VIEW dbo.view_EDW_HealthAssesment_MART
AS
--********************************************************************************************************
--7/15/2014 17:19 min. 46,750 Rows DEV
--7/15/2014 per Mark Turner
--HAModuleDocumentID is on its way out, so is - 
--Module - RiskCategory - RiskArea - Question - Answer 
--all the "DocumentID" fields are deprecated and replaced by corresponding NodeGUID fields
--8/7/2014 - Executed in DEV with GUID changes and returned 51K Rows in 00:43:10.
--8/8/2014 - Generated corrected view in DEV
-- Verified last mod date available to EDW 9.10.2014

--09.08.2014: John Croft and I working together, realized there is a deficit in the ability 
--of the EDW to recognize changes to database records based on the last modified date of a row. 
--The views that we are currently using in the database or deeply nested. This means that 
--several base tables are involved in building a single view of data.

--09.30.2014: Verified with John Croft that he does want this view to return multi-languages.
--
--The views were initially designed to recognize a date change based on a record change very 
--high in the data hierarchy, the CMS Tree level which is the top most level. However, John 
--and I recognize that data can change at any level in the hierarchy and those changes must be 
--recognized as well. Currently, that is not the case. With the new modification to the views, 
--changes in CMS documents and base tables will filter up through the hierarchy and the EDW load 
--process will be able to realize that a change in this rows data may affect and intrude into 
--the warehouse.

-- 10.01.2014 - Reviewed by Mark and Dale for use of the GUIDS
-- 10.01.2014 - Reviewed by Mark and Dale for use of Joins and fixed two that were incorrect (Thanks to Mark)

-- 10.23.2014 - (WDM) added two columns for the EDW HAPaperFlg / HATelephonicFlg
--			HAPaperFlg is whether the question was reveived electronically or on paper
--			HATelephonicFlg is whether the question was reveived by telephone or not

-- FIVE Pieces needed per John C. 10.16.2014
--	Document GUID -> HealthAssesmentUserStartedNodeGUID
--	Module GUID -> Module -> HAUserModule.HAModuleNodeGUID
--	Category GUID -> Category
--	RiskArea Node Guid -> RiskArea 
--	Question Node Guid -> Question
--	Answer Node Guid -> Answer 

--   10.30.2014 : Sowmiya 
--   The following are the possible values allowed in the HAStartedMode and HACompletedMode columns of the Hfit_HealthAssesmentUserStarted table
--      Unknown = 0, 
--       Paper = 1,  // Paper HA
--       Telephonic = 2, // Telephonic HA
--       Online = 3, // Online HA
--       Ipad = 4 // iPAD
-- 08/07/2014 - (WDM) as HAModuleDocumentID	--WDM 10.02.2014 place holder for EDW ETL per John C., Added back per John C. 10.16.2014
-- 09/30/2014 - (WDM) as HAModuleDocumentID	--Mark and Dale use NodeGUID instead of Doc GUID
--WDM 10.02.2014 place holder for EDW ETL
--Per John C. 10.16.2014 requested that this be put back into the view.	
--11.05.2014 - Changed from CMS_TREE Joined to View_HFit_HealthAssessment_Joined Mark T. / Dale M.
-- 11.05.2014 - Mark T. / Dale M. needed to get the Document for the user : ADDED inner join View_HFit_HealthAssessment_Joined as VHAJ on VHAJ.DocumentID = VHCJ.HealthAssessmentID
-- 11.05.2014 - removed the Distinct - may find it necessary to put it back as duplicates may be there. But the server resources required to do this may not be avail on P5.
--11.05.2014 - Mark T. / Dale M. removed the link to View_CMS_Tree_Joined and replaced with View_HFit_HealthAssessment_Joined
--inner join View_CMS_Tree_Joined as VCTJ on VCTJ.NodeGUID = HAUserModule.HAModuleNodeGUID
--	and VCTJ.DocumentCulture = 'en-US'	--10.01.2014 put here to match John C. req. for language agnostic.
-- 12.02.2014 - (wdm)Found that the view was being overwritten between Prod 1 and the copy of Prod 5 / Prod 1. Found a script inside a job on PRod 5 that reverted the view to a previous state. Removed the script and the view migrates correctly (d. miller and m. kimenski)
-- 12.02.2014 - (wdm) Found DUPS in Prod 1 and Prod 2, none in Prod 3. 
-- 12.17.2014 - Added two columns requested by the EDW team as noted by comments next to each column.
-- 12.29.2014 - Stripped HTML out of Title #47619
-- 12.31.2014 - Eliminated negative MPI's in response to CR47516 
-- 01.02.2014 - Tested the removal of negative MPI's in response to CR47516 
--01.27.2015 (WDM) #48941 - Add Client Identifier to View_EDW_Eligibility
--	   In analyzing this requirement, found that the PPT.ClientID is nvarchar (alphanumeric)
--	   and Hfit_Client.ClientID is integer. A bit of a domain/naming issue.
--	   This is NOT needed as the data is already contained in columns [AccountID] and [AccountCD]
--	   NOTE: Added the column [AccountName], just in case it were to be needed later.
--02.04.2015 (WDM) #48828 added:
--	    [HAUserStarted].[HACampaignNodeGUID], VCJ.BiometricCampaignStartDate
--	   , VCJ.BiometricCampaignEndDate, VCJ.CampaignStartDate
--	   , VCJ.CampaignEndDate, VCJ.Name as CampaignName, HACampaignID
-- PER John C. 2.6.2015 - Please comment out all columns except the GUID in the Assesment view.  It will reduce the amount of data coming through the delta process.  Thank you
--, [VHCJ].BiometricCampaignStartDate
--, [VHCJ].BiometricCampaignEndDate
--, [VHCJ].CampaignStartDate
--, [VHCJ].CampaignEndDate
--, [VHCJ].Name as CampaignName 
--, [VHCJ].HACampaignID

/*---------------------------------------
--the below are need in this view 
, HACampaign.BiometricCampaignStartDate
, HACampaign.BiometricCampaignEndDate
, HACampaign.CampaignStartDate
, HACampaign.CampaignEndDate
, HACampaign.Name

or only the 
select * from HAUserStarted
, HACampaign.NodeGuid as CampaignNodeGuid
*/

--02.05.2015 Ashwin and I reviewed and approved
--07.09.2015 (WDM) - Dea and I discussed the need to capture and present the Health Assessment Type.
--				Mark and I discussed how best to do this and the data, basically, was already in 
--				the view. I added the field HealthAssessmentType to the view.

--02.29.2016 (WDM) - Modified to run using the MART data.
--03.02.2016 (WDM) - Removed the CAST from DT2 to DT, causing errors.
--03.02.2016 (WDM) - Added needed performance indexes.
--********************************************************************************************************

SELECT
       HAUserStarted.ItemID AS UserStartedItemID
     , VHAJ.NodeGUID AS HealthAssesmentUserStartedNodeGUID
     , HAUserStarted.UserID
     , CMSUser.UserGUID
     , UserSettings.HFitUserMpiNumber
     , CMSSite.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , ACCT.AccountName
       --, CAST (HAUserStarted.HAStartedDt AS datetime) AS HAStartedDt
       --, CAST (HAUserStarted.HACompletedDt AS datetime) AS HACompletedDt
     , HAUserStarted.HAStartedDt
     , HAUserStarted.HACompletedDt
     , HAUserModule.ItemID AS UserModuleItemId
     , HAUserModule.CodeName AS UserModuleCodeName
     , HAUserModule.HAModuleNodeGUID
     , VHAJ.NodeGUID AS CMSNodeGuid
     , NULL AS HAModuleVersionID
     , HARiskCategory.ItemID AS UserRiskCategoryItemID
     , HARiskCategory.CodeName AS UserRiskCategoryCodeName
     , HARiskCategory.HARiskCategoryNodeGUID						--WDM 8/7/2014 as HARiskCategoryDocumentID
     , NULL AS HARiskCategoryVersionID			--WDM 10.02.2014 place holder for EDW ETL
     , HAUserRiskArea.ItemID AS UserRiskAreaItemID
     , HAUserRiskArea.CodeName AS UserRiskAreaCodeName
     , HAUserRiskArea.HARiskAreaNodeGUID							--WDM 8/7/2014 as HARiskAreaDocumentID
     , NULL AS HARiskAreaVersionID			--WDM 10.02.2014 place holder for EDW ETL
     , HAUserQuestion.ItemID AS UserQuestionItemID
     , dbo.udf_StripHTML (HAQuestionsView.Title) AS Title			--WDM 47619 12.29.2014
     , HAUserQuestion.HAQuestionNodeGUID AS HAQuestionGuid		--WDM 9.2.2014	This is a repeat field but had to stay to match the previous view - this is the NODE GUID and matches to the definition file to get the question. This tells you the question, language agnostic.
     , HAUserQuestion.CodeName AS UserQuestionCodeName
     , NULL AS HAQuestionDocumentID	--WDM 10.1.2014 - this is GOING AWAY 		--WDM 10.02.2014 place holder for EDW ETL
     , NULL AS HAQuestionVersionID			--WDM 10.1.2014 - this is GOING AWAY - no versions across environments 		--WDM 10.02.2014 place holder for EDW ETL
     , HAUserQuestion.HAQuestionNodeGUID		--WDM 10.01.2014	Left this in place to preserve column structure.		
     , HAUserAnswers.ItemID AS UserAnswerItemID
     , HAUserAnswers.HAAnswerNodeGUID								--WDM 8/7/2014 as HAAnswerDocumentID
     , NULL AS HAAnswerVersionID		--WDM 10.1.2014 - this is GOING AWAY - no versions across environments		--WDM 10.02.2014 place holder for EDW ETL
     , HAUserAnswers.CodeName AS UserAnswerCodeName
     , HAUserAnswers.HAAnswerValue
     , HAUserModule.HAModuleScore
     , HARiskCategory.HARiskCategoryScore
     , HAUserRiskArea.HARiskAreaScore
     , HAUserQuestion.HAQuestionScore
     , HAUserAnswers.HAAnswerPoints
     , HAUserQuestionGroupResults.PointResults
     , HAUserAnswers.UOMCode
     , HAUserStarted.HAScore
     , HAUserModule.PreWeightedScore AS ModulePreWeightedScore
     , HARiskCategory.PreWeightedScore AS RiskCategoryPreWeightedScore
     , HAUserRiskArea.PreWeightedScore AS RiskAreaPreWeightedScore
     , HAUserQuestion.PreWeightedScore AS QuestionPreWeightedScore
     , HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName
     , CASE
       WHEN
       HAUserAnswers.ItemCreatedWhen = HAUserAnswers.ItemModifiedWhen
           THEN 'I'
       ELSE 'U'
       END AS ChangeType
       --, CAST (HAUserAnswers.ItemCreatedWhen AS datetime) AS ItemCreatedWhen
       --, CAST (HAUserAnswers.ItemModifiedWhen AS datetime) AS ItemModifiedWhen
     , HAUserAnswers.ItemCreatedWhen
     , HAUserAnswers.ItemModifiedWhen
     , HAUserQuestion.IsProfessionallyCollected
       --, CAST (HARiskCategory.ItemModifiedWhen AS datetime) AS HARiskCategory_ItemModifiedWhen
       --, CAST (HAUserRiskArea.ItemModifiedWhen AS datetime) AS HAUserRiskArea_ItemModifiedWhen
       --, CAST (HAUserQuestion.ItemModifiedWhen AS datetime) AS HAUserQuestion_ItemModifiedWhen
       --, CAST (HAUserAnswers.ItemModifiedWhen AS datetime) AS HAUserAnswers_ItemModifiedWhen
     , HARiskCategory.ItemModifiedWhen AS HARiskCategory_ItemModifiedWhen
     , HAUserRiskArea.ItemModifiedWhen AS HAUserRiskArea_ItemModifiedWhen
     , HAUserQuestion.ItemModifiedWhen AS HAUserQuestion_ItemModifiedWhen
     , HAUserAnswers.ItemModifiedWhen AS HAUserAnswers_ItemModifiedWhen
     , HAUserStarted.HAPaperFlg
     , HAUserStarted.HATelephonicFlg
     , HAUserStarted.HAStartedMode		--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 
     , HAUserStarted.HACompletedMode	--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 

     , VHCJ.DocumentCulture AS DocumentCulture_VHCJ
     , HAQuestionsView.DocumentCulture AS DocumentCulture_HAQuestionsView
     , HAUserStarted.HACampaignNodeGUID AS CampaignNodeGUID
     , CASE
       WHEN HAUserStarted.HADocumentConfigID IS NULL
           THEN 'SHORT_VER'
       WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
           THEN 'LONG_VER'
       ELSE 'UNKNOWN'
       END AS HealthAssessmentType

    /*
    select top 100 hastartedmode from HFit_HealthAssesmentUserStarted where ItemID between 100 and 110
    update HFit_HealthAssesmentUserStarted -1 where ItemID between 100 and 110
    update HFit_HealthAssesmentUserStarted 3 where ItemID between 100 and 110

    select top 100 HATelephonicFlg from HFit_HealthAssesmentUserStarted where ItemID between 200 and 210
    update HFit_HealthAssesmentUserStarted set HATelephonicFlg = 1 where ItemID between  200 and 210
    update HFit_HealthAssesmentUserStarted set HATelephonicFlg = 0 where ItemID between  200 and 210

    update HFit_HealthAssesmentUserQuestion set IsProfessionallyCollected = 1 where ItemID in (15047,15048,15049,15050,15051)
    update HFit_HealthAssesmentUserQuestion set IsProfessionallyCollected = 0 where ItemID in (15047,15048,15049,15050,15051)

    select top 100 ItemID,CodeName from HFit_HealthAssesmentUserAnswers where ItemID in (15422,15423,15424)
    update HFit_HealthAssesmentUserAnswers set CodeName = 'Maybe' where ItemID  in (15422,15423,15424)
    update HFit_HealthAssesmentUserAnswers set CodeName = 'No' where ItemID  in (15422,15423,15424)

    */
    ,CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserStarted') , 'HAStartedMode' , 'ColumnId') , CT_HAUserStarted.SYS_CHANGE_COLUMNS) as CT_HAUserStarted
    ,CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserStarted') , 'HATelephonicFlg' , 'ColumnId') , CT_HAUserStarted.SYS_CHANGE_COLUMNS) as CT_HATelephonicFlg
    ,CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserStarted') , 'HADocumentConfigID' , 'ColumnId') , CT_HAUserStarted.SYS_CHANGE_COLUMNS) as CT_HADocumentConfigID
    ,CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSettings') , 'HFitUserMpiNumber' , 'ColumnId') , CTBL_UserSettings.SYS_CHANGE_COLUMNS) as CT_HFitUserMpiNumber
    ,CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserQuestion') , 'IsProfessionallyCollected' , 'ColumnId') , CTBL_HAUserQuestion.SYS_CHANGE_COLUMNS) as CT_IsProfessionallyCollected
    ,CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserAnswers') , 'CodeName' , 'ColumnId') , CTBL_HAUserAnswers.SYS_CHANGE_COLUMNS) as CT_CodeName
     , CASE
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserStarted') , 'HAStartedMode' , 'ColumnId') , CT_HAUserStarted.SYS_CHANGE_COLUMNS) = 1
           THEN 40
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserStarted') , 'HATelephonicFlg' , 'ColumnId') , CT_HAUserStarted.SYS_CHANGE_COLUMNS) = 1
           THEN 41
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserAnswers') , 'ItemModifiedWhen', 'ColumnId') , SYS_CHANGE_COLUMNS) = 1
               THEN 42
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserQuestion') , 'ItemModifiedWhen', 'ColumnId') , SYS_CHANGE_COLUMNS) = 1
               THEN 43
           WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserRiskArea') , 'ItemModifiedWhen', 'ColumnId') , SYS_CHANGE_COLUMNS) = 1
               THEN 44
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserStarted') , 'HADocumentConfigID' , 'ColumnId') , CT_HAUserStarted.SYS_CHANGE_COLUMNS) = 1
           THEN 52
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSettings') , 'HFitUserMpiNumber' , 'ColumnId') , CTBL_UserSettings.SYS_CHANGE_COLUMNS) = 1
           THEN 53
       WHEN     
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserQuestion') , 'IsProfessionallyCollected' , 'ColumnId') , CTBL_HAUserQuestion.SYS_CHANGE_COLUMNS) = 1
           THEN 54
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserAnswers') , 'ItemCreatedWhen' , 'ColumnId') , CTBL_HAUserAnswers.SYS_CHANGE_COLUMNS) = 1
           THEN 55
           WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserAnswers') , 'ItemModifiedWhen', 'ColumnId') , SYS_CHANGE_COLUMNS) = 1
               THEN 56
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserModule') , 'PreWeightedScore' , 'ColumnId') , CT_HAUserModule.SYS_CHANGE_COLUMNS) = 1
           THEN 57
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserQuestionGroupResults') , 'PointResults' , 'ColumnId') , CTBL_HAUserQuestionGroupResults.SYS_CHANGE_COLUMNS) = 1
           THEN 50
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserQuestionGroupResults') , 'CodeName' , 'ColumnId') , CTBL_HAUserQuestionGroupResults.SYS_CHANGE_COLUMNS) = 1
           THEN 59
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserQuestion') , 'PreWeightedScore' , 'ColumnId') , CTBL_HAUserQuestion.SYS_CHANGE_COLUMNS) = 1
           THEN 60
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserRiskArea') , 'PreWeightedScore' , 'ColumnId') , CTBL_HAUserRiskArea.SYS_CHANGE_COLUMNS) = 1
           THEN 61
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserRiskCategory') , 'PreWeightedScore' , 'ColumnId') , CTBL_HARiskCategory.SYS_CHANGE_COLUMNS) = 1
           THEN 62
           WHEN
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('View_EDW_HealthAssesmentQuestions') , 'Title' , 'ColumnId') , CTBL_HAQuestionsView.SYS_CHANGE_COLUMNS) = 1
           THEN 64
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserAnswers') , 'UOMCode' , 'ColumnId') , CTBL_HAUserAnswers.SYS_CHANGE_COLUMNS) = 1
           THEN 65
       WHEN
       CHANGE_TRACKING_IS_COLUMN_IN_MASK (COLUMNPROPERTY (OBJECT_ID ('HFit_HealthAssesmentUserAnswers') , 'CodeName' , 'ColumnId') , CTBL_HAUserAnswers.SYS_CHANGE_COLUMNS) = 1
           THEN 66
           WHEN
       ELSE 0
       END AS RowDataChanged
FROM
     dbo.HFit_HealthAssesmentUserStarted AS HAUserStarted
     INNER JOIN
     dbo.CMS_User AS CMSUser
     ON
       HAUserStarted.UserID = CMSUser.UserID AND --HAUserStarted.SVR = CMSUser.SVR AND
       HAUserStarted.DBNAME = CMSUser.DBNAME
     left JOIN
     CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted , NULL) AS CT_HAUserStarted
     ON
       HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted = CT_HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted
     INNER JOIN
     dbo.CMS_UserSettings AS UserSettings
     ON
       UserSettings.UserSettingsUserID = CMSUser.UserID AND --UserSettings.SVR = CMSUser.SVR AND
       UserSettings.DBNAME = CMSUser.DBNAME AND
       HFitUserMpiNumber >= 0 AND
       HFitUserMpiNumber IS NOT NULL -- (WDM) CR47516 
     LEFT JOIN
     CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CTBL_UserSettings
     ON
       UserSettings.SurrogateKey_CMS_UserSettings = CTBL_UserSettings.SurrogateKey_CMS_UserSettings
     INNER JOIN
     dbo.CMS_UserSite AS UserSite
     ON
       CMSUser.UserID = UserSite.UserID AND --CMSUser.SVR = UserSite.SVR AND
       CMSUser.DBNAME = UserSite.DBNAME
     INNER JOIN
     dbo.CMS_Site AS CMSSite
     ON
       UserSite.SiteID = CMSSite.SiteID AND --UserSite.SVR = CMSSite.SVR AND
       UserSite.DBNAME = CMSSite.DBNAME
     INNER JOIN
     dbo.HFit_Account AS ACCT
     ON
       ACCT.SiteID = CMSSite.SiteID AND --ACCT.svr = CMSSite.SVR AND
       ACCT.DBNAME = CMSSite.DBNAME
     INNER JOIN
     dbo.HFit_HealthAssesmentUserModule AS HAUserModule
     ON
       HAUserStarted.ItemID = HAUserModule.HAStartedItemID AND --HAUserStarted.SVR = HAUserModule.SVR AND
       HAUserStarted.DBNAME = HAUserModule.DBNAME
     LEFT JOIN
     CHANGETABLE (CHANGES HFit_HealthAssesmentUserModule , NULL) AS CT_HAUserModule
     ON
       HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule = HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule
     INNER JOIN
     View_HFit_HACampaign_Joined AS VHCJ
     ON
       VHCJ.NodeGUID = HAUserStarted.HACampaignNodeGUID AND --VHCJ.SVR = HAUserStarted.SVR AND
       VHCJ.DBNAME = HAUserStarted.DBNAME AND
       VHCJ.NodeSiteID = UserSite.SiteID AND
       VHCJ.DocumentCulture = 'en-US'
     INNER JOIN
     View_HFit_HealthAssessment_Joined AS VHAJ
     ON
       VHAJ.DocumentID = VHCJ.HealthAssessmentID AND --VHAJ.SVR = VHCJ.SVR AND
       VHAJ.DBNAME = VHCJ.DBNAME
     INNER JOIN
     dbo.HFit_HealthAssesmentUserRiskCategory AS HARiskCategory
     ON
       HAUserModule.ItemID = HARiskCategory.HAModuleItemID AND --HAUserModule.SVR = HARiskCategory.SVR AND
       HAUserModule.DBNAME = HARiskCategory.DBNAME
     LEFT JOIN
     CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskCategory , NULL) AS CTBL_HARiskCategory
     ON
       HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory = CTBL_HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
     INNER JOIN
     dbo.HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
     ON
       HARiskCategory.ItemID = HAUserRiskArea.HARiskCategoryItemID AND --HARiskCategory.SVR = HAUserRiskArea.SVR AND
       HARiskCategory.DBNAME = HAUserRiskArea.DBNAME
     LEFT JOIN
     CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea , NULL) AS CTBL_HAUserRiskArea
     ON
       HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea = CTBL_HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea
     INNER JOIN
     dbo.HFit_HealthAssesmentUserQuestion AS HAUserQuestion
     ON
       HAUserRiskArea.ItemID = HAUserQuestion.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestion.SVR AND
       HAUserRiskArea.DBNAME = HAUserQuestion.DBNAME --**********************
     LEFT JOIN
     CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestion , NULL) AS CTBL_HAUserQuestion
     ON
       HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion = CTBL_HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion
     INNER JOIN
     dbo.View_EDW_HealthAssesmentQuestions AS HAQuestionsView
     ON
       HAUserQuestion.HAQuestionNodeGUID = HAQuestionsView.NodeGUID AND --HAUserQuestion.SVR = HAQuestionsView.SVR AND
       HAUserQuestion.DBNAME = HAQuestionsView.DBNAME AND
       HAQuestionsView.DocumentCulture = 'en-US'
     LEFT JOIN
     CHANGETABLE (CHANGES View_EDW_HealthAssesmentQuestions , NULL) AS CTBL_HAQuestionsView
     ON
       HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions = CTBL_HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions
     LEFT OUTER JOIN
     dbo.HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
     ON
       HAUserRiskArea.ItemID = HAUserQuestionGroupResults.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestionGroupResults.SVR AND
       HAUserRiskArea.DBNAME = HAUserQuestionGroupResults.DBNAME
    --WDMXX
     LEFT JOIN
     CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults , NULL) AS CTBL_HAUserQuestionGroupResults
     ON
       HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults = CTBL_HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults
     INNER JOIN
     dbo.HFit_HealthAssesmentUserAnswers AS HAUserAnswers
     ON
       HAUserQuestion.ItemID = HAUserAnswers.HAQuestionItemID AND --HAUserQuestion.SVR = HAUserAnswers.SVR AND
       HAUserQuestion.DBNAME = HAUserAnswers.DBNAME
     LEFT JOIN
     CHANGETABLE (CHANGES HFit_HealthAssesmentUserAnswers , NULL) AS CTBL_HAUserAnswers
     ON
       HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers = CTBL_HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers
WHERE UserSettings.HFitUserMpiNumber NOT IN (
SELECT
       RejectMPICode
FROM HFit_LKP_EDW_RejectMPI) ;
GO

PRINT 'Processed view_EDW_HealthAssesment_MART';
GO
--  
IF NOT EXISTS (SELECT
                      name
               FROM sys.indexes
               WHERE
                      name = 'PI_CMS_Document_DocumentCulture') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_CMS_Document_DocumentCulture
        ON dbo.CMS_Document (DocumentCulture) 
        INCLUDE (DocumentForeignKeyValue , DocumentNodeID , SVR , DBNAME) ;
    END;

GO
IF NOT EXISTS (SELECT
                      name
               FROM sys.indexes
               WHERE
                      name = 'PI_CMS_Document_NodeClassID_SVR') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_CMS_Document_NodeClassID_SVR
        ON dbo.CMS_Tree (NodeClassID , SVR) 
        INCLUDE (NodeSiteID , NodeGUID , NodeLinkedNodeID) ;
    END;

GO
IF NOT EXISTS (SELECT
                      name
               FROM sys.indexes
               WHERE
                      name = 'PI_CMS_Document_ClassName') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_CMS_Document_ClassName
        ON dbo.CMS_Class (ClassName) ;
    END;

GO
IF NOT EXISTS (SELECT
                      name
               FROM sys.indexes
               WHERE
                      name = 'CI_CMS_Document_Culture_NodeID_SVR') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_CMS_Document_Culture_NodeID_SVR
        ON dbo.CMS_Document (DocumentCulture , DocumentNodeID , SVR) 
        INCLUDE (DocumentForeignKeyValue , DBNAME) ;
    END;
--  
GO
PRINT '***** Executed: view_EDW_HealthAssesment_MART.sql';
GO 


If not exists (select name from sys.indexes where name = 'PI_MART_HA_HAUserStarted_LastModifiedDate')
create nonclustered index PI_MART_HA_HAUserStarted_LastModifiedDate on BASE_MART_EDW_HealthAssesment (HAUserStarted_LastModifiedDate)
GO
If not exists (select name from sys.indexes where name = 'PI_MART_HA_CMSUser_LastModifiedDate')
create nonclustered index PI_MART_HA_CMSUser_LastModifiedDate on BASE_MART_EDW_HealthAssesment (CMSUser_LastModifiedDate)
GO
If not exists (select name from sys.indexes where name = 'PI_MART_HA_UserSettings_LastModifiedDate')
create nonclustered index PI_MART_HA_UserSettings_LastModifiedDate on BASE_MART_EDW_HealthAssesment (UserSettings_LastModifiedDate)
GO
If not exists (select name from sys.indexes where name = 'PI_MART_HA_UserSite_LastModifiedDate')
create nonclustered index PI_MART_HA_UserSite_LastModifiedDate on BASE_MART_EDW_HealthAssesment (UserSite_LastModifiedDate)
GO
If not exists (select name from sys.indexes where name = 'PI_MART_HA_ACCT_LastModifiedDate')
create nonclustered index PI_MART_HA_ACCT_LastModifiedDate on BASE_MART_EDW_HealthAssesment (ACCT_LastModifiedDate)
GO
If not exists (select name from sys.indexes where name = 'PI_MART_HA_HAUserModule_LastModifiedDate')
create nonclustered index PI_MART_HA_HAUserModule_LastModifiedDate on BASE_MART_EDW_HealthAssesment (HAUserModule_LastModifiedDate)
GO
If not exists (select name from sys.indexes where name = 'PI_MART_HA_HARiskCategory_LastModifiedDate')
create nonclustered index PI_MART_HA_HARiskCategory_LastModifiedDate on BASE_MART_EDW_HealthAssesment (HARiskCategory_LastModifiedDate)
GO
If not exists (select name from sys.indexes where name = 'PI_MART_HA_HAUserRiskArea_LastModifiedDate')
create nonclustered index PI_MART_HA_HAUserRiskArea_LastModifiedDate on BASE_MART_EDW_HealthAssesment (HAUserRiskArea_LastModifiedDate)
GO
If not exists (select name from sys.indexes where name = 'PI_MART_HA_HAUserQuestion_LastModifiedDate')
create nonclustered index PI_MART_HA_HAUserQuestion_LastModifiedDate on BASE_MART_EDW_HealthAssesment (HAUserQuestion_LastModifiedDate)
GO
If not exists (select name from sys.indexes where name = 'PI_MART_HA_HAUserAnswers_LastModifiedDate')
create nonclustered index PI_MART_HA_HAUserAnswers_LastModifiedDate on BASE_MART_EDW_HealthAssesment (HAUserAnswers_LastModifiedDate)
GO
If not exists (select name from sys.indexes where name = 'PI_MART_HA_LastModifiedDate')
create nonclustered index PI_MART_HA_LastModifiedDate on BASE_MART_EDW_HealthAssesment (LastModifiedDate)
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_EDW_HealthAssessment_MART_Pull_CMS1.sql \n 
--------------------------------------------------------------- 

/****************************************************************************
select * from view_EDW_HealthAssessment_MART_CMS1
select * +-into DIM_EDW_HA_STATIC_DATA from view_EDW_HealthAssessment_MART_CMS1
****************************************************************************/
/*
-- select top 10 UserID from KenticoCMS_1.dbo.HFit_HealthAssesmentUserStarted order by UserID desc
--	update KenticoCMS_1.dbo.HFit_HealthAssesmentUserStarted Set HAScore = HAScore+1 where UserID in
--	(
--	23381
--,51062
--,51090
--,51097
--,51093
--,51089
--,51081
--,51141
--,51155
--,51680
--,511029)
*/
-- use KenticoCMS_Datamart_2
-- select * from view_EDW_HealthAssessment_MART_Pull_CMS1
-- select * from view_EDW_HealthAssessment_MART_Pull_CMS1
GO
PRINT 'Processing view_EDW_HealthAssessment_MART_Pull_CMS1';
GO
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_EDW_HealthAssessment_MART_Pull_CMS1') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessment_MART_Pull_CMS1
    END;

GO

/*********************************************************************************************************************************
    select top 100 hastartedmode from BASE_HFit_HealthAssesmentUserStarted where ItemID between 100 and 110
    update BASE_HFit_HealthAssesmentUserStarted -1 where ItemID between 100 and 110
    update BASE_HFit_HealthAssesmentUserStarted 3 where ItemID between 100 and 110

    select top 100 HATelephonicFlg from BASE_HFit_HealthAssesmentUserStarted where ItemID between 200 and 210
    update BASE_HFit_HealthAssesmentUserStarted set HATelephonicFlg = 1 where ItemID between  200 and 210
    update BASE_HFit_HealthAssesmentUserStarted set HATelephonicFlg = 0 where ItemID between  200 and 210

    update BASE_HFit_HealthAssesmentUserQuestion set IsProfessionallyCollected = 1 where ItemID in (15047,15048,15049,15050,15051)
    update BASE_HFit_HealthAssesmentUserQuestion set IsProfessionallyCollected = 0 where ItemID in (15047,15048,15049,15050,15051)

    select top 100 ItemID,CodeName from BASE_HFit_HealthAssesmentUserAnswers where ItemID in (15422,15423,15424)
    update BASE_HFit_HealthAssesmentUserAnswers set CodeName = 'Maybe' where ItemID  in (15422,15423,15424)
    update BASE_HFit_HealthAssesmentUserAnswers set CodeName = 'No' where ItemID  in (15422,15423,15424)

	select count(*) from view_EDW_HealthAssessment_MART_Pull_CMS1
*********************************************************************************************************************************/

--SET ROWCOUNT 100;
-- USE KenticoCMS_Datamart_2

CREATE VIEW view_EDW_HealthAssessment_MART_Pull_CMS1
AS
-- Use KenticoCMS_Datamart_2
SELECT
       HAUserStarted.ItemID AS UserStartedItemID
     ,VHAJ.NodeGUID AS HealthAssesmentUserStartedNodeGUID
     ,HAUserStarted.UserID
     ,CMSUser.UserGUID
     ,UserSettings.HFitUserMpiNumber
     ,CMSSite.SiteGUID
     ,ACCT.AccountID
     ,ACCT.AccountCD
     ,ACCT.AccountName
       --, CAST (HAUserStarted.HAStartedDt AS datetime) AS HAStartedDt
       --, CAST (HAUserStarted.HACompletedDt AS datetime) AS HACompletedDt
     ,
       HAUserStarted.HAStartedDt
     ,HAUserStarted.HACompletedDt
     ,HAUserModule.ItemID AS UserModuleItemId
     ,HAUserModule.CodeName AS UserModuleCodeName
     ,HAUserModule.HAModuleNodeGUID
     ,VHAJ.NodeGUID AS CMSNodeGuid
     ,NULL AS HAModuleVersionID
     ,HARiskCategory.ItemID AS UserRiskCategoryItemID
     ,HARiskCategory.CodeName AS UserRiskCategoryCodeName
     ,HARiskCategory.HARiskCategoryNodeGUID						--WDM 8/7/2014 as HARiskCategoryDocumentID
     ,
       NULL AS HARiskCategoryVersionID			--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserRiskArea.ItemID AS UserRiskAreaItemID
     ,HAUserRiskArea.CodeName AS UserRiskAreaCodeName
     ,HAUserRiskArea.HARiskAreaNodeGUID							--WDM 8/7/2014 as HARiskAreaDocumentID
     ,
       NULL AS HARiskAreaVersionID			--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserQuestion.ItemID AS UserQuestionItemID
       --, dbo.udf_StripHTML (HAQuestionsView.Title) AS Title			--WDM 47619 12.29.2014
     ,
       HAQuestionsView.Title
     ,HAUserQuestion.HAQuestionNodeGUID AS HAQuestionGuid		--WDM 9.2.2014	This is a repeat field but had to stay to match the previous view - this is the NODE GUID and matches to the definition file to get the question. This tells you the question, language agnostic.
     ,
       HAUserQuestion.CodeName AS UserQuestionCodeName
     ,NULL AS HAQuestionDocumentID	--WDM 10.1.2014 - this is GOING AWAY 		--WDM 10.02.2014 place holder for EDW ETL
     ,
       NULL AS HAQuestionVersionID			--WDM 10.1.2014 - this is GOING AWAY - no versions across environments 		--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserQuestion.HAQuestionNodeGUID		--WDM 10.01.2014	Left this in place to preserve column structure.		
     ,
       HAUserAnswers.ItemID AS UserAnswerItemID
     ,HAUserAnswers.HAAnswerNodeGUID								--WDM 8/7/2014 as HAAnswerDocumentID
     ,
       NULL AS HAAnswerVersionID		--WDM 10.1.2014 - this is GOING AWAY - no versions across environments		--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserAnswers.CodeName AS UserAnswerCodeName
     ,HAUserAnswers.HAAnswerValue
     ,HAUserModule.HAModuleScore
     ,HARiskCategory.HARiskCategoryScore
     ,HAUserRiskArea.HARiskAreaScore
     ,HAUserQuestion.HAQuestionScore
     ,HAUserAnswers.HAAnswerPoints
       --WDM , HAUserQuestionGroupResults.PointResults
     ,
       HAUserAnswers.UOMCode
     ,HAUserStarted.HAScore
     ,HAUserModule.PreWeightedScore AS ModulePreWeightedScore
     ,HARiskCategory.PreWeightedScore AS RiskCategoryPreWeightedScore
     ,HAUserRiskArea.PreWeightedScore AS RiskAreaPreWeightedScore
     ,HAUserQuestion.PreWeightedScore AS QuestionPreWeightedScore
       --WDM, HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName
     ,
       CASE
       WHEN
       HAUserAnswers.ItemCreatedWhen = HAUserAnswers.ItemModifiedWhen
           THEN 'I'
       ELSE 'U'
       END AS ChangeType
       --, CAST (HAUserAnswers.ItemCreatedWhen AS datetime) AS ItemCreatedWhen
       --, CAST (HAUserAnswers.ItemModifiedWhen AS datetime) AS ItemModifiedWhen
     ,
       HAUserAnswers.ItemCreatedWhen
     ,HAUserAnswers.ItemModifiedWhen
     ,HAUserQuestion.IsProfessionallyCollected
       --, CAST (HARiskCategory.ItemModifiedWhen AS datetime) AS HARiskCategory_ItemModifiedWhen
       --, CAST (HAUserRiskArea.ItemModifiedWhen AS datetime) AS HAUserRiskArea_ItemModifiedWhen
       --, CAST (HAUserQuestion.ItemModifiedWhen AS datetime) AS HAUserQuestion_ItemModifiedWhen
       --, CAST (HAUserAnswers.ItemModifiedWhen AS datetime) AS HAUserAnswers_ItemModifiedWhen
     ,
       HARiskCategory.ItemModifiedWhen AS HARiskCategory_ItemModifiedWhen
     ,HAUserRiskArea.ItemModifiedWhen AS HAUserRiskArea_ItemModifiedWhen
     ,HAUserQuestion.ItemModifiedWhen AS HAUserQuestion_ItemModifiedWhen
     ,HAUserAnswers.ItemModifiedWhen AS HAUserAnswers_ItemModifiedWhen
     ,HAUserStarted.HAPaperFlg
     ,HAUserStarted.HATelephonicFlg
     ,HAUserStarted.HAStartedMode		--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 
     ,
       HAUserStarted.HACompletedMode	--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 
     ,
       VHCJ.DocumentCulture AS DocumentCulture_VHCJ
     ,HAQuestionsView.DocumentCulture AS DocumentCulture_HAQuestionsView
     ,HAUserStarted.HACampaignNodeGUID AS CampaignNodeGUID
     ,CASE
      WHEN HAUserStarted.HADocumentConfigID IS NULL
          THEN 'SHORT_VER'
      WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
          THEN 'LONG_VER'
      ELSE 'UNKNOWN'
      END AS HealthAssessmentType
     ,HAUserStarted.CT_HAStartedMode
     ,HAUserStarted.CT_HATelephonicFlg
     ,HAUserStarted.CT_HADocumentConfigID
     ,UserSettings.CT_HFitUserMpiNumber
     ,HAUserQuestion.CT_IsProfessionallyCollected
     ,HAUserAnswers.CT_CodeName
     ,CASE
      WHEN
       HAUserStarted.CT_HAStartedMode = 1
          THEN 40
      WHEN
       HAUserStarted.CT_HATelephonicFlg = 1
          THEN 41
      WHEN
       HAUserAnswers.CT_ItemModifiedWhen = 1
          THEN 42
      WHEN
       HAUserQuestion.CT_ItemModifiedWhen = 1
          THEN 43
      WHEN
       HAUserRiskArea.CT_ItemModifiedWhen = 1
          THEN 44
      WHEN
       HAUserStarted.CT_HADocumentConfigID = 1
          THEN 52
      WHEN
       HAUserQuestion.CT_IsProfessionallyCollected = 1
          THEN 54
      WHEN
       HAUserAnswers.CT_ItemCreatedWhen = 1
          THEN 55
      WHEN
       HAUserAnswers.CT_ItemModifiedWhen = 1
          THEN 56
      WHEN
       HAUserModule.CT_PreWeightedScore = 1
          THEN 57
      --wdmWHEN
      --HAUserQuestionGroupResults.CT_PointResults = 1
      --THEN 50
      --wdmWHEN
      --HAUserQuestionGroupResults.CT_CodeName = 1
      --THEN 59
      WHEN
       HAUserQuestion.CT_PreWeightedScore = 1
          THEN 60
      WHEN
       HAUserRiskArea.CT_PreWeightedScore = 1
          THEN 61
      WHEN
       HARiskCategory.CT_PreWeightedScore = 1
          THEN 62
      WHEN
       CMSSite.CT_SiteGUID = 1
          THEN 63
      WHEN
       HAQuestionsView.CT_Title = 1
          THEN 64
      WHEN
       HAUserAnswers.CT_UOMCode = 1
          THEN 65
      WHEN
       HAUserAnswers.CT_CodeName = 1
          THEN 66
      ELSE 0
      END AS RowDataChanged
     ,HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted
     ,CMSUser.SurrogateKey_CMS_User
     ,UserSettings.SurrogateKey_CMS_UserSettings
     ,UserSite.SurrogateKey_CMS_UserSite
     ,CMSSite.SurrogateKey_CMS_Site
     ,ACCT.SurrogateKey_HFit_Account
     ,HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule
     ,VHCJ.SurrogateKey_View_HFit_HACampaign_Joined
     ,VHAJ.SurrogateKey_View_HFit_HealthAssessment_Joined
     ,HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
     ,HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea
     ,HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion
     ,HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions
       --wdm,HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults	  
     ,
       HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers
     ,HAUserStarted.DBNAME
     ,HAUserStarted.SVR
     ,HAUserStarted.LastModifiedDate AS HAUserStarted_LastModifiedDate
     ,CMSUser.LastModifiedDate AS CMSUser_LastModifiedDate
     ,UserSettings.LastModifiedDate AS UserSettings_LastModifiedDate
     ,UserSite.LastModifiedDate AS UserSite_LastModifiedDate
     ,ACCT.LastModifiedDate AS ACCT_LastModifiedDate
     ,HAUserModule.LastModifiedDate AS HAUserModule_LastModifiedDate
     ,HARiskCategory.LastModifiedDate AS HARiskCategory_LastModifiedDate
     ,HAUserRiskArea.LastModifiedDate AS HAUserRiskArea_LastModifiedDate
     ,HAUserQuestion.LastModifiedDate AS HAUserQuestion_LastModifiedDate
     ,HAUserAnswers.LastModifiedDate AS HAUserAnswers_LastModifiedDate
     ,CASE
      WHEN
       HAUserStarted.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserStarted.LastModifiedDate
      WHEN
       CMSUser.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       CMSUser.LastModifiedDate > UserSettings.LastModifiedDate AND
       CMSUser.LastModifiedDate > UserSite.LastModifiedDate AND
       CMSUser.LastModifiedDate > ACCT.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserModule.LastModifiedDate AND
       CMSUser.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN CMSUser.LastModifiedDate
      WHEN
       UserSettings.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       UserSettings.LastModifiedDate > CMSUser.LastModifiedDate AND
       UserSettings.LastModifiedDate > UserSite.LastModifiedDate AND
       UserSettings.LastModifiedDate > ACCT.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserModule.LastModifiedDate AND
       UserSettings.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN UserSettings.LastModifiedDate
      WHEN
       UserSite.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       UserSite.LastModifiedDate > CMSUser.LastModifiedDate AND
       UserSite.LastModifiedDate > UserSettings.LastModifiedDate AND
       UserSite.LastModifiedDate > ACCT.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserModule.LastModifiedDate AND
       UserSite.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN UserSite.LastModifiedDate
      WHEN
       ACCT.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       ACCT.LastModifiedDate > CMSUser.LastModifiedDate AND
       ACCT.LastModifiedDate > UserSettings.LastModifiedDate AND
       ACCT.LastModifiedDate > UserSite.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserModule.LastModifiedDate AND
       ACCT.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN ACCT.LastModifiedDate
      WHEN
       HAUserModule.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserModule.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserModule.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserModule.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserModule.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserModule.LastModifiedDate
      WHEN
       HARiskCategory.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > CMSUser.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > UserSettings.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > UserSite.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > ACCT.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserModule.LastModifiedDate
      WHEN
       HAUserRiskArea.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserRiskArea.LastModifiedDate
      WHEN
       HAUserQuestion.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserQuestion.LastModifiedDate
      WHEN
       HAUserAnswers.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HAUserQuestion.LastModifiedDate
          THEN HAUserAnswers.LastModifiedDate
      ELSE NULL
      END AS LastModifiedDate
     ,CT.SYS_CHANGE_OPERATION, CT.SYS_CHANGE_VERSION

/*********************************************************************************
use KenticoCMS_Datamart_2
SELECT *    
FROM
    CHANGETABLE(CHANGES KenticoCMS_1.dbo.HFit_HealthAssesmentUserStarted, 0) AS CT
*********************************************************************************/
FROM
     CHANGETABLE (CHANGES KenticoCMS_1.dbo.HFit_HealthAssesmentUserStarted, 0) AS CT
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserStarted AS HAUserStarted
          ON
       HAUserStarted.ItemID = CT.ItemID
	  and HAUserStarted.DBNAME = 'KenticoCMS_1'
          INNER JOIN dbo.BASE_CMS_User AS CMSUser
          ON
       HAUserStarted.UserID = CMSUser.UserID AND --HAUserStarted.SVR = CMSUser.SVR AND
       HAUserStarted.DBNAME = CMSUser.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserStarted , NULL) AS CT_HAUserStarted
     --ON
     --  HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted = CT_HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted
          INNER JOIN dbo.BASE_CMS_UserSettings AS UserSettings
          ON
       UserSettings.UserSettingsUserID = CMSUser.UserID AND --UserSettings.SVR = CMSUser.SVR AND
       UserSettings.DBNAME = CMSUser.DBNAME AND
       HFitUserMpiNumber >= 0 AND HFitUserMpiNumber IS NOT NULL -- (WDM) CR47516 
     --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_CMS_UserSettings , NULL) AS CTBL_UserSettings
     --ON
     --  UserSettings.SurrogateKey_CMS_UserSettings = CTBL_UserSettings.SurrogateKey_CMS_UserSettings
          INNER JOIN dbo.BASE_CMS_UserSite AS UserSite
          ON
       CMSUser.UserID = UserSite.UserID AND --CMSUser.SVR = UserSite.SVR AND
       CMSUser.DBNAME = UserSite.DBNAME
          INNER JOIN dbo.BASE_CMS_Site AS CMSSite
          ON
       UserSite.SiteID = CMSSite.SiteID AND --UserSite.SVR = CMSSite.SVR AND
       UserSite.DBNAME = CMSSite.DBNAME
          INNER JOIN dbo.BASE_HFit_Account AS ACCT
          ON
       ACCT.SiteID = CMSSite.SiteID AND --ACCT.svr = CMSSite.SVR AND
       ACCT.DBNAME = CMSSite.DBNAME
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserModule AS HAUserModule
          ON
       HAUserStarted.ItemID = HAUserModule.HAStartedItemID AND --HAUserStarted.SVR = HAUserModule.SVR AND
       HAUserStarted.DBNAME = HAUserModule.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserModule , NULL) AS CT_HAUserModule
     --ON
     --  HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule = HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule
          INNER JOIN dbo.BASE_View_HFit_HACampaign_Joined AS VHCJ
          ON
       VHCJ.NodeGUID = HAUserStarted.HACampaignNodeGUID AND --VHCJ.SVR = HAUserStarted.SVR AND
       VHCJ.DBNAME = HAUserStarted.DBNAME AND
       VHCJ.NodeSiteID = UserSite.SiteID AND
       VHCJ.DocumentCulture = 'en-US'
          INNER JOIN dbo.BASE_View_HFit_HealthAssessment_Joined AS VHAJ
          ON
       VHAJ.DocumentID = VHCJ.HealthAssessmentID AND --VHAJ.SVR = VHCJ.SVR AND
       VHAJ.DBNAME = VHCJ.DBNAME
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserRiskCategory AS HARiskCategory
          ON
       HAUserModule.ItemID = HARiskCategory.HAModuleItemID AND --HAUserModule.SVR = HARiskCategory.SVR AND
       HAUserModule.DBNAME = HARiskCategory.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskCategory , NULL) AS CTBL_HARiskCategory
     --ON
     --  HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory = CTBL_HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
          ON
       HARiskCategory.ItemID = HAUserRiskArea.HARiskCategoryItemID AND --HARiskCategory.SVR = HAUserRiskArea.SVR AND
       HARiskCategory.DBNAME = HAUserRiskArea.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea , NULL) AS CTBL_HAUserRiskArea
     --ON
     --  HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea = CTBL_HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserQuestion AS HAUserQuestion
          ON
       HAUserRiskArea.ItemID = HAUserQuestion.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestion.SVR AND
       HAUserRiskArea.DBNAME = HAUserQuestion.DBNAME --**********************
     --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestion , NULL) AS CTBL_HAUserQuestion
     --ON
     --  HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion = CTBL_HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion
          INNER JOIN dbo.BASE_View_EDW_HealthAssesmentQuestions AS HAQuestionsView
          ON
       HAUserQuestion.HAQuestionNodeGUID = HAQuestionsView.NodeGUID AND --HAUserQuestion.SVR = HAQuestionsView.SVR AND
       HAUserQuestion.DBNAME = HAQuestionsView.DBNAME AND
       HAQuestionsView.DocumentCulture = 'en-US' --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_View_EDW_HealthAssesmentQuestions , NULL) AS CTBL_HAQuestionsView
     --ON
     --  HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions = CTBL_HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions

     --wdmLEFT JOIN
     --dbo.BASE_HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
     --ON
     --  HAUserRiskArea.ItemID = HAUserQuestionGroupResults.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestionGroupResults.SVR AND
     --  HAUserRiskArea.DBNAME = HAUserQuestionGroupResults.DBNAME 

     --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestionGroupResults , NULL) AS CTBL_HAUserQuestionGroupResults
     --ON
     --  HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults = CTBL_HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserAnswers AS HAUserAnswers
          ON
       HAUserQuestion.ItemID = HAUserAnswers.HAQuestionItemID AND --HAUserQuestion.SVR = HAUserAnswers.SVR AND
       HAUserQuestion.DBNAME = HAUserAnswers.DBNAME;
--LEFT JOIN
--CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserAnswers , NULL) AS CTBL_HAUserAnswers
--ON
--  HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers = CTBL_HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers
--WDMWHERE
--UserSettings.HFitUserMpiNumber NOT IN (
--SELECT
--       RejectMPICode
--FROM  dbo.BASE_HFit_LKP_EDW_RejectMPI) ;

GO
-- use KenticoCMS_Datamart_2
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_EDW_HealthAssessment_MART_CMS1') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessment_MART_CMS1;
    END;
GO
CREATE VIEW view_EDW_HealthAssessment_MART_CMS1
AS SELECT
          HaMain.UserStartedItemID
        ,HaMain.UserID
        ,HaMain.UserGUID
        ,HaMain.HFitUserMpiNumber
        ,HaMain.SiteGUID
        ,HaMain.AccountID
        ,HaMain.AccountCD
        ,HaMain.AccountName
        ,HaMain.HAStartedDt
        ,HaMain.HACompletedDt
        ,HaMain.UserModuleItemId
        ,HaMain.UserModuleCodeName
        ,HaMain.HAModuleNodeGUID
        ,HaMain.CMSNodeGuid
        ,HaMain.HAModuleVersionID
        ,HaMain.UserRiskCategoryItemID
        ,HaMain.UserRiskCategoryCodeName
        ,HaMain.HARiskCategoryNodeGUID
        ,HaMain.HARiskCategoryVersionID
        ,HaMain.UserRiskAreaItemID
        ,HaMain.UserRiskAreaCodeName
        ,HaMain.HARiskAreaNodeGUID
        ,HaMain.HARiskAreaVersionID
        ,HaMain.UserQuestionItemID
        ,HaMain.Title
        ,HaMain.HAQuestionGuid
        ,HaMain.UserQuestionCodeName
        ,HaMain.HAQuestionDocumentID
        ,HaMain.HAQuestionVersionID
        ,HaMain.HAQuestionNodeGUID
        ,HaMain.UserAnswerItemID
        ,HaMain.HAAnswerNodeGUID
        ,HaMain.HAAnswerVersionID
        ,HaMain.UserAnswerCodeName
        ,HaMain.HAAnswerValue
        ,HaMain.HAModuleScore
        ,HaMain.HARiskCategoryScore
        ,HaMain.HARiskAreaScore
        ,HaMain.HAQuestionScore
        ,HaMain.HAAnswerPoints
        ,HaMain.UOMCode
        ,HaMain.HAScore
        ,HaMain.ModulePreWeightedScore
        ,HaMain.RiskCategoryPreWeightedScore
        ,HaMain.RiskAreaPreWeightedScore
        ,HaMain.QuestionPreWeightedScore
        ,HaMain.ChangeType
        ,HaMain.ItemCreatedWhen
        ,HaMain.ItemModifiedWhen
        ,HaMain.IsProfessionallyCollected
        ,HaMain.HAPaperFlg
        ,HaMain.HATelephonicFlg
        ,HaMain.HAStartedMode
        ,HaMain.HACompletedMode
        ,HaMain.DocumentCulture_VHCJ
        ,HaMain.DocumentCulture_HAQuestionsView
        ,HaMain.CampaignNodeGUID
        ,HaMain.HealthAssessmentType
        ,HaMain.HAUserStarted_LastModifiedDate
        ,HaMain.CMSUser_LastModifiedDate
        ,HaMain.UserSettings_LastModifiedDate
        ,HaMain.UserSite_LastModifiedDate
        ,HaMain.ACCT_LastModifiedDate
        ,HaMain.HAUserModule_LastModifiedDate
        ,HaMain.HARiskCategory_LastModifiedDate
        ,HaMain.HAUserRiskArea_LastModifiedDate
        ,HaMain.HAUserQuestion_LastModifiedDate
        ,HaMain.HAUserAnswers_LastModifiedDate
        ,HealthAssesmentUserStartedNodeGUID
        ,HAUserQuestionGroupResults.PointResults
        ,HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName
        ,HaMain.CT_HAStartedMode
        ,HaMain.CT_HATelephonicFlg
        ,HaMain.CT_HADocumentConfigID
        ,HaMain.CT_HFitUserMpiNumber
        ,HaMain.CT_IsProfessionallyCollected
        ,HaMain.CT_CodeName
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserStarted
        ,HaMain.SurrogateKey_CMS_User
        ,HaMain.SurrogateKey_CMS_UserSettings
        ,HaMain.SurrogateKey_CMS_UserSite
        ,HaMain.SurrogateKey_CMS_Site
        ,HaMain.SurrogateKey_HFit_Account
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserModule
        ,HaMain.SurrogateKey_View_HFit_HACampaign_Joined
        ,HaMain.SurrogateKey_View_HFit_HealthAssessment_Joined
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserRiskArea
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserQuestion
        ,HaMain.SurrogateKey_View_EDW_HealthAssesmentQuestions
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserAnswers
        ,HaMain.HARiskCategory_ItemModifiedWhen
        ,HaMain.HAUserRiskArea_ItemModifiedWhen
        ,HaMain.HAUserQuestion_ItemModifiedWhen
        ,HaMain.HAUserAnswers_ItemModifiedWhen
        ,HaMain.LastModifiedDate
        ,HaMain.RowDataChanged
        ,HaMain.SVR
        ,HaMain.DBNAME, HaMain.SYS_CHANGE_OPERATION, HaMain.SYS_CHANGE_VERSION
   FROM
        view_EDW_HealthAssessment_MART_Pull_CMS1 AS HaMain -- WITH (NOEXPAND) 
             LEFT JOIN dbo.BASE_HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
             ON
          UserRiskAreaItemID = HAUserQuestionGroupResults.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestionGroupResults.SVR AND
          HAMAIN.DBNAME = HAUserQuestionGroupResults.DBNAME
             LEFT JOIN BASE_HFit_LKP_EDW_RejectMPI AS REJECT
             ON
          HAMAIN.HFitUserMpiNumber = REJECT.RejectMPICode
   WHERE REJECT.RejectMPICode IS NULL;
--WHERE
--HAMAIN.HFitUserMpiNumber NOT IN (
--SELECT
--       RejectMPICode
--FROM dbo.BASE_HFit_LKP_EDW_RejectMPI) ;

GO

/***********************************************************************************
************************************************************************************
use KenticoCMS_Datamart_2
go
SELECT 
       top 1000 *
FROM view_EDW_HealthAssessment_MART_CMS1
WHERE
       RowDataChanged > 0 AND LastModifiedDate  > '2016-03-09' 
************************************************************************************
***********************************************************************************/
GO
PRINT 'Created view_EDW_HealthAssessment_MART_Pull_CMS1';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_EDW_HealthAssessment_MART_Pull_CMS2.sql \n 
--------------------------------------------------------------- 

/****************************************************************************
select * from view_EDW_HealthAssessment_MART_CMS2
select * +-into DIM_EDW_HA_STATIC_DATA from view_EDW_HealthAssessment_MART_CMS2
****************************************************************************/
/*
select top 10 UserID from KenticoCMS_2.dbo.HFit_HealthAssesmentUserStarted order by UserID desc
	update KenticoCMS_2.dbo.HFit_HealthAssesmentUserStarted Set HAScore = HAScore+1 where UserID in
	(
193684
,193441
,193440
,193359
,193312
,193310
,193306
,193302
,193299
,193295)
*/
-- use KenticoCMS_Datamart_2
-- select * from view_EDW_HealthAssessment_MART_Pull_CMS2
-- select * from view_EDW_HealthAssessment_MART_Pull_CMS2
GO
PRINT 'Creating view_EDW_HealthAssessment_MART_Pull_CMS2';
GO
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_EDW_HealthAssessment_MART_Pull_CMS2') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessment_MART_Pull_CMS2
    END;

GO

/*********************************************************************************************************************************
    select top 100 hastartedmode from BASE_HFit_HealthAssesmentUserStarted where ItemID between 100 and 110
    update BASE_HFit_HealthAssesmentUserStarted -1 where ItemID between 100 and 110
    update BASE_HFit_HealthAssesmentUserStarted 3 where ItemID between 100 and 110

    select top 100 HATelephonicFlg from BASE_HFit_HealthAssesmentUserStarted where ItemID between 200 and 210
    update BASE_HFit_HealthAssesmentUserStarted set HATelephonicFlg = 1 where ItemID between  200 and 210
    update BASE_HFit_HealthAssesmentUserStarted set HATelephonicFlg = 0 where ItemID between  200 and 210

    update BASE_HFit_HealthAssesmentUserQuestion set IsProfessionallyCollected = 1 where ItemID in (15047,15048,15049,15050,15051)
    update BASE_HFit_HealthAssesmentUserQuestion set IsProfessionallyCollected = 0 where ItemID in (15047,15048,15049,15050,15051)

    select top 100 ItemID,CodeName from BASE_HFit_HealthAssesmentUserAnswers where ItemID in (15422,15423,15424)
    update BASE_HFit_HealthAssesmentUserAnswers set CodeName = 'Maybe' where ItemID  in (15422,15423,15424)
    update BASE_HFit_HealthAssesmentUserAnswers set CodeName = 'No' where ItemID  in (15422,15423,15424)

	select count(*) from view_EDW_HealthAssessment_MART_Pull_CMS2
*********************************************************************************************************************************/

--SET ROWCOUNT 100;
-- USE KenticoCMS_Datamart_2

CREATE VIEW view_EDW_HealthAssessment_MART_Pull_CMS2
AS
-- Use KenticoCMS_Datamart_2
SELECT
       HAUserStarted.ItemID AS UserStartedItemID
     ,VHAJ.NodeGUID AS HealthAssesmentUserStartedNodeGUID
     ,HAUserStarted.UserID
     ,CMSUser.UserGUID
     ,UserSettings.HFitUserMpiNumber
     ,CMSSite.SiteGUID
     ,ACCT.AccountID
     ,ACCT.AccountCD
     ,ACCT.AccountName
       --, CAST (HAUserStarted.HAStartedDt AS datetime) AS HAStartedDt
       --, CAST (HAUserStarted.HACompletedDt AS datetime) AS HACompletedDt
     ,
       HAUserStarted.HAStartedDt
     ,HAUserStarted.HACompletedDt
     ,HAUserModule.ItemID AS UserModuleItemId
     ,HAUserModule.CodeName AS UserModuleCodeName
     ,HAUserModule.HAModuleNodeGUID
     ,VHAJ.NodeGUID AS CMSNodeGuid
     ,NULL AS HAModuleVersionID
     ,HARiskCategory.ItemID AS UserRiskCategoryItemID
     ,HARiskCategory.CodeName AS UserRiskCategoryCodeName
     ,HARiskCategory.HARiskCategoryNodeGUID						--WDM 8/7/2014 as HARiskCategoryDocumentID
     ,
       NULL AS HARiskCategoryVersionID			--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserRiskArea.ItemID AS UserRiskAreaItemID
     ,HAUserRiskArea.CodeName AS UserRiskAreaCodeName
     ,HAUserRiskArea.HARiskAreaNodeGUID							--WDM 8/7/2014 as HARiskAreaDocumentID
     ,
       NULL AS HARiskAreaVersionID			--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserQuestion.ItemID AS UserQuestionItemID
       --, dbo.udf_StripHTML (HAQuestionsView.Title) AS Title			--WDM 47619 12.29.2014
     ,
       HAQuestionsView.Title
     ,HAUserQuestion.HAQuestionNodeGUID AS HAQuestionGuid		--WDM 9.2.2014	This is a repeat field but had to stay to match the previous view - this is the NODE GUID and matches to the definition file to get the question. This tells you the question, language agnostic.
     ,
       HAUserQuestion.CodeName AS UserQuestionCodeName
     ,NULL AS HAQuestionDocumentID	--WDM 10.1.2014 - this is GOING AWAY 		--WDM 10.02.2014 place holder for EDW ETL
     ,
       NULL AS HAQuestionVersionID			--WDM 10.1.2014 - this is GOING AWAY - no versions across environments 		--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserQuestion.HAQuestionNodeGUID		--WDM 10.01.2014	Left this in place to preserve column structure.		
     ,
       HAUserAnswers.ItemID AS UserAnswerItemID
     ,HAUserAnswers.HAAnswerNodeGUID								--WDM 8/7/2014 as HAAnswerDocumentID
     ,
       NULL AS HAAnswerVersionID		--WDM 10.1.2014 - this is GOING AWAY - no versions across environments		--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserAnswers.CodeName AS UserAnswerCodeName
     ,HAUserAnswers.HAAnswerValue
     ,HAUserModule.HAModuleScore
     ,HARiskCategory.HARiskCategoryScore
     ,HAUserRiskArea.HARiskAreaScore
     ,HAUserQuestion.HAQuestionScore
     ,HAUserAnswers.HAAnswerPoints
       --WDM , HAUserQuestionGroupResults.PointResults
     ,
       HAUserAnswers.UOMCode
     ,HAUserStarted.HAScore
     ,HAUserModule.PreWeightedScore AS ModulePreWeightedScore
     ,HARiskCategory.PreWeightedScore AS RiskCategoryPreWeightedScore
     ,HAUserRiskArea.PreWeightedScore AS RiskAreaPreWeightedScore
     ,HAUserQuestion.PreWeightedScore AS QuestionPreWeightedScore
       --WDM, HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName
     ,
       CASE
       WHEN
       HAUserAnswers.ItemCreatedWhen = HAUserAnswers.ItemModifiedWhen
           THEN 'I'
       ELSE 'U'
       END AS ChangeType
       --, CAST (HAUserAnswers.ItemCreatedWhen AS datetime) AS ItemCreatedWhen
       --, CAST (HAUserAnswers.ItemModifiedWhen AS datetime) AS ItemModifiedWhen
     ,
       HAUserAnswers.ItemCreatedWhen
     ,HAUserAnswers.ItemModifiedWhen
     ,HAUserQuestion.IsProfessionallyCollected
       --, CAST (HARiskCategory.ItemModifiedWhen AS datetime) AS HARiskCategory_ItemModifiedWhen
       --, CAST (HAUserRiskArea.ItemModifiedWhen AS datetime) AS HAUserRiskArea_ItemModifiedWhen
       --, CAST (HAUserQuestion.ItemModifiedWhen AS datetime) AS HAUserQuestion_ItemModifiedWhen
       --, CAST (HAUserAnswers.ItemModifiedWhen AS datetime) AS HAUserAnswers_ItemModifiedWhen
     ,
       HARiskCategory.ItemModifiedWhen AS HARiskCategory_ItemModifiedWhen
     ,HAUserRiskArea.ItemModifiedWhen AS HAUserRiskArea_ItemModifiedWhen
     ,HAUserQuestion.ItemModifiedWhen AS HAUserQuestion_ItemModifiedWhen
     ,HAUserAnswers.ItemModifiedWhen AS HAUserAnswers_ItemModifiedWhen
     ,HAUserStarted.HAPaperFlg
     ,HAUserStarted.HATelephonicFlg
     ,HAUserStarted.HAStartedMode		--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 
     ,
       HAUserStarted.HACompletedMode	--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 
     ,
       VHCJ.DocumentCulture AS DocumentCulture_VHCJ
     ,HAQuestionsView.DocumentCulture AS DocumentCulture_HAQuestionsView
     ,HAUserStarted.HACampaignNodeGUID AS CampaignNodeGUID
     ,CASE
      WHEN HAUserStarted.HADocumentConfigID IS NULL
          THEN 'SHORT_VER'
      WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
          THEN 'LONG_VER'
      ELSE 'UNKNOWN'
      END AS HealthAssessmentType
     ,HAUserStarted.CT_HAStartedMode
     ,HAUserStarted.CT_HATelephonicFlg
     ,HAUserStarted.CT_HADocumentConfigID
     ,UserSettings.CT_HFitUserMpiNumber
     ,HAUserQuestion.CT_IsProfessionallyCollected
     ,HAUserAnswers.CT_CodeName
     ,CASE
      WHEN
       HAUserStarted.CT_HAStartedMode = 1
          THEN 40
      WHEN
       HAUserStarted.CT_HATelephonicFlg = 1
          THEN 41
      WHEN
       HAUserAnswers.CT_ItemModifiedWhen = 1
          THEN 42
      WHEN
       HAUserQuestion.CT_ItemModifiedWhen = 1
          THEN 43
      WHEN
       HAUserRiskArea.CT_ItemModifiedWhen = 1
          THEN 44
      WHEN
       HAUserStarted.CT_HADocumentConfigID = 1
          THEN 52
      WHEN
       HAUserQuestion.CT_IsProfessionallyCollected = 1
          THEN 54
      WHEN
       HAUserAnswers.CT_ItemCreatedWhen = 1
          THEN 55
      WHEN
       HAUserAnswers.CT_ItemModifiedWhen = 1
          THEN 56
      WHEN
       HAUserModule.CT_PreWeightedScore = 1
          THEN 57
      --wdmWHEN
      --HAUserQuestionGroupResults.CT_PointResults = 1
      --THEN 50
      --wdmWHEN
      --HAUserQuestionGroupResults.CT_CodeName = 1
      --THEN 59
      WHEN
       HAUserQuestion.CT_PreWeightedScore = 1
          THEN 60
      WHEN
       HAUserRiskArea.CT_PreWeightedScore = 1
          THEN 61
      WHEN
       HARiskCategory.CT_PreWeightedScore = 1
          THEN 62
      WHEN
       CMSSite.CT_SiteGUID = 1
          THEN 63
      WHEN
       HAQuestionsView.CT_Title = 1
          THEN 64
      WHEN
       HAUserAnswers.CT_UOMCode = 1
          THEN 65
      WHEN
       HAUserAnswers.CT_CodeName = 1
          THEN 66
      ELSE 0
      END AS RowDataChanged
     ,HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted
     ,CMSUser.SurrogateKey_CMS_User
     ,UserSettings.SurrogateKey_CMS_UserSettings
     ,UserSite.SurrogateKey_CMS_UserSite
     ,CMSSite.SurrogateKey_CMS_Site
     ,ACCT.SurrogateKey_HFit_Account
     ,HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule
     ,VHCJ.SurrogateKey_View_HFit_HACampaign_Joined
     ,VHAJ.SurrogateKey_View_HFit_HealthAssessment_Joined
     ,HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
     ,HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea
     ,HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion
     ,HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions
       --wdm,HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults	  
     ,
       HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers
     ,HAUserStarted.DBNAME
     ,HAUserStarted.SVR
     ,HAUserStarted.LastModifiedDate AS HAUserStarted_LastModifiedDate
     ,CMSUser.LastModifiedDate AS CMSUser_LastModifiedDate
     ,UserSettings.LastModifiedDate AS UserSettings_LastModifiedDate
     ,UserSite.LastModifiedDate AS UserSite_LastModifiedDate
     ,ACCT.LastModifiedDate AS ACCT_LastModifiedDate
     ,HAUserModule.LastModifiedDate AS HAUserModule_LastModifiedDate
     ,HARiskCategory.LastModifiedDate AS HARiskCategory_LastModifiedDate
     ,HAUserRiskArea.LastModifiedDate AS HAUserRiskArea_LastModifiedDate
     ,HAUserQuestion.LastModifiedDate AS HAUserQuestion_LastModifiedDate
     ,HAUserAnswers.LastModifiedDate AS HAUserAnswers_LastModifiedDate
     ,CASE
      WHEN
       HAUserStarted.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserStarted.LastModifiedDate
      WHEN
       CMSUser.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       CMSUser.LastModifiedDate > UserSettings.LastModifiedDate AND
       CMSUser.LastModifiedDate > UserSite.LastModifiedDate AND
       CMSUser.LastModifiedDate > ACCT.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserModule.LastModifiedDate AND
       CMSUser.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN CMSUser.LastModifiedDate
      WHEN
       UserSettings.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       UserSettings.LastModifiedDate > CMSUser.LastModifiedDate AND
       UserSettings.LastModifiedDate > UserSite.LastModifiedDate AND
       UserSettings.LastModifiedDate > ACCT.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserModule.LastModifiedDate AND
       UserSettings.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN UserSettings.LastModifiedDate
      WHEN
       UserSite.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       UserSite.LastModifiedDate > CMSUser.LastModifiedDate AND
       UserSite.LastModifiedDate > UserSettings.LastModifiedDate AND
       UserSite.LastModifiedDate > ACCT.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserModule.LastModifiedDate AND
       UserSite.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN UserSite.LastModifiedDate
      WHEN
       ACCT.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       ACCT.LastModifiedDate > CMSUser.LastModifiedDate AND
       ACCT.LastModifiedDate > UserSettings.LastModifiedDate AND
       ACCT.LastModifiedDate > UserSite.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserModule.LastModifiedDate AND
       ACCT.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN ACCT.LastModifiedDate
      WHEN
       HAUserModule.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserModule.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserModule.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserModule.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserModule.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserModule.LastModifiedDate
      WHEN
       HARiskCategory.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > CMSUser.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > UserSettings.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > UserSite.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > ACCT.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserModule.LastModifiedDate
      WHEN
       HAUserRiskArea.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserRiskArea.LastModifiedDate
      WHEN
       HAUserQuestion.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserQuestion.LastModifiedDate
      WHEN
       HAUserAnswers.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HAUserQuestion.LastModifiedDate
          THEN HAUserAnswers.LastModifiedDate
      ELSE NULL
      END AS LastModifiedDate
     ,CT.SYS_CHANGE_OPERATION, CT.SYS_CHANGE_VERSION

/*********************************************************************************
use KenticoCMS_Datamart_2
SELECT *    
FROM
    CHANGETABLE(CHANGES KenticoCMS_2.dbo.HFit_HealthAssesmentUserStarted, 0) AS CT
*********************************************************************************/
FROM
     CHANGETABLE (CHANGES KenticoCMS_2.dbo.HFit_HealthAssesmentUserStarted, 0) AS CT
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserStarted AS HAUserStarted
          ON
       HAUserStarted.ItemID = CT.ItemID
	  and HAUserStarted.DBNAME = 'KenticoCMS_2'
          INNER JOIN dbo.BASE_CMS_User AS CMSUser
          ON
       HAUserStarted.UserID = CMSUser.UserID AND --HAUserStarted.SVR = CMSUser.SVR AND
       HAUserStarted.DBNAME = CMSUser.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserStarted , NULL) AS CT_HAUserStarted
     --ON
     --  HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted = CT_HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted
          INNER JOIN dbo.BASE_CMS_UserSettings AS UserSettings
          ON
       UserSettings.UserSettingsUserID = CMSUser.UserID AND --UserSettings.SVR = CMSUser.SVR AND
       UserSettings.DBNAME = CMSUser.DBNAME AND
       HFitUserMpiNumber >= 0 AND HFitUserMpiNumber IS NOT NULL -- (WDM) CR47516 
     --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_CMS_UserSettings , NULL) AS CTBL_UserSettings
     --ON
     --  UserSettings.SurrogateKey_CMS_UserSettings = CTBL_UserSettings.SurrogateKey_CMS_UserSettings
          INNER JOIN dbo.BASE_CMS_UserSite AS UserSite
          ON
       CMSUser.UserID = UserSite.UserID AND --CMSUser.SVR = UserSite.SVR AND
       CMSUser.DBNAME = UserSite.DBNAME
          INNER JOIN dbo.BASE_CMS_Site AS CMSSite
          ON
       UserSite.SiteID = CMSSite.SiteID AND --UserSite.SVR = CMSSite.SVR AND
       UserSite.DBNAME = CMSSite.DBNAME
          INNER JOIN dbo.BASE_HFit_Account AS ACCT
          ON
       ACCT.SiteID = CMSSite.SiteID AND --ACCT.svr = CMSSite.SVR AND
       ACCT.DBNAME = CMSSite.DBNAME
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserModule AS HAUserModule
          ON
       HAUserStarted.ItemID = HAUserModule.HAStartedItemID AND --HAUserStarted.SVR = HAUserModule.SVR AND
       HAUserStarted.DBNAME = HAUserModule.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserModule , NULL) AS CT_HAUserModule
     --ON
     --  HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule = HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule
          INNER JOIN dbo.BASE_View_HFit_HACampaign_Joined AS VHCJ
          ON
       VHCJ.NodeGUID = HAUserStarted.HACampaignNodeGUID AND --VHCJ.SVR = HAUserStarted.SVR AND
       VHCJ.DBNAME = HAUserStarted.DBNAME AND
       VHCJ.NodeSiteID = UserSite.SiteID AND
       VHCJ.DocumentCulture = 'en-US'
          INNER JOIN dbo.BASE_View_HFit_HealthAssessment_Joined AS VHAJ
          ON
       VHAJ.DocumentID = VHCJ.HealthAssessmentID AND --VHAJ.SVR = VHCJ.SVR AND
       VHAJ.DBNAME = VHCJ.DBNAME
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserRiskCategory AS HARiskCategory
          ON
       HAUserModule.ItemID = HARiskCategory.HAModuleItemID AND --HAUserModule.SVR = HARiskCategory.SVR AND
       HAUserModule.DBNAME = HARiskCategory.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskCategory , NULL) AS CTBL_HARiskCategory
     --ON
     --  HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory = CTBL_HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
          ON
       HARiskCategory.ItemID = HAUserRiskArea.HARiskCategoryItemID AND --HARiskCategory.SVR = HAUserRiskArea.SVR AND
       HARiskCategory.DBNAME = HAUserRiskArea.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea , NULL) AS CTBL_HAUserRiskArea
     --ON
     --  HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea = CTBL_HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserQuestion AS HAUserQuestion
          ON
       HAUserRiskArea.ItemID = HAUserQuestion.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestion.SVR AND
       HAUserRiskArea.DBNAME = HAUserQuestion.DBNAME --**********************
     --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestion , NULL) AS CTBL_HAUserQuestion
     --ON
     --  HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion = CTBL_HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion
          INNER JOIN dbo.BASE_View_EDW_HealthAssesmentQuestions AS HAQuestionsView
          ON
       HAUserQuestion.HAQuestionNodeGUID = HAQuestionsView.NodeGUID AND --HAUserQuestion.SVR = HAQuestionsView.SVR AND
       HAUserQuestion.DBNAME = HAQuestionsView.DBNAME AND
       HAQuestionsView.DocumentCulture = 'en-US' --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_View_EDW_HealthAssesmentQuestions , NULL) AS CTBL_HAQuestionsView
     --ON
     --  HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions = CTBL_HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions

     --wdmLEFT JOIN
     --dbo.BASE_HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
     --ON
     --  HAUserRiskArea.ItemID = HAUserQuestionGroupResults.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestionGroupResults.SVR AND
     --  HAUserRiskArea.DBNAME = HAUserQuestionGroupResults.DBNAME 

     --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestionGroupResults , NULL) AS CTBL_HAUserQuestionGroupResults
     --ON
     --  HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults = CTBL_HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserAnswers AS HAUserAnswers
          ON
       HAUserQuestion.ItemID = HAUserAnswers.HAQuestionItemID AND --HAUserQuestion.SVR = HAUserAnswers.SVR AND
       HAUserQuestion.DBNAME = HAUserAnswers.DBNAME;
--LEFT JOIN
--CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserAnswers , NULL) AS CTBL_HAUserAnswers
--ON
--  HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers = CTBL_HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers
--WDMWHERE
--UserSettings.HFitUserMpiNumber NOT IN (
--SELECT
--       RejectMPICode
--FROM  dbo.BASE_HFit_LKP_EDW_RejectMPI) ;

GO
-- use KenticoCMS_Datamart_2
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_EDW_HealthAssessment_MART_CMS2') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessment_MART_CMS2;
    END;
GO
CREATE VIEW view_EDW_HealthAssessment_MART_CMS2
AS SELECT
          HaMain.UserStartedItemID
        ,HaMain.UserID
        ,HaMain.UserGUID
        ,HaMain.HFitUserMpiNumber
        ,HaMain.SiteGUID
        ,HaMain.AccountID
        ,HaMain.AccountCD
        ,HaMain.AccountName
        ,HaMain.HAStartedDt
        ,HaMain.HACompletedDt
        ,HaMain.UserModuleItemId
        ,HaMain.UserModuleCodeName
        ,HaMain.HAModuleNodeGUID
        ,HaMain.CMSNodeGuid
        ,HaMain.HAModuleVersionID
        ,HaMain.UserRiskCategoryItemID
        ,HaMain.UserRiskCategoryCodeName
        ,HaMain.HARiskCategoryNodeGUID
        ,HaMain.HARiskCategoryVersionID
        ,HaMain.UserRiskAreaItemID
        ,HaMain.UserRiskAreaCodeName
        ,HaMain.HARiskAreaNodeGUID
        ,HaMain.HARiskAreaVersionID
        ,HaMain.UserQuestionItemID
        ,HaMain.Title
        ,HaMain.HAQuestionGuid
        ,HaMain.UserQuestionCodeName
        ,HaMain.HAQuestionDocumentID
        ,HaMain.HAQuestionVersionID
        ,HaMain.HAQuestionNodeGUID
        ,HaMain.UserAnswerItemID
        ,HaMain.HAAnswerNodeGUID
        ,HaMain.HAAnswerVersionID
        ,HaMain.UserAnswerCodeName
        ,HaMain.HAAnswerValue
        ,HaMain.HAModuleScore
        ,HaMain.HARiskCategoryScore
        ,HaMain.HARiskAreaScore
        ,HaMain.HAQuestionScore
        ,HaMain.HAAnswerPoints
        ,HaMain.UOMCode
        ,HaMain.HAScore
        ,HaMain.ModulePreWeightedScore
        ,HaMain.RiskCategoryPreWeightedScore
        ,HaMain.RiskAreaPreWeightedScore
        ,HaMain.QuestionPreWeightedScore
        ,HaMain.ChangeType
        ,HaMain.ItemCreatedWhen
        ,HaMain.ItemModifiedWhen
        ,HaMain.IsProfessionallyCollected
        ,HaMain.HAPaperFlg
        ,HaMain.HATelephonicFlg
        ,HaMain.HAStartedMode
        ,HaMain.HACompletedMode
        ,HaMain.DocumentCulture_VHCJ
        ,HaMain.DocumentCulture_HAQuestionsView
        ,HaMain.CampaignNodeGUID
        ,HaMain.HealthAssessmentType
        ,HaMain.HAUserStarted_LastModifiedDate
        ,HaMain.CMSUser_LastModifiedDate
        ,HaMain.UserSettings_LastModifiedDate
        ,HaMain.UserSite_LastModifiedDate
        ,HaMain.ACCT_LastModifiedDate
        ,HaMain.HAUserModule_LastModifiedDate
        ,HaMain.HARiskCategory_LastModifiedDate
        ,HaMain.HAUserRiskArea_LastModifiedDate
        ,HaMain.HAUserQuestion_LastModifiedDate
        ,HaMain.HAUserAnswers_LastModifiedDate
        ,HealthAssesmentUserStartedNodeGUID
        ,HAUserQuestionGroupResults.PointResults
        ,HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName
        ,HaMain.CT_HAStartedMode
        ,HaMain.CT_HATelephonicFlg
        ,HaMain.CT_HADocumentConfigID
        ,HaMain.CT_HFitUserMpiNumber
        ,HaMain.CT_IsProfessionallyCollected
        ,HaMain.CT_CodeName
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserStarted
        ,HaMain.SurrogateKey_CMS_User
        ,HaMain.SurrogateKey_CMS_UserSettings
        ,HaMain.SurrogateKey_CMS_UserSite
        ,HaMain.SurrogateKey_CMS_Site
        ,HaMain.SurrogateKey_HFit_Account
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserModule
        ,HaMain.SurrogateKey_View_HFit_HACampaign_Joined
        ,HaMain.SurrogateKey_View_HFit_HealthAssessment_Joined
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserRiskArea
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserQuestion
        ,HaMain.SurrogateKey_View_EDW_HealthAssesmentQuestions
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserAnswers
        ,HaMain.HARiskCategory_ItemModifiedWhen
        ,HaMain.HAUserRiskArea_ItemModifiedWhen
        ,HaMain.HAUserQuestion_ItemModifiedWhen
        ,HaMain.HAUserAnswers_ItemModifiedWhen
        ,HaMain.LastModifiedDate
        ,HaMain.RowDataChanged
        ,HaMain.SVR
        ,HaMain.DBNAME, HaMain.SYS_CHANGE_OPERATION, HaMain.SYS_CHANGE_VERSION
   FROM
        view_EDW_HealthAssessment_MART_Pull_CMS2 AS HaMain -- WITH (NOEXPAND) 
             LEFT JOIN dbo.BASE_HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
             ON
          UserRiskAreaItemID = HAUserQuestionGroupResults.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestionGroupResults.SVR AND
          HAMAIN.DBNAME = HAUserQuestionGroupResults.DBNAME
             LEFT JOIN BASE_HFit_LKP_EDW_RejectMPI AS REJECT
             ON
          HAMAIN.HFitUserMpiNumber = REJECT.RejectMPICode
   WHERE REJECT.RejectMPICode IS NULL;
--WHERE
--HAMAIN.HFitUserMpiNumber NOT IN (
--SELECT
--       RejectMPICode
--FROM dbo.BASE_HFit_LKP_EDW_RejectMPI) ;

GO

/***********************************************************************************
************************************************************************************
use KenticoCMS_Datamart_2
go
SELECT 
       top 1000 *
FROM view_EDW_HealthAssessment_MART_CMS2
WHERE
       RowDataChanged > 0 AND LastModifiedDate  > '2016-03-09' 
************************************************************************************
***********************************************************************************/

GO
PRINT 'Created view_EDW_HealthAssessment_MART_Pull_CMS2';
GO




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_EDW_HealthAssessment_MART_Pull_CMS3.sql \n 
--------------------------------------------------------------- 

/******************************************************************************
select count(*) from view_EDW_HealthAssessment_MART_CMS3
select * from view_EDW_HealthAssessment_MART_CMS3
select * +-into DIM_EDW_HA_STATIC_DATA from view_EDW_HealthAssessment_MART_CMS3
******************************************************************************/
/*********************************************************************************
use KenticoCMS_Datamart_2
SELECT *    
FROM
    CHANGETABLE(CHANGES KenticoCMS_3.dbo.HFit_HealthAssesmentUserStarted, 0) AS CT
*********************************************************************************/
/***********************************************************************************************
 select distinct top 20 UserID from KenticoCMS_3.dbo.HFit_HealthAssesmentUserStarted order by UserID desc
	update KenticoCMS_3.dbo.HFit_HealthAssesmentUserStarted Set HAScore = HAScore+1 where UserID in
    (
    434403
    ,434365
    ,434352
    ,434350
    ,434343
    ,434335
    ,434323
    ,434321
    ,434317
    ,434290
    ,65
    ,66
    ,67
    ,63892
    ,63893
    ,63916
    ,63918
    ,128391
    ,128393
    ,128410)
***********************************************************************************************/

-- use KenticoCMS_Datamart_2
-- select top 10 * from view_EDW_HealthAssessment_MART_Pull_CMS3
-- select * from view_EDW_HealthAssessment_MART_Pull_CMS3
GO
PRINT 'Processing view_EDW_HealthAssessment_MART_Pull_CMS3';
GO
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_EDW_HealthAssessment_MART_Pull_CMS3') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessment_MART_Pull_CMS3;
    END;

GO

/*********************************************************************************************************************************
    select top 100 hastartedmode from BASE_HFit_HealthAssesmentUserStarted where ItemID between 100 and 110
    update BASE_HFit_HealthAssesmentUserStarted -1 where ItemID between 100 and 110
    update BASE_HFit_HealthAssesmentUserStarted 3 where ItemID between 100 and 110

    select top 100 HATelephonicFlg from BASE_HFit_HealthAssesmentUserStarted where ItemID between 200 and 210
    update BASE_HFit_HealthAssesmentUserStarted set HATelephonicFlg = 1 where ItemID between  200 and 210
    update BASE_HFit_HealthAssesmentUserStarted set HATelephonicFlg = 0 where ItemID between  200 and 210

    update BASE_HFit_HealthAssesmentUserQuestion set IsProfessionallyCollected = 1 where ItemID in (15047,15048,15049,15050,15051)
    update BASE_HFit_HealthAssesmentUserQuestion set IsProfessionallyCollected = 0 where ItemID in (15047,15048,15049,15050,15051)

    select top 100 ItemID,CodeName from BASE_HFit_HealthAssesmentUserAnswers where ItemID in (15422,15423,15424)
    update BASE_HFit_HealthAssesmentUserAnswers set CodeName = 'Maybe' where ItemID  in (15422,15423,15424)
    update BASE_HFit_HealthAssesmentUserAnswers set CodeName = 'No' where ItemID  in (15422,15423,15424)

	select count(*) from view_EDW_HealthAssessment_MART_Pull_CMS3
*********************************************************************************************************************************/

--SET ROWCOUNT 100;
-- USE KenticoCMS_Datamart_2
go
CREATE VIEW view_EDW_HealthAssessment_MART_Pull_CMS3
AS
-- Use KenticoCMS_Datamart_2
SELECT
       HAUserStarted.ItemID AS UserStartedItemID
     ,VHAJ.NodeGUID AS HealthAssesmentUserStartedNodeGUID
     ,HAUserStarted.UserID
     ,CMSUser.UserGUID
     ,UserSettings.HFitUserMpiNumber
     ,CMSSite.SiteGUID
     ,ACCT.AccountID
     ,ACCT.AccountCD
     ,ACCT.AccountName
       --, CAST (HAUserStarted.HAStartedDt AS datetime) AS HAStartedDt
       --, CAST (HAUserStarted.HACompletedDt AS datetime) AS HACompletedDt
     ,
       HAUserStarted.HAStartedDt
     ,HAUserStarted.HACompletedDt
     ,HAUserModule.ItemID AS UserModuleItemId
     ,HAUserModule.CodeName AS UserModuleCodeName
     ,HAUserModule.HAModuleNodeGUID
     ,VHAJ.NodeGUID AS CMSNodeGuid
     ,NULL AS HAModuleVersionID
     ,HARiskCategory.ItemID AS UserRiskCategoryItemID
     ,HARiskCategory.CodeName AS UserRiskCategoryCodeName
     ,HARiskCategory.HARiskCategoryNodeGUID						--WDM 8/7/2014 as HARiskCategoryDocumentID
     ,
       NULL AS HARiskCategoryVersionID			--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserRiskArea.ItemID AS UserRiskAreaItemID
     ,HAUserRiskArea.CodeName AS UserRiskAreaCodeName
     ,HAUserRiskArea.HARiskAreaNodeGUID							--WDM 8/7/2014 as HARiskAreaDocumentID
     ,
       NULL AS HARiskAreaVersionID			--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserQuestion.ItemID AS UserQuestionItemID
       --, dbo.udf_StripHTML (HAQuestionsView.Title) AS Title			--WDM 47619 12.29.2014
     ,
       HAQuestionsView.Title
     ,HAUserQuestion.HAQuestionNodeGUID AS HAQuestionGuid		--WDM 9.2.2014	This is a repeat field but had to stay to match the previous view - this is the NODE GUID and matches to the definition file to get the question. This tells you the question, language agnostic.
     ,
       HAUserQuestion.CodeName AS UserQuestionCodeName
     ,NULL AS HAQuestionDocumentID	--WDM 10.1.2014 - this is GOING AWAY 		--WDM 10.02.2014 place holder for EDW ETL
     ,
       NULL AS HAQuestionVersionID			--WDM 10.1.2014 - this is GOING AWAY - no versions across environments 		--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserQuestion.HAQuestionNodeGUID		--WDM 10.01.2014	Left this in place to preserve column structure.		
     ,
       HAUserAnswers.ItemID AS UserAnswerItemID
     ,HAUserAnswers.HAAnswerNodeGUID								--WDM 8/7/2014 as HAAnswerDocumentID
     ,
       NULL AS HAAnswerVersionID		--WDM 10.1.2014 - this is GOING AWAY - no versions across environments		--WDM 10.02.2014 place holder for EDW ETL
     ,
       HAUserAnswers.CodeName AS UserAnswerCodeName
     ,HAUserAnswers.HAAnswerValue
     ,HAUserModule.HAModuleScore
     ,HARiskCategory.HARiskCategoryScore
     ,HAUserRiskArea.HARiskAreaScore
     ,HAUserQuestion.HAQuestionScore
     ,HAUserAnswers.HAAnswerPoints
       --WDM , HAUserQuestionGroupResults.PointResults
     ,
       HAUserAnswers.UOMCode
     ,HAUserStarted.HAScore
     ,HAUserModule.PreWeightedScore AS ModulePreWeightedScore
     ,HARiskCategory.PreWeightedScore AS RiskCategoryPreWeightedScore
     ,HAUserRiskArea.PreWeightedScore AS RiskAreaPreWeightedScore
     ,HAUserQuestion.PreWeightedScore AS QuestionPreWeightedScore
       --WDM, HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName
     ,
       CASE
       WHEN
       HAUserAnswers.ItemCreatedWhen = HAUserAnswers.ItemModifiedWhen
           THEN 'I'
       ELSE 'U'
       END AS ChangeType
       --, CAST (HAUserAnswers.ItemCreatedWhen AS datetime) AS ItemCreatedWhen
       --, CAST (HAUserAnswers.ItemModifiedWhen AS datetime) AS ItemModifiedWhen
     ,
       HAUserAnswers.ItemCreatedWhen
     ,HAUserAnswers.ItemModifiedWhen
     ,HAUserQuestion.IsProfessionallyCollected
       --, CAST (HARiskCategory.ItemModifiedWhen AS datetime) AS HARiskCategory_ItemModifiedWhen
       --, CAST (HAUserRiskArea.ItemModifiedWhen AS datetime) AS HAUserRiskArea_ItemModifiedWhen
       --, CAST (HAUserQuestion.ItemModifiedWhen AS datetime) AS HAUserQuestion_ItemModifiedWhen
       --, CAST (HAUserAnswers.ItemModifiedWhen AS datetime) AS HAUserAnswers_ItemModifiedWhen
     ,
       HARiskCategory.ItemModifiedWhen AS HARiskCategory_ItemModifiedWhen
     ,HAUserRiskArea.ItemModifiedWhen AS HAUserRiskArea_ItemModifiedWhen
     ,HAUserQuestion.ItemModifiedWhen AS HAUserQuestion_ItemModifiedWhen
     ,HAUserAnswers.ItemModifiedWhen AS HAUserAnswers_ItemModifiedWhen
     ,HAUserStarted.HAPaperFlg
     ,HAUserStarted.HATelephonicFlg
     ,HAUserStarted.HAStartedMode		--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 
     ,
       HAUserStarted.HACompletedMode	--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 
     ,
       VHCJ.DocumentCulture AS DocumentCulture_VHCJ
     ,HAQuestionsView.DocumentCulture AS DocumentCulture_HAQuestionsView
     ,HAUserStarted.HACampaignNodeGUID AS CampaignNodeGUID
     ,CASE
      WHEN HAUserStarted.HADocumentConfigID IS NULL
          THEN 'SHORT_VER'
      WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
          THEN 'LONG_VER'
      ELSE 'UNKNOWN'
      END AS HealthAssessmentType
     ,HAUserStarted.CT_HAStartedMode
     ,HAUserStarted.CT_HATelephonicFlg
     ,HAUserStarted.CT_HADocumentConfigID
     ,UserSettings.CT_HFitUserMpiNumber
     ,HAUserQuestion.CT_IsProfessionallyCollected
     ,HAUserAnswers.CT_CodeName
     ,CASE
      WHEN
       HAUserStarted.CT_HAStartedMode = 1
          THEN 40
      WHEN
       HAUserStarted.CT_HATelephonicFlg = 1
          THEN 41
      WHEN
       HAUserAnswers.CT_ItemModifiedWhen = 1
          THEN 42
      WHEN
       HAUserQuestion.CT_ItemModifiedWhen = 1
          THEN 43
      WHEN
       HAUserRiskArea.CT_ItemModifiedWhen = 1
          THEN 44
      WHEN
       HAUserStarted.CT_HADocumentConfigID = 1
          THEN 52
      WHEN
       HAUserQuestion.CT_IsProfessionallyCollected = 1
          THEN 54
      WHEN
       HAUserAnswers.CT_ItemCreatedWhen = 1
          THEN 55
      WHEN
       HAUserAnswers.CT_ItemModifiedWhen = 1
          THEN 56
      WHEN
       HAUserModule.CT_PreWeightedScore = 1
          THEN 57
      --wdmWHEN
      --HAUserQuestionGroupResults.CT_PointResults = 1
      --THEN 50
      --wdmWHEN
      --HAUserQuestionGroupResults.CT_CodeName = 1
      --THEN 59
      WHEN
       HAUserQuestion.CT_PreWeightedScore = 1
          THEN 60
      WHEN
       HAUserRiskArea.CT_PreWeightedScore = 1
          THEN 61
      WHEN
       HARiskCategory.CT_PreWeightedScore = 1
          THEN 62
      WHEN
       CMSSite.CT_SiteGUID = 1
          THEN 63
      WHEN
       HAQuestionsView.CT_Title = 1
          THEN 64
      WHEN
       HAUserAnswers.CT_UOMCode = 1
          THEN 65
      WHEN
       HAUserAnswers.CT_CodeName = 1
          THEN 66
      ELSE 0
      END AS RowDataChanged
     ,HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted
     ,CMSUser.SurrogateKey_CMS_User
     ,UserSettings.SurrogateKey_CMS_UserSettings
     ,UserSite.SurrogateKey_CMS_UserSite
     ,CMSSite.SurrogateKey_CMS_Site
     ,ACCT.SurrogateKey_HFit_Account
     ,HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule
     ,VHCJ.SurrogateKey_View_HFit_HACampaign_Joined
     ,VHAJ.SurrogateKey_View_HFit_HealthAssessment_Joined
     ,HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
     ,HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea
     ,HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion
     ,HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions
       --wdm,HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults	  
     ,
       HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers
     ,HAUserStarted.DBNAME
     ,HAUserStarted.SVR
     ,HAUserStarted.LastModifiedDate AS HAUserStarted_LastModifiedDate
     ,CMSUser.LastModifiedDate AS CMSUser_LastModifiedDate
     ,UserSettings.LastModifiedDate AS UserSettings_LastModifiedDate
     ,UserSite.LastModifiedDate AS UserSite_LastModifiedDate
     ,ACCT.LastModifiedDate AS ACCT_LastModifiedDate
     ,HAUserModule.LastModifiedDate AS HAUserModule_LastModifiedDate
     ,HARiskCategory.LastModifiedDate AS HARiskCategory_LastModifiedDate
     ,HAUserRiskArea.LastModifiedDate AS HAUserRiskArea_LastModifiedDate
     ,HAUserQuestion.LastModifiedDate AS HAUserQuestion_LastModifiedDate
     ,HAUserAnswers.LastModifiedDate AS HAUserAnswers_LastModifiedDate
     ,CASE
      WHEN
       HAUserStarted.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HAUserStarted.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserStarted.LastModifiedDate
      WHEN
       CMSUser.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       CMSUser.LastModifiedDate > UserSettings.LastModifiedDate AND
       CMSUser.LastModifiedDate > UserSite.LastModifiedDate AND
       CMSUser.LastModifiedDate > ACCT.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserModule.LastModifiedDate AND
       CMSUser.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       CMSUser.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN CMSUser.LastModifiedDate
      WHEN
       UserSettings.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       UserSettings.LastModifiedDate > CMSUser.LastModifiedDate AND
       UserSettings.LastModifiedDate > UserSite.LastModifiedDate AND
       UserSettings.LastModifiedDate > ACCT.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserModule.LastModifiedDate AND
       UserSettings.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       UserSettings.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN UserSettings.LastModifiedDate
      WHEN
       UserSite.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       UserSite.LastModifiedDate > CMSUser.LastModifiedDate AND
       UserSite.LastModifiedDate > UserSettings.LastModifiedDate AND
       UserSite.LastModifiedDate > ACCT.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserModule.LastModifiedDate AND
       UserSite.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       UserSite.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN UserSite.LastModifiedDate
      WHEN
       ACCT.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       ACCT.LastModifiedDate > CMSUser.LastModifiedDate AND
       ACCT.LastModifiedDate > UserSettings.LastModifiedDate AND
       ACCT.LastModifiedDate > UserSite.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserModule.LastModifiedDate AND
       ACCT.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       ACCT.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN ACCT.LastModifiedDate
      WHEN
       HAUserModule.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserModule.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserModule.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserModule.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserModule.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HAUserModule.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserModule.LastModifiedDate
      WHEN
       HARiskCategory.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > CMSUser.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > UserSettings.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > UserSite.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > ACCT.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HARiskCategory.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserModule.LastModifiedDate
      WHEN
       HAUserRiskArea.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserQuestion.LastModifiedDate AND
       HAUserRiskArea.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserRiskArea.LastModifiedDate
      WHEN
       HAUserQuestion.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserQuestion.LastModifiedDate > HAUserAnswers.LastModifiedDate
          THEN HAUserQuestion.LastModifiedDate
      WHEN
       HAUserAnswers.LastModifiedDate > HAUserStarted.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > CMSUser.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > UserSettings.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > UserSite.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > ACCT.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HAUserModule.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HARiskCategory.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HAUserRiskArea.LastModifiedDate AND
       HAUserAnswers.LastModifiedDate > HAUserQuestion.LastModifiedDate
          THEN HAUserAnswers.LastModifiedDate
      ELSE NULL
      END AS LastModifiedDate
     ,CT.SYS_CHANGE_OPERATION, CT.SYS_CHANGE_VERSION
FROM
     CHANGETABLE (CHANGES KenticoCMS_3.dbo.HFit_HealthAssesmentUserStarted, null) AS CT
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserStarted AS HAUserStarted
          ON
       HAUserStarted.ItemID = CT.ItemID
	  and HAUserStarted.DBNAME = 'KenticoCMS_3'
          INNER JOIN dbo.BASE_CMS_User AS CMSUser
          ON
       HAUserStarted.UserID = CMSUser.UserID AND --HAUserStarted.SVR = CMSUser.SVR AND
       HAUserStarted.DBNAME = CMSUser.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserStarted , NULL) AS CT_HAUserStarted
     --ON
     --  HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted = CT_HAUserStarted.SurrogateKey_HFit_HealthAssesmentUserStarted
          INNER JOIN dbo.BASE_CMS_UserSettings AS UserSettings
          ON
       UserSettings.UserSettingsUserID = CMSUser.UserID AND --UserSettings.SVR = CMSUser.SVR AND
       UserSettings.DBNAME = CMSUser.DBNAME AND
       HFitUserMpiNumber >= 0 AND HFitUserMpiNumber IS NOT NULL -- (WDM) CR47516 
     --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_CMS_UserSettings , NULL) AS CTBL_UserSettings
     --ON
     --  UserSettings.SurrogateKey_CMS_UserSettings = CTBL_UserSettings.SurrogateKey_CMS_UserSettings
          INNER JOIN dbo.BASE_CMS_UserSite AS UserSite
          ON
       CMSUser.UserID = UserSite.UserID AND --CMSUser.SVR = UserSite.SVR AND
       CMSUser.DBNAME = UserSite.DBNAME
          INNER JOIN dbo.BASE_CMS_Site AS CMSSite
          ON
       UserSite.SiteID = CMSSite.SiteID AND --UserSite.SVR = CMSSite.SVR AND
       UserSite.DBNAME = CMSSite.DBNAME
          INNER JOIN dbo.BASE_HFit_Account AS ACCT
          ON
       ACCT.SiteID = CMSSite.SiteID AND --ACCT.svr = CMSSite.SVR AND
       ACCT.DBNAME = CMSSite.DBNAME
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserModule AS HAUserModule
          ON
       HAUserStarted.ItemID = HAUserModule.HAStartedItemID AND --HAUserStarted.SVR = HAUserModule.SVR AND
       HAUserStarted.DBNAME = HAUserModule.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserModule , NULL) AS CT_HAUserModule
     --ON
     --  HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule = HAUserModule.SurrogateKey_HFit_HealthAssesmentUserModule
          INNER JOIN dbo.BASE_View_HFit_HACampaign_Joined AS VHCJ
          ON
       VHCJ.NodeGUID = HAUserStarted.HACampaignNodeGUID AND --VHCJ.SVR = HAUserStarted.SVR AND
       VHCJ.DBNAME = HAUserStarted.DBNAME AND
       VHCJ.NodeSiteID = UserSite.SiteID AND
       VHCJ.DocumentCulture = 'en-US'
          INNER JOIN dbo.BASE_View_HFit_HealthAssessment_Joined AS VHAJ
          ON
       VHAJ.DocumentID = VHCJ.HealthAssessmentID AND --VHAJ.SVR = VHCJ.SVR AND
       VHAJ.DBNAME = VHCJ.DBNAME
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserRiskCategory AS HARiskCategory
          ON
       HAUserModule.ItemID = HARiskCategory.HAModuleItemID AND --HAUserModule.SVR = HARiskCategory.SVR AND
       HAUserModule.DBNAME = HARiskCategory.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskCategory , NULL) AS CTBL_HARiskCategory
     --ON
     --  HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory = CTBL_HARiskCategory.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
          ON
       HARiskCategory.ItemID = HAUserRiskArea.HARiskCategoryItemID AND --HARiskCategory.SVR = HAUserRiskArea.SVR AND
       HARiskCategory.DBNAME = HAUserRiskArea.DBNAME --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserRiskArea , NULL) AS CTBL_HAUserRiskArea
     --ON
     --  HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea = CTBL_HAUserRiskArea.SurrogateKey_HFit_HealthAssesmentUserRiskArea
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserQuestion AS HAUserQuestion
          ON
       HAUserRiskArea.ItemID = HAUserQuestion.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestion.SVR AND
       HAUserRiskArea.DBNAME = HAUserQuestion.DBNAME --**********************
     --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestion , NULL) AS CTBL_HAUserQuestion
     --ON
     --  HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion = CTBL_HAUserQuestion.SurrogateKey_HFit_HealthAssesmentUserQuestion
          INNER JOIN dbo.BASE_View_EDW_HealthAssesmentQuestions AS HAQuestionsView
          ON
       HAUserQuestion.HAQuestionNodeGUID = HAQuestionsView.NodeGUID AND --HAUserQuestion.SVR = HAQuestionsView.SVR AND
       HAUserQuestion.DBNAME = HAQuestionsView.DBNAME AND
       HAQuestionsView.DocumentCulture = 'en-US' --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_View_EDW_HealthAssesmentQuestions , NULL) AS CTBL_HAQuestionsView
     --ON
     --  HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions = CTBL_HAQuestionsView.SurrogateKey_View_EDW_HealthAssesmentQuestions

     --wdmLEFT JOIN
     --dbo.BASE_HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
     --ON
     --  HAUserRiskArea.ItemID = HAUserQuestionGroupResults.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestionGroupResults.SVR AND
     --  HAUserRiskArea.DBNAME = HAUserQuestionGroupResults.DBNAME 

     --LEFT JOIN
     --CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserQuestionGroupResults , NULL) AS CTBL_HAUserQuestionGroupResults
     --ON
     --  HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults = CTBL_HAUserQuestionGroupResults.SurrogateKey_HFit_HealthAssesmentUserQuestionGroupResults
          INNER JOIN dbo.BASE_HFit_HealthAssesmentUserAnswers AS HAUserAnswers
          ON
       HAUserQuestion.ItemID = HAUserAnswers.HAQuestionItemID AND --HAUserQuestion.SVR = HAUserAnswers.SVR AND
       HAUserQuestion.DBNAME = HAUserAnswers.DBNAME;
--LEFT JOIN
--CHANGETABLE (CHANGES BASE_HFit_HealthAssesmentUserAnswers , NULL) AS CTBL_HAUserAnswers
--ON
--  HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers = CTBL_HAUserAnswers.SurrogateKey_HFit_HealthAssesmentUserAnswers
--WDMWHERE
--UserSettings.HFitUserMpiNumber NOT IN (
--SELECT
--       RejectMPICode
--FROM  dbo.BASE_HFit_LKP_EDW_RejectMPI) ;

GO
-- use KenticoCMS_Datamart_2
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_EDW_HealthAssessment_MART_CMS3') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessment_MART_CMS3;
    END;
GO
CREATE VIEW view_EDW_HealthAssessment_MART_CMS3
AS SELECT
          HaMain.UserStartedItemID
        ,HaMain.UserID
        ,HaMain.UserGUID
        ,HaMain.HFitUserMpiNumber
        ,HaMain.SiteGUID
        ,HaMain.AccountID
        ,HaMain.AccountCD
        ,HaMain.AccountName
        ,HaMain.HAStartedDt
        ,HaMain.HACompletedDt
        ,HaMain.UserModuleItemId
        ,HaMain.UserModuleCodeName
        ,HaMain.HAModuleNodeGUID
        ,HaMain.CMSNodeGuid
        ,HaMain.HAModuleVersionID
        ,HaMain.UserRiskCategoryItemID
        ,HaMain.UserRiskCategoryCodeName
        ,HaMain.HARiskCategoryNodeGUID
        ,HaMain.HARiskCategoryVersionID
        ,HaMain.UserRiskAreaItemID
        ,HaMain.UserRiskAreaCodeName
        ,HaMain.HARiskAreaNodeGUID
        ,HaMain.HARiskAreaVersionID
        ,HaMain.UserQuestionItemID
        ,HaMain.Title
        ,HaMain.HAQuestionGuid
        ,HaMain.UserQuestionCodeName
        ,HaMain.HAQuestionDocumentID
        ,HaMain.HAQuestionVersionID
        ,HaMain.HAQuestionNodeGUID
        ,HaMain.UserAnswerItemID
        ,HaMain.HAAnswerNodeGUID
        ,HaMain.HAAnswerVersionID
        ,HaMain.UserAnswerCodeName
        ,HaMain.HAAnswerValue
        ,HaMain.HAModuleScore
        ,HaMain.HARiskCategoryScore
        ,HaMain.HARiskAreaScore
        ,HaMain.HAQuestionScore
        ,HaMain.HAAnswerPoints
        ,HaMain.UOMCode
        ,HaMain.HAScore
        ,HaMain.ModulePreWeightedScore
        ,HaMain.RiskCategoryPreWeightedScore
        ,HaMain.RiskAreaPreWeightedScore
        ,HaMain.QuestionPreWeightedScore
        ,HaMain.ChangeType
        ,HaMain.ItemCreatedWhen
        ,HaMain.ItemModifiedWhen
        ,HaMain.IsProfessionallyCollected
        ,HaMain.HAPaperFlg
        ,HaMain.HATelephonicFlg
        ,HaMain.HAStartedMode
        ,HaMain.HACompletedMode
        ,HaMain.DocumentCulture_VHCJ
        ,HaMain.DocumentCulture_HAQuestionsView
        ,HaMain.CampaignNodeGUID
        ,HaMain.HealthAssessmentType
        ,HaMain.HAUserStarted_LastModifiedDate
        ,HaMain.CMSUser_LastModifiedDate
        ,HaMain.UserSettings_LastModifiedDate
        ,HaMain.UserSite_LastModifiedDate
        ,HaMain.ACCT_LastModifiedDate
        ,HaMain.HAUserModule_LastModifiedDate
        ,HaMain.HARiskCategory_LastModifiedDate
        ,HaMain.HAUserRiskArea_LastModifiedDate
        ,HaMain.HAUserQuestion_LastModifiedDate
        ,HaMain.HAUserAnswers_LastModifiedDate
        ,HealthAssesmentUserStartedNodeGUID
        ,HAUserQuestionGroupResults.PointResults
        ,HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName
        ,HaMain.CT_HAStartedMode
        ,HaMain.CT_HATelephonicFlg
        ,HaMain.CT_HADocumentConfigID
        ,HaMain.CT_HFitUserMpiNumber
        ,HaMain.CT_IsProfessionallyCollected
        ,HaMain.CT_CodeName
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserStarted
        ,HaMain.SurrogateKey_CMS_User
        ,HaMain.SurrogateKey_CMS_UserSettings
        ,HaMain.SurrogateKey_CMS_UserSite
        ,HaMain.SurrogateKey_CMS_Site
        ,HaMain.SurrogateKey_HFit_Account
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserModule
        ,HaMain.SurrogateKey_View_HFit_HACampaign_Joined
        ,HaMain.SurrogateKey_View_HFit_HealthAssessment_Joined
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserRiskCategory
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserRiskArea
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserQuestion
        ,HaMain.SurrogateKey_View_EDW_HealthAssesmentQuestions
        ,HaMain.SurrogateKey_HFit_HealthAssesmentUserAnswers
        ,HaMain.HARiskCategory_ItemModifiedWhen
        ,HaMain.HAUserRiskArea_ItemModifiedWhen
        ,HaMain.HAUserQuestion_ItemModifiedWhen
        ,HaMain.HAUserAnswers_ItemModifiedWhen
        ,HaMain.LastModifiedDate
        ,HaMain.RowDataChanged
        ,HaMain.SVR
        ,HaMain.DBNAME, HaMain.SYS_CHANGE_OPERATION, HaMain.SYS_CHANGE_VERSION
   FROM
        view_EDW_HealthAssessment_MART_Pull_CMS3 AS HaMain -- WITH (NOEXPAND) 
             LEFT JOIN dbo.BASE_HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
             ON
          UserRiskAreaItemID = HAUserQuestionGroupResults.HARiskAreaItemID AND --HAUserRiskArea.SVR = HAUserQuestionGroupResults.SVR AND
          HAMAIN.DBNAME = HAUserQuestionGroupResults.DBNAME
             LEFT JOIN BASE_HFit_LKP_EDW_RejectMPI AS REJECT
             ON
          HAMAIN.HFitUserMpiNumber = REJECT.RejectMPICode
   WHERE REJECT.RejectMPICode IS NULL;
--WHERE
--HAMAIN.HFitUserMpiNumber NOT IN (
--SELECT
--       RejectMPICode
--FROM dbo.BASE_HFit_LKP_EDW_RejectMPI) ;

GO

/***********************************************************************************
************************************************************************************
use KenticoCMS_Datamart_2
go
SELECT 
       top 1000 *
FROM view_EDW_HealthAssessment_MART_CMS3
WHERE
       RowDataChanged > 0 AND LastModifiedDate  > '2016-03-09' 
************************************************************************************
***********************************************************************************/

GO
PRINT 'Created view_EDW_HealthAssessment_MART_Pull_CMS3';
GO