<html lang="en">
<head>
<META content="text/html; charset=utf-8" http-equiv=Content-Type>
<META name="Generator" content="Visustin">
<META name="description" content="T-SQL flow chart saved by Aivosto Visustin (www.aivosto.com).">
<META name="keywords" content="T-SQL, flow graph, diagram">

<title>T-SQL flow chart: proc_genPullChangesProc.sql</title>

<style type="text/css">
<!--
BODY      { margin: 0; }
TEXTAREA  { background: #ffffcc; font-size: 8pt; }
A:link, A:visited { color: blue; }
TR.bar    { background: white; font-family: Verdana, Arial, Sans-Serif; font-size: 70%; }
TR TD     { padding: 0; background: white; }
TR.bar TD { padding: 2px 5px 2px 5px; background: #ccccff; }
-->
</style>

<script type="text/javascript">
<!--
function hidecode(id) { 
  if (id.style.display=="none") {
    id.style.display="";
    hidelink.innerHTML="Hide code";
  } else {
    id.style.display="none";
    hidelink.innerHTML="Show code";
  }
}
-->
</script>
</head>


<body scroll=no>

<table width="100%" height="100%" cellspacing="0" cellpadding="0" border="0">

<tr height="100%"><td id="#upper" colspan="2">
 <iframe name="pic" width="100%" height="100%" src="proc_genPullChangesProc4.png" frameborder="0" title="T-SQL flow chart: proc_genPullChangesProc.sql">
  <a href="proc_genPullChangesProc4.png"><img src="proc_genPullChangesProc4.png" height="100%" title="T-SQL flow chart: proc_genPullChangesProc.sql"></a>
 </iframe>
</td></tr>

<tr id="sourcecode"><td colspan="2">
<textarea rows=15 readonly=yes style="width:100%; border-width:0;">


-- use KenticoCMS_DataMart_2
GO
PRINT 'Creating proc_genPullChangesProc';
GO
IF EXISTS ( SELECT
             name
       FROM sys.procedures
       WHERE
             name = 'proc_genPullChangesProc')
 BEGIN
    DROP PROCEDURE
        proc_genPullChangesProc;
 END;
GO

/*---------------------------------------------------------------------------------------------------------------
--Execute to REGEN everything on all BASE tables.
select 'exec proc_genPullChangesProc "KenticoCMS_1", "'+replace(table_name,'BASE_','')+'", 0 ' + char(10) + 'GO'
from information_schema.tables
where table_name like 'base_%'
and table_name not like '%_del'
and table_name not like '%HIST'
and table_name not like '%_Joined'
and table_name not like '%_View%'
union
select 'exec proc_genPullChangesProc "KenticoCMS_2", "'+replace(table_name,'BASE_','')+'", 0 '  + char(10) + 'GO'
from information_schema.tables
where table_name like 'base_%'
and table_name not like '%_del'
and table_name not like '%HIST'
and table_name not like '%_Joined'
and table_name not like '%_View%'
union
select 'exec proc_genPullChangesProc "KenticoCMS_3", "'+replace(table_name,'BASE_','')+'", 0 '  + char(10) + 'GO'
from information_schema.tables
where table_name like 'base_%'
and table_name not like '%_del'
and table_name not like '%HIST'
and table_name not like '%_Joined'
and table_name not like '%_View%'
*/

/*-----------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------
--------------------------------------------------------------------

EXEC proc_CreateBaseTable @InstanceName = "KenticoCMS_1" , @TblName = "HFit_HealthAssesmentUserStarted" , @SkipIfExists = 1 , @AddTableDefaults = "NO"

use KenticoCMS_DataMart_2

exec proc_genPullChangesProc 'KenticoCMS_1', 'HFit_HealthAssesmentUserStarted', 1
exec proc_genPullChangesProc 'KenticoCMS_2', 'HFit_HealthAssesmentUserStarted', 1
exec proc_genPullChangesProc 'KenticoCMS_3', 'HFit_HealthAssesmentUserStarted', 1

exec proc_genPullChangesProc 'KenticoCMS_3', 'CMS_Site', 0
exec proc_genPullChangesProc 'KenticoCMS_1', 'CMS_User' , 0
exec proc_genPullChangesProc 'KenticoCMS_1', 'CMS_Document',  1
exec proc_genPullChangesProc 'KenticoCMS_2', 'cms_usersettings'
*/

/*-----------------------------------------------------
*******************************************************
INSERT INTO TestTable (FirstName, LastName)
SELECT FirstName, LastName
FROM Person.Contact
*******************************************************
*/

/*--------------------------------------------------------------------------
----------------------------------------------------------------------------
declare @DDL as nvarchar (max) = ''
exec proc_genPullChangesProc 'KenticoCMS_1', 'HFIT_Account', 1
exec proc_genPullChangesProc 'KenticoCMS_2', 'HFIT_Account', 1
*/

CREATE PROCEDURE proc_genPullChangesProc (
   @InstanceName AS NVARCHAR (250)
  , @TblName AS NVARCHAR (250)
  , @DeBug AS INTEGER = 0
  , @GenProcOnlyDoNotPullData AS BIT = 0)
AS
BEGIN
 DECLARE
     @Msg NVARCHAR (MAX)
   , @BaseTable NVARCHAR (500) ;

 SET @BaseTable = 'BASE_' + @TblName;

 SET NOCOUNT ON;

 EXEC proc_ChangeTracking  @InstanceName , @TblName , 1;

/*------------------------------------------------------------------------------
********************************************************************************
Author:   W. Dale Miller
Date:     11.12.2015
Copyright:  DMA, Ltd.
Purpose:          Generates a select into statement from a table or view. This method
            is used when table is already created in the database earlier and
            data is to be inserted into this table from another table.
Last Test:  11.12.2015 WDM
********************************************************************************
*/

 --drop table #FTCols
 --declare @InstanceName AS nvarchar(250) = 'KenticoCMS_1' ;
 --declare @TblName AS nvarchar (250) = 'cms_usersettings' ;
 --declare @DeBug as integer = 1

 BEGIN TRY
    CLOSE PCursor;
    DEALLOCATE PCursor;
 END TRY
 BEGIN CATCH
    PRINT ' ';
 END CATCH;
 BEGIN TRY
    CLOSE TCursor;
    DEALLOCATE TCursor;
 END TRY
 BEGIN CATCH
    PRINT ' ';
 END CATCH;
 BEGIN TRY
    CLOSE ZCursor;
    DEALLOCATE ZCursor;
 END TRY
 BEGIN CATCH
    PRINT ' ';

 END CATCH;
 IF OBJECT_ID ('tempdb..#FTCols') IS NOT NULL
    BEGIN DROP TABLE
             #FTCols;
    END;
 DECLARE
     @CreateAllJobs AS INT = 0
   , @Interval AS INT = -1
   , @FQN AS NVARCHAR (1000) = @InstanceName + '.dbo.' + @TblName
   , @BaseTblName AS NVARCHAR ( 250) = 'BASE_' + @TblName
   , @last_sync_version AS BIGINT = 0
   , @mysql AS NVARCHAR ( MAX) = ''
   , @FromClause AS NVARCHAR (MAX) = ''
   , @FactTableCOLS AS NVARCHAR (MAX) = ''
   , @BaseTableCOLS AS NVARCHAR (MAX) = ''
   , @BaseTableColsNoPK AS NVARCHAR (MAX) = ''
   , @ReturnedCols AS NVARCHAR (MAX) = NULL
   , @VersionTrackingTabl AS NVARCHAR (100) = 'BASE_' + @TblName + '_CTVerHIST '
   , @iCnt AS BIGINT = 0
   , @MySql2 AS NVARCHAR (MAX) = '';

 SET @MySql = 'select max(SYS_CHANGE_VERSION) from ' + @VersionTrackingTabl;

 DECLARE
     @result TABLE (
                LastVerNo BIGINT) ;
 INSERT INTO @result (
      LastVerNo)
 EXEC (@MySql) ;
 SET @last_sync_version = (SELECT TOP (1)
                            LastVerNo
                       FROM @result) ;
 IF @last_sync_version IS NULL
    BEGIN
       SET @last_sync_version = 0;
    END;

 DECLARE
     @PrimaryKeyCols AS TABLE
     (
                           column_name NVARCHAR (100)
     );

 DECLARE
     @TgtTbl AS NVARCHAR (100) = '';
 DECLARE
     @S AS NVARCHAR (MAX) = '';

 SET @TgtTbl = @InstanceName + '.INFORMATION_SCHEMA.KEY_COLUMN_USAGE';

 SET @S = ' SELECT column_name ' + CHAR (10) ;
 SET @S = @S + ' FROM ' + @InstanceName + '.INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS TC ' + CHAR (10) ;
 SET @S = @S + ' INNER JOIN ' + CHAR (10) ;
 SET @S = @S + '     ' + @TgtTbl + ' AS KU ' + CHAR (10) ;
 SET @S = @S + ' ON TC.CONSTRAINT_TYPE = ''PRIMARY KEY'' AND ' + CHAR (10) ;
 SET @S = @S + ' TC.CONSTRAINT_NAME = KU.CONSTRAINT_NAME ' + CHAR (10) ;
 SET @S = @S + ' and ku.table_name=''' + @TblName + '''' + CHAR (10) ;
 SET @S = @S + ' ORDER BY KU.TABLE_NAME, KU.ORDINAL_POSITION; ' + CHAR (10) ;

 INSERT INTO @PrimaryKeyCols
 EXEC (@S) ;

 DECLARE
     @CTKeys AS NVARCHAR (MAX) = ''
   , @CTEPkeys AS NVARCHAR (MAX) = ''
   , @strPkeys AS NVARCHAR (MAX) = ''
   , @ON_Clause AS NVARCHAR (MAX) = ''
   , @iCols  AS INTEGER = 0;

 SET @iCols = (SELECT
                  COUNT (*)
            FROM @PrimaryKeyCols) ;
 IF @iCols = 0
    BEGIN
       SET @ON_Clause = '';
       PRINT 'NO PK COLS FOUND';
    END;
 IF @iCols &gt; 0
    BEGIN
       --print 'YEA PK COLS FOUND';
       DECLARE
           @Pkey AS NVARCHAR (100) = ''
         , @MyPK AS NVARCHAR (MAX) = ''
         , @II AS INTEGER = 0;

       DECLARE PCursor CURSOR
          FOR
              SELECT
                    column_name
              FROM @PrimaryKeyCols;
       OPEN PCursor;
       FETCH NEXT FROM PCursor INTO @Pkey;

       SET @ON_Clause = ' ON ';

       WHILE
             @@FETCH_STATUS = 0
          BEGIN
              SET @II = @II + 1;
              IF @II &lt; @iCols
                 BEGIN
                     SET @ON_Clause = @ON_Clause + ' FT.' + @Pkey + ' = CT.' + @Pkey + ' AND ' + CHAR (10) ;
                     SET @strPkeys = @strPkeys + @Pkey + ',';
                     SET @CTEPkeys = @CTEPkeys + 'S.' + @Pkey + ' = ' + 'T.' + @Pkey + ' AND ' + CHAR (10) ;
                     SET @CTKeys = @CTKeys + 'CT.' + @Pkey + ' , ';
                 END;
              ELSE
                 BEGIN
                     SET @ON_Clause = @ON_Clause + ' FT.' + @Pkey + ' = CT.' + @Pkey + ' ' + CHAR (10) ;
                     SET @strPkeys = @strPkeys + @Pkey;
                     SET @CTEPkeys = @CTEPkeys + 'S.' + @Pkey + ' = ' + 'T.' + @Pkey + CHAR (10) ;
                     SET @CTKeys = @CTKeys + 'CT.' + @Pkey + CHAR (10) ;
                 END;
              FETCH NEXT FROM PCursor INTO @Pkey;
          END;

       CLOSE PCursor;
       DEALLOCATE PCursor;
    END;

 DECLARE
     @TblKeys AS NVARCHAR (2000) = '';
 DECLARE
     @PK AS NVARCHAR (2000) = NULL;
 EXEC @TblKeys = procGetTablePK @InstanceName , @TblName , @PK OUT;
 SET @TblKeys = @PK;

 --**************************** EXEC *********************************************************
 EXEC @BaseTableCOLS = proc_GetTableColumnsCT @InstanceName , @TblName , @ReturnedCols OUT;
 --**************************** EXEC *********************************************************
 SET @BaseTableCOLS = @ReturnedCols;
 --print '@BaseTableCOLS: ' + @BaseTableCOLS ;

 SET @FactTableCOLS = @BaseTableCOLS;
 --print @FactTableCOLS ;

 SELECT
      *
 INTO
     #FTCols
 FROM dbo.udfSplitString (@FactTableCOLS) ;

 SET @BaseTableCOLS = '';
 SET @iCols = (SELECT
                  COUNT (*)
            FROM #FTCols) ;

 --print 'YEA PK COLS FOUND';
 DECLARE
     @tCol AS NVARCHAR (100) = '';
 DECLARE
     @TPX AS NVARCHAR (MAX) = '';
 SET  @II = 0;
 DECLARE TCursor CURSOR
    FOR
       SELECT
             strValue
       FROM #FTCols;
 OPEN TCursor;
 FETCH NEXT FROM TCursor INTO @tCol;
 WHILE
      @@FETCH_STATUS = 0
    BEGIN

       SET @tCol = (SELECT
                         REPLACE (@tCol , CHAR (10) , '')) ;
       SET @II = @II + 1;
       IF @II &lt; @iCols
          BEGIN
              SELECT
                    @BaseTableCOLS = @BaseTableCOLS + '   FT.' + @tCol + ',' + CHAR (10) ;
          END;
       ELSE
          BEGIN
              SELECT
                    @BaseTableCOLS = @BaseTableCOLS + '   FT.' + @tCol + CHAR (10) ;
          END;
       FETCH NEXT FROM TCursor INTO @tCol;
    END;

 CLOSE TCursor;
 DEALLOCATE TCursor;

 SET @FactTableCOLS = @FactTableCOLS + ', SYS_CHANGE_VERSION , LASTMODIFIEDDATE, HashCode, SVR, DBNAME ';
 SET @BaseTableCOLS = @BaseTableCOLS + ', CT.SYS_CHANGE_VERSION ' + CHAR (10) ;
 SET @BaseTableCOLS = @BaseTableCOLS + ', getdate() as LASTMODIFIEDDATE ' + CHAR (10) ;
 SET @BaseTableCOLS = @BaseTableCOLS + ', NULL as HashCode ' + CHAR (10) ;
 SET @BaseTableCOLS = @BaseTableCOLS + ', @@servername AS SVR ' + CHAR (10) ;
 SET @BaseTableCOLS = @BaseTableCOLS + ', ''' + @InstanceName + ''' AS DBNAME ' + CHAR (10) ;

 SET @FromClause = @FromClause + 'FROM CHANGETABLE (CHANGES ' + @FQN + ', ' + CAST (@last_sync_version AS NVARCHAR (50)) + ') AS CT ' + CHAR (10) ;
 SET @FromClause = @FromClause + '    right OUTER JOIN ' + @FQN + ' AS FT ' + CHAR (10) ;
 SET @FromClause = @FromClause + '      ' + @ON_Clause + CHAR (10) ;
 SET @FromClause = @FromClause + 'where SYS_CHANGE_OPERATION = ''I'' ' + CHAR (10) ;
 SET @FromClause = @FromClause + 'order by CT.SYS_CHANGE_VERSION desc ' + CHAR (10) ;

 --**************************** CREATE INSERT *********************************************************
 DECLARE
     @ProcName AS NVARCHAR (250) = 'proc_' + @BaseTblName + '_' + @InstanceName + '_Insert';
 --****************************************************************************************************
 IF
      CHARINDEX ('_1_' , @ProcName) &gt; 0
    BEGIN
       SET @Interval = 1;
    END;
 IF
      CHARINDEX ('_2_' , @ProcName) &gt; 0
    BEGIN
       SET @Interval = 2;
    END;
 IF
      CHARINDEX ('_3_' , @ProcName) &gt; 0
    BEGIN
       SET @Interval = 3;
    END;

 IF NOT EXISTS (SELECT
                   column_name
             FROM information_schema.columns
             WHERE
                   table_name = @BaseTblName AND
                   column_name = 'CT_RowDataUpdated')
    BEGIN
       SET @mysql = 'Alter table ' + @BaseTblName + ' add CT_RowDataUpdated bit null default 1';
    END;
 EXEC mart_AddMissingColumnsFromSvrTable  @PullFromInstanceName = @InstanceName , @BaseTableName = @BaseTable , @PullTableName = @TblName;

 --**************************** CREATE INSERT PROC *********************************************************
 SET @mysql = '';
 SET @mysql = @mysql + 'create procedure ' + @ProcName + ' (@VersionNbr bigint = null) ' + CHAR ( 10) ;
 SET @mysql = @mysql + 'as ' + CHAR ( 10) ;
 SET @mysql = @mysql + 'Begin ' + CHAR ( 10) ;
 SET @mysql = @mysql + '-- Generated on: ' + CAST (GETDATE () AS NVARCHAR (50)) + CHAR (10) ;
 SET @mysql = @mysql + 'INSERT INTO ' + @BaseTblName + CHAR ( 10) ;
 SET @mysql = @mysql + '(' + CHAR ( 10) ;
 SET @mysql = @mysql + @FactTableCOLS + CHAR ( 10) + '    ,CT_RowDataUpdated ';
 SET @mysql = @mysql + ')' + CHAR ( 10) ;
 SET @mysql = @mysql + 'SELECT' + CHAR ( 10) ;
 SET @mysql = @mysql + @BaseTableCOLS;
 SET @mysql = @mysql + '       , 1         --CT_RowDataUpdated' + CHAR ( 10) ;
 SET @mysql = @mysql + @FromClause + CHAR ( 10) ;
 SET @mysql = @mysql + 'declare @TotRecs as int = @@ROWCOUNT ; ' + CHAR ( 10) ;
 SET @mysql = @mysql + 'print ''RETURNED COUNT: '' + cast(@TotRecs  as nvarchar(50)) ; ' + CHAR ( 10) ;
 SET @mysql = @mysql + 'return @TotRecs ;' + CHAR ( 10) ;
 SET @mysql = @mysql + 'End ; ' + CHAR ( 10) ;

 IF @DeBug = 1
    BEGIN
       PRINT CAST (@mysql AS NTEXT) ;
    END;

 SET  @ProcName = 'proc_' + @BaseTblName + '_' + @InstanceName + '_Insert';
 IF NOT EXISTS (SELECT
                   name
             FROM sys.procedures
             WHERE name = @ProcName)
    BEGIN
       PRINT 'CREATING INSERT PROCEDURE: ' + @ProcName + CHAR (10) ;
       EXEC (@MySql) ;
       PRINT 'CREATED INSERT PROCEDURE: ' + @ProcName;
    END;
 ELSE
    BEGIN
       PRINT '1 - PROCEDURE: ' + @ProcName + ' ALREADY EXISTS, dropping and recreating.';
       SET @MySql2 = 'drop procedure ' + @ProcName;
       EXEC (@MySql2) ;
       EXEC (@MySql) ;
       PRINT 'RE-CREATED PROCEDURE: ' + @ProcName;
    END;

 IF
      @CreateAllJobs = 1
    BEGIN
       EXEC proc_GenJobBaseTableSync @Interval , @ProcName;
       PRINT 'Created JOB : ' + 'JOB_' + @ProcName;
    END;
 SET @mysql = '';

/*-----------------------------------------------------------
declare @DDL as nvarchar (max) = ''
exec proc_genPullChangesProc 'KenticoCMS_2', 'CMS_Site', @DDL
*/

 SET @ON_Clause = (SELECT
                      REPLACE (@ON_Clause , 'FT.' , 'BT.')) ;
 SET @CTKeys = (SELECT
                   REPLACE (@CTKeys , 'BT.' , 'FT.')) ;

 IF NOT EXISTS (SELECT
                   column_name
             FROM information_schema.columns
             WHERE
                   table_name = @BaseTblName AND
                   column_name = 'CT_RowDataUpdated')
    BEGIN
       SET @mysql = 'Alter table ' + @BaseTblName + ' add CT_RowDataUpdated bit null default 1 ';
    END;

 --**************************** CREATE DELETE PROC *********************************************************
 SET @mysql = '';
 SET  @ProcName = 'proc_' + @BaseTblName + '_' + @InstanceName + '_Delete';
 SET @mysql = @mysql + 'CREATE PROCEDURE ' + @ProcName + ' (@VersionNbr bigint = null) ' + CHAR (10) ;
 SET @mysql = @mysql + 'AS ' + CHAR (10) ;
 SET @mysql = @mysql + 'BEGIN ' + CHAR (10) ;
 SET @mysql = @mysql + ' ' + CHAR (10) ;
 SET @mysql = @mysql + '    WITH CTE ( ' + CHAR (10) ;
 SET @mysql = @mysql + '         ' + @strPkeys + CHAR (10) ;
 SET @mysql = @mysql + '    )  ' + CHAR (10) ;
 SET @mysql = @mysql + '        AS ( ' + CHAR (10) ;
 SET @mysql = @mysql + '        SELECT ' + CHAR (10) ;
 SET @mysql = @mysql + '         ' + @CTKeys + CHAR (10) ;
 SET @mysql = @mysql + '               FROM ' + CHAR (10) ;
 SET @mysql = @mysql + '                   CHANGETABLE (CHANGES ' + @FQN + ', @VersionNbr) AS CT ' + CHAR (10) ;
 SET @mysql = @mysql + '                       RIGHT OUTER JOIN ' + @FQN + ' AS BT ' + CHAR (10) ;
 SET @mysql = @mysql + '                          ' + @ON_Clause + ' ';
 SET @mysql = @mysql + '               WHERE SYS_CHANGE_OPERATION = ''D'' ' + CHAR (10) ;
 SET @mysql = @mysql + '        )  ' + CHAR (10) ;
 SET @mysql = @mysql + '        DELETE FT ' + CHAR (10) ;
 SET @mysql = @mysql + '               FROM ' + @BaseTblName + ' FT ' + CHAR (10) ;
 SET @mysql = @mysql + '                        INNER JOIN CTE CT ' + CHAR (10) ;
 SET @ON_Clause = (SELECT
                      REPLACE (@ON_Clause , 'BT.' , 'FT.')) ;
 SET @mysql = @mysql + '                          ' + @ON_Clause + ' ';
 SET @mysql = @mysql + 'declare @TotRecs as int = @@ROWCOUNT ; ' + CHAR ( 10) ;
 SET @mysql = @mysql + 'print ''RETURNED COUNT: '' + cast(@TotRecs  as nvarchar(50)) ; ' + CHAR ( 10) ;
 SET @mysql = @mysql + 'return @TotRecs ;' + CHAR ( 10) ;
 SET @mysql = @mysql + 'END; ' + CHAR (10) ;

 --PRINT '@@CTKeys:' + @CTKeys ;
 --PRINT 'DELETE Procedure:' ;
 --select @mysql ;

 IF @DeBug = 1
    BEGIN
       PRINT @mysql;
    END;

 IF NOT EXISTS (SELECT
                   name
             FROM sys.procedures
             WHERE name = @ProcName)
    BEGIN
       PRINT '2 - CREATING PROCEDURE: ' + @ProcName;
       EXEC (@MySql) ;
       PRINT 'Created Procedure: ' + @ProcName;
    END;
 ELSE
    BEGIN
       PRINT '2 - PROCEDURE: ' + @ProcName + ' ALREADY EXISTS, dropping and recreating.';
       SET @MySql2 = 'drop procedure ' + @ProcName;
       EXEC (@MySql2) ;
       EXEC (@MySql) ;
       PRINT 'RE-Created Procedure: ' + @ProcName;
    END;
 IF
      @CreateAllJobs = 1
    BEGIN
       EXEC proc_GenJobBaseTableSync @Interval , @ProcName;
       PRINT 'Created JOB : ' + 'JOB_' + @ProcName;
    END;
 SET @mysql = '';

 --********************************************************************************************************
 SET @II = 0;
 DECLARE
     @X AS INTEGER = -1
   , @X2 AS INTEGER = -1
   , @XTableCOLS AS NVARCHAR (MAX) = '';

 DECLARE ZCursor CURSOR
    FOR
       SELECT
             strValue
       FROM #FTCols;
 OPEN ZCursor;
 FETCH NEXT FROM ZCursor INTO @tCol;
 WHILE
      @@FETCH_STATUS = 0
    BEGIN

       SET @tCol = (SELECT
                         REPLACE (@tCol , CHAR (10) , '')) ;
       SET @II = @II + 1;
       IF @II &lt; @iCols
          BEGIN
              EXEC @X = dbo.proc_IsColPrimaryKey @InstanceName , @TblName , @tCol;
              EXEC @X2 = dbo.proc_IsColIdentity @InstanceName , @TblName , @tCol;
              IF @X = 0 AND @X2 = 0
                 BEGIN
                     SET @XTableCOLS = @XTableCOLS + '   S.' + @tCol + ' = T.' + @tCol + ',' + CHAR (10) ;
                 END;
          END;
       ELSE
          BEGIN
              EXEC @X = proc_IsColPrimaryKey @InstanceName , @TblName , @tCol;
              IF @X = 0
                 BEGIN
                     SET @XTableCOLS = @XTableCOLS + '   S.' + @tCol + ' = T.' + @tCol + ' ' + CHAR (10) ;
                 END;
          END;
       FETCH NEXT FROM ZCursor INTO @tCol;
    END;

 CLOSE ZCursor;
 DEALLOCATE ZCursor;

 --**********************************CREATE UPDATE PROC ****************************************************
 SET @ProcName = 'proc_' + + @BaseTblName + '_' + @InstanceName + '_Update';
 IF NOT EXISTS (SELECT
                   name
             FROM sys.procedures
             WHERE name = @ProcName)
    BEGIN
       PRINT 'CREATING PROCEDURE: ' + @ProcName;
    END;
 ELSE
    BEGIN
       PRINT '3 - PROCEDURE: ' + @ProcName + ' ALREADY EXISTS, dropping and recreating.';
       SET @MySql = 'Drop Procedure ' + @ProcName;
       EXEC (@MySql) ;
    END;

 -- USE KenticoCMS_Datamart_2
 --********************************** GENERATE CT REQUIRED OBJECTS *************************************
 DECLARE
     @ViewObjVars VARCHAR (MAX)
   , @r  VARCHAR (MAX) ;

 EXEC mart_GenViewObjVars @InstanceName , @TblName , @r OUTPUT;
 SET @ViewObjVars = (SELECT
                        @r) ;
 --print '@ViewObjVars: ' + @ViewObjVars ;

 DECLARE
     @ObjCaseStmts VARCHAR (MAX) ;
 EXEC mart_GenViewObjCaseStmts @InstanceName , @TblName , @r OUTPUT;
 SET @ObjCaseStmts = (SELECT
                         @r) ;
 SET @Msg = '@ObjCaseStmts: ' + @ObjCaseStmts;
 EXEC PrintImmediate @msg;

 --**********************************CREATE UPDATE PROC ****************************************************
 SET @mysql = '';
 SET @mysql = @mysql + ' CREATE PROCEDURE ' + @ProcName + ' (@VersionNbr bigint = null) ' + CHAR (10) ;
 SET @mysql = @mysql + ' AS ' + CHAR (10) ;
 SET @mysql = @mysql + ' BEGIN ' + CHAR (10) ;
 --****************************************************************
 DECLARE
     @VarDcls VARCHAR (MAX) ;
 EXEC mart_GenColObjVarDcls @InstanceName , @TblName , @r OUTPUT;
 SET @VarDcls = (SELECT
                    @r) ;
 SET @mysql = @mysql + @VarDcls + CHAR (10) + CHAR (10) ;
 --****************************************************************
 DECLARE
     @VarSetStmts VARCHAR (MAX) ;
 EXEC mart_GenPopulateObjVarSetStmts @InstanceName , @TblName , @r OUTPUT;
 SET @VarSetStmts = (SELECT
                        @r) ;
 SET @mysql = @mysql + @VarSetStmts + CHAR (10) + CHAR (10) ;
 --****************************************************************

 SET @mysql = @mysql + '     WITH CTE ( ' + CHAR (10) ;
 SET @mysql = @mysql + '         ' + @strPkeys + CHAR (10) ;
 SET @mysql = @mysql + '         ,SYS_CHANGE_VERSION' + CHAR (10) ;
 SET @mysql = @mysql + '         ,SYS_CHANGE_COLUMNS' + CHAR (10) ;
 SET @mysql = @mysql + '        )  ' + CHAR (10) ;
 SET @mysql = @mysql + '         AS ( SELECT ' + CHAR (10) ;
 SET @mysql = @mysql + '                     ' + @strPkeys + CHAR (10) ;
 SET @mysql = @mysql + '                     ,SYS_CHANGE_VERSION' + CHAR (10) ;
 SET @mysql = @mysql + '                     ,SYS_CHANGE_COLUMNS' + CHAR (10) ;
 SET @mysql = @mysql + '                     FROM CHANGETABLE (CHANGES ' + @FQN + ', @VersionNbr) AS CT ' + CHAR (10) ;
 SET @mysql = @mysql + '                     WHERE SYS_CHANGE_OPERATION = ''U'')  ' + CHAR (10) ;
 SET @mysql = @mysql + '         UPDATE S ' + CHAR (10) ;
 SET @mysql = @mysql + '                SET ' + CHAR (10) ;
 SET @mysql = @mysql + '     ' + @XTableCOLS + CHAR (10) ;
 SET @mysql = @mysql + '                  ,S.LastModifiedDate = GETDATE ()  ' + CHAR (10) ;
 SET @mysql = @mysql + '                  ,S.SYS_CHANGE_VERSION = CTE.SYS_CHANGE_VERSION ' + CHAR (10) ;
 --********************************************************************************************************
 SET @mysql = @mysql + @ViewObjVars;
 --SET @mysql = @mysql + @VarSetStmts;
 SET @mysql = @mysql + @ObjCaseStmts;
 SET @mysql = @mysql + CHAR (10) ;
 --********************************************************************************************************
 SET @mysql = @mysql + '                    FROM ' + @FQN + ' AS T ' + CHAR (10) ;
 SET @mysql = @mysql + '                             JOIN ' + CHAR (10) ;
 SET @mysql = @mysql + '                             ' + @BaseTblName + ' AS S ' + CHAR (10) ;
 SET @mysql = @mysql + '                                 ON ' + CHAR (10) ;
 --SET @mysql = @mysql + '                                 S.UserSiteID = T.UserSiteID ' + CHAR (10) ;
 SET @mysql = @mysql + '                                 ' + @CTEPkeys + CHAR (10) ;
 SET @mysql = @mysql + '                             JOIN CTE ' + CHAR (10) ;

 SET @CTEPkeys = REPLACE (@CTEPkeys , 'S.' , 'CTE.') ;

 SET @mysql = @mysql + '                                 ON ' + @CTEPkeys + CHAR (10) ;
 SET @mysql = @mysql + 'declare @TotRecs as int = @@ROWCOUNT ; ' + CHAR ( 10) ;
 SET @mysql = @mysql + 'print ''RETURNED COUNT: '' + cast(@TotRecs  as nvarchar(50)) ; ' + CHAR ( 10) ;
 SET @mysql = @mysql + 'return @TotRecs ;' + CHAR ( 10) ;
 SET @mysql = @mysql + 'END ' + CHAR (10) ;

 IF @DeBug = 1
    BEGIN
       PRINT '************************************* BEGIN UPDATE PROC ******************************';
       SELECT
             @mysql;
       PRINT '************************************* END UPDATE PROC ******************************';
    END;

 EXEC (@mysql) ;
 SET @Msg = 'CREATED Procedure: ' + @ProcName;
 EXEC PrintImmediate @msg;

 IF
      @CreateAllJobs = 1
    BEGIN
       EXEC proc_GenJobBaseTableSync @Interval , @ProcName;
       SET @Msg = 'Created JOB : ' + 'JOB_' + @ProcName;
       EXEC PrintImmediate @msg;
    END;

 --******************************************************************************
 SET @MySql = '';
 SET @ProcName = 'proc_' + + @BaseTblName + '_' + @InstanceName + + '_SYNC';
 SET @BaseTableCOLS = (SELECT
                          REPLACE (@BaseTableCOLS , 'CT.SYS_CHANGE_VERSION' , '0 as SYS_CHANGE_VERSION')) ;

 SET @MySql = @MySql + 'CREATE PROCEDURE ' + @ProcName + ' (@VersionNbr bigint = null, @ReloadAll int = 0) ' + CHAR (10) ;
 SET @MySql = @MySql + 'AS ' + CHAR (10) ;
 SET @MySql = @MySql + 'BEGIN ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;

 SET @MySql = @MySql + '    DECLARE @Action AS NVARCHAR(10) = NULL; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @NbrRecs AS bigint = 0; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @RowGuid AS nvarchar (100) = CAST (NEWID () AS nvarchar (50)) ; ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''N''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, ''' + @InstanceName + ''', ''' + @TblName + '''' + ', @NbrRecs, ''' + @ProcName + '''; ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @MySql = @MySql + '    --************************************************************************************* ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''IS''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, ''' + @InstanceName + ''', ''' + @TblName + '''' + ', @NbrRecs, ''' + @ProcName + '''; ' + CHAR (10) ;

 SET @MySql = @MySql + '    -- ' + CHAR (10) ;
 SET @MySql = @MySql + '        if @ReloadAll = 1 ' + CHAR (10) ;
 SET @MySql = @MySql + '        begin' + CHAR (10) ;
 SET @MySql = @MySql + '             delete from ' + @BaseTblName + ' where DBNAME = ''' + @InstanceName + ''' ; ' + CHAR (10) ;
 SET @MySql = @MySql + '        end ;' + CHAR (10) ;

 --SET @mysql = @mysql + '    SET IDENTITY_INSERT ' + @BaseTblName + ' ON ;' + CHAR ( 10) ;

 SET @MySql = @MySql + '    WITH CTE_NEW ( ' + CHAR (10) ;
 SET @mysql = @mysql + '         ' + @strPkeys + CHAR (10) ;
 SET @MySql = @MySql + '         )  ' + CHAR (10) ;
 SET @MySql = @MySql + '        AS ( ' + CHAR (10) ;
 SET @MySql = @MySql + '        SELECT ' + CHAR (10) ;
 SET @mysql = @mysql + '         ' + @strPkeys + CHAR (10) ;
 SET @MySql = @MySql + '               FROM ' + @FQN + CHAR (10) ;
 SET @MySql = @MySql + '        EXCEPT ' + CHAR (10) ;
 SET @MySql = @MySql + '        SELECT ' + CHAR (10) ;
 SET @mysql = @mysql + '         ' + @strPkeys + CHAR (10) ;
 SET @MySql = @MySql + '                      FROM ' + @BaseTblName + CHAR (10) ;
 SET @MySql = @MySql + '                      Where DBNAME = ''' + @InstanceName + '''' + CHAR (10) ;
 SET @MySql = @MySql + '        )  ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @mysql = @mysql + 'INSERT INTO ' + @BaseTblName + CHAR ( 10) ;
 SET @mysql = @mysql + '(' + CHAR ( 10) ;
 SET @mysql = @mysql + @FactTableCOLS + CHAR ( 10) ;
 SET @mysql = @mysql + ')' + CHAR ( 10) ;
 SET @mysql = @mysql + 'SELECT' + CHAR ( 10) ;
 SET @mysql = @mysql + @BaseTableCOLS + CHAR ( 10) ;
 SET @MySql = @MySql + '               FROM ' + CHAR (10) ;
 SET @MySql = @MySql + '                   ' + @InstanceName + '.dbo.' + @TblName + ' AS FT ' + CHAR (10) ;
 SET @MySql = @MySql + '                       JOIN CTE_NEW AS CT ' + CHAR (10) ;
 SET @MySql = @MySql + '                           ' + @ON_Clause + '; ' + CHAR (10) ;
 SET @mysql = @mysql + 'declare @TotRecs as int = @@ROWCOUNT ; ' + CHAR ( 10) ;
 SET @mysql = @mysql + 'print ''RETURNED COUNT: '' + cast(@TotRecs  as nvarchar(50)) ; ' + CHAR ( 10) ;

 SET @MySql = @MySql + '    -- ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''IE''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, ''' + @InstanceName + ''', ''' + @TblName + '''' + ', @TotRecs, ''' + @ProcName + '''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    --************************************************************************************* ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''T''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, ''' + @InstanceName + ''', ''' + @TblName + '''' + ', @TotRecs, ''' + @ProcName + '''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    --************************************************************************************* ' + CHAR (10) ;

 SET @mysql = @mysql + 'return @TotRecs ;' + CHAR ( 10) ;
 --    SET @mysql = @mysql + 'SET IDENTITY_INSERT ' + @BaseTblName + ' OFF ;' + CHAR ( 10) ;
 SET @MySql = @MySql + 'END; ' + CHAR (10) ;

 IF @Debug = 1
    BEGIN
       PRINT @mysql;
    END;

 IF NOT EXISTS (SELECT
                   name
             FROM sys.procedures
             WHERE name = @ProcName)
    BEGIN
       PRINT '4 - CREATING PROCEDURE: ' + @ProcName;
    END;
 ELSE
    BEGIN
       PRINT '4 - PROCEDURE: ' + @ProcName + ' ALREADY EXISTS, dropping and recreating.';
       SET @MySql2 = 'Drop Procedure ' + @ProcName;
       EXEC (@MySql2) ;
    END;
 EXEC (@MySql) ;

 IF
      @CreateAllJobs = 1
    BEGIN
       EXEC proc_GenJobBaseTableSync @Interval , @ProcName;
       PRINT 'Created JOB : ' + 'JOB_' + @ProcName;
    END;

 --*******************************CREATE PROC APPLY CT CHANGES *****************************************
 SET @ProcName = 'proc_' + @BaseTblName + '_' + @InstanceName + '_ApplyCT';
 SET @MySql = '';
 SET @MySql = @MySql + 'CREATE PROCEDURE ' + @ProcName + CHAR (10) ;
 SET @MySql = @MySql + 'AS ' + CHAR (10) ;
 SET @MySql = @MySql + 'BEGIN ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @RowGuid AS nvarchar (100) = CAST (NEWID () AS nvarchar (50)) ; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @Action AS nvarchar (10) = null; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @NbrRecs AS bigint = 0; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @InstanceName AS nvarchar (100) = null; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @TblName AS nvarchar (100) = null; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @VersionTrackingTabl AS nvarchar (100) = null; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @MySql AS nvarchar (max) = null; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @last_sync_version  AS bigint = -1; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @curr_version  AS bigint = -1; ' + CHAR (10) ;
 SET @MySql = @MySql + '    DECLARE @result TABLE ( ' + CHAR (10) ;
 SET @MySql = @MySql + '                          LastVerNo bigint) ; ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @TblName = ''' + @TblName + '''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @InstanceName = ''' + @InstanceName + '''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @VersionTrackingTabl = ''' + @VersionTrackingTabl + '''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @curr_version = (SELECT ' + CHAR (10) ;
 SET @MySql = @MySql + '                                MAX (CT.SYS_CHANGE_VERSION)  ' + CHAR (10) ;
 SET @MySql = @MySql + '                                FROM CHANGETABLE ( CHANGES ' + @InstanceName + '.dbo.' + @TblName + ', NULL) AS ct); ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;

 SET @MySql = @MySql + '    DECLARE @iCnt int = 0; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC @iCnt = proc_ifExistCurrVersionNbr @VersionTrackingTabl  , @InstanceName, @curr_version; ' + CHAR (10) ;
 SET @MySql = @MySql + '    IF @iCnt &gt; 0 ' + CHAR (10) ;
 SET @MySql = @MySql + '         BEGIN ' + CHAR (10) ;
 SET @MySql = @MySql + '             PRINT ''Current version has previously been processed, returning.''; ' + CHAR (10) ;
 SET @MySql = @MySql + '             RETURN; ' + CHAR (10) ;
 SET @MySql = @MySql + '         END; ' + CHAR (10) ;

 SET @MySql = @MySql + '    EXEC @last_sync_version = proc_BASE_GetMaxCTVersionNbr @VersionTrackingTabl, @InstanceName ; ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''N''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, @InstanceName, @TblName, @NbrRecs, ''' + @ProcName + '''; ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @MySql = @MySql + '    set @MySql = ''select max(SYS_CHANGE_VERSION) from ' + @VersionTrackingTabl + ' Where DBMS = ''''' + @InstanceName + '''''' + ' ; ' + '''' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @MySql = @MySql + '    INSERT INTO @result ( ' + CHAR (10) ;
 SET @MySql = @MySql + '           LastVerNo)  ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC (@MySql) ; ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @last_sync_version = (SELECT TOP (1)  ' + CHAR (10) ;
 SET @MySql = @MySql + '                                     LastVerNo ' + CHAR (10) ;
 SET @MySql = @MySql + '                                     FROM @result); ' + CHAR (10) ;
 SET @MySql = @MySql + '    IF @last_sync_version IS NULL ' + CHAR (10) ;
 SET @MySql = @MySql + '        BEGIN ' + CHAR (10) ;
 SET @MySql = @MySql + '            SET @last_sync_version = 0; ' + CHAR (10) ;
 SET @MySql = @MySql + '        END; ' + CHAR (10) ;
 SET @MySql = @MySql + '    PRINT ''PULLING VERSION# '' + CAST (@last_sync_version AS nvarchar (50)) ; ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @MySql = @MySql + '    --************************************************************************************* ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''IS''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, @InstanceName, @TblName, @NbrRecs, NULL; ' + CHAR (10) ;
 SET @MySql = @MySql + '    -- ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC @NbrRecs = proc_BASE_CMS_Class_KenticoCMS_1_Insert @last_sync_version; ' + CHAR (10) ;
 SET @MySql = @MySql + '    -- ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''IE''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, @InstanceName, @TblName, @NbrRecs, NULL; ' + CHAR (10) ;
 SET @MySql = @MySql + '    --************************************************************************************* ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''US''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    -- ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, @InstanceName, @TblName, @NbrRecs, NULL; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC @NbrRecs = proc_BASE_CMS_Class_KenticoCMS_1_Update @last_sync_version; ' + CHAR (10) ;
 SET @MySql = @MySql + '    -- ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''UE''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, @InstanceName, @TblName, @NbrRecs, NULL; ' + CHAR (10) ;
 SET @MySql = @MySql + '    --************************************************************************************* ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''DS''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, @InstanceName, @TblName, @NbrRecs, NULL; ' + CHAR (10) ;
 SET @MySql = @MySql + '    -- ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC @NbrRecs = proc_BASE_CMS_Class_KenticoCMS_1_Delete @last_sync_version; ' + CHAR (10) ;
 SET @MySql = @MySql + '    -- ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''DE''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, @InstanceName, @TblName, @NbrRecs, NULL; ' + CHAR (10) ;
 SET @MySql = @MySql + '    --************************************************************************************* ' + CHAR (10) ;
 SET @MySql = @MySql + '    SET @Action = ''T''; ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @Action, @InstanceName, @TblName, @NbrRecs, NULL; ' + CHAR (10) ;
 SET @MySql = @MySql + '    --************************************************************************************* ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @MySql = @MySql + '    EXEC proc_BASE_SaveCurrCTVersionNbr @InstanceName, @TblName , @curr_version; ' + CHAR (10) ;
 SET @MySql = @MySql + ' ' + CHAR (10) ;
 SET @MySql = @MySql + 'END; ' + CHAR (10) ;

 IF @Debug = 1
    BEGIN
       PRINT @mysql;
    END;

 IF NOT EXISTS (SELECT
                   name
             FROM sys.procedures
             WHERE name = @ProcName)
    BEGIN
       PRINT '5 - CREATING PROCEDURE: ' + @ProcName;
    END;
 ELSE
    BEGIN
       PRINT '5 - PROCEDURE: ' + @ProcName + ' ALREADY EXISTS, dropping and rereating.';
       SET @MySql2 = 'Drop Procedure ' + @ProcName;
       EXEC (@MySql2) ;
    END;
 EXEC (@MySql) ;

 IF @Debug = 1
    BEGIN
       PRINT @MySql;
    END;
 PRINT 'Created MASTER PROC : ' + @ProcName;

 IF EXISTS (SELECT
               name
         FROM sys.procedures
         WHERE
               name = 'proc_GenJobBaseTableSync')
    BEGIN
       EXEC proc_GenJobBaseTableSync @Interval , @ProcName;
    END;
 ELSE
    BEGIN
       PRINT 'MSG ERROR 002: proc_GenJobBaseTableSync NOT found.';
       RAISERROR ('MSG ERROR 002: proc_GenJobBaseTableSync NOT found.' , 14 , 1) WITH NOWAIT;
    END;

 PRINT 'Created JOB : ' + 'JOB_' + @ProcName;

 SET NOCOUNT OFF;

 PRINT 'Pulling data from ' + @InstanceName + '.' + @TblName;
 DECLARE
     @InitProc AS NVARCHAR (200) = 'proc_' + @BaseTblName + '_' + @InstanceName + '_SYNC';

 IF
      @GenProcOnlyDoNotPullData = 0
    BEGIN
       EXEC (@InitProc) ;
    END;
 PRINT 'PULLED data from ' + @InstanceName + '.' + @TblName;
 PRINT '---------------------------------------------------------';

--if @GenProcOnlyDoNotPullData = 0
--EXEC proc_UpdateTrackerDataSurrogateKey @BaseTblName;

END;
GO
PRINT 'Created proc_genPullChangesProc';
GO




</textarea>
</td></tr>

<tr class="bar">
 <td align="left"><a href="javascript:hidecode(sourcecode);" id="hidelink">Hide code</a></td>
 <td align="right"><a href="http://www.aivosto.com/visustin.html">Visustin flow chart for T-SQL</a></td></tr>
</table>

</body>
</html>
