<html lang="en">
<head>
<META content="text/html; charset=utf-8" http-equiv=Content-Type>
<META name="Generator" content="Visustin">
<META name="description" content="T-SQL flow chart saved by Aivosto Visustin (www.aivosto.com).">
<META name="keywords" content="T-SQL, flow graph, diagram">

<title>T-SQL flow chart: proc_GenBAseTableFromView.sql</title>

<style type="text/css">
<!--
BODY      { margin: 0; }
TEXTAREA  { background: #ffffcc; font-size: 8pt; }
A:link, A:visited { color: blue; }
TR.bar    { background: white; font-family: Verdana, Arial, Sans-Serif; font-size: 70%; }
TR TD     { padding: 0; background: white; }
TR.bar TD { padding: 2px 5px 2px 5px; background: #ccccff; }
-->
</style>

<script type="text/javascript">
<!--
function hidecode(id) { 
  if (id.style.display=="none") {
    id.style.display="";
    hidelink.innerHTML="Hide code";
  } else {
    id.style.display="none";
    hidelink.innerHTML="Show code";
  }
}
-->
</script>
</head>


<body scroll=no>

<table width="100%" height="100%" cellspacing="0" cellpadding="0" border="0">

<tr height="100%"><td id="#upper" colspan="2">
 <iframe name="pic" width="100%" height="100%" src="proc_GenBaseTableFromView2.png" frameborder="0" title="T-SQL flow chart: proc_GenBAseTableFromView.sql">
  <a href="proc_GenBaseTableFromView2.png"><img src="proc_GenBaseTableFromView2.png" height="100%" title="T-SQL flow chart: proc_GenBAseTableFromView.sql"></a>
 </iframe>
</td></tr>

<tr id="sourcecode"><td colspan="2">
<textarea rows=15 readonly=yes style="width:100%; border-width:0;">


/*----------------------------------------------------
       SELECT
            TABLE_CATALOG
          , TABLE_SCHEMA
          , TABLE_NAME
          , COLUMN_NAME
          , ORDINAL_POSITION
          , IS_NULLABLE
          , DATA_TYPE
          , CHARACTER_MAXIMUM_LENGTH
          , NUMERIC_PRECISION
          , NUMERIC_SCALE
       FROM information_schema.columns
       WHERE
            table_name = 'View_CMS_Tree_Joined'
                  and column_name = 'NodeCustomData'

SELECT distinct DATA_TYPE
       FROM information_schema.columns
       WHERE
            table_name = 'View_CMS_Tree_Joined'
*/


GO
PRINT 'executing proc_GenBaseTableFromView.sql';
GO

IF EXISTS (SELECT
           name
      FROM sys.procedures
      WHERE
           name = 'proc_GenBaseTableFromView')
 BEGIN
    DROP PROCEDURE
        proc_GenBaseTableFromView;
 END;
GO
/*-------------------------------------------------------------------------------------------------------------------------------------------
use KenticoCMS_Datamart_2
go
exec proc_GenBaseTableFromView 'KenticoCMS_2', 'View_Boards_BoardMessage_Joined', 'NO', @GenJobToExecute = 1, @SkipIfExists = 1
go
--HOW TO USE:
exec proc_GenBaseTableFromView 'KenticoCMS_1', 'View_OM_ContactGroupMember_User_ContactJoined', 'no', @GenJobToExecute = 1, @SkipIfExists = 1
exec proc_GenBaseTableFromView 'KenticoCMS_2', 'View_OM_ContactGroupMember_User_ContactJoined', 'no', @GenJobToExecute = 1, @SkipIfExists = 1
exec proc_GenBaseTableFromView 'KenticoCMS_3', 'View_OM_ContactGroupMember_User_ContactJoined', 'no', @GenJobToExecute = 1, @SkipIfExists = 1
*/


CREATE PROCEDURE proc_GenBaseTableFromView (
   @DBNAME AS NVARCHAR (250)
  , @ViewName AS NVARCHAR (250)
  , @Preview AS NVARCHAR (5) = 'no'
  , @GenJobToExecute AS INT = 1
  , @SkipIfExists AS INT = 0)
AS
BEGIN

/*---------------------------------------------------------------------------------------
@Copyright  D. Miller &amp; Associates, Ltd., Highland Park, IL, 1.1.1960 allrights reserved.
License:          This procedure can be used freely as long as the copyright and this header
           are preserved.

Author:   W. Dale Miller
Date:     4-2-2013
Purpose:          Generate a set of change tracking routines and BASE table based on a view.
           This is advantageous when views' performance is an issue or views have multiple
           levels of nesting.

           Based on the DMA, Ltd. SQL Server Gen Utilities(tm)

Parms:    @DBNAME - the instance name contining the view and from which to PULL the data.
           @ViewName - name of view to be processed.
           @Preview - set to 1 if all that is wanted is to view the generated code and
                                specifically NOT to execute it.
           @GenJobToExecute - Must be set to 1 to create the JOB thats runs this procedure
                                 on a schedule
           @SkipIfExists - IF set to 1 and the tgt view has been previously processed and
                                 the BASE table already exists, the proc will immediately exit.
*/

 --DECLARE @DBNAME AS NVARCHAR (250) = 'KenticoCMS_2', @ViewName AS NVARCHAR (250) = 'View_CMS_Tree_Joined', @Preview AS NVARCHAR (5) = 'YES'

 BEGIN TRY
    CLOSE CursorHashCols;
    DEALLOCATE CursorHashCols;
 END TRY
 BEGIN CATCH
    PRINT 'CLOSING CursorHashCols';
 END CATCH;
 BEGIN TRY
    CLOSE CursorViewCols;
    DEALLOCATE CursorViewCols;
 END TRY
 BEGIN CATCH
    PRINT 'CLOSING CursorViewCols';
 END CATCH;
 BEGIN TRY
    CLOSE CursorCreateTable;
    DEALLOCATE CursorCreateTable;
 END TRY
 BEGIN CATCH
    PRINT 'CLOSING CursorCreateTable';
 END CATCH;
 BEGIN TRY
    CLOSE InsertIntoCols;
    DEALLOCATE InsertIntoCols;
 END TRY
 BEGIN CATCH
    PRINT 'CLOSING InsertIntoCols';
 END CATCH;

 DECLARE
      @TABLE_CATALOG NVARCHAR (250)
     , @TABLE_SCHEMA AS NVARCHAR (250)
     , @TABLE_NAME AS NVARCHAR (250)
     , @COLUMN_NAME AS NVARCHAR (250)
     , @ORDINAL_POSITION AS INT
     , @IS_NULLABLE AS NVARCHAR (50)
     , @DATA_TYPE AS NVARCHAR (250)
     , @CHARACTER_MAXIMUM_LENGTH AS INT
     , @NUMERIC_PRECISION AS INT
     , @NUMERIC_SCALE AS INT
     , @MySql AS NVARCHAR (MAX) = ''
     , @InsertNewDDL AS NVARCHAR (MAX) = ''
     , @InsertIntoDDL AS NVARCHAR (MAX) = ''
     , @DeleteDDL AS NVARCHAR (MAX) = ''
     , @SelectCols AS NVARCHAR (MAX) = ''
     , @ViewCols AS NVARCHAR (MAX) = ''
     , @BASE_Tbl_DLL AS NVARCHAR (MAX) = ''
     , @HashCols AS NVARCHAR (MAX) = ''
     , @HashStmt AS NVARCHAR (MAX) = '     CAST (HASHBYTES (''SHA1'', XX '
     , @COLS AS NVARCHAR (MAX) = ''
     , @BTCOLS AS NVARCHAR (MAX) = ''
     , @TblName AS NVARCHAR (100) = 'BASE_' + @ViewName
     , @TrigName AS NVARCHAR (250)
     , @TempTbl AS NVARCHAR (250) ;

 IF
      @SkipIfExists = 1
    BEGIN
       IF EXISTS (SELECT
                       table_name
                FROM information_schema.tables
                WHERE
                       table_name = @TblName)
         BEGIN
             PRINT @TblName + ' already exists, will NOT re-create. ';
         END;
    END;
 ELSE
    BEGIN IF
              @SkipIfExists = 0
           BEGIN
               IF EXISTS (SELECT
                               table_name
                          FROM information_schema.tables
                          WHERE
                               table_name = @TblName)
                   BEGIN
                       PRINT 'DROPPING and recreating ' + @TblName;
                       SET  @MySql = 'drop table ' + @TblName;
                       EXEC (@MySql) ;
                   END;
               IF EXISTS (SELECT
                               table_name
                          FROM information_schema.tables
                          WHERE
                               table_name = @TblName + '_DEL')
                   BEGIN
                       PRINT 'DROPPING and recreating ' + @TblName + '_DEL';
                       SET  @MySql = 'drop table ' + @TblName + '_DEL';
                       EXEC (@MySql) ;
                   END;
           END;
    END;

 SET @TempTbl = '#TEMP_' + @ViewName + '_' + @Dbname;

 SET @MySql = 'declare CursorHashCols CURSOR ' + char (10) ;
 SET @MySql = @MySql + '    FOR  ' + char (10) ;
 SET @MySql = @MySql + '            SELECT ' + char (10) ;
 SET @MySql = @MySql + '                   TABLE_CATALOG ' + char (10) ;
 SET @MySql = @MySql + '                 , TABLE_SCHEMA ' + char (10) ;
 SET @MySql = @MySql + '                 , TABLE_NAME ' + char (10) ;
 SET @MySql = @MySql + '                 , COLUMN_NAME ' + char (10) ;
 SET @MySql = @MySql + '                 , ORDINAL_POSITION ' + char (10) ;
 SET @MySql = @MySql + '                 , IS_NULLABLE ' + char (10) ;
 SET @MySql = @MySql + '                 , DATA_TYPE ' + char (10) ;
 SET @MySql = @MySql + '                 , CHARACTER_MAXIMUM_LENGTH ' + char (10) ;
 SET @MySql = @MySql + '                 , NUMERIC_PRECISION ' + char (10) ;
 SET @MySql = @MySql + '                 , NUMERIC_SCALE ' + char (10) ;
 SET @MySql = @MySql + '            FROM ' + @DBNAME + '.information_schema.columns ' + char (10) ;
 SET @MySql = @MySql + '            WHERE ' + char (10) ;
 SET @MySql = @MySql + '                   table_name = ''' + @ViewName + ''' and TABLE_CATALOG = ''' + @DBNAME + '''' + char (10) ;

 EXEC (@MySql) ;

 OPEN CursorHashCols;

 FETCH NEXT FROM CursorHashCols
 INTO @TABLE_CATALOG , @TABLE_SCHEMA , @TABLE_NAME , @COLUMN_NAME
 , @ORDINAL_POSITION , @IS_NULLABLE , @DATA_TYPE , @CHARACTER_MAXIMUM_LENGTH
 , @NUMERIC_PRECISION , @NUMERIC_SCALE;

 WHILE
      @@FETCH_STATUS = 0
    BEGIN
       IF
            @DATA_TYPE = 'datetime' OR
            @DATA_TYPE = 'datetime2'
         BEGIN
             SET @HashCols = @HashCols + '       ISNULL (CAST ([' + @COLUMN_NAME + '] AS nvarchar (250)) , ''01-01-1960'') + ' + char (10) ;
         END;
       ELSE
         BEGIN IF
                      @DATA_TYPE = 'varbinary'
                   BEGIN
                       PRINT 'Found varbinary, skipping ' + @COLUMN_NAME;
                   END;
               ELSE
                   BEGIN IF
                              @DATA_TYPE = 'uniqueidentifier'
                            BEGIN
                               SET @HashCols = @HashCols + '       ISNULL (CAST ([' + @COLUMN_NAME + '] AS nvarchar (250)) , ''00000000-0000-0000-0000-000000000000'') + ' + char (10) ;
                            END;
                         ELSE
                            BEGIN IF
                                   @DATA_TYPE = 'nvarchar' OR
                                   @DATA_TYPE = 'varchar' OR
                                   @DATA_TYPE = 'char' OR
                                   @DATA_TYPE = 'nchar'
                                  BEGIN
                                    -- COALESCE (substring(Bio,1,1000), '-') +
                                    IF
                                      @CHARACTER_MAXIMUM_LENGTH &lt; 0
                                     BEGIN
                                       SET @HashCols = @HashCols + '       COALESCE (substring([' + @COLUMN_NAME + '],1,1000), ''-'') + ' + char (10) ;
                                     END;
                                    ELSE
                                     BEGIN
                                       SET @HashCols = @HashCols + '       ISNULL ([' + @COLUMN_NAME + '], ''-'') + ' + char (10) ;
                                     END;
                                  END;
                                ELSE
                                  BEGIN
                                    SET @HashCols = @HashCols + '       ISNULL (CAST ([' + @COLUMN_NAME + '] AS nvarchar (250)) , ''-'') + ' + char (10) ;
                                  END;
                            END;
                   END;
         END;
       FETCH NEXT FROM CursorHashCols
       INTO @TABLE_CATALOG , @TABLE_SCHEMA , @TABLE_NAME , @COLUMN_NAME
       , @ORDINAL_POSITION , @IS_NULLABLE , @DATA_TYPE , @CHARACTER_MAXIMUM_LENGTH
       , @NUMERIC_PRECISION , @NUMERIC_SCALE;

    END;

 SET @HashCols = reverse (@HashCols) ;
 SET @HashCols = ltrim (rtrim (@HashCols)) ;

 DECLARE
      @i AS BIGINT = 0;

 SET @i = charindex ('+' , @HashCols) ;
 SET @HashCols = substring (@HashCols , @i + 1 , datalength (@HashCols)) ;
 SET @HashCols = reverse (@HashCols) ;

 --ISNULL (ClassDisplayName, '-')) as nvarchar(100)) as XX
 SET @HashCols = @HashCols + ' ) as nvarchar(100)) as HashCode ' + char (10) ;
 CLOSE CursorHashCols;
 DEALLOCATE CursorHashCols;
 SET @HashStmt = replace (@HashStmt , 'XX' , @HashCols) ;

 IF @Preview = 'YES'
    BEGIN SELECT
              @HashStmt AS HashStmt;
    END;
 --***********************************************************************************
 SET @MySql = 'declare InsertIntoCols CURSOR ' + char (10) ;
 SET @MySql = @MySql + '    FOR  ' + char (10) ;
 SET @MySql = @MySql + '            SELECT ' + char (10) ;
 SET @MySql = @MySql + '                   TABLE_CATALOG ' + char (10) ;
 SET @MySql = @MySql + '                 , TABLE_SCHEMA ' + char (10) ;
 SET @MySql = @MySql + '                 , TABLE_NAME ' + char (10) ;
 SET @MySql = @MySql + '                 , COLUMN_NAME ' + char (10) ;
 SET @MySql = @MySql + '                 , ORDINAL_POSITION ' + char (10) ;
 SET @MySql = @MySql + '                 , IS_NULLABLE ' + char (10) ;
 SET @MySql = @MySql + '                 , DATA_TYPE ' + char (10) ;
 SET @MySql = @MySql + '                 , CHARACTER_MAXIMUM_LENGTH ' + char (10) ;
 SET @MySql = @MySql + '                 , NUMERIC_PRECISION ' + char (10) ;
 SET @MySql = @MySql + '                 , NUMERIC_SCALE ' + char (10) ;
 SET @MySql = @MySql + '            FROM ' + @DBNAME + '.information_schema.columns ' + char (10) ;
 SET @MySql = @MySql + '            WHERE ' + char (10) ;
 SET @MySql = @MySql + '                   table_name = ''' + @ViewName + ''' and TABLE_CATALOG = ''' + @DBNAME + '''' + char (10) ;
 EXEC (@MySql) ;

 OPEN InsertIntoCols;

 FETCH NEXT FROM InsertIntoCols
 INTO @TABLE_CATALOG , @TABLE_SCHEMA , @TABLE_NAME , @COLUMN_NAME
 , @ORDINAL_POSITION , @IS_NULLABLE , @DATA_TYPE , @CHARACTER_MAXIMUM_LENGTH
 , @NUMERIC_PRECISION , @NUMERIC_SCALE;

 SET @InsertIntoDDL = '';
 SET @InsertIntoDDL = @InsertIntoDDL + 'Declare @NbrRecs bigint = 0 ;' + char (10) ;
 SET @InsertIntoDDL = @InsertIntoDDL + 'If @ReloadAll = 1 ' + char (10) ;
 SET @InsertIntoDDL = @InsertIntoDDL + 'BEGIN' + char (10) ;
 SET @InsertIntoDDL = @InsertIntoDDL + 'DELETE from ' + @TblName + ' where DBNAME = ''' + @DBNAME + ''' ;' + char (10) ;

 SET @InsertNewDDL = @InsertNewDDL + 'SET @NbrRecs = @NbrRecs + @@ROWCOUNT; ';
 SET @InsertNewDDL = @InsertNewDDL + 'PRINT ''#CHANGED: '' + CAST (@NbrRecs AS NVARCHAR (50)) + '' records in ' + @TblName + ' ''; ' + char (10) ;

 SET @InsertIntoDDL = @InsertIntoDDL + 'INSERT INTO ' + @TblName + ' (' + char (10) ;
 SET @SelectCols = '  SELECT ' + char (10) ;

 WHILE
      @@FETCH_STATUS = 0
    BEGIN
       SET @InsertIntoDDL = @InsertIntoDDL + '       ' + '[' + @COLUMN_NAME + '], ' + char (10) ;
       SET @COLS = @COLS + '       [' + @COLUMN_NAME + '], ' + char (10) ;
       SET @BTCOLS = @BTCOLS + 'BT.[' + @COLUMN_NAME + '], ' + char (10) ;

       FETCH NEXT FROM InsertIntoCols
       INTO @TABLE_CATALOG , @TABLE_SCHEMA , @TABLE_NAME , @COLUMN_NAME
       , @ORDINAL_POSITION , @IS_NULLABLE , @DATA_TYPE , @CHARACTER_MAXIMUM_LENGTH
       , @NUMERIC_PRECISION , @NUMERIC_SCALE;

    END;

 SET @SelectCols = @SelectCols + @COLS + ' @@Servername as SVR, DB_NAME() as DBNAME, ' + @hashStmt + ' FROM ' + @DBNAME + '.dbo.' + @ViewName + char (10) ;

 IF @Preview = 'YES'
    BEGIN
       SELECT
            @SelectCols AS SelectCols;
       SELECT
            @COLS AS COLS;
    END;

 SET @InsertIntoDDL = reverse (@InsertIntoDDL) ;
 SET @InsertIntoDDL = ltrim (rtrim (@InsertIntoDDL)) ;
 SET @i = charindex (',' , @InsertIntoDDL) ;
 SET @InsertIntoDDL = substring (@InsertIntoDDL , @i + 1 , datalength (@InsertIntoDDL)) ;
 SET @InsertIntoDDL = reverse (@InsertIntoDDL) ;

 SET @InsertIntoDDL = @InsertIntoDDL + ', SVR, DBNAME, HashCode' + char (10) ;
 SET @InsertIntoDDL = @InsertIntoDDL + ')' + char (10) ;

 SET @InsertIntoDDL = @InsertIntoDDL + @SelectCols + char (10) ;
 SET @InsertIntoDDL = @InsertIntoDDL + 'RETURN ;';
 SET @InsertIntoDDL = @InsertIntoDDL + 'END ;    --Begin';
 CLOSE InsertIntoCols;
 DEALLOCATE InsertIntoCols;

 IF @Preview = 'YES'
    BEGIN SELECT
              @InsertIntoDDL AS InsertIntoDDL;
    END;
 --***********************************************************************************
 SET @DeleteDDL = '-- Remove all records from the BASE table that are not in or are different than the CURRENT records in the view ' + char (10) ;
 SET @DeleteDDL = @DeleteDDL + 'delete from ' + @TblName + char (10) ;
 SET @DeleteDDL = @DeleteDDL + 'where DBNAME = ''' + @DBNAME + '''' + char (10) ;
 SET @DeleteDDL = @DeleteDDL + 'and HashCode not in (Select HashCode from ' + @TempTbl + ') ;' + char (10) ;

 IF @Preview = 'YES'
    BEGIN SELECT
              @DeleteDDL AS DeleteDDL;
    END;
 --***********************************************************************************
 SET @MySql = 'declare CursorViewCols CURSOR ' + char (10) ;
 SET @MySql = @MySql + '    FOR  ' + char (10) ;
 SET @MySql = @MySql + '            SELECT ' + char (10) ;
 SET @MySql = @MySql + '                   TABLE_CATALOG ' + char (10) ;
 SET @MySql = @MySql + '                 , TABLE_SCHEMA ' + char (10) ;
 SET @MySql = @MySql + '                 , TABLE_NAME ' + char (10) ;
 SET @MySql = @MySql + '                 , COLUMN_NAME ' + char (10) ;
 SET @MySql = @MySql + '                 , ORDINAL_POSITION ' + char (10) ;
 SET @MySql = @MySql + '                 , IS_NULLABLE ' + char (10) ;
 SET @MySql = @MySql + '                 , DATA_TYPE ' + char (10) ;
 SET @MySql = @MySql + '                 , CHARACTER_MAXIMUM_LENGTH ' + char (10) ;
 SET @MySql = @MySql + '                 , NUMERIC_PRECISION ' + char (10) ;
 SET @MySql = @MySql + '                 , NUMERIC_SCALE ' + char (10) ;
 SET @MySql = @MySql + '            FROM ' + @DBNAME + '.information_schema.columns ' + char (10) ;
 SET @MySql = @MySql + '            WHERE ' + char (10) ;
 SET @MySql = @MySql + '                   table_name = ''' + @ViewName + ''' and TABLE_CATALOG = ''' + @DBNAME + '''' + char (10) ;
 EXEC (@MySql) ;

 OPEN CursorViewCols;

 FETCH NEXT FROM CursorViewCols
 INTO @TABLE_CATALOG , @TABLE_SCHEMA , @TABLE_NAME , @COLUMN_NAME
 , @ORDINAL_POSITION , @IS_NULLABLE , @DATA_TYPE , @CHARACTER_MAXIMUM_LENGTH
 , @NUMERIC_PRECISION , @NUMERIC_SCALE;

 SET @InsertNewDDL = 'SELECT ' + char (10) ;

 WHILE
      @@FETCH_STATUS = 0
    BEGIN
       --ISNULL (CAST (HAUSERSTARTED.ITEMID AS NVARCHAR (250)) , '-') + ISNULL (CAST (VHAJ.NODEGUID AS NVARCHAR (250)) , '-')

       SET @SelectCols = @SelectCols + '       [' + @COLUMN_NAME + '], ' + char (10) ;
       SET @InsertNewDDL = @InsertNewDDL + '       [' + @COLUMN_NAME + '], ' + char (10) ;

       FETCH NEXT FROM CursorViewCols
       INTO @TABLE_CATALOG , @TABLE_SCHEMA , @TABLE_NAME , @COLUMN_NAME
       , @ORDINAL_POSITION , @IS_NULLABLE , @DATA_TYPE , @CHARACTER_MAXIMUM_LENGTH
       , @NUMERIC_PRECISION , @NUMERIC_SCALE;

    END;

 SET @InsertNewDDL = @InsertNewDDL + @HashStmt + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + ', ''' + @DBNAME + ''' as DBNAME ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + ', getdate() as LastModifiedDate ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + 'into ' + @TempTbl + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + 'FROM ' + @DBNAME + '.dbo.' + @ViewName + char (10) ;

 SET @InsertNewDDL = @InsertNewDDL + 'SET @NbrRecs = @NbrRecs + @@ROWCOUNT; ';
 SET @InsertNewDDL = @InsertNewDDL + 'PRINT ''PULLED: '' + CAST (@NbrRecs AS NVARCHAR (50)) + '' records from ' + @ViewName + ' ''; ' + char (10) ;

 SET @InsertNewDDL = @InsertNewDDL + 'create clustered index [IDX_' + @TempTbl + '] on ' + @TempTbl + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '( ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '       DBNAME, HashCode ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + ') ' + char (10) + char (10) ;

 SET @InsertNewDDL = @InsertNewDDL + char (10) + 'INSERT DELETE DDL HERE' + char (10) ;

 --SET @InsertNewDDL = @InsertNewDDL + 'Declare @NbrRecs as int = 0 ; ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + 'with CTE (DBNAME , HashCode ) ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + 'as ( ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '    select DBNAME, HashCode ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '    from  ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '        ' + @TempTbl + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '    except  ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '    select DBNAME, HashCode ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '    from  ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '        BASE_' + @ViewName + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + ') ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + 'INSERT INTO BASE_' + @ViewName + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '( ' + char (10) ;

 SET @InsertNewDDL = @InsertNewDDL + @cols + 'DBNAME, HashCode' + char (10) ;

 SET @InsertNewDDL = @InsertNewDDL + ') ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + 'SELECT' + char (10) ;

 SET @InsertNewDDL = @InsertNewDDL + @BTCOLS + 'BT.DBNAME,BT.HashCode ';

 SET @InsertNewDDL = @InsertNewDDL + '               FROM ' + @TempTbl + ' AS BT ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '                    JOIN CTE ON ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '                                CTE.DBNAME = BT.DBNAME AND ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '               CTE.HashCode = BT.HashCode; ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '    SET @NbrRecs = @NbrRecs + @@ROWCOUNT; ' + char (10) ;
 SET @InsertNewDDL = @InsertNewDDL + '    PRINT ''INSERTED: '' + CAST (@NbrRecs AS NVARCHAR (50)) + '' records into ' + @TblName + ' ''; ' + char (10) ;

 CLOSE CursorViewCols;
 DEALLOCATE CursorViewCols;

 IF @Preview = 'YES'
    BEGIN SELECT
              @InsertNewDDL AS InsertNewDDL;
    END;

 SET @BASE_Tbl_DLL = 'if NOT Exists (select name from sys.tables where name = ''BASE_' + @ViewName + ''') ' + char (10) ;
 --SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + '   drop TABLE BASE_' + @ViewName + ' ; ' + char (10) + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + 'BEGIN ' + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + 'Create TABLE BASE_' + @ViewName + ' ( ' + char (10) ;
 -- select * from information_schema.columns where table_name = 'View_CMS_Tree_Joined' order by Column_name
 SET @MySql = 'declare CursorCreateTable CURSOR ' + char (10) ;
 SET @MySql = @MySql + '    FOR  ' + char (10) ;
 SET @MySql = @MySql + '            SELECT ' + char (10) ;
 SET @MySql = @MySql + '                   TABLE_CATALOG ' + char (10) ;
 SET @MySql = @MySql + '                 , TABLE_SCHEMA ' + char (10) ;
 SET @MySql = @MySql + '                 , TABLE_NAME ' + char (10) ;
 SET @MySql = @MySql + '                 , COLUMN_NAME ' + char (10) ;
 SET @MySql = @MySql + '                 , ORDINAL_POSITION ' + char (10) ;
 SET @MySql = @MySql + '                 , IS_NULLABLE ' + char (10) ;
 SET @MySql = @MySql + '                 , DATA_TYPE ' + char (10) ;
 SET @MySql = @MySql + '                 , CHARACTER_MAXIMUM_LENGTH ' + char (10) ;
 SET @MySql = @MySql + '                 , NUMERIC_PRECISION ' + char (10) ;
 SET @MySql = @MySql + '                 , NUMERIC_SCALE ' + char (10) ;
 SET @MySql = @MySql + '            FROM ' + @DBNAME + '.information_schema.columns ' + char (10) ;
 SET @MySql = @MySql + '            WHERE ' + char (10) ;
 SET @MySql = @MySql + '                   table_name = ''' + @ViewName + ''' and TABLE_CATALOG = ''' + @DBNAME + '''' + char (10) ;
 EXEC (@MySql) ;

 OPEN CursorCreateTable;

 FETCH NEXT FROM CursorCreateTable
 INTO @TABLE_CATALOG , @TABLE_SCHEMA , @TABLE_NAME , @COLUMN_NAME
 , @ORDINAL_POSITION , @IS_NULLABLE , @DATA_TYPE , @CHARACTER_MAXIMUM_LENGTH
 , @NUMERIC_PRECISION , @NUMERIC_SCALE;

 --SET @InsertNewDDL = 'SELECT ' + char (10) ;

 WHILE
      @@FETCH_STATUS = 0
    BEGIN
       SET @COLUMN_NAME = '[' + @COLUMN_NAME + ']';
       SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + '       ' + @COLUMN_NAME + ' ' + @DATA_TYPE;
       SET @ViewCols = @ViewCols + '       ' + @COLUMN_NAME + ' ' + @DATA_TYPE;

       --exec PrintImmediate @ViewCols ;
       IF
            @DATA_TYPE = 'datetime' OR
            @DATA_TYPE = 'datetime2'
         BEGIN
             SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + ', ' + char (10) ;
             SET @ViewCols = @ViewCols + ', ' + char (10) ;
         END;
       ELSE
         BEGIN IF
                      @DATA_TYPE = 'varbinary'
                   BEGIN
                       SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + '(' + cast (@CHARACTER_MAXIMUM_LENGTH AS NVARCHAR (50)) + '), ' + char (10) ;
                       SET @ViewCols = @ViewCols + '(' + cast (@CHARACTER_MAXIMUM_LENGTH AS NVARCHAR (50)) + '), ' + char (10) ;
                   END;
               ELSE
                   BEGIN IF
                              @DATA_TYPE = 'uniqueidentifier'
                            BEGIN
                               SET @ViewCols = @ViewCols + ',' + char (10) ;
                               SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + ',' + char (10) ;
                            END;
                         ELSE
                            BEGIN IF
                                   @DATA_TYPE = 'nvarchar' OR
                                   @DATA_TYPE = 'varchar' OR
                                   @DATA_TYPE = 'char' OR
                                   @DATA_TYPE = 'nchar'
                                  BEGIN
                                    IF
                                    @CHARACTER_MAXIMUM_LENGTH IS NULL OR
                                      @CHARACTER_MAXIMUM_LENGTH &lt;= 0
                                     BEGIN
                                       SET @ViewCols = @ViewCols + '(MAX), ' + char (10) ;
                                       SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + '(MAX), ' + char (10) ;
                                     END;
                                    ELSE
                                     BEGIN
                                       SET @ViewCols = @ViewCols + '(' + cast (@CHARACTER_MAXIMUM_LENGTH AS NVARCHAR (50)) + '), ' + char (10) ;
                                       SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + '(' + cast (@CHARACTER_MAXIMUM_LENGTH AS NVARCHAR (50)) + '), ' + char (10) ;
                                     END;
                                  END;
                                ELSE
                                  BEGIN
                                    SET @ViewCols = @ViewCols + ',' + char (10) ;
                                    SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + ',' + char (10) ;
                                  END;
                            END;
                   END;
         END;
       FETCH NEXT FROM CursorCreateTable
       INTO @TABLE_CATALOG , @TABLE_SCHEMA , @TABLE_NAME , @COLUMN_NAME
       , @ORDINAL_POSITION , @IS_NULLABLE , @DATA_TYPE , @CHARACTER_MAXIMUM_LENGTH
       , @NUMERIC_PRECISION , @NUMERIC_SCALE;

    END;

 IF @Preview = 'YES'
    BEGIN SELECT
              @ViewCols AS ViewCols2;
    END;

 --SET @BASE_Tbl_DLL = reverse (@BASE_Tbl_DLL) ;
 --SET @BASE_Tbl_DLL = ltrim (rtrim (@BASE_Tbl_DLL)) ;
 --SET @i = charindex (',' , @BASE_Tbl_DLL) ;
 --SET @BASE_Tbl_DLL = substring (@BASE_Tbl_DLL , @i + 1 , datalength (@BASE_Tbl_DLL)) ;
 --SET @BASE_Tbl_DLL = reverse (@BASE_Tbl_DLL) ;

 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + '  HashCode nvarchar(100) ' + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + ', SVR nvarchar(100) ' + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + ', DBNAME nvarchar(100) ' + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + ', SurrogateKey_' + @viewname + ' bigint identity (1,1) not null ' + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + ')' + char (10) + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + 'Create clustered Index IHash_' + @ViewName + ' on ' + @TblName + ' (' + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + '    DBNAME, HashCode' + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + ')' + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + 'Create Index SKey_' + @ViewName + ' on ' + @TblName + ' (' + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + '    SurrogateKey_' + @ViewName + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + ')' + char (10) ;
 SET @BASE_Tbl_DLL = @BASE_Tbl_DLL + 'END ;    --begin' + char (10) ;

 CLOSE CursorCreateTable;
 DEALLOCATE CursorCreateTable;

 IF @Preview = 'YES'
    BEGIN SELECT
              @BASE_Tbl_DLL AS BASE_Tbl_DLL;
    END;
 ELSE
    BEGIN
       IF EXISTS (SELECT
                       table_name
                FROM information_schema.tables
                WHERE
                       table_name = @TblName)
         BEGIN
             PRINT @BASE_Tbl_DLL + ' : was found to already exist.';
         END;
       ELSE
         BEGIN
             EXEC (@BASE_Tbl_DLL) ;
         END;
       IF EXISTS (SELECT
                       table_name
                FROM information_schema.tables
                WHERE
                       table_name = @TblName)
         BEGIN
             PRINT 'TABLE: ' + @TblName + ' - verified and exists.';
         END;
       ELSE
         BEGIN
             PRINT 'TABLE: ' + @TblName + ' - FAILED verification and dies no exist.';
         END;
    END;

 DECLARE
      @ProcDDL AS NVARCHAR (MAX) = ''
     , @DropDDL AS NVARCHAR (MAX) = ''
     , @ProcedureName AS NVARCHAR (MAX) = 'proc_' + @ViewName + '_' + @DBNAME;

 SET @DropDDL = @DropDDL + 'if exists (select name from sys.procedures where name = ''' + @ProcedureName + ''')' + char (10) ;
 SET @DropDDL = @DropDDL + '     drop procedure ' + @ProcedureName + ';' + char (10) ;

 SET @ProcDDL = @ProcDDL + 'CREATE procedure ' + @ProcedureName + ' (@ReloadALL as int = 0) ' + char (10) ;
 SET @ProcDDL = @ProcDDL + 'AS ' + char (10) ;
 SET @ProcDDL = @ProcDDL + 'BEGIN ' + char (10) + char (10) ;
 SET @ProcDDL = @ProcDDL + '   -- This procedure, ' + @ProcedureName + ', is generated by proc_GenBaseTableFromView. On ' + cast (getdate () AS NVARCHAR (50)) + '.' + char (10) ;
 SET @ProcDDL = @ProcDDL + '   -- For changes to this procedure, please change the generator and regen the proc(s).' + char (10) ;
 SET @ProcDDL = @ProcDDL + '   -- Author:    W. Dale Miller' + char (10) ;
 SET @ProcDDL = @ProcDDL + '   -- Contact:   WDaleMiller@gmail.com' + char (10) + char (10) ;

 SET @ProcDDL = @ProcDDL + '   IF OBJECT_ID(''' + @TempTbl + ''') IS NOT NULL DROP TABLE ' + @TempTbl + ' ; ' + char (10) + char (10) ;

 SET @ProcDDL = @ProcDDL + '-- from @BASE_Tbl_DLL' + char (10) ;
 SET @ProcDDL = @ProcDDL + @BASE_Tbl_DLL + char (10) + char (10) ;

 SET @InsertNewDDL = replace (@InsertNewDDL , 'INSERT DELETE DDL HERE' , @DeleteDDL) ;

 SET @ProcDDL = @ProcDDL + '-- from @InsertIntoDDL' + char (10) ;
 SET @ProcDDL = @ProcDDL + @InsertIntoDDL + char (10) + char (10) ;
 --SET @ProcDDL = @ProcDDL + '-- from @DeleteDDL' + char (10) ;
 --SET @ProcDDL = @ProcDDL + @DeleteDDL + char (10) + char (10) ;
 SET @ProcDDL = @ProcDDL + '-- from @InsertNewDDL' + char (10) ;
 SET @ProcDDL = @ProcDDL + @InsertNewDDL + char (10) + char (10) ;

 SET @ProcDDL = @ProcDDL + 'END --Create Procedure';

 IF @Preview = 'YES'
    BEGIN
       SELECT
            @ProcDDL AS ProcDDL;
    END;
 IF
      @Preview != 'YES'
    BEGIN
       PRINT @DropDDL;
       EXEC (@DropDDL) ;
       PRINT @ProcDDL;
       EXEC (@ProcDDL) ;
       PRINT 'CREATED Procedure: ' + @ProcedureName;
    END;

 --***************************************************************************
 IF
      @GenJobToExecute = 1
    BEGIN
       DECLARE
            @Random INT
          , @Upper INT
          , @Lower INT
          , @pName NVARCHAR (100) = @ProcedureName;

       SET @Lower = 0; ---- The lowest random number
       SET @Upper = 10; ---- The highest random number
       SELECT
            @Random = ROUND ( (@Upper - @Lower - 1) * RAND () + @Lower , 0) ;

       IF
            @Preview != 'YES'
         BEGIN
             DECLARE
                    @JobFullName NVARCHAR (250) = 'job_' + @pName
                  , @StepName NVARCHAR (250) = 'Step2_' + @pName
                  , @CMD NVARCHAR (250) = 'EXEC proc_RemoveHashCodeDuplicateRows ''' + @TblName + ''',0 ';

             PRINT '@CMD: ' + @CMD;

             EXEC proc_GenJobTrackerTableSync @Interval = @Random , @ProcName = @pName;
             PRINT 'CREATED Sync Job: ' + @JobFullName;

             -- CREATE PROCEDURE proc_RemoveHashCodeDuplicateRows (@TblName AS NVARCHAR (250), @ShowSQL as bit = 0 )
             DECLARE
                    @jobid NVARCHAR (250) ;

             SELECT
                    @jobid = job_id
             FROM msdb.dbo.sysjobs
             WHERE
                    name = @JobFullName;

             EXEC msdb..sp_add_jobstep
             @job_name = @JobFullName ,
             @step_name = @StepName ,
             @subsystem = 'TSQL' ,
             @command = @CMD ,
             @on_fail_action = 3 ,
             @retry_attempts = 2 ,
             @retry_interval = 5;
             PRINT 'CREATED Job Step: ' + @StepName;

             EXEC msdb.dbo.sp_update_jobstep @job_id = @jobid , @step_id = 1 ,
             @on_success_action = 4 ,
             @on_success_step_id = 2;
                         PRINT 'Set Next Step action to CONTINUE: ' + @StepName;

         END;
       ELSE
         BEGIN
             PRINT 'SKIPPED Creating Sync Job';
         END;

       DECLARE
            @BASE_Tbl_DLL_DEL AS NVARCHAR (MAX) = ''
          , @HistoryTblName AS NVARCHAR (MAX) = @TblName + '_DEL'
          , @SKeyBad AS NVARCHAR (250) = 'SurrogateKey_' + @ViewName + '_DEL'
          , @SKeyGood AS NVARCHAR (250) = 'SurrogateKey_' + @ViewName;

       SET @BASE_Tbl_DLL_DEL = replace (@BASE_Tbl_DLL , @ViewName , @HistoryTblName) ;
       SET @BASE_Tbl_DLL_DEL = replace (@BASE_Tbl_DLL_DEL , 'bigint identity (1,1)' , 'bigint') ;
       SET @BASE_Tbl_DLL_DEL = replace (@BASE_Tbl_DLL_DEL , 'BASE_BASE_' , 'BASE_') ;
       SET @BASE_Tbl_DLL_DEL = replace (@BASE_Tbl_DLL_DEL , 'SurrogateKey_BASE_' , 'SurrogateKey_') ;
       SET @BASE_Tbl_DLL_DEL = replace (@BASE_Tbl_DLL_DEL , @SKeyBad , @SKeyGood) ;

       --print '@ViewName: '  + @ViewName ;
       --print '@HistoryTblName: '  + @HistoryTblName ;
       --print '@BASE_Tbl_DLL_DEL: '  + @BASE_Tbl_DLL_DEL ;

       IF @Preview = 'YES'
         BEGIN
             SELECT
                    @BASE_Tbl_DLL_DEL AS BASE_Tbl_DLL_DEL;
         END;
       ELSE
         BEGIN
             IF EXISTS (SELECT
                             table_name
                        FROM information_schema.tables
                        WHERE
                             table_name = @TblName + '_DEL')
                 BEGIN
                     --The History table already exists
                     IF
                           @SkipIfExists = 0
                         BEGIN
                            PRINT 'DROPPING and recreating ' + @TblName + '_DEL';
                            SET  @MySql = 'drop table ' + @TblName + '_DEL';
                            EXEC (@MySql) ;
                            EXEC (@BASE_Tbl_DLL_DEL) ;
                         END;
                     ELSE
                         BEGIN
                            PRINT '@SkipIfExists set true - Table ' + @TblName + '_DEL already exists, skipping.';
                         END;
                 END;
             ELSE
                 BEGIN
                     --The History table DOES NOT exist. Create it.
                     EXEC (@BASE_Tbl_DLL_DEL) ;
                 END;
             PRINT 'CREATED The History Table: ' + @HistoryTblName;
         END;

       DECLARE
            @OUT AS NVARCHAR (MAX) = ''
          , @DDL AS NVARCHAR (MAX) = '';

       PRINT 'CALLING: proc_genBaseDelTrigger - ' + @TblName;
       IF EXISTS (SELECT
                       table_name
                FROM information_schema.tables
                WHERE
                       table_name = @HistoryTblName)
         BEGIN
             PRINT 'TABLE: ' + @HistoryTblName + ' - verified and exists.';
             IF EXISTS (SELECT
                             table_name
                        FROM information_schema.columns
                        WHERE
                             table_name = @HistoryTblName AND
                             column_name = @SKeyBad)
                 BEGIN
                     --Change the Surrogate Key name.
                     DECLARE
                           @OldCOL AS NVARCHAR (250) = @HistoryTblName + '.' + @SKeyBad;
                     PRINT '@OldCOL: ' + @OldCOL;
                     PRINT '@SKeyGood: ' + @SKeyGood;
                     EXEC sp_RENAME @OldCOL , @SKeyGood , 'COLUMN';
                 END;

         END;
       ELSE
         BEGIN
             PRINT 'TABLE: ' + @HistoryTblName + ' - FAILED verification and does no exist.';
         END;

       --Generate the History DEL tracking trigger.
       EXEC proc_genBaseDelTrigger @TblName , @DDL OUTPUT;
       SET @OUT = (SELECT
                        @DDL) ;
       IF
            @Preview != 'YES'
         BEGIN

             SET @TrigName = 'TRIG_DEL_' + @TblName;
             IF NOT EXISTS (SELECT
                                *
                           FROM sys.triggers
                           WHERE
                                object_id = OBJECT_ID (N'[dbo].[' + @TrigName + ']'))
                 BEGIN
                     EXEC (@OUT) ;
                 END;
             PRINT 'CREATED History DEL Tracking Trigger.';
         END;

       IF @Preview = 'YES'
         BEGIN
             SELECT
                    @OUT AS DelTriggerDDL;
         END;

       --Generate the History UPDT Tracking Trigger
       EXEC proc_genBaseUpdtTrigger @TblName , @DDL OUTPUT;
       SET @OUT = (SELECT
                        @DDL) ;
       IF
            @Preview != 'YES'
         BEGIN
             SET @TrigName = 'TRIG_UPDT_' + @TblName;
             IF NOT EXISTS (SELECT
                                *
                           FROM sys.triggers
                           WHERE
                                object_id = OBJECT_ID (N'[dbo].[' + @TrigName + ']'))
                 BEGIN
                     EXEC (@OUT) ;
                 END;
             PRINT 'CREATED History UPDT Tracking Trigger.';
         END;

       IF @Preview = 'YES'
         BEGIN
             SELECT
                    @OUT AS UpdtTriggerDDL;
         END;

       --DECLARE
       --       @SetAsNotNUll AS INT = 0;
       --EXEC proc_RemoveIdentityCols @TblName , @SetAsNotNUll;

       --Check EntryDate exists in HISTORY table
       IF EXISTS (SELECT
                       name
                FROM sys.tables
                WHERE
                       name = @HistoryTblName)
         BEGIN
             IF NOT EXISTS (SELECT
                                column_name
                           FROM information_schema.columns
                           WHERE
                                table_name = @HistoryTblName AND
                                column_name = 'Action_Date')
                 BEGIN
                     SET @MySql = 'alter table ' + @HistoryTblName + ' add Action_Date datetime not null default getdate() ';
                     EXEC (@MySql) ;
                     PRINT 'Added Action_Date to: ' + @HistoryTblName;
                 END;
         END;

       --Check LastModifiedDate exists in HISTORY table
       IF EXISTS (SELECT
                       table_name
                FROM information_schema.tables
                WHERE
                       table_name = @HistoryTblName)
         BEGIN
             IF NOT EXISTS (SELECT
                                column_name
                           FROM information_schema.columns
                           WHERE
                                table_name = @HistoryTblName AND
                                column_name = 'LastModifiedDate')
                 BEGIN
                     SET @MySql = 'alter table ' + @HistoryTblName + ' add LastModifiedDate datetime null default getdate()';
                     EXEC (@MySql) ;
                     PRINT 'Added LastModifiedDate to: ' + @HistoryTblName;
                 END;
         END;
       ELSE
         BEGIN
             PRINT @TblName + ' FAILED TO CREATE.';
         END;
       --Check LastModifiedDate exists in BASE table
       IF EXISTS (SELECT
                       table_name
                FROM information_schema.tables
                WHERE
                       table_name = @TblName)
         BEGIN
             IF NOT EXISTS (SELECT
                                column_name
                           FROM information_schema.columns
                           WHERE
                                table_name = @TblName AND
                                column_name = 'LastModifiedDate')
                 BEGIN
                     SET @MySql = 'alter table ' + @TblName + ' add LastModifiedDate datetime null default getdate()';
                     EXEC (@MySql) ;
                     PRINT 'Added LastModifiedDate to: ' + @TblName;
                 END;
         END;
       ELSE
         BEGIN
             PRINT @TblName + ' FAILED TO CREATE.';
         END;
       DECLARE
            @PKName AS NVARCHAR (250) = 'PK_' + @TblName;
       DECLARE
            @SKname AS NVARCHAR (250) = 'SurrogateKey_' + @ViewName;

       IF NOT EXISTS (
       SELECT
            COLUMN_NAME
       FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
       WHERE
            OBJECTPROPERTY (OBJECT_ID (CONSTRAINT_SCHEMA + '.' + CONSTRAINT_NAME) , 'IsPrimaryKey') = 1 AND
            TABLE_NAME = @TblName AND
            TABLE_SCHEMA = 'dbo')
         BEGIN
             SET @MySQl = 'ALTER TABLE ' + @TblName + ' ADD CONSTRAINT ' + @PKName + ' PRIMARY KEY (' + @SKname + ') ';
             PRINT @MySQl;
             EXEC (@MySql) ;
         END;

       DECLARE
            @JobName NVARCHAR (250) = 'job_' + @ProcedureName;
       IF EXISTS (SELECT
                       job_id
                FROM msdb.dbo.sysjobs_view
                WHERE name = @JobName)
         BEGIN
             PRINT 'Verified: JOB ' + @JobName + ', exists.';
         END;
       ELSE
         BEGIN
             PRINT 'FAILED Verification: JOB ' + @JobName + ' does not exist.';
         END;

       PRINT 'COMPLETED..';
    END;
--***************************************************************************

END;

GO
PRINT 'executed proc_GenBaseTableFromView.sql';
GO

</textarea>
</td></tr>

<tr class="bar">
 <td align="left"><a href="javascript:hidecode(sourcecode);" id="hidelink">Hide code</a></td>
 <td align="right"><a href="http://www.aivosto.com/visustin.html">Visustin flow chart for T-SQL</a></td></tr>
</table>

</body>
</html>
