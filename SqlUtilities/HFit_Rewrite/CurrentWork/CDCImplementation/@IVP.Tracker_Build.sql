--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: PrintImmediate.sql \n 
--------------------------------------------------------------- 


-- use KenticoCMS_1
-- use KenticoCMSCloudtst4

GO
PRINT 'Executing PrintImmediate.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'PrintImmediate') 
    BEGIN
        DROP PROCEDURE
             PrintImmediate
    END;
GO

CREATE PROCEDURE PrintImmediate (
       @MSG AS NVARCHAR (MAX)) 
AS
BEGIN
    RAISERROR (@MSG , 10, 1) WITH NOWAIT;
END;
GO
PRINT 'Executed PrintImmediate.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_TableHasCol.sql \n 
--------------------------------------------------------------- 


GO
PRINT 'Executing proc_TableHasCol.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_TableHasCol') 
    BEGIN
        DROP PROCEDURE
             proc_TableHasCol
    END;
GO
/*
use KenticoCMS_DataMArt
exec proc_TableHasCol base_cms_user, userid
declare @i as int = 0 ; 
exec @i = proc_TableHasCol base_cms_user, userid   
print @i
select * from sys.procedures where name like '%comma%'
*/
CREATE PROCEDURE proc_TableHasCol (
       @TblName AS NVARCHAR (100) 
     , @ColName AS NVARCHAR (100)) 
AS
BEGIN

    DECLARE
           @rc AS INT = 0;

    SET @rc = (SELECT
                      count (*) 
               FROM information_schema.columns
               WHERE
                      table_name = @TblName AND
                      column_name = @ColName) ;

    RETURN @rc;
END;

GO
PRINT 'Executed proc_TableHasCol.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_TableContainsAllCols.sql \n 
--------------------------------------------------------------- 

/*-----------------------------------------------------------
DECLARE @DelimitedString NVARCHAR(128) ;
SET @DelimitedString = 'Duckman,Cornfed,Ajax,Charles,Mambo' ;
SELECT * into #t FROM dbo.Split(@DelimitedString, ',') ;

select * from #T ;
*/
go
print 'Executing proc_TableContainsAllCols.sql ';
go
IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[Split]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
  DROP FUNCTION [dbo].[Split]
go
CREATE FUNCTION [dbo].[Split]
(
    @String NVARCHAR(4000),
    @Delimiter NCHAR(1)
)
RETURNS TABLE
AS
RETURN
(
    -- W. Dale Miller
    WITH Split(stpos,endpos)
    AS(
        SELECT 0 AS stpos, CHARINDEX(@Delimiter,@String) AS endpos
        UNION ALL
        SELECT endpos+1, CHARINDEX(@Delimiter,@String,endpos+1)
            FROM Split
            WHERE endpos > 0
    )
    SELECT 'Id' = ROW_NUMBER() OVER (ORDER BY (SELECT 1)),
        'Data' = SUBSTRING(@String,stpos,COALESCE(NULLIF(endpos,0),LEN(@String)+1)-stpos)
    FROM Split
)
GO
PRINT 'created function "split" ';
GO
IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_TableContainsAllCols') 
    BEGIN
        DROP PROCEDURE
             proc_TableContainsAllCols;
    END;
GO

/*---------------------------------------------------------------------------------
use KenticoCMS_DataMArt
exec proc_TableContainsAllCols base_cms_user, userid
declare @i as int = 0 ; 
exec @i = proc_TableContainsAllCols base_cms_user, userid   
print @i
select * from sys.procedures where name like '%comma%'

exec proc_TableContainsAllCols BASE_hfit_PPTEligibility, 'city,state, PostalCode' ;
exec proc_TableContainsAllCols BASE_hfit_PPTEligibility, 'city,state, ZipCode' ;
*/
IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_TableContainsAllCols') 
    BEGIN
        DROP PROCEDURE
             proc_TableContainsAllCols;
    END;
GO
CREATE PROCEDURE proc_TableContainsAllCols (
       @TblName AS NVARCHAR (100) 
     , @CDF_ColNames AS NVARCHAR (100)) 
AS
BEGIN

    DECLARE
           @rc AS INT = 0
         , @i AS INT = 0
         , @j AS INT = 0;

    -- SET @CDF_ColNames = 'Duckman,Cornfed,Ajax,Charles,Mambo' ;
    SELECT
           * INTO
                  #t
    FROM dbo.Split (@CDF_ColNames , ',') ;
    UPDATE #t
        SET
            data = rtrim (ltrim (data)) ;

    SET @i = (SELECT
                     count (*) 
              FROM #t) ;
    SET @j = (SELECT
                     count (*) 
              FROM information_schema.columns
              WHERE
                     table_name = @TblName AND
                     column_name IN (SELECT
                                            data
                                     FROM #t)) ;

    IF @i = @j
        BEGIN
		  print 'All cols present' ;
            SET @rc = 1;
        END;
    ELSE
        BEGIN
		  print 'All cols NOT present' ;
            SET @rc = 0;
        END;

    RETURN @rc;

END;

GO
PRINT 'Executed proc_TableContainsAllCols.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_RI_Tracker_User.sql \n 
--------------------------------------------------------------- 
-- USE [KenticoCMS_DataMart_2];

GO
PRINT 'Executing proc_RI_Tracker_User.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_RI_Tracker_User') 
    BEGIN
        DROP PROCEDURE
             proc_RI_Tracker_User;
    END;
GO
--*********************************************************************
-- exec proc_RI_Tracker_User 'YES'
CREATE PROCEDURE proc_RI_Tracker_User (
       @PreviewOnly AS NVARCHAR (10) = 'NO') 
AS
BEGIN
    DECLARE
           @TblName AS NVARCHAR (100) = ''
         , @ConstraintName AS NVARCHAR (100) = ''
         , @TrackerName AS NVARCHAR (100) = ''
         , @ColName AS NVARCHAR (100) = ''
         , @KCols AS NVARCHAR (MAX) = ''
         , @msg AS NVARCHAR (4000) = ''
         , @cmd AS NVARCHAR (4000) = ''
         , @PkeyCols AS NVARCHAR (4000) = ''
         , @DropCmd AS NVARCHAR (MAX) = ''
         , @GenCmd AS NVARCHAR (MAX) = ''
         , @MySql AS NVARCHAR (MAX) = ''
         , @FKName AS NVARCHAR (MAX) = ''
         , @iCntUserID INT = 0
         , @iCnt INT = 0
         , @iCTFlg INT = 0
         , @i INT = 0;

    DECLARE
           @TBL TABLE
           (
                      PkeyCol NVARCHAR (500) 
           );

    DECLARE
           @TBLCOLS TABLE
           (
                          TblName NVARCHAR (500) 
                        , ColName NVARCHAR (500) 
           );

    BEGIN TRY
        DROP TABLE
             #ChangeTrackingTables;
    END TRY
    BEGIN CATCH
        PRINT 'Init table #ChangeTrackingTables ';
    END CATCH;
    BEGIN TRY
        DROP TABLE
             #TableColumns;
    END TRY
    BEGIN CATCH
        PRINT 'Init table #TableColumns';
    END CATCH;
    BEGIN TRY
        DROP TABLE
             #Tables;
    END TRY
    BEGIN CATCH
        PRINT 'Init table #Tables ';
    END CATCH;

    SELECT
           sys.tables.name AS Table_name
    INTO
         #ChangeTrackingTables
    FROM
         sys.change_tracking_tables
         JOIN sys.tables
         ON
           sys.tables.object_id = sys.change_tracking_tables.object_id
         JOIN sys.schemas
         ON
           sys.schemas.schema_id = sys.tables.schema_id
    WHERE
           sys.schemas.name = 'dbo';
    --select top 100 * from information_Schema.tables
    SELECT
           table_name
         , column_name
    INTO
         #TableColumns
    FROM information_Schema.columns
    ORDER BY
             table_name , column_name;

    SELECT
           table_name
    INTO
         #Tables
    FROM information_Schema.tables
    ORDER BY
             table_name;

    DECLARE C CURSOR
        FOR
            SELECT
                   table_name
            FROM information_Schema.tables
            WHERE
            table_name NOT LIKE 'BASE_CMS_User' AND
                   TABLE_TYPE = 'BASE TABLE';

    OPEN C;

    FETCH NEXT FROM C INTO @TblName;

    WHILE
           @@FETCH_STATUS = 0
        BEGIN

            SET @msg = '--****************************************************** ';
            EXEC PrintImmediate @msg;
            SET @msg = 'Processing: ' + @TblName;
            EXEC PrintImmediate @msg;
            SET @i = 9999;
            SET @i = (SELECT
                             count (*) 
                      FROM information_schema.columns
                      WHERE
                             table_name = @TblName AND
                             column_name = 'SVR') ;
            IF @i = 0
                BEGIN
                    SET @Msg = @tblName + ' missing SVR, skipping.';
                    EXEC PrintImmediate @msg;
                    GOTO SKIPIT;
                END;
            SET @i = (SELECT
                             count (*) 
                      FROM information_schema.columns
                      WHERE
                             table_name = @TblName AND
                             column_name = 'DBNAME') ;
            IF @i = 0
                BEGIN
                    SET @Msg = @tblName + ' missing DBNAME, skipping.';
                    EXEC PrintImmediate @msg;
                    GOTO SKIPIT;
                END;
            SET @i = (SELECT
                             count (*) 
                      FROM information_schema.columns
                      WHERE
                             table_name = @TblName AND
                             column_name = 'UserID') ;
            IF @i = 0
                BEGIN
                    SET @Msg = @tblName + ' missing UserID, skipping.';
                    EXEC PrintImmediate @msg;
                    GOTO SKIPIT;
                END;

            SET @ConstraintName = 'FK_' + @TblName + '_BASE_cms_user';

            --CHECK if FK Constraint exists, skip it
            SET @iCnt = (SELECT
                                count (*) 
                         FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS
                         WHERE
                                CONSTRAINT_NAME = @ConstraintName) ;

            IF @iCnt > 0
                BEGIN
                    SET @msg = 'Already Exists: RI Between ' + @TblName + ' and CMS_USER.' + char (10) + @MySql;
                    EXEC PrintImmediate @msg;
                    GOTO SKIPIT;
                END;

            --EXAMPLE Code:
            --ALTER TABLE BASE_HFit_HealthAssesmentUserRiskCategory 
            --ADD CONSTRAINT FK_BASE_HFit_HealthAssesmentUserRiskCategory_BASE_cms_user 
            --FOREIGN KEY (SVR, DBNAME, UserID)
            --REFERENCES BASE_cms_user(SVR, DBNAME, UserID) ON DELETE CASCADE ON UPDATE CASCADE  NOT FOR REPLICATION		  

            DECLARE
                   @SKEYNAME AS NVARCHAR (250) = 'Surrogate';
            SET @SKEYNAME = @SKEYNAME + substring (@TblName , charindex ('_' , @TblName) , 999) ;
            PRINT '@SKEYNAME = ' + @SKEYNAME;


            SET @i = (SELECT
                             count (*) 
                      FROM information_schema.columns
                      WHERE
                             table_name = @TblName AND
                             column_name = 'SurrogateKey_cms_user') ;

            IF @i = 0
                BEGIN
                    SET @Msg = '-- Adding SurrogateKey_cms_user to ' + @TblName;
                    EXEC PrintImmediate @msg;
                    SET @MySql = 'Alter table ' + @TblName + ' add SurrogateKey_cms_user bigint null ; ';
                    EXEC PrintImmediate @MySql;
                    IF
                           @PreviewOnly = 'NO'
                        BEGIN
                            EXEC (@MySql) 
                        END;
                END;

            -- create the RI Reference 
            SET @MySql = 'ALTER TABLE [dbo].[' + @TblName + ']  WITH NOCHECK  ' + char (10) ;
            SET @MySql = @MySql + ' ADD  CONSTRAINT [' + @ConstraintName + ']  ' + char (10) ;
            --SET @MySql = @MySql + ' FOREIGN KEY([SVR], [DBNAME], [UserID]) ' + char (10) ;
            SET @MySql = @MySql + ' FOREIGN KEY(SurrogateKey_cms_user) ' + char (10) ;
            --SET @MySql = @MySql + ' REFERENCES [dbo].[BASE_cms_user] ([SVR], [DBNAME], [UserID]) ' + char (10) ;
            SET @MySql = @MySql + ' REFERENCES [dbo].[BASE_cms_user] (SurrogateKey_cms_user) ' + char (10) ;
            SET @MySql = @MySql + ' ON DELETE CASCADE ON UPDATE CASCADE ' + char (10) ;
            SET @MySql = @MySql + ' NOT FOR REPLICATION' + char (10) ;

            BEGIN TRY
                EXEC PrintImmediate @MySql;
                IF
                       @PreviewOnly = 'NO'
                    BEGIN
                        EXEC (@MySql) ;
                    END;
                SET @msg = 'ADDED RI Between ' + @TblName + ' and CMS_USER.';
                EXEC PrintImmediate @msg;
            END TRY
            BEGIN CATCH
                SET @msg = 'FAILED: RI Between ' + @TblName + ' and CMS_USER.' + char (10) + @MySql;
                EXEC PrintImmediate @msg;
            END CATCH;

            SKIPIT:

            --if charindex('_DEL', @TblName) > 0 -- and @i != 0 
            --begin
            --set @i = charindex('_DEL', @TblName) - 1 ;
            --declare @ParentTable nvarchar(100) = substring(@TblName,1,@i) ;
            --print '@ParentTable: ' + @ParentTable ;

            --set @ConstraintName = 'Ref_' + @ParentTable +'_Hist' ;
            --SET @iCnt = (SELECT
            --                            count (*) 
            --                     FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS
            --                     WHERE
            --                            CONSTRAINT_NAME = @ConstraintName) ;

            --IF @iCnt = 0
            --BEGIN								
            ----BASE_HFit_TrackerBMI_DEL
            --set @MySql = '' ;
            --SET @MySql = @MySql + ' ALTER TABLE '+@TblName+' ADD CONSTRAINT ' + @ConstraintName + char(10) ;
            --SET @MySql = @MySql + '     FOREIGN KEY (ItemID, UserID, TrackerName, SVR, DBNAME) ' + char(10) ;
            --SET @MySql = @MySql + '     REFERENCES '+@ParentTable+'(ItemID, UserID, TrackerName, SVR, DBNAME) ' + char(10) ;
            --SET @MySql = @MySql + ' NOT FOR REPLICATION' + char (10) ;
            --print 'HIST: ' + @MySql;
            --end ;
            --end; 

            FETCH NEXT FROM C INTO @TblName;

        END;

    PRINT 'RUN COMPLETE.';
    CLOSE C;
    DEALLOCATE C;
END;

GO
PRINT 'Executed proc_RI_Tracker_User.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_PULL_ALL_Tracker_StoredProceduresFromDB.sql \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_DataMart_2
PRINT 'Executing proc_PULL_ALL_Tracker_StoredProceduresFromDB.sql';
GO
IF EXISTS (SELECT
              name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_PULL_ALL_Tracker_StoredProceduresFromDB') 
    BEGIN
        DROP PROCEDURE
           proc_PULL_ALL_Tracker_StoredProceduresFromDB
    END;
GO

-- bcp AdventureWorks2008R2.Sales.Currency out Currency.dat -c -U<login_id> -S<server_name\instance_name>
-- exec proc_PULL_ALL_Tracker_StoredProceduresFromDB
CREATE PROCEDURE proc_PULL_ALL_Tracker_StoredProceduresFromDB
AS
BEGIN

    DECLARE
           @source_code VARCHAR (MAX) 
         , @TSQL VARCHAR (MAX) = ' '
         , @msg VARCHAR (MAX) 
         , @ProcName VARCHAR (500) 
         , @ddl VARCHAR (MAX) 
         , @Header VARCHAR (MAX) ;
    -- drop table #t
    CREATE TABLE #T (
       line VARCHAR (MAX)) ;
    DECLARE
           @procs TABLE (
       StoredProcedure VARCHAR (MAX)) ;

    DECLARE C CURSOR
        FOR
            SELECT
               name
                   FROM sys.procedures
                   WHERE
                   name LIKE 'proc_CT%' AND
                   name LIKE '%Tracker%';

    OPEN C;

    FETCH NEXT FROM C INTO @ProcName;

    WHILE
           @@FETCH_STATUS = 0
        BEGIN
            SET @msg = 'Processing: ' + @ProcName;
            EXEC PrintImmediate @msg;
            SET @Header = '--********************************************************' + char (10) ;
            SET @Header = @Header + '-- Procedure: ' + @ProcName + char (10) ;
            SET @Header = @Header + '-- Author   : W.Dale Miller' + char (10) ;
            SET @Header = @Header + '-- Pull Date: ' + cast (getdate () AS NVARCHAR (50)) + char (10) ;
            SET @Header = @Header + '--********************************************************' + char (10) ;
		  SET @Header = @Header + 'go ' + char(10) ;
		  SET @Header = @Header + 'if exists (select name from sys.procedures where name = '''+@ProcName+''') ' + char(10) ;
		  SET @Header = @Header + '    drop procedure '+@ProcName+' ; ' + char(10) ;
		  SET @Header = @Header + 'go' + char(10)
            SET @Header = @Header + '--********************************************************' + char (10) ;
            SELECT
               @source_code = definition
                   FROM sys.sql_modules
                   WHERE
                   object_id = object_id (@ProcName) ;

            PRINT '001 ';
            SET @msg = 'truncate table #T ';
            EXEC (@msg) ;
            PRINT '002 ';

            INSERT INTO #T
            EXEC sp_helptext @ProcName;

            SET @ddl = '';
            SELECT
               @ddl = @ddl + line
                   FROM #T;

            SET @msg = @Header + @ddl + char (10) + 'GO' + char (10) ;
            INSERT INTO @procs (
               StoredProcedure) 
            VALUES ( @msg) ;

            --SET @TSQL = @TSQL + @Header + @ddl + char (10) + char (10) ;
            --EXEC PrintImmediate @Header;
            --EXEC PrintImmediate @source_code;
            --exec PrintImmediate @TSQL ;
            FETCH NEXT FROM C INTO @ProcName;
        END;
    CLOSE C;
    DEALLOCATE C;
    -- SELECT @TSql;
    -- SELECT * FROM #T;
    SELECT
       *
           FROM @procs;
END;
GO
PRINT 'Executed proc_PULL_ALL_Tracker_StoredProceduresFromDB.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: Create_FACT_EDW_TrackerCompositeDetails.sql \n 
--------------------------------------------------------------- 

-- use KenticoCMS_DataMart_2

/*----------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------
drop table FACT_EDW_TrackerCompositeDetails
set rowcount 500

-- truncate table FACT_EDW_TrackerCompositeDetails
-- delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerCardio'

select count(*) from FACT_EDW_TrackerCompositeDetails
select top 100 * from FACT_EDW_TrackerCompositeDetails
*/

GO
PRINT 'Executing Create_FACT_EDW_TrackerCompositeDetails.sql';
GO

/*
IF EXISTS (SELECT
                  name
           FROM sys.tables
           WHERE
                  name = 'FACT_EDW_TrackerCompositeDetails') 
    BEGIN
        DROP TABLE
             dbo.FACT_EDW_TrackerCompositeDetails;
    END;
GO
*/
SET ANSI_NULLS ON;
GO

SET QUOTED_IDENTIFIER ON;
GO
IF NOT EXISTS (SELECT
                      name
               FROM sys.tables
               WHERE
                      name = 'FACT_EDW_TrackerCompositeDetails') 
    BEGIN
        CREATE TABLE dbo.FACT_EDW_TrackerCompositeDetails (
                     TrackerNameAggregateTable NVARCHAR (100) NOT NULL
                   , ItemID INT NOT NULL
                   , EventDate DATETIME NULL
                   , IsProfessionallyCollected BIT NULL
                   , TrackerCollectionSourceID INT NULL
                   , Notes NVARCHAR (1000) NULL
                   , UserID INT NULL
                   , CollectionSourceName_Internal NVARCHAR (100) NULL
                   , CollectionSourceName_External NVARCHAR (100) NULL
                   , EventName NVARCHAR (100) NULL
                   , UOM NVARCHAR (100) NULL
                   , KEY1 NVARCHAR (100) NULL
                   , VAL1 FLOAT NULL
                   , KEY2 NVARCHAR (8) NULL
                   , VAL2 FLOAT NULL
                   , KEY3 NVARCHAR (100) NULL
                   , VAL3 FLOAT NULL
                   , KEY4 NVARCHAR (100) NULL
                   , VAL4 FLOAT NULL
                   , KEY5 NVARCHAR (100) NULL
                   , VAL5 FLOAT NULL
                   , KEY6 NVARCHAR (100) NULL
                   , VAL6 INT NULL
                   , KEY7 NVARCHAR (100) NULL
                   , VAL7 INT NULL
                   , KEY8 NVARCHAR (100) NULL
                   , VAL8 INT NULL
                   , KEY9 NVARCHAR (100) NULL
                   , VAL9 INT NULL
                   , KEY10 NVARCHAR (100) NULL
                   , VAL10 INT NULL
                   , ItemCreatedBy INT NULL
                   , ItemCreatedWhen DATETIME NULL
                   , ItemModifiedBy INT NULL
                   , ItemModifiedWhen DATETIME NULL
                   , IsProcessedForHa INT NULL
                   , TXTKEY1 NVARCHAR (100) NULL
                   , TXTVAL1 INT NULL
                   , TXTKEY2 NVARCHAR (100) NULL
                   , TXTVAL2 INT NULL
                   , TXTKEY3 NVARCHAR (100) NULL
                   , TXTVAL3 INT NULL
                   , ItemOrder INT NULL
                   , ItemGuid INT NULL
                   , UserGuid UNIQUEIDENTIFIER NULL
                   , MPI NVARCHAR (100) NULL
                   , ClientCode NVARCHAR (100) NULL
                   , SiteGUID UNIQUEIDENTIFIER NULL
                   , AccountID INT NULL
                   , AccountCD NVARCHAR (100) NULL
                   , IsAvailable BIT NULL
                   , IsCustom BIT NULL
                   , UniqueName NVARCHAR (100) NULL
                   , ColDesc NVARCHAR (100) NULL
                   , VendorID INT NULL
                   , VendorName INT NULL
                   , LastModifiedDate DATETIME NULL
                   , SVR NVARCHAR (100) NOT NULL
                   , DBNAME NVARCHAR (100) NOT NULL
                   , RowNumber INT IDENTITY (1 , 1) 
                                   NOT NULL
                   , SurrogateKey INT NULL
        ) 
        ON [PRIMARY]
    END;
GO
IF NOT EXISTS (SELECT
                      name
               FROM sys.indexes
               WHERE
                      name = 'PKEY_FACT_TrackerData') 
    BEGIN
        CREATE UNIQUE INDEX PKEY_FACT_TrackerData ON dbo.FACT_EDW_TrackerCompositeDetails
        (
        ItemID ASC ,
        SVR ,
        DBNAME
        )INCLUDE (AccountCD , TrackerNameAggregateTable) ;
    END;
GO
IF NOT EXISTS (SELECT
                      name
               FROM sys.indexes
               WHERE
                      name = 'PKEY_FACT_TrackerData_Recno') 
    BEGIN
        CREATE INDEX PKEY_FACT_TrackerData_Recno ON dbo.FACT_EDW_TrackerCompositeDetails
        (
        RowNumber
        ) INCLUDE (TrackerNameAggregateTable) ;
    END;
GO
-- ADD THE Surrogate KEYS
DECLARE
       @CMD AS NVARCHAR (4000) 
     , @TblName  AS NVARCHAR (250) 
     , @ColName  AS NVARCHAR (250) ;
DECLARE C CURSOR
    FOR
        SELECT
               table_name AS TableName
             , column_name AS ColumnNme
             , 'alter table FACT_EDW_TrackerCompositeDetails add ' + column_name + ' bigint null ;' AS CMD
        FROM information_schema.columns
        WHERE
        table_name LIKE 'BASE_Hfit_track%' AND
        column_name LIKE 'SurrogateKey_%';

OPEN C;

FETCH NEXT FROM C INTO @TblName , @ColName , @CMD;

WHILE
       @@FETCH_STATUS = 0
    BEGIN

        BEGIN TRY
            IF NOT EXISTS (SELECT
                                  column_name
                           FROM information_schema.columns
                           WHERE
                                  column_name = @ColName AND
                                  Table_name = 'FACT_EDW_TrackerCompositeDetails') 
                BEGIN
                    EXEC (@CMD) ;
                    PRINT 'SUCCESS: ' + @CMD;
                END;
            ELSE
                BEGIN
                    PRINT 'ALREADY EXISTS - Skipping: ' + @CMD;
                END;
        END TRY
        BEGIN CATCH
            PRINT 'FAILED: ' + @CMD;
        END CATCH;

        --declare @FKeyName as nvarchar(500) ;
        --set @FKeyName = 'FKEY_TrackerCompositeDetails_TO_'+@TblName ;
        --print @FKeyName ;

        --ALTER TABLE FACT_EDW_TrackerCompositeDetails
        --ADD CONSTRAINT @FKeyName FOREIGN KEY(@TblName)REFERENCES @TblName(ProductID)

        FETCH NEXT FROM C INTO @TblName , @ColName , @CMD;
    END;
CLOSE C;
DEALLOCATE C;

GO
PRINT 'Executed Create_FACT_EDW_TrackerCompositeDetails.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: MASTER_LKP_CTVersion.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing MASTER_LKP_CTVersion.SQL';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE
                  name = 'MASTER_LKP_CTVersion') 
    BEGIN
        DROP TABLE
             MASTER_LKP_CTVersion;
    END;

GO

CREATE TABLE dbo.MASTER_LKP_CTVersion (
             ProcedureID NVARCHAR (100) NOT NULL
           , SYS_CHANGE_VERSION BIGINT NOT NULL
           , TableName NVARCHAR (100) NOT NULL
           , CONSTRAINT PK_MASTER_LKP_CTVersion PRIMARY KEY CLUSTERED
             (
             ProcedureID ASC ,
             TableName ASC ,
             SYS_CHANGE_VERSION ASC
             ) 
                 WITH (PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , IGNORE_DUP_KEY = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) 
ON [PRIMARY];

create unique index UK_MASTER_LKP_CTVersion on MASTER_LKP_CTVersion (ProcedureID, SYS_CHANGE_VERSION);

GO
PRINT 'Executed MASTER_LKP_CTVersion.SQL';
GO
-- FATAL ERROR : FILE MISSING proc_GetTableIndexes.sql \n 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_SetTrackerPrimaryKey.sql \n 
--------------------------------------------------------------- 


GO
PRINT 'Executing proc_SetTrackerPrimaryKey.sql';
GO
IF EXISTS (SELECT
              name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_SetTrackerPrimaryKey') 
    BEGIN
        DROP PROCEDURE
           proc_SetTrackerPrimaryKey;
    END;
GO

CREATE PROCEDURE proc_SetTrackerPrimaryKey (@TblName AS NVARCHAR (100)) 
AS
BEGIN
    DECLARE
           @MySql AS NVARCHAR (MAX) = '';

    SET @MySql = 'ALTER TABLE [dbo].' + @TblName + ' drop CONSTRAINT ' + @TblName + '_PKID';

    BEGIN TRY
        EXEC (@MySql) ;
        PRINT 'Successfully DROPPED PKEY for ' + @TblName;
    END TRY
    BEGIN CATCH
        PRINT 'ERROR: Failed to DROP PKEY for ' + @TblName;
    END CATCH;

    SET @MySql = 'ALTER TABLE [dbo].' + @TblName + ' ADD  CONSTRAINT ' + @TblName + '_PKID PRIMARY KEY CLUSTERED ' + CHAR (10) ;
    SET @MySql = @MySql + '( ' + CHAR (10) ;
    SET @MySql = @MySql + '	TrackerNameAggregateTable,  ' + CHAR (10) ;
    SET @MySql = @MySql + '     [SVR] ASC, ' + CHAR (10) ;
    SET @MySql = @MySql + '	[DBNAME] ASC, ' + CHAR (10) ;
    SET @MySql = @MySql + '	[UserID] ASC, ' + CHAR (10) ;
    SET @MySql = @MySql + '	[ItemID] ASC ' + CHAR (10) ;
    SET @MySql = @MySql + ') ' + CHAR (10) ;

    BEGIN TRY
        EXEC (@MySql) ;
        PRINT 'Successfully modified PKEY for ' + @TblName;
    END TRY
    BEGIN CATCH
        PRINT 'ERROR: Failed to modify PKEY for ' + @TblName;
    END CATCH;

END;

GO
PRINT 'Executed proc_SetTrackerPrimaryKey.sql';
GO


--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerSitLess
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerSleepPlan
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerStrength
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerStress
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerStressManagement
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerSugaryDrinks
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerSugaryFoods
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerTobaccoFree
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerVegetables
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerHeight
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerWater
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerWeight
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerWholeGrains
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerCotinine
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerPreventiveCare
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerCardio
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerTobaccoAttestation
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerMedicalCarePlan
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerRegularMeals
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerRestingHeartRate
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerBloodSugarAndGlucose
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerBloodPressure

--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerBMI

--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerBodyFat
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerBodyMeasurements
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerDailySteps
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerHbA1c
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerHighFatFoods
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerHighSodiumFoods

--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerInstance_Tracker

--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerCholesterol
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerMealPortions
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerFlexibility
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerFruits
--exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerSho
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: populate_Tracker_FACT_Tables.sql \n 
--------------------------------------------------------------- 
--drop table FACT_HFit_TrackerRegularMeals ;
--drop table FACT_HFit_TrackerRestingHeartRate ;
--drop table FACT_HFit_TrackerMedicalCarePlan ;

/*
use KenticoCMS_Datamart_2

select * from information_schema.tables where table_name like '%HFit_Tracker%' and table_type = 'BASE TABLE'

select 'IF (Select count(*) from dbo.' + table_name + ')  = 0 drop table ' + table_name from information_schema.tables 
where 
table_name like 'FACT_HFit_Tracker%'
*/
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerBloodPressure';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerBloodPressure;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerBloodPressure') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerBloodPressure';
        SELECT 
               'HFit_TrackerBloodPressure' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'mm/Hg' AS UOM
             , 'Systolic' AS KEY1
             , CAST ( Systolic AS FLOAT) AS VAL1
             , 'Diastolic' AS KEY2
             , CAST ( Diastolic AS FLOAT) AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , ISNULL ( T.UniqueName , 'bp') AS UniqueName
             , ISNULL ( T.UniqueName , 'bp') AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerBloodPressure
               FROM dbo.BASE_HFit_TrackerBloodPressure AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerBloodPressure'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    END;

GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerBloodSugarAndGlucose';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerBloodSugarAndGlucose;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerBloodSugarAndGlucose') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerBloodSugarAndGlucose';
        SELECT
               'HFit_TrackerBloodSugarAndGlucose' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'mmol/L' AS UOM
             , 'Units' AS KEY1
             , CAST ( Units AS FLOAT) AS VAL1
             , 'FastingState' AS KEY2
             , CAST ( FastingState AS FLOAT) AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , ISNULL ( T.UniqueName , 'glucose') AS UniqueName
             , ISNULL ( T.UniqueName , 'glucose') AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerBloodSugarAndGlucose
               FROM dbo.BASE_HFit_TrackerBloodSugarAndGlucose AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerBMI';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerBMI;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerBMI') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerBMI';
        SELECT
               'HFit_TrackerBMI' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'kg/m2' AS UOM
             , 'BMI' AS KEY1
             , CAST ( BMI AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , 0 AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , TT.ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS UniqueName
             , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerBMI
               FROM dbo.BASE_HFit_TrackerBMI AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerBMI'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerBodyFat';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerBodyFat;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerBodyFat') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerBodyFat';
        SELECT
               'HFit_TrackerBodyFat' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'PCT' AS UOM
             , 'Value' AS KEY1
             , CAST ( [Value] AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , 0 AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS UniqueName
             , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerBodyFat
               FROM dbo.BASE_HFit_TrackerBodyFat AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerBodyFat'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    END;

GO
--set rowcount 5 ;
--******************************************************************************
EXEC PrintImmediate 'Processing FACT_HFit_TrackerBodyMeasurements';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerBodyMeasurements;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerBodyMeasurements') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerBodyMeasurements';
        SELECT
               'HFit_TrackerBodyMeasurements' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Inch' AS UOM
             , 'WaistInches' AS KEY1
             , CAST ( WaistInches AS FLOAT) AS VAL1
             , 'HipInches' AS KEY2
             , CAST ( HipInches AS FLOAT) AS VAL2
             , 'ThighInches' AS KEY3
             , CAST ( ThighInches AS FLOAT) AS VAL3
             , 'ArmInches' AS KEY4
             , CAST ( ArmInches AS FLOAT) AS VAL4
             , 'ChestInches' AS KEY5
             , CAST ( ChestInches AS FLOAT) AS VAL5
             , 'CalfInches' AS KEY6
             , CAST ( CalfInches AS FLOAT) AS VAL6
             , 'NeckInches' AS KEY7
             , CAST ( NeckInches AS FLOAT) AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerBodyMeasurements
               FROM dbo.BASE_HFit_TrackerBodyMeasurements AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    --******************************************************************************
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerCardio';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerCardio;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerCardio') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerCardio';
        SELECT
               'HFit_TrackerCardio' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'NA' AS UOM
             , 'Minutes' AS KEY1
             , CAST ( Minutes AS FLOAT) AS VAL1
             , 'Distance' AS KEY2
             , CAST ( Distance AS FLOAT) AS VAL2
             , 'DistanceUnit' AS KEY3
             , CAST ( DistanceUnit AS FLOAT) AS VAL3
             , 'Intensity' AS KEY4
             , CAST ( Intensity AS FLOAT) AS VAL4
             , 'ActivityID' AS KEY5
             , CAST ( ActivityID AS FLOAT) AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             , NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerCardio
               FROM dbo.BASE_HFit_TrackerCardio AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerCardio'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
               --the following where clause was added on 11/23/2015 as a result of BAD DATA from the PPT
               WHERE
               EventDate > '01/01/1960';
    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerCholesterol';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerCholesterol;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerCholesterol') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerCholesterol';
        SELECT
               'HFit_TrackerCholesterol' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'mg/dL' AS UOM
             , 'HDL' AS KEY1
             , CAST ( HDL AS FLOAT) AS VAL1
             , 'LDL' AS KEY2
             , CAST ( LDL AS FLOAT) AS VAL2
             , 'Total' AS KEY3
             , CAST ( Total AS FLOAT) AS VAL3
             , 'Tri' AS KEY4
             , CAST ( Tri AS FLOAT) AS VAL4
             , 'Ratio' AS KEY5
             , CAST ( Ratio AS FLOAT) AS VAL5
             , 'Fasting' AS KEY6
             , CAST ( Fasting AS FLOAT) AS VAL6
             , 'VLDL' AS KEY7
             , CAST ( VLDL AS FLOAT) AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS UniqueName
             , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerCholesterol
               FROM dbo.BASE_HFit_TrackerCholesterol AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerCholesterol'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    truncate table FACT_HFit_TrackerCholesterol ;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerDailySteps';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerDailySteps;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerDailySteps') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerDailySteps';
        SELECT
               'HFit_TrackerDailySteps' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Step' AS UOM
             , 'Steps' AS KEY1
             , CAST ( Steps AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS UniqueName
             , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerDailySteps
               FROM dbo.BASE_HFit_TrackerDailySteps AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerDailySteps'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerFlexibility';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerFlexibility;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerFlexibility') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerFlexibility';
        SELECT
               'HFit_TrackerFlexibility' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Y/N' AS UOM
             , 'HasStretched' AS KEY1
             , CAST ( HasStretched AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'Activity' AS TXTKEY1
             , Activity AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerFlexibility
               FROM dbo.BASE_HFit_TrackerFlexibility AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerFlexibility'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerFruits';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerFruits;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerFruits') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerFruits';
        SELECT
               'HFit_TrackerFruits' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'CUP(8oz)' AS UOM
             , 'Cups' AS KEY1
             , CAST ( Cups AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerFruits
               FROM dbo.BASE_HFit_TrackerFruits AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerFruits'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
--drop table FACT_HFit_TrackerHbA1c
EXEC PrintImmediate 'Processing FACT_HFit_TrackerHbA1c';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerHbA1c;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerHbA1c') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerHbA1c';
        SELECT
               'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'mmol/mol' AS UOM
             , 'Value' AS KEY1
             , CAST ( [Value] AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerHbA1c
               FROM dbo.BASE_HFit_TrackerHbA1c AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerHbA1c'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerHeight';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerHeight;
EXEC proc_QuickRowCount FACT_HFit_TrackerHeight;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerHeight') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerHeight';
        SELECT
               'HFit_TrackerHeight' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'inch' AS UOM
             , 'Height' AS KEY1
             , Height AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , TT.ItemOrder
             , TT.ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS UniqueName
             , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerHeight
               FROM dbo.BASE_HFit_TrackerHeight AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerHeight'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerHighFatFoods';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerHighFatFoods;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerHighFatFoods') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerHighFatFoods';
        SELECT
               'HFit_TrackerHighFatFoods' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Occurs' AS UOM
             , 'Times' AS KEY1
             , CAST ( Times AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             , NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerHighFatFoods
               FROM dbo.BASE_HFit_TrackerHighFatFoods AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerHighFatFoods'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerHighSodiumFoods';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerHighSodiumFoods;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerHighSodiumFoods') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerHighSodiumFoods';
        SELECT
               'HFit_TrackerHighSodiumFoods' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Occurs' AS UOM
             , 'Times' AS KEY1
             , CAST ( Times AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerHighSodiumFoods
               FROM dbo.BASE_HFit_TrackerHighSodiumFoods AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerHighSodiumFoods'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerInstance_Tracker';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerInstance_Tracker;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerInstance_Tracker') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerInstance_Tracker';
        SELECT
               'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Y/N' AS UOM
             , 'TrackerDefID' AS KEY1
             , CAST (TrackerDefID AS FLOAT) AS VAL1
             , 'YesNoValue' AS KEY2
             , CAST (YesNoValue AS FLOAT) AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID
             , NULL AS VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerInstance_Tracker
               FROM dbo.BASE_HFit_TrackerInstance_Tracker AS TT
                        INNER JOIN dbo.BASE_HFit_TrackerDef_Tracker AS TDT
                            ON TDT.trackerid = TT.trackerDefID
                           AND TDT.SVR = TT.SVR
                           AND TDT.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerInstance_Tracker'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                           AND T.DBNAME = TDT.DBNAME
                           AND T.SVR = TDT.SVR;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerMealPortions';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerMealPortions;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerMealPortions') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerMealPortions';
        SELECT
               'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'NA-portion' AS UOM
             , 'Portions' AS KEY1
             , CAST ( Portions AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerMealPortions
               FROM dbo.BASE_HFit_TrackerMealPortions AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerMealPortions'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerMedicalCarePlan';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerMedicalCarePlan;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerMedicalCarePlan') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerMedicalCarePlan';
        SELECT
               'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Y/N' AS UOM
             , 'FollowedPlan' AS KEY1
             , CAST ( FollowedPlan AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             , NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerMedicalCarePlan
               FROM dbo.BASE_HFit_TrackerMedicalCarePlan AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerMedicalCarePlan'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerRegularMeals';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerRegularMeals;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerRegularMeals') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerRegularMeals';
        SELECT
               'HFit_TrackerRegularMeals' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Occurs' AS UOM
             , 'Units' AS KEY1
             , CAST ( Units AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerRegularMeals
               FROM dbo.BASE_HFit_TrackerRegularMeals AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerRegularMeals'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerRestingHeartRate';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerRestingHeartRate;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerRestingHeartRate') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerRestingHeartRate';
        SELECT
               'HFit_TrackerRestingHeartRate' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'BPM' AS UOM
             , 'HeartRate' AS KEY1
             , CAST ( HeartRate AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerRestingHeartRate
               FROM dbo.BASE_HFit_TrackerRestingHeartRate AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerShots';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerShots;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerShots') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerShots';
        SELECT
               'HFit_TrackerShots' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Y/N' AS UOM
             , 'FluShot' AS KEY1
             , CAST ( FluShot AS FLOAT) AS VAL1
             , 'PneumoniaShot' AS KEY2
             , CAST ( PneumoniaShot AS FLOAT) AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , TT.ItemOrder
             , TT.ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerShots
               FROM dbo.BASE_HFit_TrackerShots AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerShots'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerSitLess';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerSitLess;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerSitLess') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerSitLess';
        SELECT
               'HFit_TrackerSitLess' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Occurs' AS UOM
             , 'Times' AS KEY1
             , CAST ( Times AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerSitLess
               FROM dbo.BASE_HFit_TrackerSitLess AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerSitLess'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerSleepPlan';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerSleepPlan;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerSleepPlan') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerSleepPlan';
        SELECT
               'HFit_TrackerSleepPlan' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'HR' AS UOM
             , 'DidFollow' AS KEY1
             , CAST ( DidFollow AS FLOAT) AS VAL1
             , 'HoursSlept' AS KEY2
             , HoursSlept AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'Techniques' AS TXTKEY1
             , Techniques AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerSleepPlan
               FROM dbo.BASE_HFit_TrackerSleepPlan AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerSleepPlan'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerStrength';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerStrength;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerStrength') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerStrength';
        SELECT
               'HFit_TrackerStrength' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Y/N' AS UOM
             , 'HasTrained' AS KEY1
             , CAST ( HasTrained AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'Activity' AS TXTKEY1
             , Activity AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerStrength
               FROM dbo.BASE_HFit_TrackerStrength AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerStrength'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerStress';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerStress;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerStress') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerStress';
        SELECT
               'HFit_TrackerStress' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'gradient' AS UOM
             , 'Intensity' AS KEY1
             , CAST ( Intensity AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'Awareness' AS TXTKEY1
             , Awareness AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerStress
               FROM dbo.BASE_HFit_TrackerStress AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerStress'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerStressManagement';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerStressManagement;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerStressManagement') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerStressManagement';
        SELECT
               'HFit_TrackerStressManagement' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'gradient' AS UOM
             , 'HasPracticed' AS KEY1
             , CAST ( HasPracticed AS FLOAT) AS VAL1
             , 'Effectiveness' AS KEY2
             , CAST ( Effectiveness AS FLOAT) AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'Activity' AS TXTKEY1
             , Activity AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerStressManagement
               FROM dbo.BASE_HFit_TrackerStressManagement AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerStressManagement'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerSugaryDrinks';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerSugaryDrinks;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerSugaryDrinks') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerSugaryDrinks';
        SELECT
               'HFit_TrackerSugaryDrinks' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'OZ' AS UOM
             , 'Ounces' AS KEY1
             , CAST ( Ounces AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerSugaryDrinks
               FROM dbo.BASE_HFit_TrackerSugaryDrinks AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerSugaryDrinks'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerSugaryFoods';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerSugaryFoods;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerSugaryFoods') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerSugaryFoods';
        SELECT
               'HFit_TrackerSugaryFoods' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'NA-portion' AS UOM
             , 'Portions' AS KEY1
             , CAST ( Portions AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerSugaryFoods
               FROM dbo.BASE_HFit_TrackerSugaryFoods AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerSugaryFoods'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerTests';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerTests;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerTests') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerTests';
        SELECT
               'HFit_TrackerTests' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'NA' AS UOM
             , 'PSATest' AS KEY1
             , CAST ( PSATest AS FLOAT) AS VAL1
             , 'OtherExam' AS KEY1
             , CAST ( OtherExam AS FLOAT) AS VAL2
             , 'TScore' AS KEY3
             , CAST ( TScore AS FLOAT) AS VAL3
             , 'DRA' AS KEY4
             , CAST ( DRA AS FLOAT) AS VAL4
             , 'CotinineTest' AS KEY5
             , CAST ( CotinineTest AS FLOAT) AS VAL5
             , 'ColoCareKit' AS KEY6
             , CAST ( ColoCareKit AS FLOAT) AS VAL6
             , 'CustomTest' AS KEY7
             , CAST ( CustomTest AS FLOAT) AS VAL7
             , 'TSH' AS KEY8
             , CAST ( TSH AS FLOAT) AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'CustomDesc' AS TXTKEY1
             , CustomDesc AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , TT.ItemOrder
             , TT.ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerTests
               FROM dbo.BASE_HFit_TrackerTests AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerTests'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerTobaccoFree';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerTobaccoFree;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerTobaccoFree') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerTobaccoFree';
        SELECT
               'HFit_TrackerTobaccoFree' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'Y/N' AS UOM
             , 'WasTobaccoFree' AS KEY1
             , CAST ( WasTobaccoFree AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'QuitAids' AS TXTKEY1
             , QuitAids AS TXTVAL1
             , 'QuitMeds' AS TXTKEY2
             , QuitMeds AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerTobaccoFree
               FROM dbo.BASE_HFit_TrackerTobaccoFree AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerTobaccoFree'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerVegetables';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerVegetables;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerVegetables') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerVegetables';
        SELECT
               'HFit_TrackerVegetables' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'CUP(8oz)' AS UOM
             , 'Cups' AS KEY1
             , CAST ( Cups AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerVegetables
               FROM dbo.BASE_HFit_TrackerVegetables AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerVegetables'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerWater';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerWater;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerWater') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerWater';
        SELECT
               'HFit_TrackerWater' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'OZ' AS UOM
             , 'Ounces' AS KEY1
             , CAST ( Ounces AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerWater
               FROM dbo.BASE_HFit_TrackerWater AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerWater'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerWeight';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerWeight;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerWeight') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerWeight';
        SELECT
               'HFit_TrackerWeight' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'LBS' AS UOM
             , 'Value' AS KEY1
             , [Value] AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , VENDOR.ItemID AS VendorID
             , VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerWeight
               FROM dbo.BASE_HFit_TrackerWeight AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerWeight'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                            ON TT.DBNAME = VENDOR.DBNAME
                           AND TT.SVR = VENDOR.SVR
                           AND TT.VendorID = Vendor.ItemID;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerWholeGrains';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerWholeGrains;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerWholeGrains') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerWholeGrains';
        SELECT
               'HFit_TrackerWholeGrains' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , CollectionSourceName_Internal
             , CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'NA-serving' AS UOM
             , 'Servings' AS KEY1
             , CAST ( Servings AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , NULL AS IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , NULL AS VendorID	--VENDOR.ItemID as VendorID
             ,
               NULL AS VendorName --VENDOR.VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerWholeGrains
               FROM dbo.BASE_HFit_TrackerWholeGrains AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerWholeGrains'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerCotinine';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerCotinine;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerCotinine') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerCotinine';
        SELECT
               'HFit_TrackerCotinine' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , NULL AS CollectionSourceName_Internal
             , NULL AS CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'NA' AS UOM
             , 'NicotineAssessment' AS KEY1
             , CAST ( NicotineAssessment AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , --VENDOR.ItemID AS VendorID ,
               --VENDOR.VendorName,
               NULL AS VendorID
             , NULL AS VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerCotinine
               FROM dbo.BASE_HFit_TrackerCotinine AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerCotinine'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
    --	ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR;

    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerPreventiveCare';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerPreventiveCare;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerPreventiveCare') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerPreventiveCare';
        SELECT
               'HFit_TrackerPreventiveCare' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , NULL AS CollectionSourceName_Internal
             , NULL AS CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'NA' AS UOM
             , 'PreventiveCare' AS KEY1
             , CAST ( PreventiveCare AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , --VENDOR.ItemID AS VendorID ,
               --VENDOR.VendorName,
               NULL AS VendorID
             , NULL AS VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerPreventiveCare
               FROM dbo.BASE_HFit_TrackerPreventiveCare AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerPreventiveCare'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;

    --LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
    --	ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR;
    END;
GO
--set rowcount 5 ;
EXEC PrintImmediate 'Processing FACT_HFit_TrackerTobaccoAttestation';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerTobaccoAttestation;
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'FACT_HFit_TrackerTobaccoAttestation') 
    BEGIN
        EXEC PrintImmediate '*** Loading Records: FACT_HFit_TrackerTobaccoAttestation';
        SELECT
               'HFit_TrackerTobaccoAttestation' AS TrackerNameAggregateTable
             , TT.ItemID
             , CAST (EventDate AS DATETIME) AS EventDate
             , TT.IsProfessionallyCollected
             , TT.TrackerCollectionSourceID
             , Notes
             , TT.UserID
             , NULL AS CollectionSourceName_Internal
             , NULL AS CollectionSourceName_External
             , 'MISSING' AS EventName
             , 'NA' AS UOM
             , 'TobaccoAttestation' AS KEY1
             , CAST ( TobaccoAttestation AS FLOAT) AS VAL1
             , 'NA' AS KEY2
             , NULL AS VAL2
             , 'NA' AS KEY3
             , NULL AS VAL3
             , 'NA' AS KEY4
             , NULL AS VAL4
             , 'NA' AS KEY5
             , NULL AS VAL5
             , 'NA' AS KEY6
             , NULL AS VAL6
             , 'NA' AS KEY7
             , NULL AS VAL7
             , 'NA' AS KEY8
             , NULL AS VAL8
             , 'NA' AS KEY9
             , NULL AS VAL9
             , 'NA' AS KEY10
             , NULL AS VAL10
             , TT.ItemCreatedBy
             , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
             , TT.ItemModifiedBy
             , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
             , IsProcessedForHa
             , 'NA' AS TXTKEY1
             , NULL AS TXTVAL1
             , 'NA' AS TXTKEY2
             , NULL AS TXTVAL2
             , 'NA' AS TXTKEY3
             , NULL AS TXTVAL3
             , NULL AS ItemOrder
             , NULL AS ItemGuid
             , C.UserGuid
             , PP.MPI
             , PP.ClientCode
             , S.SiteGUID
             , ACCT.AccountID
             , ACCT.AccountCD
             , T.IsAvailable
             , T.IsCustom
             , T.UniqueName
             , T.UniqueName AS ColDesc
             , --VENDOR.ItemID AS VendorID ,
               --VENDOR.VendorName,
               NULL AS VendorID
             , NULL AS VendorName
             , TT.LastModifiedDate
             , TT.SVR
             , TT.DBNAME
        INTO
             FACT_HFit_TrackerTobaccoAttestation
               FROM dbo.BASE_HFit_TrackerTobaccoAttestation AS TT
                        INNER JOIN dbo.BASE_CMS_User AS C
                            ON C.UserID = TT.UserID
                           AND C.SVR = TT.SVR
                           AND C.DBNAME = TT.DBNAME
                        INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                            ON TT.UserID = PP.userID
                           AND TT.SVR = PP.SVR
                           AND TT.DBNAME = PP.DBNAME
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON PP.ClientCode = ACCT.AccountCD
                           AND PP.SVR = ACCT.SVR
                           AND PP.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON ACCT.SiteID = S.SiteID
                           AND ACCT.SVR = S.SVR
                           AND ACCT.DBNAME = S.DBNAME
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           AND TC.SVR = TT.SVR
                           AND TC.DBNAME = TT.DBNAME
                        LEFT OUTER JOIN dbo.BASE_HFit_Tracker AS T
                            ON T.AggregateTableName = 'HFit_TrackerTobaccoAttestation'
                           AND T.SVR = TT.SVR
                           AND T.DBNAME = TT.DBNAME;
    END;

/*
	select 'exec proc_SetTrackerPrimaryKey ' + table_name 
	from information_schema.tables 
	where table_name like 'FACT_HFit_Tracker%'
*/
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerSitLess
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerSleepPlan
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerStrength
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerStress
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerStressManagement
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerSugaryDrinks
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerSugaryFoods
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerTobaccoFree
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerVegetables
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerHeight
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerWater
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerWeight
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerWholeGrains
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerCotinine
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerPreventiveCare
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerCardio
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerTobaccoAttestation
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerMedicalCarePlan
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerRegularMeals
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerRestingHeartRate
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerBloodSugarAndGlucose
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerBloodPressure

exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerBMI

exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerBodyFat
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerBodyMeasurements
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerDailySteps
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerHbA1c
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerHighFatFoods
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerHighSodiumFoods

exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerInstance_Tracker

exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerCholesterol
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerMealPortions
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerFlexibility
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerFruits
exec proc_SetTrackerPrimaryKey FACT_HFit_TrackerShots
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_GenJobTrackerTableSync.sql \n 
--------------------------------------------------------------- 


-- use kenticoCMS_DataMArt
GO
PRINT 'Executing proc_GenJobTrackerTableSync.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_GenJobTrackerTableSync') 
    BEGIN
        PRINT 'DROPPING and Reinstalling proc_GenJobTrackerTableSync.sql';
        DROP PROCEDURE
             proc_GenJobTrackerTableSync;
    END;
GO
-- exec proc_GenJobTrackerTableSync 3, 'proc_BASE_CMS_Document_KenticoCMS_2_Insert'
CREATE PROCEDURE proc_GenJobTrackerTableSync
(
       @Interval AS INT = 5
     , @ProcName AS NVARCHAR (250)) 
AS
BEGIN

    DECLARE @DB AS NVARCHAR (250) = DB_NAME() ;
    DECLARE @JobName AS NVARCHAR (250) = 'job_' + @ProcName;
    DECLARE @StepName AS NVARCHAR (250) = N'RUN ' + @ProcName;
    DECLARE @SchedName AS NVARCHAR (250) = 'SCHED ' + @ProcName;
    DECLARE @CMD AS NVARCHAR (250) = 'exec ' + @ProcName;
    DECLARE @JobGuid AS NVARCHAR (50) = CAST (NEWID () AS NVARCHAR (50)) ;
    DECLARE @StartTime AS NVARCHAR (50) = '0';

    print 'GENERATING JOB: ' + @JobName ;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = @JobName) 
        BEGIN
            EXEC msdb.dbo.sp_delete_job @job_name = @JobName, @delete_unused_schedule = 1;
        END;

    --20000 is 2:00 AM 
    --20500 is 2:05 AM 
    --21000 is 2:10 AM 
    SET @StartTime = @Interval * 250 + 20000 ;
    
    --print '@StartTime: ' + cast(@StartTime as nvarchar(50)) ;

    BEGIN TRANSACTION;
    DECLARE @ReturnCode INT;
    SELECT
           @ReturnCode = 0;

    IF NOT EXISTS (SELECT
                          name
                          FROM msdb.dbo.syscategories
                          WHERE name = N'[Uncategorized (Local)]'
                            AND category_class = 1) 
        BEGIN
            EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
            IF @@ERROR <> 0
            OR @ReturnCode <> 0
                BEGIN GOTO QuitWithRollback;
                END;

        END;

    DECLARE @jobId BINARY (16) ;
    EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JobName,
    @enabled = 1,
    @notify_level_eventlog = 0,
    @notify_level_email = 2,
    @notify_level_netsend = 2,
    @notify_level_page = 0,
    @delete_level = 0,
    @description = N'No description available.',
    @category_name = N'[Uncategorized (Local)]',
    @owner_login_name = N'sa',
    @notify_email_operator_name = N'DBA_Notify',
    @notify_netsend_operator_name = N'DBA_Email', @job_id = @jobId OUTPUT
    IF (@@ERROR <> 0 OR @ReturnCode <> 0) 
        BEGIN 
		  GOTO QuitWithRollback;
        END;

    EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = @StepName,
    @step_id = 1,
    @cmdexec_success_code = 0,
    @on_success_action = 1,
    @on_success_step_id = 0,
    @on_fail_action = 2,
    @on_fail_step_id = 0,
    @retry_attempts = 0,
    @retry_interval = 10,
    @os_run_priority = 0, @subsystem = N'TSQL',
    @command = @CMD,
    @database_name = @DB ,
    @flags = 0;
    IF @@ERROR <> 0
    OR @ReturnCode <> 0
        BEGIN GOTO QuitWithRollback;
        END;
    EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
    IF @@ERROR <> 0
    OR @ReturnCode <> 0
        BEGIN GOTO QuitWithRollback;
        END;
    EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = @SchedName,
    @enabled = 1,
    @freq_type = 4,
    @freq_interval = 1,
    @freq_subday_type = 1,
    @freq_subday_interval = 0,
    @freq_relative_interval = 0,
    @freq_recurrence_factor = 0,
    @active_start_date = 20160205,
    @active_end_date = 99991231,
    @active_start_time = @StartTime,
    @active_end_time = 235959,
    @schedule_uid = @JobGuid;
    IF @@ERROR <> 0
    OR @ReturnCode <> 0
        BEGIN GOTO QuitWithRollback;
        END;
    EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
    IF @@ERROR <> 0
    OR @ReturnCode <> 0
        BEGIN GOTO QuitWithRollback;
        END;
    COMMIT TRANSACTION;
    GOTO EndSave;
    QuitWithRollback:
    IF @@TRANCOUNT > 0
        BEGIN ROLLBACK TRANSACTION;
        END;
    EndSave:
print 'Created JOB: ' + @JobName ;
END;
GO
PRINT 'Executed proc_GenJobTrackerTableSync.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_GenJobTrackerAddStep.sql \n 
--------------------------------------------------------------- 


GO
PRINT 'Executing proc_GenJobTrackerAddStep.sql';
GO
IF EXISTS (SELECT
              name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_GenJobTrackerAddStep') 
    BEGIN
        DROP PROCEDURE
           proc_GenJobTrackerAddStep
    END;
GO
-- proc_GenJobTrackerAddStep.sql
CREATE PROCEDURE proc_GenJobTrackerAddStep (
       @JobName AS NVARCHAR (500) 
     , @StepName AS NVARCHAR (500) 
     , @CMD AS NVARCHAR (MAX)) 
AS
BEGIN
--***************************************************************
-- In generated code, it is needed at times to add a step to
-- an already generated job. This proc allows you to add a new
-- step to an existing job. Very useful in adding the dozens
-- of steps needed to complete a MART update to tables, 
-- dimensions, or fact tables.
--***************************************************************
    IF NOT EXISTS (SELECT
                      b.step_name
                          FROM msdb.dbo.sysjobs AS a WITH (NOLOCK) 
                               INNER JOIN msdb.dbo.sysjobsteps AS b WITH (NOLOCK) ON
                          a.job_id = b.job_id
                          WHERE
                          a.Name = @JobName AND
                          b.step_name = @StepName) 
        BEGIN

            EXEC msdb..sp_add_jobstep
            @job_name = @JobName ,
            @step_name = @StepName ,
            @subsystem = N'TSQL' ,
            @command = @CMD ,
            @retry_attempts = 5 ,
            @retry_interval = 5;

        END;
    ELSE
        BEGIN
            PRINT 'FAILED TO ADD Step: ' + @StepName + ' to Job: ' + @JobName;
        END;

END;
GO
PRINT 'Executed proc_GenJobTrackerAddStep.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_TrackerAddTrackerName.sql \n 
--------------------------------------------------------------- 


-- use KenticoCMS_DataMart
-- use KenticoCMS_DataMart_2
GO
PRINT 'Executing proc_TrackerAddTrackerName.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_TrackerAddTrackerName') 
    BEGIN
        DROP PROCEDURE
             proc_TrackerAddTrackerName;
    END;
GO
-- exec proc_TrackerAddTrackerName
CREATE PROCEDURE proc_TrackerAddTrackerName
AS
BEGIN

/*-----------------------------------------------------------------------------------
Author:	  W. Dale Miller
Date:	  01.08.2016
Purpose:	  Modifies each tracker table such that it contains the column TrackerName. 
		  TrackerName is used in the Primary Keys of trackers and needs to be in 
		  all tracker tables.
*/
    DECLARE
           @TblName AS NVARCHAR (100) = ''
         , @msg AS NVARCHAR (4000) = ''
         , @cmd AS NVARCHAR (4000) = ''
         , @TrackerName AS NVARCHAR (100) = '';

    DECLARE C CURSOR
        FOR
            SELECT
                   table_name
            FROM information_Schema.tables
            WHERE
            table_name LIKE 'BASE_HFit_Tracker%' OR
            table_name LIKE 'FACT_HFit_Tracker%' OR
            table_name LIKE 'BASE_HFit_ToDoSmallSteps' OR
            table_name LIKE 'BASE_HFit_TrackerBloodPressure';
    --AND table_name NOT LIKE '%VerHist' 
    --AND table_name NOT LIKE '%_DEL';

    OPEN C;

    FETCH NEXT FROM C INTO @TblName;

    WHILE
           @@FETCH_STATUS = 0
        BEGIN

            SET @msg = 'Processing: ' + @TblName;
            EXEC PrintImmediate @msg;

            IF NOT EXISTS (SELECT
                                  column_name
                           FROM information_schema.columns
                           WHERE
                                  table_name = @TblName AND
                                  column_name = 'TrackerName') 
                BEGIN
                    SET @msg = 'Modifying: ' + @TblName;
                    EXEC PrintImmediate @msg;
                    SET @cmd = 'Alter table ' + @TblName + ' add TrackerName nvarchar(100) null ';
                    BEGIN TRY
                        EXEC (@cmd) ;
                    END TRY
                    BEGIN CATCH
                        SET @msg = 'FAILED TO Modify: ' + @TblName + ' : ' + @cmd;
                        EXEC PrintImmediate @msg;
                    END CATCH;
                END;
            IF EXISTS (SELECT
                              column_name
                       FROM information_schema.columns
                       WHERE
                              table_name = @TblName AND
                              column_name = 'TrackerName') 
                BEGIN
                    SET @TrackerName = replace (@TblName , 'BASE_' , '') ;
                    SET @TrackerName = replace (@TblName , 'FACT_' , '') ;
                    SET @cmd = 'Update ' + @TblName + ' set TrackerName = ''' + @TrackerName + ''' where  TrackerName is null ';
                END;
            FETCH NEXT FROM C INTO @TblName;
        END;

    CLOSE C;
    DEALLOCATE C;
END;

GO
PRINT 'Executed proc_TrackerAddTrackerName.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_TrackerAlterPKEY.sql \n 
--------------------------------------------------------------- 


-- use KenticoCMS_DataMart
-- use KenticoCMS_DataMart_2    
-- select top 100 * from FACT_TrackerData
-- select top 100 * from FACT_HFit_TrackerWeight
-- select top 100 * from BASE_HFit_TrackerWeight
GO
PRINT 'Executing proc_TrackerAlterPKEY.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_TrackerAlterPKEY') 
    BEGIN
        DROP PROCEDURE
             proc_TrackerAlterPKEY;
    END;
GO
-- exec proc_TrackerAlterPKEY 'YES'
CREATE PROCEDURE proc_TrackerAlterPKEY (
       @PreviewOnly NVARCHAR (10) = 'NO') 
AS
BEGIN

/*--------------------------------------------------------------------------------------------
Author:	  W. Dale Miller
Date:	  01.08.2016
Purpose:	  Modifies each tracker table such that the primary keys are 
		  consistent and comprise the SVR, DBNAME, TrackerName, UserID, and ItemID.

Changes:	  
1.22.2016	  Modifies each tracker table such that the primary key is based on the SurrogateKey 
		  and a unique key index is created based on SVR, DBNAME, TrackerName, UserID, and ItemID.
1.22.2016	  Adds a foreign key relationship to FACT_TrackerData
*/

    DECLARE
           @TblName AS NVARCHAR (100) = ''
         , @ConstraintName AS NVARCHAR (100) = ''
         , @TrackerName AS NVARCHAR (100) = ''
         , @SKeyName AS NVARCHAR (100) = ''
         , @ColName AS NVARCHAR (100) = ''
         , @KCols AS NVARCHAR (MAX) = ''
         , @msg AS NVARCHAR (4000) = ''
         , @cmd AS NVARCHAR (4000) = ''
         , @PkeyCols AS NVARCHAR (4000) = ''
         , @DropCmd AS NVARCHAR (MAX) = ''
         , @GenCmd AS NVARCHAR (MAX) = ''
         , @MySql AS NVARCHAR (MAX) = ''
         , @FKName AS NVARCHAR (MAX) = ''
         , @iCntUserID INT = 0
         , @iFactTable INT = 0
         , @iCnt INT = 0
         , @iCTFlg INT = 0
         , @i INT = 0;

    DECLARE
           @TBL TABLE
           (
                      PkeyCol NVARCHAR (500) 
           );
    DECLARE
           @IDXCOL TABLE
           (
                         ColName NVARCHAR (500) 
           );

    BEGIN TRY
        DROP TABLE
             #ChangeTrackingTables;
    END TRY
    BEGIN CATCH
        PRINT 'Init table #ChangeTrackingTables ';
    END CATCH;

    SELECT
           sys.tables.name AS Table_name
    INTO
         #ChangeTrackingTables
    FROM
         sys.change_tracking_tables
         JOIN sys.tables
         ON
           sys.tables.object_id = sys.change_tracking_tables.object_id
         JOIN sys.schemas
         ON
           sys.schemas.schema_id = sys.tables.schema_id
    WHERE
           sys.schemas.name = 'dbo';

    DECLARE C CURSOR
        FOR
            SELECT 
                   table_name
            FROM information_Schema.tables
            WHERE
            (
              table_name LIKE 'BASE_HFit_Tracker%' OR
              table_name LIKE 'BASE_HFit_ToDoSmallSteps' OR -- table_name LIKE 'FACT_EDW_TrackerCompositeDetails' OR
              table_name LIKE 'BASE_HFit_TrackerBloodPressure'
            ) AND
            table_name NOT LIKE '%VerHist' AND
            table_name NOT LIKE 'BASE_HFit_TrackerCollectionSource' AND
            table_name NOT LIKE 'FACT_EDW_TrackerCompositeDetails' AND
            table_name NOT LIKE '%_DEL';

    OPEN C;

    FETCH NEXT FROM C INTO @TblName;

    WHILE
           @@FETCH_STATUS = 0
        BEGIN

            SET @msg = '-- ********************************************************** ';
            EXEC PrintImmediate @msg;

            SET @msg = 'Processing: ' + @TblName;
            EXEC PrintImmediate @msg;

            IF
                   charindex ('BASE_' , @TblNAme) > 0
                BEGIN
                    SET @iFactTable = 1;
                END;
            ELSE
                BEGIN
                    SET @iFactTable = 0;
                END;

            SET @Msg = '@iFactTable: ' + cast (@iFactTable AS NVARCHAR (50)) ;
            EXEC PrintImmediate @msg;

            SET @SKeyName = substring (@TblName , charindex ('_' , @TblName) + 1 , 999) ;
            SET @Msg = '@SKeyName: ' + @SKeyName;
            EXEC PrintImmediate @msg;

            DELETE FROM @IDXCOL;

            INSERT INTO @IDXCOL (
                   ColName) 
            SELECT
                   COLUMN_NAME
            FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
            WHERE
                   OBJECTPROPERTY (OBJECT_ID (CONSTRAINT_SCHEMA + '.' + CONSTRAINT_NAME) , 'IsPrimaryKey') = 1 AND
                   TABLE_NAME = @TblName AND
                   TABLE_SCHEMA = 'dbo';

            SET @i = (SELECT
                             count (*) 
                      FROM @IDXCOL
                      WHERE
                             ColName = @SKeyName) ;

            IF @i > 0
                BEGIN
                    SET @Msg = 'NOTICE: ' + @TblName + ', already has a Surrogate Primary Key, skipping.';
                    EXEC PrintImmediate @msg;
                    GOTO SkipThis1;
                END;

            SET @TrackerName = replace (@TblName , 'BASE_' , '') ;
            SET @TrackerName = replace (@TblName , 'FACT_' , '') ;

            DELETE FROM @TBL;

            DECLARE KCol CURSOR
                FOR
                    SELECT
                           COLUMN_NAME
                    FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
                    WHERE
                           OBJECTPROPERTY (OBJECT_ID (CONSTRAINT_SCHEMA + '.' + CONSTRAINT_NAME) , 'IsPrimaryKey') = 1 AND
                           TABLE_NAME = @TblName AND
                           TABLE_SCHEMA = 'dbo';

            OPEN KCol;
            SET @iCnt = 0;
            FETCH NEXT FROM KCol INTO @ColName;
            WHILE
                   @@FETCH_STATUS = 0
                BEGIN
                    INSERT INTO @TBL (
                           PkeyCol) 
                    VALUES (@ColName) ;
                    IF @iCnt > 0
                        BEGIN
                            SET @KCols = @KCols + ',' + @ColName;
                        END;
                    ELSE
                        BEGIN
                            SET @KCols = @ColName;
                        END;
                    SET @iCnt = @iCnt + 1;
                    FETCH NEXT FROM KCol INTO @ColName;
                END;
            CLOSE KCol;
            DEALLOCATE KCol;

            SET @msg = '@kCols = ' + @kCols;
            EXEC PrintImmediate  @msg;

            SET @kCols = 'SurrogateKey_' + @SKeyName;
            SET @msg = '@kCols Changed To: ' + @kCols;
            EXEC PrintImmediate  @msg;

            SET @ConstraintName = (SELECT DISTINCT
                                          CONSTRAINT_NAME
                                   FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
                                   WHERE
                                          OBJECTPROPERTY (OBJECT_ID (CONSTRAINT_SCHEMA + '.' + CONSTRAINT_NAME) , 'IsPrimaryKey') = 1 AND
                                          TABLE_NAME = @TblName AND
                                          TABLE_SCHEMA = 'dbo') ;

            PRINT '@ConstraintName: ' + @ConstraintName;

            SET @iCTFlg = 0;
            SET @iCnt = (SELECT
                                count (*) 
                         FROM @TBL
                         WHERE
                                PkeyCol = 'TrackerName') ;

            IF @iCnt = 0
                BEGIN
                    DELETE FROM @TBL
                    WHERE
                           PkeyCol = 'UserID';
                END;

            SET @iCntUserID = (SELECT
                                      count (*) 
                               FROM @TBL
                               WHERE
                                      PkeyCol = 'UserID') ;

            IF @iCntUserID = 0
                BEGIN DELETE FROM @TBL
                      WHERE
                             PkeyCol = 'TrackerName';
                END;

            IF
            @ConstraintName IS NOT NULL AND
            (
              @iCnt = 0 OR
              @iCntUserID = 0) 
                BEGIN
                    BEGIN TRANSACTION T1;
                    BEGIN TRY

                        SET @i = (SELECT
                                         count (*) 
                                  FROM #ChangeTrackingTables
                                  WHERE
                                         Table_name = @TblName) ;
                        PRINT '@CT: ' + @TblName + ' : ' + cast (@i AS NVARCHAR (50)) ;
                        IF @i > 0
                            BEGIN
                                SET @iCTFlg = 1;
                                SET  @MySql = 'ALTER TABLE ' + @TblName + ' DISABLE CHANGE_TRACKING ';
                                EXEC PrintImmediate @MySql;
                                IF
                                       @PreviewOnly = 'NO'
                                    BEGIN
                                        EXEC (@MySql) ;
                                    END;
                            END;

                        SET  @MySql = 'UPDATE ' + @TblName + ' set TrackerName = ''' + @TrackerName + ''' where TrackerName is null ';
                        EXEC PrintImmediate @MySql;
                        IF
                               @PreviewOnly = 'NO'
                            BEGIN
                                EXEC (@MySql) ;
                            END;

                        SET  @MySql = 'ALTER TABLE ' + @TblName + ' alter column TrackerName nvarchar(100) NOT NULL ';
                        EXEC PrintImmediate @MySql;
                        IF
                               @PreviewOnly = 'NO'
                            BEGIN
                                EXEC (@MySql) ;
                            END;

                        PRINT '1 - @kCols : ' + @kCols;
                        SET @KCols = replace (@KCols , ',TrackerName' , '') ;
                        SET @KCols = replace (@KCols , ',UserID' , '') ;
                        PRINT '2 - @kCols : ' + @kCols;

				    -- WDM Removed 1.22.2016                        
				    --SET @KCols = @KCols + ', UserID, TrackerName';

                        PRINT '3 - @kCols : ' + @kCols;

                        SET @DropCmd = 'ALTER TABLE dbo.' + @TblName + ' DROP CONSTRAINT ' + @ConstraintName;
                        SET @GenCmd = 'ALTER TABLE dbo.' + @TblName + ' ADD CONSTRAINT PKey_' + @TblName + ' PRIMARY KEY CLUSTERED (' + @kCols + ') ';

                        EXEC PrintImmediate  @DropCmd;
                        IF
                               @PreviewOnly = 'NO'
                            BEGIN
                                EXEC (@DropCmd) ;
                            END;
                        EXEC PrintImmediate  @GenCmd;
                        IF
                               @PreviewOnly = 'NO'
                            BEGIN
                                EXEC (@GenCmd) ;
                            END;

                        IF @iCTFlg = 1
                            BEGIN
                                SET  @MySql = 'ALTER TABLE ' + @TblName + ' ENABLE CHANGE_TRACKING ';
                                EXEC PrintImmediate @MySql;
                                IF
                                       @PreviewOnly = 'NO'
                                    BEGIN
                                        EXEC (@MySql) ;
                                    END;
                            END;

                        --update FACT_TrackerData set TrackerName = replace(TrackerName, 'BASE_','') where TrackerName like 'BASE_%'

                        COMMIT TRANSACTION T1;
                    END TRY
                    BEGIN CATCH
                        PRINT 'FAILED @DropCmd: ' + @DropCmd;
                        PRINT 'FAILED @GenCmd: ' + @GenCmd;
                        ROLLBACK TRANSACTION T1;
                    END CATCH;
                END;

            SET @FKName = 'FK_FACT_TrackerData_' + @TblName;

            IF NOT EXISTS (SELECT
                                  CONSTRAINT_NAME
                           FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS
                           WHERE
                                  CONSTRAINT_NAME = @FKName) 
                BEGIN
                    --SET @MySql = 'ALTER TABLE [dbo].[FACT_TrackerData]  WITH NOCHECK ' + char (10) ;
                    --SET @MySql = @MySql + ' ADD  CONSTRAINT [' + @FKName + ']  ' + char (10) ;
                    --SET @MySql = @MySql + '   FOREIGN KEY([DBNAME], [ItemID], [SVR], [UserID], [TrackerName]) ' + char (10) ;
                    --SET @MySql = @MySql + '   REFERENCES [dbo].[' + @TblName + '] ([DBNAME], [ItemID], [SVR], [UserID], [TrackerName]) ' + char (10) ;
                    --SET @MySql = @MySql + '   NOT FOR REPLICATION  ' + char (10) ;


		  --SET @kCols = 'SurrogateKey_' + @SKeyName;
		  --ALTER TABLE [dbo].[FACT_TrackerData]  WITH NOCHECK 
		  -- ADD  CONSTRAINT [FK_FACT_TrackerData_BASE_HFit_TrackerSleepPlan]  
		  --   FOREIGN KEY(SurrogateKey_HFit_TrackerSleepPlan) 
		  --   REFERENCES [dbo].[BASE_HFit_TrackerSleepPlan] (SurrogateKey_HFit_TrackerSleepPlan) NOT FOR REPLICATION  

				 SET @MySql = 'ALTER TABLE [dbo].[FACT_TrackerData]  WITH NOCHECK ' + char (10) ;
                    SET @MySql = @MySql + ' ADD  CONSTRAINT [' + @FKName + ']  ' + char (10) ;
                    SET @MySql = @MySql + '   FOREIGN KEY(SurrogateKey_' +@SKeyName+ ') ' + char (10) ;
                    SET @MySql = @MySql + '   REFERENCES [dbo].[' + @TblName + '] (SurrogateKey_' +@SKeyName+ ') ' + char (10) ;
                    SET @MySql = @MySql + '   NOT FOR REPLICATION  ' + char (10) ;

                    BEGIN TRY
                        EXEC PrintImmediate @MySql;
                        IF
                               @PreviewOnly = 'NO'
                            BEGIN
                                EXEC (@MySql) ;
                            END;
                    END TRY
                    BEGIN CATCH
                        SET @Msg = 'FAILURE: ' + @MySql;
                    END CATCH;
                END;
            SkipThis1:
            FETCH NEXT FROM C INTO @TblName;
        END;
    PRINT 'RUN COMPLETE.';
    CLOSE C;
    DEALLOCATE C;

    IF NOT EXISTS (SELECT DISTINCT
                          CONSTRAINT_NAME
                   FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
                   WHERE
                          CONSTRAINT_NAME = 'PKey_FACT_EDW_TrackerCompositeDetails' AND
                          TABLE_SCHEMA = 'dbo') 
        BEGIN
            ALTER TABLE dbo.FACT_EDW_TrackerCompositeDetails
            ADD
                        CONSTRAINT PKey_FACT_EDW_TrackerCompositeDetails
                        PRIMARY KEY CLUSTERED (TrackerNameAggregateTable , UserID , ItemID , DBNAME , SVR) ;
        END;

END;

GO
PRINT 'Executed proc_TrackerAlterPKEY.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CkTrackerDataChanged.sql \n 
--------------------------------------------------------------- 


GO
-- USE KENTICOCMS_DATAMART_2
PRINT 'Creating proc_CkTrackerDataChanged';
PRINT 'FROM proc_CkTrackerDataChanged.sql';

IF EXISTS ( SELECT
                   name
            FROM sys.procedures
            WHERE
                   name = 'proc_CkTrackerDataChanged') 
    BEGIN
        DROP PROCEDURE
             proc_CkTrackerDataChanged;
    END;
GO

-- exec proc_CkTrackerDataChanged

/*
ALTER TABLE dbo.BASE_hfit_ppteligibility
ENABLE CHANGE_TRACKING
WITH (TRACK_COLUMNS_UPDATED = ON)
*/

CREATE PROC proc_CkTrackerDataChanged
AS
BEGIN
    --Returns a 0 if no changes were found
    --Returns a 1 of changes were found and no deletes
    --Returns a 2 of changes were found including deletes
    SET NOCOUNT ON;
    IF OBJECT_ID ('tempdb..##TempCompositeData') IS NOT NULL
        BEGIN DROP TABLE
                   ##TempCompositeData;
        END;

    CREATE TABLE ##TempCompositeData (
                 TGTTBL VARCHAR (50) NOT NULL
               , SYS_CHANGE_VERSION BIGINT NULL
               --, SYS_CHANGE_CREATION_VERSION BIGINT NULL
               , SYS_CHANGE_OPERATION NVARCHAR (10) NULL
               --, SYS_CHANGE_COLUMNS VARBINARY (MAX) NULL
               --, SYS_CHANGE_CONTEXT VARBINARY (MAX) NULL
               --, SVR NVARCHAR (100) NULL
               --, DBNAME NVARCHAR (100) NULL
               ----, CHANGE_VERSION BIGINT NULL
               --, ItemID INT NOT NULL
    );

    --CREATE CLUSTERED INDEX PK_TempCompositeData ON ##TempCompositeData
    --(
    --SVR ASC ,
    --DBNAME ASC ,
    --TGTTBL ASC ,
    --ItemID ASC
    --);

    DECLARE
           @b AS BIT = 0;

    INSERT INTO ##TempCompositeData
    SELECT
           'CMS_Site' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_CMS_Class , NULL) AS CT;
    INSERT INTO ##TempCompositeData
    SELECT
           'CMS_User' AS TGTTBL
        , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
	   --, *
    FROM CHANGETABLE (CHANGES BASE_CMS_User , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_Account' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_Account , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_LKP_TrackerVendor' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_LKP_TrackerVendor , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'hfit_ppteligibility' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_hfit_ppteligibility , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFIT_Tracker' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFIT_Tracker , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerBloodPressure' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerBloodPressure , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerBloodSugarAndGlucose' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerBloodSugarAndGlucose , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerBMI' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerBMI , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerBodyFat' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerBodyFat , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerBodyMeasurements' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerBodyMeasurements , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerCardio' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerCardio , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerCholesterol' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerCholesterol , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerCollectionSource' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerCollectionSource , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerCotinine' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerCotinine , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerDailySteps' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerDailySteps , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerDef_Tracker' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerDef_Tracker , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerFlexibility' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerFlexibility , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerFruits' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerFruits , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerHbA1c' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerHbA1c , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerHeight' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerHeight , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerHighFatFoods' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerHighFatFoods , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerHighSodiumFoods' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerHighSodiumFoods , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerInstance_Tracker' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerInstance_Tracker , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerMealPortions' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerMealPortions , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerMedicalCarePlan' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerMedicalCarePlan , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerPreventiveCare' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerPreventiveCare , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerRegularMeals' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerRegularMeals , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerRestingHeartRate' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerRestingHeartRate , NULL) AS CT;
    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerShots' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerShots , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerSitLess' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerSitLess , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerSleepPlan' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerSleepPlan , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerStrength' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerStrength , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerStress' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerStress , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerStressManagement' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerStressManagement , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerSugaryDrinks' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerSugaryDrinks , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerSugaryFoods' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerSugaryFoods , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerTests' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerTests , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerTobaccoAttestation' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerTobaccoAttestation , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerTobaccoFree' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerTobaccoFree , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerVegetables' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerVegetables , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerWater' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerWater , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerWeight' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerWeight , NULL) AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerWholeGrains' AS TGTTBL
         , SYS_CHANGE_VERSION, SYS_CHANGE_OPERATION
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerWholeGrains , NULL) AS CT;

    --select * from ##TempCompositeData ;

    DECLARE
           @NbrUpdates AS INT = (SELECT
                                        COUNT (*) 
                                 FROM ##TempCompositeData) ;
    DECLARE
           @iInsert AS INT = 0;
    DECLARE
           @iUpdate AS INT = 0;
    DECLARE
           @iDel AS INT = 0;

    IF @NbrUpdates = 0
        BEGIN
            PRINT 'No changes found';
            SET @b = 0;
        END;
    ELSE
        BEGIN
            SET @iInsert = ( SELECT
                                    COUNT ( *) 
                             FROM ##TempCompositeData
                             WHERE
                                    SYS_CHANGE_OPERATION = 'I') ;
            SET @iUpdate = ( SELECT
                                    COUNT ( *) 
                             FROM ##TempCompositeData
                             WHERE
                                    SYS_CHANGE_OPERATION = 'U') ;
            SET @iDel = ( SELECT
                                 COUNT ( *) 
                          FROM ##TempCompositeData
                          WHERE
                                 SYS_CHANGE_OPERATION = 'D') ;
            PRINT CAST ( @NbrUpdates AS NVARCHAR ( 50)) + ' Changes found: proc_CkTrackerDataChanged';
            PRINT CAST ( @iInsert AS NVARCHAR ( 50)) + ' Inserts found: proc_CkTrackerDataChanged';
            PRINT CAST ( @iUpdate AS NVARCHAR ( 50)) + ' Updates found: proc_CkTrackerDataChanged';
            PRINT CAST ( @iDel AS NVARCHAR ( 50)) + ' Deletes found: proc_CkTrackerDataChanged';
            SET @b = 1;
            IF @iDel > 0
                BEGIN
                    SET @b = 2;
                END;
            SET NOCOUNT OFF;
            RETURN @b;
        END;
END;
GO
PRINT 'Created proc_CkTrackerDataChanged';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_GenTrackerCTProc.sql \n 
--------------------------------------------------------------- 

-- use KenticoCMS_DataMArt_2

GO
PRINT 'Executing proc_GenTrackerCTProc.sql;';
GO

IF EXISTS (SELECT name
             FROM sys.procedures
             WHERE name = 'proc_GenTrackerCTProc') 
    BEGIN
        DROP PROCEDURE proc_GenTrackerCTProc;
    END;

GO
-- exec sp_depends proc_GenTrackerCTProc
-- exec proc_CT_DIM_HFit_TrackerDailySteps
-- exec proc_CT_DIM_HFit_TrackerHbA1c
-- exec proc_GenTrackerCTProc BASE_HFit_TrackerDailySteps  ,1
-- exec proc_GenTrackerCTProc BASE_HFit_TrackerDailySteps  ,0
-- exec proc_GenTrackerCTProc BASE_HFit_TrackerHbA1c ,1
-- exec proc_GenTrackerCTProc BASE_HFit_TrackerBodyFat,1
-- exec proc_GenTrackerCTProc BASE_HFit_TrackerCholesterol, 1
-- exec proc_GenTrackerCTProc BASE_HFit_TrackerBMI,1
-- Select * from sys.procedures where name like 'proc_CT_DIM_%'
CREATE PROCEDURE proc_GenTrackerCTProc (@TblName AS nvarchar (100) , 
                                        @PreviewOnly AS int = 0 , 
                                        @GenJobToExecute AS int = 1 , 
                                        @AddAsJobStep AS int = 1 , 
                                        @UseCursor AS int = 0) 
AS
BEGIN

/***************************************************************************************************
Author:	  W.Dale Miller
Contact:	  WDaleMiller@Gmail.com
Date:	  01.03.2016
Purpose:	  For each supplied table name, this procedure generates a "processing procedure" that:
		  1. Populates initial tracker data
		  2. Pulls data from the tracker tables on the servers
		  3. Syncs MART data on the tracker tables on the servers
		  4. Populates FACT_TrackerData data
		  5. calls proc_GenJobTrackerTableSync which generates a JOB to run the this SYNC procedure daily.
Parameters:
	   @TblName - the Tracker table that needs these procedures generated.
	   @PreviewOnly - set to one to have the SQL selected and displayed for review.
	   @GenJobToExecute - set to 1 to have a JOB created to run the Tracker update procedure
	   @AddAsJobStep - set to one to NOT genrate a separate job, but to have this procedure 
				    added as a step to job job_CT_TrackerMergeMaster
	   @UseCursor - there are two ways to apply updates. One is using SET processing and the 
				 other is using a cursor. Set this to 1 to use a cursor and a 0 to use set processing.
***********************************************************************************************************************************************************************/

    --SELECT column_name FROM INFORMATION_SCHEMA.columns WHERE table_name = 'BASE_HFit_TrackerBMI';

    --DECLARE @TblName AS NVARCHAR (100) = 'BASE_HFit_TrackerBMI';
    --DECLARE @PreviewOnly AS INT = 1;
    --DECLARE @GenJobToExecute AS INT = 0;
    --DECLARE @AddAsJobStep AS INT = 1;
    --DECLARE @UseCursor AS INT = 1;

    DECLARE
      @CurrDB nvarchar (100) = DB_NAME () , 
      @tName nvarchar (100) = '' , 
      @cName nvarchar (100) = '' , 
      @pName nvarchar (100) = '' , 
      @SKName nvarchar (100) = '' , 
      @VerTblName nvarchar (100) = '' , 
      @HDR nvarchar (max) = '' , 
      @DOCS nvarchar (max) = '' , 
      @procSql nvarchar (max) = '' , 
      @S nvarchar (max) = '' , 
      @S2 nvarchar (max) = '' , 
      @COLS nvarchar (max) = '' , 
      @MySql AS nvarchar (max) = '';

    DECLARE
          @QryCOLS AS nvarchar (max) = '' , 
          @ReturnedCols AS nvarchar (max) = NULL , 
          @InstanceName AS nvarchar (50) = DB_NAME () ;

    SET @SKName = 'SurrogateKey' + SUBSTRING (@TblName , CHARINDEX ('_' , @TblName) , 999) ;    

    PRINT '@SKName: ' + @SKName;

    SET @VerTblName = @TblName + '_CTVerHIST';
    SET @tName = @TblName;
    --set @tName = 'BASE_HFit_TrackerCardio' ;

    SET @pName = REPLACE (@TblName , 'BASE_' , 'DIM_') ;
    SET @pName = 'proc_CT_' + @pName;

    SET @HDR = 'CREATE PROCEDURE ' + @pName + ' (@ReloadAll as int = 0) ' + CHAR (10) ;
    SET @HDR = @HDR + 'AS ' + CHAR (10) ;
    SET @HDR = @HDR + 'BEGIN ' + CHAR (10) ;

    SET @DOCS = @DOCS + '--*********************************************************************' + CHAR (10) ;
    SET @DOCS = @DOCS + '-- ** ATTENTION - ATTENTION - ATTENTION - ATTENTION - ATTENTION' + CHAR (10) ;
    SET @DOCS = @DOCS + '--*********************************************************************' + CHAR (10) ;
    SET @DOCS = @DOCS + '-- ** This PROC is generated by generator proc_GenTrackerCTProc.' + CHAR (10) ;
    SET @DOCS = @DOCS + '-- **      If changes are needed, please modify the generator and ' + CHAR (10) ;
    SET @DOCS = @DOCS + '-- **      regen ALL the procs for consistency. ' + CHAR (10) ;
    SET @DOCS = @DOCS + '-- **      ' + CHAR (10) ;
    SET @DOCS = @DOCS + '-- ** Author:    W.Dale Miller' + CHAR (10) ;
    SET @DOCS = @DOCS + '-- ** Contact:   wdalemiller@gmail.com' + CHAR (10) ;
    SET @DOCS = @DOCS + '-- ** Use:	  Set @ReloadAll = 1 to delete and reload ALL records' + CHAR (10) ;
    SET @DOCS = @DOCS + '-- **            for the this Tracker.' + CHAR (10) ;
    SET @DOCS = @DOCS + '-- ** GenDate:   ' + CAST (GETDATE () AS nvarchar (50)) + CHAR (10) ;
    SET @DOCS = @DOCS + '--*********************************************************************' + CHAR (10) + CHAR (10) ;

    SET @DOCS = @DOCS + '/* ' + CHAR (10) ;
    SET @DOCS = @DOCS + 'drop procedure ' + @pName + CHAR (10) ;
    SET @DOCS = @DOCS + 'exec ' + @pName + CHAR (10) ;
    SET @DOCS = @DOCS + 'select top 100 * from ' + @TblName + CHAR (10) ;
    SET @DOCS = @DOCS + 'update ' + @TblName + ' set HashCode = ''NA'' where ItemID in (select top 100 ItemID from ' + @TblName + ') ' + CHAR (10) ;
    SET @DOCS = @DOCS + '*/' + CHAR (10) + CHAR (10) ;

    SET @HDR = @HDR + @DOCS;

    SET @procSql = @HDR;

    SET @procSql = @procSql + '    SET TRANSACTION ISOLATION LEVEL SNAPSHOT; ' + CHAR (10) ;
    SET @procSql = @procSql + '    SET NOCOUNT ON; ' + CHAR (10) + CHAR (10) ;

    SET @COLS = '';
    DECLARE
          @RetCols AS nvarchar (max) = NULL;
    SET @InstanceName = DB_NAME () ;
    EXEC @COLS = proc_GenTableColumnsVariables @InstanceName , @TblName , @RetCols OUT;
    SET @COLS = @RetCols;
    SET @procSql = @procSql + @COLS + CHAR (10) + CHAR (10) ;

    SET @procSql = @procSql + '    DECLARE @MCnt AS bigint = NULL,' + CHAR (10) ;
    SET @procSql = @procSql + '            @PerfAction AS NVARCHAR (10) = NULL,' + CHAR (10) ;
    SET @procSql = @procSql + '            @NbrRecs AS BIGINT = 0,' + CHAR (10) ;
    SET @procSql = @procSql + '            @RowGuid AS NVARCHAR (100) = CAST (NEWID () AS NVARCHAR (50)) ;' + CHAR (10) + CHAR (10);
    SET @procSql = @procSql + '    SET @PerfAction = ''N''; ' + CHAR (10) ;
    SET @procSql = @procSql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @PerfAction, ''' + @CurrDB + ''', ''' + @TblName + ''', @NbrRecs, ''' + @pName + '''' + CHAR (10) ;

    SET @procSql = @procSql + '    SET @PerfAction = ''IS''; ' + CHAR (10) ;
    SET @procSql = @procSql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @PerfAction, ''' + @CurrDB + ''', ''' + @TblName + ''', @NbrRecs, ''' + @pName + '''; ' + CHAR (10) ;

    --print @procSql ;
    DECLARE C CURSOR
        FOR SELECT column_name
              FROM INFORMATION_SCHEMA.columns
              WHERE	--WDM modified 03.24.2016
              table_name = @tName
          AND column_name NOT LIKE 'CT_%';

    OPEN C;
    FETCH NEXT FROM C INTO @cName;

    DECLARE
          @TrackerName AS nvarchar (250) = '';
    SET @TrackerName = SUBSTRING (@TblName , CHARINDEX ('_' , @TblName) + 1 , 999) ;
    PRINT '@TrackerName: ' + @TrackerName;

    SET @S = @S + 'declare @synchronization_version as bigint = null ; ' + CHAR (10) ;
    SET @S = @S + '  SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION(); ' + CHAR (10) ;
    SET @S = @S + 'declare @LastVersion as bigint = 0 ;  ' + CHAR (10) + CHAR (10) ;

    SET @S = @S + 'EXEC PrintImmediate ''Processing ' + @pName + ' '' ';
    SET @S = @S + 'if (select count(*) from  FACT_TrackerData WHERE TrackerName = ''' + @TrackerName + ''') = 0 ' + CHAR (10) ;
    SET @S = @S + 'BEGIN ' + CHAR (10) ;
    SET @S = @S + '    Print ''Zero records found, reloading ALL.'' ; ' + CHAR (10) ;
    SET @S = @S + '    set @ReloadAll = 1 ; ' + CHAR (10) ;
    SET @S = @S + 'END' + CHAR (10) + CHAR (10) ;

    SET @S = @S + '  SET @LastVersion = (Select max(SYS_CHANGE_VERSION) from ' + @VerTblName + ') ; ' + CHAR (10) ;

    SET @S = @S + '-- PULL AND INSERT ALL RECORDS FROM: ' + @tName + +CHAR (10) ;
    SET @S = @S + 'If @ReloadAll = 1 ' + CHAR (10) ;
    SET @S = @S + 'BEGIN ' + CHAR (10) ;
    SET @S = @S + '    Print ''BEGINNING Reload ALL.'' ; ' + CHAR (10) ;
    SET @S = @S + 'Delete from FACT_TrackerData where TrackerName = ''' + @TrackerName + ''' ; ' + CHAR (10) ;
    SET @S = @S + 'INSERT INTO FACT_TrackerData (TrackerName' + CHAR (10) ;

    SET @S2 = 'Select ''' + @TrackerName + '''' + CHAR (10) ;

    WHILE @@FETCH_STATUS = 0
        BEGIN
            PRINT '@cName: ' + @cName;
            IF @cName != 'TrackerName'
                BEGIN
                    SET @S = @S + '    ,' + @cName + CHAR (10) ;
                    SET @S2 = @S2 + '    ,' + @cName + CHAR (10) ;
                END;
            FETCH NEXT FROM C INTO @cName;
        END;
    CLOSE C;
    DEALLOCATE C;
    SET @S = @S + '    )' + CHAR (10) ;
    SET @S2 = @S2 + ' FROM ' + @tName + ' option (maxdop 1) ;' + CHAR (10) ;
    SET @S2 = @S2 + ' SET @NbrRecs = @@ROWCOUNT;' + CHAR (10) ;
    SET @S2 = @S2 + ' print ''RELOADED: '' + cast(@NbrRecs as nvarchar(50)) + '' records.'';' + CHAR (10) ;

    SET @S2 = @S2 + '    SET @PerfAction = ''IE''; ' + CHAR (10) ;
    SET @S2 = @S2 + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @PerfAction, ''' + @CurrDB + ''', ''' + @TblName + ''', @NbrRecs, ''' + @pName + '''; ' + CHAR (10) ;

    SET @S2 = @S2 + '    SET @PerfAction = ''T''; ' + CHAR (10) ;
    SET @S2 = @S2 + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @PerfAction, ''' + @CurrDB + ''', ''' + @TblName + ''', @NbrRecs, ''' + @pName + '''; ' + CHAR (10) ;
    SET @S2 = @S2 + '    SET NOCOUNT OFF; ' + CHAR (10) + CHAR (10) ;

    SET @S2 = @S2 + '    BEGIN TRY ' + CHAR (10) ;
    SET @S2 = @S2 + '        INSERT INTO ' + @VerTblName + ' (SYS_CHANGE_VERSION, DBMS)  ' + CHAR (10) ;
    SET @S2 = @S2 + '        VALUES (@synchronization_version, DB_NAME ()) ; ' + CHAR (10) ;
    SET @S2 = @S2 + '        PRINT ''Registered Current CT Version id''; ' + CHAR (10) + CHAR (10) ;
    SET @S2 = @S2 + '    END TRY ' + CHAR (10) ;
    SET @S2 = @S2 + '    BEGIN Catch ' + CHAR (10) ;
    SET @S2 = @S2 + '        PRINT ''Current CT Version id currently registered''; ' + CHAR (10) + CHAR (10) ;
    SET @S2 = @S2 + '    END Catch ' + CHAR (10) ;

    SET @S2 = @S2 + ' RETURN 1; ' + CHAR (10) ;
    SET @S2 = @S2 + 'END ; ' + CHAR (10) ;

    SET @S = @S + @S2;

    --PRINT @S;

    SET @procSql = @procSql + @S + CHAR (10) ;
    SET @procSql = @procSql + '--***************************************************************' + CHAR (10) ;
    --***************************************************************
    DECLARE CInserts CURSOR
        FOR SELECT column_name
              FROM INFORMATION_SCHEMA.columns
              WHERE table_name = @tName
                AND column_name NOT LIKE 'CT_%';

    OPEN CInserts;
    FETCH NEXT FROM CInserts INTO @cName;

    DECLARE
          @S0 AS nvarchar (max) = '';
    SET @S0 = '-- PULL ALL NEW RECORDS FROM: ' + @tName + CHAR (10) ;
    SET @S0 = @S0 + 'exec PrintImmediate ''Pulling NEW records.'' ; ' + CHAR (10) ;

    SET @S0 = @S0 + 'begin try' + CHAR (10) ;
    SET @S0 = @S0 + '    drop table #' + @TblName + ';' + CHAR (10) ;
    SET @S0 = @S0 + 'end try' + CHAR (10) ;
    SET @S0 = @S0 + 'begin catch' + CHAR (10) ;
    SET @S0 = @S0 + '    print ''Dropped temp table, proceeding.'' ; ' + CHAR (10) ;
    SET @S0 = @S0 + 'end catch ;' + CHAR (10) + CHAR (10) ;

    SET @S0 = @S0 + 'WITH CTE (DBNAME, TrackerName,' + @SKName + ') AS ( ' + CHAR (10) ;
    SET @S0 = @S0 + '        SELECT DBNAME, TrackerName, ' + @SKName + ' FROM ' + @tName + ' ' + CHAR (10) ;
    SET @S0 = @S0 + '        EXCEPT ' + CHAR (10) ;
    SET @S0 = @S0 + '        SELECT  DBNAME, TrackerName, ' + @SKName + ' FROM FACT_TrackerData WHERE TrackerName = ''' + @TrackerName + '''' + CHAR (10) ;
    SET @S0 = @S0 + ') ' + CHAR (10) ;
    SET @S0 = @S0 + 'select * into #' + @TblName + ' from CTE ;' + CHAR (10) + CHAR (10) ;

    SET @S0 = @S0 + 'update #' + @TblName + ' set TrackerName = ''' + @TrackerName + ''' ;' + CHAR (10) + CHAR (10) ;

    SET @S0 = @S0 + 'CREATE NONCLUSTERED INDEX [CI_BASE_cms_user ] ON #' + @TblName + CHAR (10) ;
    SET @S0 = @S0 + ' (' + CHAR (10) ;
    SET @S0 = @S0 + ' 	DBNAME ASC, TrackerName ASC, ' + @SKName + ' ASC ' + CHAR (10) ;
    SET @S0 = @S0 + ' )' + CHAR (10) ;

    SET @S = '    INSERT INTO FACT_TrackerData ' + CHAR (10) ;
    SET @S = @S + '    (TrackerName ' + CHAR (10) ;
    SET @S2 = '   SELECT ' + CHAR (10) ;
    SET @S2 = @S2 + '        ''' + @TrackerName + '''' + CHAR (10) ;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @cName != 'TrackerName'
                BEGIN
                    SET @S = @S + '    ,' + @cName + CHAR (10) ;
                    SET @S2 = @S2 + '    ,BT.' + @cName + CHAR (10) ;
                END;
            FETCH NEXT FROM CInserts INTO @cName;
        END;
    CLOSE CInserts;
    DEALLOCATE CInserts;
    SET @S = @S + '    )' + CHAR (10) ;
    SET @S2 = @S2 + ' FROM ' + @tName + ' as BT' + CHAR (10) ;
    SET @S2 = @S2 + '     JOIN #' + @TblName + ' as CTE ' + CHAR (10) ;
    SET @S2 = @S2 + '     ON ' + CHAR (10) ;
    SET @S2 = @S2 + '         CTE.DBNAME = BT.DBNAME ' + CHAR (10) ;
    SET @S2 = @S2 + '         AND CTE.TrackerName = BT.TrackerName ' + CHAR (10) ;
    SET @S2 = @S2 + '         AND CTE.' + @SKName + '= BT.' + @SKName + ' option (maxdop 1) ; ' + CHAR (10) ;

    SET @S2 = @S2 + ' SET @NbrRecs = @NbrRecs + @@ROWCOUNT;' + CHAR (10) ;

    SET @S2 = @S2 + ' print ''INSERTED: '' + cast(@NbrRecs as nvarchar(50)) + '' records.'';' + CHAR (10) ;

    SET @S0 = @S0 + @S + @S2;
    --PRINT '--************************************';
    --PRINT @S0;

    SET @procSql = @procSql + @S0 + CHAR (10) ;
    SET @procSql = @procSql + '--***************************************************************' + CHAR (10) ;

    --**************************************************************************************************************
    SET @S0 = ' -- APPLY ALL DELETES IF ANY' + CHAR (10) ;
    SET @S0 = @S0 + '    DELETE FT ' + CHAR (10) ;
    SET @S0 = @S0 + '        from CHANGETABLE (CHANGES ' + @tName + ', @LastVersion) AS C ' + CHAR (10) ;
    SET @S0 = @S0 + '        INNER JOIN ' + @TblName + ' as BT ' + CHAR (10) ;
    SET @S0 = @S0 + '            ON BT.' + @SKName + ' = C.' + @SKName + CHAR (10) ;
    SET @S0 = @S0 + '	    INNER join FACT_TrackerData as FT ' + CHAR (10) ;
    SET @S0 = @S0 + '	        ON BT.DBNAME = FT.DBNAME ' + CHAR (10) ;
    SET @S0 = @S0 + '	   	       AND FT.TrackerName = ''' + @TrackerName + '''' + CHAR (10) ;
    SET @S0 = @S0 + '	   		  AND C.' + @SKName + ' = FT.' + @SKName + CHAR (10) ;
    SET @S0 = @S0 + '	   		  AND C.SYS_CHANGE_OPERATION = ''D''    option (maxdop 1) ' + CHAR (10) ;
    SET @S0 = @S0 + ' SET @NbrRecs = @NbrRecs + @@ROWCOUNT;' + CHAR (10) ;
    SET @S0 = @S0 + ' print ''DELETED: '' + cast(@@ROWCOUNT as nvarchar(50)) + '' records.'';' + CHAR (10) ;

    SET @procSql = @procSql + @S0 + CHAR (10) ;
    SET @procSql = @procSql + '--***************************************************************' + CHAR (10) ;

    --**************************************************************************************************************

    DECLARE
          @i AS int = 0;
    SET @S = '';
    SET @S = @S + 'declare @iChg as bigint = (SELECT  ' + CHAR (10) ;
    SET @S = @S + '                           COUNT (*)  ' + CHAR (10) ;
    SET @S = @S + '                           FROM ' + CHAR (10) ;
    SET @S = @S + '                               CHANGETABLE (CHANGES ' + @TblName + ', @LastVersion) AS C ' + CHAR (10) ;
    SET @S = @S + '                                   WHERE C.SYS_CHANGE_OPERATION = ''U''); ' + CHAR (10) + CHAR (10) ;
    IF @UseCursor = 0
        BEGIN
            DECLARE CUpdt CURSOR
                FOR SELECT column_name
                      FROM INFORMATION_SCHEMA.columns
                      WHERE table_name = @tName
                        AND column_name NOT LIKE 'CT_%';

            OPEN CUpdt;
            FETCH NEXT FROM CUpdt INTO @cName;

            SET @S = @S + 'if @iChg > 0  ' + CHAR (10) ;
            SET @S = @S + 'update FACT_TrackerData' + CHAR (10) ;
            SET @S = @S + '   set ' + CHAR (10) ;

            WHILE @@FETCH_STATUS = 0
                BEGIN
                    IF @i = 0
                        BEGIN
                            SET @S = @S + '    ' + @cName + ' = BT.' + @cName +  CHAR (10) ;
                        END;
                    ELSE
                        BEGIN
                            SET @S = @S + '    ,' + @cName + ' = BT.' + @cName + CHAR (10) ;
                        END;
                    SET @i = @i + 1;
                    FETCH NEXT FROM CUpdt INTO @cName;
                END;

            CLOSE CUpdt;
            DEALLOCATE CUpdt;

            SET @S = @S + '  from  ' + CHAR (10) ;
            SET @S = @S + '  	   CHANGETABLE (CHANGES ' + @tName + ', @LastVersion) AS C ' + CHAR (10) ;
            SET @S = @S + '  	   inner join ' + @tName + ' as BT' + CHAR (10) ;
            SET @S = @S + '  	     on C.' + @SKName + ' = BT.' + @SKName + CHAR (10) ;
            SET @S = @S + '  		  AND C.SYS_CHANGE_OPERATION = ''U''  option (maxdop 1) ' + CHAR (10) ;
            SET @S = @S + ' SET @NbrRecs = @NbrRecs + @@ROWCOUNT;' + CHAR (10) ;
            SET @S = @S + ' print ''UPDATED: '' + cast(@@ROWCOUNT as nvarchar(50)) + '' records.'';' + CHAR (10) ;
        END;

    IF @UseCursor = 1
        BEGIN
            SET @S = @S + 'if @iChg > 0  ' + CHAR (10) ;
            SET @S = @S + 'BEGIN' + CHAR (10) ;
            SET @S = @S + '     DECLARE CC Cursor for SELECT ' + CHAR (10) ;

            --DECLARE @TblName AS NVARCHAR (50) = 'BASE_HFit_TrackerHbA1c';
            EXEC @QryCOLS = proc_GetTableColumnsCT @InstanceName , @TblName , @ReturnedCols OUT;
            SET @QryCOLS = @ReturnedCols;
            SET @QryCOLS = REPLACE (@QryCOLS , '[' , 'BT.[') ;
            SET @QryCOLS = @QryCOLS + ', C.SYS_CHANGE_VERSION ' + CHAR (10) ;

            PRINT '@QryCOLS:' + @QryCOLS;

            SET @S = @S + @QryCOLS;

            SET @S = @S + '    FROM ' + CHAR (10) ;
            SET @S = @S + '       ' + @TblName + ' as BT ' + CHAR (10) ;
            SET @S = @S + '           INNER JOIN CHANGETABLE (CHANGES ' + @TblName + ' , @LastVersion) AS C ' + CHAR (10) ;
            SET @S = @S + '           ON ' + CHAR (10) ;

            SET @S = @S + '           C.' + @SKName + ' = BT.' + @SKName + CHAR (10) ;

            SET @S = @S + '           AND C.SYS_CHANGE_OPERATION = ''U''; ' + CHAR (10) ;

            SET @S = @S + '    OPEN CC;' + CHAR (10) ;

            SET @S = @S + '    FETCH NEXT FROM CC ' + CHAR (10) ;
            SET @S = @S + '    INTO ' + CHAR (10) ;
            --*************************************************************************************
            EXEC @COLS = proc_GetTableColumnsAsVars @InstanceName , @TblName , 0 , @ReturnedCols OUT;
            --*************************************************************************************
            SET @COLS = @ReturnedCols + ', @SYS_CHANGE_VERSION; ' + CHAR (10) + CHAR (10) ;
            SET @S = @S + @COLS;

            SET @S = @S + '    DECLARE @msg AS NVARCHAR (2000) = null; ' + CHAR (10) ;
            SET @S = @S + '    DECLARE @II AS int = 0; ' + CHAR (10) ;
            SET @S = @S + '    SET @msg = ''1 of '' + cast(@iChg as nvarchar(50));  ' + CHAR (10) ;
            SET @S = @S + '    EXEC PrintImmediate @msg; ' + CHAR (10) ;

            SET @S = @S + '    WHILE @@FETCH_STATUS = 0' + CHAR (10) ;
            SET @S = @S + '    BEGIN ' + CHAR (10) ;
            SET @S = @S + '        SET @II = @II + 1; ' + CHAR (10) ;
            SET @S = @S + '        SET @MCnt = @II % 1000 ; ' + CHAR (10) ;

            SET @S = @S + '        IF @MCnt = 0 ' + CHAR (10) ;
            SET @S = @S + '        BEGIN ' + CHAR (10) ;
            SET @S = @S + '             SET @msg = CAST (@II AS NVARCHAR (50)) + '' of '' + cast(@iChg as nvarchar(50))  ' + CHAR (10) ;
            SET @S = @S + '             EXEC PrintImmediate @msg; ' + CHAR (10) ;
            SET @S = @S + '        END; ' + CHAR (10) ;

            SET @S = @S + '        SET @ACTION = ''U'' ; ' + CHAR (10) ;
            SET @S = @S + '        UPDATE Fact_TrackerData ' + CHAR (10) ;
            SET @S = @S + '             SET ' + CHAR (10) ;
            --*************************************************************************************
            EXEC @COLS = proc_GetTableColumnsAsVars @InstanceName , @TblName , 1 , @ReturnedCols OUT;
            --*************************************************************************************
            SET @COLS = @ReturnedCols;
            SET @COLS = REPLACE (@COLS , ',ItemID' , '--,ItemID') ;
            SET @COLS = REPLACE (@COLS , '@LASTMODIFIEDDATE' , 'GETDATE()') ;
            SET @COLS = REPLACE (@COLS , ',ItemID' , '--,ItemID') ;
            SET @S = @S + @cols + CHAR (10) ;

            SET @S = @S + '        WHERE ' + CHAR (10) ;
            SET @S = @S + '            TrackerName = ''' + @TrackerName + ''' ' + CHAR (10) ;
            --SET @S = @S + '        AND SVR = @SVR ' + CHAR (10) ;
            SET @S = @S + '        AND DBNAME = @DBNAME ' + CHAR (10) ;
            SET @S = @S + '        AND ItemID = @Itemid; ' + CHAR (10) + CHAR (10) ;
            SET @S = @S + '    FETCH NEXT FROM CC ' + CHAR (10) ;
            SET @S = @S + '    INTO ' + CHAR (10) ;
            --*************************************************************************************
            EXEC @COLS = proc_GetTableColumnsAsVars @InstanceName , @TblName , 0 , @ReturnedCols OUT;
            --*************************************************************************************
            SET @COLS = @ReturnedCols + ', @SYS_CHANGE_VERSION; ' + CHAR (10) + CHAR (10) ;
            SET @S = @S + @COLS;

            SET @S = @S + '    END ; --while ' + CHAR (10) ;
            SET @S = @S + '    CLOSE CC; ' + CHAR (10) ;
            SET @S = @S + '    DEALLOCATE CC; ' + CHAR (10) ;
            SET @S = @S + '    set @msg = cast(@II as nvarchar(50)) + '' UPDATES applied.'' ;' + CHAR (10) ;
            SET @S = @S + '    exec PrintImmediate @msg  ;' + CHAR (10) ;

            SET @S0 = @S0 + ' SET @NbrRecs = @NbrRecs + @II;' + CHAR (10) ;

            SET @S = @S + 'END ; ' + CHAR (10) ;
        END;

    SET @procSql = @procSql + @S + CHAR (10) ;
    SET @procSql = @procSql + '--***************************************************************' + CHAR (10) ;

    SET @procSql = @procSql + '  declare @iCnt as bigint = (SELECT ' + CHAR (10) ;
    SET @procSql = @procSql + '       COUNT (*)  ' + CHAR (10) ;
    SET @procSql = @procSql + '     FROM ' + @VerTblName + CHAR (10) ;
    SET @procSql = @procSql + '     WHERE SYS_CHANGE_VERSION = @synchronization_version) ' + CHAR (10) ;
    SET @procSql = @procSql + '  IF @iCnt = 0  ' + CHAR (10) ;
    SET @procSql = @procSql + '  begin    ' + CHAR (10) ;
    SET @procSql = @procSql + '     insert into ' + @VerTblName + ' (SYS_CHANGE_VERSION, DBMS) ' + CHAR (10) ;
    SET @procSql = @procSql + '     values (@synchronization_version, DB_NAME()) ; ' + CHAR (10) ;
    SET @procSql = @procSql + '     print ''Saved version id'' ; ' + CHAR (10) ;
    SET @procSql = @procSql + '  END ; ' + CHAR (10) ;
    SET @procSql = @procSql + ' SET @NbrRecs = @NbrRecs + @@ROWCOUNT;' + CHAR (10) ;
    SET @procSql = @procSql + ' print ''RELOADED: '' + cast(@NbrRecs as nvarchar(50)) + '' records.'';' + CHAR (10) ;

    SET @procSql = @procSql + '    SET @PerfAction = ''IE''; ' + CHAR (10) ;
    SET @procSql = @procSql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @PerfAction, ''' + @CurrDB + ''', ''' + @TblName + ''', @NbrRecs, ''' + @pName + '''; ' + CHAR (10) ;

    SET @procSql = @procSql + '    SET @PerfAction = ''T''; ' + CHAR (10) ;
    SET @procSql = @procSql + '    EXEC proc_PERFMON_PullTime_HIST @RowGuid, @PerfAction, ''' + @CurrDB + ''', ''' + @TblName + ''', @NbrRecs, ''' + @pName + '''; ' + CHAR (10) ;

    SET @procSql = @procSql + '    SET NOCOUNT OFF; ' + CHAR (10) + CHAR (10) ;

    SET @procSql = @procSql + 'END ; ' + CHAR (10) ;

    --PRINT @procSql;    

    IF EXISTS (SELECT name
                 FROM sys.procedures
                 WHERE name = @pName) 
        BEGIN
            PRINT 'Dropping ' + @pName + ' and recreating.';
            SET @MySql = 'drop procedure ' + @pName;
            EXEC (@MySql) ;
        END;

    IF @PreviewOnly = 1
        BEGIN
            SELECT @procSql;
        END;
    ELSE
        BEGIN EXEC (@procSql) ;
        END;

    PRINT 'Successfully CREATED: ' + @pName;

    -- In order for the jobs to run at different time intervals, use a random number to set the interval.
    DECLARE
          @Random int;
    DECLARE
          @Upper int;
    DECLARE
          @Lower int;
    SET @Lower = 0; ---- The lowest random number
    SET @Upper = 10; ---- The highest random number
    SELECT @Random = ROUND ((@Upper - @Lower - 1) * RAND () + @Lower , 0) ;

    --***************************************************************************
    IF @GenJobToExecute = 1
        BEGIN EXEC proc_GenJobTrackerTableSync @Interval = @Random , @ProcName = @pName;
            PRINT 'Created PULL JOB: job_' + @pName;
        END;
    --***************************************************************************

    IF @PreviewOnly = 1
        BEGIN
            SELECT @procSql;
        END;

    IF EXISTS (SELECT name
                 FROM sys.procedures
                 WHERE name = @pName) 
        BEGIN
            DECLARE
                  @pSql AS nvarchar (max) = 'drop procedure ' + @pName;
            EXEC (@pSql) ;
        END;

    IF @PreviewOnly = 0
        BEGIN EXEC (@procSql) ;
        END;

END;

GO
PRINT 'Executed proc_GenTrackerCTProc.sql;';
GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_GenTrackerCTProcMASTER.sql \n 
--------------------------------------------------------------- 


GO
PRINT 'EXECUTING proc_GenTrackerCTProcMASTER.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_GenTrackerCTProcMASTER') 
    BEGIN
        DROP PROCEDURE
             proc_GenTrackerCTProcMASTER;
    END;
GO

-- Use KenticoCMS_Datamart_2
-- EXEC proc_GenTrackerCTProcMASTER 'YES'
-- EXEC proc_GenTrackerCTProcMASTER 'NO'

CREATE PROCEDURE proc_GenTrackerCTProcMASTER (
       @PreviewOnly AS NVARCHAR (50) = 'NO') 
AS
BEGIN

    DECLARE
           @cmd AS NVARCHAR (MAX) = '';

    IF OBJECT_ID ( 'usp_GetErrorInfo' , 'P') IS NULL
        BEGIN
            SET @cmd = 'CREATE PROCEDURE usp_GetErrorInfo ' + CHAR (10) ;
            SET @cmd = @cmd + 'AS ' + CHAR (10) ;
            SET @cmd = @cmd + ' SELECT ERROR_NUMBER() AS ErrorNumber ' + CHAR (10) ;
            SET @cmd = @cmd + '    ,ERROR_SEVERITY() AS ErrorSeverity ' + CHAR (10) ;
            SET @cmd = @cmd + '    ,ERROR_STATE() AS ErrorState ' + CHAR (10) ;
            SET @cmd = @cmd + '    ,ERROR_PROCEDURE() AS ErrorProcedure ' + CHAR (10) ;
            SET @cmd = @cmd + '    ,ERROR_LINE() AS ErrorLine ' + CHAR (10) ;
            SET @cmd = @cmd + '    ,ERROR_MESSAGE() AS ErrorMessage; ' + CHAR (10) ;
            EXEC (@cmd) ;
        END;
    SET @cmd = '';
    --Build the execution commands
    DECLARE cmdCursor CURSOR
        FOR
		  -- declare @table_name as nvarchar(250) = 'BASE_CMS_User' ;
            SELECT
                   'EXEC proc_GenTrackerCTProc ''' + table_name + ''';'
            FROM information_schema.tables
            WHERE
            table_name LIKE 'BASE_HFIT_Tracker%' AND
            table_name NOT LIKE '%_DEL' AND
            table_name NOT LIKE '%_CTVerHIST' AND
            table_name NOT LIKE '%_TrackerDef%' AND
            table_name NOT LIKE 'BASE_HFIT_Tracker' AND
            table_name NOT LIKE 'BASE_HFit_TrackerDef_Tracker' and 
		  table_name in (SELECT table_name FROM information_schema.tables WHERE TABLE_TYPE = 'BASE TABLE') 
		  --OR table_name in (Select 'BASE_' + table_name from MART_VIEWS_TO_CONVERT
		  --	 where 'BASE_'+table_name in (SELECT table_name FROM information_schema.tables WHERE TABLE_TYPE = 'BASE TABLE')) ;

    OPEN cmdCursor;
    FETCH NEXT FROM cmdCursor
    INTO @cmd;

    --Build each table using the previously constructed execution commands.
    WHILE
           @@FETCH_STATUS = 0
        BEGIN
            SET @cmd = REPLACE (@cmd , 'EXEC ' , '') ;
            BEGIN TRY
                IF
                       @PreviewOnly = 'NO'
                    BEGIN
                        EXEC (@cmd) 
                    END;
                PRINT 'SUCCESS: ' + @cmd;
                PRINT ' ';
            END TRY
            BEGIN CATCH
                PRINT 'ERROR: ' + @cmd;
                EXECUTE usp_GetErrorInfo;
                PRINT ' ';
            END CATCH;
            FETCH NEXT FROM cmdCursor INTO @cmd;
        END;
    CLOSE cmdCursor;
    DEALLOCATE cmdCursor;

    EXEC dbo.proc_TrackerAddTrackerName ;		  --Verified WDM 1.21.2016

    EXEC dbo.proc_TrackerAlterPKEY ;			  --Verified WDM 1.21.2016

    EXEC proc_RI_Tracker_User ;				  --Verified WDM 1.21.2016

    EXEC proc_SetTrackerKeyColToStandardLength ;	  --Verified WDM 1.21.2016

    EXEC proc_AddSurrogateKey_AllTrackerTables ;	  --Verified WDM 1.21.2016
    EXEC proc_Set_Fact_TrackerDataSurrogateKeyData; --Verified WDM 1.21.2016

    exec proc_create_Trigger_ON_TrackerName ;

    -- THE Following MAY NOT execute properly, may need to be removed.
    EXEC proc_genTrackerPrimaryKeys;



END;
GO
PRINT 'EXECUTED proc_GenTrackerCTProcMASTER.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_GenTrackerFactTable.sql \n 
--------------------------------------------------------------- 

-- use KenticoCMS_DataMart_2
-- proc_GenTrackerFactTable
-- EXEC proc_QuickRowCount FACT_TrackerData
GO
PRINT 'Executing proc_GenTrackerFactTable.sql';
GO

IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_GenTrackerFactTable') 
    BEGIN
        DROP PROCEDURE
             proc_GenTrackerFactTable;
    END;

GO
-- exec proc_GenTrackerFactTable 1
CREATE PROCEDURE proc_GenTrackerFactTable (
       @PreviewOnly AS INT = 0) 
AS
BEGIN

    -- declare @PreviewOnly AS INT = 1
    IF @PreviewOnly = 0
        BEGIN
            IF EXISTS (SELECT
                              name
                       FROM sys.tables
                       WHERE
                              name = 'FACT_TrackerData') 
                BEGIN
                    PRINT 'FACT_TrackerData already exists - returning.';
                    RETURN;
                END;
        END;

    DECLARE
           @column_name AS NVARCHAR (100) = '';
    DECLARE
           @data_type AS NVARCHAR (100) = '';
    DECLARE
           @Character_Maximum_Length AS INT = 0;
    DECLARE
           @MySql AS NVARCHAR (MAX) = '';
    DECLARE
           @i AS INT = 0;
    SET @MySql = 'IF EXISTS (Select name from sys.tables where name = ''FACT_TrackerData'') ' + CHAR (10) ;
    SET @MySql = @MySql + 'BEGIN ' + CHAR (10) ;
    SET @MySql = @MySql + '    PRINT ''FACT_TrackerData already exists - returning.''' + CHAR (10) ;
    SET @MySql = @MySql + '    RETURN ' + CHAR (10) ;
    SET @MySql = @MySql + 'END ' + CHAR (10) ;

    -- SET @MySql = @MySql + 'Create table FACT_TrackerData ( TrackerName nvarchar(100) , ' + CHAR (10) ;
    SET @MySql = @MySql + 'Create table FACT_TrackerData ( ' + CHAR (10) ;

    DECLARE C CURSOR
        FOR
            SELECT DISTINCT
                   column_name
                 , data_type
                 , Character_Maximum_Length
            FROM information_schema.columns
            WHERE
            table_name LIKE 'BASE_HFit_Tracker%' AND
            table_name NOT LIKE '%_del' AND
            table_name NOT LIKE '%_CTVerHIST'
            ORDER BY
                     column_name , data_type;

    OPEN C;
    FETCH NEXT FROM C
    INTO @column_name , @data_type , @Character_Maximum_Length;

    WHILE
           @@FETCH_STATUS = 0
        BEGIN
            SET @i = @i + 1;
            IF @i = 1
                BEGIN
                    SET @MySql = @MySql + '    ' + @column_name + ' ' + @data_type;
                    IF
                           @Character_Maximum_Length > 0
                        BEGIN
                            SET @MySql = @MySql + ' (' + CAST (@Character_Maximum_Length AS NVARCHAR (50)) + ')';
                        END;
                    SET @MySql = @MySql + ' NULL ' + CHAR (10) ;
                END ;
            ELSE
                BEGIN
                    SET @MySql = @MySql + '    ,' + @column_name + ' ' + @data_type;
                    IF
                           @Character_Maximum_Length > 0
                        BEGIN
                            SET @MySql = @MySql + ' (' + CAST (@Character_Maximum_Length AS NVARCHAR (50)) + ')';
                        END;
                    SET @MySql = @MySql + ' NULL ' + CHAR (10) ;
                END;
            --PRINT @column_name + ',' + @data_type + ',' + CAST (ISNULL (@Character_Maximum_Length , -1) AS NVARCHAR (50)) ;
            FETCH NEXT FROM C INTO @column_name , @data_type , @Character_Maximum_Length;
        END;
    SET @MySql = @MySql + ' )' + CHAR (10) ;
    CLOSE C;
    DEALLOCATE C;

    IF @PreviewOnly = 0
        BEGIN
            EXEC (@MySql) ;
        END;
    ELSE
        BEGIN
            SELECT
                   @MySql;
        END;

    PRINT 'TABLE FACT_TrackerData successfully created.';
    IF NOT EXISTS (SELECT
                          name
                   FROM sys.indexes
                   WHERE
                          name = 'PI_FACT_TrackerData') 
        BEGIN
            PRINT 'Created index PI_FACT_TrackerData';
            CREATE UNIQUE CLUSTERED INDEX PI_FACT_TrackerData ON dbo.FACT_TrackerData
            (
		  DBNAME ,
            TrackerName ,
            UserID, 
		  RowNumber
            )WITH (PAD_INDEX = OFF ,
            STATISTICS_NORECOMPUTE = OFF ,
            SORT_IN_TEMPDB = ON ,
            IGNORE_DUP_KEY = OFF ,
            DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = OFF) ON [PRIMARY];
        END;

    ALTER TABLE FACT_TrackerData
    ADD
                RowNumber BIGINT IDENTITY (1 , 1) ;

    EXEC proc_SetTrackerDataSurrogateKey ;

END;

GO
PRINT 'Executed proc_GenTrackerFactTable.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_MASTER_LKP_CTVersion_Fetch.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'EXecuting proc_MASTER_LKP_CTVersion_Fetch.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_MASTER_LKP_CTVersion_Fetch') 
    BEGIN
        DROP PROCEDURE
             proc_MASTER_LKP_CTVersion_Fetch;
    END;

GO
-- select * from MASTER_LKP_CTVersion
-- truncate table MASTER_LKP_CTVersion
CREATE PROCEDURE proc_MASTER_LKP_CTVersion_Fetch (
       @TableName AS NVARCHAR (100) 
     , @ProcID AS NVARCHAR (100)) 
AS
BEGIN

    DECLARE
           @iCnt AS BIGINT = 0;
    SET @iCnt = (SELECT
                        MAX (SYS_CHANGE_VERSION) 
                        FROM MASTER_LKP_CTVersion
                        WHERE
                        ProcedureID = @ProcID) ;

    IF @iCnt IS NULL
        BEGIN
            SET @iCnt = 0
        END;

    RETURN @iCnt;

END;
GO
PRINT 'Executed proc_MASTER_LKP_CTVersion_Fetch.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_MASTER_LKP_CTVersion_Update.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_MASTER_LKP_CTVersion_Update.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_MASTER_LKP_CTVersion_Update') 
    BEGIN
	   PRINT 'Replacing proc_MASTER_LKP_CTVersion_Update.sql';
        DROP PROCEDURE
             proc_MASTER_LKP_CTVersion_Update
    END;

GO

/*
select * from MASTER_LKP_CTVersion
truncate table MASTER_LKP_CTVersion

*/

CREATE PROCEDURE proc_MASTER_LKP_CTVersion_Update (@TableName AS NVARCHAR (100) , @ProcID AS NVARCHAR (100) , @VerNO AS BIGINT) 
AS
BEGIN
    
    DECLARE @iCnt AS INT = 0;
    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM MASTER_LKP_CTVersion
                        WHERE ProcedureID = @ProcID
                          AND SYS_CHANGE_VERSION = @VerNO);

    --If the version (@Verno) already exist, a -1 is returned.
    IF @iCnt > 0
        BEGIN
            RETURN -1
        END;
    --If the version (@Verno) does not exist, it is added to the master lookup.
    INSERT INTO MASTER_LKP_CTVersion (
           TableName
         , ProcedureID
         , SYS_CHANGE_VERSION) 
    VALUES (
           @TableName, @ProcID, @VerNO) ;

END;
GO
PRINT 'Executed proc_MASTER_LKP_CTVersion_Update.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_SetStdColsTracker.sql \n 
--------------------------------------------------------------- 

select 'exec proc_SetStdColsTracker ' + table_name + ';' + char(10) + 'GO' from information_schema.tables 
where table_name like  'FACT_HFit_Tracker%'

/*
 exec proc_SetStdColsTracker FACT_HFit_TrackerBloodPressure;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerBloodSugarAndGlucose;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerBMI;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerBodyFat;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerBodyMeasurements;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerCardio;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerCholesterol;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerCotinine;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerDailySteps;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerFlexibility;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerFruits;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerHbA1c;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerHeight;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerHighFatFoods;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerHighSodiumFoods;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerInstance_Tracker;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerMealPortions;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerMedicalCarePlan;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerPreventiveCare;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerRegularMeals;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerRestingHeartRate;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerShots;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerSitLess;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerSleepPlan;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerStrength;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerStress;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerStressManagement;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerSugaryDrinks;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerSugaryFoods;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerTobaccoAttestation;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerTobaccoFree;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerVegetables;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerWater;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerWeight;
GO
exec proc_SetStdColsTracker FACT_HFit_TrackerWholeGrains;
GO

*/
-- drop procedure proc_SetStdColsTracker 
CREATE PROCEDURE proc_SetStdColsTracker (
       @TblName AS NVARCHAR (100)) 
AS
BEGIN
    DECLARE @MySql AS NVARCHAR (2000) = ' ';
    SET @MySQl = 'alter table ' + @TblName + ' alter column [AggregateTableName] [nvarchar](100) NOT NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [CollectionSourceName_Internal] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [CollectionSourceName_External] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [EventName] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [UOM] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [KEY1] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [KEY2] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [KEY3] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [KEY4] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [KEY5] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [KEY6] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [KEY7] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [KEY8] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [KEY9] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [KEY10] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [TXTKEY1] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [TXTKEY2] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [TXTKEY3] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [MPI] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [ClientCode] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [AccountCD] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [UniqueName] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [ColDesc] [nvarchar](100) NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [SVR] [nvarchar](100) NOT NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' alter column [DBNAME] [nvarchar](100) NOT NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    SET @MySQl = 'alter table ' + @TblName + ' add [RowNumber] [int] IDENTITY(1,1) NOT NULL';
    EXEC PrintImmediate @MySql;
    EXEC (@MySql) ;
    EXEC PrintImmediate 'DONE....' ;
END;--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: create_FactTrackerViews.sql \n 
--------------------------------------------------------------- 


-- use KenticoCMS_DataMart
go
print 'Executing create_FactTrackerViews.sql'
go

EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerBloodPressure';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerBloodPressure;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerBloodPressure') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerBloodPressure;
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerBloodPressure
AS SELECT
          'HFit_TrackerBloodPressure' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mm/Hg' AS UOM
        , 'Systolic' AS KEY1
        , CAST ( Systolic AS FLOAT) AS VAL1
        , 'Diastolic' AS KEY2
        , CAST ( Diastolic AS FLOAT) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'bp') AS UniqueName
        , ISNULL ( T.UniqueName , 'bp') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerBloodPressure AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerBloodPressure'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
-- END ;

GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerBloodSugarAndGlucose';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerBloodSugarAndGlucose;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerBloodSugarAndGlucose') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerBloodSugarAndGlucose;
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerBloodSugarAndGlucose
AS SELECT
          'HFit_TrackerBloodSugarAndGlucose' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mmol/L' AS UOM
        , 'Units' AS KEY1
        , CAST ( Units AS FLOAT) AS VAL1
        , 'FastingState' AS KEY2
        , CAST ( FastingState AS FLOAT) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'glucose') AS UniqueName
        , ISNULL ( T.UniqueName , 'glucose') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerBloodSugarAndGlucose AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerBMI';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerBMI;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerBMI') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerBMI;
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerBMI
AS SELECT
          'HFit_TrackerBMI' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'kg/m2' AS UOM
        , 'BMI' AS KEY1
        , CAST ( BMI AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , 0 AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerBMI AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerBMI'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerBodyFat';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerBodyFat;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerBodyFat') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerBodyFat;
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerBodyFat
AS SELECT
          'HFit_TrackerBodyFat' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'PCT' AS UOM
        , 'Value' AS KEY1
        , CAST ( [Value] AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , 0 AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerBodyFat AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerBodyFat'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID 
				AND TT.VendorID = VENDOR.ItemID ;
-- END ;

GO
--******************************************************************************
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerBodyMeasurements';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerBodyMeasurements;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerBodyMeasurements') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerBodyMeasurements;
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerBodyMeasurements
AS SELECT
          'HFit_TrackerBodyMeasurements' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Inch' AS UOM
        , 'WaistInches' AS KEY1
        , CAST ( WaistInches AS FLOAT) AS VAL1
        , 'HipInches' AS KEY2
        , CAST ( HipInches AS FLOAT) AS VAL2
        , 'ThighInches' AS KEY3
        , CAST ( ThighInches AS FLOAT) AS VAL3
        , 'ArmInches' AS KEY4
        , CAST ( ArmInches AS FLOAT) AS VAL4
        , 'ChestInches' AS KEY5
        , CAST ( ChestInches AS FLOAT) AS VAL5
        , 'CalfInches' AS KEY6
        , CAST ( CalfInches AS FLOAT) AS VAL6
        , 'NeckInches' AS KEY7
        , CAST ( NeckInches AS FLOAT) AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerBodyMeasurements AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
--******************************************************************************
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerCardio';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerCardio;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerCardio') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerCardio;
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerCardio
AS SELECT
          'HFit_TrackerCardio' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'Minutes' AS KEY1
        , CAST ( Minutes AS FLOAT) AS VAL1
        , 'Distance' AS KEY2
        , CAST ( Distance AS FLOAT) AS VAL2
        , 'DistanceUnit' AS KEY3
        , CAST ( DistanceUnit AS FLOAT) AS VAL3
        , 'Intensity' AS KEY4
        , CAST ( Intensity AS FLOAT) AS VAL4
        , 'ActivityID' AS KEY5
        , CAST ( ActivityID AS FLOAT) AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        , NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerCardio AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerCardio'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
          --the following where clause was added on 11/23/2015 as a result of BAD DATA from the PPT
          WHERE
          EventDate > '01/01/1960';
--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerCholesterol';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerCholesterol;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerCholesterol') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerCholesterol;
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerCholesterol
AS SELECT
          'HFit_TrackerCholesterol' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mg/dL' AS UOM
        , 'HDL' AS KEY1
        , CAST ( HDL AS FLOAT) AS VAL1
        , 'LDL' AS KEY2
        , CAST ( LDL AS FLOAT) AS VAL2
        , 'Total' AS KEY3
        , CAST ( Total AS FLOAT) AS VAL3
        , 'Tri' AS KEY4
        , CAST ( Tri AS FLOAT) AS VAL4
        , 'Ratio' AS KEY5
        , CAST ( Ratio AS FLOAT) AS VAL5
        , 'Fasting' AS KEY6
        , CAST ( Fasting AS FLOAT) AS VAL6
        , 'VLDL' AS VLDL
        , CAST ( VLDL AS FLOAT) AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerCholesterol AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerCholesterol'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerDailySteps';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerDailySteps;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerDailySteps') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerDailySteps;
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerDailySteps
AS SELECT
          'HFit_TrackerDailySteps' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Step' AS UOM
        , 'Steps' AS KEY1
        , CAST ( Steps AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerDailySteps AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerDailySteps'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerFlexibility';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerFlexibility;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerFlexibility') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerFlexibility;
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerFlexibility
AS SELECT
          'HFit_TrackerFlexibility' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'HasStretched' AS KEY1
        , CAST ( HasStretched AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerFlexibility AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerFlexibility'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerFruits';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerFruits;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerFruits') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerFruits;
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerFruits
AS SELECT
          'HFit_TrackerFruits' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'CUP(8oz)' AS UOM
        , 'Cups' AS KEY1
        , CAST ( Cups AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerFruits AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerFruits'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerHbA1c';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerHbA1c;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerHbA1c') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerHbA1c
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerHbA1c
AS SELECT
          'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mmol/mol' AS UOM
        , 'Value' AS KEY1
        , CAST ( [Value] AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerHbA1c AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerHbA1c'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerHeight';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerHeight;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerHeight') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerHeight
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerHeight
AS SELECT
          'HFit_TrackerHeight' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'inch' AS UOM
        , 'Height' AS KEY1
        , Height AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerHeight AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerHeight'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerHighFatFoods';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerHighFatFoods;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerHighFatFoods') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerHighFatFoods
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerHighFatFoods
AS SELECT
          'HFit_TrackerHighFatFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        , NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerHighFatFoods AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerHighFatFoods'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerHighSodiumFoods';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerHighSodiumFoods;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerHighSodiumFoods') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerHighSodiumFoods
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerHighSodiumFoods
AS SELECT
          'HFit_TrackerHighSodiumFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerHighSodiumFoods AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerHighSodiumFoods'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerInstance_Tracker';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerInstance_Tracker;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerInstance_Tracker') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerInstance_Tracker
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerInstance_Tracker
AS SELECT
          'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'TrackerDefID' AS KEY1
        , CAST (TrackerDefID AS FLOAT) AS VAL1
        , 'YesNoValue' AS KEY2
        , CAST (YesNoValue AS FLOAT) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerInstance_Tracker AS TT
                   INNER JOIN dbo.BASE_HFit_TrackerDef_Tracker AS TDT
                       ON TDT.trackerid = TT.trackerDefID
                      AND TDT.SVR = TT.SVR
                      AND TDT.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerInstance_Tracker'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                      AND T.DBNAME = TDT.DBNAME
                      AND T.SVR = TDT.SVR;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerMealPortions';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerMealPortions;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerMealPortions') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerMealPortions
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerMealPortions
AS SELECT
          'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-portion' AS UOM
        , 'Portions' AS KEY1
        , CAST ( Portions AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerMealPortions AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerMealPortions'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerMedicalCarePlan';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerMedicalCarePlan;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerMedicalCarePlan') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerMedicalCarePlan
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerMedicalCarePlan
AS SELECT
          'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'FollowedPlan' AS KEY1
        , CAST ( FollowedPlan AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        , NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerMedicalCarePlan AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerMedicalCarePlan'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerRegularMeals';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerRegularMeals;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerRegularMeals') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerRegularMeals
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerRegularMeals
AS SELECT
          'HFit_TrackerRegularMeals' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Units' AS KEY1
        , CAST ( Units AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerRegularMeals AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerRegularMeals'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerRestingHeartRate';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerRestingHeartRate;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerRestingHeartRate') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerRestingHeartRate
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerRestingHeartRate
AS SELECT
          'HFit_TrackerRestingHeartRate' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'BPM' AS UOM
        , 'HeartRate' AS KEY1
        , CAST ( HeartRate AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerRestingHeartRate AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerShots';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerShots;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerShots') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerShots
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerShots
AS SELECT
          'HFit_TrackerShots' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'FluShot' AS KEY1
        , CAST ( FluShot AS FLOAT) AS VAL1
        , 'PneumoniaShot' AS KEY2
        , CAST ( PneumoniaShot AS FLOAT) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerShots AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerShots'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerSitLess';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerSitLess;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerSitLess') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerSitLess
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerSitLess
AS SELECT
          'HFit_TrackerSitLess' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerSitLess AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerSitLess'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerSleepPlan';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerSleepPlan;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerSleepPlan') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerSleepPlan
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerSleepPlan
AS SELECT
          'HFit_TrackerSleepPlan' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'HR' AS UOM
        , 'DidFollow' AS KEY1
        , CAST ( DidFollow AS FLOAT) AS VAL1
        , 'HoursSlept' AS KEY2
        , HoursSlept AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Techniques' AS TXTKEY1
        , Techniques AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerSleepPlan AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerSleepPlan'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerStrength';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerStrength;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerStrength') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerStrength
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerStrength
AS SELECT
          'HFit_TrackerStrength' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'HasTrained' AS KEY1
        , CAST ( HasTrained AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerStrength AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerStrength'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerStress';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerStress;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerStress') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerStress
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerStress
AS SELECT
          'HFit_TrackerStress' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'gradient' AS UOM
        , 'Intensity' AS KEY1
        , CAST ( Intensity AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Awareness' AS TXTKEY1
        , Awareness AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerStress AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerStress'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerStressManagement';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerStressManagement;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerStressManagement') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerStressManagement
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerStressManagement
AS SELECT
          'HFit_TrackerStressManagement' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'gradient' AS UOM
        , 'HasPracticed' AS KEY1
        , CAST ( HasPracticed AS FLOAT) AS VAL1
        , 'Effectiveness' AS KEY2
        , CAST ( Effectiveness AS FLOAT) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerStressManagement AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerStressManagement'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerSugaryDrinks';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerSugaryDrinks;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerSugaryDrinks') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerSugaryDrinks
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerSugaryDrinks
AS SELECT
          'HFit_TrackerSugaryDrinks' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'OZ' AS UOM
        , 'Ounces' AS KEY1
        , CAST ( Ounces AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerSugaryDrinks AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerSugaryDrinks'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerSugaryFoods';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerSugaryFoods;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerSugaryFoods') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerSugaryFoods
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerSugaryFoods
AS SELECT
          'HFit_TrackerSugaryFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-portion' AS UOM
        , 'Portions' AS KEY1
        , CAST ( Portions AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerSugaryFoods AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerSugaryFoods'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerTests';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerTests;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerTests') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerTests
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerTests
AS SELECT
          'HFit_TrackerTests' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'PSATest' AS KEY1
        , CAST ( PSATest AS FLOAT) AS VAL1
        , 'OtherExam' AS KEY2
        , CAST ( OtherExam AS FLOAT) AS VAL2
        , 'TScore' AS KEY3
        , CAST ( TScore AS FLOAT) AS VAL3
        , 'DRA' AS KEY4
        , CAST ( DRA AS FLOAT) AS VAL4
        , 'CotinineTest' AS KEY5
        , CAST ( CotinineTest AS FLOAT) AS VAL5
        , 'ColoCareKit' AS KEY6
        , CAST ( ColoCareKit AS FLOAT) AS VAL6
        , 'CustomTest' AS KEY7
        , CAST ( CustomTest AS FLOAT) AS VAL7
        , 'TSH' AS KEY8
        , CAST ( TSH AS FLOAT) AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'CustomDesc' AS TXTKEY1
        , CustomDesc AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerTests AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerTests'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerTobaccoFree';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerTobaccoFree;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerTobaccoFree') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerTobaccoFree
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerTobaccoFree
AS SELECT
          'HFit_TrackerTobaccoFree' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'WasTobaccoFree' AS KEY1
        , CAST ( WasTobaccoFree AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'QuitAids' AS TXTKEY1
        , QuitAids AS TXTVAL1
        , 'QuitMeds' AS TXTKEY2
        , QuitMeds AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerTobaccoFree AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerTobaccoFree'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerVegetables';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerVegetables;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerVegetables') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerVegetables
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerVegetables
AS SELECT
          'HFit_TrackerVegetables' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'CUP(8oz)' AS UOM
        , 'Cups' AS KEY1
        , CAST ( Cups AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerVegetables AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerVegetables'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerWater';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerWater;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerWater') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerWater
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerWater
AS SELECT
          'HFit_TrackerWater' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'OZ' AS UOM
        , 'Ounces' AS KEY1
        , CAST ( Ounces AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerWater AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerWater'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerWeight';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerWeight;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerWeight') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerWeight
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerWeight
AS SELECT
          'HFit_TrackerWeight' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'LBS' AS UOM
        , 'Value' AS KEY1
        , [Value] AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerWeight AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerWeight'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME
                   LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.DBNAME = VENDOR.DBNAME
                      AND TT.SVR = VENDOR.SVR AND TT.VendorID = VENDOR.ItemID ;;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerWholeGrains';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerWholeGrains;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerWholeGrains') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerWholeGrains
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerWholeGrains
AS SELECT
          'HFit_TrackerWholeGrains' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-serving' AS UOM
        , 'Servings' AS KEY1
        , CAST ( Servings AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID	--VENDOR.ItemID as VendorID
        ,
          NULL AS VendorName --VENDOR.VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerWholeGrains AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerWholeGrains'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerCotinine';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerCotinine;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerCotinine') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerCotinine
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerCotinine
AS SELECT
          'HFit_TrackerCotinine' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'NicotineAssessment' AS KEY1
        , CAST ( NicotineAssessment AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , --VENDOR.ItemID AS VendorID ,
          --VENDOR.VendorName,
          NULL AS VendorID
        , NULL AS VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerCotinine AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerCotinine'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR;

-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerPreventiveCare';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerPreventiveCare;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerPreventiveCare') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerPreventiveCare
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerPreventiveCare
AS SELECT
          'HFit_TrackerPreventiveCare' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'PreventiveCare' AS KEY1
        , CAST ( PreventiveCare AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , --VENDOR.ItemID AS VendorID ,
          --VENDOR.VendorName,
          NULL AS VendorID
        , NULL AS VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerPreventiveCare AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerPreventiveCare'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;

--LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR;
-- END ;
GO
EXEC PrintImmediate 'Processing VIEW FACT_HFit_TrackerTobaccoAttestation';
EXEC PrintImmediate 'Rows: ';
EXEC proc_QuickRowCount BASE_HFit_TrackerTobaccoAttestation;
IF EXISTS (SELECT
                      name
                      FROM sys.views
                      WHERE name = 'view_FACT_HFit_TrackerTobaccoAttestation') 
    BEGIN
        Drop VIEW view_FACT_HFit_TrackerTobaccoAttestation
    END; --@
GO
CREATE VIEW view_FACT_HFit_TrackerTobaccoAttestation
AS SELECT
          'HFit_TrackerTobaccoAttestation' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'TobaccoAttestation' AS KEY1
        , CAST ( TobaccoAttestation AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , --VENDOR.ItemID AS VendorID ,
          --VENDOR.VendorName,
          NULL AS VendorID
        , NULL AS VendorName
        , TT.LastModifiedDate
        , TT.SVR
        , TT.DBNAME
          FROM dbo.BASE_HFit_TrackerTobaccoAttestation AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                      AND C.SVR = TT.SVR
                      AND C.DBNAME = TT.DBNAME
                   INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                      AND TT.SVR = PP.SVR
                      AND TT.DBNAME = PP.DBNAME
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                      AND PP.SVR = ACCT.SVR
                      AND PP.DBNAME = ACCT.DBNAME
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                      AND ACCT.SVR = S.SVR
                      AND ACCT.DBNAME = S.DBNAME
                   left JOIN dbo.BASE_HFit_TrackerCollectionSource  AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                      AND TC.SVR = TT.SVR
                      AND TC.DBNAME = TT.DBNAME
                   left JOIN dbo.BASE_HFit_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerTobaccoAttestation'
                      AND T.SVR = TT.SVR
                      AND T.DBNAME = TT.DBNAME;
-- END ;
go
print 'Executed create_FactTrackerViews.sql'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: findLocks.sql \n 
--------------------------------------------------------------- 

/*------------------------------------------
 IF NEEDED, RUN THIS
go
sp_configure 'Show Advanced Options', 1
GO
RECONFIGURE
GO
sp_configure 'Ad Hoc Distributed Queries', 1
GO
RECONFIGURE
*/

/*-------------------------------------------------------------------------------------------
exec sp_who2 

select spid, status, Blocked,  open_tran, waitresource, waittype, waittime, cmd, lastwaittype
from DFINAnalytics.dbo.sysprocesses
where Blocked <> 0

dbcc inputbuffer (21)
dbcc inputbuffer (64)

exec sp_lock 53
exec sp_lock 63
*/
-- findlocks;
GO
PRINT 'Executing findLocks.sql';
GO

IF EXISTS (SELECT
              name
                  FROM sys.procedures
                  WHERE
                  name = 'findLocks') 
    BEGIN
        DROP PROCEDURE
           findLocks;
    END;
GO
CREATE PROCEDURE findLocks
AS
BEGIN

    SET NOCOUNT ON;

    BEGIN TRY
        DROP TABLE
           #TempLocks;
    END TRY
    BEGIN CATCH
        PRINT 'Dropping #TempLocks ';
    END CATCH;

    --declare @tsql as nvarchar(1000) = '' ;
    --declare @tcmd as nvarchar(1000) = 'exec sp_lock 63' ;
    --set  @tsql = @tsql + ' SELECT * INTO #TempLocks ' + char(10) ;
    --set  @tsql = @tsql + '        FROM OPENROWSET (''SQLNCLI'', ''Server=localhost;Trusted_Connection=yes;'', '''+@tcmd+''' ) ;' ;
    --exec (@tsql) ;

    BEGIN TRY
        DROP TABLE
           #TEmpBlocked;
    END TRY
    BEGIN CATCH
        PRINT 'Dropping #TempLocks ';
    END CATCH;

    SELECT
       spid
     , status
     , blocked
     , open_tran
     , waitresource
     , waittype
     , waittime
     , cmd
     , lastwaittype
    INTO
       #TempBlocked
           FROM DFINAnalytics.dbo.sysprocesses
           WHERE blocked <> 0;

    IF
           (SELECT
               COUNT (*) 
                   FROM #TempBlocked) = 0
        BEGIN
            PRINT 'NO Blocks found.';
            RETURN;
        END;

    --    SELECT
    --           * INTO
    --                  #TempBlocked
    --           FROM OPENROWSET ('SQLNCLI', 'Server=localhost;Trusted_Connection=yes;', 'select spid, status, Blocked, open_tran, waitresource, waittype, waittime, cmd, lastwaittype
    --from DFINAnalytics.dbo.sysprocesses
    --where Blocked <> 0') ;
    --select * from #TempBlocked

    DECLARE
           @lastwaittype NVARCHAR (1000) = '';
    DECLARE
           @CMD NVARCHAR (1000) = '';
    DECLARE
           @waitresource NVARCHAR (1000) = '';
    DECLARE
           @waittype BINARY (2) = NULL;
    DECLARE
           @waittime BIGINT = NULL;
    DECLARE
           @open_tran INT = 0;
    DECLARE
           @Blocked INT = 0;
    DECLARE
           @spid INT = 0;
    DECLARE
           @status AS NVARCHAR (100) = '';

    DECLARE
           @spid2 AS INT = NULL;
    DECLARE
           @dbid  AS INT = NULL;
    DECLARE
           @txtObjId AS NVARCHAR (100) = NULL;
    DECLARE
           @ObjId AS INT = NULL;
    DECLARE
           @InDid AS INT = NULL;
    DECLARE
           @Type AS NVARCHAR (100) = NULL;
    DECLARE
           @Resource AS NVARCHAR (100) = NULL;
    DECLARE
           @Mode AS NVARCHAR (100) = NULL;
    DECLARE
           @Status2 AS NVARCHAR (100) = NULL;
    DECLARE
           @MyParm AS NVARCHAR (100) = NULL;
    DECLARE
           @MySql AS NVARCHAR (4000) = NULL;

    DECLARE C CURSOR
        FOR SELECT
               spid
             , status
             , Blocked
             , open_tran
             , waitresource
             , waittype
             , waittime
             , cmd
             , lastwaittype
                   FROM #TEmpBlocked;
    OPEN C;

    FETCH NEXT FROM C
    INTO @spid , @status , @Blocked , @open_tran , @waitresource , @waittype , @waittime , @cmd , @lastwaittype;
    PRINT '@spid';
    PRINT @spid;
    WHILE
           @@FETCH_STATUS = 0
        BEGIN

            --print 'SPID: ' + cast(@spid as nvarchar(50)) ;
            SET @waitresource = LTRIM (@waitresource) ;
            SET @waitresource = RTRIM (@waitresource) ;
            --print '-' + @waitresource + '-'
            SET @MyParm = 'EXEC SP_LOCK ' + CAST (@Blocked AS NVARCHAR (50)) ;
            PRINT '@MyParm: ' + @MyParm;
            BEGIN TRY
                DROP TABLE
                   #TempLocks;
            END TRY
            BEGIN CATCH
                EXEC PrintImmediate 'filling table #TempLocks ';
            END CATCH;

            --declare @MySql nvarchar(1000) = '' ;
            --declare @Blocked as int = 50 ;
            --declare @MyParm nvarchar(1000) = 'EXEC SP_LOCK ' + cast(@Blocked as nvarchar(50)) ;

            SET @MySql = 'SELECT * INTO #TempLocks ';
            SET @MySql = @MySql + '   FROM OPENROWSET (''SQLNCLI'', ''Server=localhost;Trusted_Connection=yes;'', ''' + @MyParm + ''' ) ';
            --print @MySql ;
            EXEC (@MySql) ;

            DECLARE C2 CURSOR
                FOR
                    SELECT
                       spid
                     , dbid
                     , ObjId
                     , InDid
                     , Type
                     , resource
                     , Mode
                     , status
                           FROM #TempLocks;
            OPEN C2;

            FETCH NEXT FROM C2
            INTO @spid2 , @dbid , @ObjId , @InDid , @Type , @resource , @Mode , @Status2;

            WHILE
                   @@FETCH_STATUS = 0
                BEGIN

                    SET @txtObjId = CAST (@ObjId AS NVARCHAR (50)) ;
                    --print @txtObjId +',' + @Status2 ;
                    IF
                           CHARINDEX (@txtObjId , @waitresource) > 0 AND
                           @txtObjId <> '0'
                        BEGIN
                            PRINT 'SPID ' + CAST (@spid AS NVARCHAR (50)) + ' is blocking ' + CAST (@Blocked AS NVARCHAR (50)) + ', at the ' + @Type + ' Level, with a Mode of ' + @mode + ' and a status of ' + @Status2 + ' / from COMMAND: ' + @cmd;
                        END;

                    FETCH NEXT FROM C2
                    INTO @spid2 , @dbid , @ObjId , @InDid , @Type , @resource , @Mode , @status2;
                END;
            CLOSE C2;
            DEALLOCATE C2;
            FETCH NEXT FROM C INTO @spid , @status , @Blocked , @open_tran , @waitresource , @waittype , @waittime , @cmd , @lastwaittype;
        END;

    CLOSE C;
    DEALLOCATE C;
    SET NOCOUNT OFF;
END;

GO
PRINT 'Executed findLocks.sql';
GO

/*----------------------------------------------------------------------------------------------------------------------
SELECT * INTO #TempLocks    FROM OPENROWSET ('SQLNCLI', 'Server=localhost;Trusted_Connection=yes;', 'EXEC SP_LOCK 53' ) 
select * from #TempLocks
*/--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_EDW_TrackerCompositeDetails.sql \n 
--------------------------------------------------------------- 

--IF EXISTS (SELECT name FROM sys.triggers where name = 'trgSchemaMonitor')    
--DISABLE TRIGGER trgSchemaMonitor ON DATABASE;

/*---------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------
update BASE_HFit_TrackerBloodPressure set LastModifiedDate = getdate() where ItemID in (20504, 20505,20506)
set ROWCOUNT 100
SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
select * into FACT_EDW_TrackerCompositeDetails from view_EDW_TrackerCompositeDetails
select count(*) from view_EDW_TrackerCompositeDetails
    where LastModifiedDate between getdate()-1 and getdate()
*/
GO
PRINT '***** FROM: view_EDW_TrackerCompositeDetails.sql';
PRINT 'Processing: view_EDW_TrackerCompositeDetails ';
GO
--SELECT top 10 * from view_EDW_TrackerCompositeDetails
IF EXISTS ( SELECT DISTINCT
                   TABLE_NAME
            FROM INFORMATION_SCHEMA.VIEWS
            WHERE
                   TABLE_NAME = 'view_EDW_TrackerCompositeDetails') 
    BEGIN
        DROP VIEW
             view_EDW_TrackerCompositeDetails;
    END;
GO

--count with UNION ALL xx @ 00:00:24
--count with UNION ALL and DISTINCT xx @ 00:00:24
--count with UNION 3,218,556 @ 00:00:24
--SELECT count(*) from view_EDW_TrackerCompositeDetails;
GO
CREATE VIEW dbo.view_EDW_TrackerCompositeDetails
AS
--************************************************************************************************************************************
-- NOTES:
--************************************************************************************************************************************
--WDM 6/26/2014
--This view is needed by EDW in order to process the Tracker tables' data.
--As of now, the Tracker tables are representative of objects and that would cause 
--	large volumes of ETL to be devloped and maintained. 
--This view represents a columnar representation of all tracker tables in a Key/Value pair representation.
--Each tracker table to be processed into the EDW must be represented in this view.
--ALL new tracker tables need only be entered once using the structure contained within this view
--	and the same EDW ETL should be able to process it.
--If there is a change to the strucuture of any one query in this view, then all have to be modified 
--	to be support the change.
--Column TrackerNameAggregratetable (AggregateTableName) will be NULL if the Tracker is not a member 
--		of the DISPLAYED Trackers. This allows us to capture all trackers, displayed or not.
--EventDate is the qualifier to pull a date or between dates.
--7/29/2014
--ISSUE: HFit_TrackerBMI,  HFit_TrackerCholesterol, and HFit_TrackerHeight are not in the HFIT_Tracker
--		table. This causes T.IsAvailable, T.IsCustom, T.UniqueName to be NULL. 
--		This raises the need for the Tracker Definition Table.

--NOTE: It is a goal to keep this view using BASE tables in order to gain max performance. Nested views will 
--		be avoided here if possible.

--**************** SPECIFIC TRACKER DATA **********************
--**************** on 7/29/2014          **********************
--Tracker GUID or Unique ID across all DB Instances (ItemGuid)
--Tracker NodeID (we use it for the External ID for Audit and error Triage)  (John: can use ItemID in this case)
--Tracker Table Name or Value Group Name (e.g. Body Measurements) - Categorization (AggregateTableName)
--Tracker Column Unique Name ( In English)  Must be consistent across all DB Instances  ([UniqueName] will be 
--		the TABLE NAME if tracker name not found in the HFIT_Tracker table)
--Tracker Column Description (In English) (???)
--Tracker Column Data Type (e.g. Character, Numeric, Date, Bit or Yes/No)  so that we can set up the answer type
--	NULLS accepted for No Answer?	(KEY1, KEY2, VAL1, VAL2, etc)
--Tracker Active flag (IsAvailable will be null if tracker name not found in the HFIT_Tracker table)
--Tracker Unit of Measure (character) (Currently, the UOM is supplied in the view based on the table and type of Tracker)
--Tracker Insert Date ([ItemCreatedWhen])
--Tracker Last Update Date ([ItemModifiedWhen])
--NOTE: Convert all numerics to floats 7/30/2104 John/Dale
--****************************************************************************************************************************
-- 12.21.2014 - Added Select Distincts to avoid possible dups.
-- 12.23.2014 - Added the Vendor ID and Vendor name to the view via the BASE_HFit_LKP_TrackerVendor table
-- 12.25.2014 - Tested the view to see that it returned the correct VendorID description
--****************************************************************************************************************************
-- NEW ADDITIONS: 02.01.2015	Need for the updates to be completed and then we add.
--	  HFit_TrackerTobaccoAttestation
--	  HFit_TrackerPreventiveCare
--	  HFit_TrackerCotinine
--(03.20.2015) - (WDM) The DISTINCT in this qry in should eliminate duplicate rows found by John C.
--			 All worked correctly in 12.25.2014, NO changes effected since then, and unexplicably rows stated to 
--			 duplicate in three tables (tracker views) Shots, Tests, and TrackerInstance
--(03.20.2015) - WDM : HFit_TrackerInstance_Tracker has a problem that will require developer help - it is still OPEN.
--			    John C. and I looked at the issue and the LEFT join is causing a cartisian as there is no KEY 
--			    on which to join.
-- TGT (PRod1) NO DISTINCT: 
--  SELECT DISTINCT count(*) from view_EDW_TrackerCompositeDetails 00:08:36 @ 3,210,081
--- TGT (PRod1) WITH DISTINCT and Union all: 
--  SELECT DISTINCT count(*) from view_EDW_TrackerCompositeDetails 00:00:30 @ 3,210,081
--- TGT (PRod1) No DISTINCT and UNion all: 
--  SELECT DISTINCT count(*) from view_EDW_TrackerCompositeDetails 00:00:14 @ 3,218,556
--(03.21.2015) - WDM : Implemented bew code for TrackerInstance and it returns data properly now.
--(03.22.2015) - WDM : Found and corrected the Shots and Tests duplicate rows. No DUPS at this point.
--(12.03.2015) = Scott and Dale: The problem has resurfaced per Robert.
--			  the following where clause was added on 11/23/2015 as a result of BAD DATA from the PPT
--****************************************************************************************************************************
--Best USE is:		(however, I do not believe Laura is allowing this view to be called in this fashion)
--SELECT * from view_EDW_TrackerCompositeDetails where EventDate between '2013-11-04 00:00:00' and '2013-11-04 23:59:59'

--Set statistics IO ON
--GO

SELECT DISTINCT
       'HFit_TrackerBloodPressure' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mm/Hg' AS UOM
     , 'Systolic' AS KEY1
     , CAST ( Systolic AS FLOAT) AS VAL1
     , 'Diastolic' AS KEY2
     , CAST ( Diastolic AS FLOAT) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'bp') AS UniqueName
     , ISNULL ( T.UniqueName , 'bp') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerBloodPressure AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerBloodPressure' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT
       'HFit_TrackerBloodSugarAndGlucose' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/L' AS UOM
     , 'Units' AS KEY1
     , CAST ( Units AS FLOAT) AS VAL1
     , 'FastingState' AS KEY2
     , CAST ( FastingState AS FLOAT) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'glucose') AS UniqueName
     , ISNULL ( T.UniqueName , 'glucose') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerBloodSugarAndGlucose AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBMI' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'kg/m2' AS UOM
     , 'BMI' AS KEY1
     , CAST ( BMI AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerBMI AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerBMI' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBodyFat' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'PCT' AS UOM
     , 'Value' AS KEY1
     , CAST ( [Value] AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerBodyFat AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerBodyFat' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID

UNION ALL
--******************************************************************************
SELECT DISTINCT
       'HFit_TrackerBodyMeasurements' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Inch' AS UOM
     , 'WaistInches' AS KEY1
     , CAST ( WaistInches AS FLOAT) AS VAL1
     , 'HipInches' AS KEY2
     , CAST ( HipInches AS FLOAT) AS VAL2
     , 'ThighInches' AS KEY3
     , CAST ( ThighInches AS FLOAT) AS VAL3
     , 'ArmInches' AS KEY4
     , CAST ( ArmInches AS FLOAT) AS VAL4
     , 'ChestInches' AS KEY5
     , CAST ( ChestInches AS FLOAT) AS VAL5
     , 'CalfInches' AS KEY6
     , CAST ( CalfInches AS FLOAT) AS VAL6
     , 'NeckInches' AS KEY7
     , CAST ( NeckInches AS FLOAT) AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerBodyMeasurements AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerBodyMeasurements' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
--******************************************************************************
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCardio' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'Minutes' AS KEY1
     , CAST ( Minutes AS FLOAT) AS VAL1
     , 'Distance' AS KEY2
     , CAST ( Distance AS FLOAT) AS VAL2
     , 'DistanceUnit' AS KEY3
     , CAST ( DistanceUnit AS FLOAT) AS VAL3
     , 'Intensity' AS KEY4
     , CAST ( Intensity AS FLOAT) AS VAL4
     , 'ActivityID' AS KEY5
     , CAST ( ActivityID AS FLOAT) AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerCardio AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerCardio' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
--the following where clause was added on 11/23/2015 as a result of BAD DATA from the PPT
WHERE
       EventDate > '01/01/1960'
--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCholesterol' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mg/dL' AS UOM
     , 'HDL' AS KEY1
     , CAST ( HDL AS FLOAT) AS VAL1
     , 'LDL' AS KEY2
     , CAST ( LDL AS FLOAT) AS VAL2
     , 'Total' AS KEY3
     , CAST ( Total AS FLOAT) AS VAL3
     , 'Tri' AS KEY4
     , CAST ( Tri AS FLOAT) AS VAL4
     , 'Ratio' AS KEY5
     , CAST ( Ratio AS FLOAT) AS VAL5
     , 'Fasting' AS KEY6
     , CAST ( Fasting AS FLOAT) AS VAL6
     , 'VLDL' AS KEY7
     , CAST ( VLDL AS FLOAT) AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerCholesterol AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerCholesterol' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerDailySteps' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Step' AS UOM
     , 'Steps' AS KEY1
     , CAST ( Steps AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerDailySteps AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerDailySteps' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFlexibility' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasStretched' AS KEY1
     , CAST ( HasStretched AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerFlexibility AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerFlexibility' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFruits' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST ( Cups AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerFruits AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerFruits' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHbA1c' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/mol' AS UOM
     , 'Value' AS KEY1
     , CAST ( [Value] AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerHbA1c AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerHbA1c' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHeight' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'inch' AS UOM
     , 'Height' AS KEY1
     , Height AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerHeight AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerHeight' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighFatFoods' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerHighFatFoods AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerHighFatFoods' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighSodiumFoods' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerHighSodiumFoods AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerHighSodiumFoods' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
--w/o  distinct 00:02:07 @ 477120 PRD1
--with distinct 00:03:20 @ 475860 PRD1
--(03.20.2015) - (WDM) verified SELECT DISTINCT to this qry in order to eliminate duplicate rows found by John C.
SELECT DISTINCT
       'HFit_TrackerInstance_Tracker' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'TrackerDefID' AS KEY1
     , CAST (TrackerDefID AS FLOAT) AS VAL1
     , 'YesNoValue' AS KEY2
     , CAST (YesNoValue AS FLOAT) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID
     , NULL AS VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerInstance_Tracker AS TT
     INNER JOIN dbo.BASE_HFit_TrackerDef_Tracker AS TDT
     ON
       TDT.trackerid = TT.trackerDefID AND
       TDT.SVR = TT.SVR AND
       TDT.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerInstance_Tracker' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME AND
       T.DBNAME = TDT.DBNAME AND
       T.SVR = TDT.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMealPortions' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST ( Portions AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerMealPortions AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerMealPortions' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMedicalCarePlan' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FollowedPlan' AS KEY1
     , CAST ( FollowedPlan AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerMedicalCarePlan AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerMedicalCarePlan' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRegularMeals' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Units' AS KEY1
     , CAST ( Units AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerRegularMeals AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerRegularMeals' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRestingHeartRate' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'BPM' AS UOM
     , 'HeartRate' AS KEY1
     , CAST ( HeartRate AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerRestingHeartRate AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerRestingHeartRate' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
UNION ALL
--With DISTINCT 00:14 @ 40041
--With NO DISTINCT 00:14 @ 40060
--(03.20.2015) - (WDM) added a SELECT DISTINCT to this qry in order to eliminate duplicate rows found by John C.
SELECT DISTINCT
       'HFit_TrackerShots' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FluShot' AS KEY1
     , CAST ( FluShot AS FLOAT) AS VAL1
     , 'PneumoniaShot' AS KEY2
     , CAST ( PneumoniaShot AS FLOAT) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerShots AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerShots' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSitLess' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerSitLess AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerSitLess' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSleepPlan' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'HR' AS UOM
     , 'DidFollow' AS KEY1
     , CAST ( DidFollow AS FLOAT) AS VAL1
     , 'HoursSlept' AS KEY2
     , HoursSlept AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Techniques' AS TXTKEY1
     , Techniques AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerSleepPlan AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerSleepPlan' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStrength' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasTrained' AS KEY1
     , CAST ( HasTrained AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerStrength AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerStrength' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStress' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'Intensity' AS KEY1
     , CAST ( Intensity AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Awareness' AS TXTKEY1
     , Awareness AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerStress AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerStress' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStressManagement' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'HasPracticed' AS KEY1
     , CAST ( HasPracticed AS FLOAT) AS VAL1
     , 'Effectiveness' AS KEY2
     , CAST ( Effectiveness AS FLOAT) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerStressManagement AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerStressManagement' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryDrinks' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST ( Ounces AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerSugaryDrinks AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerSugaryDrinks' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryFoods' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Portion' AS UOM
     , 'Portions' AS KEY1
     , CAST ( Portions AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerSugaryFoods AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerSugaryFoods' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
--Using DISTINCT PROD1 - 00:08:41 @ 40313
--Using DISTINCT PRD1 - 00:00:09 @ 45502
--Using NO DISTINCT PRD1 00:19 @ 40332
--Using DISTINCT PRD1 - 00:00:11 @ 44483
--(03.20.2015) - (WDM) added a SELECT DISTINCT to this qry in order to eliminate duplicate rows found by John C.
SELECT DISTINCT
       'HFit_TrackerTests' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PSATest' AS KEY1
     , CAST ( PSATest AS FLOAT) AS VAL1
     , 'OtherExam' AS KEY2
     , CAST ( OtherExam AS FLOAT) AS VAL2
     , 'TScore' AS KEY3
     , CAST ( TScore AS FLOAT) AS VAL3
     , 'DRA' AS KEY4
     , CAST ( DRA AS FLOAT) AS VAL4
     , 'CotinineTest' AS KEY5
     , CAST ( CotinineTest AS FLOAT) AS VAL5
     , 'ColoCareKit' AS KEY6
     , CAST ( ColoCareKit AS FLOAT) AS VAL6
     , 'CustomTest' AS KEY7
     , CAST ( CustomTest AS FLOAT) AS VAL7
     , 'TSH' AS KEY8
     , CAST ( TSH AS FLOAT) AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'CustomDesc' AS TXTKEY1
     , CustomDesc AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerTests AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerTests' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoFree' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'WasTobaccoFree' AS KEY1
     , CAST ( WasTobaccoFree AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'QuitAids' AS TXTKEY1
     , QuitAids AS TXTVAL1
     , 'QuitMeds' AS TXTKEY2
     , QuitMeds AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerTobaccoFree AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerTobaccoFree' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerVegetables' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST ( Cups AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerVegetables AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerVegetables' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWater' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST ( Ounces AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerWater AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerWater' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWeight' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'LBS' AS UOM
     , 'Value' AS KEY1
     , [Value] AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerWeight AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerWeight' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME
     LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
     ON
       TT.DBNAME = VENDOR.DBNAME AND
       TT.SVR = VENDOR.SVR AND
       TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWholeGrains' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Serving' AS UOM
     , 'Servings' AS KEY1
     , CAST ( Servings AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerWholeGrains AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerWholeGrains' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--left outer join BASE_HFit_LKP_TrackerVendor as VENDOR ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR
UNION ALL

SELECT DISTINCT
       'HFit_TrackerCotinine' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'NicotineAssessment' AS KEY1
     , CAST ( NicotineAssessment AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerCotinine AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerCotinine' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR;

UNION ALL
SELECT DISTINCT
       'HFit_TrackerPreventiveCare' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PreventiveCare' AS KEY1
     , CAST ( PreventiveCare AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerPreventiveCare AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerPreventiveCare' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME

--LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR;
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoAttestation' AS AggregateTableName
     , TT.ItemID
     , CAST (EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'TobaccoAttestation' AS KEY1
     , CAST ( TobaccoAttestation AS FLOAT) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
     , TT.LastModifiedDate
     , TT.SVR
     , TT.DBNAME
FROM
     dbo.BASE_HFit_TrackerTobaccoAttestation AS TT
     INNER JOIN dbo.BASE_CMS_User AS C
     ON
       C.UserID = TT.UserID AND
       C.SVR = TT.SVR AND
       C.DBNAME = TT.DBNAME
     INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
     ON
       TT.UserID = PP.userID AND
       TT.SVR = PP.SVR AND
       TT.DBNAME = PP.DBNAME
     INNER JOIN dbo.BASE_HFit_Account AS ACCT
     ON
       PP.ClientCode = ACCT.AccountCD AND
       PP.SVR = ACCT.SVR AND
       PP.DBNAME = ACCT.DBNAME
     INNER JOIN dbo.BASE_CMS_Site AS S
     ON
       ACCT.SiteID = S.SiteID AND
       ACCT.SVR = S.SVR AND
       ACCT.DBNAME = S.DBNAME
     LEFT JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
     ON
       TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID AND
       TC.SVR = TT.SVR AND
       TC.DBNAME = TT.DBNAME
     LEFT JOIN dbo.BASE_HFit_Tracker AS T
     ON
       T.AggregateTableName = 'HFit_TrackerTobaccoAttestation' AND
       T.SVR = TT.SVR AND
       T.DBNAME = TT.DBNAME;
--LEFT OUTER JOIN BASE_HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.DBNAME= VENDOR.DBNAME and TT.SVR= VENDOR.SVR;

GO

--  
--  
GO
PRINT '***** CREATED: view_EDW_TrackerCompositeDetails.sql';
GO

--IF EXISTS (SELECT name FROM sys.triggers where name = 'trgSchemaMonitor')    
--enable TRIGGER trgSchemaMonitor ON DATABASE;

GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_EDW_TrackerCompositeDetails_CT.sql \n 
--------------------------------------------------------------- 


GO
-- use KenticoCMS_Prod1
PRINT 'Processing: view_EDW_TrackerCompositeDetails_CT ';
GO

-- drop table ##XDATA
--SELECT * into ##XDATA from view_EDW_TrackerCompositeDetails_CT where CMS_Operation is not null

IF EXISTS ( SELECT
                   TABLE_NAME
                   FROM INFORMATION_SCHEMA.VIEWS
                   WHERE
                   TABLE_NAME = 'view_EDW_TrackerCompositeDetails_CT') 
    BEGIN
        DROP VIEW
             view_EDW_TrackerCompositeDetails_CT;
    END;
GO

CREATE VIEW view_EDW_TrackerCompositeDetails_CT
AS SELECT DISTINCT
          'HFit_TrackerBloodPressure' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mm/Hg' AS UOM
        , 'Systolic' AS KEY1
        , CAST ( Systolic AS FLOAT) AS VAL1
        , 'Diastolic' AS KEY2
        , CAST ( Diastolic AS FLOAT) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'bp') AS UniqueName
        , ISNULL ( T.UniqueName , 'bp') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerBloodPressure AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerBloodPressure'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerBloodPressure, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL 
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerBloodSugarAndGlucose' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mmol/L' AS UOM
        , 'Units' AS KEY1
        , CAST ( Units AS FLOAT) AS VAL1
        , 'FastingState' AS KEY2
        , CAST ( FastingState AS FLOAT) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'glucose') AS UniqueName
        , ISNULL ( T.UniqueName , 'glucose') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerBloodSugarAndGlucose AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerBloodSugarAndGlucose, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerBMI' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'kg/m2' AS UOM
        , 'BMI' AS KEY1
        , CAST ( BMI AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , 0 AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerBMI AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerBMI'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerBMI, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerBodyFat' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'PCT' AS UOM
        , 'Value' AS KEY1
        , CAST ( [Value] AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , 0 AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerBodyFat AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerBodyFat'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerBodyFat, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL

   SELECT DISTINCT
          'HFit_TrackerBodyMeasurements' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Inch' AS UOM
        , 'WaistInches' AS KEY1
        , CAST ( WaistInches AS FLOAT) AS VAL1
        , 'HipInches' AS KEY2
        , CAST ( HipInches AS FLOAT) AS VAL2
        , 'ThighInches' AS KEY3
        , CAST ( ThighInches AS FLOAT) AS VAL3
        , 'ArmInches' AS KEY4
        , CAST ( ArmInches AS FLOAT) AS VAL4
        , 'ChestInches' AS KEY5
        , CAST ( ChestInches AS FLOAT) AS VAL5
        , 'CalfInches' AS KEY6
        , CAST ( CalfInches AS FLOAT) AS VAL6
        , 'NeckInches' AS KEY7
        , CAST ( NeckInches AS FLOAT) AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerBodyMeasurements AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerBodyMeasurements, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerCardio' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'Minutes' AS KEY1
        , CAST ( Minutes AS FLOAT) AS VAL1
        , 'Distance' AS KEY2
        , CAST ( Distance AS FLOAT) AS VAL2
        , 'DistanceUnit' AS KEY3
        , CAST ( DistanceUnit AS FLOAT) AS VAL3
        , 'Intensity' AS KEY4
        , CAST ( Intensity AS FLOAT) AS VAL4
        , 'ActivityID' AS KEY5
        , CAST ( ActivityID AS FLOAT) AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerCardio AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerCardio' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerCardio, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerCholesterol' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mg/dL' AS UOM
        , 'HDL' AS KEY1
        , CAST ( HDL AS FLOAT) AS VAL1
        , 'LDL' AS KEY2
        , CAST ( LDL AS FLOAT) AS VAL2
        , 'Total' AS KEY3
        , CAST ( Total AS FLOAT) AS VAL3
        , 'Tri' AS KEY4
        , CAST ( Tri AS FLOAT) AS VAL4
        , 'Ratio' AS KEY5
        , CAST ( Ratio AS FLOAT) AS VAL5
        , 'Fasting' AS KEY6
        , CAST ( Fasting AS FLOAT) AS VAL6
        , 'VLDL' AS VLDL
        , CAST ( VLDL AS FLOAT) AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerCholesterol AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerCholesterol'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerCholesterol, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerDailySteps' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Step' AS UOM
        , 'Steps' AS KEY1
        , CAST ( Steps AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerDailySteps AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerDailySteps' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerDailySteps, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerFlexibility' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'HasStretched' AS KEY1
        , CAST ( HasStretched AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerFlexibility AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerFlexibility' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerFlexibility, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerFruits' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'CUP(8oz)' AS UOM
        , 'Cups' AS KEY1
        , CAST ( Cups AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerFruits AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerFruits' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerFruits, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mmol/mol' AS UOM
        , 'Value' AS KEY1
        , CAST ( [Value] AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerHbA1c AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerHbA1c'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerHbA1c, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHeight' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'inch' AS UOM
        , 'Height' AS KEY1
        , Height AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerHeight AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerHeight'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerHeight, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHighFatFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerHighFatFoods AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerHighFatFoods' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerHighFatFoods, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHighSodiumFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerHighSodiumFoods AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerHighSodiumFoods' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerHighSodiumFoods, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'TrackerDefID' AS KEY1
        , CAST ( TrackerDefID AS FLOAT) AS VAL1
        , 'YesNoValue' AS KEY2
        , CAST ( YesNoValue AS FLOAT) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerInstance_Tracker AS TT
                   INNER JOIN dbo.BASE_HFit_TrackerDef_Tracker AS TDT
                       ON TDT.trackerid = TT.trackerDefID
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerInstance_Tracker'
                      AND T.uniquename = TDT.name
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerInstance_Tracker, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-portion' AS UOM
        , 'Portions' AS KEY1
        , CAST ( Portions AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerMealPortions AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerMealPortions' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerMealPortions, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'FollowedPlan' AS KEY1
        , CAST ( FollowedPlan AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerMedicalCarePlan AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerMedicalCarePlan' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerMedicalCarePlan, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerRegularMeals' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Units' AS KEY1
        , CAST ( Units AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerRegularMeals AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerRegularMeals' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerRegularMeals, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerRestingHeartRate' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'BPM' AS UOM
        , 'HeartRate' AS KEY1
        , CAST ( HeartRate AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerRestingHeartRate AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerRestingHeartRate, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerShots;' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'FluShot' AS KEY1
        , CAST ( FluShot AS FLOAT) AS VAL1
        , 'PneumoniaShot' AS KEY2
        , CAST ( PneumoniaShot AS FLOAT) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerShots AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerShots'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerShots, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSitLess' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerSitLess AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerSitLess' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerSitLess, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSleepPlan' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'HR' AS UOM
        , 'DidFollow' AS KEY1
        , CAST ( DidFollow AS FLOAT) AS VAL1
        , 'HoursSlept' AS KEY2
        , HoursSlept AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Techniques' AS TXTKEY1
        , Techniques AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerSleepPlan AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerSleepPlan' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerSleepPlan, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerStrength' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'HasTrained' AS KEY1
        , CAST ( HasTrained AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerStrength AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerStrength' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerStrength, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerStress' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'gradient' AS UOM
        , 'Intensity' AS KEY1
        , CAST ( Intensity AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Awareness' AS TXTKEY1
        , Awareness AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerStress AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerStress' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerStress, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerStressManagement' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'gradient' AS UOM
        , 'HasPracticed' AS KEY1
        , CAST ( HasPracticed AS FLOAT) AS VAL1
        , 'Effectiveness' AS KEY2
        , CAST ( Effectiveness AS FLOAT) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerStressManagement AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerStressManagement' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerStressManagement, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSugaryDrinks' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'OZ' AS UOM
        , 'Ounces' AS KEY1
        , CAST ( Ounces AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerSugaryDrinks AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerSugaryDrinks' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerSugaryDrinks, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSugaryFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-portion' AS UOM
        , 'Portions' AS KEY1
        , CAST ( Portions AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerSugaryFoods AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerSugaryFoods' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerSugaryFoods, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerTests' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'PSATest' AS KEY1
        , CAST ( PSATest AS FLOAT) AS VAL1
        , 'OtherExam' AS KEY1
        , CAST ( OtherExam AS FLOAT) AS VAL2
        , 'TScore' AS KEY3
        , CAST ( TScore AS FLOAT) AS VAL3
        , 'DRA' AS KEY4
        , CAST ( DRA AS FLOAT) AS VAL4
        , 'CotinineTest' AS KEY5
        , CAST ( CotinineTest AS FLOAT) AS VAL5
        , 'ColoCareKit' AS KEY6
        , CAST ( ColoCareKit AS FLOAT) AS VAL6
        , 'CustomTest' AS KEY7
        , CAST ( CustomTest AS FLOAT) AS VAL7
        , 'TSH' AS KEY8
        , CAST ( TSH AS FLOAT) AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'CustomDesc' AS TXTKEY1
        , CustomDesc AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerTests AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerTests'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerTests, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerTobaccoFree' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'WasTobaccoFree' AS KEY1
        , CAST ( WasTobaccoFree AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'QuitAids' AS TXTKEY1
        , QuitAids AS TXTVAL1
        , 'QuitMeds' AS TXTKEY2
        , QuitMeds AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerTobaccoFree AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerTobaccoFree' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerTobaccoFree, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerVegetables' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'CUP(8oz)' AS UOM
        , 'Cups' AS KEY1
        , CAST ( Cups AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerVegetables AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerVegetables' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerVegetables, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerWater' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'OZ' AS UOM
        , 'Ounces' AS KEY1
        , CAST ( Ounces AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerWater AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerWater' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerWater, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerWeight' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'LBS' AS UOM
        , 'Value' AS KEY1
        , [Value] AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerWeight AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerWeight'
                   LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                       ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerWeight, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerWholeGrains' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-serving' AS UOM
        , 'Servings' AS KEY1
        , CAST ( Servings AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerWholeGrains AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerWholeGrains' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerWholeGrains, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerCotinine' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'NicotineAssessment' AS KEY1
        , CAST ( NicotineAssessment AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerCotinine AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerCotinine' --LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
   --	ON TT.VendorID = VENDOR.ItemID;
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerCotinine, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerPreventiveCare' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'PreventiveCare' AS KEY1
        , CAST ( PreventiveCare AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerPreventiveCare AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerPreventiveCare' --LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
   --	ON TT.VendorID = VENDOR.ItemID;
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerPreventiveCare, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerTobaccoAttestation' AS TrackerNameAggregateTable
        , TT.ItemID
        , CAST (EventDate AS DATETIME) AS EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'TobaccoAttestation' AS KEY1
        , CAST ( TobaccoAttestation AS FLOAT) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
        , TT.ItemModifiedBy
        , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
        , TT.SVR
        , TT.DBNAME, TT.LastModifiedDate
          FROM dbo.BASE_HFit_TrackerTobaccoAttestation AS TT
                   INNER JOIN dbo.BASE_CMS_User AS C
                       ON C.UserID = TT.UserID
                   INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                       ON TT.UserID = PP.userID
                   INNER JOIN dbo.BASE_HFit_Account AS ACCT
                       ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.BASE_CMS_Site AS S
                       ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                       ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                       ON T.AggregateTableName = 'HFit_TrackerTobaccoAttestation'
                   LEFT OUTER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerTobaccoAttestation, NULL) AS CT
                       ON TT.itemid = CT.itemid   WHERE CT.ItemID is not NULL;

GO

--  
--  
GO
PRINT '***** FROM: view_EDW_TrackerCompositeDetails_CT.sql';
PRINT '***** CREATED view_EDW_TrackerCompositeDetails_CT ';
GO 


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_EDW_TrackerCompositeDetails_CT_ONLY.sql \n 
--------------------------------------------------------------- 
GO
PRINT 'Processing: view_EDW_TrackerCompositeDetails_CT_ONLY ';
GO

--SELECT * FROM HFit_TrackerCotinine
--select * from view_EDW_TrackerCompositeDetails_CT_ONLY
--select * from HFit_TrackerBMI
--select * from HFit_TrackerCholesterol
--update HFit_TrackerBMI set Notes = 'TEST CHANGE' where ItemID in (15234,15235,15236)
--update HFit_TrackerCholesterol set Notes = 'TEST CHANGE' where ItemID BETWEEN 55922 AND 55928
--update HFit_TrackerCotinine set Notes = 'TEST CHANGE' where ItemID = 3

IF EXISTS ( SELECT
                   TABLE_NAME
                   FROM INFORMATION_SCHEMA.VIEWS
                   WHERE TABLE_NAME = 'view_EDW_TrackerCompositeDetails_CT_ONLY'
) 
    BEGIN
        DROP VIEW
             view_EDW_TrackerCompositeDetails_CT_ONLY;
    END;
GO
CREATE VIEW dbo.BASE_view_EDW_TrackerCompositeDetails_CT_ONLY
AS

--************************************************************************************************************************************
-- NOTES:
--************************************************************************************************************************************
--WDM 6/26/2014
--This view is needed by EDW in order to process the Tracker tables' data.
--As of now, the Tracker tables are representative of objects and that would cause 
--	large volumes of ETL to be devloped and maintained. 
--This view represents a columnar representation of all tracker tables in a Key/Value pair representation.
--Each tracker table to be processed into the EDW must be represented in this view.
--ALL new tracker tables need only be entered once using the structure contained within this view
--	and the same EDW ETL should be able to process it.
--If there is a change to the strucuture of any one query in this view, then all have to be modified 
--	to be support the change.
--Column TrackerNameAggregratetable (AggregateTableName) will be NULL if the Tracker is not a member 
--		of the DISPLAYED Trackers. This allows us to capture all trackers, displayed or not.
--7/29/2014
--ISSUE: HFit_TrackerBMI,  HFit_TrackerCholesterol, and HFit_TrackerHeight are not in the HFIT_Tracker
--		table. This causes T.IsAvailable, T.IsCustom, T.UniqueName to be NULL. 
--		This raises the need for the Tracker Definition Table.
--NOTE: It is a goal to keep this view using BASE tables in order to gain max performance. Nested views will 
--		be avoided here if possible.
--**************** SPECIFIC TRACKER DATA **********************
--**************** on 7/29/2014          **********************
--Tracker GUID or Unique ID across all DB Instances (ItemGuid)
--Tracker NodeID (we use it for the External ID for Audit and error Triage)  (John: can use ItemID in this case)
--Tracker Table Name or Value Group Name (e.g. Body Measurements) - Categorization (TrackerNameAggregateTable)
--Tracker Column Unique Name ( In English)  Must be consistent across all DB Instances  ([UniqueName] will be 
--		the TABLE NAME if tracker name not found in the HFIT_Tracker table)
--Tracker Column Description (In English) (???)
--Tracker Column Data Type (e.g. Character, Numeric, Date, Bit or Yes/No)  so that we can set up the answer type
--	NULLS accepted for No Answer?	(KEY1, KEY2, VAL1, VAL2, etc)
--Tracker Active flag (IsAvailable will be null if tracker name not found in the HFIT_Tracker table)
--Tracker Unit of Measure (character) (Currently, the UOM is supplied in the view based on the table and type of Tracker)
--Tracker Insert Date ([ItemCreatedWhen])
--Tracker Last Update Date ([ItemModifiedWhen])
--NOTE: Convert all numerics to floats 7/30/2104 John/Dale
--****************************************************************************************************************************
-- 12.23.2014 - Added the Vendor ID and Vendor name to the view via the HFit_LKP_TrackerVendor table
-- 12.25.2014 - Tested the view to see that it returned the correct VendorID description
--****************************************************************************************************************************
-- NEW ADDITIONS: 02.01.2015	Need for the updates to be completed and then we add.
--HFit_TrackerTobaccoAttestation
--HFit_TrackerPreventiveCare
--HFit_TrackerCotinine
--****************************************************************************************************************************
--USE:
--select * from view_EDW_TrackerCompositeDetails_CT_ONLY where EventDate between '2013-11-01 15:02:00.000' and '2013-12-01 15:02:00.000'
--Set statistics IO ON
--GO

SELECT DISTINCT
       'HFit_TrackerBloodPressure' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mm/Hg' AS UOM
     , 'Systolic' AS KEY1
     , CAST ( Systolic AS FLOAT
       )AS VAL1
     , 'Diastolic' AS KEY2
     , CAST ( Diastolic AS FLOAT
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'bp'
       )AS UniqueName
     , ISNULL ( T.UniqueName , 'bp'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerBloodPressure AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerBloodPressure'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerBloodPressure, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBloodSugarAndGlucose' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/L' AS UOM
     , 'Units' AS KEY1
     , CAST ( Units AS FLOAT
       )AS VAL1
     , 'FastingState' AS KEY2
     , CAST ( FastingState AS FLOAT
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'glucose'
       )AS UniqueName
     , ISNULL ( T.UniqueName , 'glucose'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerBloodSugarAndGlucose AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerBloodSugarAndGlucose, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL

/*
SELECT Distinct
	  [CT].[ItemID]
  FROM CHANGETABLE (CHANGES BASE_[HFit_TrackerBMI] , NULL) AS [CT];

*/

SELECT DISTINCT
       'HFit_TrackerBMI' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'kg/m2' AS UOM
     , 'BMI' AS KEY1
     , CAST ( BMI AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerBMI'
       )AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerBMI'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerBMI AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerBMI'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerBMI, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBodyFat' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'PCT' AS UOM
     , 'Value' AS KEY1
     , CAST ( [Value] AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat'
       )AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerBodyFat AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerBodyFat'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerBodyFat, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL

--******************************************************************************

SELECT DISTINCT
       'HFit_TrackerBodyMeasurements' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Inch' AS UOM
     , 'WaistInches' AS KEY1
     , CAST ( WaistInches AS FLOAT
       )AS VAL1
     , 'HipInches' AS KEY2
     , CAST ( HipInches AS FLOAT
       )AS VAL2
     , 'ThighInches' AS KEY3
     , CAST ( ThighInches AS FLOAT
       )AS VAL3
     , 'ArmInches' AS KEY4
     , CAST ( ArmInches AS FLOAT
       )AS VAL4
     , 'ChestInches' AS KEY5
     , CAST ( ChestInches AS FLOAT
       )AS VAL5
     , 'CalfInches' AS KEY6
     , CAST ( CalfInches AS FLOAT
       )AS VAL6
     , 'NeckInches' AS KEY7
     , CAST ( NeckInches AS FLOAT
       )AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerBodyMeasurements AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID --******************************************************************************
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerBodyMeasurements, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCardio' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'Minutes' AS KEY1
     , CAST ( Minutes AS FLOAT
       )AS VAL1
     , 'Distance' AS KEY2
     , CAST ( Distance AS FLOAT
       )AS VAL2
     , 'DistanceUnit' AS KEY3
     , CAST ( DistanceUnit AS FLOAT
       )AS VAL3
     , 'Intensity' AS KEY4
     , CAST ( Intensity AS FLOAT
       )AS VAL4
     , 'ActivityID' AS KEY5
     , CAST ( ActivityID AS FLOAT
       )AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerCardio AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerCardio' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerCardio, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCholesterol' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mg/dL' AS UOM
     , 'HDL' AS KEY1
     , CAST ( HDL AS FLOAT
       )AS VAL1
     , 'LDL' AS KEY2
     , CAST ( LDL AS FLOAT
       )AS VAL2
     , 'Total' AS KEY3
     , CAST ( Total AS FLOAT
       )AS VAL3
     , 'Tri' AS KEY4
     , CAST ( Tri AS FLOAT
       )AS VAL4
     , 'Ratio' AS KEY5
     , CAST ( Ratio AS FLOAT
       )AS VAL5
     , 'Fasting' AS KEY6
     , CAST ( Fasting AS FLOAT
       )AS VAL6
     , 'VLDL' AS VLDL
     , CAST ( VLDL AS FLOAT
       )AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol'
       )AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerCholesterol AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerCholesterol'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerCholesterol, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerDailySteps' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Step' AS UOM
     , 'Steps' AS KEY1
     , CAST ( Steps AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps'
       )AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps'
       )AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerDailySteps AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerDailySteps' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerDailySteps, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFlexibility' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasStretched' AS KEY1
     , CAST ( HasStretched AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerFlexibility AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerFlexibility' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerFlexibility, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFruits' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST ( Cups AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerFruits AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerFruits' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerFruits, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/mol' AS UOM
     , 'Value' AS KEY1
     , CAST ( [Value] AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerHbA1c AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerHbA1c'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerHbA1c, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHeight' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'inch' AS UOM
     , 'Height' AS KEY1
     , Height AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerHeight'
       )AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerHeight'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerHeight AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerHeight'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerHeight, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighFatFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerHighFatFoods AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerHighFatFoods' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerHighFatFoods, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighSodiumFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerHighSodiumFoods AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerHighSodiumFoods' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerHighSodiumFoods, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'TrackerDefID' AS KEY1
     , CAST ( TrackerDefID AS FLOAT
       )AS VAL1
     , 'YesNoValue' AS KEY2
     , CAST ( YesNoValue AS FLOAT
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerInstance_Tracker AS TT
                INNER JOIN dbo.BASE_HFit_TrackerDef_Tracker AS TDT
                    ON TDT.trackerid = TT.trackerDefID
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerInstance_Tracker'
                   AND T.uniquename = TDT.name
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerInstance_Tracker, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST ( Portions AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerMealPortions AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerMealPortions' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerMealPortions, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FollowedPlan' AS KEY1
     , CAST ( FollowedPlan AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerMedicalCarePlan AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerMedicalCarePlan' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerMedicalCarePlan, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRegularMeals' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Units' AS KEY1
     , CAST ( Units AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerRegularMeals AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerRegularMeals' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerRegularMeals, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRestingHeartRate' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'BPM' AS UOM
     , 'HeartRate' AS KEY1
     , CAST ( HeartRate AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerRestingHeartRate AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerRestingHeartRate, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerShots' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FluShot' AS KEY1
     , CAST ( FluShot AS FLOAT
       )AS VAL1
     , 'PneumoniaShot' AS KEY2
     , CAST ( PneumoniaShot AS FLOAT
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerShots AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerShots'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerShots, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSitLess' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerSitLess AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerSitLess' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerSitLess, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSleepPlan' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'HR' AS UOM
     , 'DidFollow' AS KEY1
     , CAST ( DidFollow AS FLOAT
       )AS VAL1
     , 'HoursSlept' AS KEY2
     , HoursSlept AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Techniques' AS TXTKEY1
     , Techniques AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerSleepPlan AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerSleepPlan' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerSleepPlan, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStrength' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasTrained' AS KEY1
     , CAST ( HasTrained AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerStrength AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerStrength' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerStrength, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStress' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'Intensity' AS KEY1
     , CAST ( Intensity AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Awareness' AS TXTKEY1
     , Awareness AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerStress AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerStress' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerStress, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStressManagement' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'HasPracticed' AS KEY1
     , CAST ( HasPracticed AS FLOAT
       )AS VAL1
     , 'Effectiveness' AS KEY2
     , CAST ( Effectiveness AS FLOAT
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerStressManagement AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerStressManagement' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerStressManagement, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryDrinks' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST ( Ounces AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerSugaryDrinks AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerSugaryDrinks' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerSugaryDrinks, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST ( Portions AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerSugaryFoods AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerSugaryFoods' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerSugaryFoods, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTests' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PSATest' AS KEY1
     , CAST ( PSATest AS FLOAT
       )AS VAL1
     , 'OtherExam' AS KEY1
     , CAST ( OtherExam AS FLOAT
       )AS VAL2
     , 'TScore' AS KEY3
     , CAST ( TScore AS FLOAT
       )AS VAL3
     , 'DRA' AS KEY4
     , CAST ( DRA AS FLOAT
       )AS VAL4
     , 'CotinineTest' AS KEY5
     , CAST ( CotinineTest AS FLOAT
       )AS VAL5
     , 'ColoCareKit' AS KEY6
     , CAST ( ColoCareKit AS FLOAT
       )AS VAL6
     , 'CustomTest' AS KEY7
     , CAST ( CustomTest AS FLOAT
       )AS VAL7
     , 'TSH' AS KEY8
     , CAST ( TSH AS FLOAT
       )AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'CustomDesc' AS TXTKEY1
     , CustomDesc AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerTests AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerTests'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerTests, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoFree' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'WasTobaccoFree' AS KEY1
     , CAST ( WasTobaccoFree AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'QuitAids' AS TXTKEY1
     , QuitAids AS TXTVAL1
     , 'QuitMeds' AS TXTKEY2
     , QuitMeds AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerTobaccoFree AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerTobaccoFree' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerTobaccoFree, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerVegetables' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST ( Cups AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerVegetables AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerVegetables' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerVegetables, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWater' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST ( Ounces AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerWater AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerWater' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerWater, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWeight' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'LBS' AS UOM
     , 'Value' AS KEY1
     , [Value] AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerWeight AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerWeight'
                LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
                    ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerWeight, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWholeGrains' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-serving' AS UOM
     , 'Servings' AS KEY1
     , CAST ( Servings AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID

       --VENDOR.ItemID as VendorID

     , NULL AS VendorName

       --VENDOR.VendorName

     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerWholeGrains AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerWholeGrains' --left outer JOIN dbo.BASE_HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerWholeGrains, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCotinine' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'NicotineAssessment' AS KEY1
     , CAST ( NicotineAssessment AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     ,--VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,

       NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerCotinine AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerCotinine' --LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.VendorID = VENDOR.ItemID;
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerCotinine, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerPreventiveCare' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PreventiveCare' AS KEY1
     , CAST ( PreventiveCare AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     ,--VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,

       NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerPreventiveCare AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerPreventiveCare' --LEFT OUTER JOIN dbo.BASE_HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.VendorID = VENDOR.ItemID;
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerPreventiveCare, NULL) AS CT
                    ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoAttestation' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST ( EventDate AS DATETIME) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'TobaccoAttestation' AS KEY1
     , CAST ( TobaccoAttestation AS FLOAT
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , CAST ( TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
     , TT.ItemModifiedBy
     , CAST ( TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     ,--VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,

       NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM dbo.BASE_HFit_TrackerTobaccoAttestation AS TT
                INNER JOIN dbo.BASE_CMS_User AS C
                    ON C.UserID = TT.UserID
                INNER JOIN dbo.BASE_hfit_ppteligibility AS PP
                    ON TT.UserID = PP.userID
                INNER JOIN dbo.BASE_HFit_Account AS ACCT
                    ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.BASE_CMS_Site AS S
                    ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                    ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.BASE_HFIT_Tracker AS T
                    ON T.AggregateTableName = 'HFit_TrackerTobaccoAttestation'
                INNER JOIN CHANGETABLE (CHANGES BASE_HFit_TrackerTobaccoAttestation, NULL) AS CT
                    ON TT.itemid = CT.itemid;
GO

--  
--  

GO
PRINT '***** FROM: view_EDW_TrackerCompositeDetails_CT_ONLY.sql';
PRINT '***** CREATED view_EDW_TrackerCompositeDetails_CT_ONLY ';
GO 


-- FATAL ERROR : FILE MISSING view_PPT_User_Details.sql \n 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_GenTableColumnsVariables.sql \n 
--------------------------------------------------------------- 


--SELECT COLUMN_NAME
--FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
--WHERE OBJECTPROPERTY(OBJECT_ID(CONSTRAINT_SCHEMA + '.' + CONSTRAINT_NAME), 'IsPrimaryKey') = 1
--AND TABLE_NAME = 'CMS_WidgetRole' AND TABLE_SCHEMA = 'dbo'

GO
PRINT 'Executing proc_GenTableColumnsVariables.sql';
GO
IF EXISTS (SELECT
                  *
                  FROM   sys.procedures
                  WHERE  name = 'proc_GenTableColumnsVariables') 
    BEGIN
        PRINT 'Replacing function proc_GenTableColumnsVariables';
        DROP PROCEDURE
             proc_GenTableColumnsVariables;
    END;

GO
/*-----------------------------------------------------------
-- use KenticoCMS_DataMart_2
declare @COLS as nvarchar(max) = '' ;
declare @ReturnedCols as nvarchar(max) = null ;
declare @InstanceName as nvarchar(50) = 'KenticoCMS_DataMart'
declare @TblName as nvarchar(50) = 'BASE_HFit_TrackerCardio'
exec @COLS = proc_GenTableColumnsVariables @InstanceName, @TblName, @ReturnedCols OUT
set @COLS = @ReturnedCols ;
print @COLS ;
*/
CREATE PROCEDURE dbo.proc_GenTableColumnsVariables (
       @InstanceName NVARCHAR (100) 
     , @TblName NVARCHAR (100) 
     , @ReturnedCols NVARCHAR (MAX) OUT) 
AS
BEGIN
    --W. Dale Miller
    --June 20, 2012
    DECLARE @COL AS NVARCHAR (MAX) = '';
    DECLARE @DT AS NVARCHAR (MAX) = '';
    DECLARE @Character_Maximum_Length AS INT = 0;
    DECLARE @TableCols AS NVARCHAR (MAX) = '';
    DECLARE @S AS NVARCHAR (MAX) = '';

    IF CURSOR_STATUS ('global', 'PCursor') >= -1
        BEGIN
            DEALLOCATE PCursor;
        END;

    SET @S = 'DECLARE PCursor CURSOR FOR ' + CHAR (10) ;
    SET @S = @S + ' SELECT column_name, data_type, Character_Maximum_Length  ' + CHAR (10) ;
    SET @S = @S + ' FROM ' + @InstanceName + '.INFORMATION_SCHEMA.columns AS TC ' + CHAR (10) ;
    SET @S = @S + ' where TABLE_NAME = ''' + @TblName + '''' + CHAR (10) ;
    SET @S = @S + ' and column_name not like ''ct_%'' ' + CHAR (10) ;
    --print @S ;    
    EXEC (@S) ;

    OPEN PCursor;
    FETCH NEXT FROM PCursor INTO @COL, @DT, @Character_Maximum_Length;
    IF @@FETCH_STATUS <> 0
        BEGIN
            PRINT 'No PKs found';
            RETURN '';
        END;

    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @DT = 'nvarchar'
                BEGIN
                    SELECT
                           @TableCols = @TableCols + CHAR (10) + 'Declare @' + @COL + ' ' + @DT + '(' + CAST (@Character_Maximum_Length AS NVARCHAR (50)) + ') = NULL ;';
                END
            ELSE
                BEGIN IF @DT = 'varchar'
                          BEGIN
                              SELECT
                                     @TableCols = @TableCols + CHAR (10) + 'Declare @' + @COL + ' ' + @DT + '(' + CAST (@Character_Maximum_Length AS NVARCHAR (50)) + ') =NULL ;';
                          END
                      ELSE
                          BEGIN IF @DT = 'char'
                                    BEGIN
                                        SELECT
                                               @TableCols = @TableCols + CHAR (10) + 'Declare @' + @COL + ' ' + @DT + '(' + CAST (@Character_Maximum_Length AS NVARCHAR (50)) + ') =NULL ;';
                                    END
                                ELSE
                                    BEGIN
                                        SELECT
                                               @TableCols = @TableCols + CHAR (10) + 'Declare @' + @COL + ' ' + @DT + ' =NULL ;';
                                    END;
                          END;
                END;
            --PRINT @TableCols;
            FETCH NEXT FROM PCursor INTO @COL, @DT, @Character_Maximum_Length;
        END;

    CLOSE PCursor;
    DEALLOCATE PCursor;
    IF LEN (@TableCols) > 0
        BEGIN
            DECLARE @k AS INT = LEN (@TableCols) ;
            SET @TableCols = SUBSTRING (@TableCols, 1, @k - 1) ;
        END;
    --print @TableCols ;
    SET @ReturnedCols = @TableCols;
END;
GO
PRINT 'Executed proc_GenTableColumnsVariables.sql';
GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_UdpateTrackerCompositeFACTTbl.sql \n 
--------------------------------------------------------------- 
--select 'EXEC ' + name + char(10) + 'GO' +char(10) + 'print ''************************''' + char(10) from sys.procedures where name like 'proc_CT_FACT_Tracker%'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerBMI
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerCardio
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerFruits
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerHeight
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerShots
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerStrength
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerStress
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerTests
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerWater
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerWeight
GO
print '************************'

EXEC proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains
GO
print '************************'
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure.sql';
GO

IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure;
    END;
GO

/*-----------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerBloodPressure'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerBloodPressure'
select count(*) from BASE_HFit_TrackerBloodPressure
DBCC FREEPROCCACHE

update BASE_HFit_TrackerBloodPressure set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerBloodPressure)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure ;

select top 100 * from BASE_HFit_TrackerBloodPressure
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
           @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerBloodPressure'
         , @msg AS NVARCHAR (1000) = ''
         , @StepSecs AS BIGINT = 0
         , @TotalSecs AS BIGINT = 0
         , @StartTime AS DATETIME = GETDATE () 
         , @Step1Time AS DATETIME = GETDATE () 
         , @Step2Time AS DATETIME = GETDATE () 
         , @Step3Time AS DATETIME = GETDATE () 
         , @Step4Time AS DATETIME = GETDATE () 
         , @Step5Time AS DATETIME = GETDATE () 
         , @Step6Time AS DATETIME = GETDATE () 
         , @synchronization_version AS BIGINT = NULL
         , @LastVersion AS BIGINT = 0
         , @iCnt AS BIGINT = 0
         , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerBloodPressure' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerBloodPressure';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerBloodPressure;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerBloodPressure , @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                     FROM #TrackerData) ;
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBloodPressure', 'proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END
	   else 
		  PRINT '#Changes registered to process: ' + cast(@iChanges as nvarchR(50)) ;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                 FROM FACT_EDW_TrackerCompositeDetails
                 WHERE
                        TrackerNameAggregateTable = @AggregateTableName) ;

    IF
    @iChanges < 10 AND
    @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBloodPressure' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerBloodPressure' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
            FROM BASE_HFit_TrackerBloodPressure;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                 FROM #TrackerData) ;
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerBloodPressure') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    --select table_name, column_name, character_maximum_length, data_type  from information_schema.columns where table_name = 'FACT_EDW_TrackerCompositeDetails'
    --union 
    --select table_name, column_name, character_maximum_length, data_type  from information_schema.columns where table_name = 'BASE_HFit_TrackerBloodPressure'
    --order by column_name

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerBloodPressure' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'mm/Hg' AS UOM
         , 'Systolic' AS KEY1
         , CAST ( Systolic AS FLOAT) AS VAL1
         , 'Diastolic' AS KEY2
         , CAST ( Diastolic AS FLOAT) AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
    FROM
         dbo.BASE_HFit_TrackerBloodPressure AS TT
         INNER JOIN #TrackerData AS TD
         ON
            TT.SVR = TD.SVR AND
           TT.DBNAME = TD.DBNAME AND
           TT.ItemID = TD.ItemID AND
           TD.SYS_CHANGE_OPERATION = 'I'
         INNER JOIN dbo.BASE_CMS_User AS C
         ON
           C.UserID = TT.UserID AND
           C.SVR = TT.SVR AND
           C.DBNAME = TT.DBNAME
         INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
         ON
           TT.UserID = PP.userID AND
           TT.SVR = PP.SVR AND
           TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
        SET
            FT.AccountID = ACCT.AccountID
          ,FT.AccountCD = ACCT.AccountCD
    FROM FACT_EDW_TrackerCompositeDetails AS FT
         INNER JOIN dbo.BASE_HFit_Account AS ACCT
         ON
           FT.ClientCode = ACCT.AccountCD AND
           FT.SVR = ACCT.SVR AND
           FT.DBNAME = ACCT.DBNAME AND
           FT.TrackerNameAggregateTable = @AggregateTableName
         INNER JOIN #TrackerData AS TD
         ON
         FT.SVR = TD.SVR AND
           FT.DBNAME = TD.DBNAME AND
           FT.ItemID = TD.ItemID AND
           FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
        SET
            FT.AccountCD = ACCT.AccountCD
    FROM FACT_EDW_TrackerCompositeDetails AS FT
         INNER JOIN dbo.BASE_HFit_Account AS ACCT
         ON
           FT.ClientCode = ACCT.AccountCD AND
           FT.SVR = ACCT.SVR AND
           FT.DBNAME = ACCT.DBNAME AND
           FT.TrackerNameAggregateTable = @AggregateTableName
         INNER JOIN #TrackerData AS TD
         ON
         FT.SVR = TD.SVR AND
           FT.DBNAME = TD.DBNAME AND
           FT.ItemID = TD.ItemID AND
           FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
        SET
            FT.SiteGUID = S.SiteGUID
    FROM FACT_EDW_TrackerCompositeDetails AS FT
         INNER JOIN #TrackerData AS TD
         ON
         FT.SVR = TD.SVR AND
           FT.DBNAME = TD.DBNAME AND
           FT.ItemID = TD.ItemID AND
           FT.TrackerNameAggregateTable = 'HFit_TrackerBloodPressure'
         INNER JOIN dbo.BASE_HFit_Account AS ACCT
         ON
           FT.AccountCD = ACCT.AccountCD AND
           FT.SVR = ACCT.SVR AND
           FT.DBNAME = ACCT.DBNAME
         INNER JOIN dbo.BASE_CMS_Site AS S
         ON
           ACCT.SiteID = S.SiteID AND
           ACCT.SVR = S.SVR AND
           ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
        SET
            FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
          ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    FROM FACT_EDW_TrackerCompositeDetails AS FT
         INNER JOIN #TrackerData AS TD
         ON
         FT.SVR = TD.SVR AND
           FT.DBNAME = TD.DBNAME AND
           FT.ItemID = TD.ItemID AND
           FT.TrackerNameAggregateTable = 'HFit_TrackerBloodPressure'
         INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
         ON
           TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID AND
           TC.SVR = FT.SVR AND
           TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerBloodPressure AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerBloodPressure%'
    UPDATE FT
        SET
            FT.IsAvailable = T.IsAvailable
          ,FT.IsCustom = T.IsCustom
          ,FT.UniqueName = T.UniqueName
          ,FT.ColDesc = T.UniqueName
    FROM FACT_EDW_TrackerCompositeDetails AS FT
         INNER JOIN #TrackerData AS TD
         ON
         FT.SVR = TD.SVR AND
           FT.DBNAME = TD.DBNAME AND
           FT.ItemID = TD.ItemID AND
           FT.TrackerNameAggregateTable = 'HFit_TrackerBloodPressure'
         JOIN dbo.BASE_HFit_Tracker AS T
         ON
           T.AggregateTableName = 'HFit_TrackerBloodPressure' AND
           T.SVR = FT.SVR AND
           T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBloodPressure' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol;
    END;
GO

/*---------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where AggregateTableName = 'HFit_TrackerCholesterol'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol ;
select top 100 * from BASE_HFit_TrackerCholesterol
update BASE_HFit_TrackerCholesterol set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerCholesterol)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerCholesterol';
    DECLARE
    @msg AS NVARCHAR (1000) = '';
    DECLARE
    @StepSecs AS BIGINT = 0;
    DECLARE
    @TotalSecs AS BIGINT = 0;
    DECLARE
    @StartTime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6Time AS DATETIME = GETDATE () ;

    DECLARE
    @synchronization_version AS BIGINT = NULL;
    DECLARE
    @LastVersion AS BIGINT = 0;

    DECLARE
    @iCnt AS BIGINT = 0;
    DECLARE
    @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerCholesterol' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerCholesterol';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerCholesterol;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TCardio;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TCardio
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerCholesterol, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TCardio (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TCardio);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerCholesterol', 'proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerCholesterol' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TCardio;
            INSERT INTO #TCardio (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerCholesterol' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerCholesterol;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TCardio);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerCholesterol' AS AggregateTableName
         , TT.ItemID
         , CAST (EventDate AS DATETIME) AS EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
           --, CollectionSourceName_Internal
           --, CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'mg/dL' AS UOM
         , 'HDL' AS KEY1
         , CAST ( HDL AS FLOAT) AS VAL1
         , 'LDL' AS KEY2
         , CAST ( LDL AS FLOAT) AS VAL2
         , 'Total' AS KEY3
         , CAST ( Total AS FLOAT) AS VAL3
         , 'Tri' AS KEY4
         , CAST ( Tri AS FLOAT) AS VAL4
         , 'Ratio' AS KEY5
         , CAST ( Ratio AS FLOAT) AS VAL5
         , 'Fasting' AS KEY6
         , CAST ( Fasting AS FLOAT) AS VAL6
         , 'VLDL' AS KEY7
         , CAST ( VLDL AS FLOAT) AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
         , TT.ItemModifiedBy
         , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerCholesterol AS TT
                    INNER JOIN #TCardio AS CHG
                        ON TT.SVR = CHG.SVR
                       AND TT.DBNAME = CHG.DBNAME
                       AND TT.ItemID = CHG.ItemID
                       AND CHG.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerCholesterol';

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerCholesterol';

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TCardio AS CHG
                            ON
                            FT.SVR = CHG.SVR
                        AND FT.DBNAME = CHG.DBNAME
                        AND FT.ItemID = CHG.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TCardio AS CHG
                            ON
                            FT.SVR = CHG.SVR
                        AND FT.DBNAME = CHG.DBNAME
                        AND FT.ItemID = CHG.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerCholesterol AS BT
    --                    INNER JOIN #TCardio AS CHG
    --                        ON BT.SVR = CHG.SVR
    --                       AND BT.DBNAME = CHG.DBNAME
    --                       AND BT.ItemID = CHG.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerCholesterol'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableNAme like '%Cholesterol%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TCardio AS CHG
                            ON
                            FT.SVR = CHG.SVR
                        AND FT.DBNAME = CHG.DBNAME
                        AND FT.ItemID = CHG.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerCholesterol'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit.TrackerBMI'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerCholesterol' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where AggregateTableName = 'HFit_TrackerRegularMeals'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals ;
select top 100 * from BASE_HFit_TrackerRegularMeals
update BASE_HFit_TrackerRegularMeals set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerRegularMeals)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerRegularMeals'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerRegularMeals' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerRegularMeals';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerRegularMeals;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerRegularMeals, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerRegularMeals', 'proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerRegularMeals' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerRegularMeals' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerRegularMeals;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerRegularMeals') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerRegularMeals' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Occurs' AS UOM
         , 'Units' AS KEY1
         , CAST ( Units AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerRegularMeals AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerRegularMeals AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerRegularMeals%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerRegularMeals'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerRegularMeals' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan;
    END;
GO

/*---------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerMedicalCarePlan'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan ;
select top 100 * from BASE_HFit_TrackerMedicalCarePlan
update BASE_HFit_TrackerMedicalCarePlan set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerMedicalCarePlan)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerMedicalCarePlan';
    DECLARE
    @msg AS NVARCHAR (1000) = '';
    DECLARE
    @StepSecs AS BIGINT = 0;
    DECLARE
    @TotalSecs AS BIGINT = 0;
    DECLARE
    @StartTime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6Time AS DATETIME = GETDATE () ;

    DECLARE
    @synchronization_version AS BIGINT = NULL;
    DECLARE
    @LastVersion AS BIGINT = 0;

    DECLARE
    @iCnt AS BIGINT = 0;
    DECLARE
    @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerMedicalCarePlan' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerMedicalCarePlan';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerMedicalCarePlan;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerMedicalCarePlan, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerMedicalCarePlan', 'proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerMedicalCarePlan' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerMedicalCarePlan;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerMedicalCarePlan') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Y/N' AS UOM
         , 'FollowedPlan' AS KEY1
         , CAST ( FollowedPlan AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerMedicalCarePlan AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerMedicalCarePlan AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%_TrackerMedicalCarePlan%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = @AggregateTableName
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerMedicalCarePlan' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions;
    END;
GO

/*---------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerMealPortions'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions ;
select top 100 * from BASE_HFit_TrackerMealPortions
update BASE_HFit_TrackerMealPortions set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerMealPortions)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerMealPortions';
    DECLARE
    @msg AS NVARCHAR (1000) = '';
    DECLARE
    @StepSecs AS BIGINT = 0;
    DECLARE
    @TotalSecs AS BIGINT = 0;
    DECLARE
    @StartTime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6Time AS DATETIME = GETDATE () ;

    DECLARE
    @synchronization_version AS BIGINT = NULL;
    DECLARE
    @LastVersion AS BIGINT = 0;

    DECLARE
    @iCnt AS BIGINT = 0;
    DECLARE
    @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerMealPortions' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerMealPortions';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerMealPortions;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerMealPortions, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges = 0
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerMealPortions', 'proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges = 0
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerMealPortions' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerMealPortions;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerMealPortions') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'NA-portion' AS UOM
         , 'Portions' AS KEY1
         , CAST ( Portions AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerMealPortions AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerMealPortions'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName 

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerMealPortions'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerMealPortions AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerMealPortions'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%_TrackerMealPortions%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerMealPortions'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerMealPortions'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerMealPortions' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods;
    END;
GO

/*---------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where AggregateTableName = 'HFit_TrackerHighSodiumFoods'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods ;
select top 100 * from BASE_HFit_TrackerHighSodiumFoods
update BASE_HFit_TrackerHighSodiumFoods set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerHighSodiumFoods)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerHighSodiumFoods'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerHighSodiumFoods' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerHighSodiumFoods';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerHighSodiumFoods;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerHighSodiumFoods, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHighSodiumFoods', 'proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHighSodiumFoods' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerHighSodiumFoods' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerHighSodiumFoods;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerHighSodiumFoods') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerHighSodiumFoods' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Occurs' AS UOM
         , 'Times' AS KEY1
         , CAST ( Times AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerHighSodiumFoods AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHighSodiumFoods'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHighSodiumFoods'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerHighSodiumFoods AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerHighSodiumFoods'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerHighSodiumFoods%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHighSodiumFoods'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerHighSodiumFoods'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHighSodiumFoods' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods;
    END;
GO

/*---------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where AggregateTableName = 'HFit_TrackerHighFatFoods'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods ;
select top 100 * from BASE_HFit_TrackerHighFatFoods
update BASE_HFit_TrackerHighFatFoods set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerHighFatFoods)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerHighFatFoods';
    DECLARE
    @msg AS NVARCHAR (1000) = '';
    DECLARE
    @StepSecs AS BIGINT = 0;
    DECLARE
    @TotalSecs AS BIGINT = 0;
    DECLARE
    @StartTime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6Time AS DATETIME = GETDATE () ;

    DECLARE
    @synchronization_version AS BIGINT = NULL;
    DECLARE
    @LastVersion AS BIGINT = 0;

    DECLARE
    @iCnt AS BIGINT = 0;
    DECLARE
    @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerHighFatFoods' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerHighFatFoods';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerHighFatFoods;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerHighFatFoods, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHighFatFoods', 'proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHighFatFoods' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerHighFatFoods' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerHighFatFoods;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
		  --or table_name = 'BASE_HFit_TrackerHighFatFoods') and Data_type like '%varchar%'
		  --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
	   , CollectionSourceName_Internal
           , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
     'HFit_TrackerHighFatFoods' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
           ,NULL as CollectionSourceName_Internal
           ,NULL as CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Occurs' AS UOM
         , 'Times' AS KEY1
         , CAST ( Times AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerHighFatFoods AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHighFatFoods'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName 

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHighFatFoods'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName 

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerHighFatFoods AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerHighFatFoods'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerHighFatFoods%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHighFatFoods'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerHighFatFoods'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHighFatFoods' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerHeight.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerHeight.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerHeight') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerHeight.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerHeight;
    END;
GO

/*---------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerHeight'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerHeight ;
select top 100 * from BASE_HFit_TrackerHeight
update BASE_HFit_TrackerHeight set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerHeight)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerHeight
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerHeight';
    DECLARE
    @msg AS NVARCHAR (1000) = '';
    DECLARE
    @StepSecs AS BIGINT = 0;
    DECLARE
    @TotalSecs AS BIGINT = 0;
    DECLARE
    @StartTime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6Time AS DATETIME = GETDATE () ;

    DECLARE
    @synchronization_version AS BIGINT = NULL;
    DECLARE
    @LastVersion AS BIGINT = 0;

    DECLARE
    @iCnt AS BIGINT = 0;
    DECLARE
    @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerHeight' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHeight';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerHeight';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerHeight;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerHeight, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges = 0
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHeight', 'proc_CT_FACT_TrackerCompositeDetails_TrackerHeight' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges = 0
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHeight' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHeight' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerHeight' AS TrackerNameAggregateTable
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerHeight;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
	   , CollectionSourceName_Internal
           , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           @AggregateTableName AS TrackerNameAggregateTable
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
           , null as  CollectionSourceName_Internal
           , null as CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'inch' AS UOM
         , 'Height' AS KEY1
         , CAST ( Height AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , 0 AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerHeight AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHeight'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName 

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHeight'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName 

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerHeight AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerHeight'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%Height%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHeight'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerHeight'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHeight' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHeight' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerHeight.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c;
    END;
GO

/*---------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerHbA1c'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c ;
select top 100 * from BASE_HFit_TrackerHbA1c
update BASE_HFit_TrackerHbA1c set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerHbA1c)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerHbA1c';
    DECLARE
    @msg AS NVARCHAR (1000) = '';
    DECLARE
    @StepSecs AS BIGINT = 0;
    DECLARE
    @TotalSecs AS BIGINT = 0;
    DECLARE
    @StartTime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6Time AS DATETIME = GETDATE () ;

    DECLARE
    @synchronization_version AS BIGINT = NULL;
    DECLARE
    @LastVersion AS BIGINT = 0;

    DECLARE
    @iCnt AS BIGINT = 0;
    DECLARE
    @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerHbA1c' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerHbA1c';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerHbA1c;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerHbA1c, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges = 0
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHbA1c', 'proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges = 0
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHbA1c' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerHbA1c;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerHbA1c') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'mmol/mol' AS UOM
         , 'Value' AS KEY1
         , CAST ( Value AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerHbA1c AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHbA1c'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHbA1c'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerHbA1c AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerHbA1c'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableNAme like '%HbA1c%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerHbA1c'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerHbA1C'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerHbA1c' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerFruits.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerFruits.sql';
GO

IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerFruits') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerFruits.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerFruits;
    END;
GO

/**********************************************************************************************************************
use KenticoCMS_Datamart_2

delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerFruits'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerFruits ;
select top 100 * from BASE_HFit_TrackerFruits
update BASE_HFit_TrackerFruits set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerFruits)
**********************************************************************************************************************/

CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerFruits
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerFruits';
    DECLARE
    @msg AS NVARCHAR (1000) = '';
    DECLARE
    @StepSecs AS BIGINT = 0;
    DECLARE
    @TotalSecs AS BIGINT = 0;
    DECLARE
    @StartTime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6Time AS DATETIME = GETDATE () ;

    DECLARE
    @synchronization_version AS BIGINT = NULL;
    DECLARE
    @LastVersion AS BIGINT = 0;

    DECLARE
    @iCnt AS BIGINT = 0;
    DECLARE
    @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;
    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerFruits' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerFruits';
    EXEC PrintImmediate 'Processing BASE_HFit_TrackerFruits';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerFruits;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         ,SYS_CHANGE_VERSION
         ,SYS_CHANGE_OPERATION
         ,SYS_CHANGE_COLUMNS
         ,SVR
         ,DBNAME INTO
                      #TrackerData
    FROM CHANGETABLE (CHANGES BASE_HFit_TrackerFruits, null) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                     FROM #TrackerData) ;
    IF @iChanges = 0
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerFruits', 'proc_CT_FACT_TrackerCompositeDetails_TrackerFruits' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                 FROM FACT_EDW_TrackerCompositeDetails
                 WHERE
                        TrackerNameAggregateTable = @AggregateTableName) ;

    IF
       @iChanges = 0 AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update 'BASE_HFit_TrackerFruits' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerFruits' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 ,SYS_CHANGE_VERSION
                 ,SYS_CHANGE_OPERATION
                 ,SYS_CHANGE_COLUMNS
                 ,SVR
                 ,DBNAME) 
            SELECT
            --  'HFit_TrackerFruits' AS TrackerNameAggregateTable
                   ITEMID
          ,0 AS SYS_CHANGE_VERSION
          ,'I' AS SYS_CHANGE_OPERATION
          ,NULL AS SYS_CHANGE_COLUMNS
          ,SVR
          ,DBNAME
            FROM BASE_HFit_TrackerFruits;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                 FROM #TrackerData) ;
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    INSERT INTO FACT_EDW_TrackerCompositeDetails (
           TrackerNameAggregateTable
         ,ItemID
         ,EventDate
         ,IsProfessionallyCollected
         ,TrackerCollectionSourceID
         ,Notes
         ,UserID
         ,EventName
         ,UOM
         ,KEY1
         ,VAL1
         ,Key2
         ,Val2
         ,Key3
         ,Val3
         ,Key4
         ,Val4
         ,Key5
         ,Val5
         ,Key6
         ,Val6
         ,Key7
         ,Val7
         ,Key8
         ,Val8
         ,Key9
         ,Val9
         ,Key10
         ,Val10
         ,ItemCreatedBy
         ,ItemCreatedWhen
         ,ItemModifiedBy
         ,ItemModifiedWhen
         ,IsProcessedForHa
         ,TXTKEY1
         ,TXTVAL1
         ,TXTKEY2
         ,TXTVAL2
         ,TXTKEY3
         ,TXTVAL3
         ,ItemOrder
         ,ItemGuid
         ,UserGuid
         ,MPI
         ,ClientCode
         ,VendorID
         ,VendorName
         ,LastModifiedDate
         ,SVR
         ,DBNAME) 
    SELECT DISTINCT
           @AggregateTableName AS TrackerNameAggregateTable
         ,TT.ItemID
         ,EventDate
         ,TT.IsProfessionallyCollected
         ,TT.TrackerCollectionSourceID
         ,Notes
         ,TT.UserID
           --, CollectionSourceName_Internal
           --, CollectionSourceName_External
         ,
           'MISSING' AS EventName
         ,'CUP(8oz)' AS UOM
         ,'Cups' AS KEY1
         ,CAST (Cups AS FLOAT) AS VAL1
         ,'NA' AS KEY2
         ,0 AS VAL2
         ,'NA' AS KEY3
         ,NULL AS VAL3
         ,'NA' AS KEY4
         ,NULL AS VAL4
         ,'NA' AS KEY5
         ,NULL AS VAL5
         ,'NA' AS KEY6
         ,NULL AS VAL6
         ,'NA' AS KEY7
         ,NULL AS VAL7
         ,'NA' AS KEY8
         ,NULL AS VAL8
         ,'NA' AS KEY9
         ,NULL AS VAL9
         ,'NA' AS KEY10
         ,NULL AS VAL10
         ,TT.ItemCreatedBy
         ,TT.ItemCreatedWhen
         ,TT.ItemModifiedBy
         ,TT.ItemModifiedWhen
         ,NULL AS IsProcessedForHa
         ,'NA' AS TXTKEY1
         ,NULL AS TXTVAL1
         ,'NA' AS TXTKEY2
         ,NULL AS TXTVAL2
         ,'NA' AS TXTKEY3
         ,NULL AS TXTVAL3
         ,NULL AS ItemOrder
         ,NULL AS ItemGuid
         ,C.UserGuid
         ,PP.MPI
         ,PP.ClientCode
         ,NULL AS VendorID	--VENDOR.ItemID as VendorID
         ,
           NULL AS VendorName --VENDOR.VendorName
         ,
           TT.LastModifiedDate
         ,TT.SVR
         ,TT.DBNAME
    FROM
         dbo.BASE_HFit_TrackerFruits AS TT
              INNER JOIN #TrackerData AS TD
              ON
                 TT.SVR = TD.SVR AND
           TT.DBNAME = TD.DBNAME AND
           TT.ItemID = TD.ItemID AND
           TD.SYS_CHANGE_OPERATION = 'I'
              INNER JOIN dbo.BASE_CMS_User AS C
              ON
           C.UserID = TT.UserID AND C.SVR = TT.SVR AND
           C.DBNAME = TT.DBNAME
              INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
              ON
           TT.UserID = PP.userID AND TT.SVR = PP.SVR AND
           TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
        SET
            FT.AccountID = ACCT.AccountID
          ,FT.AccountCD = ACCT.AccountCD
    FROM FACT_EDW_TrackerCompositeDetails AS FT
              INNER JOIN dbo.BASE_HFit_Account AS ACCT
              ON
           FT.ClientCode = ACCT.AccountCD AND
           FT.SVR = ACCT.SVR AND
           FT.DBNAME = ACCT.DBNAME AND
           FT.TrackerNameAggregateTable = 'HFit_TrackerFruits'
              INNER JOIN #TrackerData AS TD
              ON
                 FT.SVR = TD.SVR AND
           FT.DBNAME = TD.DBNAME AND
           FT.ItemID = TD.ItemID AND
           FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
        SET
            FT.AccountCD = ACCT.AccountCD
    FROM FACT_EDW_TrackerCompositeDetails AS FT
              INNER JOIN dbo.BASE_HFit_Account AS ACCT
              ON
           FT.ClientCode = ACCT.AccountCD AND
           FT.SVR = ACCT.SVR AND
           FT.DBNAME = ACCT.DBNAME AND
           FT.TrackerNameAggregateTable = 'HFit_TrackerFruits'
              INNER JOIN #TrackerData AS TD
              ON
                 FT.SVR = TD.SVR AND
           FT.DBNAME = TD.DBNAME AND
           FT.ItemID = TD.ItemID AND
           FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
        SET
            FT.SiteGUID = S.SiteGUID
    FROM FACT_EDW_TrackerCompositeDetails AS FT
              INNER JOIN #TrackerData AS TD
              ON
                 FT.SVR = TD.SVR AND
           FT.DBNAME = TD.DBNAME AND
           FT.ItemID = TD.ItemID AND
           FT.TrackerNameAggregateTable = @AggregateTableName
              INNER JOIN dbo.BASE_HFit_Account AS ACCT
              ON
           FT.AccountCD = ACCT.AccountCD AND
           FT.SVR = ACCT.SVR AND
           FT.DBNAME = ACCT.DBNAME
              INNER JOIN dbo.BASE_CMS_Site AS S
              ON
           ACCT.SiteID = S.SiteID AND ACCT.SVR = S.SVR AND
           ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
        SET
            FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
          ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    FROM FACT_EDW_TrackerCompositeDetails AS FT
              INNER JOIN #TrackerData AS TD
              ON
                 FT.SVR = TD.SVR AND
           FT.DBNAME = TD.DBNAME AND
           FT.ItemID = TD.ItemID AND
           FT.TrackerNameAggregateTable = @AggregateTableName
              INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
              ON
           TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID AND TC.SVR = FT.SVR AND
           TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerFruits AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerFruits'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%Fruits%'
    UPDATE FT
        SET
            FT.IsAvailable = T.IsAvailable
          ,FT.IsCustom = T.IsCustom
          ,FT.UniqueName = T.UniqueName
          ,FT.ColDesc = T.UniqueName
    FROM FACT_EDW_TrackerCompositeDetails AS FT
              INNER JOIN #TrackerData AS TD
              ON
                 FT.SVR = TD.SVR AND
           FT.DBNAME = TD.DBNAME AND
           FT.ItemID = TD.ItemID AND
           FT.TrackerNameAggregateTable = 'HFit_TrackerFruits'
              JOIN dbo.BASE_HFit_Tracker AS T
              ON
           T.AggregateTableName = 'HFit_TrackerFruits' AND T.SVR = FT.SVR AND
           T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    EXEC proc_MASTER_LKP_CTVersion_Update 'BASE_HFit_TrackerFruits' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerFruits' , @synchronization_version;
    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerFruits.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility;
    END;
GO

/*---------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerFlexibility'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility ;
select top 100 * from BASE_HFit_TrackerFlexibility
update BASE_HFit_TrackerFlexibility set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerFlexibility)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerFlexibility';
    DECLARE
    @msg AS NVARCHAR (1000) = '';
    DECLARE
    @StepSecs AS BIGINT = 0;
    DECLARE
    @TotalSecs AS BIGINT = 0;
    DECLARE
    @StartTime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6Time AS DATETIME = GETDATE () ;

    DECLARE
    @synchronization_version AS BIGINT = NULL;
    DECLARE
    @LastVersion AS BIGINT = 0;

    DECLARE
    @iCnt AS BIGINT = 0;
    DECLARE
    @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerFlexibility' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerFlexibility';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerFlexibility;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerFlexibility, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerFlexibility', 'proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerFlexibility' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerFlexibility' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerFlexibility;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           @AggregateTableName AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
           --, CollectionSourceName_Internal
           --, CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Y/N' AS UOM
         , 'HasStretched' AS KEY1
         , CAST ( HasStretched AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , 0 AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerFlexibility AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerFlexibility'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName 

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerFlexibility'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName 

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerFlexibility AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerFlexibility'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerFlexibility%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerFlexibility'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerFlexibility'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerFlexibility' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps;
    END;
GO
/*
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerDailySteps'

DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps ;
select top 100 * from BASE_HFit_TrackerDailySteps

update BASE_HFit_TrackerDailySteps set HAshCode = '@' where ItemID in (select top 2000 itemid from BASE_HFit_TrackerDailySteps)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerDailySteps';
    DECLARE @msg AS NVARCHAR (1000) = '';
    DECLARE @StepSecs AS BIGINT = 0;
    DECLARE @TotalSecs AS BIGINT = 0;
    DECLARE @StartTime AS DATETIME = GETDATE () ;
    DECLARE @Step1Time AS DATETIME = GETDATE () ;
    DECLARE @Step2Time AS DATETIME = GETDATE () ;
    DECLARE @Step3Time AS DATETIME = GETDATE () ;
    DECLARE @Step4Time AS DATETIME = GETDATE () ;
    DECLARE @Step5Time AS DATETIME = GETDATE () ;
    DECLARE @Step6Time AS DATETIME = GETDATE () ;

    DECLARE @synchronization_version AS BIGINT = NULL;
    DECLARE @LastVersion AS BIGINT = 0;

    DECLARE @iCnt AS BIGINT = 0;
    DECLARE @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerDailySteps', 'proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps';
    
    EXEC PrintImmediate 'Processing BASE_HFit_TrackerDailySteps';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerDailySteps;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    begin try
	   drop table #TrackerData;
    end try
    begin catch 
	   exec printImmediate 'Loading temp table' ;
    end catch 
    SELECT 
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerDailySteps, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR, DBNAME, ItemID, SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges = 0
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerDailySteps', 'proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE TrackerNameAggregateTable = @AggregateTableName);

    IF @iChanges = 0
   AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerDailySteps', 'proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerDailySteps' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerDailySteps;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           @AggregateTableName AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
           --, CollectionSourceName_Internal
           --, CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Step' AS UOM
         , 'Steps' AS KEY1
         , CAST ( Steps AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerDailySteps AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME ;

    SET @StepSecs = DATEDIFF (second, @StartTime, GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM BASE_HFit_TrackerDailySteps AS BT
                        INNER JOIN #TrackerData AS TD
                            ON BT.SVR = TD.SVR
                           AND BT.DBNAME = TD.DBNAME
                           AND BT.ItemID = TD.ItemID
                        JOIN FACT_EDW_TrackerCompositeDetails AS FT
                            ON
                            BT.SVR = FT.SVR
                        AND BT.DBNAME = FT.DBNAME
                        AND BT.ItemID = FT.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME;

    SET @StepSecs = DATEDIFF (second, @Step1Time, @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM BASE_HFit_TrackerDailySteps AS BT
                        INNER JOIN #TrackerData AS TD
                            ON BT.SVR = TD.SVR
                           AND BT.DBNAME = TD.DBNAME
                           AND BT.ItemID = TD.ItemID
                        JOIN FACT_EDW_TrackerCompositeDetails AS FT
                            ON
                            BT.ItemID = FT.ItemID
                        AND FT.SVR = BT.SVR
                        AND FT.DBNAME = BT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME;

    SET @StepSecs = DATEDIFF (second, @Step2Time, @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON FT.SVR = TD.SVR
                           AND FT.DBNAME = TD.DBNAME
                           AND FT.ItemID = TD.ItemID
                           AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second, @Step3Time, @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';
    
    UPDATE FT
			SET
			 FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
			  ,FT.CollectionSourceName_External = TC.CollectionSourceName_External		
			    FROM FACT_EDW_TrackerCompositeDetails AS FT
					   INNER JOIN #TrackerData AS TD
						  ON FT.SVR = TD.SVR
						 AND FT.DBNAME = TD.DBNAME
						 AND FT.ItemID = TD.ItemID
						  AND FT.TrackerNameAggregateTable = @AggregateTableName
					   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
						  ON
						  TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
					   AND TC.SVR = FT.SVR
					   AND TC.DBNAME = FT.DBNAME ;



    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerDailySteps AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerDailySteps'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;
    
    SET @StepSecs = DATEDIFF (second, @Step4Time, @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerDailySteps%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON FT.SVR = TD.SVR
                           AND FT.DBNAME = TD.DBNAME
                           AND FT.ItemID = TD.ItemID
                           AND FT.TrackerNameAggregateTable = 'HFit_TrackerDailySteps'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerDailySteps'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second, @Step5Time, @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second, @StartTime, GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerDailySteps', 'proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerCardio.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerCardio.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerCardio') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerCardio.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerCardio;
    END;
GO
/*
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerCardio ;
select top 100 * from BASE_HFit_TrackerCardio
update BASE_HFit_TrackerCardio set HAshCode = '@' where ItemID in (select top 5000 itemid from BASE_HFit_TrackerCardio)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerCardio
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;

    DECLARE @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerCardio';
    DECLARE @msg AS NVARCHAR (1000) = '';
    DECLARE @StepSecs AS BIGINT = 0;
    DECLARE @TotalSecs AS BIGINT = 0;
    DECLARE @StartTime AS DATETIME = GETDATE () ;
    DECLARE @Step1Time AS DATETIME = GETDATE () ;
    DECLARE @Step2Time AS DATETIME = GETDATE () ;
    DECLARE @Step3Time AS DATETIME = GETDATE () ;
    DECLARE @Step4Time AS DATETIME = GETDATE () ;
    DECLARE @Step5Time AS DATETIME = GETDATE () ;
    DECLARE @Step6Time AS DATETIME = GETDATE () ;

    DECLARE @synchronization_version AS BIGINT = NULL;
    DECLARE @LastVersion AS BIGINT = 0;

    DECLARE @iCnt AS BIGINT = 0;
    DECLARE @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerCardio', 'proc_CT_FACT_TrackerCompositeDetails_TrackerCardio';
    
    EXEC PrintImmediate 'Processing BASE_HFit_TrackerCardio';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerCardio;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    --drop table #TrackerData;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerCardio, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR, DBNAME, ItemID, SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerCardio', 'proc_CT_FACT_TrackerCompositeDetails_TrackerCardio' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE TrackerNameAggregateTable = @AggregateTableName);

    IF @iChanges < 10
   AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerCardio', 'proc_CT_FACT_TrackerCompositeDetails_TrackerCardio' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerCardio' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerCardio;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT
           @AggregateTableName AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
           --, CollectionSourceName_Internal
           --, CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'NA' AS UOM
         , 'Minutes' AS KEY1
         , CAST ( Minutes AS FLOAT) AS VAL1
         , 'Distance' AS KEY2
         , CAST ( Distance AS FLOAT) AS VAL2
         , 'DistanceUnit' AS KEY3
         , CAST ( DistanceUnit AS FLOAT) AS VAL3
         , 'Intensity' AS KEY4
         , CAST ( Intensity AS FLOAT) AS VAL4
         , 'ActivityID' AS KEY5
         , CAST ( ActivityID AS FLOAT) AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerCardio AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME
           WHERE
           EventDate > '01/01/1960';

    SET @StepSecs = DATEDIFF (second, @StartTime, GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM BASE_HFit_TrackerCardio AS BT
                        INNER JOIN #TrackerData AS TD
                            ON BT.SVR = TD.SVR
                           AND BT.DBNAME = TD.DBNAME
                           AND BT.ItemID = TD.ItemID
                        JOIN FACT_EDW_TrackerCompositeDetails AS FT
                            ON
                            BT.SVR = FT.SVR
                        AND BT.DBNAME = FT.DBNAME
                        AND BT.ItemID = FT.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME;

    SET @StepSecs = DATEDIFF (second, @Step1Time, @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM BASE_HFit_TrackerCardio AS BT
                        INNER JOIN #TrackerData AS TD
                            ON BT.SVR = TD.SVR
                           AND BT.DBNAME = TD.DBNAME
                           AND BT.ItemID = TD.ItemID
                        JOIN FACT_EDW_TrackerCompositeDetails AS FT
                            ON
                            BT.ItemID = FT.ItemID
                        AND FT.SVR = BT.SVR
                        AND FT.DBNAME = BT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME;

    SET @StepSecs = DATEDIFF (second, @Step2Time, @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON FT.SVR = TD.SVR
                           AND FT.DBNAME = TD.DBNAME
                           AND FT.ItemID = TD.ItemID
                           AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second, @Step3Time, @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';
    
    UPDATE FT
			SET
			 FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
			  ,FT.CollectionSourceName_External = TC.CollectionSourceName_External			   
			    FROM FACT_EDW_TrackerCompositeDetails AS FT
					   INNER JOIN #TrackerData AS TD
						  ON FT.SVR = TD.SVR
						 AND FT.DBNAME = TD.DBNAME
						 AND FT.ItemID = TD.ItemID
					   INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
						  ON
						  TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
					   AND TC.SVR = FT.SVR
					   AND TC.DBNAME = FT.DBNAME ;



    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerCardio AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerCardio'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;
    
    SET @StepSecs = DATEDIFF (second, @Step4Time, @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON FT.SVR = TD.SVR
                           AND FT.DBNAME = TD.DBNAME
                           AND FT.ItemID = TD.ItemID
                           AND FT.TrackerNameAggregateTable = 'HFit_TrackerCardio'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerCardio'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second, @Step5Time, @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second, @StartTime, GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerCardio', 'proc_CT_FACT_TrackerCompositeDetails_TrackerCardio' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerCardio.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerBMI.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerBMI.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerBMI') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerBMI.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerBMI;
    END;
GO

/*---------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where AggregateTableName = 'HFit_TrackerBMI'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerBMI ;
select top 100 * from BASE_HFit_TrackerBMI
update BASE_HFit_TrackerBMI set HAshCode = '@' where ItemID in (select top 500 itemid from BASE_HFit_TrackerBMI)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerBMI
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerBMI';
    DECLARE
    @msg AS NVARCHAR (1000) = '';
    DECLARE
    @StepSecs AS BIGINT = 0;
    DECLARE
    @TotalSecs AS BIGINT = 0;
    DECLARE
    @StartTime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6Time AS DATETIME = GETDATE () ;

    DECLARE
    @synchronization_version AS BIGINT = NULL;
    DECLARE
    @LastVersion AS BIGINT = 0;

    DECLARE
    @iCnt AS BIGINT = 0;
    DECLARE
    @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerBMI' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBMI';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerBMI';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerBMI;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerBMI, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges = 0
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBMI', 'proc_CT_FACT_TrackerCompositeDetails_TrackerBMI' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges = 0
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBMI' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBMI' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerBMI' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerBMI;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           @AggregateTableName AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
           --, CollectionSourceName_Internal
           --, CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'kg/m2' AS UOM
         , 'BMI' AS KEY1
         , CAST ( BMI AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerBMI AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBMI'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName 

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBMI'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName 

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerBMI AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerBMI'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%BMI%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBMI'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerBMI'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBMI' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBMI' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerBMI.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat;
    END;
GO

/*---------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where AggregateTableName = 'HFit_TrackerBodyFat'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat ;
select top 100 * from BASE_HFit_TrackerBodyFat
update BASE_HFit_TrackerBodyFat set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerBodyFat)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerBodyFat';
    DECLARE
    @msg AS NVARCHAR (1000) = '';
    DECLARE
    @StepSecs AS BIGINT = 0;
    DECLARE
    @TotalSecs AS BIGINT = 0;
    DECLARE
    @StartTime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5Time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6Time AS DATETIME = GETDATE () ;

    DECLARE
    @synchronization_version AS BIGINT = NULL;
    DECLARE
    @LastVersion AS BIGINT = 0;

    DECLARE
    @iCnt AS BIGINT = 0;
    DECLARE
    @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerBodyFat' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerBodyFat';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerBodyFat;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerBodyFat, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges = 0
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBodyFat', 'proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges = 0
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBodyFat' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerBodyFat' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerBodyFat;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           @AggregateTableName AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
           --, CollectionSourceName_Internal
           --, CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'PCT' AS UOM
         , 'Value' AS KEY1
         , CAST ( Value AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , 0 AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerBodyFat AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBodyFat'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBodyFat';

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerBodyFat AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerBodyFat'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerBodyFat%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBodyFat'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerBodyFat'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBodyFat' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where AggregateTableName = 'HFit_TrackerRestingHeartRate'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate ;
select top 100 * from BASE_HFit_TrackerRestingHeartRate
update BASE_HFit_TrackerRestingHeartRate set HAshCode = '@' where ItemID in (select top 500 itemid from BASE_HFit_TrackerRestingHeartRate order by itemid  desc)
*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerRestingHeartRate'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerRestingHeartRate' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerRestingHeartRate';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerRestingHeartRate;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerRestingHeartRate, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerRestingHeartRate', 'proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerRestingHeartRate' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerRestingHeartRate' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerRestingHeartRate;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerRestingHeartRate') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerRestingHeartRate' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'BPM' AS UOM
         , 'HeartRate' AS KEY1
         , CAST ( HeartRate AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerRestingHeartRate AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON TD.ItemID = FT.ItemID
                           AND TD.SVR = FT.SVR
                           AND TD.DBNAME = FT.DBNAME
                           AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON TD.ItemID = FT.ItemID
                           AND TD.SVR = FT.SVR
                           AND TD.DBNAME = FT.DBNAME
                           AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerRestingHeartRate AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerRestingHeartRate'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerRestingHeartRate%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerRestingHeartRate' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerShots.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerShots.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerShots') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerShots.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerShots;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerShots'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerShots'
select count(*) from BASE_HFit_TrackerShots
DBCC FREEPROCCACHE

update BASE_HFit_TrackerShots set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerShots)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerShots ;

select top 100 * from BASE_HFit_TrackerShots

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerShots
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerShots'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerShots' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerShots';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerShots';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerShots;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerShots, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerShots', 'proc_CT_FACT_TrackerCompositeDetails_TrackerShots' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerShots' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerShots' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerShots' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerShots;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerShots') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerShots' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Y/N' AS UOM
         , 'FluShot' AS KEY1
         , CAST ( FluShot AS FLOAT) AS VAL1
         , 'PneumoniaShot' AS KEY2
         , CAST ( PneumoniaShot AS FLOAT) AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerShots AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerShots'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerShots'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerShots AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerShots%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerShots'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerShots'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerShots' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerShots' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerShots.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerSitLess'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerSitLess'
select count(*) from BASE_HFit_TrackerSitLess
DBCC FREEPROCCACHE

update BASE_HFit_TrackerSitLess set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerSitLess)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess ;

select top 100 * from BASE_HFit_TrackerSitLess

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerSitLess'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerSitLess' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerSitLess';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerSitLess;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerSitLess, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSitLess', 'proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSitLess' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerSitLess' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerSitLess;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerSitLess') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerSitLess' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Occurs' AS UOM
         , 'Times' AS KEY1
         , CAST ( Times AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerSitLess AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSitLess'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSitLess'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerSitLess AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerSitLess%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSitLess'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerSitLess'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSitLess' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerSleepPlan'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerSleepPlan'
select count(*) from BASE_HFit_TrackerSleepPlan
DBCC FREEPROCCACHE

update BASE_HFit_TrackerSleepPlan set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerSleepPlan)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan ;

select top 100 * from BASE_HFit_TrackerSleepPlan

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerSleepPlan'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerSleepPlan' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerSleepPlan';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerSleepPlan;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerSleepPlan, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSleepPlan', 'proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSleepPlan' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerSleepPlan' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerSleepPlan;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerSleepPlan') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerSleepPlan' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'HR' AS UOM
         , 'DidFollow' AS KEY1
         , CAST ( DidFollow AS FLOAT) AS VAL1
         , 'HoursSlept' AS KEY2
         , CAST ( HoursSlept AS FLOAT)  AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerSleepPlan AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSleepPlan'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSleepPlan'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerSleepPlan AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerSleepPlan%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSleepPlan'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerSleepPlan'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSleepPlan' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerStrength.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerStrength.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerStrength') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerStrength.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerStrength;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerStrength'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerStrength'
select count(*) from BASE_HFit_TrackerStrength
DBCC FREEPROCCACHE

update BASE_HFit_TrackerStrength set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerStrength)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerStrength ;

select top 100 * from BASE_HFit_TrackerStrength

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerStrength
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerStrength'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerStrength' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerStrength';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerStrength';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerStrength;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerStrength, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerStrength', 'proc_CT_FACT_TrackerCompositeDetails_TrackerStrength' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerStrength' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerStrength' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerStrength' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerStrength;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerStrength') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerStrength' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Y/N' AS UOM
         , 'HasTrained' AS KEY1
         , HasTrained AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen 
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen 
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerStrength AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerStrength'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerStrength'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerStrength AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerStrength%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerStrength'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerStrength'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerStrength' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerStrength' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerStrength.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerStress.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerStress.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerStress') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerStress.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerStress;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerStress'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerStress'
select count(*) from BASE_HFit_TrackerStress
DBCC FREEPROCCACHE

update BASE_HFit_TrackerStress set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerStress)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerStress ;

select top 100 * from BASE_HFit_TrackerStress

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerStress
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerStress'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerStress' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerStress';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerStress';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerStress;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerStress, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerStress', 'proc_CT_FACT_TrackerCompositeDetails_TrackerStress' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerStress' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerStress' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerStress' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerStress;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerStress') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerStress' AS AggregateTableName
         , TT.ItemID
         , CAST (EventDate AS DATETIME) AS EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'gradient' AS UOM
         , 'Intensity' AS KEY1
         , CAST ( Intensity AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , CAST (TT.ItemCreatedWhen AS DATETIME) AS ItemCreatedWhen
         , TT.ItemModifiedBy
         , CAST (TT.ItemModifiedWhen AS DATETIME) AS ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerStress AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerStress'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerStress'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerStress AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerStress%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerStress'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerStress'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerStress' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerStress' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerStress.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerStressManagement'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerStressManagement'
select count(*) from BASE_HFit_TrackerStressManagement
DBCC FREEPROCCACHE

update BASE_HFit_TrackerStressManagement set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerStressManagement)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement ;

select top 100 * from BASE_HFit_TrackerStressManagement

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerStressManagement'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerStressManagement' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerStressManagement';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerStressManagement;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerStressManagement, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerStressManagement', 'proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerStressManagement' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerStressManagement' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerStressManagement;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerStressManagement') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerStressManagement' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'gradient' AS UOM
         , 'HasPracticed' AS KEY1
         , CAST ( HasPracticed AS FLOAT) AS VAL1
         , 'Effectiveness' AS KEY2
         , CAST ( Effectiveness AS FLOAT) AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerStressManagement AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerStressManagement'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerStressManagement'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerStressManagement AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerStressManagement%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerStressManagement'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerStressManagement'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerStressManagement' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerSugaryDrinks'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerSugaryDrinks'
select count(*) from BASE_HFit_TrackerSugaryDrinks
DBCC FREEPROCCACHE

update BASE_HFit_TrackerSugaryDrinks set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerSugaryDrinks)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks ;

select top 100 * from BASE_HFit_TrackerSugaryDrinks

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerSugaryDrinks'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerSugaryDrinks' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerSugaryDrinks';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerSugaryDrinks;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerSugaryDrinks, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSugaryDrinks', 'proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSugaryDrinks' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerSugaryDrinks' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerSugaryDrinks;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerSugaryDrinks') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerSugaryDrinks' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'OZ' AS UOM
         , 'Ounces' AS KEY1
         , CAST ( Ounces AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerSugaryDrinks AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSugaryDrinks'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSugaryDrinks'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerSugaryDrinks AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerSugaryDrinks%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSugaryDrinks'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerSugaryDrinks'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSugaryDrinks' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerSugaryFoods'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerSugaryFoods'
select count(*) from BASE_HFit_TrackerSugaryFoods
DBCC FREEPROCCACHE

update BASE_HFit_TrackerSugaryFoods set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerSugaryFoods)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods ;

select top 100 * from BASE_HFit_TrackerSugaryFoods

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerSugaryFoods'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerSugaryFoods' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerSugaryFoods';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerSugaryFoods;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerSugaryFoods, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSugaryFoods', 'proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSugaryFoods' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerSugaryFoods' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerSugaryFoods;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerSugaryFoods') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerSugaryFoods' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Portion' AS UOM
         , 'Portions' AS KEY1
         , CAST ( Portions AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerSugaryFoods AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSugaryFoods'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSugaryFoods'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerSugaryFoods AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerSugaryFoods%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerSugaryFoods'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerSugaryFoods'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerSugaryFoods' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerTobaccoFree'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerTobaccoFree'
select count(*) from BASE_HFit_TrackerTobaccoFree
DBCC FREEPROCCACHE

update BASE_HFit_TrackerTobaccoFree set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerTobaccoFree)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree ;

select top 100 * from BASE_HFit_TrackerTobaccoFree

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerTobaccoFree'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerTobaccoFree' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerTobaccoFree';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerTobaccoFree;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerTobaccoFree, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerTobaccoFree', 'proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerTobaccoFree' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerTobaccoFree' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerTobaccoFree;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerTobaccoFree') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerTobaccoFree' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Y/N' AS UOM
         , 'WasTobaccoFree' AS KEY1
         , CAST ( WasTobaccoFree AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerTobaccoFree AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerTobaccoFree'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerTobaccoFree'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerTobaccoFree AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerTobaccoFree%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerTobaccoFree'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerTobaccoFree'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerTobaccoFree' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerVegetables'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerVegetables'
select count(*) from BASE_HFit_TrackerVegetables
DBCC FREEPROCCACHE

update BASE_HFit_TrackerVegetables set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerVegetables)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables ;

select top 100 * from BASE_HFit_TrackerVegetables

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerVegetables'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerVegetables' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerVegetables';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerVegetables;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerVegetables, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerVegetables', 'proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerVegetables' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerVegetables' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerVegetables;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerVegetables') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerVegetables' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'CUP(8oz)' AS UOM
         , 'Cups' AS KEY1
         , CAST ( Cups AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerVegetables AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerVegetables'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerVegetables'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerVegetables AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerVegetables%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerVegetables'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerVegetables'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerVegetables' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerWater.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerWater.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerWater') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerWater.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerWater;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerWater'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerWater'
select count(*) from BASE_HFit_TrackerWater
DBCC FREEPROCCACHE

update BASE_HFit_TrackerWater set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerWater)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerWater ;

select top 100 * from BASE_HFit_TrackerWater

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerWater
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerWater'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerWater' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerWater';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerWater';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerWater;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerWater, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerWater', 'proc_CT_FACT_TrackerCompositeDetails_TrackerWater' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerWater' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerWater' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerWater' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerWater;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerWater') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerWater' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'OZ' AS UOM
         , 'Ounces' AS KEY1
         , CAST ( Ounces AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerWater AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerWater'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerWater'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerWater AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerWater%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerWater'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerWater'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerWater' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerWater' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerWater.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerWeight.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerWeight.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerWeight') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerWeight.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerWeight;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerWeight'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerWeight'
select count(*) from BASE_HFit_TrackerWeight
DBCC FREEPROCCACHE

update BASE_HFit_TrackerWeight set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerWeight)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerWeight ;

select top 100 * from BASE_HFit_TrackerWeight

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerWeight
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerWeight'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerWeight' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerWeight';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerWeight';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerWeight;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerWeight, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerWeight', 'proc_CT_FACT_TrackerCompositeDetails_TrackerWeight' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerWeight' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerWeight' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerWeight' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerWeight;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerWeight') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerWeight' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'LBS' AS UOM
         , 'Value' AS KEY1
         , CAST ( Value AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerWeight AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerWeight'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerWeight'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerWeight AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerWeight%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerWeight'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerWeight'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerWeight' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerWeight' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerWeight.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerWholeGrains'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerWholeGrains'
select count(*) from BASE_HFit_TrackerWholeGrains
DBCC FREEPROCCACHE

update BASE_HFit_TrackerWholeGrains set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerWholeGrains)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains ;

select top 100 * from BASE_HFit_TrackerWholeGrains

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerWholeGrains'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerWholeGrains' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerWholeGrains';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerWholeGrains;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerWholeGrains, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerWholeGrains', 'proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerWholeGrains' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerWholeGrains' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerWholeGrains;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerWholeGrains') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerWholeGrains' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'Serving' AS UOM
         , 'Servings' AS KEY1
         , CAST ( Servings AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerWholeGrains AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerWholeGrains'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerWholeGrains'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerWholeGrains AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerWholeGrains%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerWholeGrains'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerWholeGrains'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerWholeGrains' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerCotinine'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerCotinine'
select count(*) from BASE_HFit_TrackerCotinine
DBCC FREEPROCCACHE

update BASE_HFit_TrackerCotinine set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerCotinine)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine ;

select top 100 * from BASE_HFit_TrackerCotinine

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerCotinine'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerCotinine' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerCotinine';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerCotinine;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerCotinine, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerCotinine', 'proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerCotinine' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerCotinine' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerCotinine;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerCotinine') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerCotinine' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'NA' AS UOM
         , 'NicotineAssessment' AS KEY1
         , CAST ( NicotineAssessment AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerCotinine AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerCotinine'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerCotinine'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerCotinine AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerCotinine%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerCotinine'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerCotinine'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerCotinine' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerPreventiveCare'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerPreventiveCare'
select count(*) from BASE_HFit_TrackerPreventiveCare
DBCC FREEPROCCACHE

update BASE_HFit_TrackerPreventiveCare set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerPreventiveCare)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare ;

select top 100 * from BASE_HFit_TrackerPreventiveCare

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerPreventiveCare'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerPreventiveCare' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerPreventiveCare';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerPreventiveCare;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerPreventiveCare, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerPreventiveCare', 'proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerPreventiveCare' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerPreventiveCare' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerPreventiveCare;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerPreventiveCare') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerPreventiveCare' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'NA' AS UOM
         , 'PreventiveCare' AS KEY1
         , CAST ( PreventiveCare AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerPreventiveCare AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerPreventiveCare'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerPreventiveCare'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerPreventiveCare AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerPreventiveCare%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerPreventiveCare'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerPreventiveCare'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerPreventiveCare' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerTobaccoAttestation'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerTobaccoAttestation'
select count(*) from BASE_HFit_TrackerTobaccoAttestation
DBCC FREEPROCCACHE

update BASE_HFit_TrackerTobaccoAttestation set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerTobaccoAttestation)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation ;

select top 100 * from BASE_HFit_TrackerTobaccoAttestation

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerTobaccoAttestation'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerTobaccoAttestation' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerTobaccoAttestation';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerTobaccoAttestation;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerTobaccoAttestation, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerTobaccoAttestation', 'proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerTobaccoAttestation' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerTobaccoAttestation' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerTobaccoAttestation;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerTobaccoAttestation') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerTobaccoAttestation' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'NA' AS UOM
         , 'TobaccoAttestation' AS KEY1
         , CAST ( TobaccoAttestation AS FLOAT) AS VAL1
         , 'NA' AS KEY2
         , NULL AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerTobaccoAttestation AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerTobaccoAttestation'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerTobaccoAttestation'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerTobaccoAttestation AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerTobaccoAttestation%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerTobaccoAttestation'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerTobaccoAttestation'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerTobaccoAttestation' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker.sql';
GO
IF EXISTS ( SELECT
                   NAME
                   FROM SYS.PROCEDURES
                   WHERE
                   NAME = 'proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker.sql';
        DROP PROCEDURE
             PROC_CT_FACT_TRACKERCOMPOSITEDETAILS_TRACKERINSTANCE_TRACKER;
    END;
GO

/*-----------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerInstance_Tracker'
select count(*) from BASE_HFit_TrackerInstance_Tracker
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerInstance_Tracker'
DBCC FREEPROCCACHE
exec proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker ;
select top 100 * from BASE_HFit_TrackerInstance_Tracker
update BASE_HFit_TrackerInstance_Tracker set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerInstance_Tracker)
*/

CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;

    DECLARE
    @AggregateTableName AS NVARCHAR ( 100) = 'HFit_TrackerInstance_Tracker';
    DECLARE
    @Msg AS NVARCHAR ( 1000) = '';
    DECLARE
    @Stepsecs AS BIGINT = 0;
    DECLARE
    @Totalsecs AS BIGINT = 0;
    DECLARE
    @Starttime AS DATETIME = GETDATE () ;
    DECLARE
    @Step1time AS DATETIME = GETDATE () ;
    DECLARE
    @Step2time AS DATETIME = GETDATE () ;
    DECLARE
    @Step3time AS DATETIME = GETDATE () ;
    DECLARE
    @Step4time AS DATETIME = GETDATE () ;
    DECLARE
    @Step5time AS DATETIME = GETDATE () ;
    DECLARE
    @Step6time AS DATETIME = GETDATE () ;
    DECLARE
    @Synchronization_Version AS BIGINT = NULL;
    DECLARE
    @Lastversion AS BIGINT = 0;
    DECLARE
    @Icnt AS BIGINT = 0;
    DECLARE
    @Ichanges AS BIGINT = 0;
    SET @Synchronization_Version = CHANGE_TRACKING_CURRENT_VERSION () ;
    EXEC @Lastversion = PROC_MASTER_LKP_CTVERSION_FETCH 'BASE_HFit_TrackerInstance_Tracker' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker';
    EXEC PRINTIMMEDIATE 'Processing BASE_HFit_TrackerInstance_Tracker';
    SET @Msg = 'Pulling CT Version: ' + CAST ( @Lastversion AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;

    -- select * from information_schema.tables where table_name like '%small%'

    EXEC @Icnt = PROC_QUICKROWCOUNT BASE_HFIT_TRACKERINSTANCE_TRACKER;
    SET @Msg = 'Total rows in Base Table: ' + CAST ( @Icnt AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;

    --******************************************************
    --CHECKPOINT;

    BEGIN TRY
        DROP TABLE
             #TRACKERDATA;
    END TRY
    BEGIN CATCH
        EXEC PRINTIMMEDIATE 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TRACKERDATA
           FROM CHANGETABLE (CHANGES BASE_HFIT_TRACKERINSTANCE_TRACKER, @Lastversion) AS CT;
    CREATE CLUSTERED INDEX PK_TT ON #TRACKERDATA ( SVR , DBNAME , ITEMID , SYS_CHANGE_OPERATION) ;
    SET @Ichanges = ( SELECT
                             COUNT ( *) 
                             FROM #TRACKERDATA );
    IF @Ichanges < 10
        BEGIN

            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerInstance_Tracker', 'proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker' , @synchronization_version;

            PRINT 'No changes registered to process.';
        END;
    SET @Msg = 'Starting Time: ' + CAST ( GETDATE () AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;
    SET @Icnt = ( SELECT
                         COUNT ( *) 
                         FROM FACT_EDW_TRACKERCOMPOSITEDETAILS
                         WHERE
                         TRACKERNAMEAGGREGATETABLE = @AggregateTableName );
    IF
    @Ichanges < 10
AND @Icnt > 0
        BEGIN

            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.

            EXEC PROC_MASTER_LKP_CTVERSION_UPDATE  'BASE_HFit_TrackerInstance_Tracker' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker' , @Synchronization_Version;
            PRINT 'No changes found to process, returning.';
            SET @Msg = 'END Time: ' + CAST ( GETDATE () AS NVARCHAR ( 50)) ;
            EXEC PRINTIMMEDIATE @Msg;
            RETURN;
        END;

    --If no records exists in the 

    IF @Icnt = 0
        BEGIN
            EXEC PRINTIMMEDIATE 'RELOADING ALL RECORDS...';
            truncate TABLE #TRACKERDATA;
            INSERT INTO #TRACKERDATA (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT

            --  'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable

                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFIT_TRACKERINSTANCE_TRACKER;
        END;
    SET @Icnt = ( SELECT
                         COUNT ( *) 
                         FROM #TRACKERDATA );
    SET @Msg = 'Total Records to Process: ' + CAST ( @Icnt AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerInstance_Tracker') and Data_type like '%varchar%'
    --order by column_name, table_name
    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TRACKERCOMPOSITEDETAILS
    (
           TRACKERNAMEAGGREGATETABLE
         , ITEMID
         , EVENTDATE
         , ISPROFESSIONALLYCOLLECTED
         , TRACKERCOLLECTIONSOURCEID
         , NOTES
         , USERID
         , COLLECTIONSOURCENAME_INTERNAL
         , COLLECTIONSOURCENAME_EXTERNAL
         , EVENTNAME
         , UOM
         , KEY1
         , VAL1
         , KEY2
         , VAL2
         , KEY3
         , VAL3
         , KEY4
         , VAL4
         , KEY5
         , VAL5
         , KEY6
         , VAL6
         , KEY7
         , VAL7
         , KEY8
         , VAL8
         , KEY9
         , VAL9
         , KEY10
         , VAL10
         , ITEMCREATEDBY
         , ITEMCREATEDWHEN
         , ITEMMODIFIEDBY
         , ITEMMODIFIEDWHEN
         , ISPROCESSEDFORHA
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ITEMORDER
         , ITEMGUID
         , USERGUID
         , MPI
         , CLIENTCODE
         , VENDORID
         , VENDORNAME
         , LASTMODIFIEDDATE
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerInstance_Tracker' AS TRACKERNAMEAGGREGATETABLE
         , TT.ITEMID
         , CAST ( EVENTDATE AS DATETIME) AS EVENTDATE
         , TT.ISPROFESSIONALLYCOLLECTED
         , TT.TRACKERCOLLECTIONSOURCEID
         , NOTES
         , TT.USERID
         , NULL AS COLLECTIONSOURCENAME_INTERNAL
         , NULL AS COLLECTIONSOURCENAME_EXTERNAL
         , 'MISSING' AS EVENTNAME
         , 'Y/N' AS UOM
         , 'TrackerDefID' AS KEY1
         , CAST ( TRACKERDEFID AS FLOAT) AS VAL1
         , 'YesNoValue' AS KEY2
         , CAST ( YESNOVALUE AS FLOAT) AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ITEMCREATEDBY
         , CAST ( TT.ITEMCREATEDWHEN AS DATETIME) AS ITEMCREATEDWHEN
         , TT.ITEMMODIFIEDBY
         , CAST ( TT.ITEMMODIFIEDWHEN AS DATETIME) AS ITEMMODIFIEDWHEN
         , NULL AS ISPROCESSEDFORHA
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ITEMORDER
         , NULL AS ITEMGUID
         , C.USERGUID
         , PP.MPI
         , PP.CLIENTCODE
         , NULL AS VENDORID

           --VENDOR.ItemID as VendorID

         , NULL AS VENDORNAME

           --VENDOR.VendorName

         , TT.LASTMODIFIEDDATE
         , TT.SVR
         , TT.DBNAME
           FROM DBO.BASE_HFIT_TRACKERINSTANCE_TRACKER AS TT
                    INNER JOIN #TRACKERDATA AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ITEMID = TD.ITEMID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN DBO.BASE_CMS_USER AS C
                        ON C.USERID = TT.USERID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN DBO.BASE_HFIT_PPTELIGIBILITY AS PP
                        ON TT.USERID = PP.USERID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;
    SET @Stepsecs = DATEDIFF ( SECOND , @Starttime , GETDATE ()) ;
    SET @Msg = 'Step1 seconds: ' + CAST ( @Stepsecs AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;
    SET @Step2time = GETDATE () ;

    --******************************************************
    --CHECKPOINT;

    UPDATE FT
           SET
               FT.ACCOUNTID = ACCT.ACCOUNTID
             ,FT.ACCOUNTCD = ACCT.ACCOUNTCD
               FROM FACT_EDW_TRACKERCOMPOSITEDETAILS AS FT
                        INNER JOIN DBO.BASE_HFIT_ACCOUNT AS ACCT
                            ON
                            FT.CLIENTCODE = ACCT.ACCOUNTCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TRACKERNAMEAGGREGATETABLE = 'HFit_TrackerInstance_Tracker'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @Stepsecs = DATEDIFF ( SECOND , @Step1time , @Step2time) ;
    SET @Msg = 'Step2 seconds: ' + CAST ( @Stepsecs AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;
    SET @Step3time = GETDATE () ;

    --******************************************************
    --CHECKPOINT;

    UPDATE FT
           SET
               FT.ACCOUNTCD = ACCT.ACCOUNTCD
               FROM FACT_EDW_TRACKERCOMPOSITEDETAILS AS FT
                        INNER JOIN DBO.BASE_HFIT_ACCOUNT AS ACCT
                            ON
                            FT.CLIENTCODE = ACCT.ACCOUNTCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TRACKERNAMEAGGREGATETABLE = 'HFit_TrackerInstance_Tracker'
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName;

    SET @Stepsecs = DATEDIFF ( SECOND , @Step2time , @Step3time) ;
    SET @Msg = 'Step3 seconds: ' + CAST ( @Stepsecs AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;
    SET @Step4time = GETDATE () ;

    --******************************************************
    --CHECKPOINT;

    UPDATE FT
           SET
               FT.SITEGUID = S.SITEGUID
               FROM FACT_EDW_TRACKERCOMPOSITEDETAILS AS FT
                        INNER JOIN #TRACKERDATA AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ITEMID = TD.ITEMID
                        AND FT.TRACKERNAMEAGGREGATETABLE = @AggregateTableName
                        INNER JOIN DBO.BASE_HFIT_ACCOUNT AS ACCT
                            ON
                            FT.ACCOUNTCD = ACCT.ACCOUNTCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN DBO.BASE_CMS_SITE AS S
                            ON
                            ACCT.SITEID = S.SITEID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;
    SET @Stepsecs = DATEDIFF ( SECOND , @Step3time , @Step4time) ;
    SET @Msg = 'Step4 seconds: ' + CAST ( @Stepsecs AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;
    SET @Step5time = GETDATE () ;

    --******************************************************
    --CHECKPOINT;

    EXEC PRINTIMMEDIATE 'Starting Step5';
    UPDATE FT
           SET
               FT.COLLECTIONSOURCENAME_INTERNAL = TC.COLLECTIONSOURCENAME_INTERNAL
             ,FT.COLLECTIONSOURCENAME_EXTERNAL = TC.COLLECTIONSOURCENAME_EXTERNAL
               FROM FACT_EDW_TRACKERCOMPOSITEDETAILS AS FT
                        INNER JOIN #TRACKERDATA AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ITEMID = TD.ITEMID
                        AND FT.TRACKERNAMEAGGREGATETABLE = @AggregateTableName
                        INNER JOIN DBO.BASE_HFIT_TRACKERCOLLECTIONSOURCE AS TC
                            ON
                            TC.TRACKERCOLLECTIONSOURCEID = FT.TRACKERCOLLECTIONSOURCEID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerInstance_Tracker AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = 'HFit_TrackerInstance_Tracker'
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @Stepsecs = DATEDIFF ( SECOND , @Step4time , @Step5time) ;
    SET @Msg = 'Step5 seconds: ' + CAST ( @Stepsecs AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;
    SET @Step6time = GETDATE () ;

    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%_TrackerInstance_Tracker%'

    UPDATE FT
           SET
               FT.ISAVAILABLE = T.ISAVAILABLE
             ,FT.ISCUSTOM = T.ISCUSTOM
             ,FT.UNIQUENAME = T.UNIQUENAME
             ,FT.COLDESC = T.UNIQUENAME
               FROM FACT_EDW_TRACKERCOMPOSITEDETAILS AS FT
                        INNER JOIN #TRACKERDATA AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ITEMID = TD.ITEMID
                        AND FT.TRACKERNAMEAGGREGATETABLE = 'HFit_TrackerInstance_Tracker'
                        JOIN DBO.BASE_HFIT_TRACKER AS T
                            ON
                            T.AGGREGATETABLENAME = 'HFit_TrackerInstance_Tracker'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME;

    --OPTION (MAXDOP 1) ;

    SET @Stepsecs = DATEDIFF ( SECOND , @Step5time , @Step6time) ;
    SET @Msg = 'Step6 seconds: ' + CAST ( @Stepsecs AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;
    SET @Stepsecs = DATEDIFF ( SECOND , @Starttime , GETDATE ()) ;
    SET @Msg = 'Total Time in seconds: ' + CAST ( @Stepsecs AS NVARCHAR ( 50)) ;
    EXEC PRINTIMMEDIATE @Msg;
    EXEC PROC_MASTER_LKP_CTVERSION_UPDATE  'BASE_HFit_TrackerInstance_Tracker' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker' , @Synchronization_Version;
    EXEC PRINTIMMEDIATE 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerBloodSugarAndGlucose'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerBloodSugarAndGlucose'
select count(*) from BASE_HFit_TrackerBloodSugarAndGlucose
DBCC FREEPROCCACHE

update BASE_HFit_TrackerBloodSugarAndGlucose set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerBloodSugarAndGlucose)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose ;

select top 100 * from BASE_HFit_TrackerBloodSugarAndGlucose

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerBloodSugarAndGlucose'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerBloodSugarAndGlucose' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerBloodSugarAndGlucose';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerBloodSugarAndGlucose;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerBloodSugarAndGlucose, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBloodSugarAndGlucose', 'proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBloodSugarAndGlucose' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerBloodSugarAndGlucose' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerBloodSugarAndGlucose;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerBloodSugarAndGlucose') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerBloodSugarAndGlucose' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'mmol/L' AS UOM
         , 'Units' AS KEY1
         , CAST ( Units AS FLOAT) AS VAL1
         , 'FastingState' AS KEY2
         , CAST ( FastingState AS FLOAT) AS VAL2
         , 'NA' AS KEY3
         , NULL AS VAL3
         , 'NA' AS KEY4
         , NULL AS VAL4
         , 'NA' AS KEY5
         , NULL AS VAL5
         , 'NA' AS KEY6
         , NULL AS VAL6
         , 'NA' AS KEY7
         , NULL AS VAL7
         , 'NA' AS KEY8
         , NULL AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerBloodSugarAndGlucose AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBloodSugarAndGlucose'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBloodSugarAndGlucose'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerBloodSugarAndGlucose AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerBloodSugarAndGlucose%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBloodSugarAndGlucose'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBloodSugarAndGlucose' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerBodyMeasurements'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerBodyMeasurements'
select count(*) from BASE_HFit_TrackerBodyMeasurements
DBCC FREEPROCCACHE

update BASE_HFit_TrackerBodyMeasurements set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerBodyMeasurements)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements ;

select top 100 * from BASE_HFit_TrackerBodyMeasurements

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerBodyMeasurements'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerBodyMeasurements' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerBodyMeasurements';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerBodyMeasurements;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerBodyMeasurements, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBodyMeasurements', 'proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBodyMeasurements' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerBodyMeasurements' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerBodyMeasurements;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerBodyMeasurements') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerBodyMeasurements' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
  , 'MISSING' AS EventName
     , 'Inch' AS UOM
     , 'WaistInches' AS KEY1
     , CAST ( WaistInches AS FLOAT) AS VAL1
     , 'HipInches' AS KEY2
     , CAST ( HipInches AS FLOAT) AS VAL2
     , 'ThighInches' AS KEY3
     , CAST ( ThighInches AS FLOAT) AS VAL3
     , 'ArmInches' AS KEY4
     , CAST ( ArmInches AS FLOAT) AS VAL4
     , 'ChestInches' AS KEY5
     , CAST ( ChestInches AS FLOAT) AS VAL5
     , 'CalfInches' AS KEY6
     , CAST ( CalfInches AS FLOAT) AS VAL6
     , 'NeckInches' AS KEY7
     , CAST ( NeckInches AS FLOAT) AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerBodyMeasurements AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBodyMeasurements'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBodyMeasurements'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerBodyMeasurements AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerBodyMeasurements%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerBodyMeasurements'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerBodyMeasurements' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_CT_FACT_TrackerCompositeDetails_TrackerTests.sql \n 
--------------------------------------------------------------- 

GO
PRINT 'Executing proc_CT_FACT_TrackerCompositeDetails_TrackerTests.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_CT_FACT_TrackerCompositeDetails_TrackerTests') 
    BEGIN
        PRINT 'UPDATING proc_CT_FACT_TrackerCompositeDetails_TrackerTests.sql';
        DROP PROCEDURE
             proc_CT_FACT_TrackerCompositeDetails_TrackerTests;
    END;
GO

/*--------------------------------------------------------------------------------------------------------------
delete from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerTests'
select count(*) from FACT_EDW_TrackerCompositeDetails where TrackerNameAggregateTable = 'HFit_TrackerTests'
select count(*) from BASE_HFit_TrackerTests
DBCC FREEPROCCACHE

update BASE_HFit_TrackerTests set HAshCode = '@' where ItemID in (select top 1000 itemid from BASE_HFit_TrackerTests)
exec proc_CT_FACT_TrackerCompositeDetails_TrackerTests ;

select top 100 * from BASE_HFit_TrackerTests

*/
CREATE PROCEDURE proc_CT_FACT_TrackerCompositeDetails_TrackerTests
AS
BEGIN

    --SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
    --truncate table FACT_EDW_TrackerCompositeDetails

    DECLARE
    @AggregateTableName AS NVARCHAR (100) = 'HFit_TrackerTests'
  , @msg AS NVARCHAR (1000) = ''
  , @StepSecs AS BIGINT = 0
  , @TotalSecs AS BIGINT = 0
  , @StartTime AS DATETIME = GETDATE () 
  , @Step1Time AS DATETIME = GETDATE () 
  , @Step2Time AS DATETIME = GETDATE () 
  , @Step3Time AS DATETIME = GETDATE () 
  , @Step4Time AS DATETIME = GETDATE () 
  , @Step5Time AS DATETIME = GETDATE () 
  , @Step6Time AS DATETIME = GETDATE () 
  , @synchronization_version AS BIGINT = NULL
  , @LastVersion AS BIGINT = 0
  , @iCnt AS BIGINT = 0
  , @iChanges AS BIGINT = 0;

    SET @synchronization_version = CHANGE_TRACKING_CURRENT_VERSION () ;

    EXEC @LastVersion = proc_MASTER_LKP_CTVersion_Fetch 'BASE_HFit_TrackerTests' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerTests';

    EXEC PrintImmediate 'Processing BASE_HFit_TrackerTests';
    SET @msg = 'Pulling CT Version: ' + CAST (@LastVersion AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;
    -- select * from information_schema.tables where table_name like '%small%'
    EXEC @iCnt = proc_QuickRowCount BASE_HFit_TrackerTests;
    SET @msg = 'Total rows in Base Table: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC PrintImmediate @msg;

    --******************************************************
    --CHECKPOINT;
    BEGIN TRY
        DROP TABLE
             #TrackerData;
    END TRY
    BEGIN CATCH
        EXEC printImmediate 'Loading temp table';
    END CATCH;
    SELECT
           ITEMID
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SYS_CHANGE_COLUMNS
         , SVR
         , DBNAME INTO
                       #TrackerData
           FROM CHANGETABLE (CHANGES BASE_HFit_TrackerTests, @LastVersion) AS CT;

    CREATE CLUSTERED INDEX PK_TT ON #TrackerData (SVR , DBNAME , ItemID , SYS_CHANGE_OPERATION) ;

    SET @iChanges = (SELECT
                            COUNT (*) 
                            FROM #TrackerData);
    IF @iChanges < 10
        BEGIN
            --EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerTests', 'proc_CT_FACT_TrackerCompositeDetails_TrackerTests' , @synchronization_version;
            PRINT 'No changes registered to process.';
        END;

    SET @msg = 'Starting Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM FACT_EDW_TrackerCompositeDetails
                        WHERE
                        TrackerNameAggregateTable = @AggregateTableName);

    IF
    @iChanges < 10
AND @iCnt > 0
        BEGIN
            --No changes found and RELOAD NOT needed. If reload needed, delete all entries for this table in the FACT table.
            EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerTests' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerTests' , @synchronization_version;
            PRINT 'No changes found to process, returning.';
            SET @msg = 'END Time: ' + CAST (GETDATE () AS NVARCHAR (50)) ;
            EXEC printImmediate @msg;
            RETURN;
        END;

    --If no records exists in the 
    IF @iCnt = 0
        BEGIN
            EXEC PrintImmediate 'RELOADING ALL RECORDS...';
            truncate TABLE #TrackerData;
            INSERT INTO #TrackerData (
                   ITEMID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_OPERATION
                 , SYS_CHANGE_COLUMNS
                 , SVR
                 , DBNAME) 
            SELECT
            --  'HFit_TrackerTests' AS AggregateTableName
                   ITEMID
          , 0 AS SYS_CHANGE_VERSION
          , 'I' AS SYS_CHANGE_OPERATION
          , NULL AS SYS_CHANGE_COLUMNS
          , SVR
          , DBNAME
                   FROM BASE_HFit_TrackerTests;
        END;

    SET @iCnt = (SELECT
                        COUNT (*) 
                        FROM #TrackerData);
    SET @msg = 'Total Records to Process: ' + CAST (@iCnt AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    --select * from information_schema.columns where (table_name = 'FACT_EDW_TrackerCompositeDetails'
    --or table_name = 'BASE_HFit_TrackerTests') and Data_type like '%varchar%'
    --order by column_name, table_name

    --truncate table FACT_EDW_TrackerCompositeDetails

    INSERT INTO FACT_EDW_TrackerCompositeDetails
    (
           TrackerNameAggregateTable
         , ItemID
         , EventDate
         , IsProfessionallyCollected
         , TrackerCollectionSourceID
         , Notes
         , UserID
         , CollectionSourceName_Internal
         , CollectionSourceName_External
         , EventName
         , UOM
         , KEY1
         , VAL1
         , Key2
         , Val2
         , Key3
         , Val3
         , Key4
         , Val4
         , Key5
         , Val5
         , Key6
         , Val6
         , Key7
         , Val7
         , Key8
         , Val8
         , Key9
         , Val9
         , Key10
         , Val10
         , ItemCreatedBy
         , ItemCreatedWhen
         , ItemModifiedBy
         , ItemModifiedWhen
         , IsProcessedForHa
         , TXTKEY1
         , TXTVAL1
         , TXTKEY2
         , TXTVAL2
         , TXTKEY3
         , TXTVAL3
         , ItemOrder
         , ItemGuid
         , UserGuid
         , MPI
         , ClientCode
         , VendorID
         , VendorName
         , LastModifiedDate
         , SVR
         , DBNAME) 
    SELECT DISTINCT
           'HFit_TrackerTests' AS AggregateTableName
         , TT.ItemID
         , EventDate
         , TT.IsProfessionallyCollected
         , TT.TrackerCollectionSourceID
         , Notes
         , TT.UserID
         , NULL AS CollectionSourceName_Internal
         , NULL AS CollectionSourceName_External
         , 'MISSING' AS EventName
         , 'NA' AS UOM
         , 'PSATest' AS KEY1
         , CAST ( PSATest AS FLOAT) AS VAL1
         , 'OtherExam' AS KEY2
         , CAST ( OtherExam AS FLOAT) AS VAL2
         , 'TScore' AS KEY3
         , CAST ( TScore AS FLOAT) AS VAL3
         , 'DRA' AS KEY4
         , CAST ( DRA AS FLOAT) AS VAL4
         , 'CotinineTest' AS KEY5
         , CAST ( CotinineTest AS FLOAT) AS VAL5
         , 'ColoCareKit' AS KEY6
         , CAST ( ColoCareKit AS FLOAT) AS VAL6
         , 'CustomTest' AS KEY7
         , CAST ( CustomTest AS FLOAT) AS VAL7
         , 'TSH' AS KEY8
         , CAST ( TSH AS FLOAT) AS VAL8
         , 'NA' AS KEY9
         , NULL AS VAL9
         , 'NA' AS KEY10
         , NULL AS VAL10
         , TT.ItemCreatedBy
         , TT.ItemCreatedWhen
         , TT.ItemModifiedBy
         , TT.ItemModifiedWhen
         , NULL AS IsProcessedForHa
         , 'NA' AS TXTKEY1
         , NULL AS TXTVAL1
         , 'NA' AS TXTKEY2
         , NULL AS TXTVAL2
         , 'NA' AS TXTKEY3
         , NULL AS TXTVAL3
         , NULL AS ItemOrder
         , NULL AS ItemGuid
         , C.UserGuid
         , PP.MPI
         , PP.ClientCode
         , NULL AS VendorID	--VENDOR.ItemID as VendorID
         , NULL AS VendorName --VENDOR.VendorName
         , TT.LastModifiedDate
         , TT.SVR
         , TT.DBNAME
           FROM dbo.BASE_HFit_TrackerTests AS TT
                    INNER JOIN #TrackerData AS TD
                        ON TT.SVR = TD.SVR
                       AND TT.DBNAME = TD.DBNAME
                       AND TT.ItemID = TD.ItemID
                       AND TD.SYS_CHANGE_OPERATION = 'I'
                    INNER JOIN dbo.BASE_CMS_User AS C
                        ON C.UserID = TT.UserID
                       AND C.SVR = TT.SVR
                       AND C.DBNAME = TT.DBNAME
                    INNER JOIN dbo.BASE_HFit_ppteligibility AS PP
                        ON TT.UserID = PP.userID
                       AND TT.SVR = PP.SVR
                       AND TT.DBNAME = PP.DBNAME;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Step1 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step2Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountID = ACCT.AccountID
             ,FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step1Time , @Step2Time) ;
    SET @msg = 'Step2 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step3Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.AccountCD = ACCT.AccountCD
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.ClientCode = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        AND FT.TrackerNameAggregateTable = @AggregateTableName
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = @AggregateTableName

    SET @StepSecs = DATEDIFF (second , @Step2Time , @Step3Time) ;
    SET @msg = 'Step3 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;
    SET @Step4Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    UPDATE FT
           SET
               FT.SiteGUID = S.SiteGUID
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerTests'
                        INNER JOIN dbo.BASE_HFit_Account AS ACCT
                            ON
                            FT.AccountCD = ACCT.AccountCD
                        AND FT.SVR = ACCT.SVR
                        AND FT.DBNAME = ACCT.DBNAME
                        INNER JOIN dbo.BASE_CMS_Site AS S
                            ON
                            ACCT.SiteID = S.SiteID
                        AND ACCT.SVR = S.SVR
                        AND ACCT.DBNAME = S.DBNAME;

    SET @StepSecs = DATEDIFF (second , @Step3Time , @Step4Time) ;
    SET @msg = 'Step4 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step5Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    EXEC printImmediate 'Starting Step5';

    UPDATE FT
           SET
               FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
             ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerTests'
                        INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
                            ON
                            TC.TrackerCollectionSourceID = FT.TrackerCollectionSourceID
                        AND TC.SVR = FT.SVR
                        AND TC.DBNAME = FT.DBNAME;

    --UPDATE FT
    --       SET
    --           FT.CollectionSourceName_Internal = TC.CollectionSourceName_Internal
    --         ,FT.CollectionSourceName_External = TC.CollectionSourceName_External
    --           FROM BASE_HFit_TrackerTests AS BT
    --                    INNER JOIN #TrackerData AS TD
    --                        ON BT.SVR = TD.SVR
    --                       AND BT.DBNAME = TD.DBNAME
    --                       AND BT.ItemID = TD.ItemID
    --                    JOIN FACT_EDW_TrackerCompositeDetails AS FT
    --                        ON
    --                        BT.ItemID = FT.ItemID
    --                    AND FT.SVR = BT.SVR
    --                    AND FT.DBNAME = BT.DBNAME
    --                    AND FT.TrackerNameAggregateTable = @AggregateTableName
    --                    INNER JOIN dbo.BASE_HFit_TrackerCollectionSource AS TC
    --                        ON
    --                        TC.TrackerCollectionSourceID = BT.TrackerCollectionSourceID
    --                    AND TC.SVR = BT.SVR
    --                    AND TC.DBNAME = BT.DBNAME  OPTION (
    --                                                      MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step4Time , @Step5Time) ;
    SET @msg = 'Step5 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @Step6Time = GETDATE () ;
    --******************************************************
    --CHECKPOINT;
    -- Select * from BASE_HFit_Tracker where AggregateTableName like '%HFit_TrackerTests%'
    UPDATE FT
           SET
               FT.IsAvailable = T.IsAvailable
             ,FT.IsCustom = T.IsCustom
             ,FT.UniqueName = T.UniqueName
             ,FT.ColDesc = T.UniqueName
               FROM FACT_EDW_TrackerCompositeDetails AS FT
                        INNER JOIN #TrackerData AS TD
                            ON
                            FT.SVR = TD.SVR
                        AND FT.DBNAME = TD.DBNAME
                        AND FT.ItemID = TD.ItemID
                        AND FT.TrackerNameAggregateTable = 'HFit_TrackerTests'
                        JOIN dbo.BASE_HFit_Tracker AS T
                            ON
                            T.AggregateTableName = 'HFit_TrackerTests'
                        AND T.SVR = FT.SVR
                        AND T.DBNAME = FT.DBNAME; --OPTION (MAXDOP 1) ;

    SET @StepSecs = DATEDIFF (second , @Step5Time , @Step6Time) ;
    SET @msg = 'Step6 seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    SET @StepSecs = DATEDIFF (second , @StartTime , GETDATE ()) ;
    SET @msg = 'Total Time in seconds: ' + CAST (@StepSecs AS NVARCHAR (50)) ;
    EXEC printImmediate @msg;

    EXEC proc_MASTER_LKP_CTVersion_Update  'BASE_HFit_TrackerTests' , 'proc_CT_FACT_TrackerCompositeDetails_TrackerTests' , @synchronization_version;

    EXEC printImmediate 'Ending Time: ';
    PRINT GETDATE () ;
END;
GO
PRINT 'Executed proc_CT_FACT_TrackerCompositeDetails_TrackerTests.sql';
GO
-- FATAL ERROR : FILE MISSING view_MART_HealthAssesment.sql \n 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_PPT_CMSUser.sql \n 
--------------------------------------------------------------- 

USE KenticoCMS_DataMart;
GO
PRINT 'Executing view_PPT_CMSUser.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_PPT_CMSUser') 
    BEGIN
        DROP VIEW
             view_PPT_CMSUser;
    END;
GO
CREATE VIEW view_PPT_CMSUser
AS SELECT
		  BASE_cms_user.UserID
        , BASE_cms_user.FirstName
        , BASE_cms_user.MiddleName
        , BASE_cms_user.LastName
        , BASE_cms_user.FullName
        , BASE_cms_user.Email
        , BASE_cms_user.UserCreated
        , BASE_hfit_PPTEligibility.BirthDate
        , BASE_hfit_PPTEligibility.Gender
        , BASE_hfit_PPTEligibility.City
        , BASE_hfit_PPTEligibility.[State]
        , BASE_hfit_PPTEligibility.PostalCode
        , BASE_hfit_PPTEligibility.HireDate
        , BASE_hfit_PPTEligibility.TermDate
        , BASE_hfit_PPTEligibility.RetireeDate
        , BASE_hfit_PPTEligibility.PlanName
        , BASE_hfit_PPTEligibility.PlanStartDate
        , BASE_hfit_PPTEligibility.PlanEndDate
        , BASE_hfit_PPTEligibility.Company
        , BASE_hfit_PPTEligibility.CompanyCd
        , BASE_hfit_PPTEligibility.LocationName
        , BASE_hfit_PPTEligibility.LocationCd
        , BASE_hfit_PPTEligibility.DepartmentName
        , BASE_hfit_PPTEligibility.DepartmentCd
        , BASE_hfit_PPTEligibility.UnionCd
        , BASE_hfit_PPTEligibility.BenefitGrp
        , BASE_hfit_PPTEligibility.PayGrp
        , BASE_hfit_PPTEligibility.Division
        , BASE_hfit_PPTEligibility.JobTitle
        , BASE_hfit_PPTEligibility.JobCd
        , BASE_hfit_PPTEligibility.TeamName
        , BASE_hfit_PPTEligibility.MaritalStatus
        , BASE_hfit_PPTEligibility.PersonType
        , BASE_hfit_PPTEligibility.PersonStatus
        , BASE_hfit_PPTEligibility.EmployeeType
        , BASE_hfit_PPTEligibility.CoverageType
        , BASE_hfit_PPTEligibility.EmployeeStatus
        , BASE_hfit_PPTEligibility.PayCd
        , BASE_hfit_PPTEligibility.BenefitStatus
        , BASE_hfit_PPTEligibility.PlanType
        , BASE_hfit_PPTEligibility.PPTID
        , BASE_hfit_PPTEligibility.SurrogateKey_hfit_PPTEligibility
        , BASE_cms_user.SurrogateKey_cms_user
        , BASE_cms_user.SVR
        , BASE_cms_user.DBNAME
   FROM
        BASE_cms_user
        INNER JOIN BASE_hfit_PPTEligibility
        ON
          BASE_cms_user.SVR = BASE_hfit_PPTEligibility.SVR AND
          BASE_cms_user.DBNAME = BASE_hfit_PPTEligibility.DBNAME AND
          BASE_cms_user.UserID = BASE_hfit_PPTEligibility.UserID;

GO
PRINT 'Executed view_PPT_CMSUser.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_PPT_User_TrackerDetails.sql \n 
--------------------------------------------------------------- 

-- use KenticoCMS_DataMart_2
GO
PRINT 'Executing view_PPT_User_TrackerDetails.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_PPT_User_TrackerDetails') 
    BEGIN
        DROP VIEW
             view_PPT_User_TrackerDetails
    END;
GO

CREATE VIEW view_PPT_User_TrackerDetails
AS SELECT
          BASE_hfit_PPTEligibility.LastName + ', ' + BASE_hfit_PPTEligibility.FirstName + ' ' + BASE_hfit_PPTEligibility.MiddleInit AS FullName
        , BASE_hfit_PPTEligibility.LastName
        , BASE_hfit_PPTEligibility.FirstName
        , BASE_hfit_PPTEligibility.MiddleInit
        , BASE_hfit_PPTEligibility.BirthDate
        , BASE_hfit_PPTEligibility.Gender
        , BASE_hfit_PPTEligibility.City
        , BASE_hfit_PPTEligibility.State
        , BASE_hfit_PPTEligibility.PostalCode
        , BASE_hfit_PPTEligibility.DepartmentName
        , BASE_hfit_PPTEligibility.DepartmentCd
        , FACT_EDW_TrackerCompositeDetails.TrackerNameAggregateTable
        , FACT_EDW_TrackerCompositeDetails.ItemID
        , FACT_EDW_TrackerCompositeDetails.EventDate
        , FACT_EDW_TrackerCompositeDetails.IsProfessionallyCollected
        , FACT_EDW_TrackerCompositeDetails.TrackerCollectionSourceID
        , FACT_EDW_TrackerCompositeDetails.EventName
        , FACT_EDW_TrackerCompositeDetails.UOM
        , FACT_EDW_TrackerCompositeDetails.KEY1
        , FACT_EDW_TrackerCompositeDetails.VAL1
        , FACT_EDW_TrackerCompositeDetails.KEY2
        , FACT_EDW_TrackerCompositeDetails.VAL2
        , FACT_EDW_TrackerCompositeDetails.KEY3
        , FACT_EDW_TrackerCompositeDetails.VAL3
        , FACT_EDW_TrackerCompositeDetails.KEY4
        , FACT_EDW_TrackerCompositeDetails.VAL4
        , FACT_EDW_TrackerCompositeDetails.KEY5
        , FACT_EDW_TrackerCompositeDetails.VAL5
        , FACT_EDW_TrackerCompositeDetails.KEY6
        , FACT_EDW_TrackerCompositeDetails.VAL6
        , FACT_EDW_TrackerCompositeDetails.KEY7
        , FACT_EDW_TrackerCompositeDetails.VAL7
        , FACT_EDW_TrackerCompositeDetails.KEY8
        , FACT_EDW_TrackerCompositeDetails.VAL8
        , FACT_EDW_TrackerCompositeDetails.KEY9
        , FACT_EDW_TrackerCompositeDetails.VAL9
        , FACT_EDW_TrackerCompositeDetails.KEY10
        , FACT_EDW_TrackerCompositeDetails.VAL10
        , FACT_EDW_TrackerCompositeDetails.ItemCreatedWhen
        , FACT_EDW_TrackerCompositeDetails.TXTKEY1
        , FACT_EDW_TrackerCompositeDetails.TXTVAL1
        , FACT_EDW_TrackerCompositeDetails.TXTKEY2
        , FACT_EDW_TrackerCompositeDetails.TXTVAL2
        , FACT_EDW_TrackerCompositeDetails.TXTKEY3
        , FACT_EDW_TrackerCompositeDetails.TXTVAL3
        , FACT_EDW_TrackerCompositeDetails.MPI
        , FACT_EDW_TrackerCompositeDetails.SiteGUID
        , FACT_EDW_TrackerCompositeDetails.VendorID
        , FACT_EDW_TrackerCompositeDetails.VendorName
        , FACT_EDW_TrackerCompositeDetails.IsCustom
        , FACT_EDW_TrackerCompositeDetails.AccountCD
        , FACT_EDW_TrackerCompositeDetails.DBNAME
        , FACT_EDW_TrackerCompositeDetails.SVR
        , FACT_EDW_TrackerCompositeDetails.UserID
   FROM
        BASE_hfit_PPTEligibility
        INNER JOIN FACT_EDW_TrackerCompositeDetails
        ON
          BASE_hfit_PPTEligibility.SVR = FACT_EDW_TrackerCompositeDetails.SVR AND
          BASE_hfit_PPTEligibility.UserID = FACT_EDW_TrackerCompositeDetails.UserID AND
          BASE_hfit_PPTEligibility.DBNAME = FACT_EDW_TrackerCompositeDetails.DBNAME;
GO
PRINT 'Executed view_PPT_User_TrackerDetails.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_SetTrackerKeyColToStandardLength.sql \n 
--------------------------------------------------------------- 


-- use KenticoCMS_DataMart
-- use KenticoCMS_DataMart_2
-- select top 100 * from FACT_TrackerData
-- select top 100 * from FACT_HFit_TrackerWeight
-- select top 100 * from BASE_HFit_TrackerWeight
GO
PRINT 'Executing proc_SetTrackerKeyColToStandardLength.sql';
GO
IF EXISTS (SELECT name
                  FROM sys.procedures
                  WHERE name = 'proc_SetTrackerKeyColToStandardLength') 
    BEGIN
        DROP PROCEDURE proc_SetTrackerKeyColToStandardLength;
    END;
GO
-- exec proc_SetTrackerKeyColToStandardLength 'NO'
-- exec proc_SetTrackerKeyColToStandardLength 
CREATE PROCEDURE proc_SetTrackerKeyColToStandardLength (
       @PreviewOnly AS nvarchar (10) = 'YES') 
AS
BEGIN

/*--------------------------------------------------------------------
Author:	  W. Dale Miller
Date:	  01.08.2016
Purpose:	  Modifies each tracker table such that the primary keys are 
		  consistent and comprise the SVR, DBNAME

Parms:	  @PreviewOnly	 
		  - Set this to YES to have the DDL displayed and NOT executed.
		  - Set this to NO to have the DDL displayed AND executed.
*/

    DECLARE
           @TblName AS nvarchar (100) = ''
         , @ConstraintName AS nvarchar (100) = ''
         , @TrackerName AS nvarchar (100) = ''
         , @ColName AS nvarchar (100) = ''
         , @KCols AS nvarchar (max) = ''
         , @msg AS nvarchar (4000) = ''
         , @cmd AS nvarchar (4000) = ''
         , @PkeyCols AS nvarchar (4000) = ''
         , @DropCmd AS nvarchar (max) = ''
         , @GenCmd AS nvarchar (max) = ''
         , @MySql AS nvarchar (max) = ''
         , @FKName AS nvarchar (max) = ''
         , @iCntUserID int = 0
         , @iCnt int = 0
         , @iCTFlg int = 0
         , @i int = 0;

    DECLARE
           @TBL TABLE (PkeyCol nvarchar (500)) ;

    IF OBJECT_ID ('tempdb..#DBTables') IS NOT NULL
        BEGIN
            DROP TABLE #DBTables
        END;

    SELECT sys.tables.name AS Table_name INTO #DBTables
           FROM
                sys.change_tracking_tables
                JOIN sys.tables
                    ON sys.tables.object_id = sys.change_tracking_tables.object_id
                JOIN sys.schemas
                    ON sys.schemas.schema_id = sys.tables.schema_id
           WHERE sys.schemas.name = 'dbo';

    DECLARE C CURSOR
        FOR SELECT c.table_name
                 , C.column_name
                   FROM
                        information_Schema.columns AS C
                        JOIN information_Schema.tables AS T
                            ON T.table_Name = C.table_Name
                           AND T.Table_type = 'base table'
                           AND (C.column_name = 'SVR'
                             OR C.column_name = 'DBNAME')
                           AND C.character_maximum_length != 100;

    OPEN C;

    FETCH NEXT FROM C INTO @TblName, @ColName;

    DECLARE
           @DropStmt nvarchar (max) 
         , @CreateStmt nvarchar (max) ;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            BEGIN TRANSACTION TXMAIN;
            BEGIN TRY
                SET @msg = 'Processing: '
                         + @TblName
                         + ' and column: '
                         + @ColName;
                EXEC PrintImmediate @msg;

                IF OBJECT_ID ('tempdb..#TempIndexes') IS NOT NULL
                    BEGIN
                        DROP TABLE #TempIndexes;
                    END;

                --select * into #TempIndexes from dbo.fnGetTableIndexes('BASE_CMS_SIte') ; -- select * from #TempIndexes 
                SELECT * INTO #TempIndexes
                       FROM dbo.fnGetTableIndexes (@TblName) ;

                DECLARE TableIndexes CURSOR
                    FOR SELECT create_statement
                             , drop_statement
                               FROM #TempIndexes;

                OPEN TableIndexes;
                SET @iCnt = 0;
                FETCH NEXT FROM TableIndexes INTO @CreateStmt, @DropStmt;
                WHILE @@FETCH_STATUS = 0
                    BEGIN
                        SET @MySql = @DropStmt;
                        EXEC PrintImmediate @MySql;
                        IF @PreviewOnly = 'NO'
                            BEGIN EXEC (@MySql) ;
                            END;
                        FETCH NEXT FROM TableIndexes INTO @CreateStmt, @DropStmt;
                    END;
                CLOSE TableIndexes;
                DEALLOCATE TableIndexes;

                SET @MySql = 'Alter table '
                           + @TblName
                           + ' alter column '
                           + @ColName
                           + ' nvarchar(100) NULL ';
                EXEC PrintImmediate @MySql;
                IF @PreviewOnly = 'NO'
                    BEGIN EXEC (@MySql) ;
                    END;

                DECLARE TableIndexes CURSOR
                    FOR SELECT create_statement
                             , drop_statement
                               FROM #TempIndexes;

                OPEN TableIndexes;
                SET @iCnt = 0;
                FETCH NEXT FROM TableIndexes INTO @CreateStmt, @DropStmt;
                WHILE @@FETCH_STATUS = 0
                    BEGIN
                        SET @i = CHARINDEX (')', @CreateStmt) ;
                        SET @MySql = SUBSTRING (@CreateStmt, 1, @i) ;
                        EXEC PrintImmediate @MySql;
                        IF @PreviewOnly = 'NO'
                            BEGIN EXEC (@MySql) ;
                            END;
                        FETCH NEXT FROM TableIndexes INTO @CreateStmt, @DropStmt;
                    END;
                CLOSE TableIndexes;
                DEALLOCATE TableIndexes;
                COMMIT TRANSACTION TXMAIN;
                FETCH NEXT FROM C INTO @TblName, @ColName;
            END TRY
            BEGIN CATCH
                SET @msg = 'FAILED Processing: '
                         + @TblName
                         + ' and column: '
                         + @ColName
                         + CHAR (10)
                         + @MySql;
                EXEC printImmediate @msg;
                ROLLBACK TRANSACTION TXMAIN;
            END CATCH;
        END;

    PRINT 'RUN COMPLETE.';
    CLOSE C;
    DEALLOCATE C;

END;

GO
PRINT 'Executed proc_SetTrackerKeyColToStandardLength.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: view_DIM_UserPptDetail.sql \n 
--------------------------------------------------------------- 

GO
-- use KenticoCMS_DataMart
PRINT 'Executing view_DIM_UserPPTDetail.sql';
GO
IF EXISTS (SELECT
                  name
           FROM sys.views
           WHERE
                  name = 'view_DIM_UserPPTDetail') 
    BEGIN
        DROP VIEW
             dbo.view_DIM_UserPPTDetail;
    END;
GO
-- select top 100 * from view_DIM_UserPPTDetail
CREATE VIEW view_DIM_UserPPTDetail
AS SELECT
          BASE_cms_user.SVR
        , BASE_cms_user.UserName
        , BASE_cms_user.FirstName
        , BASE_cms_user.MiddleName
        , BASE_cms_user.LastName
        , BASE_cms_user.FullName
        , BASE_cms_user.Email
        , BASE_cms_user.PreferredCultureCode
        , BASE_cms_user.PreferredUICultureCode
        , BASE_cms_user.UserEnabled
        , BASE_cms_user.UserID
        , BASE_cms_user.SurrogateKey_cms_user
        , BASE_cms_user.LASTMODIFIEDDATE
        , BASE_hfit_PPTEligibility.LASTMODIFIEDDATE AS BASE_hfit_PPTEligibility_LASTMODIFIEDDATE
        , BASE_hfit_PPTEligibility.SurrogateKey_hfit_PPTEligibility
        , BASE_hfit_PPTEligibility.BirthDate
        , BASE_hfit_PPTEligibility.Gender
        , BASE_hfit_PPTEligibility.City
        , BASE_hfit_PPTEligibility.State
        , BASE_hfit_PPTEligibility.PostalCode
        , BASE_hfit_PPTEligibility.HireDate
        , BASE_hfit_PPTEligibility.TermDate
        , BASE_hfit_PPTEligibility.RetireeDate
        , BASE_hfit_PPTEligibility.PlanName
        , BASE_hfit_PPTEligibility.PlanDescription
        , BASE_hfit_PPTEligibility.PlanID
        , BASE_hfit_PPTEligibility.PlanStartDate
        , BASE_hfit_PPTEligibility.PlanEndDate
        , BASE_hfit_PPTEligibility.Company
        , BASE_hfit_PPTEligibility.CompanyCd
        , BASE_hfit_PPTEligibility.LocationName
        , BASE_hfit_PPTEligibility.DepartmentName
        , BASE_hfit_PPTEligibility.DepartmentCd
        , BASE_hfit_PPTEligibility.UnionCd
        , BASE_hfit_PPTEligibility.BenefitGrp
        , BASE_hfit_PPTEligibility.PayGrp
        , BASE_hfit_PPTEligibility.Division
        , BASE_hfit_PPTEligibility.JobTitle
        , BASE_hfit_PPTEligibility.JobCd
        , BASE_hfit_PPTEligibility.TeamName
        , BASE_hfit_PPTEligibility.MaritalStatus
        , BASE_hfit_PPTEligibility.PersonType
        , BASE_hfit_PPTEligibility.PersonStatus
        , BASE_hfit_PPTEligibility.EmployeeType
        , BASE_hfit_PPTEligibility.EmployeeStatus
        , BASE_hfit_PPTEligibility.CoverageType
        , BASE_hfit_PPTEligibility.PayCd
        , BASE_hfit_PPTEligibility.BenefitStatus
        , BASE_hfit_PPTEligibility.PlanType
        , BASE_hfit_PPTEligibility.ClientPlatformElig
        , BASE_hfit_PPTEligibility.ClientHRAElig
        , BASE_hfit_PPTEligibility.ClientLMElig
        , BASE_hfit_PPTEligibility.PPTID
        , BASE_cms_user.DBNAME
   FROM
        dbo.BASE_cms_user
        INNER JOIN dbo.BASE_hfit_PPTEligibility
        ON
          BASE_cms_user.UserID = BASE_hfit_PPTEligibility.UserID AND
          BASE_cms_user.SVR = BASE_hfit_PPTEligibility.SVR AND
          BASE_cms_user.DBNAME = BASE_hfit_PPTEligibility.DBNAME;
GO
PRINT 'Executed view_DIM_UserPPTDetail.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: LastStep_PopulateTrackerTables.sql \n 
--------------------------------------------------------------- 



-- select 'exec ' + name + char(10) + 'GO' from sys.procedures where name like 'proc_CT_FACT_TrackerComposite%' or name like 'proc_CT_DIM_HFit_Tracker%'

exec proc_CT_DIM_HFit_TrackerCardio_Cursor
GO
exec proc_CT_DIM_HFit_TrackerSugaryDrinks
GO
exec proc_CT_DIM_HFit_TrackerFlexibility
GO
exec proc_CT_DIM_HFit_TrackerSleepPlan
GO
exec proc_CT_DIM_HFit_TrackerCardio
GO
exec proc_CT_DIM_HFit_TrackerHighSodiumFoods
GO
exec proc_CT_DIM_HFit_TrackerCollectionSource
GO
exec proc_CT_DIM_HFit_TrackerBMI
GO
exec proc_CT_DIM_HFit_TrackerVegetables
GO
exec proc_CT_DIM_HFit_TrackerRegularMeals
GO
exec proc_CT_DIM_HFit_TrackerSugaryFoods
GO
exec proc_CT_DIM_HFit_TrackerFruits
GO
exec proc_CT_DIM_HFit_TrackerInstance_Tracker
GO
exec proc_CT_DIM_HFit_TrackerCotinine
GO
exec proc_CT_DIM_HFit_TrackerStrength
GO
exec proc_CT_DIM_HFit_TrackerBodyFat
GO
exec proc_CT_DIM_HFit_TrackerWater
GO
exec proc_CT_DIM_HFIT_Tracker
GO
exec proc_CT_DIM_HFit_TrackerRestingHeartRate
GO
exec proc_CT_DIM_HFit_TrackerTests
GO
exec proc_CT_DIM_HFit_TrackerHbA1c
GO
exec proc_CT_DIM_HFit_TrackerMealPortions
GO
exec proc_CT_DIM_HFit_TrackerDailySteps
GO
exec proc_CT_DIM_HFit_TrackerStress
GO
exec proc_CT_DIM_HFit_TrackerBodyMeasurements
GO
exec proc_CT_DIM_HFit_TrackerWeight
GO
exec proc_CT_DIM_HFit_TrackerShots
GO
exec proc_CT_DIM_HFit_TrackerHeight
GO
exec proc_CT_DIM_HFit_TrackerBloodPressure
GO
exec proc_CT_DIM_HFit_TrackerTobaccoAttestation
GO
exec proc_CT_DIM_HFit_TrackerMedicalCarePlan
GO
exec proc_CT_DIM_HFit_TrackerStressManagement
GO
exec proc_CT_DIM_HFit_TrackerWholeGrains
GO
exec proc_CT_DIM_HFit_TrackerCholesterol
GO
exec proc_CT_DIM_HFit_TrackerSitLess
GO
exec proc_CT_DIM_HFit_TrackerBloodSugarAndGlucose
GO
exec proc_CT_DIM_HFit_TrackerHighFatFoods
GO
exec proc_CT_DIM_HFit_TrackerTobaccoFree
GO
exec proc_CT_DIM_HFit_TrackerPreventiveCare
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerBloodPressure
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerCholesterol
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerRegularMeals
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerMedicalCarePlan
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerMealPortions
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerHighSodiumFoods
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerHighFatFoods
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerHeight
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerHbA1c
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerFruits
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerFlexibility
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerDailySteps
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerCardio
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerBMI
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerBodyFat
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerRestingHeartRate
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerSitLess
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerSleepPlan
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerStrength
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerStress
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerStressManagement
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryDrinks
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerSugaryFoods
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoFree
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerVegetables
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerWater
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerWeight
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerWholeGrains
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerCotinine
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerPreventiveCare
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerTobaccoAttestation
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerInstance_Tracker
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerBloodSugarAndGlucose
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerBodyMeasurements
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerTests
GO
exec proc_CT_FACT_TrackerCompositeDetails_TrackerShots
GO
exec proc_CT_DIM_HFit_TrackerBMI_Cursor
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_ConvertAllDatetimeToDatetime2.sql \n 
--------------------------------------------------------------- 


GO
PRINT 'Executing proc_ConvertAllDatetimeToDatetime2.sql';
GO

IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_ConvertAllDatetimeToDatetime2') 
    BEGIN
        DROP PROCEDURE
             proc_ConvertAllDatetimeToDatetime2;
    END;
GO

/*----------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------
SETUP:

use KenticoCMS_DataMart_2

select distinct 'if @ProcessDatetime = 1 truncate table ' + table_name + char(10) + 'GO' 
from information_schema.tables
where table_name like '%_DEL'

select distinct 'if @ProcessDatetime = 1 EXEC proc_ConvertAllDatetimeToDatetime2 ' + table_name + char(10) + 'GO' 
from information_schema.columns 
where table_name like 'BASE_%' and data_type = 'DATETIME'
*/

CREATE PROCEDURE proc_ConvertAllDatetimeToDatetime2 (
       @TblName AS NVARCHAR (250)) 
AS
BEGIN

    -- declare @TblName nvarchar(250) = 'BASE_HFit_TrackerCardio' ;

    BEGIN TRY
        CLOSE C;
        DEALLOCATE C;
    END TRY
    BEGIN CATCH
        PRINT ' ';
    END CATCH;

    BEGIN TRY
        CLOSE CDEFAULTCreate;
        DEALLOCATE CDEFAULTCreate;
    END TRY
    BEGIN CATCH
        PRINT ' ';
    END CATCH;

    BEGIN TRY
        CLOSE CDEFAULTDROP;
        DEALLOCATE CDEFAULTDROP;
    END TRY
    BEGIN CATCH
        PRINT ' ';
    END CATCH;

    BEGIN TRY
        CLOSE CIDXDROP;
        DEALLOCATE CIDXDROP;
    END TRY
    BEGIN CATCH
        PRINT ' ';
    END CATCH;
    BEGIN TRY
        CLOSE CIDXCREATE;
        DEALLOCATE CIDXCREATE;
    END TRY
    BEGIN CATCH
        PRINT ' ';
    END CATCH;

    DECLARE
           @MySql  NVARCHAR (MAX) 
         , @msg NVARCHAR (MAX) 
         , @iCnt INT = 0
         , @CreateIndexScript NVARCHAR (MAX) 
         , @ColumnNAme NVARCHAR (250) 
         , @definition  NVARCHAR (250) ;

    SET @msg = ' ' + char (10) + '*********************************************************' + char (10) + 'Processing: ' + @TblName;
    EXEC PrintImmediate @msg;

    SET  @iCnt = (SELECT
                         count (*) 
                  FROM information_schema.columns
                  WHERE
                         table_name = @TblName AND
                         data_type = 'DATETIME') ;
    IF @iCnt = 0
        BEGIN
            SET @Msg = 'No DATETIME found in ' + @TblName + ', returning.';
            EXEC PrintImmediate @Msg;
            RETURN;
        END;

    BEGIN TRY
        DROP TABLE
             tIndex;
    END TRY
    BEGIN CATCH
        PRINT 'dropped table #tIndex';
    END CATCH;
    CREATE TABLE tIndex
    (
                 CreateIndexScript NVARCHAR (MAX) 
               , INAME NVARCHAR (MAX) 
    );

    INSERT INTO tIndex
    EXEC proc_GetTableIndexes @TblName;
    --  select * from tIndex
    ALTER TABLE tIndex
    ADD
                IndexDropped BIT NULL;

    --set @IndexScript = (Select CreateIndexScript from #tIndex where INAME = @CurrIndexName) ;

    BEGIN TRY
        DROP TABLE
             tIdxColumns;
    END TRY
    BEGIN CATCH
        PRINT 'dropped table #tIdxColumns ';
    END CATCH;

    SELECT
           i.name AS index_name
         , COL_NAME (ic.object_id , ic.column_id) AS column_name
         , ic.index_column_id
         , ic.key_ordinal
         , ic.is_included_column
    INTO
         tIdxColumns
    FROM
         sys.indexes AS i
         INNER JOIN sys.index_columns AS ic
         ON
           i.object_id = ic.object_id AND
           i.index_id = ic.index_id
    WHERE
           i.object_id = OBJECT_ID (@TblName) ;
    --  select * from tIdxColumns

    BEGIN TRY
        DROP TABLE
             TDefaults;
    END TRY
    BEGIN CATCH
        PRINT 'dropped table #TDefaults ';
    END CATCH;

    SELECT
           TableName = t.Name
         , ColumnName = c.Name
         , dc.Name
         , dc.definition
    INTO
         TDefaults
    FROM
         sys.tables AS t
         INNER JOIN sys.default_constraints AS dc
         ON
           t.object_id = dc.parent_object_id
         INNER JOIN sys.columns AS c
         ON
           dc.parent_object_id = c.object_id AND
           c.column_id = dc.parent_column_id
    WHERE
           t.Name = @TblName
    ORDER BY
             t.Name;
    --  select * from TDefaults
    ALTER TABLE TDefaults
    ADD
                DefaultDropped BIT NULL;

    DECLARE
           @table_name AS NVARCHAR (250) = ''
         , @column_name AS NVARCHAR (250) = ''
         , @IndexName AS NVARCHAR (250) = ''
         , @S AS NVARCHAR (MAX) = ''
         , @DefaultName  AS NVARCHAR (250) = ''
         , @i AS INT = 0;

    BEGIN TRANSACTION TX01;

    BEGIN TRY
        DECLARE CIDXDROP CURSOR
            FOR
                SELECT
                       INAME
                FROM tIndex;

        OPEN CIDXDROP;

        FETCH NEXT FROM CIDXDROP INTO @IndexName;
        WHILE
               @@FETCH_STATUS = 0
            BEGIN
                SET @MySql = 'Drop Index ' + @IndexName + ' ON ' + @TblName;
                EXEC PrintImmediate @MySql;
                EXEC (@MySql) ;
                FETCH NEXT FROM CIDXDROP INTO @IndexName;
            END;
        CLOSE CIDXDROP;
        DEALLOCATE CIDXDROP;

        -- select * from TDefaults
        DECLARE CDEFAULTDROP CURSOR
            FOR
                SELECT
                       NAME
                FROM TDefaults;

        OPEN CDEFAULTDROP;

        FETCH NEXT FROM CDEFAULTDROP INTO @IndexName;
        WHILE
               @@FETCH_STATUS = 0
            BEGIN
                --alter table tbloffers drop constraint [ConstraintName]
                SET @MySql = 'Alter Table ' + @TblName + ' drop constraint ' + @IndexName;
                EXEC PrintImmediate @MySql;
                EXEC (@MySql) ;
                FETCH NEXT FROM CDEFAULTDROP INTO @IndexName;
            END;
        CLOSE CDEFAULTDROP;
        DEALLOCATE CDEFAULTDROP;

        DECLARE C CURSOR
            FOR
                SELECT
                       c.table_name
                     , c.column_name
                FROM
                     information_schema.columns AS C
                     JOIN information_schema.tables AS T
                     ON
                       c.table_name = t.table_name AND
                       table_type = 'BASE TABLE' AND
                       c.table_name = @TblName
                WHERE
                       data_type = 'datetime';

        OPEN C;

        FETCH NEXT FROM C
        INTO @table_name , @column_name;

        WHILE
               @@FETCH_STATUS = 0
            BEGIN

                SET @S = '';
                SET @S = 'Alter table ' + @table_name + ' alter column ' + @column_name + ' datetime2 null ';
                EXEC PrintImmediate @S;
                BEGIN TRY
                    EXEC (@S) ;
                END TRY
                BEGIN CATCH
                    PRINT 'ERROR: ' + @S;
                END CATCH;
                FETCH NEXT FROM C
                INTO @table_name , @column_name;
            END;
        CLOSE C;
        DEALLOCATE C;

        DECLARE CIDXCREATE CURSOR
            FOR
                SELECT
                       CreateIndexScript
                     , INAME
                FROM tIndex;
        OPEN CIDXCREATE;
        FETCH NEXT FROM CIDXCREATE
        INTO @CreateIndexScript , @IndexName;
        WHILE
               @@FETCH_STATUS = 0
            BEGIN
                SET @MySql = @CreateIndexScript;
                SET @MySql = replace (@MySql , ' WITH' , ' -- WITH') ;
                EXEC PrintImmediate @MySql;
                EXEC (@MySql) ;
                FETCH NEXT FROM CIDXCREATE
                INTO @CreateIndexScript , @IndexName;
            END;

        CLOSE CIDXCREATE;
        DEALLOCATE CIDXCREATE;

        DECLARE CDEFAULTCreate CURSOR
            FOR
                SELECT
                       ColumnName
                     , Name
                     , definition
                FROM TDefaults;
        OPEN CDEFAULTCreate;
        FETCH NEXT FROM CDEFAULTCreate INTO @ColumnName , @IndexName , @definition;
        WHILE
               @@FETCH_STATUS = 0
            BEGIN
                --ALTER TABLE Employee ADD CONSTRAINT DF_SomeName DEFAULT N'SANDNES' FOR CityBorn;
                SET @MySql = 'Alter Table ' + @TblName + ' ADD CONSTRAINT ' + @IndexName + ' default ' + @definition + ' for ' + @ColumnName;
                EXEC PrintImmediate @MySql;
                EXEC (@MySql) ;
                FETCH NEXT FROM CDEFAULTCreate INTO @ColumnName , @IndexName , @definition;
            END;
        CLOSE CDEFAULTCreate;
        DEALLOCATE CDEFAULTCreate;

        COMMIT TRANSACTION TX01;
    END TRY
    BEGIN CATCH
        PRINT 'ERROR: ROLLBACK Failed on ' + @TblName;
        PRINT '@MySql: ' + @MySql;
        EXECUTE usp_GetErrorInfo;
        ROLLBACK TRANSACTION TX01;
    END CATCH;

    SET @msg = ' -- ------ COMPLETE.' + char (10) + char (10) ;
    EXEC PrintImmediate @msg;

END;

GO
PRINT 'Executed proc_ConvertAllDatetimeToDatetime2.sql';
GO

DECLARE
       @ProcessDatetime AS BIT = 0;

IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_CMS_Class_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_CMS_Document_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_CMS_Site_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_CMS_Tree_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_cms_user_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_cms_usersettings_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_cms_usersite_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_COM_SKU_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_Account_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_CoachingHealthArea_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_CoachingHealthInterest_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HACampaign_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentMatrixQuestion_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentModule_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentMultipleChoiceQuestion_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentRiskArea_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentRiskCategory_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentUserAnswers_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentUserModule_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentUserQuestion_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentUserQuestionGroupResults_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentUserRiskArea_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentUserRiskCategory_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssesmentUserStarted_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssessment_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_HealthAssessmentFreeForm_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFIT_LKP_EDW_REJECTMPI_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_LKP_RewardActivity_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_LKP_RewardLevelType_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_LKP_RewardTrigger_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_LKP_RewardTriggerParameterOperator_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_LKP_RewardType_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_LKP_TrackerVendor_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_OutComeMessages_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_hfit_PPTEligibility_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_RewardActivity_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_RewardException_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_RewardGroup_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_RewardLevel_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_RewardProgram_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_RewardsUserActivityDetail_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_RewardsUserLevelDetail_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_RewardTrigger_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_RewardTriggerParameter_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_Hfit_SmallStepResponses_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_ToDoSmallSteps_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFIT_Tracker_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerBloodPressure_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerBloodSugarAndGlucose_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerBMI_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerBodyFat_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerBodyMeasurements_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerCardio_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerCholesterol_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerCollectionSource_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerCotinine_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerDailySteps_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerDef_Tracker_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerFlexibility_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerFruits_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerHbA1c_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerHeight_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerHighFatFoods_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerHighSodiumFoods_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerInstance_Tracker_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerMealPortions_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerMedicalCarePlan_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerPreventiveCare_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerRegularMeals_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerRestingHeartRate_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerShots_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerSitLess_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerSleepPlan_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerStrength_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerStress_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerStressManagement_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerSugaryDrinks_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerSugaryFoods_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerTests_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerTobaccoAttestation_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerTobaccoFree_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerVegetables_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerWater_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerWeight_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_TrackerWholeGrains_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        truncate TABLE BASE_HFit_UserTracker_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN

        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_CMS_Class;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_CMS_Document_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_CMS_Site;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_CMS_Site_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_CoachingHealthInterest;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_CoachingHealthInterest_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HACampaign;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HACampaign_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentMatrixQuestion;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentMatrixQuestion_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentModule;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentModule_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentMultipleChoiceQuestion;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentMultipleChoiceQuestion_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentRiskArea;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentRiskArea_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentRiskCategory;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentRiskCategory_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserAnswers;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserAnswers_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserModule;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserModule_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserQuestion;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserQuestion_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserQuestionGroupResults;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserQuestionGroupResults_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserRiskArea;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserRiskArea_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserRiskCategory;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserRiskCategory_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserStarted;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssesmentUserStarted_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssessment;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssessment_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssessmentFreeForm;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_HealthAssessmentFreeForm_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFIT_LKP_EDW_REJECTMPI;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFIT_LKP_EDW_REJECTMPI_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_RewardActivity;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_RewardActivity_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_RewardLevelType;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_RewardLevelType_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_RewardTrigger;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_RewardTrigger_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_RewardTriggerParameterOperator;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_RewardTriggerParameterOperator_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_RewardType;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_RewardType_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_TrackerVendor;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_LKP_TrackerVendor_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_OutComeMessages;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_OutComeMessages_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_hfit_PPTEligibility;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_hfit_PPTEligibility_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardActivity;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardActivity_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardException;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardException_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardGroup;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardGroup_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardLevel;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardLevel_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardProgram;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardProgram_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardsUserActivityDetail;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardsUserActivityDetail_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardsUserLevelDetail;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardsUserLevelDetail_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardTrigger;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardTrigger_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardTriggerParameter;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_RewardTriggerParameter_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_Hfit_SmallStepResponses;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_Hfit_SmallStepResponses_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_ToDoSmallSteps;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_ToDoSmallSteps_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFIT_Tracker;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFIT_Tracker_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerBloodPressure;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerBloodPressure_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerBloodSugarAndGlucose;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerBloodSugarAndGlucose_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerBMI;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerBMI_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerBodyFat;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerBodyFat_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerBodyMeasurements;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerBodyMeasurements_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerCardio_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerCholesterol;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerCholesterol_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerCollectionSource;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerCollectionSource_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerCotinine;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerCotinine_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerDailySteps;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerDailySteps_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerDef_Tracker;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerDef_Tracker_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerFlexibility;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerFlexibility_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerFruits;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerFruits_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerHbA1c;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerHbA1c_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerHeight;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerHeight_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerHighFatFoods;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerHighFatFoods_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerHighSodiumFoods;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerHighSodiumFoods_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerInstance_Tracker;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerInstance_Tracker_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerMealPortions;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerMealPortions_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerMedicalCarePlan;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerMedicalCarePlan_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerPreventiveCare;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerPreventiveCare_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerRegularMeals;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerRegularMeals_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerRestingHeartRate;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerRestingHeartRate_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerShots;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerShots_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerSitLess;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerSitLess_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerSleepPlan;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerSleepPlan_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerStrength;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerStrength_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerStress;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerStress_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerStressManagement;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerStressManagement_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerSugaryDrinks;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerSugaryDrinks_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerSugaryFoods;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerSugaryFoods_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerTests;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerTests_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerTobaccoAttestation;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerTobaccoAttestation_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerTobaccoFree;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerTobaccoFree_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerVegetables;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerVegetables_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerWater;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerWeight;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerWeight_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerWholeGrains;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_HFit_TrackerWholeGrains_DEL;
    END;
IF
       @ProcessDatetime = 1
    BEGIN
        EXEC proc_ConvertAllDatetimeToDatetime2 BASE_view_EDW_TrackerCompositeDetails_CT_ONLY;
    END;--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: proc_SetTrackerDataSurrogateKey.sql \n 
--------------------------------------------------------------- 


GO
PRINT 'Executing proc_SetTrackerDataSurrogateKey.sql';
GO

IF EXISTS (SELECT
                  name
           FROM sys.procedures
           WHERE
                  name = 'proc_SetTrackerDataSurrogateKey') 
    BEGIN
        DROP PROCEDURE
             proc_SetTrackerDataSurrogateKey;
    END;
GO
-- exec proc_SetTrackerDataSurrogateKey
CREATE PROCEDURE proc_SetTrackerDataSurrogateKey
AS
BEGIN

    DECLARE
           @Tbl AS NVARCHAR (250) = ''
         , @suffix AS NVARCHAR (250) = ''
         , @IdxName AS NVARCHAR (250) = ''
         , @iCnt AS BIGINT
         , @MySql AS NVARCHAR (MAX) = ''
         , @Msg  AS NVARCHAR (MAX) ;

    DECLARE C CURSOR
        FOR
            SELECT
                   table_name
            FROM information_schema.tables
            WHERE
            table_name LIKE 'BASE_HFit_Tracker%' AND
            table_name NOT LIKE '%_DEL' AND
            table_name NOT LIKE 'BASE_HFit_TrackerDef_Tracker' AND
            table_name NOT LIKE '%_CTVerHIST'
            ORDER BY
                     table_name;

    OPEN C;

    FETCH NEXT FROM C  INTO @tbl;

    WHILE
           @@FETCH_STATUS = 0
        BEGIN

            SET @suffix = substring (@Tbl , charindex ('_' , @Tbl) + 1 , 9999) ;
            SET @Msg = 'Processing Table suffix: ' + @suffix;
            EXEC PrintImmediate @msg;

            SET @IdxName = 'PI_TrackerData_SKEY_' + @suffix;
            SET @MySql = '';
            SET @MySql = @MySql + ' CREATE NONCLUSTERED INDEX ' + @IdxName + ' ON [dbo].[FACT_TrackerData] ' + char (10) ;
            SET @MySql = @MySql + ' ( ' + char (10) ;
            SET @MySql = @MySql + ' 	DBNAME ASC, TrackerName ASC, [SurrogateKey_' + @suffix + '] ASC ' + char (10) ;
            SET @MySql = @MySql + ' ) ' + char (10) ;
            SET @MySql = @MySql + ' INCLUDE ([TrackerName] ) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)  ' + char (10) ;

            IF NOT EXISTS (SELECT
                                  name
                           FROM sys.indexes
                           WHERE name = @IdxName) 
                BEGIN
                    BEGIN TRY
                        EXEC (@Mysql) ;
                        PRINT 'Created Index: ' + @IdxName + '.';
                    END TRY
                    BEGIN CATCH
                        SET @Msg = 'Failed INDEX: ' + @MySql;
                        EXEC PrintImmediate @msg;
                    END CATCH
                END;

            SET @MySql = ' UPDATE T2 ' + char (10) ;
            SET @MySql = @MySql + '     SET ' + char (10) ;
            SET @MySql = @MySql + '        T2.SurrogateKey_XXXXX = T1.SurrogateKey_XXXXX ' + char (10) ;
            SET @MySql = @MySql + ' FROM BASE_XXXXX T1 ' + char (10) ;
            SET @MySql = @MySql + '    INNER JOIN FACT_TrackerData T2 ' + char (10) ;
            SET @MySql = @MySql + '    ON ' + char (10) ;
            SET @MySql = @MySql + '      T1.DBNAME = T2.DBNAME AND ' + char (10) ;
            SET @MySql = @MySql + '      T1.ItemID = T2.ItemID AND ' + char (10) ;
            SET @MySql = @MySql + '	  T1.SurrogateKey_XXXXX != isnull(T2.SurrogateKey_XXXXX,-1) and ' + char (10) ;
            SET @MySql = @MySql + '       T2.TrackerName = ''XXXXX''; ' + char (10) ;

            SET @MySql = replace ( @MySql , 'XXXXX' , @suffix) ;

            BEGIN TRY
                EXEC (@Mysql) ;
                SET @iCnt = @@ROWCOUNT;
                PRINT 'Updated ' + cast (@iCnt AS NVARCHAR (50)) + ' from ' + @Tbl + '.';
            END TRY
            BEGIN CATCH
                SET @Msg = 'Failed: ' + @MySql;
                EXEC PrintImmediate @msg;
            END CATCH;
            FETCH NEXT FROM C  INTO @tbl;
        END;
    CLOSE C;
    DEALLOCATE C;
END;

GO
PRINT 'Executed proc_SetTrackerDataSurrogateKey.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: create_Tracker_Indexes.sql \n 
--------------------------------------------------------------- 

-- use KenticoCMS_DataMArt_2

GO
PRINT 'Executing create_Tracker_Indexes.sql';
GO


-- SELECT 'TRUNCATE TABLE ' + TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME LIKE '%_del'SELECT 'TRUNCATE TABLE ' + TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME LIKE '%_del'


--if (SELECT count(*)
--FROM sys.indexes AS i
--INNER JOIN sys.index_columns AS ic 
--    ON i.object_id = ic.object_id AND i.index_id = ic.index_id
--WHERE i.name = 'PI_TrackerData_SKEY_SurrogateKey_CMS_user'
--and COL_NAME(ic.object_id,ic.column_id) = 'TrackerName') = 0

/*
-- USE this SCRIPT TO CHECK FOR THE EXISTANCE OF THE COLUMN TrackerName AND RE-CREATE INDEX IF MISSING
select 'Print ''START TIME: '''
+char(10) + 'Print getdate() ;' 
+char(10) + 'Print ''PI_TrackerData_SKEY_'+column_name +'''' + 
+char(10) + 'GO'
+char(10) + 'If  (SELECT count(*) ' 
+char(10) + 'FROM sys.indexes AS i '
+char(10) + 'INNER JOIN sys.index_columns AS ic '
+char(10) + '    ON i.object_id = ic.object_id AND i.index_id = ic.index_id'
+char(10) + 'where i.name = ''PI_TrackerData_SKEY_'+column_name +'''' + 
+char(10) + 'and COL_NAME(ic.object_id,ic.column_id) = ''TrackerName'') = 0'
+char(10) + 'BEGIN'
+char(10) + '    if exists (select name from sys.indexes where name = ''PI_TrackerData_SKEY_' + column_name + ''')'
+char(10) + '        DROP INDEX PI_TrackerData_SKEY_' + column_name + ' on dbo.FACT_TrackerData ; ' 
+char(10) + '    CREATE nonclustered INDEX PI_TrackerData_SKEY_' + column_name + ' on dbo.FACT_TrackerData ' 
+char(10) + '      (DBNAME asc, TrackerName ASC, SurrogateKey_' + replace(substring(C.table_name,6,9999),'_DEL','') + ' asc) ' 
+char(10) + 'END'
+char(10) + 'GO'
+char(10) + 'Print ''END TIME: '''
+char(10) + 'Print getdate() ;' 
+char(10) + 'Print ''*************************************************************'' ; ' 
+char(10) + 'GO'
    FROM INFORMATION_SCHEMA.TABLES t 
    LEFT JOIN INFORMATION_SCHEMA.COLUMNS c
    ON c.tABLE_NAME = t.TABLE_NAME 
    AND c.COLUMN_NAME = 'TrackerName'
    WHERE t.TABLE_NAME LIKE '%TRACKER%' 
    AND t.TABLE_NAME LIKE 'BASE_%' 
    AND t.TABLE_NAME not LIKE '%_NONULLS' 
    AND t.TABLE_NAME not LIKE '%_CtVerHist' 
    AND t.TABLE_NAME not LIKE '%_TestData' 
    AND t.TABLE_NAME not LIKE '%_VIEW_%' 
    AND t.TABLE_NAME not LIKE '%_LKP_%'     
    AND t.TABLE_NAME not LIKE '%_join_%'
    AND t.TABLE_NAME not LIKE '%Mapping'
    AND t.TABLE_NAME not LIKE '%Category'
    AND t.TABLE_NAME not LIKE '%_Item'
    AND t.TABLE_NAME not LIKE '%TrackerInstance_Tracker'
    and column_name like 'SurrogateKey_%'
*/    
    

/*

--USE THE FOLLOWING TO CREATE ALL MISSING TRACKER INDEXES on FACT_TrackerData
select 'If  not Exists (select name from sys.indexes where name = ''PI_TrackerData_SKEY_'+column_name +''')' + 
+char(10) + 'BEGIN'
+char(10) + 'CREATE nonclustered INDEX PI_TrackerData_SKEY_' + column_name + ' on dbo.FACT_TrackerData ' 
+char(10) + '(DBNAME asc, TrackerName ASC, ' + column_name + ' asc) ' 
+char(10) + 'END'
+char(10) + 'GO'
+char(10) + 'Print ''END TIME: ''' 
+char(10) + 'Print getdate() '  
+char(10) + 'GO'
from INFORMATION_SCHEMA.COLUMNS
where table_name like 'FACT_TrackerData' and column_name like 'SurrogateKey_%'

--USE THE FOLLOWING TO DROP AND RECREATE ALL TRACKER INDEXES on FACT_TrackerData
select 'If  Exists (select name from sys.indexes where name = ''PI_TrackerData_SKEY_'+column_name +''')' + 
+char(10) + 'BEGIN'
+char(10) + 'Print START TIME: ''' + getdate() + '''' 
+char(10) + 'DROP INDEX PI_TrackerData_SKEY_' + column_name + ' on dbo.FACT_TrackerData ' 
+char(10) + 'END'
+char(10) + 'GO'
+char(10) + 'Print ''' + Column_name + '''' 
+char(10) + 'GO'
+char(10) + 'CREATE nonclustered INDEX PI_TrackerData_SKEY_' + column_name + ' on dbo.FACT_TrackerData ' 
+char(10) + '(DBNAME asc, TrackerName ASC, ' + column_name + ' asc) ' 
+char(10) + 'GO'
+char(10) + 'Print END TIME: ''' + getdate() + '''' 
+char(10) + 'GO'
from INFORMATION_SCHEMA.COLUMNS
where table_name like 'FACT_TrackerData' and column_name like 'SurrogateKey_%'

--USE THE FOLLOWING TO CREATE ALL TRACKER TABLENAME COLUMNS
  SELECT 'If not exists (select column_name from information_Schema.columns where table_name = ''' + T.Table_name + ''' and column_name = ''TrackerName'')'
	+char(10) + 'Alter Table ' + T.table_name 
    +char(10) + 'ADD TrackerName nvarchar(100) default ''' + replace(substring(t.table_name, 6,9999), '_DEL','')  + ''';'
    +char(10) +'GO'
	+char(10) +'Print ''Processing ' + substring(t.table_name, 6,9999) + ''''
	+char(10) +'GO'
    +char(10) + 'Update ' + T.table_name + ' set TrackerName = ''' + replace(substring(t.table_name, 6,9999), '_DEL','') + ''' Where TrackerName is null'
	+char(10) + '   OR TrackerName != ''' + replace(substring(t.table_name, 6,9999), '_DEL','') + ''''
    +char(10) +'GO'+Char(10) 
    FROM INFORMATION_SCHEMA.TABLES t 
    LEFT JOIN INFORMATION_SCHEMA.COLUMNS c
    ON c.tABLE_NAME = t.TABLE_NAME 
    AND c.COLUMN_NAME = 'TrackerName'
    WHERE t.TABLE_NAME LIKE '%TRACKER%' 
    AND t.TABLE_NAME LIKE 'BASE_%' 
    AND t.TABLE_NAME not LIKE '%_NONULLS' 
    AND t.TABLE_NAME not LIKE '%_CtVerHist' 
    AND t.TABLE_NAME not LIKE '%_TestData' 
    AND t.TABLE_NAME not LIKE '%_VIEW_%' 
    AND t.TABLE_NAME not LIKE '%_LKP_%'     
    AND t.TABLE_NAME not LIKE '%_join_%'
    AND t.TABLE_NAME not LIKE '%Mapping'
    AND t.TABLE_NAME not LIKE '%Category'
    AND t.TABLE_NAME not LIKE '%_Item'
    AND t.TABLE_NAME not LIKE '%TrackerInstance_Tracker'    
--and C.Column_name is null
order by T.Table_Name
*/
go

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'PI05_BASE_cms_usersettings') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI05_BASE_cms_usersettings
        ON dbo.BASE_cms_usersettings (UserSettingsUserID , SVR , DBNAME , HFitUserMpiNumber) ;
    END;

GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'PI05_BASE_cms_usersite') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI05_BASE_cms_usersite
        ON dbo.BASE_cms_usersite (UserID , SiteID , SVR , DBNAME) ;
    END;

GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_HFit_Account') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_BASE_HFit_Account ON dbo.BASE_HFit_Account
        (
        SVR ASC ,
        DBNAME ASC ,
        SiteID ASC
        ) 
        INCLUDE (AccountCD , HashCode) WITH (PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON , FILLFACTOR = 80) ON [PRIMARY];
    END;
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'CI05_FACT_EDW_HealthAssesment') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI05_FACT_EDW_HealthAssesment
        ON dbo.FACT_EDW_HealthAssesment (HAQUESTIONNODEGUID , SVR , DBNAME) 
        INCLUDE (USERSTARTEDITEMID) ;
    END;
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'CI05_BASE_HFit_HealthAssesmentUserQuestion') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI05_BASE_HFit_HealthAssesmentUserQuestion
        ON dbo.BASE_HFit_HealthAssesmentUserQuestion (HARiskAreaItemID , SVR , DBNAME) 
        INCLUDE (HAQuestionScore , ItemModifiedWhen , CodeName , PreWeightedScore , IsProfessionallyCollected , HAQuestionNodeGUID , ItemID) ;
    END;
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'PKEY_FACT_EDW_TrackerCompositeDetails') 
    BEGIN
        CREATE UNIQUE NONCLUSTERED INDEX PKEY_FACT_EDW_TrackerCompositeDetails ON dbo.FACT_EDW_TrackerCompositeDetails
        (
        ItemID ASC ,
        SVR ,
        DBNAME , TrackerNameAggregateTable
        ) 
        INCLUDE (AccountCD) ;
    END;
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'PI01_FACT_HFit_TrackerCardio') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI01_FACT_HFit_TrackerCardio
        ON dbo.FACT_HFit_TrackerCardio (ClientCode , SVR , DBNAME) 
        INCLUDE (TrackerNameAggregateTable , ItemID) ;
    END;

GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'PI01_BASE_HFit_TrackerMealPortions') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI01_BASE_HFit_TrackerMealPortions
        ON dbo.BASE_HFit_TrackerMealPortions (TrackerCollectionSourceID , SVR , DBNAME) 
        INCLUDE (UserID) ;
    END;
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'PI00_BASE_hfit_PPTEligibility') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI00_BASE_hfit_PPTEligibility ON dbo.BASE_hfit_PPTEligibility (SVR , DBNAME) 
        INCLUDE (UserID , ClientCode) ;
    END;

GO
IF EXISTS (SELECT
              name
                  FROM sys.indexes
                  WHERE
                  name = 'CI_BASE_HFit_TrackerCollectionSource') 
    BEGIN
        DROP INDEX CI_BASE_HFit_TrackerCollectionSource ON dbo.BASE_HFit_TrackerCollectionSource;
    END;
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_HFit_TrackerCollectionSource') 
    BEGIN
        CREATE NONCLUSTERED INDEX CI_BASE_HFit_TrackerCollectionSource ON dbo.BASE_HFit_TrackerCollectionSource
        (
        SVR ,
        DBNAME ,
        TrackerCollectionSourceID ,
        ItemID
        ) 
        INCLUDE (HashCode) ;
    END;
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'PI01_BASE_cms_user') 
    BEGIN

        CREATE NONCLUSTERED INDEX PI01_BASE_cms_user
        ON dbo.BASE_cms_user (UserID , SVR , DBNAME) ;
    END;
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_hfit_PPTEligibility') 
    BEGIN
        --DROP INDEX [CI_BASE_hfit_PPTEligibility] ON [dbo].[BASE_hfit_PPTEligibility]
        EXEC printImmediate 'Creating [CI_BASE_hfit_PPTEligibility]';

        CREATE NONCLUSTERED INDEX CI_BASE_hfit_PPTEligibility ON dbo.BASE_hfit_PPTEligibility
        (
        SVR , DBNAME , ClientCode , UserID
        ) 
        INCLUDE (MPI , HashCode) WITH (PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
    END;
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'CI_BASE_HFit_TrackerBloodPressure') 
    BEGIN
        --DROP INDEX [CI_BASE_HFit_TrackerBloodPressure] ON [dbo].[BASE_HFit_TrackerBloodPressure]
        EXEC printImmediate 'Creating [CI_BASE_HFit_TrackerBloodPressure]';
        CREATE NONCLUSTERED INDEX [CI_BASE_HFit_TrackerBloodPressure ] ON dbo.BASE_HFit_TrackerBloodPressure
        (
        SVR ,
        DBNAME ,
        ItemID ,
        UserID
        ) 
        INCLUDE (TrackerCollectionSourceID , VendorID , HashCode) WITH (PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
    END;

IF NOT EXISTS (SELECT
                  name
                      FROM sys.indexes
                      WHERE
                      name = 'FACT_EDW_TrackerCompositeDetails_Recno') 
    BEGIN
        CREATE NONCLUSTERED INDEX FACT_EDW_TrackerCompositeDetails_Recno ON dbo.FACT_EDW_TrackerCompositeDetails
        (
        RowNumber ASC
        ) 
        INCLUDE ( 	TrackerNameAggregateTable) WITH (PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
    END;
GO

--*****************************************
print 'STARTING TRACKER INDEXES...'


If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping' and column_name = 'TrackerName')
Alter Table BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping
ADD TrackerName nvarchar(100) default 'HFit_HealthAssessmentCodeNamesToTrackerMapping';
GO
Print 'Processing HFit_HealthAssessmentCodeNamesToTrackerMapping'
GO
Update BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping set TrackerName = 'HFit_HealthAssessmentCodeNamesToTrackerMapping' Where TrackerName is null
   OR TrackerName != 'HFit_HealthAssessmentCodeNamesToTrackerMapping'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping_DEL
ADD TrackerName nvarchar(100) default 'HFit_HealthAssessmentCodeNamesToTrackerMapping';
GO
Print 'Processing HFit_HealthAssessmentCodeNamesToTrackerMapping_DEL'
GO
Update BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping_DEL set TrackerName = 'HFit_HealthAssessmentCodeNamesToTrackerMapping' Where TrackerName is null
   OR TrackerName != 'HFit_HealthAssessmentCodeNamesToTrackerMapping'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_Join_ClinicalSourceTracker' and column_name = 'TrackerName')
Alter Table BASE_HFit_Join_ClinicalSourceTracker
ADD TrackerName nvarchar(100) default 'HFit_Join_ClinicalSourceTracker';
GO
Print 'Processing HFit_Join_ClinicalSourceTracker'
GO
Update BASE_HFit_Join_ClinicalSourceTracker set TrackerName = 'HFit_Join_ClinicalSourceTracker' Where TrackerName is null
   OR TrackerName != 'HFit_Join_ClinicalSourceTracker'
GO
-- use KenticoCMS_Datamart_2
If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_Join_ClinicalSourceTracker_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_Join_ClinicalSourceTracker_DEL
ADD TrackerName nvarchar(100) default 'HFit_Join_ClinicalSourceTracker';
GO
Print 'Processing HFit_Join_ClinicalSourceTracker_DEL'
GO
Update BASE_HFit_Join_ClinicalSourceTracker_DEL set TrackerName = 'HFit_Join_ClinicalSourceTracker' Where TrackerName is null
   OR TrackerName != 'HFit_Join_ClinicalSourceTracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_join_ClinicalTrackers' and column_name = 'TrackerName')
Alter Table BASE_HFit_join_ClinicalTrackers
ADD TrackerName nvarchar(100) default 'HFit_join_ClinicalTrackers';
GO
Print 'Processing HFit_join_ClinicalTrackers'
GO
Update BASE_HFit_join_ClinicalTrackers set TrackerName = 'HFit_join_ClinicalTrackers' Where TrackerName is null
   OR TrackerName != 'HFit_join_ClinicalTrackers'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_join_ClinicalTrackers_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_join_ClinicalTrackers_DEL
ADD TrackerName nvarchar(100) default 'HFit_join_ClinicalTrackers';
GO
Print 'Processing HFit_join_ClinicalTrackers_DEL'
GO
Update BASE_HFit_join_ClinicalTrackers_DEL set TrackerName = 'HFit_join_ClinicalTrackers' Where TrackerName is null
   OR TrackerName != 'HFit_join_ClinicalTrackers'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_Ref_RewardTrackerValidation' and column_name = 'TrackerName')
Alter Table BASE_HFit_Ref_RewardTrackerValidation
ADD TrackerName nvarchar(100) default 'HFit_Ref_RewardTrackerValidation';
GO
Print 'Processing HFit_Ref_RewardTrackerValidation'
GO
Update BASE_HFit_Ref_RewardTrackerValidation set TrackerName = 'HFit_Ref_RewardTrackerValidation' Where TrackerName is null
   OR TrackerName != 'HFit_Ref_RewardTrackerValidation'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_Ref_RewardTrackerValidation_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_Ref_RewardTrackerValidation_DEL
ADD TrackerName nvarchar(100) default 'HFit_Ref_RewardTrackerValidation';
GO
Print 'Processing HFit_Ref_RewardTrackerValidation_DEL'
GO
Update BASE_HFit_Ref_RewardTrackerValidation_DEL set TrackerName = 'HFit_Ref_RewardTrackerValidation' Where TrackerName is null
   OR TrackerName != 'HFit_Ref_RewardTrackerValidation'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFIT_Tracker' and column_name = 'TrackerName')
Alter Table BASE_HFIT_Tracker
ADD TrackerName nvarchar(100) default 'HFIT_Tracker';
GO
Print 'Processing HFIT_Tracker'
GO
Update BASE_HFIT_Tracker set TrackerName = 'HFIT_Tracker' Where TrackerName is null
   OR TrackerName != 'HFIT_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFIT_Tracker_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFIT_Tracker_DEL
ADD TrackerName nvarchar(100) default 'HFIT_Tracker';
GO
Print 'Processing HFIT_Tracker_DEL'
GO
Update BASE_HFIT_Tracker_DEL set TrackerName = 'HFIT_Tracker' Where TrackerName is null
   OR TrackerName != 'HFIT_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBloodPressure' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBloodPressure
ADD TrackerName nvarchar(100) default 'HFit_TrackerBloodPressure';
GO
Print 'Processing HFit_TrackerBloodPressure'
GO
Update BASE_HFit_TrackerBloodPressure set TrackerName = 'HFit_TrackerBloodPressure' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBloodPressure'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBloodPressure_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBloodPressure_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerBloodPressure';
GO
Print 'Processing HFit_TrackerBloodPressure_DEL'
GO
Update BASE_HFit_TrackerBloodPressure_DEL set TrackerName = 'HFit_TrackerBloodPressure' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBloodPressure'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBloodSugarAndGlucose' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBloodSugarAndGlucose
ADD TrackerName nvarchar(100) default 'HFit_TrackerBloodSugarAndGlucose';
GO
Print 'Processing HFit_TrackerBloodSugarAndGlucose'
GO
Update BASE_HFit_TrackerBloodSugarAndGlucose set TrackerName = 'HFit_TrackerBloodSugarAndGlucose' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBloodSugarAndGlucose'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBloodSugarAndGlucose_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBloodSugarAndGlucose_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerBloodSugarAndGlucose';
GO
Print 'Processing HFit_TrackerBloodSugarAndGlucose_DEL'
GO
Update BASE_HFit_TrackerBloodSugarAndGlucose_DEL set TrackerName = 'HFit_TrackerBloodSugarAndGlucose' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBloodSugarAndGlucose'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBMI' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBMI
ADD TrackerName nvarchar(100) default 'HFit_TrackerBMI';
GO
Print 'Processing HFit_TrackerBMI'
GO
Update BASE_HFit_TrackerBMI set TrackerName = 'HFit_TrackerBMI' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBMI'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBMI_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBMI_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerBMI';
GO
Print 'Processing HFit_TrackerBMI_DEL'
GO
Update BASE_HFit_TrackerBMI_DEL set TrackerName = 'HFit_TrackerBMI' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBMI'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBodyFat' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBodyFat
ADD TrackerName nvarchar(100) default 'HFit_TrackerBodyFat';
GO
Print 'Processing HFit_TrackerBodyFat'
GO
Update BASE_HFit_TrackerBodyFat set TrackerName = 'HFit_TrackerBodyFat' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBodyFat'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBodyFat_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBodyFat_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerBodyFat';
GO
Print 'Processing HFit_TrackerBodyFat_DEL'
GO
Update BASE_HFit_TrackerBodyFat_DEL set TrackerName = 'HFit_TrackerBodyFat' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBodyFat'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBodyMeasurements' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBodyMeasurements
ADD TrackerName nvarchar(100) default 'HFit_TrackerBodyMeasurements';
GO
Print 'Processing HFit_TrackerBodyMeasurements'
GO
Update BASE_HFit_TrackerBodyMeasurements set TrackerName = 'HFit_TrackerBodyMeasurements' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBodyMeasurements'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBodyMeasurements_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBodyMeasurements_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerBodyMeasurements';
GO
Print 'Processing HFit_TrackerBodyMeasurements_DEL'
GO
Update BASE_HFit_TrackerBodyMeasurements_DEL set TrackerName = 'HFit_TrackerBodyMeasurements' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBodyMeasurements'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCardio' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCardio
ADD TrackerName nvarchar(100) default 'HFit_TrackerCardio';
GO
Print 'Processing HFit_TrackerCardio'
GO
Update BASE_HFit_TrackerCardio set TrackerName = 'HFit_TrackerCardio' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCardio'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCardio_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCardio_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerCardio';
GO
Print 'Processing HFit_TrackerCardio_DEL'
GO
Update BASE_HFit_TrackerCardio_DEL set TrackerName = 'HFit_TrackerCardio' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCardio'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCategory' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCategory
ADD TrackerName nvarchar(100) default 'HFit_TrackerCategory';
GO
Print 'Processing HFit_TrackerCategory'
GO
Update BASE_HFit_TrackerCategory set TrackerName = 'HFit_TrackerCategory' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCategory'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCategory_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCategory_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerCategory';
GO
Print 'Processing HFit_TrackerCategory_DEL'
GO
Update BASE_HFit_TrackerCategory_DEL set TrackerName = 'HFit_TrackerCategory' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCategory'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCholesterol' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCholesterol
ADD TrackerName nvarchar(100) default 'HFit_TrackerCholesterol';
GO
Print 'Processing HFit_TrackerCholesterol'
GO
Update BASE_HFit_TrackerCholesterol set TrackerName = 'HFit_TrackerCholesterol' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCholesterol'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCholesterol_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCholesterol_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerCholesterol';
GO
Print 'Processing HFit_TrackerCholesterol_DEL'
GO
Update BASE_HFit_TrackerCholesterol_DEL set TrackerName = 'HFit_TrackerCholesterol' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCholesterol'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCollectionSource' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCollectionSource
ADD TrackerName nvarchar(100) default 'HFit_TrackerCollectionSource';
GO
Print 'Processing HFit_TrackerCollectionSource'
GO
Update BASE_HFit_TrackerCollectionSource set TrackerName = 'HFit_TrackerCollectionSource' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCollectionSource'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCollectionSource_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCollectionSource_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerCollectionSource';
GO
Print 'Processing HFit_TrackerCollectionSource_DEL'
GO
Update BASE_HFit_TrackerCollectionSource_DEL set TrackerName = 'HFit_TrackerCollectionSource' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCollectionSource'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCotinine' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCotinine
ADD TrackerName nvarchar(100) default 'HFit_TrackerCotinine';
GO
Print 'Processing HFit_TrackerCotinine'
GO
Update BASE_HFit_TrackerCotinine set TrackerName = 'HFit_TrackerCotinine' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCotinine'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCotinine_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCotinine_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerCotinine';
GO
Print 'Processing HFit_TrackerCotinine_DEL'
GO
Update BASE_HFit_TrackerCotinine_DEL set TrackerName = 'HFit_TrackerCotinine' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCotinine'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDailySteps' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDailySteps
ADD TrackerName nvarchar(100) default 'HFit_TrackerDailySteps';
GO
Print 'Processing HFit_TrackerDailySteps'
GO
Update BASE_HFit_TrackerDailySteps set TrackerName = 'HFit_TrackerDailySteps' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDailySteps'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDailySteps_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDailySteps_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerDailySteps';
GO
Print 'Processing HFit_TrackerDailySteps_DEL'
GO
Update BASE_HFit_TrackerDailySteps_DEL set TrackerName = 'HFit_TrackerDailySteps' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDailySteps'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDef_Item' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDef_Item
ADD TrackerName nvarchar(100) default 'HFit_TrackerDef_Item';
GO
Print 'Processing HFit_TrackerDef_Item'
GO
Update BASE_HFit_TrackerDef_Item set TrackerName = 'HFit_TrackerDef_Item' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDef_Item'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDef_Item_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDef_Item_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerDef_Item';
GO
Print 'Processing HFit_TrackerDef_Item_DEL'
GO
Update BASE_HFit_TrackerDef_Item_DEL set TrackerName = 'HFit_TrackerDef_Item' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDef_Item'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDef_Tracker' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDef_Tracker
ADD TrackerName nvarchar(100) default 'HFit_TrackerDef_Tracker';
GO
Print 'Processing HFit_TrackerDef_Tracker'
GO
Update BASE_HFit_TrackerDef_Tracker set TrackerName = 'HFit_TrackerDef_Tracker' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDef_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDef_Tracker_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDef_Tracker_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerDef_Tracker';
GO
Print 'Processing HFit_TrackerDef_Tracker_DEL'
GO
Update BASE_HFit_TrackerDef_Tracker_DEL set TrackerName = 'HFit_TrackerDef_Tracker' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDef_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDocument' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDocument
ADD TrackerName nvarchar(100) default 'HFit_TrackerDocument';
GO
Print 'Processing HFit_TrackerDocument'
GO
Update BASE_HFit_TrackerDocument set TrackerName = 'HFit_TrackerDocument' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDocument'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDocument_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDocument_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerDocument';
GO
Print 'Processing HFit_TrackerDocument_DEL'
GO
Update BASE_HFit_TrackerDocument_DEL set TrackerName = 'HFit_TrackerDocument' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDocument'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerFlexibility' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerFlexibility
ADD TrackerName nvarchar(100) default 'HFit_TrackerFlexibility';
GO
Print 'Processing HFit_TrackerFlexibility'
GO
Update BASE_HFit_TrackerFlexibility set TrackerName = 'HFit_TrackerFlexibility' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerFlexibility'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerFlexibility_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerFlexibility_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerFlexibility';
GO
Print 'Processing HFit_TrackerFlexibility_DEL'
GO
Update BASE_HFit_TrackerFlexibility_DEL set TrackerName = 'HFit_TrackerFlexibility' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerFlexibility'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerFruits' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerFruits
ADD TrackerName nvarchar(100) default 'HFit_TrackerFruits';
GO
Print 'Processing HFit_TrackerFruits'
GO
Update BASE_HFit_TrackerFruits set TrackerName = 'HFit_TrackerFruits' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerFruits'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerFruits_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerFruits_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerFruits';
GO
Print 'Processing HFit_TrackerFruits_DEL'
GO
Update BASE_HFit_TrackerFruits_DEL set TrackerName = 'HFit_TrackerFruits' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerFruits'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHbA1c' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHbA1c
ADD TrackerName nvarchar(100) default 'HFit_TrackerHbA1c';
GO
Print 'Processing HFit_TrackerHbA1c'
GO
Update BASE_HFit_TrackerHbA1c set TrackerName = 'HFit_TrackerHbA1c' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHbA1c'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHbA1c_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHbA1c_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerHbA1c';
GO
Print 'Processing HFit_TrackerHbA1c_DEL'
GO
Update BASE_HFit_TrackerHbA1c_DEL set TrackerName = 'HFit_TrackerHbA1c' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHbA1c'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHeight' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHeight
ADD TrackerName nvarchar(100) default 'HFit_TrackerHeight';
GO
Print 'Processing HFit_TrackerHeight'
GO
Update BASE_HFit_TrackerHeight set TrackerName = 'HFit_TrackerHeight' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHeight'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHeight_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHeight_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerHeight';
GO
Print 'Processing HFit_TrackerHeight_DEL'
GO
Update BASE_HFit_TrackerHeight_DEL set TrackerName = 'HFit_TrackerHeight' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHeight'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHighFatFoods' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHighFatFoods
ADD TrackerName nvarchar(100) default 'HFit_TrackerHighFatFoods';
GO
Print 'Processing HFit_TrackerHighFatFoods'
GO
Update BASE_HFit_TrackerHighFatFoods set TrackerName = 'HFit_TrackerHighFatFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHighFatFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHighFatFoods_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHighFatFoods_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerHighFatFoods';
GO
Print 'Processing HFit_TrackerHighFatFoods_DEL'
GO
Update BASE_HFit_TrackerHighFatFoods_DEL set TrackerName = 'HFit_TrackerHighFatFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHighFatFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHighSodiumFoods' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHighSodiumFoods
ADD TrackerName nvarchar(100) default 'HFit_TrackerHighSodiumFoods';
GO
Print 'Processing HFit_TrackerHighSodiumFoods'
GO
Update BASE_HFit_TrackerHighSodiumFoods set TrackerName = 'HFit_TrackerHighSodiumFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHighSodiumFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHighSodiumFoods_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHighSodiumFoods_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerHighSodiumFoods';
GO
Print 'Processing HFit_TrackerHighSodiumFoods_DEL'
GO
Update BASE_HFit_TrackerHighSodiumFoods_DEL set TrackerName = 'HFit_TrackerHighSodiumFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHighSodiumFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerInstance_Item' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerInstance_Item
ADD TrackerName nvarchar(100) default 'HFit_TrackerInstance_Item';
GO
Print 'Processing HFit_TrackerInstance_Item'
GO
Update BASE_HFit_TrackerInstance_Item set TrackerName = 'HFit_TrackerInstance_Item' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerInstance_Item'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerInstance_Item_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerInstance_Item_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerInstance_Item';
GO
Print 'Processing HFit_TrackerInstance_Item_DEL'
GO
Update BASE_HFit_TrackerInstance_Item_DEL set TrackerName = 'HFit_TrackerInstance_Item' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerInstance_Item'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerInstance_Tracker' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerInstance_Tracker
ADD TrackerName nvarchar(100) default 'HFit_TrackerInstance_Tracker';
GO
Print 'Processing HFit_TrackerInstance_Tracker'
GO
Update BASE_HFit_TrackerInstance_Tracker set TrackerName = 'HFit_TrackerInstance_Tracker' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerInstance_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerInstance_Tracker_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerInstance_Tracker_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerInstance_Tracker';
GO
Print 'Processing HFit_TrackerInstance_Tracker_DEL'
GO
Update BASE_HFit_TrackerInstance_Tracker_DEL set TrackerName = 'HFit_TrackerInstance_Tracker' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerInstance_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerMealPortions' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerMealPortions
ADD TrackerName nvarchar(100) default 'HFit_TrackerMealPortions';
GO
Print 'Processing HFit_TrackerMealPortions'
GO
Update BASE_HFit_TrackerMealPortions set TrackerName = 'HFit_TrackerMealPortions' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerMealPortions'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerMealPortions_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerMealPortions_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerMealPortions';
GO
Print 'Processing HFit_TrackerMealPortions_DEL'
GO
Update BASE_HFit_TrackerMealPortions_DEL set TrackerName = 'HFit_TrackerMealPortions' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerMealPortions'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerMedicalCarePlan' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerMedicalCarePlan
ADD TrackerName nvarchar(100) default 'HFit_TrackerMedicalCarePlan';
GO
Print 'Processing HFit_TrackerMedicalCarePlan'
GO
Update BASE_HFit_TrackerMedicalCarePlan set TrackerName = 'HFit_TrackerMedicalCarePlan' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerMedicalCarePlan'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerMedicalCarePlan_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerMedicalCarePlan_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerMedicalCarePlan';
GO
Print 'Processing HFit_TrackerMedicalCarePlan_DEL'
GO
Update BASE_HFit_TrackerMedicalCarePlan_DEL set TrackerName = 'HFit_TrackerMedicalCarePlan' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerMedicalCarePlan'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerPreventiveCare' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerPreventiveCare
ADD TrackerName nvarchar(100) default 'HFit_TrackerPreventiveCare';
GO
Print 'Processing HFit_TrackerPreventiveCare'
GO
Update BASE_HFit_TrackerPreventiveCare set TrackerName = 'HFit_TrackerPreventiveCare' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerPreventiveCare'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerPreventiveCare_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerPreventiveCare_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerPreventiveCare';
GO
Print 'Processing HFit_TrackerPreventiveCare_DEL'
GO
Update BASE_HFit_TrackerPreventiveCare_DEL set TrackerName = 'HFit_TrackerPreventiveCare' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerPreventiveCare'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerRegularMeals' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerRegularMeals
ADD TrackerName nvarchar(100) default 'HFit_TrackerRegularMeals';
GO
Print 'Processing HFit_TrackerRegularMeals'
GO
Update BASE_HFit_TrackerRegularMeals set TrackerName = 'HFit_TrackerRegularMeals' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerRegularMeals'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerRegularMeals_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerRegularMeals_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerRegularMeals';
GO
Print 'Processing HFit_TrackerRegularMeals_DEL'
GO
Update BASE_HFit_TrackerRegularMeals_DEL set TrackerName = 'HFit_TrackerRegularMeals' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerRegularMeals'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerRestingHeartRate' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerRestingHeartRate
ADD TrackerName nvarchar(100) default 'HFit_TrackerRestingHeartRate';
GO
Print 'Processing HFit_TrackerRestingHeartRate'
GO
Update BASE_HFit_TrackerRestingHeartRate set TrackerName = 'HFit_TrackerRestingHeartRate' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerRestingHeartRate'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerRestingHeartRate_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerRestingHeartRate_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerRestingHeartRate';
GO
Print 'Processing HFit_TrackerRestingHeartRate_DEL'
GO
Update BASE_HFit_TrackerRestingHeartRate_DEL set TrackerName = 'HFit_TrackerRestingHeartRate' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerRestingHeartRate'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerShots' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerShots
ADD TrackerName nvarchar(100) default 'HFit_TrackerShots';
GO
Print 'Processing HFit_TrackerShots'
GO
Update BASE_HFit_TrackerShots set TrackerName = 'HFit_TrackerShots' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerShots'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerShots_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerShots_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerShots';
GO
Print 'Processing HFit_TrackerShots_DEL'
GO
Update BASE_HFit_TrackerShots_DEL set TrackerName = 'HFit_TrackerShots' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerShots'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSitLess' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSitLess
ADD TrackerName nvarchar(100) default 'HFit_TrackerSitLess';
GO
Print 'Processing HFit_TrackerSitLess'
GO
Update BASE_HFit_TrackerSitLess set TrackerName = 'HFit_TrackerSitLess' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSitLess'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSitLess_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSitLess_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerSitLess';
GO
Print 'Processing HFit_TrackerSitLess_DEL'
GO
Update BASE_HFit_TrackerSitLess_DEL set TrackerName = 'HFit_TrackerSitLess' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSitLess'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSleepPlan' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSleepPlan
ADD TrackerName nvarchar(100) default 'HFit_TrackerSleepPlan';
GO
Print 'Processing HFit_TrackerSleepPlan'
GO
Update BASE_HFit_TrackerSleepPlan set TrackerName = 'HFit_TrackerSleepPlan' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSleepPlan'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSleepPlan_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSleepPlan_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerSleepPlan';
GO
Print 'Processing HFit_TrackerSleepPlan_DEL'
GO
Update BASE_HFit_TrackerSleepPlan_DEL set TrackerName = 'HFit_TrackerSleepPlan' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSleepPlan'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStrength' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStrength
ADD TrackerName nvarchar(100) default 'HFit_TrackerStrength';
GO
Print 'Processing HFit_TrackerStrength'
GO
Update BASE_HFit_TrackerStrength set TrackerName = 'HFit_TrackerStrength' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStrength'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStrength_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStrength_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerStrength';
GO
Print 'Processing HFit_TrackerStrength_DEL'
GO
Update BASE_HFit_TrackerStrength_DEL set TrackerName = 'HFit_TrackerStrength' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStrength'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStress' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStress
ADD TrackerName nvarchar(100) default 'HFit_TrackerStress';
GO
Print 'Processing HFit_TrackerStress'
GO
Update BASE_HFit_TrackerStress set TrackerName = 'HFit_TrackerStress' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStress'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStress_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStress_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerStress';
GO
Print 'Processing HFit_TrackerStress_DEL'
GO
Update BASE_HFit_TrackerStress_DEL set TrackerName = 'HFit_TrackerStress' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStress'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStressManagement' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStressManagement
ADD TrackerName nvarchar(100) default 'HFit_TrackerStressManagement';
GO
Print 'Processing HFit_TrackerStressManagement'
GO
Update BASE_HFit_TrackerStressManagement set TrackerName = 'HFit_TrackerStressManagement' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStressManagement'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStressManagement_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStressManagement_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerStressManagement';
GO
Print 'Processing HFit_TrackerStressManagement_DEL'
GO
Update BASE_HFit_TrackerStressManagement_DEL set TrackerName = 'HFit_TrackerStressManagement' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStressManagement'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSugaryDrinks' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSugaryDrinks
ADD TrackerName nvarchar(100) default 'HFit_TrackerSugaryDrinks';
GO
Print 'Processing HFit_TrackerSugaryDrinks'
GO
Update BASE_HFit_TrackerSugaryDrinks set TrackerName = 'HFit_TrackerSugaryDrinks' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSugaryDrinks'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSugaryDrinks_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSugaryDrinks_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerSugaryDrinks';
GO
Print 'Processing HFit_TrackerSugaryDrinks_DEL'
GO
Update BASE_HFit_TrackerSugaryDrinks_DEL set TrackerName = 'HFit_TrackerSugaryDrinks' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSugaryDrinks'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSugaryFoods' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSugaryFoods
ADD TrackerName nvarchar(100) default 'HFit_TrackerSugaryFoods';
GO
Print 'Processing HFit_TrackerSugaryFoods'
GO
Update BASE_HFit_TrackerSugaryFoods set TrackerName = 'HFit_TrackerSugaryFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSugaryFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSugaryFoods_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSugaryFoods_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerSugaryFoods';
GO
Print 'Processing HFit_TrackerSugaryFoods_DEL'
GO
Update BASE_HFit_TrackerSugaryFoods_DEL set TrackerName = 'HFit_TrackerSugaryFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSugaryFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSummary' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSummary
ADD TrackerName nvarchar(100) default 'HFit_TrackerSummary';
GO
Print 'Processing HFit_TrackerSummary'
GO
Update BASE_HFit_TrackerSummary set TrackerName = 'HFit_TrackerSummary' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSummary'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSummary_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSummary_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerSummary';
GO
Print 'Processing HFit_TrackerSummary_DEL'
GO
Update BASE_HFit_TrackerSummary_DEL set TrackerName = 'HFit_TrackerSummary' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSummary'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTests' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTests
ADD TrackerName nvarchar(100) default 'HFit_TrackerTests';
GO
Print 'Processing HFit_TrackerTests'
GO
Update BASE_HFit_TrackerTests set TrackerName = 'HFit_TrackerTests' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTests'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTests_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTests_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerTests';
GO
Print 'Processing HFit_TrackerTests_DEL'
GO
Update BASE_HFit_TrackerTests_DEL set TrackerName = 'HFit_TrackerTests' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTests'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTobaccoAttestation' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTobaccoAttestation
ADD TrackerName nvarchar(100) default 'HFit_TrackerTobaccoAttestation';
GO
Print 'Processing HFit_TrackerTobaccoAttestation'
GO
Update BASE_HFit_TrackerTobaccoAttestation set TrackerName = 'HFit_TrackerTobaccoAttestation' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTobaccoAttestation'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTobaccoAttestation_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTobaccoAttestation_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerTobaccoAttestation';
GO
Print 'Processing HFit_TrackerTobaccoAttestation_DEL'
GO
Update BASE_HFit_TrackerTobaccoAttestation_DEL set TrackerName = 'HFit_TrackerTobaccoAttestation' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTobaccoAttestation'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTobaccoFree' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTobaccoFree
ADD TrackerName nvarchar(100) default 'HFit_TrackerTobaccoFree';
GO
Print 'Processing HFit_TrackerTobaccoFree'
GO
Update BASE_HFit_TrackerTobaccoFree set TrackerName = 'HFit_TrackerTobaccoFree' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTobaccoFree'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTobaccoFree_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTobaccoFree_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerTobaccoFree';
GO
Print 'Processing HFit_TrackerTobaccoFree_DEL'
GO
Update BASE_HFit_TrackerTobaccoFree_DEL set TrackerName = 'HFit_TrackerTobaccoFree' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTobaccoFree'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerVegetables' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerVegetables
ADD TrackerName nvarchar(100) default 'HFit_TrackerVegetables';
GO
Print 'Processing HFit_TrackerVegetables'
GO
Update BASE_HFit_TrackerVegetables set TrackerName = 'HFit_TrackerVegetables' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerVegetables'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerVegetables_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerVegetables_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerVegetables';
GO
Print 'Processing HFit_TrackerVegetables_DEL'
GO
Update BASE_HFit_TrackerVegetables_DEL set TrackerName = 'HFit_TrackerVegetables' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerVegetables'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWater' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWater
ADD TrackerName nvarchar(100) default 'HFit_TrackerWater';
GO
Print 'Processing HFit_TrackerWater'
GO
Update BASE_HFit_TrackerWater set TrackerName = 'HFit_TrackerWater' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWater'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWater_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWater_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerWater';
GO
Print 'Processing HFit_TrackerWater_DEL'
GO
Update BASE_HFit_TrackerWater_DEL set TrackerName = 'HFit_TrackerWater' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWater'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWeight' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWeight
ADD TrackerName nvarchar(100) default 'HFit_TrackerWeight';
GO
Print 'Processing HFit_TrackerWeight'
GO
Update BASE_HFit_TrackerWeight set TrackerName = 'HFit_TrackerWeight' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWeight'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWeight_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWeight_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerWeight';
GO
Print 'Processing HFit_TrackerWeight_DEL'
GO
Update BASE_HFit_TrackerWeight_DEL set TrackerName = 'HFit_TrackerWeight' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWeight'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWholeGrains' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWholeGrains
ADD TrackerName nvarchar(100) default 'HFit_TrackerWholeGrains';
GO
Print 'Processing HFit_TrackerWholeGrains'
GO
Update BASE_HFit_TrackerWholeGrains set TrackerName = 'HFit_TrackerWholeGrains' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWholeGrains'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWholeGrains_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWholeGrains_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerWholeGrains';
GO
Print 'Processing HFit_TrackerWholeGrains_DEL'
GO
Update BASE_HFit_TrackerWholeGrains_DEL set TrackerName = 'HFit_TrackerWholeGrains' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWholeGrains'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_UserTracker' and column_name = 'TrackerName')
Alter Table BASE_HFit_UserTracker
ADD TrackerName nvarchar(100) default 'HFit_UserTracker';
GO
Print 'Processing HFit_UserTracker'
GO
Update BASE_HFit_UserTracker set TrackerName = 'HFit_UserTracker' Where TrackerName is null
   OR TrackerName != 'HFit_UserTracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_UserTracker_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_UserTracker_DEL
ADD TrackerName nvarchar(100) default 'HFit_UserTracker';
GO
Print 'Processing HFit_UserTracker_DEL'
GO
Update BASE_HFit_UserTracker_DEL set TrackerName = 'HFit_UserTracker' Where TrackerName is null
   OR TrackerName != 'HFit_UserTracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_UserTrackerCategory' and column_name = 'TrackerName')
Alter Table BASE_HFit_UserTrackerCategory
ADD TrackerName nvarchar(100) default 'HFit_UserTrackerCategory';
GO
Print 'Processing HFit_UserTrackerCategory'
GO
Update BASE_HFit_UserTrackerCategory set TrackerName = 'HFit_UserTrackerCategory' Where TrackerName is null
   OR TrackerName != 'HFit_UserTrackerCategory'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_UserTrackerCategory_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_UserTrackerCategory_DEL
ADD TrackerName nvarchar(100) default 'HFit_UserTrackerCategory';
GO
Print 'Processing HFit_UserTrackerCategory_DEL'
GO
Update BASE_HFit_UserTrackerCategory_DEL set TrackerName = 'HFit_UserTrackerCategory' Where TrackerName is null
   OR TrackerName != 'HFit_UserTrackerCategory'
GO


--*************************************************
-- CHECK INDEXES EXIST
wdmxx
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_CMS_user')
BEGIN
Print 'SurrogateKey_CMS_user'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_CMS_user on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_CMS_user asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFIT_Tracker')
BEGIN
Print 'SurrogateKey_HFIT_Tracker'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFIT_Tracker on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFIT_Tracker asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerBloodPressure')
BEGIN
Print 'SurrogateKey_HFit_TrackerBloodPressure'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerBloodPressure on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerBloodPressure asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerBloodSugarAndGlucose')
BEGIN
Print 'SurrogateKey_HFit_TrackerBloodSugarAndGlucose'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerBloodSugarAndGlucose on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerBloodSugarAndGlucose asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerBMI')
BEGIN
Print 'SurrogateKey_HFit_TrackerBMI'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerBMI on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerBMI asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerBodyFat')
BEGIN
Print 'SurrogateKey_HFit_TrackerBodyFat'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerBodyFat on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerBodyFat asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerBodyMeasurements')
BEGIN
Print 'SurrogateKey_HFit_TrackerBodyMeasurements'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerBodyMeasurements on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerBodyMeasurements asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerCardio')
BEGIN
Print 'SurrogateKey_HFit_TrackerCardio'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerCardio on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerCardio asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerCholesterol')
BEGIN
Print 'SurrogateKey_HFit_TrackerCholesterol'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerCholesterol on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerCholesterol asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerCollectionSource')
BEGIN
Print 'SurrogateKey_HFit_TrackerCollectionSource'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerCollectionSource on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerCollectionSource asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerCotinine')
BEGIN
Print 'SurrogateKey_HFit_TrackerCotinine'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerCotinine on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerCotinine asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerDailySteps')
BEGIN
Print 'SurrogateKey_HFit_TrackerDailySteps'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerDailySteps on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerDailySteps asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerDef_Tracker')
BEGIN
Print 'SurrogateKey_HFit_TrackerDef_Tracker'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerDef_Tracker on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerDef_Tracker asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerFlexibility')
BEGIN
Print 'SurrogateKey_HFit_TrackerFlexibility'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerFlexibility on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerFlexibility asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerFruits')
BEGIN
Print 'SurrogateKey_HFit_TrackerFruits'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerFruits on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerFruits asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerHbA1c')
BEGIN
Print 'SurrogateKey_HFit_TrackerHbA1c'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerHbA1c on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerHbA1c asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerHeight')
BEGIN
Print 'SurrogateKey_HFit_TrackerHeight'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerHeight on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerHeight asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerHighFatFoods')
BEGIN
Print 'SurrogateKey_HFit_TrackerHighFatFoods'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerHighFatFoods on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerHighFatFoods asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerHighSodiumFoods')
BEGIN
Print 'SurrogateKey_HFit_TrackerHighSodiumFoods'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerHighSodiumFoods on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerHighSodiumFoods asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerInstance_Tracker')
BEGIN
Print 'SurrogateKey_HFit_TrackerInstance_Tracker'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerInstance_Tracker on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerInstance_Tracker asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerMealPortions')
BEGIN
Print 'SurrogateKey_HFit_TrackerMealPortions'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerMealPortions on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerMealPortions asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerMedicalCarePlan')
BEGIN
Print 'SurrogateKey_HFit_TrackerMedicalCarePlan'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerMedicalCarePlan on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerMedicalCarePlan asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerPreventiveCare')
BEGIN
Print 'SurrogateKey_HFit_TrackerPreventiveCare'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerPreventiveCare on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerPreventiveCare asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerRegularMeals')
BEGIN
Print 'SurrogateKey_HFit_TrackerRegularMeals'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerRegularMeals on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerRegularMeals asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerRestingHeartRate')
BEGIN
Print 'SurrogateKey_HFit_TrackerRestingHeartRate'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerRestingHeartRate on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerRestingHeartRate asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerShots')
BEGIN
Print 'SurrogateKey_HFit_TrackerShots'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerShots on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerShots asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerSitLess')
BEGIN
Print 'SurrogateKey_HFit_TrackerSitLess'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerSitLess on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerSitLess asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerSleepPlan')
BEGIN
Print 'SurrogateKey_HFit_TrackerSleepPlan'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerSleepPlan on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerSleepPlan asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerStrength')
BEGIN
Print 'SurrogateKey_HFit_TrackerStrength'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerStrength on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerStrength asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerStress')
BEGIN
Print 'SurrogateKey_HFit_TrackerStress'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerStress on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerStress asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerStressManagement')
BEGIN
Print 'SurrogateKey_HFit_TrackerStressManagement'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerStressManagement on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerStressManagement asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerSugaryDrinks')
BEGIN
Print 'SurrogateKey_HFit_TrackerSugaryDrinks'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerSugaryDrinks on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerSugaryDrinks asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerSugaryFoods')
BEGIN
Print 'SurrogateKey_HFit_TrackerSugaryFoods'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerSugaryFoods on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerSugaryFoods asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerTests')
BEGIN
Print 'SurrogateKey_HFit_TrackerTests'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerTests on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerTests asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerTobaccoAttestation')
BEGIN
Print 'SurrogateKey_HFit_TrackerTobaccoAttestation'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerTobaccoAttestation on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerTobaccoAttestation asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerTobaccoFree')
BEGIN
Print 'SurrogateKey_HFit_TrackerTobaccoFree'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerTobaccoFree on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerTobaccoFree asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerVegetables')
BEGIN
Print 'SurrogateKey_HFit_TrackerVegetables'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerVegetables on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerVegetables asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerWater')
BEGIN
Print 'SurrogateKey_HFit_TrackerWater'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerWater on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerWater asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerWeight')
BEGIN
Print 'SurrogateKey_HFit_TrackerWeight'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerWeight on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerWeight asc) 
END
GO
If NOT Exists (select name from sys.indexes where name = 'PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerWholeGrains')
BEGIN
Print 'SurrogateKey_HFit_TrackerWholeGrains'
CREATE nonclustered INDEX PI_TrackerData_SKEY_SurrogateKey_HFit_TrackerWholeGrains on dbo.FACT_TrackerData 
(DBNAME asc, TrackerName ASC, SurrogateKey_HFit_TrackerWholeGrains asc) 
END
GO

--*******************************************************
PRINT 'COMPLETE! - Executed create_Tracker_Indexes.sql'; 

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: create_Trigger__ON_TrackerName.sql \n 
--------------------------------------------------------------- 

-- USE [KenticoCMS_Datamart_2];
--**********************************************************************

go
print 'Executing create_Trigger__ON_TrackerName' 
go
if exists (select name from sys.procedures where name = 'proc_create_Trigger_ON_TrackerName')
    drop procedure proc_create_Trigger_ON_TrackerName;
go

create procedure proc_create_Trigger_ON_TrackerName as
begin
set nocount off ;

DECLARE
      @MySql AS nvarchar (max) , 
      @DBNAME AS nvarchar (250) = 'KenticoCMS_2' , 
      @TblName AS nvarchar (250) = '' , 
      @I AS int = 0;

DECLARE CursorTrigger CURSOR
    FOR SELECT DISTINCT table_name
          FROM information_schema.columns
          WHERE column_name = 'TrackerName'
            AND table_name NOT LIKE '%DEL'
            AND table_name NOT LIKE '%view%'
		  AND table_name NOT LIKE '%TESTDATA';

OPEN CursorTrigger;

FETCH NEXT FROM CursorTrigger INTO @TblName;
DECLARE
      @ShortTblName AS nvarchar (100) = '' , 
      @TriggerName AS nvarchar (250) = '';
WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @I = @I + 1;
	   -- if @I > 2 goto NOMORE ;
        SET @ShortTblName = SUBSTRING (@TblName , 6 , 9999) ;
        SET @TriggerName = 'TRIG_TNAME_INS_' + @TblName;

        IF EXISTS (SELECT *
                     FROM sys.objects
                     WHERE type = 'TR'
                       AND name = @TriggerName) 
            BEGIN
                SET @MySQl = 'DROP TRIGGER ' + @TriggerName;
                EXEC (@MySQl) ;
			 print 'Replaced Trigger: ' + @TriggerName;
            END;
        SET @TriggerName = 'TRIG_TNAME_UPDT_' + @TblName;
        IF EXISTS (SELECT *
                     FROM sys.objects
                     WHERE type = 'TR'
                       AND name = @TriggerName) 
            BEGIN
                SET @MySQl = 'DROP TRIGGER ' + @TriggerName;
                EXEC (@MySQl) ;
			 print 'Replaced Trigger: ' + @TriggerName;
            END;

        SET @MySQl = '';
        SET @MySQl = @MySQl + ' create TRIGGER dbo.TRIG_TNAME_INS_' + @TblName + ' ON dbo.' + @TblName + ' ' + CHAR (10) ;
        SET @MySQl = @MySQl + ' AFTER INSERT  ' + CHAR (10) ;
        SET @MySQl = @MySQl + ' AS ' + CHAR (10) ;
        SET @MySQl = @MySQl + ' BEGIN ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      UPDATE T ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      SET T.TrackerName = REPLACE (T.TrackerName , ''BASE_'' , '''')  ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      FROM ' + @TblName + ' T ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      JOIN inserted I ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      ON T.SurrogateKey_' + @ShortTblName + ' = I.SurrogateKey_' + @ShortTblName + '; ' + CHAR (10) ;
        SET @MySQl = @MySQl + '       ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      UPDATE T ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      SET T.TrackerName = REPLACE (T.TrackerName , ''FACT_'' , '''') ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      FROM ' + @TblName + ' T ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      JOIN inserted I ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      ON T.SurrogateKey_' + @ShortTblName + ' = I.SurrogateKey_' + @ShortTblName + '; ' + CHAR (10) ;
        SET @MySQl = @MySQl + 'END;  ' + CHAR (10) ;

        --PRINT @MySql;
        EXEC (@MySql) ;

        SET @MySQl = 'CREATE TRIGGER dbo.TRIG_TNAME_UPDT_' + @TblName + ' ON dbo.' + @TblName + ' ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      AFTER UPDATE  ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      AS ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      BEGIN ' + CHAR (10) ;
        SET @MySQl = @MySQl + '           UPDATE T ' + CHAR (10) ;
        SET @MySQl = @MySQl + '           SET T.TrackerName = REPLACE (T.TrackerName , ''BASE_'' , '''') ' + CHAR (10) ;
        SET @MySQl = @MySQl + '           FROM ' + @TblName + ' T ' + CHAR (10) ;
        SET @MySQl = @MySQl + '           JOIN inserted I ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      ON T.SurrogateKey_' + @ShortTblName + ' = I.SurrogateKey_' + @ShortTblName + '; ' + CHAR (10) ;
        SET @MySQl = @MySQl + '            ' + CHAR (10) ;
        SET @MySQl = @MySQl + '           UPDATE T ' + CHAR (10) ;
        SET @MySQl = @MySQl + '           SET T.TrackerName = REPLACE (T.TrackerName , ''FACT_'' , '''') ' + CHAR (10) ;
        SET @MySQl = @MySQl + '           FROM ' + @TblName + ' T ' + CHAR (10) ;
        SET @MySQl = @MySQl + '           JOIN inserted I ' + CHAR (10) ;
        SET @MySQl = @MySQl + '           ON T.SurrogateKey_' + @ShortTblName + ' = I.SurrogateKey_' + @ShortTblName + '; ' + CHAR (10) ;
        SET @MySQl = @MySQl + '      END;  ' + CHAR (10) ;
        EXEC (@MySql) ;
        --PRINT @MySql;

	    IF EXISTS (SELECT *
                     FROM sys.objects
                     WHERE type = 'TR'
                       AND name = @TriggerName) 
            BEGIN
                print 'SUCCESSFULLY Generated Trigger: ' + @TriggerName;
			 set @MySQl = 'Update ' + @TblName + ' SET TrackerName = REPLACE (TrackerName , ''BASE_'' , '''') where TrackerName like ''BASE%'' '
			 print @MySql;
			 exec (@MySql) ;
			 
			 set @MySQl = 'Update ' + @TblName + ' SET TrackerName = REPLACE (TrackerName , ''FACT_'' , '''')  where TrackerName like ''FACT%'''
			 print @MySql;
			 exec (@MySql) ;
			 
            END;
        SET @TriggerName = 'TRIG_TNAME_UPDT_' + @TblName;
        IF EXISTS (SELECT *
                     FROM sys.objects
                     WHERE type = 'TR'
                       AND name = @TriggerName) 
            BEGIN
                print 'SUCCESSFULLY Generated Trigger: ' + @TriggerName;
            END;
		  print '--*********************************************'
        FETCH NEXT FROM CursorTrigger INTO @TblName;
    END;
NOMORE:
CLOSE CursorTrigger;
DEALLOCATE CursorTrigger; 

set nocount off ;
end 

go
print 'Executed create_Trigger__ON_TrackerName' 
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--------------------------------------------------------------- 
-- PROCESSING SCRIPT FILE: FindAndCorrectAllTrackerNamesInTrackerTables.sql \n 
--------------------------------------------------------------- 


/*

  SELECT 'If not exists (select column_name from information_Schema.columns where table_name = ''' + T.Table_name + ''' and column_name = ''TrackerName'')'
	+char(10) + 'Alter Table ' + T.table_name 
    +char(10) + 'ADD TrackerName nvarchar(100) default ''' + replace(substring(t.table_name, 6,9999), '_DEL','')  + ''';'
    +char(10) +'GO'
	+char(10) +'Print ''Processing ' + substring(t.table_name, 6,9999) + ''''
	+char(10) +'GO'
    +char(10) + 'Update ' + T.table_name + ' set TrackerName = ''' + replace(substring(t.table_name, 6,9999), '_DEL','') + ''' Where TrackerName is null'
	+char(10) + '   OR TrackerName != ''' + replace(substring(t.table_name, 6,9999), '_DEL','') + ''''
    +char(10) +'GO'+Char(10) 
    FROM INFORMATION_SCHEMA.TABLES t 
    LEFT JOIN INFORMATION_SCHEMA.COLUMNS c
    ON c.tABLE_NAME = t.TABLE_NAME 
    AND c.COLUMN_NAME = 'TrackerName'
    WHERE t.TABLE_NAME LIKE '%TRACKER%' 
    AND t.TABLE_NAME LIKE 'BASE_%' 
    AND t.TABLE_NAME not LIKE '%_NONULLS' 
    AND t.TABLE_NAME not LIKE '%_CtVerHist' 
    AND t.TABLE_NAME not LIKE '%_TestData' 
    AND t.TABLE_NAME not LIKE '%_VIEW_%' 
    AND t.TABLE_NAME not LIKE '%_LKP_%'     
	--AND t.TABLE_NAME not LIKE '%_join_%'     
--and C.Column_name is null
order by T.Table_Name

*/

Print 'Processing FACT_TrackerData BASE_ correction'
go
if (select count(*) from FACT_TrackerData where TrackerName like 'BASE_%') > 0 
    update FACT_TrackerData set TrackerName = replace(TrackerName,'BASE_','') where TrackerName like 'BASE_%'
go
Print 'Processing FACT_TrackerData _DEL correction'
go
if (select count(*) from FACT_TrackerData where TrackerName like '%_DEL') > 0 
    update FACT_TrackerData set TrackerName = replace(TrackerName,'_DEL','') where TrackerName like '%_DEL'

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping' and column_name = 'TrackerName')
Alter Table BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping
ADD TrackerName nvarchar(100) default 'HFit_HealthAssessmentCodeNamesToTrackerMapping';
GO
Print 'Processing HFit_HealthAssessmentCodeNamesToTrackerMapping'
GO
Update BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping set TrackerName = 'HFit_HealthAssessmentCodeNamesToTrackerMapping' Where TrackerName is null
   OR TrackerName != 'HFit_HealthAssessmentCodeNamesToTrackerMapping'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping_DEL
ADD TrackerName nvarchar(100) default 'HFit_HealthAssessmentCodeNamesToTrackerMapping';
GO
Print 'Processing HFit_HealthAssessmentCodeNamesToTrackerMapping_DEL'
GO
Update BASE_HFit_HealthAssessmentCodeNamesToTrackerMapping_DEL set TrackerName = 'HFit_HealthAssessmentCodeNamesToTrackerMapping' Where TrackerName is null
   OR TrackerName != 'HFit_HealthAssessmentCodeNamesToTrackerMapping'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_Join_ClinicalSourceTracker' and column_name = 'TrackerName')
Alter Table BASE_HFit_Join_ClinicalSourceTracker
ADD TrackerName nvarchar(100) default 'HFit_Join_ClinicalSourceTracker';
GO
Print 'Processing HFit_Join_ClinicalSourceTracker'
GO
Update BASE_HFit_Join_ClinicalSourceTracker set TrackerName = 'HFit_Join_ClinicalSourceTracker' Where TrackerName is null
   OR TrackerName != 'HFit_Join_ClinicalSourceTracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_Join_ClinicalSourceTracker_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_Join_ClinicalSourceTracker_DEL
ADD TrackerName nvarchar(100) default 'HFit_Join_ClinicalSourceTracker';
GO
Print 'Processing HFit_Join_ClinicalSourceTracker_DEL'
GO
Update BASE_HFit_Join_ClinicalSourceTracker_DEL set TrackerName = 'HFit_Join_ClinicalSourceTracker' Where TrackerName is null
   OR TrackerName != 'HFit_Join_ClinicalSourceTracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_join_ClinicalTrackers' and column_name = 'TrackerName')
Alter Table BASE_HFit_join_ClinicalTrackers
ADD TrackerName nvarchar(100) default 'HFit_join_ClinicalTrackers';
GO
Print 'Processing HFit_join_ClinicalTrackers'
GO
Update BASE_HFit_join_ClinicalTrackers set TrackerName = 'HFit_join_ClinicalTrackers' Where TrackerName is null
   OR TrackerName != 'HFit_join_ClinicalTrackers'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_join_ClinicalTrackers_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_join_ClinicalTrackers_DEL
ADD TrackerName nvarchar(100) default 'HFit_join_ClinicalTrackers';
GO
Print 'Processing HFit_join_ClinicalTrackers_DEL'
GO
Update BASE_HFit_join_ClinicalTrackers_DEL set TrackerName = 'HFit_join_ClinicalTrackers' Where TrackerName is null
   OR TrackerName != 'HFit_join_ClinicalTrackers'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_Ref_RewardTrackerValidation' and column_name = 'TrackerName')
Alter Table BASE_HFit_Ref_RewardTrackerValidation
ADD TrackerName nvarchar(100) default 'HFit_Ref_RewardTrackerValidation';
GO
Print 'Processing HFit_Ref_RewardTrackerValidation'
GO
Update BASE_HFit_Ref_RewardTrackerValidation set TrackerName = 'HFit_Ref_RewardTrackerValidation' Where TrackerName is null
   OR TrackerName != 'HFit_Ref_RewardTrackerValidation'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_Ref_RewardTrackerValidation_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_Ref_RewardTrackerValidation_DEL
ADD TrackerName nvarchar(100) default 'HFit_Ref_RewardTrackerValidation';
GO
Print 'Processing HFit_Ref_RewardTrackerValidation_DEL'
GO
Update BASE_HFit_Ref_RewardTrackerValidation_DEL set TrackerName = 'HFit_Ref_RewardTrackerValidation' Where TrackerName is null
   OR TrackerName != 'HFit_Ref_RewardTrackerValidation'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFIT_Tracker' and column_name = 'TrackerName')
Alter Table BASE_HFIT_Tracker
ADD TrackerName nvarchar(100) default 'HFIT_Tracker';
GO
Print 'Processing HFIT_Tracker'
GO
Update BASE_HFIT_Tracker set TrackerName = 'HFIT_Tracker' Where TrackerName is null
   OR TrackerName != 'HFIT_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFIT_Tracker_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFIT_Tracker_DEL
ADD TrackerName nvarchar(100) default 'HFIT_Tracker';
GO
Print 'Processing HFIT_Tracker_DEL'
GO
Update BASE_HFIT_Tracker_DEL set TrackerName = 'HFIT_Tracker' Where TrackerName is null
   OR TrackerName != 'HFIT_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBloodPressure' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBloodPressure
ADD TrackerName nvarchar(100) default 'HFit_TrackerBloodPressure';
GO
Print 'Processing HFit_TrackerBloodPressure'
GO
Update BASE_HFit_TrackerBloodPressure set TrackerName = 'HFit_TrackerBloodPressure' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBloodPressure'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBloodPressure_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBloodPressure_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerBloodPressure';
GO
Print 'Processing HFit_TrackerBloodPressure_DEL'
GO
Update BASE_HFit_TrackerBloodPressure_DEL set TrackerName = 'HFit_TrackerBloodPressure' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBloodPressure'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBloodSugarAndGlucose' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBloodSugarAndGlucose
ADD TrackerName nvarchar(100) default 'HFit_TrackerBloodSugarAndGlucose';
GO
Print 'Processing HFit_TrackerBloodSugarAndGlucose'
GO
Update BASE_HFit_TrackerBloodSugarAndGlucose set TrackerName = 'HFit_TrackerBloodSugarAndGlucose' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBloodSugarAndGlucose'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBloodSugarAndGlucose_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBloodSugarAndGlucose_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerBloodSugarAndGlucose';
GO
Print 'Processing HFit_TrackerBloodSugarAndGlucose_DEL'
GO
Update BASE_HFit_TrackerBloodSugarAndGlucose_DEL set TrackerName = 'HFit_TrackerBloodSugarAndGlucose' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBloodSugarAndGlucose'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBMI' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBMI
ADD TrackerName nvarchar(100) default 'HFit_TrackerBMI';
GO
Print 'Processing HFit_TrackerBMI'
GO
Update BASE_HFit_TrackerBMI set TrackerName = 'HFit_TrackerBMI' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBMI'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBMI_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBMI_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerBMI';
GO
Print 'Processing HFit_TrackerBMI_DEL'
GO
Update BASE_HFit_TrackerBMI_DEL set TrackerName = 'HFit_TrackerBMI' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBMI'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBodyFat' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBodyFat
ADD TrackerName nvarchar(100) default 'HFit_TrackerBodyFat';
GO
Print 'Processing HFit_TrackerBodyFat'
GO
Update BASE_HFit_TrackerBodyFat set TrackerName = 'HFit_TrackerBodyFat' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBodyFat'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBodyFat_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBodyFat_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerBodyFat';
GO
Print 'Processing HFit_TrackerBodyFat_DEL'
GO
Update BASE_HFit_TrackerBodyFat_DEL set TrackerName = 'HFit_TrackerBodyFat' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBodyFat'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBodyMeasurements' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBodyMeasurements
ADD TrackerName nvarchar(100) default 'HFit_TrackerBodyMeasurements';
GO
Print 'Processing HFit_TrackerBodyMeasurements'
GO
Update BASE_HFit_TrackerBodyMeasurements set TrackerName = 'HFit_TrackerBodyMeasurements' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBodyMeasurements'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerBodyMeasurements_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerBodyMeasurements_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerBodyMeasurements';
GO
Print 'Processing HFit_TrackerBodyMeasurements_DEL'
GO
Update BASE_HFit_TrackerBodyMeasurements_DEL set TrackerName = 'HFit_TrackerBodyMeasurements' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerBodyMeasurements'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCardio' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCardio
ADD TrackerName nvarchar(100) default 'HFit_TrackerCardio';
GO
Print 'Processing HFit_TrackerCardio'
GO
Update BASE_HFit_TrackerCardio set TrackerName = 'HFit_TrackerCardio' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCardio'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCardio_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCardio_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerCardio';
GO
Print 'Processing HFit_TrackerCardio_DEL'
GO
Update BASE_HFit_TrackerCardio_DEL set TrackerName = 'HFit_TrackerCardio' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCardio'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCategory' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCategory
ADD TrackerName nvarchar(100) default 'HFit_TrackerCategory';
GO
Print 'Processing HFit_TrackerCategory'
GO
Update BASE_HFit_TrackerCategory set TrackerName = 'HFit_TrackerCategory' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCategory'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCategory_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCategory_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerCategory';
GO
Print 'Processing HFit_TrackerCategory_DEL'
GO
Update BASE_HFit_TrackerCategory_DEL set TrackerName = 'HFit_TrackerCategory' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCategory'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCholesterol' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCholesterol
ADD TrackerName nvarchar(100) default 'HFit_TrackerCholesterol';
GO
Print 'Processing HFit_TrackerCholesterol'
GO
Update BASE_HFit_TrackerCholesterol set TrackerName = 'HFit_TrackerCholesterol' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCholesterol'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCholesterol_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCholesterol_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerCholesterol';
GO
Print 'Processing HFit_TrackerCholesterol_DEL'
GO
Update BASE_HFit_TrackerCholesterol_DEL set TrackerName = 'HFit_TrackerCholesterol' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCholesterol'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCollectionSource' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCollectionSource
ADD TrackerName nvarchar(100) default 'HFit_TrackerCollectionSource';
GO
Print 'Processing HFit_TrackerCollectionSource'
GO
Update BASE_HFit_TrackerCollectionSource set TrackerName = 'HFit_TrackerCollectionSource' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCollectionSource'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCollectionSource_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCollectionSource_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerCollectionSource';
GO
Print 'Processing HFit_TrackerCollectionSource_DEL'
GO
Update BASE_HFit_TrackerCollectionSource_DEL set TrackerName = 'HFit_TrackerCollectionSource' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCollectionSource'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCotinine' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCotinine
ADD TrackerName nvarchar(100) default 'HFit_TrackerCotinine';
GO
Print 'Processing HFit_TrackerCotinine'
GO
Update BASE_HFit_TrackerCotinine set TrackerName = 'HFit_TrackerCotinine' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCotinine'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerCotinine_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerCotinine_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerCotinine';
GO
Print 'Processing HFit_TrackerCotinine_DEL'
GO
Update BASE_HFit_TrackerCotinine_DEL set TrackerName = 'HFit_TrackerCotinine' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerCotinine'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDailySteps' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDailySteps
ADD TrackerName nvarchar(100) default 'HFit_TrackerDailySteps';
GO
Print 'Processing HFit_TrackerDailySteps'
GO
Update BASE_HFit_TrackerDailySteps set TrackerName = 'HFit_TrackerDailySteps' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDailySteps'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDailySteps_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDailySteps_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerDailySteps';
GO
Print 'Processing HFit_TrackerDailySteps_DEL'
GO
Update BASE_HFit_TrackerDailySteps_DEL set TrackerName = 'HFit_TrackerDailySteps' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDailySteps'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDef_Item' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDef_Item
ADD TrackerName nvarchar(100) default 'HFit_TrackerDef_Item';
GO
Print 'Processing HFit_TrackerDef_Item'
GO
Update BASE_HFit_TrackerDef_Item set TrackerName = 'HFit_TrackerDef_Item' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDef_Item'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDef_Item_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDef_Item_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerDef_Item';
GO
Print 'Processing HFit_TrackerDef_Item_DEL'
GO
Update BASE_HFit_TrackerDef_Item_DEL set TrackerName = 'HFit_TrackerDef_Item' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDef_Item'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDef_Tracker' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDef_Tracker
ADD TrackerName nvarchar(100) default 'HFit_TrackerDef_Tracker';
GO
Print 'Processing HFit_TrackerDef_Tracker'
GO
Update BASE_HFit_TrackerDef_Tracker set TrackerName = 'HFit_TrackerDef_Tracker' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDef_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDef_Tracker_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDef_Tracker_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerDef_Tracker';
GO
Print 'Processing HFit_TrackerDef_Tracker_DEL'
GO
Update BASE_HFit_TrackerDef_Tracker_DEL set TrackerName = 'HFit_TrackerDef_Tracker' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDef_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDocument' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDocument
ADD TrackerName nvarchar(100) default 'HFit_TrackerDocument';
GO
Print 'Processing HFit_TrackerDocument'
GO
Update BASE_HFit_TrackerDocument set TrackerName = 'HFit_TrackerDocument' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDocument'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerDocument_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerDocument_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerDocument';
GO
Print 'Processing HFit_TrackerDocument_DEL'
GO
Update BASE_HFit_TrackerDocument_DEL set TrackerName = 'HFit_TrackerDocument' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerDocument'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerFlexibility' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerFlexibility
ADD TrackerName nvarchar(100) default 'HFit_TrackerFlexibility';
GO
Print 'Processing HFit_TrackerFlexibility'
GO
Update BASE_HFit_TrackerFlexibility set TrackerName = 'HFit_TrackerFlexibility' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerFlexibility'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerFlexibility_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerFlexibility_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerFlexibility';
GO
Print 'Processing HFit_TrackerFlexibility_DEL'
GO
Update BASE_HFit_TrackerFlexibility_DEL set TrackerName = 'HFit_TrackerFlexibility' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerFlexibility'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerFruits' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerFruits
ADD TrackerName nvarchar(100) default 'HFit_TrackerFruits';
GO
Print 'Processing HFit_TrackerFruits'
GO
Update BASE_HFit_TrackerFruits set TrackerName = 'HFit_TrackerFruits' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerFruits'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerFruits_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerFruits_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerFruits';
GO
Print 'Processing HFit_TrackerFruits_DEL'
GO
Update BASE_HFit_TrackerFruits_DEL set TrackerName = 'HFit_TrackerFruits' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerFruits'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHbA1c' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHbA1c
ADD TrackerName nvarchar(100) default 'HFit_TrackerHbA1c';
GO
Print 'Processing HFit_TrackerHbA1c'
GO
Update BASE_HFit_TrackerHbA1c set TrackerName = 'HFit_TrackerHbA1c' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHbA1c'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHbA1c_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHbA1c_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerHbA1c';
GO
Print 'Processing HFit_TrackerHbA1c_DEL'
GO
Update BASE_HFit_TrackerHbA1c_DEL set TrackerName = 'HFit_TrackerHbA1c' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHbA1c'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHeight' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHeight
ADD TrackerName nvarchar(100) default 'HFit_TrackerHeight';
GO
Print 'Processing HFit_TrackerHeight'
GO
Update BASE_HFit_TrackerHeight set TrackerName = 'HFit_TrackerHeight' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHeight'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHeight_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHeight_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerHeight';
GO
Print 'Processing HFit_TrackerHeight_DEL'
GO
Update BASE_HFit_TrackerHeight_DEL set TrackerName = 'HFit_TrackerHeight' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHeight'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHighFatFoods' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHighFatFoods
ADD TrackerName nvarchar(100) default 'HFit_TrackerHighFatFoods';
GO
Print 'Processing HFit_TrackerHighFatFoods'
GO
Update BASE_HFit_TrackerHighFatFoods set TrackerName = 'HFit_TrackerHighFatFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHighFatFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHighFatFoods_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHighFatFoods_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerHighFatFoods';
GO
Print 'Processing HFit_TrackerHighFatFoods_DEL'
GO
Update BASE_HFit_TrackerHighFatFoods_DEL set TrackerName = 'HFit_TrackerHighFatFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHighFatFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHighSodiumFoods' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHighSodiumFoods
ADD TrackerName nvarchar(100) default 'HFit_TrackerHighSodiumFoods';
GO
Print 'Processing HFit_TrackerHighSodiumFoods'
GO
Update BASE_HFit_TrackerHighSodiumFoods set TrackerName = 'HFit_TrackerHighSodiumFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHighSodiumFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerHighSodiumFoods_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerHighSodiumFoods_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerHighSodiumFoods';
GO
Print 'Processing HFit_TrackerHighSodiumFoods_DEL'
GO
Update BASE_HFit_TrackerHighSodiumFoods_DEL set TrackerName = 'HFit_TrackerHighSodiumFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerHighSodiumFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerInstance_Item' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerInstance_Item
ADD TrackerName nvarchar(100) default 'HFit_TrackerInstance_Item';
GO
Print 'Processing HFit_TrackerInstance_Item'
GO
Update BASE_HFit_TrackerInstance_Item set TrackerName = 'HFit_TrackerInstance_Item' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerInstance_Item'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerInstance_Item_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerInstance_Item_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerInstance_Item';
GO
Print 'Processing HFit_TrackerInstance_Item_DEL'
GO
Update BASE_HFit_TrackerInstance_Item_DEL set TrackerName = 'HFit_TrackerInstance_Item' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerInstance_Item'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerInstance_Tracker' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerInstance_Tracker
ADD TrackerName nvarchar(100) default 'HFit_TrackerInstance_Tracker';
GO
Print 'Processing HFit_TrackerInstance_Tracker'
GO
Update BASE_HFit_TrackerInstance_Tracker set TrackerName = 'HFit_TrackerInstance_Tracker' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerInstance_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerInstance_Tracker_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerInstance_Tracker_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerInstance_Tracker';
GO
Print 'Processing HFit_TrackerInstance_Tracker_DEL'
GO
Update BASE_HFit_TrackerInstance_Tracker_DEL set TrackerName = 'HFit_TrackerInstance_Tracker' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerInstance_Tracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerMealPortions' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerMealPortions
ADD TrackerName nvarchar(100) default 'HFit_TrackerMealPortions';
GO
Print 'Processing HFit_TrackerMealPortions'
GO
Update BASE_HFit_TrackerMealPortions set TrackerName = 'HFit_TrackerMealPortions' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerMealPortions'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerMealPortions_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerMealPortions_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerMealPortions';
GO
Print 'Processing HFit_TrackerMealPortions_DEL'
GO
Update BASE_HFit_TrackerMealPortions_DEL set TrackerName = 'HFit_TrackerMealPortions' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerMealPortions'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerMedicalCarePlan' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerMedicalCarePlan
ADD TrackerName nvarchar(100) default 'HFit_TrackerMedicalCarePlan';
GO
Print 'Processing HFit_TrackerMedicalCarePlan'
GO
Update BASE_HFit_TrackerMedicalCarePlan set TrackerName = 'HFit_TrackerMedicalCarePlan' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerMedicalCarePlan'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerMedicalCarePlan_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerMedicalCarePlan_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerMedicalCarePlan';
GO
Print 'Processing HFit_TrackerMedicalCarePlan_DEL'
GO
Update BASE_HFit_TrackerMedicalCarePlan_DEL set TrackerName = 'HFit_TrackerMedicalCarePlan' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerMedicalCarePlan'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerPreventiveCare' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerPreventiveCare
ADD TrackerName nvarchar(100) default 'HFit_TrackerPreventiveCare';
GO
Print 'Processing HFit_TrackerPreventiveCare'
GO
Update BASE_HFit_TrackerPreventiveCare set TrackerName = 'HFit_TrackerPreventiveCare' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerPreventiveCare'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerPreventiveCare_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerPreventiveCare_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerPreventiveCare';
GO
Print 'Processing HFit_TrackerPreventiveCare_DEL'
GO
Update BASE_HFit_TrackerPreventiveCare_DEL set TrackerName = 'HFit_TrackerPreventiveCare' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerPreventiveCare'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerRegularMeals' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerRegularMeals
ADD TrackerName nvarchar(100) default 'HFit_TrackerRegularMeals';
GO
Print 'Processing HFit_TrackerRegularMeals'
GO
Update BASE_HFit_TrackerRegularMeals set TrackerName = 'HFit_TrackerRegularMeals' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerRegularMeals'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerRegularMeals_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerRegularMeals_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerRegularMeals';
GO
Print 'Processing HFit_TrackerRegularMeals_DEL'
GO
Update BASE_HFit_TrackerRegularMeals_DEL set TrackerName = 'HFit_TrackerRegularMeals' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerRegularMeals'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerRestingHeartRate' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerRestingHeartRate
ADD TrackerName nvarchar(100) default 'HFit_TrackerRestingHeartRate';
GO
Print 'Processing HFit_TrackerRestingHeartRate'
GO
Update BASE_HFit_TrackerRestingHeartRate set TrackerName = 'HFit_TrackerRestingHeartRate' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerRestingHeartRate'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerRestingHeartRate_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerRestingHeartRate_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerRestingHeartRate';
GO
Print 'Processing HFit_TrackerRestingHeartRate_DEL'
GO
Update BASE_HFit_TrackerRestingHeartRate_DEL set TrackerName = 'HFit_TrackerRestingHeartRate' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerRestingHeartRate'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerShots' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerShots
ADD TrackerName nvarchar(100) default 'HFit_TrackerShots';
GO
Print 'Processing HFit_TrackerShots'
GO
Update BASE_HFit_TrackerShots set TrackerName = 'HFit_TrackerShots' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerShots'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerShots_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerShots_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerShots';
GO
Print 'Processing HFit_TrackerShots_DEL'
GO
Update BASE_HFit_TrackerShots_DEL set TrackerName = 'HFit_TrackerShots' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerShots'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSitLess' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSitLess
ADD TrackerName nvarchar(100) default 'HFit_TrackerSitLess';
GO
Print 'Processing HFit_TrackerSitLess'
GO
Update BASE_HFit_TrackerSitLess set TrackerName = 'HFit_TrackerSitLess' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSitLess'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSitLess_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSitLess_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerSitLess';
GO
Print 'Processing HFit_TrackerSitLess_DEL'
GO
Update BASE_HFit_TrackerSitLess_DEL set TrackerName = 'HFit_TrackerSitLess' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSitLess'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSleepPlan' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSleepPlan
ADD TrackerName nvarchar(100) default 'HFit_TrackerSleepPlan';
GO
Print 'Processing HFit_TrackerSleepPlan'
GO
Update BASE_HFit_TrackerSleepPlan set TrackerName = 'HFit_TrackerSleepPlan' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSleepPlan'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSleepPlan_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSleepPlan_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerSleepPlan';
GO
Print 'Processing HFit_TrackerSleepPlan_DEL'
GO
Update BASE_HFit_TrackerSleepPlan_DEL set TrackerName = 'HFit_TrackerSleepPlan' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSleepPlan'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStrength' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStrength
ADD TrackerName nvarchar(100) default 'HFit_TrackerStrength';
GO
Print 'Processing HFit_TrackerStrength'
GO
Update BASE_HFit_TrackerStrength set TrackerName = 'HFit_TrackerStrength' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStrength'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStrength_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStrength_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerStrength';
GO
Print 'Processing HFit_TrackerStrength_DEL'
GO
Update BASE_HFit_TrackerStrength_DEL set TrackerName = 'HFit_TrackerStrength' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStrength'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStress' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStress
ADD TrackerName nvarchar(100) default 'HFit_TrackerStress';
GO
Print 'Processing HFit_TrackerStress'
GO
Update BASE_HFit_TrackerStress set TrackerName = 'HFit_TrackerStress' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStress'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStress_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStress_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerStress';
GO
Print 'Processing HFit_TrackerStress_DEL'
GO
Update BASE_HFit_TrackerStress_DEL set TrackerName = 'HFit_TrackerStress' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStress'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStressManagement' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStressManagement
ADD TrackerName nvarchar(100) default 'HFit_TrackerStressManagement';
GO
Print 'Processing HFit_TrackerStressManagement'
GO
Update BASE_HFit_TrackerStressManagement set TrackerName = 'HFit_TrackerStressManagement' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStressManagement'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerStressManagement_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerStressManagement_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerStressManagement';
GO
Print 'Processing HFit_TrackerStressManagement_DEL'
GO
Update BASE_HFit_TrackerStressManagement_DEL set TrackerName = 'HFit_TrackerStressManagement' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerStressManagement'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSugaryDrinks' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSugaryDrinks
ADD TrackerName nvarchar(100) default 'HFit_TrackerSugaryDrinks';
GO
Print 'Processing HFit_TrackerSugaryDrinks'
GO
Update BASE_HFit_TrackerSugaryDrinks set TrackerName = 'HFit_TrackerSugaryDrinks' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSugaryDrinks'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSugaryDrinks_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSugaryDrinks_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerSugaryDrinks';
GO
Print 'Processing HFit_TrackerSugaryDrinks_DEL'
GO
Update BASE_HFit_TrackerSugaryDrinks_DEL set TrackerName = 'HFit_TrackerSugaryDrinks' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSugaryDrinks'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSugaryFoods' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSugaryFoods
ADD TrackerName nvarchar(100) default 'HFit_TrackerSugaryFoods';
GO
Print 'Processing HFit_TrackerSugaryFoods'
GO
Update BASE_HFit_TrackerSugaryFoods set TrackerName = 'HFit_TrackerSugaryFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSugaryFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSugaryFoods_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSugaryFoods_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerSugaryFoods';
GO
Print 'Processing HFit_TrackerSugaryFoods_DEL'
GO
Update BASE_HFit_TrackerSugaryFoods_DEL set TrackerName = 'HFit_TrackerSugaryFoods' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSugaryFoods'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSummary' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSummary
ADD TrackerName nvarchar(100) default 'HFit_TrackerSummary';
GO
Print 'Processing HFit_TrackerSummary'
GO
Update BASE_HFit_TrackerSummary set TrackerName = 'HFit_TrackerSummary' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSummary'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerSummary_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerSummary_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerSummary';
GO
Print 'Processing HFit_TrackerSummary_DEL'
GO
Update BASE_HFit_TrackerSummary_DEL set TrackerName = 'HFit_TrackerSummary' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerSummary'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTests' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTests
ADD TrackerName nvarchar(100) default 'HFit_TrackerTests';
GO
Print 'Processing HFit_TrackerTests'
GO
Update BASE_HFit_TrackerTests set TrackerName = 'HFit_TrackerTests' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTests'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTests_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTests_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerTests';
GO
Print 'Processing HFit_TrackerTests_DEL'
GO
Update BASE_HFit_TrackerTests_DEL set TrackerName = 'HFit_TrackerTests' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTests'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTobaccoAttestation' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTobaccoAttestation
ADD TrackerName nvarchar(100) default 'HFit_TrackerTobaccoAttestation';
GO
Print 'Processing HFit_TrackerTobaccoAttestation'
GO
Update BASE_HFit_TrackerTobaccoAttestation set TrackerName = 'HFit_TrackerTobaccoAttestation' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTobaccoAttestation'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTobaccoAttestation_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTobaccoAttestation_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerTobaccoAttestation';
GO
Print 'Processing HFit_TrackerTobaccoAttestation_DEL'
GO
Update BASE_HFit_TrackerTobaccoAttestation_DEL set TrackerName = 'HFit_TrackerTobaccoAttestation' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTobaccoAttestation'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTobaccoFree' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTobaccoFree
ADD TrackerName nvarchar(100) default 'HFit_TrackerTobaccoFree';
GO
Print 'Processing HFit_TrackerTobaccoFree'
GO
Update BASE_HFit_TrackerTobaccoFree set TrackerName = 'HFit_TrackerTobaccoFree' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTobaccoFree'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerTobaccoFree_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerTobaccoFree_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerTobaccoFree';
GO
Print 'Processing HFit_TrackerTobaccoFree_DEL'
GO
Update BASE_HFit_TrackerTobaccoFree_DEL set TrackerName = 'HFit_TrackerTobaccoFree' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerTobaccoFree'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerVegetables' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerVegetables
ADD TrackerName nvarchar(100) default 'HFit_TrackerVegetables';
GO
Print 'Processing HFit_TrackerVegetables'
GO
Update BASE_HFit_TrackerVegetables set TrackerName = 'HFit_TrackerVegetables' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerVegetables'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerVegetables_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerVegetables_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerVegetables';
GO
Print 'Processing HFit_TrackerVegetables_DEL'
GO
Update BASE_HFit_TrackerVegetables_DEL set TrackerName = 'HFit_TrackerVegetables' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerVegetables'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWater' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWater
ADD TrackerName nvarchar(100) default 'HFit_TrackerWater';
GO
Print 'Processing HFit_TrackerWater'
GO
Update BASE_HFit_TrackerWater set TrackerName = 'HFit_TrackerWater' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWater'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWater_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWater_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerWater';
GO
Print 'Processing HFit_TrackerWater_DEL'
GO
Update BASE_HFit_TrackerWater_DEL set TrackerName = 'HFit_TrackerWater' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWater'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWeight' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWeight
ADD TrackerName nvarchar(100) default 'HFit_TrackerWeight';
GO
Print 'Processing HFit_TrackerWeight'
GO
Update BASE_HFit_TrackerWeight set TrackerName = 'HFit_TrackerWeight' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWeight'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWeight_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWeight_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerWeight';
GO
Print 'Processing HFit_TrackerWeight_DEL'
GO
Update BASE_HFit_TrackerWeight_DEL set TrackerName = 'HFit_TrackerWeight' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWeight'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWholeGrains' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWholeGrains
ADD TrackerName nvarchar(100) default 'HFit_TrackerWholeGrains';
GO
Print 'Processing HFit_TrackerWholeGrains'
GO
Update BASE_HFit_TrackerWholeGrains set TrackerName = 'HFit_TrackerWholeGrains' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWholeGrains'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_TrackerWholeGrains_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_TrackerWholeGrains_DEL
ADD TrackerName nvarchar(100) default 'HFit_TrackerWholeGrains';
GO
Print 'Processing HFit_TrackerWholeGrains_DEL'
GO
Update BASE_HFit_TrackerWholeGrains_DEL set TrackerName = 'HFit_TrackerWholeGrains' Where TrackerName is null
   OR TrackerName != 'HFit_TrackerWholeGrains'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_UserTracker' and column_name = 'TrackerName')
Alter Table BASE_HFit_UserTracker
ADD TrackerName nvarchar(100) default 'HFit_UserTracker';
GO
Print 'Processing HFit_UserTracker'
GO
Update BASE_HFit_UserTracker set TrackerName = 'HFit_UserTracker' Where TrackerName is null
   OR TrackerName != 'HFit_UserTracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_UserTracker_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_UserTracker_DEL
ADD TrackerName nvarchar(100) default 'HFit_UserTracker';
GO
Print 'Processing HFit_UserTracker_DEL'
GO
Update BASE_HFit_UserTracker_DEL set TrackerName = 'HFit_UserTracker' Where TrackerName is null
   OR TrackerName != 'HFit_UserTracker'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_UserTrackerCategory' and column_name = 'TrackerName')
Alter Table BASE_HFit_UserTrackerCategory
ADD TrackerName nvarchar(100) default 'HFit_UserTrackerCategory';
GO
Print 'Processing HFit_UserTrackerCategory'
GO
Update BASE_HFit_UserTrackerCategory set TrackerName = 'HFit_UserTrackerCategory' Where TrackerName is null
   OR TrackerName != 'HFit_UserTrackerCategory'
GO

If not exists (select column_name from information_Schema.columns where table_name = 'BASE_HFit_UserTrackerCategory_DEL' and column_name = 'TrackerName')
Alter Table BASE_HFit_UserTrackerCategory_DEL
ADD TrackerName nvarchar(100) default 'HFit_UserTrackerCategory';
GO
Print 'Processing HFit_UserTrackerCategory_DEL'
GO
Update BASE_HFit_UserTrackerCategory_DEL set TrackerName = 'HFit_UserTrackerCategory' Where TrackerName is null
   OR TrackerName != 'HFit_UserTrackerCategory'
GO
