--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
print 'FROM ckChangeTrackingTurnedON.sql';
print 'Installing Change Tracking';
go


DECLARE @DB AS NVarChar (200) = DB_NAME () ;
DECLARE @DBID AS Int = 0;
DECLARE @s AS NVarChar (2000) = '';

IF NOT EXISTS (SELECT
				  [database_id]
			   FROM [sys].[change_tracking_databases]
			   WHERE [database_id] = DB_ID (@DB)) 
    BEGIN
	   SET @s =
			'ALTER DATABASE ' + @DB + ' SET CHANGE_TRACKING = ON (CHANGE_RETENTION = 5 DAYS, AUTO_CLEANUP = ON) ';
	   EXEC (@s) ;
	   PRINT 'Turned Change Tracking On';
    END;

GO
print 'FROM ckChangeTrackingTurnedON.sql';
print 'Installed Change Tracking';
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing proc_ChangeTracking.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_ChangeTracking') 
    BEGIN
        PRINT 'replacing proc_ChangeTracking';
        DROP PROCEDURE
             proc_ChangeTracking;
    END;
GO

-- exec proc_ChangeTracking @InstanceName = 'KenticoCMS_1', @TblName = 'COM_SKU', @Enable = 1
-- exec proc_ChangeTracking 'KenticoCMS_1', 'CMS_USER', 1
CREATE PROCEDURE proc_ChangeTracking (
     @InstanceName AS nvarchar (100) 
   , @TblName AS nvarchar (100) 
   , @Enable AS bit) 
AS
BEGIN
    --DECLARE @InstanceName AS nvarchar (100) = 'KenticoCMS_2';
    --DECLARE @TblName AS nvarchar (100)  = 'CMS_Class';
    --DECLARE @Enable AS bit = 1;
    DECLARE @S AS nvarchar (2000) = '';
    DECLARE @iCnt AS integer = 0;
    DECLARE @TEMPVAR AS TABLE (
                              iCNT integer) ;
PRINT 'INSIDE proc_ChangeTracking: ' + @InstanceName + ' / ' +  @TblName;
    IF @Enable = 1
        BEGIN

            SET @S = 'SELECT count(*) as iCNT FROM ' + CHAR (10) ;
            SET @S = @S + '    ' + @InstanceName + '.sys.change_tracking_tables ' + CHAR (10) ;
            SET @S = @S + '        JOIN ' + @InstanceName + '.sys.tables ' + CHAR (10) ;
            SET @S = @S + '           ON ' + @InstanceName + '.sys.tables.object_id = ' + @InstanceName + '.sys.change_tracking_tables.object_id ' + CHAR (10) ;
            SET @S = @S + '               JOIN ' + @InstanceName + '.sys.schemas ' + CHAR (10) ;
            SET @S = @S + '			    ON ' + @InstanceName + '.sys.schemas.schema_id = ' + @InstanceName + '.sys.tables.schema_id ' + CHAR (10) ;
            SET @S = @S + '           WHERE ' + @InstanceName + '.sys.tables.name = ''' + @TblName + '''';

            INSERT INTO @TEMPVAR
            EXEC (@S) ;
            SET @iCnt = (SELECT TOP 1
                                iCNT
                                FROM @TEMPVAR);

            IF @iCnt = 0
                BEGIN
                    PRINT 'ENABLING Change Tracking on ' + @InstanceName + '.dbo.' + @TblName;
                    SET @S = 'ALTER TABLE ' + @InstanceName + '.dbo.' + @TblName + ' ENABLE CHANGE_TRACKING WITH (TRACK_COLUMNS_UPDATED = ON) ';
    print @S ;
                    EXEC (@S) ;
                END;
            ELSE
                BEGIN
                    PRINT 'Change Tracking ENABLED for: ' + + @InstanceName + '.dbo.' + @TblName;
                END;
        END;
    IF @Enable = 0
        BEGIN
            SET @S = 'SELECT count(*) as iCNT FROM ' + CHAR (10) ;
            SET @S = @S + '    ' + @InstanceName + '.sys.change_tracking_tables ' + CHAR (10) ;
            SET @S = @S + '        JOIN ' + @InstanceName + '.sys.tables ' + CHAR (10) ;
            SET @S = @S + '           ON ' + @InstanceName + '.sys.tables.object_id = ' + @InstanceName + '.sys.change_tracking_tables.object_id ' + CHAR (10) ;
            SET @S = @S + '               JOIN ' + @InstanceName + '.sys.schemas ' + CHAR (10) ;
            SET @S = @S + '			    ON ' + @InstanceName + '.sys.schemas.schema_id = ' + @InstanceName + '.sys.tables.schema_id ' + CHAR (10) ;
            SET @S = @S + '           WHERE ' + @InstanceName + '.sys.tables.name = ''' + @TblName + '''';

            INSERT INTO @TEMPVAR
            EXEC (@S) ;
            SET @iCnt = (SELECT TOP 1
                                iCNT
                                FROM @TEMPVAR);

            IF @iCnt > 0
                BEGIN
                    PRINT 'DISABLED Change Tracking on ' + @InstanceName + '.dbo.' + @TblName;
                    SET @S = 'ALTER TABLE ' + @InstanceName + '.dbo.' + @TblName + ' DISABLE CHANGE_TRACKING ';
                    EXEC (@S) ;
                END;
            ELSE
                BEGIN
                    PRINT 'Change Tracking is NOT applied to ' + + @InstanceName + '.dbo.' + @TblName + '.';
                END;
        END;
END;

GO
PRINT 'Executed proc_ChangeTracking.sql';
GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'EXECUTING SetCtHA.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EnableChangeTracking') 
    BEGIN
        DROP PROCEDURE
             proc_EnableChangeTracking;
    END;

GO
-- exec proc_EnableChangeTracking 'KenticoCMS_1'
-- exec proc_EnableChangeTracking 'KenticoCMS_2'
-- exec proc_EnableChangeTracking 'KenticoCMS_3'
CREATE PROCEDURE proc_EnableChangeTracking ( @DatabaseName AS nvarchar (100) )
AS
BEGIN
    DECLARE @DB AS nvarchar (100) = DB_NAME () ;
    DECLARE @MySql AS nvarchar (1000) = '';
    --DECLARE @DatabaseName AS nvarchar (2000) = 'KenticoCMS_2';

    IF NOT EXISTS (SELECT
                          database_id
                          FROM sys.change_tracking_databases
                          WHERE database_id = DB_ID (@DatabaseName)) 
        BEGIN
		  PRINT ('ENABLED CHANGE TRACKING ON: ' + @DatabaseName);
            SET @MySql = 'ALTER DATABASE ' + @DatabaseName + ' SET CHANGE_TRACKING = ON (CHANGE_RETENTION = 2 DAYS, AUTO_CLEANUP = ON) ';
            EXEC (@MySql) ;
        END;

    DECLARE @DBID AS int = 0;
    DECLARE @s AS nvarchar (2000) = '';
    
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Class', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Document', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Site', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Tree', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'cms_user', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'cms_usersettings', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'cms_usersite', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'COM_SKU', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_Account', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_CoachingHealthArea', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_CoachingHealthInterest', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HACampaign', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentMatrixQuestion', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentModule', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentMultipleChoiceQuestion', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentRiskArea', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentRiskCategory', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserAnswers', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserModule', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserQuestion', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserQuestionGroupResults', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserRiskArea', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserRiskCategory', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserStarted', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssessment', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssessmentFreeForm', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_EDW_RejectMPI', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardActivity', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardLevelType', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardTrigger', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardType', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_TrackerVendor', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_OutComeMessages', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'hfit_PPTEligibility', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardActivity', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardException', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardGroup', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardLevel', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardProgram', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardsUserActivityDetail', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardsUserLevelDetail', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardTrigger', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardTriggerParameter', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'Hfit_SmallStepResponses', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_ToDoSmallSteps', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFIT_Tracker', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBloodPressure', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBloodSugarAndGlucose', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBMI', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBodyFat', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBodyMeasurements', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCardio', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCholesterol', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCollectionSource', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCotinine', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerDailySteps', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerDef_Tracker', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerFlexibility', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerFruits', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHbA1c', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHeight', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHighFatFoods', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHighSodiumFoods', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerInstance_Tracker', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerMealPortions', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerMedicalCarePlan', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerPreventiveCare', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerRegularMeals', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerRestingHeartRate', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerShots', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSitLess', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSleepPlan', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerStrength', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerStress', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerStressManagement', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSugaryDrinks', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSugaryFoods', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerTests', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerTobaccoAttestation', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerTobaccoFree', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerVegetables', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerWater', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerWeight', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerWholeGrains', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_UserTracker', 1;


    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_HA_Master_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_HA_Master_KenticoCMS_PRD_1', @enabled = 1;
        END;
    PRINT 'Activated Change Tracking for EDW Views and tables';
END;

GO
PRINT 'EXECUTED SetCtHA.sql';

GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing DisableCT_EDW.sql';
GO

if exists (select name from sys.procedures where name = 'proc_DisableChangeTracking')
drop procedure proc_DisableChangeTracking

go
-- exec proc_DisableChangeTracking 'KenticoCMS_1' ;
CREATE PROCEDURE proc_DisableChangeTracking (@DatabaseName as nvarchar(100))
AS
BEGIN
    DECLARE @DB AS nvarchar (100) = @DatabaseName ;
    DECLARE @MySql AS nvarchar (1000) = '';
    DECLARE @DBID AS int = 0;
    DECLARE @s AS nvarchar (2000) = '';

    --declare @DatabaseName as nvarchar(100) = 'KenticoCMS_1' ;
    EXEC proc_ChangeTracking @DatabaseName, 'Hfit_SmallStepResponses', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Class', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Document', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Site', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Tree', 0;
    -- The below tables are used in Audit Tracking and cannot be removed from Change TRacking
    --EXEC proc_ChangeTracking @DatabaseName, 'cms_user', 0;
    --EXEC proc_ChangeTracking @DatabaseName, 'cms_usersettings', 0;
    --EXEC proc_ChangeTracking @DatabaseName, 'cms_usersite', 0;
    --EXEC proc_ChangeTracking @DatabaseName, 'hfit_ppteligibility', 0;    
    EXEC proc_ChangeTracking @DatabaseName, 'COM_SKU', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_Account', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_CoachingHealthArea', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_CoachingHealthInterest', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HACampaign', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentMatrixQuestion', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentModule', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentMultipleChoiceQuestion', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentRiskArea', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentRiskCategory', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserAnswers', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserModule', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserQuestion', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserQuestionGroupResults', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserRiskArea', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserRiskCategory', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserStarted', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssessment', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssessmentFreeForm', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_EDW_RejectMPI', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardActivity', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardLevelType', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardTrigger', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardType', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_TrackerVendor', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_OutComeMessages', 0;    
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardActivity', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardException', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardGroup', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardLevel', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardProgram', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardsUserActivityDetail', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardsUserLevelDetail', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardTrigger', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardTriggerParameter', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_ToDoSmallSteps', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFIT_Tracker', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBloodPressure', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBloodSugarAndGlucose', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBMI', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBodyFat', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBodyMeasurements', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCardio', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCholesterol', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCollectionSource', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCotinine', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCotinine', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerDailySteps', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerDef_Tracker', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerFlexibility', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerFruits', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHbA1c', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHeight', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHighFatFoods', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHighSodiumFoods', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerInstance_Tracker', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerMealPortions', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerMedicalCarePlan', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerPreventiveCare', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerPreventiveCare', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerRegularMeals', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerRestingHeartRate', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerShots', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSitLess', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSleepPlan', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerStrength', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerStress', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerStressManagement', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSugaryDrinks', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSugaryFoods', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerTests', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerTobaccoAttestation', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerTobaccoFree', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerVegetables', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerWater', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerWeight', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerWholeGrains', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_UserTracker', 0;

    IF NOT EXISTS (SELECT
                          database_id
                          FROM sys.change_tracking_databases
                          WHERE database_id = DB_ID (@DB)) 
        BEGIN
            SET @MySql = 'ALTER DATABASE ' + @DB + ' SET CHANGE_TRACKING = OFF ';
            EXEC (@MySql) ;
        END;

    SELECT
           OBJECT_NAME (object_id) AS TABLE_NAME
           FROM sys.change_tracking_tables;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_HA_Master_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_HA_Master_KenticoCMS_PRD_1', @enabled = 0;
        END;

END;

GO
PRINT 'Executed DisableCT_EDW.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;







GO
PRINT 'Creating proc_QuickRowCount.sql';

GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_QuickRowCount' )
    BEGIN
        DROP PROCEDURE
             proc_QuickRowCount
    END;
GO

/*
declare @i as bigint = 0 ;
EXEC @i = proc_QuickRowCount 'Device_RawNotification' ;
print @i ;

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardUserDetail';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

*/

CREATE PROCEDURE proc_QuickRowCount ( @TblName AS nvarchar( 254 ))
AS
BEGIN

    /*********************************************
    Author:	  Dale Miller
    Date:	  02.02.2008
    Copyright:  DMA, Ltd., Chicago, IL
    **********************************************/

    DECLARE
   @i AS bigint = 0;

    SET @i = ( SELECT
                      SUM ( row_count )
                 FROM sys.dm_db_partition_stats
                 WHERE
                      object_id = OBJECT_ID( @TblName )
                  AND (
                      index_id = 0
                   OR index_id = 1));
    if @i is null
	   set @i = 0 ;
    PRINT @i;
    return @i ;
END;

GO
PRINT 'Created proc_QuickRowCount.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go

print 'Executing createOperators.SQL'
go

if not exists (select name FROM MSDB.dbo.sysoperators where name = 'DBA_Email')
begin
EXEC msdb.dbo.sp_add_operator @name=N'DBA_Email', 
		@enabled=1, 
		@weekday_pager_start_time=60000, 
		@weekday_pager_end_time=220000, 
		@saturday_pager_start_time=80000, 
		@saturday_pager_end_time=220000, 
		@sunday_pager_start_time=80000, 
		@sunday_pager_end_time=220000, 
		@pager_days=127, 
		@email_address=N'majorconfigs@hotmail.com', 
		@category_name=N'[Uncategorized]'
end 

if not exists (select name  FROM MSDB.dbo.sysoperators where name = 'DBA_Mail')
begin
EXEC msdb.dbo.sp_add_operator @name=N'DBA_Mail', 
		@enabled=1, 
		@weekday_pager_start_time=60000, 
		@weekday_pager_end_time=220000, 
		@saturday_pager_start_time=80000, 
		@saturday_pager_end_time=220000, 
		@sunday_pager_start_time=80000, 
		@sunday_pager_end_time=220000, 
		@pager_days=127, 
		@email_address=N'majorconfigs@hotmail.com', 
		@category_name=N'[Uncategorized]'
end 

if not exists (select name  FROM MSDB.dbo.sysoperators where name = 'DBA_Notify')
begin
EXEC msdb.dbo.sp_add_operator @name=N'DBA_Notify', 
		@enabled=1, 
		@weekday_pager_start_time=60000, 
		@weekday_pager_end_time=220000, 
		@saturday_pager_start_time=80000, 
		@saturday_pager_end_time=220000, 
		@sunday_pager_start_time=80000, 
		@sunday_pager_end_time=220000, 
		@pager_days=127, 
		@email_address=N'majorconfigs@hotmail.com', 
		@category_name=N'[Uncategorized]'
end 

go
print 'Executed createOperators.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
print 'executing proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI.SQL'
go

if exists (select name from sys.procedures where name = 'proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI')
    drop procedure proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI;

go

-- exec proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI
CREATE PROCEDURE proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI
AS
BEGIN
    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE name = 'HFIT_LKP_EDW_ALLOWED_MPI') 
        BEGIN
            PRINT 'Creating Lookup table HFIT_LKP_EDW_ALLOWED_MPI';
            CREATE TABLE dbo.HFIT_LKP_EDW_ALLOWED_MPI (
                         HFITUSERMPINUMBER bigint NULL
            ) 
            ON [PRIMARY];

            CREATE UNIQUE CLUSTERED INDEX PK_HFIT_LKP_EDW_ALLOWED_MPI ON dbo.HFIT_LKP_EDW_ALLOWED_MPI
            (
            HFITUSERMPINUMBER ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    truncate TABLE HFIT_LKP_EDW_ALLOWED_MPI;

    INSERT INTO HFIT_LKP_EDW_ALLOWED_MPI
    (
           HFITUSERMPINUMBER) 
    SELECT DISTINCT
           HFITUSERMPINUMBER
           FROM CMS_USERSETTINGS AS USERSETTINGS
           WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
                 SELECT
                        HFIT_LKP_EDW_REJECTMPI.REJECTMPICODE
                        FROM DBO.HFIT_LKP_EDW_REJECTMPI) 
             AND HFITUSERMPINUMBER IS NOT NULL
    AND HFITUSERMPINUMBER > 0 ;
END;

go
print 'Executed proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI.SQL'
go--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'EXecuting proc_trace.SQL';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_trace') 
    BEGIN
        DROP PROCEDURE
             proc_trace
    END;

GO

CREATE PROCEDURE proc_trace (
     @Msg nvarchar (500) 
   , @StartTime datetime
   , @EndTime datetime) 
AS
BEGIN

    DECLARE @rettime AS nvarchar (50) = '';
    DECLARE @dt2 datetime = GETDATE () ;

    IF @EndTime IS NOT NULL
        BEGIN
            SET @rettime = 'Duration: ' + (SELECT
                                                  CONVERT (varchar (12) , DATEADD (ms, DATEDIFF (ms, @StartTime, @EndTime) , 0) , 114) );
        END
    ELSE
        BEGIN
            SET @rettime = 'Start: ' + CAST (@StartTime AS nvarchar (50)) ;
        END;

    IF @EndTime IS NOT NULL
        BEGIN
            SET @Msg = CHAR (10) + @Msg + ' - ' + @rettime ;
        END
    ELSE
        BEGIN
            SET @Msg = @Msg + ' - ' + @rettime + CHAR (10) ;
        END;
    PRINT @Msg;
END;

GO
EXEC proc_trace 'Test Message', '2015-08-03 11:30:22.722', '2015-08-03 12:27:24.413';
GO
PRINT 'Ececuted proc_trace.SQL';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*------------------------------------------------------------
DELETE FROM DIM_EDW_HealthAssessment
WHERE
      PkHashCode IN (SELECT TOP 1000
                            PkHashCode
                          FROM DIM_EDW_HealthAssessment) ;

SELECT
       COUNT (*) 
       FROM DIM_EDW_HealthAssessment;
*/
GO

PRINT 'Execute proc_CT_HA_MarkDeletedRecords.sql';

GO

--0.23.2015 03:36:42
--0.24.2015 00:08:42 @ 1,000,000 no CT
--0.24.2015 00:05:16 @ 1,000,000 no CT / no DUPS
--0.24.2015 00:04:56 @ 1,000,000 no CT / no DUPS / TEMP TABLE
-- select count(*) from [@EdwHAHashkeys]
-- exec [proc_CT_HA_MarkDeletedRecords]

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_HA_MarkDeletedRecords') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_MarkDeletedRecords;
    END;

GO
-- exec [proc_CT_HA_MarkDeletedRecords]
CREATE PROCEDURE proc_CT_HA_MarkDeletedRecords
AS
BEGIN

    --************************************************
    --MAKE SURE THE STAGED HASH KEY Table exists
    EXEC proc_Create_STAGED_EDW_PkHashkey_TBL ;
    --************************************************

    DECLARE @st AS datetime = GETDATE () ;
    DECLARE @ET AS datetime = GETDATE () ;
    DECLARE @CT AS datetime = GETDATE () ;

    DECLARE @LatestDbVersionToPull AS bigint = 0;
    SET @LatestDbVersionToPull = CHANGE_TRACKING_CURRENT_VERSION () - 1;

    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START determine if DELETED records present', @CT, NULL;
    --**************************************************************

declare @iChgTypes as int = 0 ; 
declare @NbrOfDetectedChanges as bigint = 0 ; 
    EXEC @iChgTypes = proc_CkHaDataChanged NULL, @NbrOfDetectedChanges OUTPUT;
    PRINT 'iChgType is: ' + CAST (@iChgTypes AS nvarchar (50)) ;
    PRINT 'Total Number Of Changes to process is: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) ;
    --**************************************************************
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END determine if DELETED records present', @CT, @ET;
/*-------------------------------
if @iChgTypes = 
    0 - no changes
    1 - updates only
    2 - deletes only
    3 - deletes and updates
    4 - inserts only
    5 - inserts and updates
    6 - inserts and deletes
    7 - inserts, updates, and deletes
*/
    IF @iChgTypes = 0
    OR @iChgTypes = 1
    OR @iChgTypes = 4
    OR @iChgTypes = 5
        BEGIN
            PRINT 'NO DELETES found.';
		  RETURN 0;
        END;

    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process proc_EDW_Gen_Temp_PkHashKeys', @CT, NULL;
    --****************************************
    exec proc_EDW_Gen_Temp_PkHashKeys ;
    --****************************************
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process proc_EDW_Gen_Temp_PkHashKeys', @CT, @ET;

    --***************************************************************************************************************
    SET @CT = GETDATE () ;    
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - CREATE TABLE VAR', @CT, NULL;
    
    
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - Remove DUPS', @CT, NULL;
    --select * from @HASHKEYS
    DECLARE @ms AS float = DATEDIFF (ms, @st, GETDATE ()) ;
    DECLARE @secs AS float = @ms / 1000;
    DECLARE @mins AS float = @ms / 1000 / 60;
    PRINT '1 - @Secs = ' + CAST (@secs AS nvarchar (50)) ;
    PRINT '1 - @mins = ' + CAST (@mins AS nvarchar (50)) ;

    DECLARE @RemoveDups AS bit = 1;

    IF @RemoveDups = 1
        BEGIN
            WITH CTE (
                 PKHASHCODE
               , HAUSERSTARTED_ITEMID
               , HASHCODE
               , DuplicateCount) 
                AS (
                SELECT
                       PKHASHCODE
                     , HAUSERSTARTED_ITEMID
                     , HASHCODE
                     , ROW_NUMBER () OVER ( PARTITION BY PKHASHCODE
                                                       , HAUSERSTARTED_ITEMID
                                                       , HASHCODE  ORDER BY PKHASHCODE , HAUSERSTARTED_ITEMID , HASHCODE) AS DuplicateCount
                       FROM ##STAGED_EDW_PkHashkey
                ) 
                DELETE
                FROM CTE
                WHERE
                      DuplicateCount > 1;
        END;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process MarkDeletedRecords - Remove DUPS', @CT, @ET;
    --***************************************************************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - Remove NULL RECS', @CT, NULL;

    DELETE FROM DIM_EDW_HealthAssessment
    WHERE
          PKHashCode IS NULL;

    DELETE FROM ##STAGED_EDW_PkHashkey
    WHERE
          PKHashCode IS NULL;

    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process MarkDeletedRecords - Remove NULL RECS', @CT, @ET;
    --***************************************************************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - FIND AND MARK Deleted Recs', @CT, NULL;

    --delete from STAGED_EDW_PkHashkey where RowNbr in (select top 100 RowNbr from STAGED_EDW_PkHashkey)
    DECLARE
    @DELDATE AS  datetime2 ( 7) = GETDATE () ;
    -- select top 100 * from STAGED_EDW_PkHashkey
    --  drop table LKUP_DeletedEdwHAHashkeys
if exists (select name from sys.tables where name = 'LKUP_DeletedEdwHAHashkeys')
    drop table LKUP_DeletedEdwHAHashkeys;

    create table LKUP_DeletedEdwHAHashkeys 
            (
                                    HAUSERSTARTED_ITEMID int  NOT NULL
                                  , USERGUID uniqueidentifier  NOT NULL
                                  , PKHASHCODE nvarchar (100) NOT NULL
                                  --, RowNbr int IDENTITY (1 , 1) 
                                  --             NOT NULL
                                  --  PRIMARY KEY ( PKHASHCODE ASC, HAUSERSTARTED_ITEMID ASC, USERGUID ASC, RowNbr ASC) 
            );

    CREATE CLUSTERED INDEX CI_TEMPEdwHAHashkeys ON dbo.LKUP_DeletedEdwHAHashkeys
	   (
		    HAUSERSTARTED_ITEMID ASC,
		    USERGUID ASC,
		    PKHASHCODE ASC
	   );
    
    -- delete from ##STAGED_EDW_PkHashkey where PKHashCode in (select top 1000 PKHashCode from STAGED_EDW_PkHashkey)
    -- exec proc_CT_HA_MarkDeletedRecords

    --*********************************************************************
    --If a record exists in the Staging Table and not in the temp table
    --Then it has been deleted. Take all the HASH KEYS in the Staging
    --table and remove those HASH KEYS that exists in the TEMP table,
    --and the ones remaining have been deleted from the STAGING table.
    --*********************************************************************
    WITH CTE_DEL (
         HAUserStarted_ItemID
       , UserGUID
       , PKHashCode
    ) 
        AS (
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
               FROM STAGED_EDW_PkHashkey
			WHERE ISNULL (DeletedFlg, 0) = 0
        EXCEPT
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
               FROM ##STAGED_EDW_PkHashkey               
        ) 
        INSERT INTO LKUP_DeletedEdwHAHashkeys
        (
               HAUSERSTARTED_ITEMID
             , USERGUID
             , PKHASHCODE) 
        SELECT
               HAUSERSTARTED_ITEMID
             , USERGUID
             , PKHASHCODE
               FROM CTE_DEL;


    -- select  count(*) from LKUP_DeletedEdwHAHashkeys ;

    UPDATE S
           SET
               S.DeletedFlg = 1
             ,S.ChangeDate = GETDATE () 
             ,S.ChangeType = 'D'
               FROM STAGED_EDW_PkHashkey AS S
                        JOIN
                        LKUP_DeletedEdwHAHashkeys AS C
                            ON
                            C.PKHashCode = S.PKHashCode
                        AND C.HAUSERSTARTED_ITEMID = S.HAUSERSTARTED_ITEMID
                        AND C.UserGUID = S.UserGUID;    

    UPDATE S
           SET
               DeletedFlg = 1
             ,LastModifiedDate = GETDATE () 
             --,ChangeType = 'D'
               FROM DIM_EDW_HealthAssessment AS S
                        JOIN
                        LKUP_DeletedEdwHAHashkeys AS C
                            ON
                            C.PKHashCode = S.PKHashCode
                        AND C.HAUSERSTARTED_ITEMID = S.UserStartedItemID
                        AND C.UserGUID = S.UserGUID;
    
    DECLARE
    @iDels AS int = @@ROWCOUNT;

        UPDATE dbo.CT_VersionTracking
           SET
               CNT_Delete = @iDels
    WHERE
          SVRName = @@SERVERNAME
      AND DBName = DB_NAME () 
      AND TgtView = 'view_EDW_HealthAssesment'
      AND rownbr = (select max(RowNbr) from CT_VersionTracking where TgtView = 'view_EDW_HealthAssesment')

    PRINT 'NUMBER OF ROWS flagged as deleted: ' + CAST (@iDels AS nvarchar (50)) ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process MarkDeletedRecords - FIND AND MARK Deleted Recs', @CT, @ET;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process', @CT, @ET;
    RETURN @iDels;

END;

GO
PRINT 'Executed MarkDeletedRecords.sql';
--select top 1000 * from [@EdwHAHashkeys] order by RowNbr
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_Create_StagingTables_INIT.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Create_StagingTables_INIT') 
    BEGIN
        DROP PROCEDURE
             proc_Create_StagingTables_INIT;
    END;
go
IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'DIM_EDW_HealthAssessment') 
    BEGIN
        DROP table
             DIM_EDW_HealthAssessment;
    END;

GO
SET ANSI_NULLS ON;
GO
SET QUOTED_IDENTIFIER ON;
GO



-- exec proc_Create_StagingTables_INIT
CREATE PROCEDURE proc_Create_StagingTables_INIT
AS
BEGIN
    SET NOCOUNT ON;
    IF NOT EXISTS ( SELECT
                           name
                           FROM sys.tables
                           WHERE name = 'DIM_EDW_HealthAssessment') 
        BEGIN

            SET ANSI_NULLS ON;
            SET QUOTED_IDENTIFIER ON;
            SET ANSI_PADDING ON;

            CREATE TABLE dbo.DIM_EDW_HealthAssessment (
                         USERSTARTEDITEMID int NULL
                       , HEALTHASSESMENTUSERSTARTEDNODEGUID uniqueidentifier NULL
                       , USERID bigint NULL
                       , USERGUID uniqueidentifier NULL
                       , HFITUSERMPINUMBER bigint NULL
                       , SITEGUID uniqueidentifier NULL
                       , ACCOUNTID int NULL
                       , ACCOUNTCD nvarchar (8) NULL
                       , ACCOUNTNAME nvarchar (200) NULL
                       , HASTARTEDDT datetime NULL
                       , HACOMPLETEDDT datetime NULL
                       , USERMODULEITEMID int NULL
                       , USERMODULECODENAME nvarchar (100) NULL
                       , HAMODULENODEGUID uniqueidentifier NULL
                       , CMSNODEGUID uniqueidentifier NULL
                       , HAMODULEVERSIONID int NULL
                       , USERRISKCATEGORYITEMID int NULL
                       , USERRISKCATEGORYCODENAME nvarchar (100) NULL
                       , HARISKCATEGORYNODEGUID uniqueidentifier NULL
                       , HARISKCATEGORYVERSIONID int NULL
                       , USERRISKAREAITEMID int NULL
                       , USERRISKAREACODENAME nvarchar (100) NULL
                       , HARISKAREANODEGUID uniqueidentifier NULL
                       , HARISKAREAVERSIONID int NULL
                       , USERQUESTIONITEMID int NULL
                       , TITLE varchar (max) NULL
                       , HAQUESTIONGUID uniqueidentifier NULL
                       , USERQUESTIONCODENAME nvarchar (100) NULL
                       , HAQUESTIONDOCUMENTID int NULL
                       , HAQUESTIONVERSIONID int NULL
                       , HAQUESTIONNODEGUID uniqueidentifier NULL
                       , USERANSWERITEMID int NULL
                       , HAANSWERNODEGUID uniqueidentifier NULL
                       , HAANSWERVERSIONID int NULL
                       , USERANSWERCODENAME nvarchar (100) NULL
                       , HAANSWERVALUE nvarchar (255) NULL
                       , HAMODULESCORE float NULL
                       , HARISKCATEGORYSCORE float NULL
                       , HARISKAREASCORE float NULL
                       , HAQUESTIONSCORE float NULL
                       , HAANSWERPOINTS int NULL
                       , POINTRESULTS int NULL
                       , UOMCODE nvarchar (10) NULL
                       , HASCORE int NULL
                       , MODULEPREWEIGHTEDSCORE float NULL
                       , RISKCATEGORYPREWEIGHTEDSCORE float NULL
                       , RISKAREAPREWEIGHTEDSCORE float NULL
                       , QUESTIONPREWEIGHTEDSCORE float NULL
                       , QUESTIONGROUPCODENAME nvarchar (100) NULL
                       , ITEMCREATEDWHEN datetime NULL
                       , ITEMMODIFIEDWHEN datetime NULL
                       , ISPROFESSIONALLYCOLLECTED bit NULL
                       , HARISKCATEGORY_ITEMMODIFIEDWHEN datetime NULL
                       , HAUSERRISKAREA_ITEMMODIFIEDWHEN datetime NULL
                       , HAUSERQUESTION_ITEMMODIFIEDWHEN datetime NULL
                       , HAUSERANSWERS_ITEMMODIFIEDWHEN datetime NULL
                       , HAPAPERFLG bit NULL
                       , HATELEPHONICFLG bit NULL
                       , HASTARTEDMODE int NULL
                       , HACOMPLETEDMODE int NULL
                       , DOCUMENTCULTURE_VHCJ nvarchar (10) NULL
                       , DOCUMENTCULTURE_HAQUESTIONSVIEW nvarchar (10) NULL
                       , CAMPAIGNNODEGUID uniqueidentifier NULL
                       , HACAMPAIGNID int NULL
                       , HASHCODE nvarchar (75) NULL
                       , PKHASHCODE nvarchar (75) NULL
                       , CHANGED_FLG int NULL
                       , LASTMODIFIEDDATE datetime NULL
                       , HEALTHASSESSMENTTYPE varchar (9) NULL
                       , HAUSERSTARTED_LASTMODIFIED datetime NULL
                       , CMSUSER_LASTMODIFIED datetime NULL
                       , USERSETTINGS_LASTMODIFIED datetime NULL
                       , USERSITE_LASTMODIFIED datetime NULL
                       , CMSSITE_LASTMODIFIED datetime NULL
                       , ACCT_LASTMODIFIED datetime NULL
                       , HAUSERMODULE_LASTMODIFIED datetime NULL
                       , VHCJ_LASTMODIFIED datetime NULL
                       , VHAJ_LASTMODIFIED datetime NULL
                       , HARISKCATEGORY_LASTMODIFIED datetime NULL
                       , HAUSERRISKAREA_LASTMODIFIED datetime NULL
                       , HAUSERQUESTION_LASTMODIFIED datetime NULL
                       , HAQUESTIONSVIEW_LASTMODIFIED datetime NULL
                       , HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED datetime NULL
                       , HAUSERANSWERS_LASTMODIFIED datetime NULL
                       , HAUSERSTARTED_LastUpdateID int NULL
                       , CMSUSER_LastUpdateID int NULL
                       , USERSETTINGS_LastUpdateID int NULL
                       , USERSITE_LastUpdateID int NULL
                       , CMSSITE_LastUpdateID datetime NULL
                       , ACCT_LastUpdateID datetime NULL
                       , HAUSERMODULE_LastUpdateID int NULL
                       , VHCJ_LastUpdateID int NULL
                       , VHAJ_LastUpdateID int NULL
                       , HARISKCATEGORY_LastUpdateID int NULL
                       , HAUSERRISKAREA_LastUpdateID int NULL
                       , HAUSERQUESTION_LastUpdateID int NULL
                       , HAQUESTIONSVIEW_LastUpdateID int NULL
                       , HAUSERQUESTIONGROUPRESULTS_LastUpdateID int NULL
                       , HAUSERANSWERS_LastUpdateID int NULL
                       , LASTUPDATEID int NULL
                       , DELETEFLG int NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DELETEDFLG int NULL
                       , RowNbr int NULL
                       , TimeZone nvarchar (10) NULL
                       , ConvertedToCentralTime bit NULL
            ) 
            ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_CDT ON dbo.DIM_EDW_HealthAssessment
            (
            ConvertedToCentralTime ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_Dates ON dbo.DIM_EDW_HealthAssessment
            (
            ITEMMODIFIEDWHEN ASC,
            HAUSERSTARTED_LASTMODIFIED ASC,
            CMSUSER_LASTMODIFIED ASC,
            USERSETTINGS_LASTMODIFIED ASC,
            USERSITE_LASTMODIFIED ASC,
            CMSSITE_LASTMODIFIED ASC,
            ACCT_LASTMODIFIED ASC,
            HAUSERMODULE_LASTMODIFIED ASC,
            VHCJ_LASTMODIFIED ASC,
            VHAJ_LASTMODIFIED ASC,
            HARISKCATEGORY_LASTMODIFIED ASC,
            HAUSERRISKAREA_LASTMODIFIED ASC,
            HAUSERQUESTION_LASTMODIFIED ASC,
            HAQUESTIONSVIEW_LASTMODIFIED ASC,
            HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED ASC,
            HAUSERANSWERS_LASTMODIFIED ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE CLUSTERED INDEX PI_EDW_HealthAssessment_NATKEY ON dbo.DIM_EDW_HealthAssessment
            (
            USERSTARTEDITEMID ASC,
            USERGUID ASC,
            PKHASHCODE ASC,
            DeletedFlg
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.indexes
                                  WHERE name = 'DIM_EDW_HealthAssessment') 
                BEGIN
                    CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_DelFLG
                    ON dbo.DIM_EDW_HealthAssessment (LASTMODIFIEDDATE, DELETEDFLG) ;
                END;
        END;
    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'DIM_EDW_CombinedHAViews') 
        BEGIN
            PRINT ' Initalizing DIM_EDW_CombinedHAViews';
            CREATE TABLE dbo.DIM_EDW_CombinedHAViews (
                         USERRISKCATEGORYITEMID int NULL
                       , USERRISKCATEGORYCODENAME nvarchar (100) NOT NULL
                       , HARISKCATEGORYNODEGUID uniqueidentifier NOT NULL
                       , HARISKCATEGORYSCORE float NULL
                       , RISKCATEGORYPREWEIGHTEDSCORE float NULL
                       , HARISKCATEGORY_ITEMMODIFIEDWHEN datetime NULL
                       , HAMODULEITEMID int NULL
                       , USERRISKAREAITEMID int NULL
                       , USERRISKAREACODENAME nvarchar (100) NOT NULL
                       , HARISKAREANODEGUID uniqueidentifier NOT NULL
                       , HARISKAREASCORE float NULL
                       , RISKAREAPREWEIGHTEDSCORE float NULL
                       , HAUSERRISKAREA_ITEMMODIFIEDWHEN datetime NULL
                       , USERQUESTIONITEMID int NULL
                       , HAQUESTIONGUID uniqueidentifier NOT NULL
                       , USERQUESTIONCODENAME nvarchar (100) NOT NULL
                       , HAQUESTIONNODEGUID uniqueidentifier NOT NULL
                       , HAQUESTIONSCORE float NULL
                       , QUESTIONPREWEIGHTEDSCORE float NULL
                       , ISPROFESSIONALLYCOLLECTED bit NOT NULL
                       , HAUSERQUESTION_ITEMMODIFIEDWHEN datetime NULL
                       , TITLE varchar (max) NULL
                       , DOCUMENTCULTURE_HAQUESTIONSVIEW nvarchar (10) NOT NULL
                       , HAQUESTIONSVIEW_LASTMODIFIED datetime NOT NULL
                       , GroupResultsItemID int NULL
                       , POINTRESULTS int NULL
                       , QUESTIONGROUPCODENAME nvarchar (100) NULL
                       , HARISKAREAITEMID int NULL
                       , HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED datetime NULL
                       , USERANSWERITEMID int NULL
                       , HAANSWERNODEGUID uniqueidentifier NOT NULL
                       , USERANSWERCODENAME nvarchar (100) NOT NULL
                       , HAANSWERVALUE nvarchar (255) NULL
                       , HAANSWERPOINTS int NULL
                       , UOMCODE nvarchar (10) NULL
                       , HAQUESTIONITEMID int NOT NULL
                       , ITEMCREATEDWHEN datetime NULL
                       , HAUSERANSWERS_ITEMMODIFIEDWHEN datetime NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
            ) 
            ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];
            CREATE CLUSTERED INDEX PI_EDW_CombinedHAViews ON dbo.DIM_EDW_CombinedHAViews
            (
            USERRISKCATEGORYITEMID ASC,
            USERRISKAREAITEMID ASC,
            HARISKAREANODEGUID ASC,
            USERQUESTIONITEMID ASC,
            HAQUESTIONGUID ASC,
            HAQUESTIONNODEGUID ASC,
            HAANSWERNODEGUID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_CMS_USER') 
        BEGIN
            CREATE TABLE dbo.FACT_EDW_CMS_USER (
                         USERGUID uniqueidentifier NOT NULL
                       , LastModifiedWhen datetime2 (7) NOT NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , USERID int NULL
            ) 
            ON [PRIMARY];
            CREATE UNIQUE CLUSTERED INDEX PI_FACT_EDW_CMS_USER ON dbo.FACT_EDW_CMS_USER
            (
            USERID ASC,
            USERGUID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_CMS_USERSETTINGS') 
        BEGIN
            CREATE TABLE dbo.FACT_EDW_CMS_USERSETTINGS (
                         USERSETTINGSUSERID int NOT NULL
                       , HFITUSERMPINUMBER bigint NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , USERSETTINGSID int NULL
            ) 
            ON [PRIMARY];

            CREATE CLUSTERED INDEX PI_CMS_USER ON dbo.FACT_EDW_CMS_USERSETTINGS
            (
            USERSETTINGSID ASC,
            USERSETTINGSUSERID ASC,
            HFITUSERMPINUMBER ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_CMS_USER_IDS ON dbo.FACT_EDW_CMS_USERSETTINGS
            (
            USERSETTINGSUSERID ASC,
            HFITUSERMPINUMBER ASC
            ) 
            INCLUDE ( 	LASTUPDATEID,
            LASTLOADEDDATE,
            SVR,
            DBNAME,
            DeletedFlg,
            USERSETTINGSID) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_CMS_USERSITE') 
        BEGIN
            CREATE TABLE dbo.FACT_EDW_CMS_USERSITE (
                         USERID int NOT NULL
                       , SITEID int NOT NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , USERSITEID int NULL
            ) 
            ON [PRIMARY];

            CREATE CLUSTERED INDEX PI_EDW_CMS_USERSITE ON dbo.FACT_EDW_CMS_USERSITE
            (
            USERSITEID ASC,
            USERID ASC,
            SITEID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_CMS_USERSITE_UID ON dbo.FACT_EDW_CMS_USERSITE
            (
            USERID ASC
            ) 
            INCLUDE ( 	SITEID,
            LASTUPDATEID,
            LASTLOADEDDATE,
            SVR,
            DBNAME,
            DeletedFlg,
            USERSITEID) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;
    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_HealthAssessmentDefinition') 
        BEGIN
            CREATE TABLE dbo.FACT_EDW_HealthAssessmentDefinition (
                         SiteGUID int NULL
                       , AccountCD int NULL
                       , HANodeID int NOT NULL
                       , HANodeName nvarchar (100) NOT NULL
                       , HADocumentID int NULL
                       , HANodeSiteID int NOT NULL
                       , HADocPubVerID int NULL
                       , ModTitle varchar (max) NULL
                       , IntroText varchar (max) NULL
                       , ModDocGuid uniqueidentifier NOT NULL
                       , ModWeight int NOT NULL
                       , ModIsEnabled bit NOT NULL
                       , ModCodeName nvarchar (100) NOT NULL
                       , ModDocPubVerID int NULL
                       , RCTitle varchar (max) NULL
                       , RCWeight int NOT NULL
                       , RCDocumentGUID uniqueidentifier NOT NULL
                       , RCIsEnabled bit NOT NULL
                       , RCCodeName nvarchar (100) NOT NULL
                       , RCDocPubVerID int NULL
                       , RATytle varchar (max) NULL
                       , RAWeight int NOT NULL
                       , RADocumentGuid uniqueidentifier NOT NULL
                       , RAIsEnabled bit NOT NULL
                       , RACodeName nvarchar (100) NOT NULL
                       , RAScoringStrategyID int NOT NULL
                       , RADocPubVerID int NULL
                       , QuestionType nvarchar (100) NOT NULL
                       , QuesTitle varchar (max) NULL
                       , QuesWeight int NOT NULL
                       , QuesIsRequired bit NOT NULL
                       , QuesDocumentGuid uniqueidentifier NOT NULL
                       , QuesIsEnabled bit NOT NULL
                       , QuesIsVisible nvarchar (max) NULL
                       , QuesIsSTaging bit NOT NULL
                       , QuestionCodeName nvarchar (100) NOT NULL
                       , QuesDocPubVerID int NULL
                       , AnsValue nvarchar (150) NULL
                       , AnsPoints int NULL
                       , AnsDocumentGuid uniqueidentifier NULL
                       , AnsIsEnabled bit NULL
                       , AnsCodeName nvarchar (100) NULL
                       , AnsUOM nvarchar (5) NULL
                       , AnsDocPUbVerID int NULL
                       , ChangeType varchar (1) NOT NULL
                       , DocumentCreatedWhen datetime NULL
                       , DocumentModifiedWhen datetime NULL
                       , CmsTreeNodeGuid uniqueidentifier NOT NULL
                       , HANodeGUID uniqueidentifier NOT NULL
                       , SiteLastModified int NULL
                       , Account_ItemModifiedWhen int NULL
                       , Campaign_DocumentModifiedWhen int NULL
                       , Assessment_DocumentModifiedWhen datetime NULL
                       , Module_DocumentModifiedWhen datetime NULL
                       , RiskCategory_DocumentModifiedWhen datetime NULL
                       , RiskArea_DocumentModifiedWhen datetime NULL
                       , Question_DocumentModifiedWhen datetime NULL
                       , Answer_DocumentModifiedWhen datetime NULL
                       , AllowMultiSelect bit NULL
                       , LocID varchar (5) NOT NULL
                       , CMS_Class_CtID int NULL
                       , CMS_Class_SCV bigint NULL
                       , CMS_Document_CtID int NULL
                       , CMS_Document_SCV bigint NULL
                       , CMS_Site_CtID int NULL
                       , CMS_Site_SCV bigint NULL
                       , CMS_Tree_CtID int NULL
                       , CMS_Tree_SCV bigint NULL
                       , CMS_User_CtID int NULL
                       , CMS_User_SCV bigint NULL
                       , COM_SKU_CtID int NULL
                       , COM_SKU_SCV bigint NULL
                       , HFit_HealthAssesmentMatrixQuestion_CtID int NULL
                       , HFit_HealthAssesmentMatrixQuestion_SCV bigint NULL
                       , HFit_HealthAssesmentModule_CtID int NULL
                       , HFit_HealthAssesmentModule_SCV bigint NULL
                       , HFit_HealthAssesmentMultipleChoiceQuestion_CtID int NULL
                       , HFit_HealthAssesmentMultipleChoiceQuestion_SCV bigint NULL
                       , HFit_HealthAssesmentRiskArea_CtID int NULL
                       , HFit_HealthAssesmentRiskArea_SCV bigint NULL
                       , HFit_HealthAssesmentRiskCategory_CtID int NULL
                       , HFit_HealthAssesmentRiskCategory_SCV bigint NULL
                       , HFit_HealthAssessment_CtID int NULL
                       , HFit_HealthAssessment_SCV bigint NULL
                       , HFit_HealthAssessmentFreeForm_CtID int NULL
                       , HFit_HealthAssessmentFreeForm_SCV bigint NULL
                       , CMS_Class_CHANGE_OPERATION nchar (1) NULL
                       , CMS_Document_CHANGE_OPERATION nchar (1) NULL
                       , CMS_Site_CHANGE_OPERATION nchar (1) NULL
                       , CMS_Tree_CHANGE_OPERATION nchar (1) NULL
                       , CMS_User_CHANGE_OPERATION nchar (1) NULL
                       , COM_SKU_CHANGE_OPERATION nchar (1) NULL
                       , HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION nchar (1) NULL
                       , HFit_HealthAssesmentModule_CHANGE_OPERATION nchar (1) NULL
                       , HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION nchar (1) NULL
                       , HFit_HealthAssesmentRiskArea_CHANGE_OPERATION nchar (1) NULL
                       , HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION nchar (1) NULL
                       , HFit_HealthAssessment_CHANGE_OPERATION nchar (1) NULL
                       , HFit_HealthAssessmentFreeForm_CHANGE_OPERATION nchar (1) NULL
                       , CHANGED_FLG int NULL
                       , CHANGE_TYPE_CODE nchar (1) NULL
                       , LastModifiedDate datetime NULL
                       , RowNbr int NULL
                       , DeletedFlg bit NULL
                       , TimeZone nvarchar (10) NULL
                       , ConvertedToCentralTime bit NULL
            ) 
            ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

            CREATE CLUSTERED INDEX PI_FACT_EDW_HealthAssessmentDefinition ON dbo.FACT_EDW_HealthAssessmentDefinition
            (
            SiteGUID ASC
            , AccountCD ASC
            , HANodeID ASC
            , HADocumentID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_HFIT_HealthAssesmentUserAnswers') 
        BEGIN
            CREATE TABLE dbo.FACT_EDW_HFIT_HealthAssesmentUserAnswers (
                         HAANSWERNODEGUID uniqueidentifier NOT NULL
                       , CODENAME nvarchar (100) NOT NULL
                       , HAANSWERVALUE nvarchar (255) NULL
                       , HAANSWERPOINTS int NULL
                       , UOMCODE nvarchar (10) NULL
                       , ITEMCREATEDWHEN datetime2 (7) NULL
                       , ITEMMODIFIEDWHEN datetime2 (7) NULL
                       , HAQUESTIONITEMID int NOT NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , ITEMID int NULL
            ) 
            ON [PRIMARY];
            --drop index PI_HFIT_HealthAssesmentUserAnswers ON dbo.FACT_EDW_HFIT_HealthAssesmentUserAnswers
            CREATE CLUSTERED INDEX PI_HFIT_HealthAssesmentUserAnswers ON dbo.FACT_EDW_HFIT_HealthAssesmentUserAnswers
            (
            ITEMID ASC,
            HAQUESTIONITEMID ASC,
            HAANSWERNODEGUID ASC,
            CODENAME ASC,
            HAANSWERVALUE ASC,
            HAANSWERPOINTS ASC,
            UOMCODE ASC,
            ITEMCREATEDWHEN ASC,
            ITEMMODIFIEDWHEN ASC,
            LASTUPDATEID, LASTLOADEDDATE
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_HFIT_HealthAssesmentUserAnswers_HAQUESTIONITEMID ON dbo.FACT_EDW_HFIT_HealthAssesmentUserAnswers
            (
            HAQUESTIONITEMID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_HFIT_HealthAssesmentUserAnswers_LASTUPDATEID ON dbo.FACT_EDW_HFIT_HealthAssesmentUserAnswers
            (
            ITEMID ASC,
            LASTUPDATEID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_HFIT_HEALTHASSESMENTUSERMODULE') 
        BEGIN
            CREATE TABLE dbo.FACT_EDW_HFIT_HEALTHASSESMENTUSERMODULE (
                         HASTARTEDITEMID int NOT NULL
                       , CODENAME nvarchar (100) NOT NULL
                       , HAMODULENODEGUID uniqueidentifier NOT NULL
                       , HAMODULESCORE float NOT NULL
                       , PREWEIGHTEDSCORE float NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , ITEMID int NULL
            ) 
            ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_HFIT_HEALTHASSESMENTUSERMODULE ON dbo.FACT_EDW_HFIT_HEALTHASSESMENTUSERMODULE
            (
            ITEMID ASC,
            HASTARTEDITEMID ASC
            ) 
            INCLUDE ( 	CODENAME,
            HAMODULENODEGUID,
            HAMODULESCORE,
            PREWEIGHTEDSCORE) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_HFIT_HEALTHASSESMENTUSERMODULE_HASITEMID ON dbo.FACT_EDW_HFIT_HEALTHASSESMENTUSERMODULE
            (
            HASTARTEDITEMID ASC
            ) 
            INCLUDE ( 	CODENAME,
            HAMODULENODEGUID,
            HAMODULESCORE,
            PREWEIGHTEDSCORE,
            LASTUPDATEID,
            LASTLOADEDDATE,
            SVR,
            DBNAME,
            DeletedFlg,
            ITEMID) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_HFit_HealthAssesmentUserQuestion') 
        BEGIN
            CREATE TABLE dbo.FACT_EDW_HFit_HealthAssesmentUserQuestion (
                         HAQUESTIONNODEGUID uniqueidentifier NOT NULL
                       , CODENAME nvarchar (100) NOT NULL
                       , HAQUESTIONSCORE float NULL
                       , PREWEIGHTEDSCORE float NULL
                       , ISPROFESSIONALLYCOLLECTED bit NOT NULL
                       , ITEMMODIFIEDWHEN datetime2 (7) NULL
                       , HARISKAREAITEMID int NOT NULL
                       , HFIT_HEALTHASSESMENTUSERQUESTION_CTID int NULL
                       , HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION nchar (1) NULL
                       , CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV bigint NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , ITEMID int NULL
            ) 
            ON [PRIMARY];

            CREATE CLUSTERED INDEX PI_HFit_HealthAssesmentUserQuestion ON dbo.FACT_EDW_HFit_HealthAssesmentUserQuestion
            (
            ITEMID ASC,
            HARISKAREAITEMID ASC,
            HAQUESTIONNODEGUID ASC,
            CODENAME ASC,
            HAQUESTIONSCORE ASC,
            PREWEIGHTEDSCORE ASC,
            ISPROFESSIONALLYCOLLECTED,
            ITEMMODIFIEDWHEN ASC,
            LASTUPDATEID ASC,
            LASTLOADEDDATE ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI01_FACT_EDW_HFIT_HEALTHASSESMENTUSERQUESTION ON dbo.FACT_EDW_HFit_HealthAssesmentUserQuestion
            (
            HARISKAREAITEMID ASC
            ) 
            INCLUDE ( 	ITEMID,
            HAQUESTIONNODEGUID,
            CODENAME,
            HAQUESTIONSCORE,
            PREWEIGHTEDSCORE,
            ISPROFESSIONALLYCOLLECTED,
            ITEMMODIFIEDWHEN,
            LASTUPDATEID ,
            LASTLOADEDDATE) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE UNIQUE NONCLUSTERED INDEX UK_FACT_EDW_HFIT_HEALTHASSESMENTUSERQUESTION ON dbo.FACT_EDW_HFit_HealthAssesmentUserQuestion
            (
            ITEMID ASC,
            LASTUPDATEID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_HFit_HealthAssesmentUserQuestionGroupResults') 
        BEGIN
            CREATE TABLE dbo.FACT_EDW_HFit_HealthAssesmentUserQuestionGroupResults (
                         POINTRESULTS int NOT NULL
                       , CODENAME nvarchar (100) NOT NULL
                       , HARISKAREAITEMID int NOT NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , ITEMID int NULL
            ) 
            ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_HealthAssesmentUserQuestionGroupResults ON dbo.FACT_EDW_HFit_HealthAssesmentUserQuestionGroupResults
            (
            ITEMID ASC
            ) 
            INCLUDE ( 	POINTRESULTS,
            CODENAME,
            HARISKAREAITEMID) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_FACT_HAUserQuestionGroupResults ON dbo.FACT_EDW_HFit_HealthAssesmentUserQuestionGroupResults
            (
            HARISKAREAITEMID ASC
            ) 
            INCLUDE ( 	ITEMID,
            POINTRESULTS,
            CODENAME) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_HFit_HealthAssesmentUserRiskArea') 
        BEGIN
            CREATE TABLE dbo.FACT_EDW_HFit_HealthAssesmentUserRiskArea (
                         CODENAME nvarchar (100) NOT NULL
                       , HARISKAREANODEGUID uniqueidentifier NOT NULL
                       , HARISKAREASCORE float NULL
                       , PREWEIGHTEDSCORE float NULL
                       , ITEMMODIFIEDWHEN datetime2 (7) NULL
                       , HARISKCATEGORYITEMID int NOT NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , ITEMID int NULL
            ) 
            ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_HEALTHASSESMENTUSERRISKAREA_Category ON dbo.FACT_EDW_HFit_HealthAssesmentUserRiskArea
            (
            HARISKCATEGORYITEMID ASC
            ) 
            INCLUDE ( 	CODENAME,
            HARISKAREANODEGUID,
            HARISKAREASCORE,
            PREWEIGHTEDSCORE,
            ITEMMODIFIEDWHEN,
            LASTUPDATEID,
            LASTLOADEDDATE,
            SVR,
            DBNAME,
            DeletedFlg,
            ITEMID) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY') 
        BEGIN

            CREATE TABLE dbo.FACT_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY (
                         CODENAME nvarchar (100) NOT NULL
                       , HARISKCATEGORYNODEGUID uniqueidentifier NOT NULL
                       , HARISKCATEGORYSCORE float NULL
                       , PREWEIGHTEDSCORE float NULL
                       , ITEMMODIFIEDWHEN datetime2 (7) NULL
                       , HAMODULEITEMID int NOT NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , ITEMID int NULL
            ) 
            ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_HEALTHASSESMENTUSERRISKCATEGORY ON dbo.FACT_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
            (
            ITEMID ASC,
            HAMODULEITEMID ASC
            ) 
            INCLUDE ( 	CODENAME,
            HARISKCATEGORYNODEGUID,
            HARISKCATEGORYSCORE,
            PREWEIGHTEDSCORE,
            ITEMMODIFIEDWHEN) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_HEALTHASSESMENTUSERRISKCATEGORY_HAMODID ON dbo.FACT_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
            (
            HAMODULEITEMID ASC
            ) 
            INCLUDE ( 	CODENAME,
            HARISKCATEGORYNODEGUID,
            HARISKCATEGORYSCORE,
            PREWEIGHTEDSCORE,
            ITEMMODIFIEDWHEN,
            LASTUPDATEID,
            LASTLOADEDDATE,
            SVR,
            DBNAME,
            DeletedFlg,
            ITEMID) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'FACT_EDW_HFIT_HEALTHASSESMENTUSERSTARTED') 
        BEGIN
            CREATE TABLE dbo.FACT_EDW_HFIT_HEALTHASSESMENTUSERSTARTED (
                         USERID bigint NOT NULL
                       , HASTARTEDDT datetime2 (7) NOT NULL
                       , HACOMPLETEDDT datetime2 (7) NULL
                       , HASCORE int NULL
                       , HAPAPERFLG bit NOT NULL
                       , HATELEPHONICFLG bit NOT NULL
                       , HASTARTEDMODE int NOT NULL
                       , HACOMPLETEDMODE int NOT NULL
                       , HACAMPAIGNNODEGUID uniqueidentifier NOT NULL
                       , HADocumentConfigID int NULL
                       , ItemModifiedWhen datetime2 (7) NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , ITEMID int NULL
            ) 
            ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_HFIT_HEALTHASSESMENTUSERSTARTED ON dbo.FACT_EDW_HFIT_HEALTHASSESMENTUSERSTARTED
            (
            ITEMID ASC,
            USERID ASC
            ) 
            INCLUDE ( 	HASTARTEDDT,
            HACOMPLETEDDT,
            HASCORE,
            HAPAPERFLG,
            HATELEPHONICFLG,
            HASTARTEDMODE,
            HACAMPAIGNNODEGUID,
            HADocumentConfigID) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'DIM_EDW_TEMP_VIEW_EDW_HEALTHASSESMENTQUESTIONS') 
        BEGIN
            CREATE TABLE dbo.DIM_EDW_TEMP_VIEW_EDW_HEALTHASSESMENTQUESTIONS (
                         TITLE varchar (max) NULL
                       , DOCUMENTCULTURE nvarchar (10) NOT NULL
                       , NODEGUID uniqueidentifier NOT NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
            ) 
            ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

            CREATE UNIQUE CLUSTERED INDEX PI_VIEW_EDW_HEALTHASSESMENTQUESTIONS ON dbo.DIM_EDW_TEMP_VIEW_EDW_HEALTHASSESMENTQUESTIONS
            (
            DOCUMENTCULTURE ASC,
            NODEGUID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED') 
        BEGIN
            CREATE TABLE dbo.DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED (
                         DOCUMENTCULTURE nvarchar (10) NOT NULL
                       , HACAMPAIGNID int NOT NULL
                       , NODEGUID uniqueidentifier NOT NULL
                       , NODESITEID int NOT NULL
                       , HEALTHASSESSMENTID int NOT NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
            ) 
            ON [PRIMARY];

            CREATE UNIQUE CLUSTERED INDEX PI_VIEW_HFIT_HACAMPAIGN_JOINED ON dbo.DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED
            (
            DOCUMENTCULTURE ASC,
            HACAMPAIGNID ASC,
            NODEGUID ASC,
            NODESITEID ASC,
            HEALTHASSESSMENTID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_VIEW_HFIT_HACAMPAIGN_JOINED_CULTURE ON dbo.DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED
            (
            NODEGUID ASC,
            DOCUMENTCULTURE ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED') 
        BEGIN
            CREATE TABLE dbo.DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED (
                         NODEGUID uniqueidentifier NOT NULL
                       , DOCUMENTID int NOT NULL
                       , DOCUMENTCULTURE nvarchar (10) NOT NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
            ) 
            ON [PRIMARY];

            CREATE UNIQUE CLUSTERED INDEX PI_VIEW_HFIT_HEALTHASSESSMENT_JOINED ON dbo.DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED
            (
            NODEGUID ASC,
            DOCUMENTID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'DIM_EDW_View_EDW_HealthAssesmentQuestions') 
        BEGIN
            CREATE TABLE dbo.DIM_EDW_View_EDW_HealthAssesmentQuestions (
                         TITLE varchar (max) NULL
                       , DOCUMENTCULTURE nvarchar (10) NOT NULL
                       , LASTUPDATEID int NOT NULL
                       , LASTLOADEDDATE datetime NOT NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DeletedFlg int NOT NULL
                       , NODEGUID uniqueidentifier NULL
            ) 
            ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

            CREATE UNIQUE CLUSTERED INDEX PI_VIEW_EDW_HEALTHASSESMENTQUESTIONS ON dbo.DIM_EDW_View_EDW_HealthAssesmentQuestions
            (
            DOCUMENTCULTURE ASC,
            NODEGUID ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
        END;

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined') 
        BEGIN
            DROP TABLE
                 DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined;
        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE
                          name = 'DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined') 
        BEGIN
            PRINT 'POPULATING DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined';
            SELECT
                   HAUserRiskArea.ITEMID AS UserRiskAreaItemID
                 , HAUserRiskArea.HARISKCATEGORYITEMID
                 , HAUserRiskArea.CODENAME AS USERRISKAREACODENAME
                 , HAUserRiskArea.HARISKAREANODEGUID
                 , NULL AS HARISKAREAVERSIONID
                 , HAUserRiskArea.HARISKAREASCORE
                 , HAUserRiskArea.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
                 , HAUserRiskArea.ITEMMODIFIEDWHEN AS HAUserRiskArea_ITEMMODIFIEDWHEN
                 , HAUserRiskArea.ITEMMODIFIEDWHEN AS HAUserRiskArea_LASTMODIFIED   --HAUserRiskArea.LASTLOADEDDATE 
                 , NULL AS HAUserRiskArea_LastUpdateID   --HAUserRiskArea.LastUpdateID 

                 , HAUserQuestionGroupResults.HARiskAreaItemID
                 , HAUserQuestionGroupResults.ItemID AS HAUserQuestionGroupResultsItemID
                 , HAUserQuestionGroupResults.POINTRESULTS
                 , HAUserQuestionGroupResults.CODENAME AS QUESTIONGROUPCODENAME
                 , HAUserQuestionGroupResults.ITEMMODIFIEDWHEN AS HAUserQuestionGroupResults_LASTMODIFIED	--HAUserQuestionGroupResults.LASTLOADEDDATE 
                 , NULL AS HAUserQuestionGroupResults_LastUpdateID	--HAUserQuestionGroupResults.LastUpdateID 

                 , HAUserRiskArea.ItemModifiedWhen AS LastModifiedWhen
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@SERVERNAME AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
            INTO
                 DIM_EDW_HFIT_HealthAssesmentUserRiskArea_Joined
                   FROM
                       DBO.FACT_HFIT_HealthAssesmentUserRiskArea AS HAUserRiskArea --ON HARISKCATEGORY.ITEMID = HAUserRiskArea.HARISKCATEGORYITEMID
                           LEFT JOIN DBO.FACT_HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS AS HAUserQuestionGroupResults
                               ON HAUserRiskArea.ITEMID = HAUserQuestionGroupResults.HARiskAreaItemID;

            IF NOT EXISTS (SELECT
                                  column_name
                                  FROM information_schema.columns
                                  WHERE table_name = 'DIM_EDW_HFIT_HealthAssesmentUserRiskArea_Joined'
                                    AND column_name = 'HARISKCATEGORYITEMID') 
                BEGIN
                    PRINT 'ADDING HARISKCATEGORYITEMID to DIM_EDW_HFIT_HealthAssesmentUserRiskArea_Joined';
                    ALTER TABLE DIM_EDW_HFIT_HealthAssesmentUserRiskArea_Joined
                    ADD
                                HARISKCATEGORYITEMID int NULL;
                END;

            CREATE CLUSTERED INDEX PI_EDW_HFIT_HealthAssesmentUserRiskArea_Joined ON DIM_EDW_HFIT_HealthAssesmentUserRiskArea_Joined ( UserRiskAreaItemID ASC , HAUserQuestionGroupResultsItemID ASC) ;

            CREATE NONCLUSTERED INDEX CI_EDW_HFIT_HealthAssesmentUserRiskArea_Joined
            ON dbo.DIM_EDW_HFIT_HealthAssesmentUserRiskArea_Joined (HAUserQuestionGroupResultsItemID) 
            INCLUDE (UserRiskAreaItemID, LastUpdateID) ;

        END;

    SET NOCOUNT OFF;
END;
GO
exec proc_Create_StagingTables_INIT ;
PRINT 'Executed proc_Create_StagingTables_INIT';
GO

IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'LKUP_NewEdwHAHashkeys') 
    BEGIN
        PRINT 'Creating LKUP_NewEdwHAHashkeys';
        CREATE TABLE LKUP_NewEdwHAHashkeys
        (
                     HAUSERSTARTED_ITEMID int  NOT NULL
                   , USERGUID uniqueidentifier  NOT NULL
                   , PKHASHCODE nvarchar (100) NOT NULL
                   , HASHCODE nvarchar (100) NOT NULL
        );

        CREATE CLUSTERED INDEX CI_TEMPEdwNewHAHashkeys ON dbo.LKUP_NewEdwHAHashkeys
        (
        PKHASHCODE ASC,
        HAUSERSTARTED_ITEMID ASC,
        HASHCODE ASC,
        USERGUID ASC
        );
    END;

GO
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'LKUP_UpdatedEdwHAHashkeys') 
    BEGIN
        PRINT 'Creating LKUP_UpdatedEdwHAHashkeys';
        CREATE TABLE LKUP_UpdatedEdwHAHashkeys
        (
                     HAUSERSTARTED_ITEMID int  NOT NULL
                   , USERGUID uniqueidentifier  NOT NULL
                   , PKHASHCODE nvarchar (100) NOT NULL
                   , HASHCODE nvarchar (100) NOT NULL
        --, RowNbr int IDENTITY (1 , 1) 
        --             NOT NULL
        --  PRIMARY KEY ( PKHASHCODE ASC, HAUSERSTARTED_ITEMID ASC, USERGUID ASC, RowNbr ASC) 
        );

        CREATE CLUSTERED INDEX CI_TEMPEdwHAHashkeys ON dbo.LKUP_UpdatedEdwHAHashkeys
        (
        HAUSERSTARTED_ITEMID ASC,
        PKHASHCODE ASC,
        HASHCODE ASC,
        USERGUID ASC
        );
    END;
GO
IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'LKUP_DeletedEdwHAHashkeys') 
    BEGIN
        DROP TABLE
             LKUP_DeletedEdwHAHashkeys
    END;
GO
CREATE TABLE LKUP_DeletedEdwHAHashkeys
(
             HAUSERSTARTED_ITEMID int  NOT NULL
           , USERGUID uniqueidentifier  NOT NULL
           , PKHASHCODE nvarchar (100) NOT NULL
--, RowNbr int IDENTITY (1 , 1) 
--             NOT NULL
--  PRIMARY KEY ( PKHASHCODE ASC, HAUSERSTARTED_ITEMID ASC, USERGUID ASC, RowNbr ASC) 
);

CREATE CLUSTERED INDEX CI_TEMPEdwHAHashkeys ON dbo.LKUP_DeletedEdwHAHashkeys
(
HAUSERSTARTED_ITEMID ASC,
USERGUID ASC,
PKHASHCODE ASC
);

GO
PRINT 'RUNNING procedure proc_Create_StagingTables_INIT';
GO

EXEC proc_Create_StagingTables_INIT;

GO

PRINT 'COMPLETED RUNNING procedure proc_Create_StagingTables_INIT.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
Print 'Executing View_EDW_STAGED_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined.SQL'
go

if exists (select name from sys.views where name = 'View_EDW_STAGED_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined')
    drop view View_EDW_STAGED_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined;

go

CREATE VIEW View_EDW_STAGED_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined
AS
select  
	   HAUSERRISKAREA.ITEMID AS USERRISKAREAITEMID
	   ,HAUSERRISKAREA.HARISKCATEGORYITEMID 
	   , HAUSERRISKAREA.CODENAME AS USERRISKAREACODENAME
	   , HAUSERRISKAREA.HARISKAREANODEGUID
	   , NULL AS HARISKAREAVERSIONID
	   , HAUSERRISKAREA.HARISKAREASCORE
	   , HAUSERRISKAREA.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
	   , HAUSERRISKAREA.ITEMMODIFIEDWHEN AS HAUSERRISKAREA_ITEMMODIFIEDWHEN
	   , HAUSERRISKAREA.ItemModifiedWhen AS HAUSERRISKAREA_LASTMODIFIED   --HAUSERRISKAREA.LASTLOADEDDATE 
	   , 0 AS HAUSERRISKAREA_LastUpdateID   --HAUSERRISKAREA.LastUpdateID 

	   , HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
	   , HAUSERQUESTIONGROUPRESULTS.ItemID as HAUSERQUESTIONGROUPRESULTSItemID
	   , HAUSERQUESTIONGROUPRESULTS.POINTRESULTS
	   , HAUSERQUESTIONGROUPRESULTS.CODENAME AS QUESTIONGROUPCODENAME
	   , HAUSERQUESTIONGROUPRESULTS.ItemModifiedWhen AS HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED	--HAUSERQUESTIONGROUPRESULTS.LASTLOADEDDATE 
	   , 0 AS HAUSERQUESTIONGROUPRESULTS_LastUpdateID	--HAUSERQUESTIONGROUPRESULTS.LastUpdateID 

	   , HAUSERRISKAREA.ItemModifiedWhen as  LastModifiedWhen
	   , 0 as LastUpdateID
	   , getdate() as LASTLOADEDDATE
	   , @@SERVERNAME as SVR
	   , DB_NAME() AS DBNAME
	   , 0 as DeletedFlg

--into DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined
from DBO.HFIT_HEALTHASSESMENTUSERRISKAREA AS HAUSERRISKAREA
              --ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
LEFT JOIN DBO.HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS AS HAUSERQUESTIONGROUPRESULTS
              ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID

go
Print 'ExecutED View_EDW_STAGED_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined.SQL'
go

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_EDW_BuildStagingTables.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE
                  name = 'proc_EDW_BuildStagingTables') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_BuildStagingTables;
    END;
GO

/*-------------------------------------
------------------------------
EXEC proc_EDW_BuildStagingTables 12576 
exec proc_EDW_BuildHAHashkeys
*/
CREATE PROCEDURE proc_EDW_BuildStagingTables (
     @ChangeVersionID int = 0) 
AS
BEGIN
    SET NOCOUNT ON;
    IF NOT EXISTS ( SELECT
                           NAME
                           FROM sys.tables
                           WHERE
                           name = 'STAGED_EDW_MASTER_TABLES') 
        BEGIN

/*---------------------------------------------------------------------
----------------------------------------------------------------------
@ChangeVersionID is the CHANGE Version number that is desired to pull.
If not provided, it defaults to 0 which will cause all CT recs to be 
considered.

ADD THE MASTER TABLE SO THAT THIS INITIALIZATION WILL NOT OCCUR AGAIN.
NOTE: TO RELOAD ALL STAGING TABLES, JUST DROP STAGED_EDW_MASTER_TABLES.
*/

            PRINT '**INSIDE Populating Staging Tables: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;

            DECLARE @iInsertedCnt AS bigint = 0;

            PRINT 'Populating STAGED_EDW_MASTER_TABLES';
            SELECT
                   table_name INTO
                                   STAGED_EDW_MASTER_TABLES
                   FROM information_schema.tables
                   WHERE table_name LIKE 'STAGED_EDW%';

            --DROP ANY EXISTING TABLES SO THEY WILL BE REPOPULATED
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_CMS_USER') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;

                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_CMS_USERSETTINGS') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_CMS_USERSITE') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HealthAssessmentDefinition') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFIT_HealthAssesmentUserAnswers') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFit_HealthAssesmentUserQuestion') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFit_HealthAssesmentUserRiskArea') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;
            IF NOT EXISTS (SELECT
                                  name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_EDW_View_EDW_HealthAssesmentQuestions') 
                BEGIN
                    EXEC proc_Create_StagingTables_INIT;
                END;

        END;

    --***************************************************************************
    DECLARE @iCnt AS bigint = 0;

    --***************************************************************************
    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined') 
        BEGIN
            DROP TABLE
                 DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined;
        END;

    SELECT
           HAUserRiskArea.ITEMID AS UserRiskAreaItemID
         , HAUserRiskArea.HARISKCATEGORYITEMID
         , HAUserRiskArea.CODENAME AS USERRISKAREACODENAME
         , HAUserRiskArea.HARISKAREANODEGUID
         , NULL AS HARISKAREAVERSIONID
         , HAUserRiskArea.HARISKAREASCORE
         , HAUserRiskArea.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
         , HAUserRiskArea.ITEMMODIFIEDWHEN AS HAUserRiskArea_ITEMMODIFIEDWHEN
         , HAUserRiskArea.ITEMMODIFIEDWHEN AS HAUserRiskArea_LASTMODIFIED   --HAUserRiskArea.LASTLOADEDDATE 
         , NULL AS HAUserRiskArea_LastUpdateID   --HAUserRiskArea.LastUpdateID 

         , HAUserQuestionGroupResults.HARiskAreaItemID
         , HAUserQuestionGroupResults.ItemID AS HAUserQuestionGroupResultsItemID
         , HAUserQuestionGroupResults.POINTRESULTS
         , HAUserQuestionGroupResults.CODENAME AS QUESTIONGROUPCODENAME
         , HAUserQuestionGroupResults.ITEMMODIFIEDWHEN AS HAUserQuestionGroupResults_LASTMODIFIED	--HAUserQuestionGroupResults.LASTLOADEDDATE 
         , NULL AS HAUserQuestionGroupResults_LastUpdateID	--HAUserQuestionGroupResults.LastUpdateID 

         , HAUserRiskArea.ItemModifiedWhen AS LastModifiedWhen
         , 0 AS LastUpdateID
         , GETDATE () AS LASTLOADEDDATE
         , @@SERVERNAME AS SVR
         , DB_NAME () AS DBNAME
         , 0 AS DeletedFlg
    INTO
         DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined
           FROM
               DBO.HFIT_HealthAssesmentUserRiskArea AS HAUserRiskArea --ON HARISKCATEGORY.ITEMID = HAUserRiskArea.HARISKCATEGORYITEMID
                   LEFT JOIN DBO.HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS AS HAUserQuestionGroupResults
                       ON HAUserRiskArea.ITEMID = HAUserQuestionGroupResults.HARiskAreaItemID;

    IF NOT EXISTS (SELECT
                          column_name
                          FROM information_schema.columns
                          WHERE table_name = 'DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined'
                            AND column_name = 'HARISKCATEGORYITEMID') 
        BEGIN
            PRINT 'ADDING HARISKCATEGORYITEMID to DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined';
            ALTER TABLE DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined
            ADD
                        HARISKCATEGORYITEMID int NULL;
        END;

    CREATE CLUSTERED INDEX PI_EDW_HFit_HealthAssesmentUserRiskArea_Joined ON DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined ( UserRiskAreaItemID ASC , HAUserQuestionGroupResultsItemID ASC) ;

    CREATE NONCLUSTERED INDEX CI_EDW_HFit_HealthAssesmentUserRiskArea_Joined
    ON dbo.DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined (HAUserQuestionGroupResultsItemID) 
    INCLUDE (UserRiskAreaItemID, LastUpdateID) ;

    -- delete from HFit_HealthAssesmentUserRiskArea where ItemID = 6928
    -- DECLARE @ChangeVersionID AS int = 0;
    DELETE FROM DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined
    WHERE
          UserRiskAreaItemID IN ( SELECT
                                         CT_HFit_HealthAssesmentUserRiskArea.ItemID
                                         FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea, @ChangeVersionID) AS CT_HFit_HealthAssesmentUserRiskArea
                                         WHERE
                                         SYS_CHANGE_OPERATION = 'D') ;

    -- select * from CHANGETABLE ( CHANGES HFit_HealthAssesmentUserRiskArea , 0) AS CT_HFit_HealthAssesmentUserRiskArea  
    -- select top 100 * from HFit_HealthAssesmentUserRiskArea
    -- update HFit_HealthAssesmentUserRiskArea set CodeName = 'Fats' where CodeNAme = 'Fats'
    -- DECLARE @ChangeVersionID AS int = 0;
    UPDATE S
           SET
               S.USERRISKAREACODENAME = T.CODENAME
             ,S.HARISKAREANODEGUID = T.HARISKAREANODEGUID
             ,S.HARISKAREASCORE = T.HARISKAREASCORE
             ,S.RISKAREAPREWEIGHTEDSCORE = T.PREWEIGHTEDSCORE
             ,S.HAUserRiskArea_ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
             ,S.HARISKCATEGORYITEMID = T.HARISKCATEGORYITEMID
             ,S.LastUpdateID = CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,SVR = @@Servername
             ,DBNAME = DB_NAME () 
             ,DeletedFlg = 0
               FROM HFit_HealthAssesmentUserRiskArea AS T
                        JOIN DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined AS S
                            ON
                            S.UserRiskAreaItemID = T.ItemID
                        JOIN CHANGETABLE ( CHANGES HFit_HealthAssesmentUserRiskArea , @ChangeVersionID) AS CT_HFit_HealthAssesmentUserRiskArea
                            ON
                            CT_HFit_HealthAssesmentUserRiskArea.ItemID = T.ItemID
                        AND CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION = 'U';

    -- select * from CHANGETABLE ( CHANGES HFit_HealthAssesmentUserQuestionGroupResults , 0) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
    -- select top 100 * from HFit_HealthAssesmentUserQuestionGroupResults
    -- Update HFit_HealthAssesmentUserQuestionGroupResults set CodeNAme = 'MME' where CodeName = 'MME'
    -- DECLARE @ChangeVersionID AS int = 0;
    UPDATE S
           SET
               S.POINTRESULTS = T.POINTRESULTS
             ,S.QUESTIONGROUPCODENAME = T.CODENAME
             ,S.UserRiskAreaItemID = T.HARiskAreaItemID
             ,S.LastUpdateID = CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,SVR = @@Servername
             ,DBNAME = DB_NAME () 
             ,DeletedFlg = 0
               FROM HFit_HealthAssesmentUserQuestionGroupResults AS T
                        JOIN DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined AS S
                            ON
                            S.HAUserQuestionGroupResultsItemID = T.ItemID
                        JOIN CHANGETABLE ( CHANGES HFit_HealthAssesmentUserQuestionGroupResults , @ChangeVersionID) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                            ON
                            CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID = T.ItemID
                        AND CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION = 'U';
    -- alter table DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined add HaRiskAreaItemID int null 
    -- DECLARE @ChangeVersionID AS int = 0;
    WITH CTE_temp (
         UserRiskAreaItemID
       , HaRiskAreaItemID) 
        AS (
        SELECT
               HAUserRiskArea.ITEMID AS UserRiskAreaItemID
             , HAUserQuestionGroupResults.HARiskAreaItemID
               FROM
                   DBO.HFIT_HealthAssesmentUserRiskArea AS HAUserRiskArea
                       LEFT JOIN DBO.HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS AS HAUserQuestionGroupResults
                           ON HAUserRiskArea.ITEMID = HAUserQuestionGroupResults.HaRiskAreaItemID
        EXCEPT
        SELECT
               UserRiskAreaItemID
             , HaRiskAreaItemID
               FROM DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined
        ) 
        INSERT INTO DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined (
               USERRISKAREAITEMID
             , HARISKCATEGORYITEMID
             , USERRISKAREACODENAME
             , HARISKAREANODEGUID
             , HARISKAREAVERSIONID
             , HARISKAREASCORE
             , RISKAREAPREWEIGHTEDSCORE
             , HAUserRiskArea_ITEMMODIFIEDWHEN
             , HAUserRiskArea_LASTMODIFIED
             , HAUserRiskArea_LastUpdateID
             , HAUserQuestionGroupResultsItemID
             , POINTRESULTS
             , QUESTIONGROUPCODENAME
             , HAUserQuestionGroupResults_LASTMODIFIED
             , HAUserQuestionGroupResults_LastUpdateID
             , LastModifiedWhen
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg) 
        SELECT
               T.USERRISKAREAITEMID
             , T.HARISKCATEGORYITEMID
             , T.USERRISKAREACODENAME
             , T.HARISKAREANODEGUID
             , T.HARISKAREAVERSIONID
             , T.HARISKAREASCORE
             , T.RISKAREAPREWEIGHTEDSCORE
             , T.HAUserRiskArea_ITEMMODIFIEDWHEN
             , T.HAUserRiskArea_LASTMODIFIED
             , T.HAUserRiskArea_LastUpdateID
             , T.HAUserQuestionGroupResultsItemID
             , T.POINTRESULTS
             , T.QUESTIONGROUPCODENAME
             , T.HAUserQuestionGroupResults_LASTMODIFIED
             , T.HAUserQuestionGroupResults_LastUpdateID
             , T.LastModifiedWhen
               --, @ChangeVersionID AS LastUpdateID
             , 666 AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@SERVERNAME AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
               FROM
                   View_EDW_STAGED_HFIT_HealthAssesmentUserRiskArea_Joined AS T
                       JOIN CTE_temp AS C
                           ON c.UserRiskAreaItemID = T.UserRiskAreaItemID
                          AND c.HaRiskAreaItemID = T.HaRiskAreaItemID;

    --***************************************************************************
    --***************************************************************************
    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_CMS_USER';
    --Check for the existance of DIM_EDW_CMS_USER
    IF @iCnt = 0
        BEGIN
            PRINT 'Populating DIM_EDW_CMS_USER';
            truncate TABLE DIM_EDW_CMS_USER;
            INSERT INTO DIM_EDW_CMS_USER
            (
                   USERID
                 , USERGUID
                 , LastModifiedWhen
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   CMSUSER.USERID
                 , CMSUSER.USERGUID
                 , CMSUSER.UserLastModified AS LastModifiedWhen
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM CMS_USER AS CMSUSER;

        --CREATE CLUSTERED INDEX PI_EDW_CMS_USER ON DIM_EDW_CMS_USER ( USERID ASC , USERGUID) ;
        END;

    DELETE FROM DIM_EDW_CMS_USER
    WHERE
          Userid IN ( SELECT
                             CT_CMS_User.UserID
                             FROM CHANGETABLE (CHANGES CMS_User, @ChangeVersionID) AS CT_CMS_User
                             WHERE
                             SYS_CHANGE_OPERATION = 'D') ;

    UPDATE S
           SET
               S.LastUpdateID = CT_CMS_User.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,SVR = @@Servername
             ,DBNAME = DB_NAME () 
             ,DeletedFlg = 0
               FROM CMS_USER AS T
                        JOIN DIM_EDW_CMS_USER AS S
                            ON
                            S.UserID = T.UserID
                        JOIN CHANGETABLE ( CHANGES CMS_User , @ChangeVersionID) AS CT_CMS_User
                            ON
                            CT_CMS_User.UserID = T.USERID
                        AND S.UserGUID = T.UserGUID
                        AND CT_CMS_User.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_CMS_User.SYS_CHANGE_OPERATION = 'U';

    WITH CTE_EDW_CMS_USER (
         USERID) 
        AS (
        SELECT
               CT_CMS_User.USERID
               FROM CHANGETABLE (CHANGES CMS_User, @ChangeVersionID) AS CT_CMS_User
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               USERID
               FROM DIM_EDW_CMS_USER
        ) 
        INSERT INTO DIM_EDW_CMS_USER (
               USERID
             , USERGUID
             , LastModifiedWhen
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg) 
        SELECT
               T.USERID
             , T.USERGUID
             , T.UserLastModified AS LastModifiedWhen
             , CT_CMS_User.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
               FROM
                   cms_user AS T
                       JOIN CHANGETABLE (CHANGES CMS_User, @ChangeVersionID) AS CT_CMS_User
                           ON CT_CMS_User.UserID = T.USERID
                          AND CT_CMS_User.SYS_CHANGE_OPERATION = 'I'
                       JOIN CTE_EDW_CMS_USER AS C
                           ON c.userid = CT_CMS_User.userid;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --*************************************************************************
    -- drop table DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED';

    IF @iCnt = 0
        BEGIN
            PRINT 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED';
            INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED
            (
                   ITEMID
                 , USERID
                 , HASTARTEDDT
                 , HACOMPLETEDDT
                 , HASCORE
                 , HAPAPERFLG
                 , HATELEPHONICFLG
                 , HASTARTEDMODE
                 , HACOMPLETEDMODE
                 , HACAMPAIGNNODEGUID
                 , HADocumentConfigID
                 , ItemModifiedWhen
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HAUSERSTARTED.ITEMID
                 , HAUSERSTARTED.USERID
                 , HAUSERSTARTED.HASTARTEDDT
                 , HAUSERSTARTED.HACOMPLETEDDT
                 , HAUSERSTARTED.HASCORE
                 , HAUSERSTARTED.HAPAPERFLG
                 , HAUSERSTARTED.HATELEPHONICFLG
                 , HAUSERSTARTED.HASTARTEDMODE
                 , HAUSERSTARTED.HACOMPLETEDMODE
                 , HAUSERSTARTED.HACAMPAIGNNODEGUID
                 , HAUserStarted.HADocumentConfigID
                 , HAUserStarted.ItemModifiedWhen
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM HFIT_HEALTHASSESMENTUSERSTARTED AS HAUSERSTARTED;
        END;

    DELETE FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED
    WHERE
          ItemID IN ( SELECT
                             CT_CMS_HEALTHASSESMENTUSERSTARTED.ItemID
                             FROM CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERSTARTED, @ChangeVersionID) AS CT_CMS_HEALTHASSESMENTUSERSTARTED
                             WHERE
                             SYS_CHANGE_OPERATION = 'D') ;

    UPDATE S
           SET
               S.HASTARTEDDT = T.HASTARTEDDT
             ,S.HACOMPLETEDDT = T.HACOMPLETEDDT
             ,S.HASCORE = T.HASCORE
             ,S.HAPAPERFLG = T.HAPAPERFLG
             ,S.HATELEPHONICFLG = T.HATELEPHONICFLG
             ,S.HASTARTEDMODE = T.HASTARTEDMODE
             ,S.HACOMPLETEDMODE = T.HACOMPLETEDMODE
             ,S.HACAMPAIGNNODEGUID = T.HACAMPAIGNNODEGUID
             ,S.HADocumentConfigID = T.HADocumentConfigID
             ,S.ItemModifiedWhen = T.ItemModifiedWhen
             ,S.LastUpdateID = CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,S.SVR = @@Servername
             ,S.DBNAME = DB_NAME () 
             ,S.DeletedFlg = 0
               FROM HFIT_HEALTHASSESMENTUSERSTARTED AS T
                        JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED AS S
                            ON
                            S.ItemID = T.ItemID
                        JOIN CHANGETABLE ( CHANGES HFIT_HEALTHASSESMENTUSERSTARTED , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERSTARTED
                            ON
                            CT_HFIT_HEALTHASSESMENTUSERSTARTED.ItemID = T.ItemID
                        AND S.ItemID = T.ItemID
                        AND CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_OPERATION = 'U';

    WITH CTE_HFIT_HEALTHASSESMENTUSERSTARTED (
         ItemID) 
        AS (
        SELECT
               CT_HFIT_HEALTHASSESMENTUSERSTARTED.ItemID
               FROM CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERSTARTED, @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERSTARTED
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               itemid
               FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED
        ) 
        INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED (
               USERID
             , HASTARTEDDT
             , HACOMPLETEDDT
             , HASCORE
             , HAPAPERFLG
             , HATELEPHONICFLG
             , HASTARTEDMODE
             , HACOMPLETEDMODE
             , HACAMPAIGNNODEGUID
             , HADocumentConfigID
             , ItemModifiedWhen
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , ITEMID) 
        SELECT
               T.USERID
             , T.HASTARTEDDT
             , T.HACOMPLETEDDT
             , T.HASCORE
             , T.HAPAPERFLG
             , T.HATELEPHONICFLG
             , T.HASTARTEDMODE
             , T.HACOMPLETEDMODE
             , T.HACAMPAIGNNODEGUID
             , T.HADocumentConfigID
             , T.ItemModifiedWhen
             , 0 AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@SERVERNAME AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
             , T.ITEMID
               FROM
                   HFIT_HEALTHASSESMENTUSERSTARTED AS T
                       JOIN CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERSTARTED, @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERSTARTED
                           ON CT_HFIT_HEALTHASSESMENTUSERSTARTED.ItemID = T.ItemID
                          AND CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_OPERATION = 'I'
                       JOIN CTE_HFIT_HEALTHASSESMENTUSERSTARTED AS C
                           ON C.ItemID = T.ItemID;

    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;
    --***********************************************************************************
/*--------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------
     select top 100 S.LastUpdateID , T.ItemID, * from DIM_EDW_HFIT_HealthAssesmentUserAnswers as S
	   join HFIT_HealthAssesmentUserAnswers as T on T.itemid = S.itemid 
	   join DIM_EDW_HFit_HealthAssesmentUserQuestion as S2 on S2.ItemID = S.ItemID
	   where S.LastUpdateID > 60
	   order by S.LastUpdateID desc
    

    delete from HFIT_HealthAssesmentUserAnswers where ItemID between 131264 and 131268

    select top 100 * from HFIT_HealthAssesmentUserAnswers 
    where ItemID in (SELECT top 100
		  USERANSWERITEMID FROM VIEW_EDW_PULLHADATA_NOCT order by USERANSWERITEMID )

     update HFIT_HealthAssesmentUserAnswers  set codename = lower(codename),itemmodifiedwhen = getdate() where ItemID in (SELECT top 25000
		  USERANSWERITEMID FROM VIEW_EDW_PULLHADATA_NOCT order by USERANSWERITEMID )

     SELECT distinct SYS_CHANGE_VERSION FROM CHANGETABLE ( CHANGES HFIT_HealthAssesmentUserAnswers , NULL) AS CT_HealthAssesmentUserAnswers ORDER BY SYS_CHANGE_VERSION DESC
*/
    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFIT_HealthAssesmentUserAnswers';

    IF @iCnt = 0
        BEGIN

            PRINT 'Populating DIM_EDW_HFIT_HealthAssesmentUserAnswers';

            INSERT INTO DIM_EDW_HFIT_HealthAssesmentUserAnswers (
                   ITEMID
                 , HAANSWERNODEGUID
                 , CODENAME
                 , HAANSWERVALUE
                 , HAANSWERPOINTS
                 , UOMCODE
                 , ITEMCREATEDWHEN
                 , ITEMMODIFIEDWHEN
                 , HAQUESTIONITEMID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HAUSERANSWERS.ITEMID
                 , HAUSERANSWERS.HAANSWERNODEGUID
                 , HAUSERANSWERS.CODENAME
                 , HAUSERANSWERS.HAANSWERVALUE
                 , HAUSERANSWERS.HAANSWERPOINTS
                 , HAUSERANSWERS.UOMCODE
                 , HAUSERANSWERS.ITEMCREATEDWHEN
                 , HAUSERANSWERS.ITEMMODIFIEDWHEN
                 , HAUSERANSWERS.HAQUESTIONITEMID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM HFIT_HealthAssesmentUserAnswers AS HAUSERANSWERS;
        END;

    DELETE FROM DIM_EDW_HFIT_HealthAssesmentUserAnswers
    WHERE
          ItemID IN ( SELECT
                             CT_HealthAssesmentUserAnswers.ItemID
                             FROM CHANGETABLE (CHANGES HFIT_HealthAssesmentUserAnswers, @ChangeVersionID) AS CT_HealthAssesmentUserAnswers
                             WHERE
                             SYS_CHANGE_OPERATION = 'D') ;

    UPDATE S
           SET
               S.HAANSWERNODEGUID = T.HAANSWERNODEGUID
             ,S.CODENAME = T.CODENAME
             ,S.HAANSWERVALUE = T.HAANSWERVALUE
             ,S.HAANSWERPOINTS = T.HAANSWERPOINTS
             ,S.UOMCODE = T.UOMCODE
             ,S.ITEMCREATEDWHEN = T.ITEMCREATEDWHEN
             ,S.ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
             ,S.HAQUESTIONITEMID = T.HAQUESTIONITEMID
             ,S.LastUpdateID = CT_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,SVR = @@Servername
             ,DBNAME = DB_NAME () 
             ,DeletedFlg = 0
               FROM HFIT_HealthAssesmentUserAnswers AS T
                        JOIN DIM_EDW_HFIT_HealthAssesmentUserAnswers AS S
                            ON
                            S.ItemID = T.ItemID
                        JOIN CHANGETABLE ( CHANGES HFIT_HealthAssesmentUserAnswers , @ChangeVersionID) AS CT_HealthAssesmentUserAnswers
                            ON
                            CT_HealthAssesmentUserAnswers.ItemID = T.ItemID
                        AND CT_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION = 'U';

    WITH CTE_temp (
         ItemID) 
        AS (
        SELECT
               CTE_temp.ItemID
               FROM CHANGETABLE (CHANGES HFIT_HealthAssesmentUserAnswers, @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               ItemID
               FROM DIM_EDW_HFIT_HealthAssesmentUserAnswers
        ) 
        INSERT INTO DIM_EDW_HFIT_HealthAssesmentUserAnswers (
               HAANSWERNODEGUID
             , CODENAME
             , HAANSWERVALUE
             , HAANSWERPOINTS
             , UOMCODE
             , ITEMCREATEDWHEN
             , ITEMMODIFIEDWHEN
             , HAQUESTIONITEMID
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , ITEMID) 
        SELECT
               T.HAANSWERNODEGUID
             , T.CODENAME
             , T.HAANSWERVALUE
             , T.HAANSWERPOINTS
             , T.UOMCODE
             , T.ITEMCREATEDWHEN
             , T.ITEMMODIFIEDWHEN
             , T.HAQUESTIONITEMID
             , CT_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
             , T.ITEMID
               FROM
                   HFIT_HealthAssesmentUserAnswers AS T
                       JOIN CHANGETABLE (CHANGES HFIT_HealthAssesmentUserAnswers, @ChangeVersionID) AS CT_HealthAssesmentUserAnswers
                           ON CT_HealthAssesmentUserAnswers.ItemID = T.ItemID
                          AND CT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION = 'I'
                       JOIN CTE_temp AS C
                           ON c.ItemID = CT_HealthAssesmentUserAnswers.ItemID;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    --drop table DIM_EDW_CMS_USERSITE
    --select CT_TEMP.USERSITEID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES CMS_USERSITE , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_CMS_USERSITE
    --select top 100 * from CMS_USERSITE
    --select top 100 * from DIM_EDW_CMS_USERSITE
    --update CMS_USERSITE set UserPreferredCurrencyID = NULL where UserSiteID = 22594   --changes nothing, just enters a rec into CT

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_CMS_USERSITE';

    IF @iCnt = 0
        BEGIN

            PRINT 'Populating DIM_EDW_CMS_USERSITE';
            INSERT INTO DIM_EDW_CMS_USERSITE
            (
                   USERSITEID
                 , USERID
                 , SITEID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   USERSITE.USERSITEID
                 , USERSITE.USERID
                 , USERSITE.SITEID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM CMS_USERSITE AS USERSITE;
        END;
    DELETE FROM DIM_EDW_CMS_USERSITE
    WHERE
          USERSITEID IN ( SELECT
                                 CT_XXX.USERSITEID
                                 FROM CHANGETABLE (CHANGES CMS_USERSITE, @ChangeVersionID) AS CT_XXX
                                 WHERE
                                 SYS_CHANGE_OPERATION = 'D') ;
    UPDATE S
           SET
               S.USERID = T.USERID
             ,S.SITEID = T.SITEID
             ,S.LastUpdateID = CT_CMS_USERSITE.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,S.SVR = @@Servername
             ,S.DBNAME = DB_NAME () 
             ,S.DeletedFlg = 0
               FROM CMS_USERSITE AS T
                        JOIN DIM_EDW_CMS_USERSITE AS S
                            ON
                            S.UserSiteID = T.UserSiteID
                        JOIN CHANGETABLE ( CHANGES CMS_USERSITE , @ChangeVersionID) AS CT_CMS_USERSITE
                            ON
                            CT_CMS_USERSITE.UserSiteID = T.UserSiteID
                        AND CT_CMS_USERSITE.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_CMS_USERSITE.SYS_CHANGE_OPERATION = 'U';
    WITH CTE_temp (
         UserSiteID) 
        AS (
        SELECT
               CTE_temp.UserSiteID
               FROM CHANGETABLE (CHANGES CMS_USERSITE, @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               UserSiteID
               FROM DIM_EDW_CMS_USERSITE
        ) 
        INSERT INTO DIM_EDW_CMS_USERSITE (
               USERID
             , SITEID
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , USERSITEID) 
        SELECT
               T.USERID
             , T.SITEID
             , CT_CMS_USERSITE.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
             , T.USERSITEID
               FROM
                   CMS_USERSITE AS T
                       JOIN CHANGETABLE (CHANGES CMS_USERSITE, @ChangeVersionID) AS CT_CMS_USERSITE
                           ON CT_CMS_USERSITE.UserSiteID = T.UserSiteID
                          AND CT_CMS_USERSITE.SYS_CHANGE_OPERATION = 'I'
                       JOIN CTE_temp AS C
                           ON c.UserSiteID = CT_CMS_USERSITE.UserSiteID;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    --drop table DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE
    --select CT_TEMP.ItemID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERMODULE , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE
    --select top 100 * from HFIT_HEALTHASSESMENTUSERMODULE
    --select top 100 * from DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE
    --update HFIT_HEALTHASSESMENTUSERMODULE set CodeName = 'AboutYou' where itemid = 10257

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE';

    IF @iCnt = 0
        BEGIN

            PRINT 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE';
            INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE
            (
                   HASTARTEDITEMID
                 , ITEMID
                 , CODENAME
                 , HAMODULENODEGUID
                 , HAMODULESCORE
                 , PREWEIGHTEDSCORE
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HAUSERMODULE.HASTARTEDITEMID
                 , HAUSERMODULE.ITEMID
                 , HAUSERMODULE.CODENAME
                 , HAUSERMODULE.HAMODULENODEGUID
                 , HAUSERMODULE.HAMODULESCORE
                 , HAUSERMODULE.PREWEIGHTEDSCORE
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE;
        END;
    DELETE FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE
    WHERE
          ItemID IN ( SELECT
                             CT_HFIT_HEALTHASSESMENTUSERMODULE.ItemID
                             FROM CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERMODULE, @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERMODULE
                             WHERE
                             SYS_CHANGE_OPERATION = 'D') ;
    UPDATE S
           SET
               S.HASTARTEDITEMID = T.HASTARTEDITEMID
             ,S.CODENAME = T.CODENAME
             ,S.HAMODULENODEGUID = T.HAMODULENODEGUID
             ,S.HAMODULESCORE = T.HAMODULESCORE
             ,S.PREWEIGHTEDSCORE = T.PREWEIGHTEDSCORE
             ,S.LastUpdateID = CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,SVR = @@Servername
             ,DBNAME = DB_NAME () 
             ,DeletedFlg = 0
               FROM HFIT_HEALTHASSESMENTUSERMODULE AS T
                        JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE AS S
                            ON
                            S.ItemID = T.ItemID
                        JOIN CHANGETABLE ( CHANGES HFIT_HEALTHASSESMENTUSERMODULE , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERMODULE
                            ON
                            CT_HFIT_HEALTHASSESMENTUSERMODULE.ItemID = T.ItemID
                        AND CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION = 'U';

    WITH CTE_temp (
         ItemID) 
        AS (
        SELECT
               CTE_temp.ItemID
               FROM CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERMODULE, @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               ItemID
               FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE
        ) 
        INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE (
               HASTARTEDITEMID
             , CODENAME
             , HAMODULENODEGUID
             , HAMODULESCORE
             , PREWEIGHTEDSCORE
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , ITEMID) 
        SELECT
               T.HASTARTEDITEMID
             , T.CODENAME
             , T.HAMODULENODEGUID
             , T.HAMODULESCORE
             , T.PREWEIGHTEDSCORE
             , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
             , T.ITEMID
               FROM
                   HFIT_HEALTHASSESMENTUSERMODULE AS T
                       JOIN CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERMODULE, @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERMODULE
                           ON CT_HFIT_HEALTHASSESMENTUSERMODULE.ItemID = T.ItemID
                          AND CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION = 'I'
                       JOIN CTE_temp AS C
                           ON c.ItemID = CT_HFIT_HEALTHASSESMENTUSERMODULE.ItemID;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    --drop table DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
    --select CT_TEMP.ItemID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERRISKCATEGORY , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
    --select top 100 * from HFIT_HEALTHASSESMENTUSERRISKCATEGORY
    --select top 100 * from DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
    --update HFIT_HEALTHASSESMENTUSERRISKCATEGORY set CodeName = 'AboutYou' where itemid = 32919

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY';

    IF @iCnt = 0
        BEGIN
            PRINT 'Populating DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY';
            INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
            (
                   ITEMID
                 , CODENAME
                 , HARISKCATEGORYNODEGUID
                 , HARISKCATEGORYSCORE
                 , PREWEIGHTEDSCORE
                 , ITEMMODIFIEDWHEN
                 , HAMODULEITEMID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HARISKCATEGORY.ITEMID
                 , HARISKCATEGORY.CODENAME
                 , HARISKCATEGORY.HARISKCATEGORYNODEGUID
                 , HARISKCATEGORY.HARISKCATEGORYSCORE
                 , HARISKCATEGORY.PREWEIGHTEDSCORE
                 , HARISKCATEGORY.ITEMMODIFIEDWHEN
                 , HARISKCATEGORY.HAMODULEITEMID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY;
        END;

    DELETE FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
    WHERE
          ItemID IN ( SELECT
                             CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ItemID
                             FROM CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERRISKCATEGORY, @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
                             WHERE
                             SYS_CHANGE_OPERATION = 'D') ;
    UPDATE S
           SET
               S.CODENAME = T.CODENAME
             ,S.HARISKCATEGORYNODEGUID = T.HARISKCATEGORYNODEGUID
             ,S.HARISKCATEGORYSCORE = T.HARISKCATEGORYSCORE
             ,S.PREWEIGHTEDSCORE = T.PREWEIGHTEDSCORE
             ,S.ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
             ,S.HAMODULEITEMID = T.HAMODULEITEMID
             ,S.LastUpdateID = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,SVR = @@Servername
             ,DBNAME = DB_NAME () 
             ,DeletedFlg = 0
               FROM HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS T
                        JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS S
                            ON
                            S.ItemID = T.ItemID
                        JOIN CHANGETABLE ( CHANGES HFIT_HEALTHASSESMENTUSERRISKCATEGORY , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
                            ON
                            CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ItemID = T.ItemID
                        AND CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION = 'U';
    WITH CTE_temp (
         ItemID) 
        AS (
        SELECT
               CTE_temp.ItemID
               FROM CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERRISKCATEGORY, @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               ItemID
               FROM DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
        ) 
        INSERT INTO DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY (
               ITEMID
             , CODENAME
             , HARISKCATEGORYNODEGUID
             , HARISKCATEGORYSCORE
             , PREWEIGHTEDSCORE
             , ITEMMODIFIEDWHEN
             , HAMODULEITEMID
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg) 
        SELECT
               T.ITEMID
             , T.CODENAME
             , T.HARISKCATEGORYNODEGUID
             , T.HARISKCATEGORYSCORE
             , T.PREWEIGHTEDSCORE
             , T.ITEMMODIFIEDWHEN
             , T.HAMODULEITEMID
             , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
               FROM
                   HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS T
                       JOIN CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERRISKCATEGORY, @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
                           ON CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ItemID = T.ItemID
                          AND CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION = 'I'
                       JOIN CTE_temp AS C
                           ON c.ItemID = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ItemID;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    --drop table DIM_EDW_CMS_USERSETTINGS
    --select CT_TEMP.UserSettingID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES CMS_USERSETTINGS , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_CMS_USERSETTINGS
    --select top 100 * from CMS_USERSETTINGS
    --select top 100 * from DIM_EDW_CMS_USERSETTINGS
    --update CMS_USERSETTINGS set UserNickName = 'XXX' where UserSettingsID = 63971
    --update CMS_USERSETTINGS set UserNickName = null where UserSettingsID = 63971

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_CMS_USERSETTINGS';

    IF @iCnt = 0
        BEGIN

            PRINT 'Populating DIM_EDW_CMS_USERSETTINGS';
            INSERT INTO DIM_EDW_CMS_USERSETTINGS
            (
                   USERSETTINGSID
                 , USERSETTINGSUSERID
                 , HFITUSERMPINUMBER
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   USERSETTINGS.USERSETTINGSID
                 , USERSETTINGS.USERSETTINGSUSERID
                 , USERSETTINGS.HFITUSERMPINUMBER
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM CMS_USERSETTINGS AS USERSETTINGS;
        END;
    DELETE FROM DIM_EDW_CMS_USERSETTINGS
    WHERE
          USERSETTINGSID IN ( SELECT
                                     CT_CMS_USERSETTINGS.USERSETTINGSID
                                     FROM CHANGETABLE (CHANGES CMS_USERSETTINGS, @ChangeVersionID) AS CT_CMS_USERSETTINGS
                                     WHERE
                                     SYS_CHANGE_OPERATION = 'D') ;
    UPDATE S
           SET
               S.USERSETTINGSUSERID = T.USERSETTINGSUSERID
             ,S.HFITUSERMPINUMBER = T.HFITUSERMPINUMBER
             ,S.LastUpdateID = CT_CMS_USERSETTINGS.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,SVR = @@Servername
             ,DBNAME = DB_NAME () 
             ,DeletedFlg = 0
               FROM CMS_USERSETTINGS AS T
                        JOIN DIM_EDW_CMS_USERSETTINGS AS S
                            ON
                            S.USERSETTINGSID = T.USERSETTINGSID
                        JOIN CHANGETABLE ( CHANGES CMS_USERSETTINGS , @ChangeVersionID) AS CT_CMS_USERSETTINGS
                            ON
                            CT_CMS_USERSETTINGS.USERSETTINGSID = T.USERSETTINGSID
                        AND CT_CMS_USERSETTINGS.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION = 'U';
    WITH CTE_temp (
         USERSETTINGSID) 
        AS (
        SELECT
               CTE_temp.USERSETTINGSID
               FROM CHANGETABLE (CHANGES CMS_USERSETTINGS, @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               USERSETTINGSID
               FROM DIM_EDW_CMS_USERSETTINGS
        ) 
        INSERT INTO DIM_EDW_CMS_USERSETTINGS (
               USERSETTINGSUSERID
             , HFITUSERMPINUMBER
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , USERSETTINGSID) 
        SELECT
               T.USERSETTINGSUSERID
             , T.HFITUSERMPINUMBER
             , CT_CMS_USERSETTINGS.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
             , T.USERSETTINGSID
               FROM
                   CMS_USERSETTINGS AS T
                       JOIN CHANGETABLE (CHANGES CMS_USERSETTINGS, @ChangeVersionID) AS CT_CMS_USERSETTINGS
                           ON CT_CMS_USERSETTINGS.USERSETTINGSID = T.USERSETTINGSID
                          AND CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION = 'I'
                       JOIN CTE_temp AS C
                           ON c.USERSETTINGSID = CT_CMS_USERSETTINGS.USERSETTINGSID;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    --drop table DIM_EDW_HFit_HealthAssesmentUserRiskArea
    --select CT_TEMP.ItemID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES HFIT_HealthAssesmentUserRiskArea , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_HFit_HealthAssesmentUserRiskArea
    --select top 100 * from HFIT_HealthAssesmentUserRiskArea
    --select top 100 * from DIM_EDW_HFit_HealthAssesmentUserRiskArea
    --update HFIT_HealthAssesmentUserRiskArea set CodeName = 'AboutYou' where itemid = 46664

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFit_HealthAssesmentUserRiskArea';

    IF @iCnt = 0
        BEGIN

            PRINT 'Populating DIM_EDW_HFit_HealthAssesmentUserRiskArea';
            INSERT INTO DIM_EDW_HFit_HealthAssesmentUserRiskArea
            (
                   ITEMID
                 , CODENAME
                 , HARISKAREANODEGUID
                 , HARISKAREASCORE
                 , PREWEIGHTEDSCORE
                 , ITEMMODIFIEDWHEN
                 , HARISKCATEGORYITEMID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HAUserRiskArea.ItemID
                 , HAUserRiskArea.CODENAME
                 , HAUserRiskArea.HARISKAREANODEGUID
                 , HAUserRiskArea.HARISKAREASCORE
                 , HAUserRiskArea.PREWEIGHTEDSCORE
                 , HAUserRiskArea.ITEMMODIFIEDWHEN
                 , HAUserRiskArea.HARISKCATEGORYITEMID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM HFIT_HealthAssesmentUserRiskArea AS HAUserRiskArea;

        END;
    DELETE FROM DIM_EDW_HFit_HealthAssesmentUserRiskArea
    WHERE
          ItemID IN ( SELECT
                             CT_HFit_HealthAssesmentUserRiskArea.ItemID
                             FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea, @ChangeVersionID) AS CT_HFit_HealthAssesmentUserRiskArea
                             WHERE
                             SYS_CHANGE_OPERATION = 'D') ;
    UPDATE S
           SET
               S.CODENAME = T.CODENAME
             ,S.HARISKAREANODEGUID = T.HARISKAREANODEGUID
             ,S.HARISKAREASCORE = T.HARISKAREASCORE
             ,S.PREWEIGHTEDSCORE = T.PREWEIGHTEDSCORE
             ,S.ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
             ,S.HARISKCATEGORYITEMID = T.HARISKCATEGORYITEMID
             ,S.LastUpdateID = CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,SVR = @@Servername
             ,DBNAME = DB_NAME () 
             ,DeletedFlg = 0
               FROM HFit_HealthAssesmentUserRiskArea AS T
                        JOIN DIM_EDW_HFit_HealthAssesmentUserRiskArea AS S
                            ON
                            S.ItemID = T.ItemID
                        JOIN CHANGETABLE ( CHANGES HFit_HealthAssesmentUserRiskArea , @ChangeVersionID) AS CT_HFit_HealthAssesmentUserRiskArea
                            ON
                            CT_HFit_HealthAssesmentUserRiskArea.ItemID = T.ItemID
                        AND CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION = 'U';
    WITH CTE_temp (
         ItemID) 
        AS (
        SELECT
               CTE_temp.ItemID
               FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea, @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               ItemID
               FROM DIM_EDW_HFit_HealthAssesmentUserRiskArea
        ) 
        INSERT INTO DIM_EDW_HFit_HealthAssesmentUserRiskArea (
               CODENAME
             , HARISKAREANODEGUID
             , HARISKAREASCORE
             , PREWEIGHTEDSCORE
             , ITEMMODIFIEDWHEN
             , HARISKCATEGORYITEMID
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , ITEMID) 
        SELECT
               T.CODENAME
             , T.HARISKAREANODEGUID
             , T.HARISKAREASCORE
             , T.PREWEIGHTEDSCORE
             , T.ITEMMODIFIEDWHEN
             , T.HARISKCATEGORYITEMID
             , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
             , T.ITEMID
               FROM
                   HFit_HealthAssesmentUserRiskArea AS T
                       JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea, @ChangeVersionID) AS CT_HFit_HealthAssesmentUserRiskArea
                           ON CT_HFit_HealthAssesmentUserRiskArea.ItemID = T.ItemID
                          AND CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION = 'I'
                       JOIN CTE_temp AS C
                           ON c.ItemID = CT_HFit_HealthAssesmentUserRiskArea.ItemID;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************		 
    --drop table DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
    --select CT_TEMP.ItemID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
    --select top 100 * from HFit_HealthAssesmentUserQuestionGroupResults
    --select top 100 * from DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
    --update HFit_HealthAssesmentUserQuestionGroupResults set CodeName = 'MME' where itemid = 19864

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults';

    IF @iCnt = 0
        BEGIN

            PRINT 'Populating DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults';
            INSERT INTO DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
            (
                   ITEMID
                 , POINTRESULTS
                 , CODENAME
                 , HARiskAreaItemID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   HAUserQuestionGroupResults.ItemID
                 , HAUserQuestionGroupResults.POINTRESULTS
                 , HAUserQuestionGroupResults.CODENAME
                 , HAUserQuestionGroupResults.HARiskAreaItemID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM HFIT_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults;

        END;
    DELETE FROM DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
    WHERE
          ItemID IN ( SELECT
                             CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID
                             FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults, @ChangeVersionID) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                             WHERE
                             SYS_CHANGE_OPERATION = 'D') ;
    UPDATE S
           SET
               S.POINTRESULTS = T.POINTRESULTS
             ,S.CODENAME = T.CODENAME
             ,S.HARiskAreaItemID = T.HARiskAreaItemID
             ,S.LastUpdateID = CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION
             ,S.LASTLOADEDDATE = GETDATE () 
             ,SVR = @@Servername
             ,DBNAME = DB_NAME () 
             ,DeletedFlg = 0
               FROM HFit_HealthAssesmentUserQuestionGroupResults AS T
                        JOIN DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults AS S
                            ON
                            S.ItemID = T.ItemID
                        JOIN CHANGETABLE ( CHANGES HFit_HealthAssesmentUserQuestionGroupResults , @ChangeVersionID) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                            ON
                            CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID = T.ItemID
                        AND CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION != S.LastUpdateID
                        AND CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION = 'U';
    WITH CTE_temp (
         ItemID) 
        AS (
        SELECT
               CTE_temp.ItemID
               FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults, @ChangeVersionID) AS CTE_temp
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               ItemID
               FROM DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults
        ) 
        INSERT INTO DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults (
               POINTRESULTS
             , CODENAME
             , HARiskAreaItemID
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg
             , ITEMID) 
        SELECT
               T.POINTRESULTS
             , T.CODENAME
             , T.HARiskAreaItemID
             , CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
             , T.ITEMID
               FROM
                   HFit_HealthAssesmentUserQuestionGroupResults AS T
                       JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults, @ChangeVersionID) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                           ON CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID = T.ItemID
                          AND CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION = 'I'
                       JOIN CTE_temp AS C
                           ON c.ItemID = CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    --***********************************************************************************
    -- drop table DIM_EDW_HFit_HealthAssesmentUserQuestion
    -- select top 100 * from DIM_EDW_HFit_HealthAssesmentUserQuestion

    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_HFit_HealthAssesmentUserQuestion';

    IF @iCnt = 0
        BEGIN
            PRINT 'Populating DIM_EDW_HFit_HealthAssesmentUserQuestion';
            INSERT INTO DIM_EDW_HFit_HealthAssesmentUserQuestion
            (
                   ITEMID
                 , HAQUESTIONNODEGUID
                 , CODENAME
                 , HAQUESTIONSCORE
                 , PREWEIGHTEDSCORE
                 , ISPROFESSIONALLYCOLLECTED
                 , ITEMMODIFIEDWHEN
                 , HARiskAreaItemID
                 , HFIT_HEALTHASSESMENTUSERQUESTION_CTID
                 , HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
                 , CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   USERQUES.ITEMID
                 , USERQUES.HAQUESTIONNODEGUID
                 , USERQUES.CODENAME
                 , USERQUES.HAQUESTIONSCORE
                 , USERQUES.PREWEIGHTEDSCORE
                 , USERQUES.ISPROFESSIONALLYCOLLECTED
                 , USERQUES.ITEMMODIFIEDWHEN
                 , USERQUES.HARiskAreaItemID
                 , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID AS HFIT_HEALTHASSESMENTUSERQUESTION_CTID
                 , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
                 , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg

                   FROM
                       HFIT_HEALTHASSESMENTUSERQUESTION AS USERQUES
                           LEFT OUTER JOIN CHANGETABLE ( CHANGES HFIT_HEALTHASSESMENTUSERQUESTION , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
                               ON
                               USERQUES.ITEMID = CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID;

        END;
    WITH CTE_HFIT_HEALTHASSESMENTUSERQUESTION (
         ItemID) 
        AS (
        SELECT
               CT_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID
               FROM CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERQUESTION, @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
               WHERE
               SYS_CHANGE_OPERATION = 'I'
        EXCEPT
        SELECT
               itemid
               FROM DIM_EDW_HFit_HealthAssesmentUserQuestion
        ) 
        INSERT INTO DIM_EDW_HFit_HealthAssesmentUserQuestion (
               ITEMID
             , HAQUESTIONNODEGUID
             , CODENAME
             , HAQUESTIONSCORE
             , PREWEIGHTEDSCORE
             , ISPROFESSIONALLYCOLLECTED
             , ITEMMODIFIEDWHEN
             , HARiskAreaItemID
             , HFIT_HEALTHASSESMENTUSERQUESTION_CTID
             , HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
             , CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
             , LastUpdateID
             , LASTLOADEDDATE
             , SVR
             , DBNAME
             , DeletedFlg) 
        SELECT
               T.ITEMID
             , T.HAQUESTIONNODEGUID
             , T.CODENAME
             , T.HAQUESTIONSCORE
             , T.PREWEIGHTEDSCORE
             , T.ISPROFESSIONALLYCOLLECTED
             , T.ITEMMODIFIEDWHEN
             , T.HARiskAreaItemID
             , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID  AS HFIT_HEALTHASSESMENTUSERQUESTION_CTID
             , 'I' AS HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
             , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
             , 0 AS LastUpdateID
             , GETDATE () AS LASTLOADEDDATE
             , @@SERVERNAME AS SVR
             , DB_NAME () AS DBNAME
             , 0 AS DeletedFlg
               FROM
                   HFIT_HEALTHASSESMENTUSERQUESTION AS T
                       JOIN CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERQUESTION, @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
                           ON CT_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID = T.ItemID
                          AND CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION = 'I'
                       JOIN CTE_HFIT_HEALTHASSESMENTUSERQUESTION
                           ON CTE_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID = T.ItemID;
    --set @iInsertedCnt = @iInsertedCnt + @@ROWCOUNT ;

    DELETE FROM DIM_EDW_HFit_HealthAssesmentUserQuestion
    WHERE
          ItemID IN ( SELECT
                             CT_CMS_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID
                             FROM CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERQUESTION, @ChangeVersionID) AS CT_CMS_HFIT_HEALTHASSESMENTUSERQUESTION
                             WHERE
                             SYS_CHANGE_OPERATION = 'D') ;

    WITH CTE_HAQ (
         ItemID
       , SYS_CHANGE_VERSION) 
        AS (
        SELECT
               CT_CMS_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID
             , CT_CMS_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION
               FROM CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERQUESTION, @ChangeVersionID) AS CT_CMS_HFIT_HEALTHASSESMENTUSERQUESTION
               WHERE
               SYS_CHANGE_OPERATION = 'U'
        EXCEPT
        SELECT
               ItemID
             , LastUpdateID
               FROM DIM_EDW_HFit_HealthAssesmentUserQuestion
        ) 
        UPDATE S
               SET
                   S.HAQUESTIONNODEGUID = T.HAQUESTIONNODEGUID
                 ,S.CODENAME = T.CODENAME
                 ,S.HAQUESTIONSCORE = T.HAQUESTIONSCORE
                 ,S.PREWEIGHTEDSCORE = T.PREWEIGHTEDSCORE
                 ,S.ISPROFESSIONALLYCOLLECTED = T.ISPROFESSIONALLYCOLLECTED
                 ,S.ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
                 ,S.HARiskAreaItemID = T.HARiskAreaItemID
                 ,S.LastUpdateID = CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION
                 ,S.LASTLOADEDDATE = GETDATE () 
                 ,S.SVR = @@Servername
                 ,S.DBNAME = DB_NAME () 
                 ,S.DeletedFlg = 0
                   FROM HFIT_HEALTHASSESMENTUSERQUESTION AS T
                            JOIN DIM_EDW_HFit_HealthAssesmentUserQuestion AS S
                                ON
                                S.ItemID = T.ItemID
                            JOIN CHANGETABLE ( CHANGES HFIT_HEALTHASSESMENTUSERQUESTION , @ChangeVersionID) AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
                                ON
                                CT_HFIT_HEALTHASSESMENTUSERQUESTION.ItemID = T.ItemID
                            AND S.ItemID = T.ItemID
                            AND CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION != S.LastUpdateID
                            AND CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION = 'U'
                            JOIN CTE_HAQ
                                ON
                                CTE_HAQ.ItemID = S.ItemID;

    --********************************************************************************************
    -- THIS IS A TABLE CREATED FROM A VIEW WITH A SMALL NUMBER OF ROWS, JUST DROP AND RECREATE.
    truncate TABLE DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED;
    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED';

    IF @iCnt = 0
        BEGIN

            PRINT 'Populating DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED';
            INSERT INTO DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED
            (
                   DOCUMENTCULTURE
                 , HACAMPAIGNID
                 , NODEGUID
                 , NODESITEID
                 , HEALTHASSESSMENTID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg) 
            SELECT
                   CAMPAIGN.DOCUMENTCULTURE
                 , CAMPAIGN.HACAMPAIGNID
                 , CAMPAIGN.NODEGUID
                 , CAMPAIGN.NODESITEID
                 , CAMPAIGN.HEALTHASSESSMENTID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM VIEW_HFIT_HACAMPAIGN_JOINED AS CAMPAIGN;
        END;

    --***********************************************************************************
    --select top 100 * from View_HFit_HealthAssessment_Joined
    -- THIS IS A TABLE CREATED FROM A VIEW WITH A SMALL NUMBER OF ROWS, JUST DROP AND RECREATE.
    truncate TABLE DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED;
    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED';

    IF @iCnt = 0
        BEGIN

            PRINT 'Populating DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED';
            INSERT INTO DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED
            (
                   NODEGUID
                 , DOCUMENTID
                 , DOCUMENTCULTURE
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg) 
            SELECT
                   HAJOINED.NODEGUID
                 , HAJOINED.DOCUMENTID
                 , HAJOINED.DOCUMENTCULTURE
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM VIEW_HFIT_HEALTHASSESSMENT_JOINED AS HAJOINED;
        END;

    --***********************************************************************************		
    --***********************************************************************************
    --drop table DIM_EDW_View_EDW_HealthAssesmentQuestions
    --select CT_TEMP.ItemID, CT_TEMP.SYS_CHANGE_VERSION from CHANGETABLE (CHANGES View_EDW_HealthAssesmentQuestions , NULL) AS CT_TEMP where SYS_CHANGE_OPERATION = 'U'
    --select * from DIM_EDW_View_EDW_HealthAssesmentQuestions
    --select top 100 * from View_EDW_HealthAssesmentQuestions
    --select top 100 * from DIM_EDW_View_EDW_HealthAssesmentQuestions
    --update View_EDW_HealthAssesmentQuestions set CodeName = 'AboutYou' where itemid = 32919
    -- THIS IS A TABLE CREATED FROM A VIEW WITH A SMALL NUMBER OF ROWS, JUST DROP AND RECREATE.

    truncate TABLE DIM_EDW_View_EDW_HealthAssesmentQuestions;
    EXEC @iCnt = proc_QuickRowCount 'DIM_EDW_View_EDW_HealthAssesmentQuestions';

    IF @iCnt = 0
        BEGIN

            PRINT 'Populating DIM_EDW_View_EDW_HealthAssesmentQuestions';
            INSERT INTO DIM_EDW_View_EDW_HealthAssesmentQuestions
            (
                   TITLE
                 , DOCUMENTCULTURE
                 , NODEGUID
                 , LastUpdateID
                 , LASTLOADEDDATE
                 , SVR
                 , DBNAME
                 , DeletedFlg
            ) 
            SELECT
                   DBO.UDF_STRIPHTML ( QUES.TITLE) AS TITLE
                 , QUES.DOCUMENTCULTURE
                 , QUES.NODEGUID
                 , 0 AS LastUpdateID
                 , GETDATE () AS LASTLOADEDDATE
                 , @@Servername AS SVR
                 , DB_NAME () AS DBNAME
                 , 0 AS DeletedFlg
                   FROM VIEW_EDW_HEALTHASSESMENTQUESTIONS AS QUES;
        END;

    --***********************************************************************************		 		 

    IF NOT EXISTS ( SELECT
                           NAME
                           FROM SYS.INDEXES
                           WHERE
                           NAME = 'PI_Staged_HAUserQuestionGroupResults') 
        BEGIN
            PRINT 'Populating PI_Staged_HAUserQuestionGroupResults';
            CREATE NONCLUSTERED INDEX PI_Staged_HAUserQuestionGroupResults ON DBO.DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults ( HARiskAreaItemID ASC) INCLUDE (
            ITEMID
            , POINTRESULTS
            , CODENAME) ;
        END;
    SET ANSI_PADDING ON;
    SET NOCOUNT OFF;
    PRINT '**LEAVING Populating Staging Tables: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
END;
GO
PRINT 'Executed proc_EDW_BuildStagingTables.sql';
GO

PRINT 'RUNNING PROCEDURE proc_EDW_BuildStagingTables';

GO

EXEC proc_EDW_BuildStagingTables;

GO

PRINT 'COMPETED RUNNING PROCEDURE proc_EDW_BuildStagingTables';

GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Creating proc_EDW_Create_HA_TempTable.sql';
GO

exec proc_EDW_BuildStagingTables ;

go

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_Create_HA_TempTable' )
    BEGIN
        DROP PROCEDURE
             proc_EDW_Create_HA_TempTable;
    END;
GO
--EXEC proc_EDW_Create_HA_TempTable
CREATE PROCEDURE proc_EDW_Create_HA_TempTable
AS
BEGIN

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.tables
                      WHERE name = 'TEMP_EDW_HealthAssessment_DATA' )
        BEGIN
            CREATE TABLE TEMP_EDW_HealthAssessment_DATA
            (
                         UserStartedItemID int  NULL
                         ,HealthAssesmentUserStartedNodeGUID uniqueidentifier  NULL
                         ,UserID bigint  NULL
                         ,UserGUID uniqueidentifier  NULL
                         ,HFitUserMpiNumber bigint  NULL
                         ,SiteGUID uniqueidentifier  NULL
                         ,AccountID int  NULL
                         ,AccountCD nvarchar( 8 ) NULL
                         ,AccountName nvarchar( 200 ) NULL
                         ,HAStartedDt datetime  NULL
                         ,HACompletedDt datetime  NULL
                         ,UserModuleItemId int  NULL
                         ,UserModuleCodeName nvarchar( 100 ) NULL
                         ,HAModuleNodeGUID uniqueidentifier  NULL
                         ,CMSNodeGuid uniqueidentifier  NULL
                         ,HAModuleVersionID int  NULL
                         ,UserRiskCategoryItemID int  NULL
                         ,UserRiskCategoryCodeName nvarchar( 100 ) NULL
                         ,HARiskCategoryNodeGUID uniqueidentifier  NULL
                         ,HARiskCategoryVersionID int  NULL
                         ,UserRiskAreaItemID int  NULL
                         ,UserRiskAreaCodeName nvarchar( 100 ) NULL
                         ,HARiskAreaNodeGUID uniqueidentifier  NULL
                         ,HARiskAreaVersionID int  NULL
                         ,UserQuestionItemID int  NULL
                         ,Title varchar( max ) NULL
                         ,HAQuestionGuid uniqueidentifier  NULL
                         ,UserQuestionCodeName nvarchar( 100 ) NULL
                         ,HAQuestionDocumentID int  NULL
                         ,HAQuestionVersionID int  NULL
                         ,HAQuestionNodeGUID uniqueidentifier  NULL
                         ,UserAnswerItemID int  NULL
                         ,HAAnswerNodeGUID uniqueidentifier  NULL
                         ,HAAnswerVersionID int  NULL
                         ,UserAnswerCodeName nvarchar( 100 ) NULL
                         ,HAAnswerValue nvarchar( 255 ) NULL
                         ,HAModuleScore float  NULL
                         ,HARiskCategoryScore float  NULL
                         ,HARiskAreaScore float  NULL
                         ,HAQuestionScore float  NULL
                         ,HAAnswerPoints int  NULL
                         ,PointResults int  NULL
                         ,UOMCode nvarchar( 10 ) NULL
                         ,HAScore int  NULL
                         ,ModulePreWeightedScore float  NULL
                         ,RiskCategoryPreWeightedScore float  NULL
                         ,RiskAreaPreWeightedScore float  NULL
                         ,QuestionPreWeightedScore float  NULL
                         ,QuestionGroupCodeName nvarchar( 100 ) NULL
                         ,ChangeType nchar( 1 ) NULL
                         ,ItemCreatedWhen datetime  NULL
                         ,ItemModifiedWhen datetime  NULL
                         ,IsProfessionallyCollected bit  NULL
                         ,HARiskCategory_ItemModifiedWhen datetime  NULL
                         ,HAUserRiskArea_ItemModifiedWhen datetime  NULL
                         ,HAUserQuestion_ItemModifiedWhen datetime  NULL
                         ,HAUserAnswers_ItemModifiedWhen datetime  NULL
                         ,HAPaperFlg bit  NULL
                         ,HATelephonicFlg bit  NULL
                         ,HAStartedMode int  NULL
                         ,HACompletedMode int  NULL
                         ,DocumentCulture_VHCJ nvarchar( 10 ) NULL
                         ,DocumentCulture_HAQuestionsView nvarchar( 10 ) NULL
                         ,CampaignNodeGUID uniqueidentifier  NULL
                         ,HACampaignID int  NULL
                         ,HashCode varchar( 100 ) NULL
                         ,PKHASHCODE nvarchar( 100 ) NOT  NULL
                         ,CHANGED_FLG int  NULL
                         ,CT_CMS_User_UserID int  NULL
                         ,CT_CMS_User_CHANGE_OPERATION nchar( 1 ) NULL
                         ,CT_UserSettingsID int  NULL
                         ,CT_UserSettingsID_CHANGE_OPERATION nchar( 1 ) NULL
                         ,SiteID_CtID int  NULL
                         ,SiteID_CHANGE_OPERATION nchar( 1 ) NULL
                         ,UserSiteID_CtID int  NULL
                         ,UserSiteID_CHANGE_OPERATION nchar( 1 ) NULL
                         ,AccountID_CtID int  NULL
                         ,AccountID__CHANGE_OPERATION nchar( 1 ) NULL
                         ,HAUserAnswers_CtID int  NULL
                         ,HAUserAnswers_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserModule_CtID int  NULL
                         ,HFit_HealthAssesmentUserModule_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserQuestion_CtID int  NULL
                         ,HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserQuestionGroupResults_CtID int  NULL
                         ,HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserRiskArea_CtID int  NULL
                         ,HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserRiskCategory_CtID int  NULL
                         ,HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION nchar( 1 ) NULL
                         ,HFit_HealthAssesmentUserStarted_CtID int  NULL
                         ,HFit_HealthAssesmentUserStarted_CHANGE_OPERATION nchar( 1 ) NULL
                         ,CT_CMS_User_SCV bigint  NULL
                         ,CT_CMS_UserSettings_SCV bigint  NULL
                         ,CT_CMS_Site_SCV bigint  NULL
                         ,CT_CMS_UserSite_SCV bigint  NULL
                         ,CT_HFit_Account_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserAnswers_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserModule_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserQuestion_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserRiskArea_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserRiskCategory_SCV bigint  NULL
                         ,CT_HFit_HealthAssesmentUserStarted_SCV bigint  NULL
                         ,LastModifiedDate datetime  NULL
                         ,DeleteFlg int  NULL
            );
        END;

/******************************************************************************************************************
IF NOT EXISTS ( SELECT
                        name
                    FROM sys.indexes
                    WHERE name = 'temp_PI_EDW_HealthAssessment_IDs' )
CREATE INDEX temp_PI_EDW_HealthAssessment_IDs ON TEMP_EDW_HealthAssessment_DATA (
UserStartedItemID
, HealthAssesmentUserStartedNodeGUID
, UserGUID
, SiteGUID
, AccountCD
, HAModuleNodeGUID
, CMSNodeGuid
, HARiskCategoryNodeGUID
, UserRiskAreaItemID
, HARiskAreaNodeGUID
, UserQuestionItemID
, HAQuestionGuid
, HAQuestionNodeGUID
, UserAnswerItemID
, HAAnswerNodeGUID
, CampaignNodeGUID
)
INCLUDE ( AccountID , UserModuleItemId , UserRiskCategoryItemID , HASHCODE , LastModifiedDate )
WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
ALLOW_ROW_LOCKS = ON ,
ALLOW_PAGE_LOCKS = ON );
******************************************************************************************************************/

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'temp_PI_EDW_HealthAssessment_ChangeType' )
        BEGIN
            CREATE INDEX temp_PI_EDW_HealthAssessment_ChangeType ON TEMP_EDW_HealthAssessment_DATA ( ChangeType )
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON ,
            ALLOW_PAGE_LOCKS = ON )
        END;

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'temp_PI_EDW_HealthAssessment_NATKEY' )
        BEGIN
            CREATE INDEX temp_PI_EDW_HealthAssessment_NATKEY ON TEMP_EDW_HealthAssessment_DATA (
            UserStartedItemID
            , UserGUID
            , PKHashCode
            , HASHCODE
            )
        END;

END;

GO
PRINT 'Created proc_EDW_Create_HA_TempTable';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HealthInterestDetail_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestDetail_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestDetail_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HealthInterestDetail_AddNewRecs
AS
BEGIN

 WITH CTE_NEW (
             UserID
           , UserGUID
           , HFitUserMpiNumber
           , SiteGUID
           , CoachingHealthInterestID
           , FirstNodeID
           , SecondNodeGuid
           , ThirdNodeGuid) 
            AS ( SELECT
                        UserID
                      , UserGUID
                      , HFitUserMpiNumber
                      , SiteGUID
                      , CoachingHealthInterestID
                      , FirstNodeID
                      , SecondNodeGuid
                      , ThirdNodeGuid
                        FROM ##Temp_HealthInterestDetail
                 EXCEPT
                 SELECT
                        UserID
                      , UserGUID
                      , HFitUserMpiNumber
                      , SiteGUID
                      , CoachingHealthInterestID
                      , FirstNodeID
                      , SecondNodeGuid
                      , ThirdNodeGuid
                        FROM DIM_EDW_HealthInterestDetail
                        WHERE LastModifiedDate IS NULL) 
            INSERT INTO DIM_EDW_HealthInterestDetail
            SELECT
                   S.[UserID]
      ,S.[UserGUID]
      ,S.[HFitUserMpiNumber]
      ,S.[SiteGUID]
      ,S.[CoachingHealthInterestID]
      ,S.[FirstHealthAreaID]
      ,S.[FirstNodeID]
      ,S.[FirstNodeGuid]
      ,S.[FirstHealthAreaName]
      ,S.[FirstHealthAreaDescription]
      ,S.[FirstCodeName]
      ,S.[SecondHealthAreaID]
      ,S.[SecondNodeID]
      ,S.[SecondNodeGuid]
      ,S.[SecondHealthAreaName]
      ,S.[SecondHealthAreaDescription]
      ,S.[SecondCodeName]
      ,S.[ThirdHealthAreaID]
      ,S.[ThirdNodeID]
      ,S.[ThirdNodeGuid]
      ,S.[ThirdHealthAreaName]
      ,S.[ThirdHealthAreaDescription]
      ,S.[ThirdCodeName]
      ,S.[ItemCreatedWhen]
      ,S.[ItemModifiedWhen]
      ,S.[IsDeleted]
      ,S.[HashCode]
      ,S.[SVR]
      ,S.[DBNAME]
                 , NULL AS LastModifiedDate
                 , NULL AS RowNbr
                 , NULL AS DeletedFlg
                 , NULL AS TimeZone
                 , NULL AS ConvertedToCentralTime
                   FROM
                        ##Temp_HealthInterestDetail AS S
                             JOIN CTE_NEW AS C
                             ON
                                S.UserID = C.UserID AND
                                S.UserGUID = C.UserGUID AND
                                S.HFitUserMpiNumber = C.HFitUserMpiNumber AND
                                S.SiteGUID = C.SiteGUID AND
                                S.CoachingHealthInterestID = C.CoachingHealthInterestID AND
                                S.FirstNodeID = C.FirstNodeID AND
                                S.SecondNodeGuid = C.SecondNodeGuid AND
                                S.ThirdNodeGuid = C.ThirdNodeGuid;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestDetail_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_HealthInterestDetail_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestDetail_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestDetail_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HealthInterestDetail_AddUpdatedRecs
AS
BEGIN

    DECLARE
        @RUNDATE AS datetime2 ( 7) = GETDATE () ;

        UPDATE S
          SET
              S.UserID = T.UserID
            ,S.UserGUID = T.UserGUID
            ,S.HFitUserMpiNumber = T.HFitUserMpiNumber
            ,S.SiteGUID = T.SiteGUID
            ,S.CoachingHealthInterestID = T.CoachingHealthInterestID
            ,S.FirstHealthAreaID = T.FirstHealthAreaID
            ,S.FirstNodeID = T.FirstNodeID
            ,S.FirstNodeGuid = T.FirstNodeGuid
            ,S.FirstHealthAreaName = T.FirstHealthAreaName
            ,S.FirstHealthAreaDescription = T.FirstHealthAreaDescription
            ,S.FirstCodeName = T.FirstCodeName
            ,S.SecondHealthAreaID = T.SecondHealthAreaID
            ,S.SecondNodeID = T.SecondNodeID
            ,S.SecondNodeGuid = T.SecondNodeGuid
            ,S.SecondHealthAreaName = T.SecondHealthAreaName
            ,S.SecondHealthAreaDescription = T.SecondHealthAreaDescription
            ,S.SecondCodeName = T.SecondCodeName
            ,S.ThirdHealthAreaID = T.ThirdHealthAreaID
            ,S.ThirdNodeID = T.ThirdNodeID
            ,S.ThirdNodeGuid = T.ThirdNodeGuid
            ,S.ThirdHealthAreaName = T.ThirdHealthAreaName
            ,S.ThirdHealthAreaDescription = T.ThirdHealthAreaDescription
            ,S.ThirdCodeName = T.ThirdCodeName
            ,S.ItemCreatedWhen = T.ItemCreatedWhen
            ,S.ItemModifiedWhen = T.ItemModifiedWhen
            ,S.HashCode = T.HashCode
              --,S.DESC1 = T.DESC1
              --,S.DESC2 = T.DESC2
              --,S.DESC3 = T.DESC3
              --,S.[DeletedFlg] = T.[DeletedFlg]
            ,
              S.LastModifiedDate = GETDATE () 
            ,S.ConvertedToCentralTime = NULL
              FROM ##Temp_HealthInterestDetail AS T
                        JOIN
                        DIM_EDW_HealthInterestDetail AS S
                        ON
                        S.UserID = T.UserID AND
                        S.UserGUID = T.UserGUID AND
                        S.HFitUserMpiNumber = T.HFitUserMpiNumber AND
                        S.SiteGUID = T.SiteGUID AND
                        S.CoachingHealthInterestID = T.CoachingHealthInterestID AND
                        S.FirstNodeID = T.FirstNodeID AND
                        S.SecondNodeGuid = T.SecondNodeGuid AND
                        S.ThirdNodeGuid = T.ThirdNodeGuid AND
                        S.HASHCODE != T.HASHCODE AND
                        S.LastModifiedDate IS NULL and S.DeletedFlg is null;
              

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestDetail_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HealthInterestDetail_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestDetail_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestDetail_AddDeletedRecs;
    END;
GO
-- exec proc_CT_HealthInterestDetail_AddDeletedRecs
CREATE PROCEDURE proc_CT_HealthInterestDetail_AddDeletedRecs
AS
BEGIN

DECLARE
        @DELDATE AS datetime2 ( 7) = GETDATE () ;
        WITH CTE_DEL (
             UserID
           , UserGUID
           , HFitUserMpiNumber
           , SiteGUID
           , CoachingHealthInterestID
           , FirstNodeID
           , SecondNodeGuid
           , ThirdNodeGuid) 
            AS ( SELECT
                        UserID
                      , UserGUID
                      , HFitUserMpiNumber
                      , SiteGUID
                      , CoachingHealthInterestID
                      , FirstNodeID
                      , SecondNodeGuid
                      , ThirdNodeGuid
                        FROM DIM_EDW_HealthInterestDetail
                 EXCEPT
                 SELECT
                        UserID
                      , UserGUID
                      , HFitUserMpiNumber
                      , SiteGUID
                      , CoachingHealthInterestID
                      , FirstNodeID
                      , SecondNodeGuid
                      , ThirdNodeGuid
                        FROM ##Temp_HealthInterestDetail) 

            UPDATE S
              SET
                  DeletedFlg = 1
                ,LastModifiedDate = @DELDATE
                  FROM DIM_EDW_HealthInterestDetail AS S
                            JOIN
                            CTE_DEL AS C
                            ON
                            S.UserID = C.UserID AND
                            S.UserGUID = C.UserGUID AND
                            S.HFitUserMpiNumber = C.HFitUserMpiNumber AND
                            S.SiteGUID = C.SiteGUID AND
                            S.CoachingHealthInterestID = C.CoachingHealthInterestID AND
                            S.FirstNodeID = C.FirstNodeID AND
                            S.SecondNodeGuid = C.SecondNodeGuid AND
                            S.ThirdNodeGuid = C.ThirdNodeGuid AND
                            S.DeletedFlg IS NULL;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    UPDATE DIM_EDW_HealthInterestDetail
      SET
          LastModifiedDate = GETDATE () 
           WHERE
                 LastModifiedDate IS NULL AND
                 DeletedFlg IS NOT NULL;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestDetail_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HealthInterestList_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestList_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestList_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HealthInterestList_AddNewRecs
AS
BEGIN

    WITH CTE_NEW (
         HealthAreaID
       , NodeID
       , NodeGuid
       , AccountCD) 
        AS ( SELECT
                    HealthAreaID
                  , NodeID
                  , NodeGuid
                  , AccountCD
                    FROM ##Temp_HealthInterestList
             EXCEPT
             SELECT
                    HealthAreaID
                  , NodeID
                  , NodeGuid
                  , AccountCD
                    FROM DIM_EDW_HealthInterestList
                    WHERE LastModifiedDate IS NULL) 
        INSERT INTO DIM_EDW_HealthInterestList
        SELECT
               T.HealthAreaID
             , T.NodeID
             , T.NodeGuid
             , T.AccountCD
             , T.HealthAreaName
             , T.HealthAreaDescription
             , T.CodeName
             , T.DocumentCreatedWhen
             , T.DocumentModifiedWhen
             , T.HashCode
             , T.SVR
             , T.DBNAME
             , NULL AS LastModifiedDate
             , NULL AS RowNbr
             , NULL AS DeletedFlg
             , NULL AS TimeZone
             , NULL AS ConvertedToCentralTime
               FROM
                    ##Temp_HealthInterestList AS T
                         JOIN CTE_NEW AS C
                         ON
                            T.HealthAreaID = C.HealthAreaID AND
                            T.NodeID = C.NodeID AND
                            T.NodeGuid = C.NodeGuid AND
                            T.AccountCD = C.AccountCD;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestList_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_HealthInterestList_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestList_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestList_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HealthInterestList_AddUpdatedRecs
AS
BEGIN

        DECLARE @RUNDATE AS datetime2 ( 7) = GETDATE () ;

        UPDATE S
          SET
              S.HealthAreaName = T.HealthAreaName
            ,S.HealthAreaDescription = T.HealthAreaDescription
            ,S.CodeName = T.CodeName
            ,S.DocumentCreatedWhen = T.DocumentCreatedWhen
            ,S.DocumentModifiedWhen = T.DocumentModifiedWhen
            ,S.HashCode = T.HashCode
            ,S.LastModifiedDate = GETDATE () 
            ,S.ConvertedToCentralTime = NULL

              FROM ##Temp_HealthInterestList AS T
                        JOIN DIM_EDW_HealthInterestList AS S
                        ON
                        S.HealthAreaID = T.HealthAreaID AND
                        S.NodeID = T.NodeID AND
                        S.NodeGuid = T.NodeGuid AND
                        S.AccountCD = T.AccountCD AND
                        S.HASHCODE != T.HASHCODE AND
                        S.DeletedFlg IS NULL;
 
    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestList_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HealthInterestList_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HealthInterestList_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HealthInterestList_AddDeletedRecs;
    END;
GO
-- exec proc_CT_HealthInterestList_AddDeletedRecs
CREATE PROCEDURE proc_CT_HealthInterestList_AddDeletedRecs
AS
BEGIN
      
        WITH CTE_DEL (
             HealthAreaID
           , NodeID
           , NodeGuid
           , AccountCD, DeletedFlg) 
            AS ( SELECT
                        HealthAreaID
                      , NodeID
                      , NodeGuid
                      , AccountCD, DeletedFlg
                        FROM DIM_EDW_HealthInterestList
                 EXCEPT
                 SELECT
                        HealthAreaID
                      , NodeID
                      , NodeGuid
                      , AccountCD, DeletedFlg
                        FROM ##Temp_HealthInterestList) 

            UPDATE S
              SET
                  DeletedFlg = 1
                ,LastModifiedDate = GETDATE () 
                  FROM DIM_EDW_HealthInterestList AS S
                            JOIN CTE_DEL AS C
                            ON
                            S.HealthAreaID = C.HealthAreaID AND
                            S.NodeID = C.NodeID AND
                            isnull(S.NodeGuid,'00000000-0000-0000-0000-000000000000')  = isnull(C.NodeGuid,'00000000-0000-0000-0000-000000000000')  AND
                            S.AccountCD = C.AccountCD AND
                            isnull(S.DeletedFlg,0)  = 0 ;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    UPDATE DIM_EDW_HealthInterestList
      SET
          LastModifiedDate = GETDATE () 
           WHERE
                 LastModifiedDate IS NULL AND
                 DeletedFlg IS NOT NULL;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HealthInterestList_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Processing: view_EDW_Participant ';
PRINT '***** FROM: view_EDW_Participant.sql';
GO

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
                  WHERE TABLE_NAME = 'view_EDW_Participant') 
    BEGIN
        PRINT 'View exists, dropping to recreate.';
        DROP VIEW
             view_EDW_Participant;
    END;
GO
--select top 300 * from view_EDW_Participant
if not exists (select column_name from information_schema.columns where column_name = 'HFitUserIsRegistered' and table_name = 'CMS_UserSettings')
begin
    alter table CMS_UserSettings add HFitUserIsRegistered bit null ;
End;
go

CREATE VIEW dbo.view_EDW_Participant
AS
--*********************************************************************************************
--WDM Reviewed 8/6/2014 for needed updates, none required
--09.11.2014 (wdm) added date fields to facilitate EDW determination of last mod date 
--05.06.2015 (wdm) added HFitUserPreferredEmail to the view to resolve 52888 per a 
--				conversation with Vijay, Shankar, and John K.
--05.15.2015 (WDM) John and I, while working on this item, found the story has been removed ??? No idea why.
--05.15.2015 (WDM) CUS.HFitUserRegistrationDate (52189)  The contract (story) was removed by Vijay causing John and I to miss this one. We luckily caught it today and fixed the missing columns
--05.15.2015 (WDM) CUS.HFitUserIsRegistered  (52189)	  The contract (story) was removed by Vijay causing John and I to miss this one. We luckily caught it today and fixed the missing columns
--*********************************************************************************************

SELECT
       cus.HFitUserMpiNumber
     , cu.UserID
     , cu.UserGUID
     , CS.SiteGUID
     , hfa.AccountID
     , hfa.AccountCD
     , cus.HFitUserPreferredMailingAddress
     , cus.HFitUserPreferredMailingCity
     , cus.HFitUserPreferredMailingState
     , cus.HFitUserPreferredMailingPostalCode
     , CAST (cus.HFitCoachingEnrollDate AS datetime) AS HFitCoachingEnrollDate
     , cus.HFitUserAltPreferredPhone
     , cus.HFitUserAltPreferredPhoneExt
     , cus.HFitUserAltPreferredPhoneType
     , cus.HFitUserPreferredPhone
     , cus.HFitUserPreferredFirstName
     , CUS.HFitUserPreferredEmail
     , cast(CUS.HFitUserRegistrationDate as datetime2)	as HFitUserRegistrationDate
     , CUS.HFitUserIsRegistered
     , CASE
           WHEN CAST (cu.UserCreated AS date) = CAST (cu.UserLastModified AS date) 
               THEN 'I'
           ELSE 'U'
       END AS ChangeType
     , CAST (cu.UserCreated AS datetime) AS UserCreated
     , CAST (cu.UserLastModified AS datetime) AS UserLastModified
     , CAST (HFA.ItemModifiedWhen AS datetime) AS Account_ItemModifiedWhen	--wdm: 09.11.2014 added to view
       FROM dbo.CMS_User AS CU
            INNER JOIN dbo.CMS_UserSite AS CUS2 WITH (NOLOCK) 
                    ON CU.UserID = CUS2.UserID
            INNER JOIN dbo.HFit_Account AS HFA WITH (NOLOCK) 
                    ON cus2.SiteID = hfa.SiteID
            INNER JOIN dbo.CMS_Site AS CS WITH (NOLOCK) 
                    ON CUS2.SiteID = CS.SiteID
            INNER JOIN dbo.CMS_UserSettings AS CUS WITH (NOLOCK) 
                    ON CU.UserID = CUS.UserSettingsUserID and CUS.HFitUserMpiNumber > 0 and CUS.HFitUserMpiNumber is not null;

GO

--  
--  
GO
PRINT 'Created/Updated: view_EDW_Participant ';
PRINT '***** FROM: view_EDW_Participant.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Processing: view_EDW_Participant_CT ';
PRINT '***** FROM: view_EDW_Participant_CT.sql';
GO

IF EXISTS ( SELECT
                   TABLE_NAME
              FROM INFORMATION_SCHEMA.VIEWS
              WHERE TABLE_NAME = 'view_EDW_Participant_CT' )
    BEGIN
        PRINT 'View exists, dropping to recreate.';
        DROP VIEW
             view_EDW_Participant_CT;
    END;
GO
--select top 300 * from view_EDW_Participant_CT where CHANGED_FLG is not null

CREATE VIEW dbo.view_EDW_Participant_CT
AS
--*********************************************************************************************
--WDM Reviewed 8/6/2014 for needed updates, none required
--09.11.2014 (wdm) added date fields to facilitate EDW determination of last mod date 
--05.06.2015 (wdm) added HFitUserPreferredEmail to the view to resolve 52888 per a 
--				conversation with Vijay, Shankar, and John K.
--05.15.2015 (WDM) John and I, while working on this item, found the story has been removed ??? No idea why.
--05.15.2015 (WDM) CUS.HFitUserRegistrationDate (52189)  The contract (story) was removed by Vijay causing John and I to miss this one. We luckily caught it today and fixed the missing columns
--05.15.2015 (WDM) CUS.HFitUserIsRegistered  (52189)	  The contract (story) was removed by Vijay causing John and I to miss this one. We luckily caught it today and fixed the missing columns
--*********************************************************************************************

/*
Natural Key:
    [UserID]
    ,[UserGUID]
    ,[SiteGUID]
    ,[AccountID]
    ,[AccountCD]   
*/

SELECT 
       cus.HFitUserMpiNumber
       ,cu.UserID
       ,cu.UserGUID
       ,CS.SiteGUID
       ,hfa.AccountID
       ,hfa.AccountCD
       ,cus.HFitUserPreferredMailingAddress
       ,cus.HFitUserPreferredMailingCity
       ,cus.HFitUserPreferredMailingState
       ,cus.HFitUserPreferredMailingPostalCode
       ,CAST ( cus.HFitCoachingEnrollDate AS datetime ) AS HFitCoachingEnrollDate
       ,cus.HFitUserAltPreferredPhone
       ,cus.HFitUserAltPreferredPhoneExt
       ,cus.HFitUserAltPreferredPhoneType
       ,cus.HFitUserPreferredPhone
       ,cus.HFitUserPreferredFirstName
       ,CUS.HFitUserPreferredEmail
       ,CAST( CUS.HFitUserRegistrationDate AS datetime2 )	AS HFitUserRegistrationDate
       ,CUS.HFitUserIsRegistered
       ,CASE
        WHEN CAST ( cu.UserCreated AS date ) = CAST ( cu.UserLastModified AS date )
        THEN 'I'
            ELSE 'U'
        END AS ChangeType
       ,CAST ( cu.UserCreated AS datetime ) AS UserCreated
       ,CAST ( cu.UserLastModified AS datetime ) AS UserLastModified
       ,CAST ( HFA.ItemModifiedWhen AS datetime ) AS Account_ItemModifiedWhen	--wdm: 09.11.2014 added to view

       ,CAST( HASHBYTES( 'sha1' ,
			 ISNULL( CAST( cus.HFitUserMpiNumber AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cu.UserID AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cu.UserGUID AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( CS.SiteGUID AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( hfa.AccountID AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( hfa.AccountCD AS nvarchar( 50 )) , '-' ) +
			 ISNULL( cus.HFitUserPreferredMailingAddress , '-' ) +
			 ISNULL( cus.HFitUserPreferredMailingCity , '-' ) +
			 ISNULL( cus.HFitUserPreferredMailingState , '-' ) +
			 ISNULL( CAST( cus.HFitUserPreferredMailingPostalCode AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitCoachingEnrollDate  AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitUserAltPreferredPhone AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitUserAltPreferredPhoneExt AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitUserAltPreferredPhoneType AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitUserPreferredPhone AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( cus.HFitUserPreferredFirstName AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( CUS.HFitUserPreferredEmail AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( CUS.HFitUserRegistrationDate AS nvarchar( 50 )) , '-' ) +
			 ISNULL( CAST( CUS.HFitUserIsRegistered AS nvarchar( 50 )) , '-' )
       ) AS nvarchar( 100 )) AS HashCode
       , COALESCE ( 
		  CT_CMS_User.SYS_CHANGE_OPERATION
		  ,CT_CMS_UserSettings.SYS_CHANGE_OPERATION
		  ,CT_HFit_Account.SYS_CHANGE_OPERATION
		  , CT_CMS_Site.SYS_CHANGE_OPERATION
		  ,  CT_CMS_UserSettings.SYS_CHANGE_OPERATION) AS CHANGED_FLG
 , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	   FROM
       dbo.CMS_User AS CU INNER JOIN
            dbo.CMS_UserSite AS CMSUS WITH ( NOLOCK )
                          ON CU.UserID = CMSUS.UserID
                          INNER JOIN
            dbo.HFit_Account AS HFA WITH ( NOLOCK )
                          ON CMSUS.SiteID = hfa.SiteID
                          INNER JOIN
            dbo.CMS_Site AS CS WITH ( NOLOCK )
                          ON CMSUS.SiteID = CS.SiteID
                          INNER JOIN
            dbo.CMS_UserSettings AS CUS WITH ( NOLOCK )
                          ON CU.UserID = CUS.UserSettingsUserID
					   and CUS.HFitUserMpiNumber > 0 and CUS.HFitUserMpiNumber is not null
	   LEFT JOIN CHANGETABLE(CHANGES CMS_User , NULL)AS CT_CMS_User
		 ON CU.UserID = CT_CMS_User.UserID 
	   LEFT JOIN CHANGETABLE(CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
		 ON CMSUS.UserSiteID = CT_CMS_UserSite.UserSiteID
	   LEFT JOIN CHANGETABLE(CHANGES HFit_Account , NULL)AS CT_HFit_Account
		 ON HFA.AccountID = CT_HFit_Account.AccountID
	   LEFT JOIN CHANGETABLE(CHANGES CMS_Site , NULL)AS CT_CMS_Site
		 ON CS.SiteID = CT_CMS_Site.SiteID
	   LEFT JOIN CHANGETABLE(CHANGES CMS_UserSettings , NULL)AS CT_CMS_UserSettings
		 ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID

GO

--  
--  
GO
PRINT 'Created/Updated: view_EDW_Participant_CT ';
PRINT '***** FROM: view_EDW_Participant_CT.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_RewardTriggerParameters_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardTriggerParameters_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardTriggerParameters_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardTriggerParameters_AddUpdatedRecs
AS
BEGIN

    DECLARE
       @RUNDATE AS  datetime2 ( 7 ) = GETDATE ( );

       UPDATE S
              SET
                  S.SiteGUID = T.SiteGUID
                  ,S.RewardTriggerID = T.RewardTriggerID
                  ,S.TriggerName = T.TriggerName
                  ,S.RewardTriggerParameterOperatorLKPDisplayName = T.RewardTriggerParameterOperatorLKPDisplayName
                  ,S.ParameterDisplayName = T.ParameterDisplayName
                  ,S.RewardTriggerParameterOperator = T.RewardTriggerParameterOperator
                  ,S.Value = T.Value
                  ,S.AccountID = T.AccountID
                  ,S.AccountCD = T.AccountCD
                  ,S.ChangeType = T.ChangeType
                  ,S.DocumentGuid = T.DocumentGuid
                  ,S.NodeGuid = T.NodeGuid
                  ,S.DocumentCreatedWhen = T.DocumentCreatedWhen
                  ,S.DocumentModifiedWhen = T.DocumentModifiedWhen
                  ,S.RewardTriggerParameter_DocumentModifiedWhen = T.RewardTriggerParameter_DocumentModifiedWhen
                  ,S.documentculture_VHFRTPJ = T.documentculture_VHFRTPJ
                  ,S.documentculture_VHFRTJ = T.documentculture_VHFRTJ
                  ,S.HashCode = T.HashCode
                  ,S.LastModifiedDate = GETDATE ( )
                  ,S.DeletedFlg = NULL
                  ,S.ConvertedToCentralTime = NULL

              FROM DIM_EDW_RewardTriggerParameters AS S JOIN ##TEMP_RewardTriggerParameters AS T
                   ON
                   S.SiteGUID = T.SiteGUID
               AND S.RewardTriggerID = T.RewardTriggerID
               AND S.ParameterDisplayName = T.ParameterDisplayName
               AND S.RewardTriggerParameterOperator = T.RewardTriggerParameterOperator
               AND S.Value = T.Value
               AND S.AccountID = T.AccountID
               AND S.AccountCD = T.AccountCD
               AND S.DocumentGuid = T.DocumentGuid
               AND S.NodeGuid = T.NodeGuid
              WHERE
                            S.HashCode != T.HashCode and S.DeletedFlg is null;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardTriggerParameters_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_RewardTriggerParameters_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardTriggerParameters_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardTriggerParameters_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardTriggerParameters_AddDeletedRecs
AS
BEGIN

    WITH CTE (
         SiteGUID
       , RewardTriggerID
       , ParameterDisplayName
       , RewardTriggerParameterOperator
       , [Value]
       , AccountID
       , AccountCD
       , DocumentGuid
       , NodeGuid) 
        AS (
        SELECT
               SiteGUID
             , RewardTriggerID
             , ParameterDisplayName
             , RewardTriggerParameterOperator
             , [Value]
             , AccountID
             , AccountCD
             , DocumentGuid
             , NodeGuid
               FROM DIM_EDW_RewardTriggerParameters
        EXCEPT
        SELECT
               SiteGUID
             , RewardTriggerID
             , ParameterDisplayName
             , RewardTriggerParameterOperator
             , [Value]
             , AccountID
             , AccountCD
             , DocumentGuid
             , NodeGuid
               FROM ##TEMP_RewardTriggerParameters
        ) 
        UPDATE S
          SET
              S.DeletedFlg = 1
              FROM CTE AS T
                        JOIN DIM_EDW_RewardTriggerParameters AS S
                        ON
                        S.SiteGUID = T.SiteGUID AND
                        S.RewardTriggerID = T.RewardTriggerID AND
                        S.ParameterDisplayName = T.ParameterDisplayName AND
                        S.RewardTriggerParameterOperator = T.RewardTriggerParameterOperator AND
                        S.Value = T.Value AND
                        S.AccountID = T.AccountID AND
                        S.AccountCD = T.AccountCD AND
                        S.DocumentGuid = T.DocumentGuid AND
                        S.NodeGuid = T.NodeGuid AND
                        S.DeletedFlg IS NULL;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    UPDATE DIM_EDW_RewardTriggerParameters
      SET
          LastModifiedDate = GETDATE () 
           WHERE
                 LastModifiedDate IS NULL AND
                 DeletedFlg IS NOT NULL;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardTriggerParameters_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_RewardTriggerParameters_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardTriggerParameters_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardTriggerParameters_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardTriggerParameters_AddNewRecs
AS
BEGIN

    WITH CTE (
         SiteGUID
       , RewardTriggerID
       , ParameterDisplayName
       , RewardTriggerParameterOperator
       , [Value]
       , AccountID
       , AccountCD
       , DocumentGuid
       , NodeGuid
    ) 
        AS (
        SELECT
               SiteGUID
             , RewardTriggerID
             , ParameterDisplayName
             , RewardTriggerParameterOperator
             , [Value]
             , AccountID
             , AccountCD
             , DocumentGuid
             , NodeGuid
               FROM ##TEMP_RewardTriggerParameters
        EXCEPT
        SELECT
               SiteGUID
             , RewardTriggerID
             , ParameterDisplayName
             , RewardTriggerParameterOperator
             , [Value]
             , AccountID
             , AccountCD
             , DocumentGuid
             , NodeGuid
               FROM DIM_EDW_RewardTriggerParameters
               WHERE LastModifiedDate IS NULL
        ) 
        INSERT INTO dbo.DIM_EDW_RewardTriggerParameters
        (
               SiteGUID
             , RewardTriggerID
             , TriggerName
             , RewardTriggerParameterOperatorLKPDisplayName
             , ParameterDisplayName
             , RewardTriggerParameterOperator
             , [Value]
             , AccountID
             , AccountCD
             , ChangeType
             , DocumentGuid
             , NodeGuid
             , DocumentCreatedWhen
             , DocumentModifiedWhen
             , RewardTriggerParameter_DocumentModifiedWhen
             , documentculture_VHFRTPJ
             , documentculture_VHFRTJ
             , HashCode
             , LastModifiedDate
             , DeletedFlg
        ) 
        SELECT
               T.SiteGUID
             , T.RewardTriggerID
             , T.TriggerName
             , T.RewardTriggerParameterOperatorLKPDisplayName
             , T.ParameterDisplayName
             , T.RewardTriggerParameterOperator
             , T.[Value]
             , T.AccountID
             , T.AccountCD
             , T.ChangeType
             , T.DocumentGuid
             , T.NodeGuid
             , T.DocumentCreatedWhen
             , T.DocumentModifiedWhen
             , T.RewardTriggerParameter_DocumentModifiedWhen
             , T.documentculture_VHFRTPJ
             , T.documentculture_VHFRTJ
             , T.HashCode
             , NULL AS LastModifiedDate
             , NULL AS DeletedFlg
               FROM
                    ##TEMP_RewardTriggerParameters AS T
                         JOIN CTE AS S
                         ON
                            S.SiteGUID = T.SiteGUID AND
                            S.RewardTriggerID = T.RewardTriggerID AND
                            S.ParameterDisplayName = T.ParameterDisplayName AND
                            S.RewardTriggerParameterOperator = T.RewardTriggerParameterOperator AND
                            S.Value = T.Value AND
                            S.AccountID = T.AccountID AND
                            S.AccountCD = T.AccountCD AND
                            S.DocumentGuid = T.DocumentGuid AND
                            S.NodeGuid = T.NodeGuid;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardTriggerParameters_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_HA_Definition_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HA_Definition_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_Definition_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HA_Definition_AddUpdatedRecs
AS
BEGIN

    DECLARE
       @RUNDATE AS  datetime2 ( 7 ) = GETDATE ( );

            UPDATE S
              SET
                  S.SiteGUID = T.SiteGUID
                ,S.AccountCD = T.AccountCD
                ,S.HANodeID = T.HANodeID
                ,S.HANodeName = T.HANodeName
                ,S.HADocumentID = T.HADocumentID
                ,S.HANodeSiteID = T.HANodeSiteID
                ,S.HADocPubVerID = T.HADocPubVerID
                ,S.ModTitle = T.ModTitle
                ,S.IntroText = T.IntroText
                ,S.ModDocGuid = T.ModDocGuid
                ,S.ModWeight = T.ModWeight
                ,S.ModIsEnabled = T.ModIsEnabled
                ,S.ModCodeName = T.ModCodeName
                ,S.ModDocPubVerID = T.ModDocPubVerID
                ,S.RCTitle = T.RCTitle
                ,S.RCWeight = T.RCWeight
                ,S.RCDocumentGUID = T.RCDocumentGUID
                ,S.RCIsEnabled = T.RCIsEnabled
                ,S.RCCodeName = T.RCCodeName
                ,S.RCDocPubVerID = T.RCDocPubVerID
                ,S.RATytle = T.RATytle
                ,S.RAWeight = T.RAWeight
                ,S.RADocumentGuid = T.RADocumentGuid
                ,S.RAIsEnabled = T.RAIsEnabled
                ,S.RACodeName = T.RACodeName
                ,S.RAScoringStrategyID = T.RAScoringStrategyID
                ,S.RADocPubVerID = T.RADocPubVerID
                ,S.QuestionType = T.QuestionType
                ,S.QuesTitle = T.QuesTitle
                ,S.QuesWeight = T.QuesWeight
                ,S.QuesIsRequired = T.QuesIsRequired
                ,S.QuesDocumentGuid = T.QuesDocumentGuid
                ,S.QuesIsEnabled = T.QuesIsEnabled
                ,S.QuesIsVisible = T.QuesIsVisible
                ,S.QuesIsSTaging = T.QuesIsSTaging
                ,S.QuestionCodeName = T.QuestionCodeName
                ,S.QuesDocPubVerID = T.QuesDocPubVerID
                ,S.AnsValue = T.AnsValue
                ,S.AnsPoints = T.AnsPoints
                ,S.AnsDocumentGuid = T.AnsDocumentGuid
                ,S.AnsIsEnabled = T.AnsIsEnabled
                ,S.AnsCodeName = T.AnsCodeName
                ,S.AnsUOM = T.AnsUOM
                ,S.AnsDocPUbVerID = T.AnsDocPUbVerID
                ,S.ChangeType = T.ChangeType
                ,S.DocumentCreatedWhen = T.DocumentCreatedWhen
                ,S.DocumentModifiedWhen = T.DocumentModifiedWhen
                ,S.CmsTreeNodeGuid = T.CmsTreeNodeGuid
                ,S.HANodeGUID = T.HANodeGUID
                ,S.SiteLastModified = T.SiteLastModified
                ,S.Account_ItemModifiedWhen = T.Account_ItemModifiedWhen
                ,S.Campaign_DocumentModifiedWhen = T.Campaign_DocumentModifiedWhen
                ,S.Assessment_DocumentModifiedWhen = T.Assessment_DocumentModifiedWhen
                ,S.Module_DocumentModifiedWhen = T.Module_DocumentModifiedWhen
                ,S.RiskCategory_DocumentModifiedWhen = T.RiskCategory_DocumentModifiedWhen
                ,S.RiskArea_DocumentModifiedWhen = T.RiskArea_DocumentModifiedWhen
                ,S.Question_DocumentModifiedWhen = T.Question_DocumentModifiedWhen
                ,S.Answer_DocumentModifiedWhen = T.Answer_DocumentModifiedWhen
                ,S.AllowMultiSelect = T.AllowMultiSelect
                ,S.LocID = T.LocID
                ,S.CMS_Class_CtID = T.CMS_Class_CtID
                ,S.CMS_Class_SCV = T.CMS_Class_SCV
                ,S.CMS_Document_CtID = T.CMS_Document_CtID
                ,S.CMS_Document_SCV = T.CMS_Document_SCV
                ,S.CMS_Site_CtID = T.CMS_Site_CtID
                ,S.CMS_Site_SCV = T.CMS_Site_SCV
                ,S.CMS_Tree_CtID = T.CMS_Tree_CtID
                ,S.CMS_Tree_SCV = T.CMS_Tree_SCV
                ,S.CMS_User_CtID = T.CMS_User_CtID
                ,S.CMS_User_SCV = T.CMS_User_SCV
                ,S.COM_SKU_CtID = T.COM_SKU_CtID
                ,S.COM_SKU_SCV = T.COM_SKU_SCV
                ,S.HFit_HealthAssesmentMatrixQuestion_CtID = T.HFit_HealthAssesmentMatrixQuestion_CtID
                ,S.HFit_HealthAssesmentMatrixQuestion_SCV = T.HFit_HealthAssesmentMatrixQuestion_SCV
                ,S.HFit_HealthAssesmentModule_CtID = T.HFit_HealthAssesmentModule_CtID
                ,S.HFit_HealthAssesmentModule_SCV = T.HFit_HealthAssesmentModule_SCV
                ,S.HFit_HealthAssesmentMultipleChoiceQuestion_CtID = T.HFit_HealthAssesmentMultipleChoiceQuestion_CtID
                ,S.HFit_HealthAssesmentMultipleChoiceQuestion_SCV = T.HFit_HealthAssesmentMultipleChoiceQuestion_SCV
                ,S.HFit_HealthAssesmentRiskArea_CtID = T.HFit_HealthAssesmentRiskArea_CtID
                ,S.HFit_HealthAssesmentRiskArea_SCV = T.HFit_HealthAssesmentRiskArea_SCV
                ,S.HFit_HealthAssesmentRiskCategory_CtID = T.HFit_HealthAssesmentRiskCategory_CtID
                ,S.HFit_HealthAssesmentRiskCategory_SCV = T.HFit_HealthAssesmentRiskCategory_SCV
                ,S.HFit_HealthAssessment_CtID = T.HFit_HealthAssessment_CtID
                ,S.HFit_HealthAssessment_SCV = T.HFit_HealthAssessment_SCV
                ,S.HFit_HealthAssessmentFreeForm_CtID = T.HFit_HealthAssessmentFreeForm_CtID
                ,S.HFit_HealthAssessmentFreeForm_SCV = T.HFit_HealthAssessmentFreeForm_SCV
                ,S.CMS_Class_CHANGE_OPERATION = T.CMS_Class_CHANGE_OPERATION
                ,S.CMS_Document_CHANGE_OPERATION = T.CMS_Document_CHANGE_OPERATION
                ,S.CMS_Site_CHANGE_OPERATION = T.CMS_Site_CHANGE_OPERATION
                ,S.CMS_Tree_CHANGE_OPERATION = T.CMS_Tree_CHANGE_OPERATION
                ,S.CMS_User_CHANGE_OPERATION = T.CMS_User_CHANGE_OPERATION
                ,S.COM_SKU_CHANGE_OPERATION = T.COM_SKU_CHANGE_OPERATION
                ,S.HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION = T.HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
                ,S.HFit_HealthAssesmentModule_CHANGE_OPERATION = T.HFit_HealthAssesmentModule_CHANGE_OPERATION
                ,S.HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION = T.HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
                ,S.HFit_HealthAssesmentRiskArea_CHANGE_OPERATION = T.HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
                ,S.HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION = T.HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
                ,S.HFit_HealthAssessment_CHANGE_OPERATION = T.HFit_HealthAssessment_CHANGE_OPERATION
                ,S.HFit_HealthAssessmentFreeForm_CHANGE_OPERATION = T.HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
                ,S.CHANGED_FLG = T.CHANGED_FLG
                ,S.CHANGE_TYPE_CODE = T.CHANGE_TYPE_CODE
                ,S.HashCode = T.HashCode
                ,S.LastModifiedDate = GETDATE () 
                ,S.DeletedFlg = NULL
                ,S.ConvertedToCentralTime = NULL
                  FROM STAGING_EDW_HA_Definition AS S
                            JOIN ##TEMP_EDW_HealthDefinition_DATA AS T
                            ON
                            S.RCDocumentGuid = T.RCDocumentGuid AND
                            S.RADocumentGuid = T.RADocumentGuid AND
                            S.RACodeName = T.RACodeName AND
                            S.QuesDocumentGuid = T.QuesDocumentGuid AND
                            S.AnsDocumentGuid = T.AnsDocumentGuid AND
                            S.HANodeSiteID = T.HANodeSiteID
              WHERE
                            S.HashCode != T.HashCode and S.DeletedFlg is null;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HA_Definition_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HA_Definition_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HA_Definition_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_Definition_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_HA_Definition_AddNewRecs
AS
BEGIN

WITH CTE (
                 RCDocumentGuid
               , RADocumentGuid
               , RACodeName
               , QuesDocumentGuid
               , AnsDocumentGuid
               , HANodeSiteID) 
                AS ( SELECT
                            RCDocumentGuid
                          , RADocumentGuid
                          , RACodeName
                          , QuesDocumentGuid
                          , AnsDocumentGuid
                          , HANodeSiteID
                            FROM ##TEMP_EDW_HealthDefinition_DATA
                     EXCEPT
                     SELECT
                            RCDocumentGuid
                          , RADocumentGuid
                          , RACodeName
                          , QuesDocumentGuid
                          , AnsDocumentGuid
                          , HANodeSiteID
                     --HANodeID
                     --HADocumentID
                     --RCDocPubVerID
                     --QuesDocPubVerID
                            FROM STAGING_EDW_HA_Definition
                            WHERE LastModifiedDate IS NULL) 
                INSERT INTO dbo.STAGING_EDW_HA_Definition (
                       SiteGUID
                     , AccountCD
                     , HANodeID
                     , HANodeName
                     , HADocumentID
                     , HANodeSiteID
                     , HADocPubVerID
                     , ModTitle
                     , IntroText
                     , ModDocGuid
                     , ModWeight
                     , ModIsEnabled
                     , ModCodeName
                     , ModDocPubVerID
                     , RCTitle
                     , RCWeight
                     , RCDocumentGUID
                     , RCIsEnabled
                     , RCCodeName
                     , RCDocPubVerID
                     , RATytle
                     , RAWeight
                     , RADocumentGuid
                     , RAIsEnabled
                     , RACodeName
                     , RAScoringStrategyID
                     , RADocPubVerID
                     , QuestionType
                     , QuesTitle
                     , QuesWeight
                     , QuesIsRequired
                     , QuesDocumentGuid
                     , QuesIsEnabled
                     , QuesIsVisible
                     , QuesIsSTaging
                     , QuestionCodeName
                     , QuesDocPubVerID
                     , AnsValue
                     , AnsPoints
                     , AnsDocumentGuid
                     , AnsIsEnabled
                     , AnsCodeName
                     , AnsUOM
                     , AnsDocPUbVerID
                     , ChangeType
                     , DocumentCreatedWhen
                     , DocumentModifiedWhen
                     , CmsTreeNodeGuid
                     , HANodeGUID
                     , SiteLastModified
                     , Account_ItemModifiedWhen
                     , Campaign_DocumentModifiedWhen
                     , Assessment_DocumentModifiedWhen
                     , Module_DocumentModifiedWhen
                     , RiskCategory_DocumentModifiedWhen
                     , RiskArea_DocumentModifiedWhen
                     , Question_DocumentModifiedWhen
                     , Answer_DocumentModifiedWhen
                     , AllowMultiSelect
                     , LocID
                     , CMS_Class_CtID
                     , CMS_Class_SCV
                     , CMS_Document_CtID
                     , CMS_Document_SCV
                     , CMS_Site_CtID
                     , CMS_Site_SCV
                     , CMS_Tree_CtID
                     , CMS_Tree_SCV
                     , CMS_User_CtID
                     , CMS_User_SCV
                     , COM_SKU_CtID
                     , COM_SKU_SCV
                     , HFit_HealthAssesmentMatrixQuestion_CtID
                     , HFit_HealthAssesmentMatrixQuestion_SCV
                     , HFit_HealthAssesmentModule_CtID
                     , HFit_HealthAssesmentModule_SCV
                     , HFit_HealthAssesmentMultipleChoiceQuestion_CtID
                     , HFit_HealthAssesmentMultipleChoiceQuestion_SCV
                     , HFit_HealthAssesmentRiskArea_CtID
                     , HFit_HealthAssesmentRiskArea_SCV
                     , HFit_HealthAssesmentRiskCategory_CtID
                     , HFit_HealthAssesmentRiskCategory_SCV
                     , HFit_HealthAssessment_CtID
                     , HFit_HealthAssessment_SCV
                     , HFit_HealthAssessmentFreeForm_CtID
                     , HFit_HealthAssessmentFreeForm_SCV
                     , CMS_Class_CHANGE_OPERATION
                     , CMS_Document_CHANGE_OPERATION
                     , CMS_Site_CHANGE_OPERATION
                     , CMS_Tree_CHANGE_OPERATION
                     , CMS_User_CHANGE_OPERATION
                     , COM_SKU_CHANGE_OPERATION
                     , HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
                     , HFit_HealthAssesmentModule_CHANGE_OPERATION
                     , HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
                     , HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
                     , HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
                     , HFit_HealthAssessment_CHANGE_OPERATION
                     , HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
                     , CHANGED_FLG
                     , CHANGE_TYPE_CODE
                     , LastModifiedDate
                       --,[RowNbr]
                     ,
                       DeletedFlg) 
                SELECT
                       T.SiteGUID
                     , T.AccountCD
                     , T.HANodeID
                     , T.HANodeName
                     , T.HADocumentID
                     , T.HANodeSiteID
                     , T.HADocPubVerID
                     , T.ModTitle
                     , T.IntroText
                     , T.ModDocGuid
                     , T.ModWeight
                     , T.ModIsEnabled
                     , T.ModCodeName
                     , T.ModDocPubVerID
                     , T.RCTitle
                     , T.RCWeight
                     , T.RCDocumentGUID
                     , T.RCIsEnabled
                     , T.RCCodeName
                     , T.RCDocPubVerID
                     , T.RATytle
                     , T.RAWeight
                     , T.RADocumentGuid
                     , T.RAIsEnabled
                     , T.RACodeName
                     , T.RAScoringStrategyID
                     , T.RADocPubVerID
                     , T.QuestionType
                     , T.QuesTitle
                     , T.QuesWeight
                     , T.QuesIsRequired
                     , T.QuesDocumentGuid
                     , T.QuesIsEnabled
                     , T.QuesIsVisible
                     , T.QuesIsSTaging
                     , T.QuestionCodeName
                     , T.QuesDocPubVerID
                     , T.AnsValue
                     , T.AnsPoints
                     , T.AnsDocumentGuid
                     , T.AnsIsEnabled
                     , T.AnsCodeName
                     , T.AnsUOM
                     , T.AnsDocPUbVerID
                     , T.ChangeType
                     , T.DocumentCreatedWhen
                     , T.DocumentModifiedWhen
                     , T.CmsTreeNodeGuid
                     , T.HANodeGUID
                     , T.SiteLastModified
                     , T.Account_ItemModifiedWhen
                     , T.Campaign_DocumentModifiedWhen
                     , T.Assessment_DocumentModifiedWhen
                     , T.Module_DocumentModifiedWhen
                     , T.RiskCategory_DocumentModifiedWhen
                     , T.RiskArea_DocumentModifiedWhen
                     , T.Question_DocumentModifiedWhen
                     , T.Answer_DocumentModifiedWhen
                     , T.AllowMultiSelect
                     , T.LocID
                     , T.CMS_Class_CtID
                     , T.CMS_Class_SCV
                     , T.CMS_Document_CtID
                     , T.CMS_Document_SCV
                     , T.CMS_Site_CtID
                     , T.CMS_Site_SCV
                     , T.CMS_Tree_CtID
                     , T.CMS_Tree_SCV
                     , T.CMS_User_CtID
                     , T.CMS_User_SCV
                     , T.COM_SKU_CtID
                     , T.COM_SKU_SCV
                     , T.HFit_HealthAssesmentMatrixQuestion_CtID
                     , T.HFit_HealthAssesmentMatrixQuestion_SCV
                     , T.HFit_HealthAssesmentModule_CtID
                     , T.HFit_HealthAssesmentModule_SCV
                     , T.HFit_HealthAssesmentMultipleChoiceQuestion_CtID
                     , T.HFit_HealthAssesmentMultipleChoiceQuestion_SCV
                     , T.HFit_HealthAssesmentRiskArea_CtID
                     , T.HFit_HealthAssesmentRiskArea_SCV
                     , T.HFit_HealthAssesmentRiskCategory_CtID
                     , T.HFit_HealthAssesmentRiskCategory_SCV
                     , T.HFit_HealthAssessment_CtID
                     , T.HFit_HealthAssessment_SCV
                     , T.HFit_HealthAssessmentFreeForm_CtID
                     , T.HFit_HealthAssessmentFreeForm_SCV
                     , T.CMS_Class_CHANGE_OPERATION
                     , T.CMS_Document_CHANGE_OPERATION
                     , T.CMS_Site_CHANGE_OPERATION
                     , T.CMS_Tree_CHANGE_OPERATION
                     , T.CMS_User_CHANGE_OPERATION
                     , T.COM_SKU_CHANGE_OPERATION
                     , T.HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
                     , T.HFit_HealthAssesmentModule_CHANGE_OPERATION
                     , T.HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
                     , T.HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
                     , T.HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
                     , T.HFit_HealthAssessment_CHANGE_OPERATION
                     , T.HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
                     , T.CHANGED_FLG
                     , T.CHANGE_TYPE_CODE
                     , NULL AS LastModifiedDate
                       --, T.[RowNbr]
                     ,
                       NULL AS DeletedFlg
                       FROM
                            ##TEMP_EDW_HealthDefinition_DATA AS T --JOIN TEMPXX AS S
                                 JOIN CTE AS S
                                 ON
                                 S.RCDocumentGuid = T.RCDocumentGuid AND
                                 S.RADocumentGuid = T.RADocumentGuid AND
                                 S.RACodeName = T.RACodeName AND
                                 S.QuesDocumentGuid = T.QuesDocumentGuid AND
                                 S.AnsDocumentGuid = T.AnsDocumentGuid AND
                                 S.HANodeSiteID = T.HANodeSiteID;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HA_Definition_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_HA_Definition_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HA_Definition_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_Definition_AddDeletedRecs;
    END;
GO
-- exec proc_CT_HA_Definition_AddDeletedRecs
CREATE PROCEDURE proc_CT_HA_Definition_AddDeletedRecs
AS
BEGIN

    WITH CTE (
                 RCDocumentGuid
               , RADocumentGuid
               , RACodeName
               , QuesDocumentGuid
               , AnsDocumentGuid
               , HANodeSiteID) 
                AS ( SELECT
                            RCDocumentGuid
                          , RADocumentGuid
                          , RACodeName
                          , QuesDocumentGuid
                          , AnsDocumentGuid
                          , HANodeSiteID
                            FROM STAGING_EDW_HA_Definition
                            WHERE DeletedFlg IS NULL
                     EXCEPT
                     SELECT
                            RCDocumentGuid
                          , RADocumentGuid
                          , RACodeName
                          , QuesDocumentGuid
                          , AnsDocumentGuid
                          , HANodeSiteID
                            FROM ##TEMP_EDW_HealthDefinition_DATA) 
                UPDATE S
                  SET
                      S.DeletedFlg = 1
                      FROM CTE AS T
                                JOIN STAGING_EDW_HA_Definition AS S
                                ON
                                S.RCDocumentGuid = T.RCDocumentGuid AND
                                S.RADocumentGuid = T.RADocumentGuid AND
                                S.RACodeName = T.RACodeName AND
                                S.QuesDocumentGuid = T.QuesDocumentGuid AND
                                S.AnsDocumentGuid = T.AnsDocumentGuid AND
                                S.HANodeSiteID = T.HANodeSiteID and S.DeletedFlg is null;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    UPDATE STAGING_EDW_HA_Definition
      SET
          LastModifiedDate = GETDATE () 
           WHERE
                 LastModifiedDate IS NULL AND
                 DeletedFlg IS NOT NULL;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HA_Definition_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_RewardsDefinition_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardsDefinition_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardsDefinition_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardsDefinition_AddNewRecs
AS
BEGIN

WITH CTE (
                 SiteGUID
                 ,AccountID
                 ,AccountCD
                 ,RewardProgramGUID
                 ,RewardGroupGuid
                 ,RewardLevelGuid
                 ,RewardActivityGuid
                 ,RewardTriggerGuid
                 ,RewardTriggerParmGUID )
                AS ( SELECT
                            SiteGUID
                            ,AccountID
                            ,AccountCD
                            ,RewardProgramGUID
                            ,RewardGroupGuid
                            ,RewardLevelGuid
                            ,RewardActivityGuid
                            ,RewardTriggerGuid
                            ,RewardTriggerParmGUID
                       FROM ##TEMP_EDW_RewardsDefinition_DATA
                     EXCEPT
                     SELECT
                            SiteGUID
                            ,AccountID
                            ,AccountCD
                            ,RewardProgramGUID
                            ,RewardGroupGuid
                            ,RewardLevelGuid
                            ,RewardActivityGuid
                            ,RewardTriggerGuid
                            ,RewardTriggerParmGUID
                       FROM DIM_EDW_RewardsDefinition
                       WHERE LastModifiedDate IS NULL )
                INSERT INTO dbo.DIM_EDW_RewardsDefinition (
                       SiteGUID
                       ,AccountID
                       ,AccountCD
                       ,RewardProgramGUID
                       ,RewardProgramName
                       ,RewardProgramPeriodStart
                       ,RewardProgramPeriodEnd
                       ,RewardGroupGuid
                       ,GroupName
                       ,RewardLevelGuid
                       ,Level
                       ,RewardLevelTypeLKPName
                       ,AwardDisplayName
                       ,AwardType
                       ,AwardThreshold1
                       ,AwardThreshold2
                       ,AwardThreshold3
                       ,AwardThreshold4
                       ,AwardValue1
                       ,AwardValue2
                       ,AwardValue3
                       ,AwardValue4
                       ,ExternalFulfillmentRequired
                       ,RewardActivityGuid
                       ,ActivityName
                       ,ActivityFreqOrCrit
                       ,ActivityPoints
                       ,IsBundle
                       ,IsRequired
                       ,MaxThreshold
                       ,AwardPointsIncrementally
                       ,AllowMedicalExceptions
                       ,RewardTriggerGuid
                       ,RewardTriggerDynamicValue
                       ,TriggerName
                       ,RewardTriggerParameterOperator
                       ,RewardTriggerParmGUID
                       ,[Value]
                       ,ChangeType
                       ,DocumentCulture_VHFRAJ
                       ,DocumentCulture_VHFRPJ
                       ,DocumentCulture_VHFRGJ
                       ,DocumentCulture_VHFRLJ
                       ,DocumentCulture_VHFRTPJ
                       ,LevelName
                       ,HashCode
                       ,LastModifiedDate
                       ,DeletedFlg )
                SELECT
                       T.SiteGUID
                       ,T.AccountID
                       ,T.AccountCD
                       ,T.RewardProgramGUID
                       ,T.RewardProgramName
                       ,T.RewardProgramPeriodStart
                       ,T.RewardProgramPeriodEnd
                       ,T.RewardGroupGuid
                       ,T.GroupName
                       ,T.RewardLevelGuid
                       ,T.Level
                       ,T.RewardLevelTypeLKPName
                       ,T.AwardDisplayName
                       ,T.AwardType
                       ,T.AwardThreshold1
                       ,T.AwardThreshold2
                       ,T.AwardThreshold3
                       ,T.AwardThreshold4
                       ,T.AwardValue1
                       ,T.AwardValue2
                       ,T.AwardValue3
                       ,T.AwardValue4
                       ,T.ExternalFulfillmentRequired
                       ,T.RewardActivityGuid
                       ,T.ActivityName
                       ,T.ActivityFreqOrCrit
                       ,T.ActivityPoints
                       ,T.IsBundle
                       ,T.IsRequired
                       ,T.MaxThreshold
                       ,T.AwardPointsIncrementally
                       ,T.AllowMedicalExceptions
                       ,T.RewardTriggerGuid
                       ,T.RewardTriggerDynamicValue
                       ,T.TriggerName
                       ,T.RewardTriggerParameterOperator
                       ,T.RewardTriggerParmGUID
                       ,T.[Value]
                       ,T.ChangeType
                       ,T.DocumentCulture_VHFRAJ
                       ,T.DocumentCulture_VHFRPJ
                       ,T.DocumentCulture_VHFRGJ
                       ,T.DocumentCulture_VHFRLJ
                       ,T.DocumentCulture_VHFRTPJ
                       ,T.LevelName
                       ,T.HashCode
                       ,NULL AS LastModifiedDate
                       ,NULL AS DeletedFlg
                  FROM
                       ##TEMP_EDW_RewardsDefinition_DATA AS T JOIN CTE AS S
                       ON
                       S.SiteGUID = T.SiteGUID
                   AND S.AccountID = T.AccountID
                   AND S.AccountCD = T.AccountCD
                   AND S.RewardProgramGUID = T.RewardProgramGUID
                   AND S.RewardGroupGuid = T.RewardGroupGuid
                   AND S.RewardLevelGuid = T.RewardLevelGuid
                   AND S.RewardActivityGuid = T.RewardActivityGuid
                   AND S.RewardTriggerGuid = T.RewardTriggerGuid
                   AND S.RewardTriggerParmGUID = T.RewardTriggerParmGUID;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardsDefinition_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
-- use KenticoCMS_Prod1

GO
PRINT 'Executing proc_CT_RewardsDefinition_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardsDefinition_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardsDefinition_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardsDefinition_AddDeletedRecs
AS
BEGIN

     WITH CTE (
                 SiteGUID
                 ,AccountID
                 ,AccountCD
                 ,RewardProgramGUID
                 ,RewardGroupGuid
                 ,RewardLevelGuid
                 ,RewardActivityGuid
                 ,RewardTriggerGuid
                 ,RewardTriggerParmGUID )
                AS ( SELECT
                            SiteGUID
                            ,AccountID
                            ,AccountCD
                            ,RewardProgramGUID
                            ,RewardGroupGuid
                            ,RewardLevelGuid
                            ,RewardActivityGuid
                            ,RewardTriggerGuid
                            ,RewardTriggerParmGUID
                       FROM DIM_EDW_RewardsDefinition
                     EXCEPT
                     SELECT
                            SiteGUID
                            ,AccountID
                            ,AccountCD
                            ,RewardProgramGUID
                            ,RewardGroupGuid
                            ,RewardLevelGuid
                            ,RewardActivityGuid
                            ,RewardTriggerGuid
                            ,RewardTriggerParmGUID
                       FROM ##TEMP_EDW_RewardsDefinition_DATA )
                UPDATE S
                  SET
                      S.DeletedFlg = 1
                  FROM CTE AS T JOIN DIM_EDW_RewardsDefinition AS S
                       ON
                       S.SiteGUID = T.SiteGUID
                   AND S.AccountID = T.AccountID
                   AND S.AccountCD = T.AccountCD
                   AND S.RewardProgramGUID = T.RewardProgramGUID
                   AND S.RewardGroupGuid = T.RewardGroupGuid
                   AND S.RewardLevelGuid = T.RewardLevelGuid
                   AND S.RewardActivityGuid = T.RewardActivityGuid
                   AND S.RewardTriggerGuid = T.RewardTriggerGuid
                   AND S.RewardTriggerParmGUID = T.RewardTriggerParmGUID AND S.DeletedFlg is null;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    update DIM_EDW_RewardsDefinition set LastModifiedDate = getdate() where LastModifiedDate is null and DeletedFlg is NOT null ;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardsDefinition_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_RewardsDefinition_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardsDefinition_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardsDefinition_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardsDefinition_AddUpdatedRecs
AS
BEGIN

    DECLARE
       @RUNDATE AS  datetime2 ( 7 ) = GETDATE ( );

    UPDATE S
                      SET
                          S.SiteGUID = T.SiteGUID
                          ,S.AccountID = T.AccountID
                          ,S.AccountCD = T.AccountCD
                          ,S.RewardProgramGUID = T.RewardProgramGUID
                          ,S.RewardProgramName = T.RewardProgramName
                          ,S.RewardProgramPeriodStart = T.RewardProgramPeriodStart
                          ,S.RewardProgramPeriodEnd = T.RewardProgramPeriodEnd
                          ,S.RewardGroupGuid = T.RewardGroupGuid
                          ,S.GroupName = T.GroupName
                          ,S.RewardLevelGuid = T.RewardLevelGuid
                          ,S.Level = T.Level
                          ,S.RewardLevelTypeLKPName = T.RewardLevelTypeLKPName
                          ,S.AwardDisplayName = T.AwardDisplayName
                          ,S.AwardType = T.AwardType
                          ,S.AwardThreshold1 = T.AwardThreshold1
                          ,S.AwardThreshold2 = T.AwardThreshold2
                          ,S.AwardThreshold3 = T.AwardThreshold3
                          ,S.AwardThreshold4 = T.AwardThreshold4
                          ,S.AwardValue1 = T.AwardValue1
                          ,S.AwardValue2 = T.AwardValue2
                          ,S.AwardValue3 = T.AwardValue3
                          ,S.AwardValue4 = T.AwardValue4
                          ,S.ExternalFulfillmentRequired = T.ExternalFulfillmentRequired
                          ,S.RewardActivityGuid = T.RewardActivityGuid
                          ,S.ActivityName = T.ActivityName
                          ,S.ActivityFreqOrCrit = T.ActivityFreqOrCrit
                          ,S.ActivityPoints = T.ActivityPoints
                          ,S.IsBundle = T.IsBundle
                          ,S.IsRequired = T.IsRequired
                          ,S.MaxThreshold = T.MaxThreshold
                          ,S.AwardPointsIncrementally = T.AwardPointsIncrementally
                          ,S.AllowMedicalExceptions = T.AllowMedicalExceptions
                          ,S.RewardTriggerGuid = T.RewardTriggerGuid
                          ,S.RewardTriggerDynamicValue = T.RewardTriggerDynamicValue
                          ,S.TriggerName = T.TriggerName
                          ,S.RewardTriggerParameterOperator = T.RewardTriggerParameterOperator
                          ,S.RewardTriggerParmGUID = T.RewardTriggerParmGUID
                          ,S.Value = T.Value
                          ,S.ChangeType = T.ChangeType
                          ,S.DocumentCulture_VHFRAJ = T.DocumentCulture_VHFRAJ
                          ,S.DocumentCulture_VHFRPJ = T.DocumentCulture_VHFRPJ
                          ,S.DocumentCulture_VHFRGJ = T.DocumentCulture_VHFRGJ
                          ,S.DocumentCulture_VHFRLJ = T.DocumentCulture_VHFRLJ
                          ,S.DocumentCulture_VHFRTPJ = T.DocumentCulture_VHFRTPJ
                          ,S.LevelName = T.LevelName
                          ,S.HashCode = T.HashCode
                          ,S.LastModifiedDate = GETDATE ( )
                          ,S.DeletedFlg = NULL
                          ,S.ConvertedToCentralTime = NULL
                      FROM DIM_EDW_RewardsDefinition AS S JOIN ##TEMP_EDW_RewardsDefinition_DATA AS T
                           ON
                           S.SiteGUID = T.SiteGUID
                       AND S.AccountID = T.AccountID
                       AND S.AccountCD = T.AccountCD
                       AND S.RewardProgramGUID = T.RewardProgramGUID
                       AND S.RewardGroupGuid = T.RewardGroupGuid
                       AND S.RewardLevelGuid = T.RewardLevelGuid
                       AND S.RewardActivityGuid = T.RewardActivityGuid
                       AND S.RewardTriggerGuid = T.RewardTriggerGuid
                       AND S.RewardTriggerParmGUID = T.RewardTriggerParmGUID
                      WHERE
                            S.HashCode != T.HashCode and S.DeletedFlg is null;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardsDefinition_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go 
print 'Executing proc_CT_TrackerComposite_AddNewRecs.SQL'
go

if exists (select name from sys.procedures where name = 'proc_CT_TrackerComposite_AddNewRecs')    
    drop procedure proc_CT_TrackerComposite_AddNewRecs;
go
--exec proc_CT_TrackerComposite_AddNewRecs
create procedure proc_CT_TrackerComposite_AddNewRecs
as
WITH CTE_NEW (
                 TrackerNameAggregateTable
                 ,ItemID )
                AS
                (
                SELECT
                       TrackerNameAggregateTable
                       ,ItemID
                  FROM DIM_TEMPTBL_Staging_EDW_Tracker_DATA
                EXCEPT
                SELECT
                       TrackerNameAggregateTable
                       ,ItemID
                  FROM DIM_EDW_Trackers
			 where deletedflg is null
                )
                INSERT INTO dbo.DIM_EDW_Trackers (
                       TrackerNameAggregateTable
                       ,ItemID
                       ,EventDate
                       ,IsProfessionallyCollected
                       ,TrackerCollectionSourceID
                       ,Notes
                       ,UserID
                       ,CollectionSourceName_Internal
                       ,CollectionSourceName_External
                       ,EventName
                       ,UOM
                       ,KEY1
                       ,VAL1
                       ,KEY2
                       ,VAL2
                       ,KEY3
                       ,VAL3
                       ,KEY4
                       ,VAL4
                       ,KEY5
                       ,VAL5
                       ,KEY6
                       ,VAL6
                       ,KEY7
                       ,VAL7
                       ,KEY8
                       ,VAL8
                       ,KEY9
                       ,VAL9
                       ,KEY10
                       ,VAL10
                       ,ItemCreatedBy
                       ,ItemCreatedWhen
                       ,ItemModifiedBy
                       ,ItemModifiedWhen
                       ,IsProcessedForHa
                       ,TXTKEY1
                       ,TXTVAL1
                       ,TXTKEY2
                       ,TXTVAL2
                       ,TXTKEY3
                       ,TXTVAL3
                       ,ItemOrder
                       ,ItemGuid
                       ,UserGuid
                       ,MPI
                       ,ClientCode
                       ,SiteGUID
                       ,AccountID
                       ,AccountCD
                       ,IsAvailable
                       ,IsCustom
                       ,UniqueName
                       ,ColDesc
                       ,VendorID
                       ,VendorName
                       ,CT_ItemID
                       ,CT_ChangeVersion
                       ,CMS_Operation
                       ,ItemLastUpdated )
                SELECT
                       T1.TrackerNameAggregateTable
                       ,T1.ItemID
                       ,T1.EventDate
                       ,T1.IsProfessionallyCollected
                       ,T1.TrackerCollectionSourceID
                       ,T1.Notes
                       ,T1.UserID
                       ,T1.CollectionSourceName_Internal
                       ,T1.CollectionSourceName_External
                       ,T1.EventName
                       ,T1.UOM
                       ,T1.KEY1
                       ,T1.VAL1
                       ,T1.KEY2
                       ,T1.VAL2
                       ,T1.KEY3
                       ,T1.VAL3
                       ,T1.KEY4
                       ,T1.VAL4
                       ,T1.KEY5
                       ,T1.VAL5
                       ,T1.KEY6
                       ,T1.VAL6
                       ,T1.KEY7
                       ,T1.VAL7
                       ,T1.KEY8
                       ,T1.VAL8
                       ,T1.KEY9
                       ,T1.VAL9
                       ,T1.KEY10
                       ,T1.VAL10
                       ,T1.ItemCreatedBy
                       ,T1.ItemCreatedWhen
                       ,T1.ItemModifiedBy
                       ,T1.ItemModifiedWhen
                       ,T1.IsProcessedForHa
                       ,T1.TXTKEY1
                       ,T1.TXTVAL1
                       ,T1.TXTKEY2
                       ,T1.TXTVAL2
                       ,T1.TXTKEY3
                       ,T1.TXTVAL3
                       ,T1.ItemOrder
                       ,T1.ItemGuid
                       ,T1.UserGuid
                       ,T1.MPI
                       ,T1.ClientCode
                       ,T1.SiteGUID
                       ,T1.AccountID
                       ,T1.AccountCD
                       ,T1.IsAvailable
                       ,T1.IsCustom
                       ,T1.UniqueName
                       ,T1.ColDesc
                       ,T1.VendorID
                       ,T1.VendorName
                       ,T1.CT_ItemID
                       ,T1.CT_ChangeVersion
                       ,T1.CMS_Operation
                       ,GETDATE ( )
                  FROM
                       DIM_TEMPTBL_Staging_EDW_Tracker_DATA AS T1 INNER JOIN
                            CTE_NEW AS T2
                                                           ON
                       T1.TrackerNameAggregateTable = T2.TrackerNameAggregateTable
                   AND T1.ItemId = T2.ItemId;

        DECLARE
           @iInserted AS int = @@ROWCOUNT;
	   PRINT 'Records Added: ' + CAST ( @iInserted AS nvarchar( 5 ));
	   return @iInserted ;
go 
print 'Executed proc_CT_TrackerComposite_AddNewRecs.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO

PRINT 'Executing proc_CT_TrackerComposite_AddDeletedRecs.sql';

GO

IF EXISTS ( SELECT
			    name
		    FROM sys.procedures
		    WHERE name = 'proc_CT_TrackerComposite_AddDeletedRecs' )

    BEGIN

	   DROP PROCEDURE
		   proc_CT_TrackerComposite_AddDeletedRecs;
    END;

GO

-- select * from ##TempCompositeData
-- select top 100 * from STAGING_EDW_TrackerComposite
-- exec proc_CT_TrackerComposite_AddDeletedRecs

CREATE PROCEDURE proc_CT_TrackerComposite_AddDeletedRecs
AS

BEGIN

    IF NOT EXISTS ( SELECT
					  name
				  FROM tempdb.dbo.sysobjects
				  WHERE id = OBJECT_ID ( N'tempdb..##TempCompositeData'))

	   BEGIN

		  PRINT 'Reading changed data, standby...';
		  EXEC proc_CkTrackerDataChanged;
	   END;

    UPDATE S
    SET
	   S.DeletedFlg = 1
	 ,S.LastModifiedDate = GETDATE( )
	 FROM DIM_EDW_Trackers AS S
		 JOIN
		 ##TempCompositeData AS T
			ON
			T.TGTTBL = S.TrackerNameAggregateTable		 
		 AND T.ItemID = S.ItemID
		 AND T.SYS_CHANGE_OPERATION = 'D'
		 AND S.DeletedFlg IS NULL;

    DECLARE
	  @iCnt AS int = @@ROWCOUNT;

    PRINT 'Deleted Count: ' + CAST ( @iCnt AS nvarchar(50));

    RETURN @iCnt;
END;

GO

PRINT 'Executed proc_CT_TrackerComposite_AddDeletedRecs.sql';

GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO

PRINT 'Executing proc_CT_TrackerComposite_AddUpdatedRecs.SQL';

GO

IF EXISTS ( SELECT
			    name
		    FROM sys.procedures
		    WHERE name = 'proc_CT_TrackerComposite_AddUpdatedRecs' )

    BEGIN

	   DROP PROCEDURE
		   proc_CT_TrackerComposite_AddUpdatedRecs;
    END;

GO

--select top 100 * from DIM_EDW_Trackers
-- exec proc_CT_TrackerComposite_AddUpdatedRecs

CREATE PROCEDURE proc_CT_TrackerComposite_AddUpdatedRecs
AS

BEGIN

    IF NOT EXISTS ( SELECT
					  name
				  FROM tempdb.dbo.sysobjects
				  WHERE id = OBJECT_ID ( N'tempdb..##TempCompositeData' ))

	   BEGIN

		  PRINT 'Reading changed data, standby...';
		  EXEC proc_CkTrackerDataChanged;
	   END;

    DECLARE
	  @RUNDATE AS datetime2 ( 7 ) = GETDATE ( );

    DECLARE
	  @CurrentChgVersion AS  bigint = CHANGE_TRACKING_CURRENT_VERSION ( );

    PRINT 'Processing Current Change Version: ' + CAST( @CurrentChgVersion AS nvarchar(50));

    UPDATE S
    SET
	   S.TrackerNameAggregateTable = T.TrackerNameAggregateTable
	 ,S.ItemID = T.ItemID
	 ,S.EventDate = T.EventDate
	 ,S.IsProfessionallyCollected = T.IsProfessionallyCollected
	 ,S.TrackerCollectionSourceID = T.TrackerCollectionSourceID
	 ,S.Notes = T.Notes
	 ,S.UserID = T.UserID
	 ,S.CollectionSourceName_Internal = T.CollectionSourceName_Internal
	 ,S.CollectionSourceName_External = T.CollectionSourceName_External
	 ,S.EventName = T.EventName
	 ,S.UOM = T.UOM
	 ,S.KEY1 = T.KEY1
	 ,S.VAL1 = T.VAL1
	 ,S.KEY2 = T.KEY2
	 ,S.VAL2 = T.VAL2
	 ,S.KEY3 = T.KEY3
	 ,S.VAL3 = T.VAL3
	 ,S.KEY4 = T.KEY4
	 ,S.VAL4 = T.VAL4
	 ,S.KEY5 = T.KEY5
	 ,S.VAL5 = T.VAL5
	 ,S.KEY6 = T.KEY6
	 ,S.VAL6 = T.VAL6
	 ,S.KEY7 = T.KEY7
	 ,S.VAL7 = T.VAL7
	 ,S.KEY8 = T.KEY8
	 ,S.VAL8 = T.VAL8
	 ,S.KEY9 = T.KEY9
	 ,S.VAL9 = T.VAL9
	 ,S.KEY10 = T.KEY10
	 ,S.VAL10 = T.VAL10
	 ,S.ItemCreatedBy = T.ItemCreatedBy
	 ,S.ItemCreatedWhen = T.ItemCreatedWhen
	 ,S.ItemModifiedBy = T.ItemModifiedBy
	 ,S.ItemModifiedWhen = T.ItemModifiedWhen
	 ,S.IsProcessedForHa = T.IsProcessedForHa
	 ,S.TXTKEY1 = T.TXTKEY1
	 ,S.TXTVAL1 = T.TXTVAL1
	 ,S.TXTKEY2 = T.TXTKEY2
	 ,S.TXTVAL2 = T.TXTVAL2
	 ,S.TXTKEY3 = T.TXTKEY3
	 ,S.TXTVAL3 = T.TXTVAL3
	 ,S.ItemOrder = T.ItemOrder
	 ,S.ItemGuid = T.ItemGuid
	 ,S.UserGuid = T.UserGuid
	 ,S.MPI = T.MPI
	 ,S.ClientCode = T.ClientCode
	 ,S.SiteGUID = T.SiteGUID
	 ,S.AccountID = T.AccountID
	 ,S.AccountCD = T.AccountCD
	 ,S.IsAvailable = T.IsAvailable
	 ,S.IsCustom = T.IsCustom
	 ,S.UniqueName = T.UniqueName
	 ,S.ColDesc = T.ColDesc
	 ,S.VendorID = T.VendorID
	 ,S.VendorName = T.VendorName
	 ,S.CT_ItemID = T.CT_ItemID
	 ,S.CT_ChangeVersion = @CurrentChgVersion
	 ,S.CMS_Operation = T.CMS_Operation
	 ,S.LastModifiedDate = GETDATE ( )
	 ,S.ConvertedToCentralTime = NULL
	 FROM DIM_EDW_Trackers AS S
		 JOIN
		 ##TempCompositeData AS TTEMP
			ON
			TTEMP.TGTTBL = S.TrackerNameAggregateTable
		 AND TTEMP.ItemID = S.ItemID
		 AND TTEMP.SYS_CHANGE_OPERATION = 'U'
		 JOIN
		 DIM_TEMPTBL_Staging_EDW_Tracker_DATA AS T
			ON
			T.ItemID = S.ItemID
		 AND T.TrackerNameAggregateTable = S.TrackerNameAggregateTable
		 AND T.DeletedFlg IS NULL;

    --AND T.CMS_Operation = 'U' 

    DECLARE
	  @iUpdated AS int = + @@ROWCOUNT;

    RETURN @iUpdated;
END;

GO

PRINT 'Executed proc_CT_TrackerComposite_AddUpdatedRecs.SQL';

GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
-- use KenticoCMS_Prod1

GO
print ('Processing: view_EDW_RewardTriggerParameters_CT ') ;
print ('FROM: view_EDW_RewardTriggerParameters_CT.sql ') ;
go

if exists(select NAME from sys.VIEWS where NAME = 'view_EDW_RewardTriggerParameters_CT')
BEGIN
	drop view view_EDW_RewardTriggerParameters_CT ;
END
GO

--*******************************************************************************************************************
--8/7/2014  VHFRTJ.DocumentGuid		  --WDM Added in case needed
--8/7/2014  VHFRTJ.NodeGuid			  --WDM Added in case needed
--09.11.2014 : (wdm) Verified last mod date available to EDW - RewardTriggerParameter_DocumentModifiedWhen
--11.17.2014 : (wdm) John C. found that Spanish was being brought across in TriggerName and 
--				ParameterDisplayName. Found that View_HFit_RewardTrigger_Joined has no way to limit the 
--				returned data to Spanish. Created a new view, View_EDW_RewardProgram_Joined, and provided 
--				a FILTER on Document Culture. The, added Launguage fitlers as: 
--					where VHFRTJ.DocumentCulture = 'en-US' AND VHFRTPJ.DocumentCulture = 'en-US'
--				This appears to have eliminated the Spanish.
-- 03.03.2015 : (Dale/Natahn) no changes required.
-- 04.12.2015 : (WDM) In order to implement change tracking on this view, a STAGING table will simply be 
--			 dropped and recreated everytime using this view. It is too small to worry about otherwise.
-- 04.12.2015 : created view view_EDW_RewardTriggerParameters_CT so that change tracking would be consistent.
--SELECT * FROM [view_EDW_RewardTriggerParameters_CT]
--*******************************************************************************************************************
/*
select count(*), SiteGUID, RewardTriggerID, ParameterDisplayName, RewardTriggerParameterOperator, [Value], AccountID, AccountCD, DocumentGuid, NodeGuid
from [view_EDW_RewardTriggerParameters_CT]
group by SiteGUID
                    , RewardTriggerID
                    , ParameterDisplayName
                    , RewardTriggerParameterOperator
                    , [Value]
                    , AccountID
                    , AccountCD
                    , DocumentGuid
                    , NodeGuid
having count(*) > 1

select distinct count(*), SiteGUID,RewardTriggerID,AccountID,AccountCD,DocumentGuid,NodeGuid,RewardTriggerParameterOperatorLKPDisplayName
from [view_EDW_RewardTriggerParameters_CT]
group by SiteGUID,RewardTriggerID,AccountID,AccountCD,DocumentGuid,NodeGuid,RewardTriggerParameterOperatorLKPDisplayName
having count(*) > 1
go
*/

create VIEW [dbo].[view_EDW_RewardTriggerParameters_CT]
AS
--8/7/2014 - added and commented out DocumentGuid and NodeGuid in case needed later
--8/8/2014 - Generated corrected view in DEV (WDM)
	SELECT distinct
		cs.SiteGUID															 --CMS_Site
		, VHFRTJ.RewardTriggerID													 --HFit_RewardTrigger
		, VHFRTJ.TriggerName													 --HFit_RewardTrigger
		, HFLRTPO.RewardTriggerParameterOperatorLKPDisplayName							 --HFit_LKP_RewardTriggerParameterOperator 
		, VHFRTPJ.ParameterDisplayName											 --HFit_RewardTriggerParameter
		, VHFRTPJ.RewardTriggerParameterOperator									 --HFit_RewardTriggerParameter
		, VHFRTPJ.Value														 --HFit_RewardTriggerParameter
		, hfa.AccountID														 --HFit_Account
		, hfa.AccountCD														 --HFit_Account
		, CASE	WHEN CAST(VHFRTJ.DocumentCreatedWhen AS DATE) = CAST(VHFRTJ.DocumentModifiedWhen AS DATE)
				THEN 'I'
				ELSE 'U'
			END AS ChangeType		
		, VHFRTJ.DocumentGuid													 --CMS_Document
		, VHFRTJ.NodeGuid														 --CMS_Document
		, VHFRTJ.DocumentCreatedWhen												 --CMS_Document
		, VHFRTJ.DocumentModifiedWhen												 --CMS_Document
		,VHFRTPJ.DocumentModifiedWhen as RewardTriggerParameter_DocumentModifiedWhen	  	 --CMS_Document
		,VHFRTPJ.documentculture as documentculture_VHFRTPJ							 --CMS_Document
		,VHFRTJ.documentculture as documentculture_VHFRTJ								 --CMS_Document
	   ,hashbytes ('sha1',
			 isnull(cast(cs.SiteGUID as nvarchar(50)),'-')
			 + isnull(cast(VHFRTJ.RewardTriggerID as nvarchar(50)),'-')
			 + isnull(cast(VHFRTJ.TriggerName as nvarchar(250)),'-')
			 + isnull(cast(HFLRTPO.RewardTriggerParameterOperatorLKPDisplayName as nvarchar(250)),'-')
			 + isnull(cast(VHFRTPJ.ParameterDisplayName as nvarchar(250)),'-')
			 + isnull(cast(VHFRTPJ.RewardTriggerParameterOperator as nvarchar(50)),'-')
			 + isnull(cast(VHFRTPJ.Value as nvarchar(50)),'-')
			 + isnull(cast(VHFRTJ.DocumentGuid as nvarchar(50)),'-')
			 + isnull(cast(VHFRTJ.NodeGuid as nvarchar(50)),'-')
			 + isnull(cast(VHFRTJ.DocumentCreatedWhen as nvarchar(50)),'-')
			 + isnull(cast(VHFRTJ.DocumentModifiedWhen as nvarchar(50)),'-')
			 + isnull(cast(VHFRTPJ.DocumentModifiedWhen as nvarchar(50)),'-')
	   ) as HashCode

	, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
		dbo.View_HFit_RewardTrigger_Joined AS VHFRTJ 
		--dbo.[View_EDW_RewardProgram_Joined] AS VHFRTJ 		
	INNER JOIN dbo.View_HFit_RewardTriggerParameter_Joined AS VHFRTPJ  ON vhfrtj.NodeID = VHFRTPJ.NodeParentID
	INNER JOIN dbo.HFit_LKP_RewardTriggerParameterOperator AS HFLRTPO  ON VHFRTPJ.RewardTriggerParameterOperator = HFLRTPO.RewardTriggerParameterOperatorLKPID
	INNER JOIN dbo.CMS_Site AS CS  ON VHFRTJ.NodeSiteID = cs.SiteID
	INNER JOIN dbo.HFit_Account AS HFA  ON cs.SiteID = HFA.SiteID
	where VHFRTJ.DocumentCulture = 'en-US'
	AND VHFRTPJ.DocumentCulture = 'en-US'
      

GO


  --  
  --  
GO 
print('***** Created: view_EDW_RewardTriggerParameters_CT.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




go

print 'EXecute PrintNow.sql' ;

go

if exists (select name from sys.procedures where name = 'PrintNow')
    DROP PROCEDURE [dbo].[PrintNow] ;

GO

create procedure [dbo].[PrintNow] (@msg as nvarchar(500))
as
begin
raiserror (@msg, 10,1) with nowait;
end 


GO


print 'Executed PrintNow.sql' ;

go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;







GO
PRINT 'Creating QuickCount.sql';

GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'QuickCount' )
    BEGIN
        DROP PROCEDURE
             QuickCount
    END;
GO

/*
declare @i as bigint = 0 ;
EXEC @i = QuickCount 'Device_RawNotification' ;
print @i ;

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = QuickCount 'STAGING_EDW_RewardUserDetail';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

*/

CREATE PROCEDURE QuickCount ( @TblName AS nvarchar( 254 ))
AS
BEGIN

    /*********************************************
    Author:	  Dale Miller
    Date:	  02.02.2008
    Copyright:  DMA, Ltd., Chicago, IL
    **********************************************/

    DECLARE
   @i AS bigint = 0;

    SET @i = ( SELECT
                      SUM ( row_count )
                 FROM sys.dm_db_partition_stats
                 WHERE
                      object_id = OBJECT_ID( @TblName )
                  AND (
                      index_id = 0
                   OR index_id = 1));
    if @i is null
	   set @i = 0 ;
    PRINT @i;
    return @i ;
END;

GO
PRINT 'Created QuickCount.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Create proc_CREATE_EDW_HealthAssessment_TABLE.SQL';
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CREATE_EDW_HealthAssessment_TABLE') 
    BEGIN
        DROP PROCEDURE
             proc_CREATE_EDW_HealthAssessment_TABLE;
    END;
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthAssessment') 
    BEGIN
       drop table DIM_EDW_HealthAssessment;
    END;
GO

-- drop table DIM_EDW_HealthAssessment
-- exec proc_CREATE_EDW_HealthAssessment_TABLE
CREATE PROCEDURE proc_CREATE_EDW_HealthAssessment_TABLE
AS
BEGIN
    IF NOT EXISTS ( SELECT
                           name
                           FROM sys.tables
                           WHERE name = 'DIM_EDW_HealthAssessment') 
        BEGIN
            PRINT 'CREATING DIM_EDW_HealthAssessment ';

            CREATE TABLE dbo.DIM_EDW_HealthAssessment (
                         USERSTARTEDITEMID int NULL
                       , HEALTHASSESMENTUSERSTARTEDNODEGUID uniqueidentifier NULL
                       , USERID bigint NULL
                       , USERGUID uniqueidentifier NULL
                       , HFITUSERMPINUMBER bigint NULL
                       , SITEGUID uniqueidentifier NULL
                       , ACCOUNTID int NULL
                       , ACCOUNTCD nvarchar (8) NULL
                       , ACCOUNTNAME nvarchar (200) NULL
                       , HASTARTEDDT datetime NULL
                       , HACOMPLETEDDT datetime NULL
                       , USERMODULEITEMID int NULL
                       , USERMODULECODENAME nvarchar (100) NULL
                       , HAMODULENODEGUID uniqueidentifier NULL
                       , CMSNODEGUID uniqueidentifier NULL
                       , HAMODULEVERSIONID int NULL
                       , USERRISKCATEGORYITEMID int NULL
                       , USERRISKCATEGORYCODENAME nvarchar (100) NULL
                       , HARISKCATEGORYNODEGUID uniqueidentifier NULL
                       , HARISKCATEGORYVERSIONID int NULL
                       , USERRISKAREAITEMID int NULL
                       , USERRISKAREACODENAME nvarchar (100) NULL
                       , HARISKAREANODEGUID uniqueidentifier NULL
                       , HARISKAREAVERSIONID int NULL
                       , USERQUESTIONITEMID int NULL
                       , TITLE varchar (max) NULL
                       , HAQUESTIONGUID uniqueidentifier NULL
                       , USERQUESTIONCODENAME nvarchar (100) NULL
                       , HAQUESTIONDOCUMENTID int NULL
                       , HAQUESTIONVERSIONID int NULL
                       , HAQUESTIONNODEGUID uniqueidentifier NULL
                       , USERANSWERITEMID int NULL
                       , HAANSWERNODEGUID uniqueidentifier NULL
                       , HAANSWERVERSIONID int NULL
                       , USERANSWERCODENAME nvarchar (100) NULL
                       , HAANSWERVALUE nvarchar (255) NULL
                       , HAMODULESCORE float NULL
                       , HARISKCATEGORYSCORE float NULL
                       , HARISKAREASCORE float NULL
                       , HAQUESTIONSCORE float NULL
                       , HAANSWERPOINTS int NULL
                       , POINTRESULTS int NULL
                       , UOMCODE nvarchar (10) NULL
                       , HASCORE int NULL
                       , MODULEPREWEIGHTEDSCORE float NULL
                       , RISKCATEGORYPREWEIGHTEDSCORE float NULL
                       , RISKAREAPREWEIGHTEDSCORE float NULL
                       , QUESTIONPREWEIGHTEDSCORE float NULL
                       , QUESTIONGROUPCODENAME nvarchar (100) NULL
                       , ITEMCREATEDWHEN datetime NULL
                       , ITEMMODIFIEDWHEN datetime NULL
                       , ISPROFESSIONALLYCOLLECTED bit NULL
                       , HARISKCATEGORY_ITEMMODIFIEDWHEN datetime NULL
                       , HAUSERRISKAREA_ITEMMODIFIEDWHEN datetime NULL
                       , HAUSERQUESTION_ITEMMODIFIEDWHEN datetime NULL
                       , HAUSERANSWERS_ITEMMODIFIEDWHEN datetime NULL
                       , HAPAPERFLG bit NULL
                       , HATELEPHONICFLG bit NULL
                       , HASTARTEDMODE int NULL
                       , HACOMPLETEDMODE int NULL
                       , DOCUMENTCULTURE_VHCJ nvarchar (10) NULL
                       , DOCUMENTCULTURE_HAQUESTIONSVIEW nvarchar (10) NULL
                       , CAMPAIGNNODEGUID uniqueidentifier NULL
                       , HACAMPAIGNID int NULL
                       , HASHCODE varchar (100) NULL
                       , PKHASHCODE varchar (100) NULL
                       , CHANGED_FLG int NULL
                       , LASTMODIFIEDDATE datetime NULL
                       , HEALTHASSESSMENTTYPE varchar (9) NULL
                       , HAUSERSTARTED_LASTMODIFIED datetime NULL
                       , CMSUSER_LASTMODIFIED datetime NULL
                       , USERSETTINGS_LASTMODIFIED datetime NULL
                       , USERSITE_LASTMODIFIED datetime NULL
                       , CMSSITE_LASTMODIFIED datetime NULL
                       , ACCT_LASTMODIFIED datetime NULL
                       , HAUSERMODULE_LASTMODIFIED datetime NULL
                       , VHCJ_LASTMODIFIED datetime NULL
                       , VHAJ_LASTMODIFIED datetime NULL
                       , HARISKCATEGORY_LASTMODIFIED datetime NULL
                       , HAUSERRISKAREA_LASTMODIFIED datetime NULL
                       , HAUSERQUESTION_LASTMODIFIED datetime NULL
                       , HAQUESTIONSVIEW_LASTMODIFIED datetime NULL
                       , HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED datetime NULL
                       , HAUSERANSWERS_LASTMODIFIED datetime NULL
                       , HAUSERSTARTED_LastUpdateID int NULL
                       , CMSUSER_LastUpdateID int NULL
                       , USERSETTINGS_LastUpdateID int NULL
                       , USERSITE_LastUpdateID int NULL
                       , CMSSITE_LastUpdateID datetime NULL
                       , ACCT_LastUpdateID datetime NULL
                       , HAUSERMODULE_LastUpdateID int NULL
                       , VHCJ_LastUpdateID int NULL
                       , VHAJ_LastUpdateID int NULL
                       , HARISKCATEGORY_LastUpdateID int NULL
                       , HAUSERRISKAREA_LastUpdateID int NULL
                       , HAUSERQUESTION_LastUpdateID int NULL
                       , HAQUESTIONSVIEW_LastUpdateID int NULL
                       , HAUSERQUESTIONGROUPRESULTS_LastUpdateID int NULL
                       , HAUSERANSWERS_LastUpdateID int NULL
                       , LASTUPDATEID int NULL
                       , DELETEFLG int NULL
                       , SVR nvarchar (128) NULL
                       , DBNAME nvarchar (128) NULL
                       , DELETEDFLG int NULL
                       , RowNbr int NULL
                       , TimeZone nvarchar (10) NULL
                       , ConvertedToCentralTime bit NULL
                       , ChangeType nchar (1) NULL
            ) 
            ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_CDT ON dbo.DIM_EDW_HealthAssessment
            (
            ConvertedToCentralTime ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_Dates ON dbo.DIM_EDW_HealthAssessment
            (
            ITEMMODIFIEDWHEN ASC,
            HAUSERSTARTED_LASTMODIFIED ASC,
            CMSUSER_LASTMODIFIED ASC,
            USERSETTINGS_LASTMODIFIED ASC,
            USERSITE_LASTMODIFIED ASC,
            CMSSITE_LASTMODIFIED ASC,
            ACCT_LASTMODIFIED ASC,
            HAUSERMODULE_LASTMODIFIED ASC,
            VHCJ_LASTMODIFIED ASC,
            VHAJ_LASTMODIFIED ASC,
            HARISKCATEGORY_LASTMODIFIED ASC,
            HAUSERRISKAREA_LASTMODIFIED ASC,
            HAUSERQUESTION_LASTMODIFIED ASC,
            HAQUESTIONSVIEW_LASTMODIFIED ASC,
            HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED ASC,
            HAUSERANSWERS_LASTMODIFIED ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

            CREATE CLUSTERED INDEX PI_EDW_HealthAssessment_NATKEY ON dbo.DIM_EDW_HealthAssessment
            (
            USERSTARTEDITEMID ASC,
            USERGUID ASC,
            PKHASHCODE ASC,
            DeletedFlg, ChangeType
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

        END;
    ELSE
        BEGIN
            PRINT 'DIM_EDW_HealthAssessment ALREADY exists, skipping.';
        END;
END;
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'FROM: createDayLightSavingsTimeFunctions.sql';

GO
IF EXISTS ( SELECT
                   *
                   FROM    dbo.sysobjects
                   WHERE
                   id = OBJECT_ID (N'[dbo].[udfGetDstStart]') 
               AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT')) 
    BEGIN
        PRINT 'Replacing udfGetDstStart';
        DROP FUNCTION
             udfGetDstStart;
    END;

GO

CREATE FUNCTION udfGetDstStart (
     @Year AS int) 
RETURNS datetime
AS
--Author: W. Dale Miller
--Date  : Jan 15, 2009
BEGIN
    DECLARE
    @StartOfMarch datetime
  ,@DstStart datetime;

    SET @StartOfMarch = DATEADD (MONTH, 2,
    DATEADD (YEAR, @year - 1900, 0)) ;
    SET @DstStart = DATEADD (HOUR, 2,
    DATEADD (day, ( 15 - DATEPART (dw,
                    @StartOfMarch) ) % 7 + 7, @StartOfMarch)) ;
    RETURN @DstStart;
END;

GO
IF EXISTS ( SELECT
                   *
                   FROM    dbo.sysobjects
                   WHERE
                   id = OBJECT_ID (N'[dbo].[udfGetDstEnd]') 
               AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT')) 
    BEGIN
        PRINT 'Replacing udfGetDstEnd';
        DROP FUNCTION
             dbo.udfGetDstEnd;
    END;
GO
CREATE FUNCTION dbo.udfGetDstEnd (
     @Year AS int) 
RETURNS datetime
AS
--Author: W. Dale Miller
--Date  : Jan 15, 2009
BEGIN
    DECLARE
    @StartOfNovember datetime
  ,@DstEnd datetime;

    SET @StartOfNovember = DATEADD (MONTH, 10,
    DATEADD (YEAR, @year - 1900, 0)) ;
    SET @DstEnd = DATEADD (HOUR, 2,
    DATEADD (day,
    ( 8 - DATEPART (dw,
      @StartOfNovember) ) % 7, @StartOfNovember)) ;
    RETURN @DstEnd;
END;

GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating PROC proc_EDW_Procedure_Performance_Monitor.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EDW_Procedure_Performance_Monitor') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_Procedure_Performance_Monitor;
    END;
GO

CREATE PROCEDURE proc_EDW_Procedure_Performance_Monitor
       @Action AS CHAR (1) = 'I'
     , @TraceName NVARCHAR (100) 
     , @TrackID AS NVARCHAR (50) = NULL
AS
BEGIN
    SET NOCOUNT ON;

/*---------------------------------------------------------------------------------------------
I = insert new record
E = add enddate to specified record by TraceName and TrackID
D = delete all occurances of records by TraceName
T = total the elapsed and accumulated time for the specified TraceName

select * from EDW_Proc_Performance_Monitor where TraceName = 'proc_Staging_EDW_Data' order by RowNbr
exec proc_EDW_Procedure_Performance_Monitor 'D', 'proc_Staging_EDW_Data'
exec proc_EDW_Procedure_Performance_Monitor 'I', 'TestRun', '001'
exec proc_EDW_Procedure_Performance_Monitor 'I', 'TestRun', '002'
exec proc_EDW_Procedure_Performance_Monitor 'I', 'TestRun', '003'
exec proc_EDW_Procedure_Performance_Monitor 'I', 'TestRun', '004'
exec proc_EDW_Procedure_Performance_Monitor 'I', 'TestRun', '005'
exec proc_EDW_Procedure_Performance_Monitor 'T', 'proc_Staging_EDW_Data'

update EDW_Proc_Performance_Monitor set ElapsedSecs = cast(ElapsedTime as float)/ 1000 
update EDW_Proc_Performance_Monitor set ElapsedMin = cast(ElapsedTime as float) / 1000 / 60 
update EDW_Proc_Performance_Monitor set ElapsedHrs = cast(ElapsedTime as float) / 1000 / 60 /60
*/
    DECLARE
           @TimeNow AS DATETIME2 = GETDATE () ;

    IF @TrackID IS NULL
        BEGIN
            SET @TrackID = CAST (@TimeNow AS NVARCHAR (50)) 
        END;

    IF @Action = 'D'
        BEGIN
            DELETE FROM EDW_Proc_Performance_Monitor
                   WHERE
                         TraceName = @TraceName;
            RETURN;
        END;

    IF @Action = 'I'
        BEGIN
            INSERT INTO dbo.EDW_Proc_Performance_Monitor
            (
                   TraceName
                 , TrackID
                 , StartTime
                 , EndTime
                 , ElapsedTime
                 , ElapsedTimeUnits) 
            VALUES
            (
            @TraceName
            , @TrackID
            , @TimeNow
            , NULL
            , NULL
            , 'ms') ;
        END;
    IF @Action = 'E'
        BEGIN
            DECLARE
                   @sd AS DATETIME = (SELECT
                                             StartTime
                                             FROM EDW_Proc_Performance_Monitor
                                             WHERE
                                             TraceName = @TraceName AND
                                             TrackID = @TrackID) ;
            DECLARE
                   @Dstring AS NVARCHAR (50) = CAST (@sd AS NVARCHAR (50)) ;
            DECLARE
                   @ms AS INT = DATEDIFF (millisecond , @Dstring , @Dstring) ;

            UPDATE dbo.EDW_Proc_Performance_Monitor
              SET
                  EndTime = GETDATE () 
                ,ElapsedTime = @ms
                   WHERE
                         TraceName = @TraceName AND
                         TrackID = @TrackID;
        END;
    IF @Action = 'T'
        BEGIN

            DECLARE
                   @ST AS DATETIME2 (7) = NULL;
            DECLARE
                   @ET AS DATETIME2 (7) = NULL;
            DECLARE
                   @ElapsedTime AS INT = 0;
            DECLARE
                   @RN AS INT = 0;
            DECLARE
                   @PrevRN AS INT = 0;
            DECLARE
                   @i AS INT = 0;
            DECLARE
                   @initTime AS DATETIME2 = NULL;
            DECLARE
                   @accumTime AS INT = 0;

            SET @ElapsedTime = DATEDIFF (microsecond , @ET , @ST) ;
            PRINT @ElapsedTime;

            DECLARE db_cursor CURSOR
                FOR
                    SELECT
                           TraceName
                         , RowNbr
                         , StartTime
                           FROM dbo.EDW_Proc_Performance_Monitor
                           WHERE TraceName = @TraceName
                           ORDER BY
                                    RowNbr;

            OPEN db_cursor;
            FETCH NEXT FROM db_cursor INTO @TraceName , @RN , @ST;

            WHILE @@FETCH_STATUS = 0
                BEGIN
                    SET @ST = (SELECT
                                      StartTime
                                      FROM EDW_Proc_Performance_Monitor
                                      WHERE RowNbr = @RN) ;
                    SET @PrevRN = (SELECT
                                          MAX (Rownbr) 
                                          FROM EDW_Proc_Performance_Monitor
                                          WHERE RowNbr < @RN) ;
                    SET @ET = (SELECT
                                      StartTime
                                      FROM EDW_Proc_Performance_Monitor
                                      WHERE RowNbr = @PrevRN) ;

                    IF @i = 0
                        BEGIN
                            SET @initTime = @ST;
                            SET @accumTime = 0;
                            SET @ElapsedTime = 0;
                        END;
                    ELSE
                        BEGIN
                            SET @ElapsedTime = DATEDIFF (MILLISECOND , @ET , @ST) ;
                            SET @accumTime = DATEDIFF (MILLISECOND , @initTime , @ST) ;
                        END;

                    --if @i > 100 and @i < 150 
                    --print @RN, @PrevRN, @ET, @accumTime ;

                    UPDATE dbo.EDW_Proc_Performance_Monitor
                      SET
                          ElapsedTime = @ElapsedTime
                        ,AccumulatedTime = @accumTime
                        ,ElapsedSecs = CAST (@ElapsedTime AS FLOAT) / 1000
                        ,ElapsedMin = CAST (@ElapsedTime AS FLOAT) / 1000 / 60
                        ,ElapsedHrs = CAST (@ElapsedTime AS FLOAT) / 1000 / 60 / 60
                           WHERE
                                 RowNbr = @RN;
                    SET @i = @i + 1;
                    FETCH NEXT FROM db_cursor INTO @TraceName , @RN , @ST;
                END;

            CLOSE db_cursor;
            DEALLOCATE db_cursor;
        END;

END;  --Procedure

GO
PRINT 'Created PROC proc_EDW_Procedure_Performance_Monitor.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
print 'create_TEMP_EDW_HealthAssessment_DATA.sql'
go 

if exists (select name from sys.tables where name = 'TEMP_EDW_HealthAssessment_DATA')
    drop table [dbo].[TEMP_EDW_HealthAssessment_DATA];

go

CREATE TABLE [dbo].[TEMP_EDW_HealthAssessment_DATA](
	[UserStartedItemID] [int] NULL,
	[HealthAssesmentUserStartedNodeGUID] [uniqueidentifier] NULL,
	[UserID] [bigint] NULL,
	[UserGUID] [uniqueidentifier] NULL,
	[HFitUserMpiNumber] [bigint] NULL,
	[SiteGUID] [uniqueidentifier] NULL,
	[AccountID] [int] NULL,
	[AccountCD] [nvarchar](8) NULL,
	[AccountName] [nvarchar](200) NULL,
	[HAStartedDt] [datetime] NULL,
	[HACompletedDt] [datetime] NULL,
	[UserModuleItemId] [int] NULL,
	[UserModuleCodeName] [nvarchar](100) NULL,
	[HAModuleNodeGUID] [uniqueidentifier] NULL,
	[CMSNodeGuid] [uniqueidentifier] NULL,
	[HAModuleVersionID] [int] NULL,
	[UserRiskCategoryItemID] [int] NULL,
	[UserRiskCategoryCodeName] [nvarchar](100) NULL,
	[HARiskCategoryNodeGUID] [uniqueidentifier] NULL,
	[HARiskCategoryVersionID] [int] NULL,
	[UserRiskAreaItemID] [int] NULL,
	[UserRiskAreaCodeName] [nvarchar](100) NULL,
	[HARiskAreaNodeGUID] [uniqueidentifier] NULL,
	[HARiskAreaVersionID] [int] NULL,
	[UserQuestionItemID] [int] NULL,
	[Title] [varchar](max) NULL,
	[HAQuestionGuid] [uniqueidentifier] NULL,
	[UserQuestionCodeName] [nvarchar](100) NULL,
	[HAQuestionDocumentID] [int] NULL,
	[HAQuestionVersionID] [int] NULL,
	[HAQuestionNodeGUID] [uniqueidentifier] NULL,
	[UserAnswerItemID] [int] NULL,
	[HAAnswerNodeGUID] [uniqueidentifier] NULL,
	[HAAnswerVersionID] [int] NULL,
	[UserAnswerCodeName] [nvarchar](100) NULL,
	[HAAnswerValue] [nvarchar](255) NULL,
	[HAModuleScore] [float] NULL,
	[HARiskCategoryScore] [float] NULL,
	[HARiskAreaScore] [float] NULL,
	[HAQuestionScore] [float] NULL,
	[HAAnswerPoints] [int] NULL,
	[PointResults] [int] NULL,
	[UOMCode] [nvarchar](10) NULL,
	[HAScore] [int] NULL,
	[ModulePreWeightedScore] [float] NULL,
	[RiskCategoryPreWeightedScore] [float] NULL,
	[RiskAreaPreWeightedScore] [float] NULL,
	[QuestionPreWeightedScore] [float] NULL,
	[QuestionGroupCodeName] [nvarchar](100) NULL,
	[ItemCreatedWhen] [datetime] NULL,
	[ItemModifiedWhen] [datetime] NULL,
	[IsProfessionallyCollected] [bit] NULL,
	[HARiskCategory_ItemModifiedWhen] [datetime] NULL,
	[HAUserRiskArea_ItemModifiedWhen] [datetime] NULL,
	[HAUserQuestion_ItemModifiedWhen] [datetime] NULL,
	[HAUserAnswers_ItemModifiedWhen] [datetime] NULL,
	[HAPaperFlg] [bit] NULL,
	[HATelephonicFlg] [bit] NULL,
	[HAStartedMode] [int] NULL,
	[HACompletedMode] [int] NULL,
	[DocumentCulture_VHCJ] [nvarchar](10) NULL,
	[DocumentCulture_HAQuestionsView] [nvarchar](10) NULL,
	[CampaignNodeGUID] [uniqueidentifier] NULL,
	[HACampaignID] [int] NULL,
	[HashCode] [varchar](100) NULL,
	[ChangeType] [nchar](1) NULL,
	[CHANGED_FLG] [int] NULL,
	[DeleteFlg] [int] NULL,
	[CT_CMS_User_UserID] [int] NULL,
	[CT_CMS_User_CHANGE_OPERATION] [nchar](1) NULL,
	[CT_UserSettingsID] [int] NULL,
	[CT_UserSettingsID_CHANGE_OPERATION] [nchar](1) NULL,
	[SiteID_CtID] [int] NULL,
	[SiteID_CHANGE_OPERATION] [nchar](1) NULL,
	[UserSiteID_CtID] [int] NULL,
	[UserSiteID_CHANGE_OPERATION] [nchar](1) NULL,
	[AccountID_CtID] [int] NULL,
	[AccountID__CHANGE_OPERATION] [nchar](1) NULL,
	[HAUserAnswers_CtID] [int] NULL,
	[HAUserAnswers_CHANGE_OPERATION] [nchar](1) NULL,
	[HFit_HealthAssesmentUserModule_CtID] [int] NULL,
	[HFit_HealthAssesmentUserModule_CHANGE_OPERATION] [nchar](1) NULL,
	[HFit_HealthAssesmentUserQuestion_CtID] [int] NULL,
	[HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION] [nchar](1) NULL,
	[HFit_HealthAssesmentUserQuestionGroupResults_CtID] [int] NULL,
	[HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION] [nchar](1) NULL,
	[HFit_HealthAssesmentUserRiskArea_CtID] [int] NULL,
	[HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION] [nchar](1) NULL,
	[HFit_HealthAssesmentUserRiskCategory_CtID] [int] NULL,
	[HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION] [nchar](1) NULL,
	[HFit_HealthAssesmentUserStarted_CtID] [int] NULL,
	[HFit_HealthAssesmentUserStarted_CHANGE_OPERATION] [nchar](1) NULL,
	[CT_CMS_User_SCV] [bigint] NULL,
	[CT_CMS_UserSettings_SCV] [bigint] NULL,
	[CT_CMS_Site_SCV] [bigint] NULL,
	[CT_CMS_UserSite_SCV] [bigint] NULL,
	[CT_HFit_Account_SCV] [bigint] NULL,
	[CT_HFit_HealthAssesmentUserAnswers_SCV] [bigint] NULL,
	[CT_HFit_HealthAssesmentUserModule_SCV] [bigint] NULL,
	[CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV] [bigint] NULL,
	[CT_HFit_HealthAssesmentUserRiskArea_SCV] [bigint] NULL,
	[CT_HFit_HealthAssesmentUserRiskCategory_SCV] [bigint] NULL,
	[CT_HFit_HealthAssesmentUserStarted_SCV] [bigint] NULL,
	   [CT_HFit_HealthAssesmentUserQuestion_SCV] [bigint] NULL,
	[ConvertedToCentralTime] [bit] NULL,
	[LastModifiedDate] [datetime] NULL,
	[RowNbr] [int] NULL,
	[DeletedFlg] [bit] NULL,
	[TimeZone] [nvarchar](10) NULL,
	[PKHashCode] [varchar](100) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

go

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'Temp_PI_EDW_HealthAssessment_Dates' )
        BEGIN
            PRINT 'Adding INDEX Temp_PI_EDW_HealthAssessment_Dates at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));

            CREATE NONCLUSTERED INDEX Temp_PI_EDW_HealthAssessment_Dates ON dbo.[TEMP_EDW_HealthAssessment_DATA] ( ItemCreatedWhen ASC ,
            ItemModifiedWhen ASC) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
            DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
        END;

    IF NOT EXISTS
    ( SELECT
             name
        FROM sys.indexes
        WHERE name = 'Temp_PI_EDW_HealthAssessment_NATKEY' )
        BEGIN
            PRINT 'Adding INDEX Temp_PI_EDW_HealthAssessment_NATKEY at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
            CREATE INDEX Temp_PI_EDW_HealthAssessment_NATKEY ON dbo.[TEMP_EDW_HealthAssessment_DATA] (
            UserStartedItemID
            , UserGUID
            , PKHashCode, DeletedFlg, LastModifiedDate
            );
        END;

    --IF NOT EXISTS ( SELECT
    --                       name
    --                  FROM sys.indexes
    --                  WHERE name = 'Temp_PI_EDW_HealthAssessment_IDs' )
    --    BEGIN
    --        EXEC PrintNow 'Adding INDEX Temp_PI_EDW_HealthAssessment_IDs';
    --        CREATE INDEX Temp_PI_EDW_HealthAssessment_IDs ON dbo.[TEMP_EDW_HealthAssessment_DATA] (
    --        UserStartedItemID
    --        , HealthAssesmentUserStartedNodeGUID
    --        , UserGUID
    --        , SiteGUID
    --        , AccountCD
    --        , HAModuleNodeGUID
    --        , CMSNodeGuid
    --        , HARiskCategoryNodeGUID
    --        , UserRiskAreaItemID
    --        , HARiskAreaNodeGUID
    --        , UserQuestionItemID
    --        , HAQuestionGuid
    --        , HAQuestionNodeGUID
    --        , UserAnswerItemID
    --        , HAAnswerNodeGUID
    --        , CampaignNodeGUID
    --        )
    --        INCLUDE ( AccountID , UserModuleItemId , UserRiskCategoryItemID , DeletedFlg , HASHCODE , LastModifiedDate )
    --        WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
    --        ALLOW_ROW_LOCKS = ON ,
    --        ALLOW_PAGE_LOCKS = ON );
    --    END;
go

go
print 'Created TEMP_EDW_HealthAssessment_DATA.sql'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--SELECT
--       *
--       FROM information_schema.tables
--       WHERE table_name LIKE 'staging_edw%';

/* HOW TO USE THIS PROCEDURE:
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_BioMetrics'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Coaches'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_CoachingDetail'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthAssesmentClientView'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthAssessment'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthDefinition'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestDetail'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestList'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardAwardDetail'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardsDefinition'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardTriggerParameters'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserDetail'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserLevel'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_SmallSteps'
exec proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Trackers'
*/

/*
SELECT
       table_name
     , column_name
       FROM information_schema.columns
       WHERE
    data_type = 'datetime'
   AND table_name = 'DIM_EDW_Coaches'
       ORDER BY
                table_name, column_name;
*/

/* EXAMPLE:
    Update DIM_EDW_BioMetrics SET 
    CreatedDate = DateAdd(hour, -5, CreatedDate) ,
    EventDate = DateAdd(hour, -5, EventDate) ,
    ItemCreatedWhen = DateAdd(hour, -5, ItemCreatedWhen) ,
    ItemModifiedWhen = DateAdd(hour, -5, ItemModifiedWhen) ,
    LastModifiedDate = DateAdd(hour, -5, LastModifiedDate) ,
    ModifiedDate = DateAdd(hour, -5, ModifiedDate) ,
	ConvertedToCentralTime = 1 
    where ConvertedToCentralTime is null 
*/

GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EDW_ChangeGmtToCentralTime') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_ChangeGmtToCentralTime;
    END;
GO

CREATE PROCEDURE proc_EDW_ChangeGmtToCentralTime (
     @tname AS nvarchar (100)) 
AS
BEGIN
    BEGIN
	   --Author:  W. Dale Miller
	   --Date  :  05.21.2015
	   --Purpose: Converts a GMT date to Central time considering whether DST or not. Done specificially for the EDW, expressly, laura B.
	   --		Adds a column to track whether the date is converted to central time or not to provide easy fallback if deemed unneeded.
	   
        --DECLARE @tname AS nvarchar (100) = 'DIM_EDW_RewardUserDetail';

	   DECLARE @CurrTZ nvarchar (250) = null ;
        DECLARE @dstStart AS datetime;
        DECLARE @dstEnd AS datetime;
        DECLARE @currYear AS int = DATEPART (year, GETDATE ()) ;
        DECLARE @t nvarchar (250) ;
        DECLARE @c nvarchar (250) ;
        DECLARE @offset int;
        DECLARE @localDateTime datetime;
        DECLARE @utcDateTime datetime = null ;
	   

        SET @dstStart = dbo.udfGetDstStart ( @currYear) ;
        SET @dstEnd = dbo.udfGetDstEnd ( @currYear) ;
        --PRINT @dstStart;
        --PRINT @dstEnd;

        DECLARE @isDst AS int = 0;

        IF GETDATE () BETWEEN @dstStart AND @dstEnd
            BEGIN
                SET @isDst = 1;
            END;

        --PRINT @isDst;

        DECLARE @CT_Offset AS nvarchar (50) = NULL;
        IF @isDst = 1
            BEGIN
                SET @offset = -5;
                SET @CT_Offset = '-05:00';
			 set @CurrTZ = 'CDT' ;
            END ;
        ELSE
            BEGIN
                SET @offset = -6;
                SET @CT_Offset = '-06:00';
			 set @CurrTZ = 'CST' ;
            END;

        DECLARE @i AS int = 0;
        DECLARE @MySql AS nvarchar (max) = NULL;
        DECLARE db_cursor CURSOR
            FOR
                SELECT
                       column_name
                       FROM information_schema.columns
                       WHERE
                       table_name = @tname
                   AND data_type = 'datetime'
                       ORDER BY
                                column_name;

        --SELECT SYSDATETIMEOFFSET() ;
        --SELECT SWITCHOFFSET(SYSDATETIMEOFFSET(), @CT_Offset) AS 'US Central Time';

        --SET @offset = DATEDIFF (hour, GETUTCDATE () , GETDATE ()) ;
        --SET @localDateTime = DATEADD (hour, @offset, @utcDateTime) ;

        --PRINT @offset;
        --PRINT @localDateTime;

        IF NOT EXISTS (SELECT
                              column_name
                              FROM information_schema.columns
                              WHERE
                              table_name = @tname
                          AND column_name = 'ConvertedToCentralTime') 
            BEGIN
                DECLARE @s AS nvarchar (500) ;
                SET @s = 'alter table ' + @tname + ' add ConvertedToCentralTime bit null ';
                EXEC (@s) ;
                PRINT 'Added column ConvertedToCentralTime to ' + @tname;
            END;
        DECLARE @idxname AS nvarchar (250) = NULL;
        SET @idxname = 'PI_' + @tname + '_CDT';
        IF NOT EXISTS (SELECT
                              name
                              FROM sys.indexes
                              WHERE
                              name = @idxname) 
            BEGIN
		      declare @idxsql as nvarchar(max) = '
                CREATE NONCLUSTERED INDEX PI_'+@tname+'_CDT ON ' + @tname + ' (ConvertedToCentralTime ASC)';
			 exec (@idxsql ) ;
                PRINT 'Added index ConvertedToCentralTime to ' + @tname;
            END;

        SET @MySql = 'Update ' + @tname + ' SET ';
        --PRINT @MySql;

        OPEN db_cursor;
        FETCH NEXT FROM db_cursor INTO  @c;
        WHILE @@FETCH_STATUS = 0
            BEGIN
                SET @i = @i + 1;
                --print '@i = ' + cast(@i as nvarchar(50)) ;
                --            PRINT 'Column: ' + @c;
                SET @MySql = @MySql + CHAR (10) + @c + ' = DateAdd(hour, ' + CAST (@offset AS nvarchar (50)) + ', ' + @c + ') ,';
                --PRINT  @MySql;
                --PRINT '_______________________________________________';
                FETCH NEXT FROM db_cursor INTO @c;
            END;

        CLOSE db_cursor;
        DEALLOCATE db_cursor;

        SET @MySql = @MySql + CHAR (10) + ' ConvertedToCentralTime = 1, TimeZone = ''' + @CurrTZ + '''' + CHAR (10) + '    where ConvertedToCentralTime is null ';

	   --print @MySql ;

        exec( @MySql ) ;
	   declare @iCnt as bigint = @@ROWCOUNT ;
	   print 'Records Updated: ' + cast(@iCnt as nvarchar(50)) ;
    END;
END;
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating proc_CkHaDataChanged';
PRINT 'FROM proc_CkHaDataChanged.sql';

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CkHaDataChanged') 
    BEGIN
        DROP PROCEDURE
             proc_CkHaDataChanged;
    END;
GO

-- exec proc_CkHaDataChanged 0
-- exec proc_CkHaDataChanged 12550

CREATE PROC proc_CkHaDataChanged
     @CTVersionID AS int,@NbrDetectedChanges bigint OUTPUT
AS
BEGIN
/*----------------------------------------
--------------------------------------
Author:	  Dale Miller
Returns:	  @b = 0 - no changes
		  @b = 1 - updates only
		  @b = 2 - deletes only
		  @b = 3 - deletes and updates
		  @b = 4 - inserts only
		  @b = 5 - inserts and updates
		  @b = 6 - inserts and deletes
		  @b = 7 - inserts, updates, and deletes
*/
    DECLARE
    @UpdatesFound TABLE (
                        ChangeType nvarchar (10) NULL) ;
    DECLARE
    @b AS int = 0;

    INSERT INTO @UpdatesFound
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_Class, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_Document, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_Site, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_Tree, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_User, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_UserSettings, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_UserSite, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES COM_SKU, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_Account, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HACampaign, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserAnswers, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserModule, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestion, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskCategory, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssessment, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, @CTVersionID) AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_LKP_EDW_RejectMPI, @CTVersionID) AS CT;

    set @NbrDetectedChanges = @@ROWCOUNT;
    DECLARE @iInsert AS int = 0;
    DECLARE @iUpdate AS int = 0;
    DECLARE @iDel AS int = 0;

    IF @NbrDetectedChanges = 0
        BEGIN
            PRINT 'No changes found';
            SET @b = 0;
        END;
    ELSE
        BEGIN

            SET @iInsert = (SELECT
                                   COUNT (*) 
                                   FROM @UpdatesFound
                                   WHERE ChangeType = 'I');
            SET @iUpdate = (SELECT
                                   COUNT (*) 
                                   FROM @UpdatesFound
                                   WHERE ChangeType = 'U');
            SET @iDel = (SELECT
                                COUNT (*) 
                                FROM @UpdatesFound
                                WHERE ChangeType = 'D');
            
		  PRINT 'Print Total Changes found in version: ' +cast(@CTVersionID as nvarchar(50)) + ' is '  + CAST (@iInsert AS nvarchar (50)) + CAST (@iDel AS nvarchar (50)) + CAST (@iUpdate AS nvarchar (50)) ;
            PRINT CAST (@NbrDetectedChanges AS nvarchar (50)) + ' TOTAL Changes found: proc_CkHaDataChanged';
            PRINT CAST (@iInsert AS nvarchar (50)) + ' : Inserts found';
            PRINT CAST (@iUpdate AS nvarchar (50)) + ' : Updates found';
            PRINT CAST (@iDel AS nvarchar (50)) + ' : Deletes found';

            IF @iInsert > 0
                BEGIN
                    PRINT CAST (@iInsert AS nvarchar (50)) + ' Inserts found: proc_CkHaDataChanged';
                    SET @b = 1;
                END;
            IF @iUpdate > 0
                BEGIN
                    PRINT CAST (@iUpdate AS nvarchar (50)) + ' Updates found: proc_CkHaDataChanged';
                    SET @b = 1;
                END;
            PRINT CAST (@iDel AS nvarchar (50)) + ' Deletes found: proc_CkHaDataChanged';

            IF @iInsert = 0
           AND @iDel = 0
           AND @iUpdate = 0
                BEGIN
                    PRINT '@b = 0 - no changes';
                    SET @b = 0;
                END;
            IF @iInsert = 0
           AND @iDel = 0
           AND @iUpdate > 0
                BEGIN
                    PRINT '@b > 0 - updates only';
                    SET @b = 1;
                END;
            IF @iInsert = 0
           AND @iDel > 0
           AND @iUpdate = 0
                BEGIN
                    SET @b = 2;
                    PRINT '@b = 2 - deletes only';
                END;
            IF @iInsert = 0
           AND @iDel > 0
           AND @iUpdate > 0
                BEGIN
                    SET @b = 3;
                    PRINT '@b = 3 - deletes and updates';
                END;
            IF @iInsert > 0
           AND @iDel = 0
           AND @iUpdate = 0
                BEGIN
                    SET @b = 4;
                    PRINT '@b = 4 - inserts only';
                END;
            IF @iInsert > 0
           AND @iDel = 0
           AND @iUpdate > 0
                BEGIN
                    SET @b = 5;
                    PRINT '@b = 5 - inserts and updates';
                END;
            IF @iInsert > 0
           AND @iDel > 0
           AND @iUpdate = 0
                BEGIN
                    SET @b = 6;
                    PRINT '@b = 6 - inserts and deletes';
                END;
            IF @iInsert > 0
           AND @iDel > 0
           AND @iUpdate > 0
                BEGIN
                    SET @b = 7;
                    PRINT '@b = 7 - inserts, updates, and deletes';
                END;

		  print 'Returned Value: ' + cast(@b as nvarchar(50)) ;

            RETURN @b;
        END;
END;
GO
PRINT 'Created proc_CkHaDataChanged';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating proc_Add_EDW_CT_StdCols.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Add_EDW_CT_StdCols') 
    BEGIN
        DROP PROCEDURE
             proc_Add_EDW_CT_StdCols;
    END;
GO

-- EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthAssessment';
CREATE PROCEDURE proc_Add_EDW_CT_StdCols (
       @tname AS nvarchar (100)) 
AS
BEGIN
    DECLARE @MySql AS nvarchar (2000) = NULL;
    declare @DBN as nvarchar(100) = DB_NAME() ;
    IF @tname LIKE '#%'
        BEGIN
            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'LastModifiedDate') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' ADD LastModifiedDate datetime NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'RowNbr') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' ADD RowNbr int NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'DeletedFlg') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add DeletedFlg bit NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'TimeZone') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add TimeZone nvarchar (10) NULL; ';
                    EXEC (@MySql) ;
                END;
            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'ConvertedToCentralTime') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add ConvertedToCentralTime bit NULL; ';
                    EXEC (@MySql) ;
                END;
			 IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'SVR') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add SVR nvarchar(100) not NULL default(@@SERVERNAME); ';
                    EXEC (@MySql) ;
                END;
			 IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'DBNAME') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add DBNAME nvarchar(100) not NULL default('''+@DBN+'''); ';
                    EXEC (@MySql) ;
                END;
			 IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM TempDB.INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'HashCode') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add HashCode nvarchar(75) NULL; ';
                    EXEC (@MySql) ;
                END;
        END ;
    ELSE
        BEGIN

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'LastModifiedDate') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' ADD LastModifiedDate datetime NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'RowNbr') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' ADD RowNbr int NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'DeletedFlg') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add DeletedFlg bit NULL; ';
                    EXEC (@MySql) ;
                END;

            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'TimeZone') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add TimeZone nvarchar (10) NULL; ';
                    EXEC (@MySql) ;
                END;
            IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'ConvertedToCentralTime') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add ConvertedToCentralTime bit NULL; ';
                    EXEC (@MySql) ;
                END;

		  IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'SVR') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add SVR nvarchar(100) not NULL default(@@SERVERNAME); ';
                    EXEC (@MySql) ;
                END;
			 IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'DBNAME') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add DBNAME nvarchar(100) not NULL default('''+@DBN+'''); ';
                    EXEC (@MySql) ;
                END;

		  IF NOT EXISTS ( SELECT
                                   column_name
                                   FROM INFORMATION_SCHEMA.COLUMNS
                                   WHERE
                                   table_name = @tname AND
                                   column_name = 'HashCode') 
                BEGIN
                    SET @MySql = 'ALTER TABLE ' + @tname + ' add HashCode nvarchar(75) NULL ; ';
                    EXEC (@MySql) ;
                END;


        END;
--*************************************************************************

END;

GO
PRINT 'Created proc_Add_EDW_CT_StdCols.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
print 'Creating procedure PrintNow' ;
print 'FROM PrintNow.sql' ;
go
if exists (select name from sys.procedures where name = 'PrintNow')
    drop procedure PrintNow;

go

create procedure PrintNow (@msg as nvarchar(500))
as
begin
raiserror (@msg, 10,1) with nowait;
end 

go
print 'Created procedure PrintNow' ;

go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating CT_Performance_History';
PRINT 'FROM CT_Performance_History.sql';
GO

IF NOT EXISTS (SELECT
                  name
                      FROM sys.tables
                      WHERE name = 'CT_Performance_History') 
    BEGIN
        PRINT 'CT_Performance_History missing - created now.';
        CREATE TABLE dbo.CT_Performance_History (
           RowGuid uniqueidentifier NOT NULL
         ,RowNbr int IDENTITY (1, 1) 
                     NOT NULL
         ,CALLING_PROC nvarchar (100) NOT NULL
         ,PROC_LOCATION nvarchar (100) NOT NULL
         ,starttime datetime2 (7) NOT NULL
         ,endtime datetime2 (7) NULL
         ,elapsedsecs decimal (18, 2) NULL
         ,elapsedmin decimal (18, 2) NULL
         ,elapsedhr decimal (18, 2) NULL
         ,RowsProcessed bigint NULL
         ,CreateDate datetime NULL
         ,LastModifiedDate datetime NULL
         ,CONSTRAINT PK_CT_Performance_History PRIMARY KEY CLUSTERED
           (
           RowGuid ASC,
           RowNbr ASC
           ) 
              WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
        ) 
        ON [PRIMARY];

        ALTER TABLE dbo.CT_Performance_History
        ADD
           CONSTRAINT DF_CT_Performance_History_CreateDate  DEFAULT GETDATE () FOR CreateDate;

	   PRINT 'Created CT_Performance_History';
    END;
else 
    PRINT 'CT_Performance_History already exists, skipping create.';
GO

PRINT 'FROM CT_Performance_History.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Creating proc_CT_Performance_History';
PRINT 'FROM proc_CT_Performance_History.sql';
GO

IF EXISTS (SELECT
              name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_Performance_History') 
    BEGIN
        DROP PROCEDURE
           proc_CT_Performance_History;
    END;
GO

/*
Author: W. Dale Miller
Created: 05.06.2015
Purpose: Track ongoing performance of selected procs and functions

exec proc_CT_Performance_History @RowGuid, @CALLING_PROC, @PROC_LOCATION, @starttime, @endtime, @elapsedsecs, @RowsProcessed ;

*/

CREATE PROCEDURE proc_CT_Performance_History
       @RowGuid AS uniqueidentifier
     , @CALLING_PROC AS nvarchar (100) 
     , @PROC_LOCATION AS nvarchar (100) 
     , @starttime AS datetime2 = NULL
     , @endtime  AS datetime2 = NULL
     , @elapsedsecs AS bigint = NULL
     , @RowsProcessed AS bigint = NULL
AS
BEGIN

    DECLARE @iCnt AS int = 0
          , @elapsedmin AS decimal (10, 2) 
          , @elapsedhr AS decimal (10, 2) ;

    SET @iCnt = (SELECT
                    COUNT (*) 
                        FROM CT_Performance_History
                        WHERE RowGuid = @RowGuid );

    IF @iCnt = 0
        BEGIN
            IF @starttime IS NULL
                BEGIN
                    SET @starttime = GETDATE () ;
                END;

            INSERT INTO dbo.CT_Performance_History
            (
               RowGuid
             , CALLING_PROC
             , PROC_LOCATION
             , starttime
             , endtime
             , elapsedsecs
             , elapsedmin
             , elapsedhr
             , RowsProcessed
             , CreateDate
             , LastModifiedDate) 
            VALUES
                   (
                   @RowGuid
                   , @CALLING_PROC
                   , @PROC_LOCATION
                   , @starttime
                   , @endtime
                   , @elapsedsecs
                   , @elapsedmin
                   , @elapsedhr
                   , @RowsProcessed
                   , GETDATE () 
                   , GETDATE ()) ;
        END;

    --IF @starttime IS NOT NULL
    --        BEGIN
    --            UPDATE CT_Performance_History
    --                   SET
    --               starttime = @starttime;
    --        END;
    IF @endtime IS NOT NULL
        BEGIN
            UPDATE CT_Performance_History
                   SET
               endtime = @endtime
            WHERE
               RowGuid = @RowGuid;
        END;
    IF
           @endtime IS NOT NULL
       AND @starttime IS NOT NULL
        BEGIN
            SET @elapsedsecs = DATEDIFF ( second , @starttime , @endtime) ;

            UPDATE CT_Performance_History
                   SET
               elapsedsecs = @elapsedsecs
            WHERE
               RowGuid = @RowGuid;
        END;
    IF @elapsedsecs IS NOT NULL
        BEGIN
            UPDATE CT_Performance_History
                   SET
               elapsedsecs = @elapsedsecs
            WHERE
               RowGuid = @RowGuid;
            DECLARE @m AS decimal (10, 2) = @elapsedsecs / 60;
            UPDATE CT_Performance_History
                   SET
               elapsedmin = @m
            WHERE
               RowGuid = @RowGuid;
            DECLARE @h AS decimal (10, 2) = @m / 60;
            UPDATE CT_Performance_History
                   SET
               elapsedhr = @h
            WHERE
               RowGuid = @RowGuid;
        END;
    IF @RowsProcessed IS NOT NULL
        BEGIN
            UPDATE CT_Performance_History
                   SET
               RowsProcessed = @RowsProcessed
            WHERE
               RowGuid = @RowGuid;
        END;
    UPDATE CT_Performance_History
           SET
       LastModifiedDate = GETDATE () 
    WHERE
       RowGuid = @RowGuid;

END;

GO
PRINT 'Created proc_CT_Performance_History';
PRINT 'FROM proc_CT_Performance_History.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*-------------------------------------------------------------------
exec isJobRunning 'job_EDW_GetStagingData_HA_KenticoCMS_Prod1'
exec isJobRunning 'job_EDW_GetStagingData_HA_KenticoCMS_Prod3'
exec isJobRunning 'job_EDW_GetStagingData_HADefinition_KenticoCMS_QA'

declare @b as int = 0 ;
exec @b = isJobRunning 'job_EDW_GetStagingData_HA_KenticoCMS_Prod1' ;
print @b
*/

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'isJobRunning') 
    BEGIN
        DROP PROCEDURE
             isJobRunning;
    END;
GO

CREATE PROCEDURE isJobRunning (
       @jobname AS NVARCHAR (100)) 
AS
BEGIN
    --DECLARE @jobname sysname  ='job_EDW_GetStagingData_HA_KenticoCMS_Prod1' -- Enter the job name here
    SET NOCOUNT ON;
    IF NOT EXISTS (SELECT
                          *
                          FROM msdb..sysjobs
                          WHERE Name = @jobname) 
        BEGIN
            PRINT @jobname + ' Job does not exists';
        END;
    ELSE
        BEGIN
            DECLARE
                   @State AS INT = 0;
            CREATE TABLE #xp_results
            (
                         job_id                UNIQUEIDENTIFIER NOT NULL
                       , last_run_date         INT              NOT NULL
                       , last_run_time         INT              NOT NULL
                       , next_run_date         INT              NOT NULL
                       , next_run_time         INT              NOT NULL
                       , next_run_schedule_id  INT              NOT NULL
                       , requested_to_run      INT              NOT NULL
                       , request_source        INT              NOT NULL
                       , request_source_id     SYSNAME          COLLATE database_default NULL
                       , running               INT              NOT NULL
                       , current_step          INT              NOT NULL
                       , current_retry_attempt INT              NOT NULL
                       , job_state             INT              NOT NULL
            );
            INSERT INTO  #xp_results
            EXECUTE DFINAnalytics.dbo.xp_sqlagent_enum_jobs 1 , 'sa';
            IF EXISTS (
            SELECT
                   1
                   FROM
                        #xp_results AS X
                             INNER JOIN
                             msdb..sysjobs AS J
                             ON X.job_id = J.job_id
                   WHERE
                   x.running = 1 AND
                   j.name = @jobname) 
                BEGIN
                    PRINT @jobname + ' : Job is Running';
                    SET @State = 1;
                END;
            ELSE
                BEGIN
                    PRINT @jobname + ' : Job is NOT Running';
                    SET @State = 0;
                END;
            DROP TABLE
                 #xp_results;
            RETURN @State;
        END;
END;--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
Print 'Executing View_EDW_STAGED_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined.SQL'
go

if exists (select name from sys.views where name = 'View_EDW_STAGED_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined')
    drop view View_EDW_STAGED_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined;

go

CREATE VIEW View_EDW_STAGED_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined
AS
select  
	   HAUSERRISKAREA.ITEMID AS USERRISKAREAITEMID
	   ,HAUSERRISKAREA.HARISKCATEGORYITEMID 
	   , HAUSERRISKAREA.CODENAME AS USERRISKAREACODENAME
	   , HAUSERRISKAREA.HARISKAREANODEGUID
	   , NULL AS HARISKAREAVERSIONID
	   , HAUSERRISKAREA.HARISKAREASCORE
	   , HAUSERRISKAREA.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
	   , HAUSERRISKAREA.ITEMMODIFIEDWHEN AS HAUSERRISKAREA_ITEMMODIFIEDWHEN
	   , HAUSERRISKAREA.ItemModifiedWhen AS HAUSERRISKAREA_LASTMODIFIED   --HAUSERRISKAREA.LASTLOADEDDATE 
	   , 0 AS HAUSERRISKAREA_LastUpdateID   --HAUSERRISKAREA.LastUpdateID 

	   , HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
	   , HAUSERQUESTIONGROUPRESULTS.ItemID as HAUSERQUESTIONGROUPRESULTSItemID
	   , HAUSERQUESTIONGROUPRESULTS.POINTRESULTS
	   , HAUSERQUESTIONGROUPRESULTS.CODENAME AS QUESTIONGROUPCODENAME
	   , HAUSERQUESTIONGROUPRESULTS.ItemModifiedWhen AS HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED	--HAUSERQUESTIONGROUPRESULTS.LASTLOADEDDATE 
	   , 0 AS HAUSERQUESTIONGROUPRESULTS_LastUpdateID	--HAUSERQUESTIONGROUPRESULTS.LastUpdateID 

	   , HAUSERRISKAREA.ItemModifiedWhen as  LastModifiedWhen
	   , 0 as LastUpdateID
	   , getdate() as LASTLOADEDDATE
	   , @@SERVERNAME as SVR
	   , DB_NAME() AS DBNAME
	   , 0 as DeletedFlg

--into DIM_EDW_HFit_HealthAssesmentUserRiskArea_Joined
from DBO.HFIT_HEALTHASSESMENTUSERRISKAREA AS HAUSERRISKAREA
              --ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
LEFT JOIN DBO.HFIT_HEALTHASSESMENTUSERQUESTIONGROUPRESULTS AS HAUSERQUESTIONGROUPRESULTS
              ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID

go
Print 'ExecutED View_EDW_STAGED_HFIT_HEALTHASSESMENTUSERRISKAREA_Joined.SQL'
go

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
-- use KenticoCMS_Prod1

print ('Processing: view_EDW_CoachingDefinition_CT ') ;
go

if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_CoachingDefinition_CT')
BEGIN
	drop view view_EDW_CoachingDefinition_CT ;
END
GO


--GRANT SELECT
--	ON [dbo].[view_EDW_CoachingDefinition_CT]
--	TO [EDWReader_PRD]
--GO


CREATE VIEW [dbo].[view_EDW_CoachingDefinition_CT]
AS
--********************************************************************************************************
--8/7/2014 - added DocumentGuid 
--8/8/2014 - Generated corrected view in DEV (WDM)
-- Verified last mod date available to EDW 9.10.2014
--11.17.2014 - (wdm) John Croft found an issue with multiple languages being returned.
--		view_EDW_CoachingDefinition_CT pulls its data from a nested view View_HFit_Tobacco_Goal_Joined. I added 
--		a Document Culture filter on the SELECT STATEMENT pulling the data from View_HFit_Tobacco_Goal_Joined.
--		In LAB DB, when the view is executed W/O the filter, I get 90 rows. When executed with the filter, I 
--		get 89 rows. This would indicate the filter can be applied at the SELCT statement level. The view has 
--		the change applied and is ready to be regenerated. Also, I needed to add a language filter to 
--		View_HFit_Goal_Joined. Additionally, I allow the view to return the Document Culture as a column so 
--		that we can see the associated language. This can be removed if not wanted, but for troubleshooting 
--		it is useful.
--********************************************************************************************************
/*
drop table TEMPXX;
go
select * 
into TEMPXX
from view_EDW_CoachingDefinition_CT

select count(*) from [view_EDW_CoachingDefinition_CT]
select * from [view_EDW_CoachingDefinition_CT]
*/
SELECT
	GJ.GoalID
	, GJ.DocumentGuid
	, GJ.NodeSiteID
	, cs.SiteGUID
	, GJ.GoalImage
	, GJ.Goal
	, dbo.udf_StripHTML(GJ.GoalText) GoalText --
	, dbo.udf_StripHTML(GJ.GoalSummary) GoalSummary --
	, GJ.TrackerAssociation
	, GJ.GoalFrequency
	, HFLF.FrequencySingular
	, HFLF.FrequencyPlural
	, GJ.GoalUnitOfMeasure
	, HFLUOM.UnitOfMeasure
	, GJ.GoalDirection
	, GJ.GoalPrecision
	, GJ.GoalAbsoluteMin
	, GJ.GoalAbsoluteMax
	, dbo.udf_StripHTML(GJ.SetGoalText) SetGoalText --
	, dbo.udf_StripHTML(GJ.HelpText) HelpText --
	, GJ.EvaluationType
	, GJ.CatalogDisplay
	, GJ.AllowModification
	, GJ.ActivityText
	, dbo.udf_StripHTML(GJ.SetGoalModifyText) SetgoalModifyText
	, GJ.IsLifestyleGoal
	, GJ.CodeName
	, CASE	WHEN CAST(gj.DocumentCreatedWhen AS DATE) = CAST(gj.DocumentModifiedWhen AS DATE)
			THEN 'I'
			ELSE 'U'
		END AS ChangeType
	, GJ.DocumentCreatedWhen
	, GJ.DocumentModifiedWhen
	, GJ.DocumentCulture
	,hashbytes('sha1',
		   isNull(cast(GJ.GoalID as nvarchar(50)),'-')
		   + isNull(cast( GJ.DocumentGuid as nvarchar(50)),'-')
		   + isNull(cast( GJ.NodeSiteID as nvarchar(50)),'-')
		   + isNull(cast( cs.SiteGUID as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalImage as nvarchar(50)),'-')
		   + isNull(cast( GJ.Goal as nvarchar(50)),'-')
		   + isnull(LEFT(GJ.GoalText,1000),'-')
		   + isnull(left(GJ.GoalSummary,1000),'-')
		   + isNull(cast( GJ.TrackerAssociation as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalFrequency as nvarchar(50)),'-')
		   + isNull(cast( HFLF.FrequencySingular as nvarchar(50)),'-')
		   + isNull(cast( HFLF.FrequencyPlural as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalUnitOfMeasure as nvarchar(50)),'-')
		   + isNull(cast( HFLUOM.UnitOfMeasure as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalDirection as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalPrecision as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalAbsoluteMin as nvarchar(50)),'-')
		   + isNull(cast( GJ.GoalAbsoluteMax as nvarchar(50)),'-')
		   + isnull(left(GJ.SetGoalText,1000),'-')
		   + isnull(left(GJ.HelpText,1000),'-')
		   + isNull(cast( GJ.EvaluationType as nvarchar(50)),'-')
		   + isNull(cast( GJ.CatalogDisplay as nvarchar(50)),'-')
		   + isNull(cast( GJ.AllowModification as nvarchar(50)),'-')
		   + isnull(left(GJ.ActivityText, 1000),'-')
		   + isnull(left(GJ.SetGoalModifyText,1000),'-')
		   + isNull(cast( GJ.IsLifestyleGoal as nvarchar(50)),'-')
		   + isNUll( GJ.CodeName, '-')
		   + isNull(cast( GJ.DocumentCreatedWhen as nvarchar(50)),'-')
		   + isNull(cast( GJ.DocumentModifiedWhen as nvarchar(50)),'-')
		   + isNull( GJ.DocumentCulture, '-')
	   ) as HashCode
, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
	(
		SELECT
			VHFGJ.GoalID
			, VHFGJ.DocumentGuid	--, VHFGJ.DocumentID
			, VHFGJ.NodeSiteID
			, VHFGJ.GoalImage
			, VHFGJ.Goal
			, VHFGJ.GoalText
			, VHFGJ.GoalSummary
			, VHFGJ.TrackerNodeGUID as TrackerAssociation  --VHFGJ.TrackerAssociation
			, VHFGJ.GoalFrequency
			, VHFGJ.GoalUnitOfMeasure
			, VHFGJ.GoalDirection
			, VHFGJ.GoalPrecision
			, VHFGJ.GoalAbsoluteMin
			, VHFGJ.GoalAbsoluteMax
			, VHFGJ.SetGoalText
			, VHFGJ.HelpText
			, VHFGJ.EvaluationType
			, VHFGJ.CatalogDisplay
			, VHFGJ.AllowModification
			, VHFGJ.ActivityText
			, VHFGJ.SetGoalModifyText
			, VHFGJ.IsLifestyleGoal
			, VHFGJ.CodeName
			, VHFGJ.DocumentCreatedWhen
			, VHFGJ.DocumentModifiedWhen
			, VHFGJ.DocumentCulture
		, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
			dbo.View_HFit_Goal_Joined AS VHFGJ
			where VHFGJ.DocumentCulture = 'en-US'
		UNION ALL
		SELECT
			VHFTGJ.GoalID
			, VHFTGJ.DocumentGuid	--, VHFTGJ.DocumentID
			, VHFTGJ.NodeSiteID
			, VHFTGJ.GoalImage
			, VHFTGJ.Goal
			, NULL AS GoalText
			, VHFTGJ.GoalSummary
			, VHFTGJ.TrackerNodeGUID as TrackerAssociation  --VHFTGJ.TrackerAssociation
			, VHFTGJ.GoalFrequency
			, NULL AS GoalUnitOfMeasure
			, VHFTGJ.GoalDirection
			, VHFTGJ.GoalPrecision
			, VHFTGJ.GoalAbsoluteMin
			, VHFTGJ.GoalAbsoluteMax
			, NULL AS SetGoalText
			, NULL AS HelpText
			, VHFTGJ.EvaluationType
			, VHFTGJ.CatalogDisplay
			, VHFTGJ.AllowModification
			, VHFTGJ.ActivityText
			, NULL SetGoalModifyText
			, VHFTGJ.IsLifestyleGoal
			, VHFTGJ.CodeName
			, VHFTGJ.DocumentCreatedWhen
			, VHFTGJ.DocumentModifiedWhen
			, VHFTGJ.DocumentCulture
		, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
			dbo.View_HFit_Tobacco_Goal_Joined AS VHFTGJ
			where VHFTGJ.DocumentCulture = 'en-US'
	) AS GJ
LEFT OUTER JOIN dbo.HFit_LKP_UnitOfMeasure AS HFLUOM ON GJ.GoalUnitOfMeasure = HFLUOM.UnitOfMeasureID
LEFT OUTER JOIN dbo.HFit_LKP_Frequency AS HFLF ON GJ.GoalFrequency = HFLF.FrequencyID
INNER JOIN cms_site AS CS ON gj.nodesiteid = cs.siteid
--INNER JOIN cms_site AS CS ON gj.siteguid = cs.siteguid
WHERE
	gj.DocumentCreatedWhen IS NOT NULL
	AND gj.DocumentModifiedWhen IS NOT NULL 

GO

--select * from view_EDW_CoachingDefinition_CT  --  
  --  
GO 
print('Completed: view_EDW_CoachingDefinition_CT.sql'); 
print('***** FROM: view_EDW_CoachingDefinition_CT.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO

--select top 10 * into XX_TEMP from view_EDW_HealthAssesment_CT

PRINT 'Creating the STAGING tables';

GO

/*-------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------
*********************************************************************************************************************
=============================================================
DATE:      04-17-2015 16:49:54
SERVER:    hfit-tgt.cloudapp.net,2
Author:	  Dale Miller
Tables:
		DIM_EDW_HealthAssessmentDefinition, DIM_EDW_Coaches, DIM_EDW_CoachingDetail
		DIM_EDW_HealthAssesmentClientView, DIM_EDW_HealthAssessment, DIM_EDW_HealthDefinition
		DIM_EDW_HealthInterestDetail, DIM_EDW_HealthInterestList, DIM_EDW_RewardAwardDetail
		DIM_EDW_RewardTriggerParameters, DIM_EDW_RewardUserDetail, DIM_EDW_RewardUserLevel
		DIM_EDW_SmallSteps, DIM_EDW_Trackers, TEMP_EDW_Coaches_DATA
		TEMP_EDW_CoachingDetail_DATA, TEMP_EDW_HealthDefinition_DATA, TEMP_EDW_RewardAwardDetail_DATA
		TEMP_EDW_RewardTriggerParameters_DATA, TEMP_EDW_RewardUserLevel_DATA, TEMP_EDW_Tracker_DATA


=============================================================
*********************************************************************************************************************
*/

--IF EXISTS ( SELECT
--                   name
--              FROM sys.procedures
--              WHERE name = 'spPullEdwCompositeTracker' )

--    BEGIN

--        DROP PROCEDURE
--             spPullEdwCompositeTracker;
--    END;

--GO

--IF EXISTS ( SELECT
--                   name
--              FROM sys.procedures
--              WHERE name = 'proc_EDW_HA_Changes' )

--    BEGIN

--        DROP PROCEDURE
--             proc_EDW_HA_Changes;
--    END;

--GO

--IF EXISTS ( SELECT
--                   name
--              FROM sys.procedures
--              WHERE name = 'spPullEdwHaDefinition' )

--    BEGIN

--        DROP PROCEDURE
--             spPullEdwHaDefinition;
--    END;

--GO

PRINT 'Creating DIM_EDW_RewardsDefinition';

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_RewardsDefinition') 

    BEGIN

        DROP TABLE
             DIM_EDW_RewardsDefinition;
    END;

GO

CREATE TABLE dbo.DIM_EDW_RewardsDefinition (
             SiteGUID uniqueidentifier NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , RewardProgramGUID uniqueidentifier NOT NULL
           , RewardProgramName nvarchar (100) NOT NULL
           , RewardProgramPeriodStart datetime NOT NULL
           , RewardProgramPeriodEnd datetime NOT NULL
           , RewardGroupGuid uniqueidentifier NOT NULL
           , GroupName nvarchar (100) NOT NULL
           , RewardLevelGuid uniqueidentifier NOT NULL
           , Level nvarchar (50) NOT NULL
           , RewardLevelTypeLKPName nvarchar (25) NOT NULL
           , AwardDisplayName nvarchar (255) NULL
           , AwardType int NOT NULL
           , AwardThreshold1 int NOT NULL
           , AwardThreshold2 int NOT NULL
           , AwardThreshold3 int NOT NULL
           , AwardThreshold4 int NOT NULL
           , AwardValue1 float NOT NULL
           , AwardValue2 float NOT NULL
           , AwardValue3 float NOT NULL
           , AwardValue4 float NOT NULL
           , ExternalFulfillmentRequired bit NOT NULL
           , RewardActivityGuid uniqueidentifier NOT NULL
           , ActivityName nvarchar (150) NOT NULL
           , ActivityFreqOrCrit int NULL
           , ActivityPoints float NOT NULL
           , IsBundle bit NOT NULL
           , IsRequired bit NULL
           , MaxThreshold int NOT NULL
           , AwardPointsIncrementally bit NOT NULL
           , AllowMedicalExceptions bit NOT NULL
           , RewardTriggerGuid uniqueidentifier NOT NULL
           , RewardTriggerDynamicValue bit NULL
           , TriggerName nvarchar (100) NOT NULL
           , RewardTriggerParameterOperator int NOT NULL
           , RewardTriggerParmGUID uniqueidentifier NOT NULL
           , [Value] float NOT NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentCulture_VHFRAJ nvarchar (10) NOT NULL
           , DocumentCulture_VHFRPJ nvarchar (10) NOT NULL
           , DocumentCulture_VHFRGJ nvarchar (10) NOT NULL
           , DocumentCulture_VHFRLJ nvarchar (10) NOT NULL
           , DocumentCulture_VHFRTPJ nvarchar (10) NOT NULL
           , LevelName nvarchar (128) NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10) 
) 
ON [PRIMARY];

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardsDefinition';

GO

PRINT 'CREATED DIM_EDW_RewardsDefinition';

GO

SET ANSI_WARNINGS ON;

SET XACT_ABORT ON;

SET ARITHABORT ON;

SET NOCOUNT ON;

SET NUMERIC_ROUNDABORT OFF;

SET CONCAT_NULL_YIELDS_NULL ON;

GO

-- Create Table [dbo].[DIM_EDW_HealthAssessment]

PRINT 'Create Table [dbo].[DIM_EDW_HealthAssessment]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthAssessment') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthAssessment;
    END;

GO

SET ANSI_NULLS ON;

GO

SET QUOTED_IDENTIFIER ON;

GO

SET ANSI_PADDING ON;

GO

--ALTER TABLE DIM_EDW_HealthAssessment ALTER COLUMN DeleteFlg INT NULL
CREATE TABLE dbo.DIM_EDW_HealthAssessment (
             USERSTARTEDITEMID int NULL
           , HEALTHASSESMENTUSERSTARTEDNODEGUID uniqueidentifier NULL
           , USERID bigint NULL
           , USERGUID uniqueidentifier NULL
           , HFITUSERMPINUMBER bigint NULL
           , SITEGUID uniqueidentifier NULL
           , ACCOUNTID int NULL
           , ACCOUNTCD nvarchar (8) NULL
           , ACCOUNTNAME nvarchar (200) NULL
           , HASTARTEDDT datetime NULL
           , HACOMPLETEDDT datetime NULL
           , USERMODULEITEMID int NULL
           , USERMODULECODENAME nvarchar (100) NULL
           , HAMODULENODEGUID uniqueidentifier NULL
           , CMSNODEGUID uniqueidentifier NULL
           , HAMODULEVERSIONID int NULL
           , USERRISKCATEGORYITEMID int NULL
           , USERRISKCATEGORYCODENAME nvarchar (100) NULL
           , HARISKCATEGORYNODEGUID uniqueidentifier NULL
           , HARISKCATEGORYVERSIONID int NULL
           , USERRISKAREAITEMID int NULL
           , USERRISKAREACODENAME nvarchar (100) NULL
           , HARISKAREANODEGUID uniqueidentifier NULL
           , HARISKAREAVERSIONID int NULL
           , USERQUESTIONITEMID int NULL
           , TITLE varchar (max) NULL
           , HAQUESTIONGUID uniqueidentifier NULL
           , USERQUESTIONCODENAME nvarchar (100) NULL
           , HAQUESTIONDOCUMENTID int NULL
           , HAQUESTIONVERSIONID int NULL
           , HAQUESTIONNODEGUID uniqueidentifier NULL
           , USERANSWERITEMID int NULL
           , HAANSWERNODEGUID uniqueidentifier NULL
           , HAANSWERVERSIONID int NULL
           , USERANSWERCODENAME nvarchar (100) NULL
           , HAANSWERVALUE nvarchar (255) NULL
           , HAMODULESCORE float NULL
           , HARISKCATEGORYSCORE float NULL
           , HARISKAREASCORE float NULL
           , HAQUESTIONSCORE float NULL
           , HAANSWERPOINTS int NULL
           , POINTRESULTS int NULL
           , UOMCODE nvarchar (10) NULL
           , HASCORE int NULL
           , MODULEPREWEIGHTEDSCORE float NULL
           , RISKCATEGORYPREWEIGHTEDSCORE float NULL
           , RISKAREAPREWEIGHTEDSCORE float NULL
           , QUESTIONPREWEIGHTEDSCORE float NULL
           , QUESTIONGROUPCODENAME nvarchar (100) NULL
           , ITEMCREATEDWHEN datetime NULL
           , ITEMMODIFIEDWHEN datetime NULL
           , ISPROFESSIONALLYCOLLECTED bit NULL
           , HARISKCATEGORY_ITEMMODIFIEDWHEN datetime NULL
           , HAUSERRISKAREA_ITEMMODIFIEDWHEN datetime NULL
           , HAUSERQUESTION_ITEMMODIFIEDWHEN datetime NULL
           , HAUSERANSWERS_ITEMMODIFIEDWHEN datetime NULL
           , HAPAPERFLG bit NULL
           , HATELEPHONICFLG bit NULL
           , HASTARTEDMODE int NULL
           , HACOMPLETEDMODE int NULL
           , DOCUMENTCULTURE_VHCJ nvarchar (10) NULL
           , DOCUMENTCULTURE_HAQUESTIONSVIEW nvarchar (10) NULL
           , CAMPAIGNNODEGUID uniqueidentifier NULL
           , HACAMPAIGNID int NULL
           , HASHCODE varchar (100) NULL
           , PKHASHCODE varchar (100) NULL
           , CHANGED_FLG int NULL
           , LASTMODIFIEDDATE datetime NULL
           , HEALTHASSESSMENTTYPE varchar (9) NULL
           , HAUSERSTARTED_LASTMODIFIED datetime NULL
           , CMSUSER_LASTMODIFIED datetime NULL
           , USERSETTINGS_LASTMODIFIED datetime NULL
           , USERSITE_LASTMODIFIED datetime NULL
           , CMSSITE_LASTMODIFIED datetime NULL
           , ACCT_LASTMODIFIED datetime NULL
           , HAUSERMODULE_LASTMODIFIED datetime NULL
           , VHCJ_LASTMODIFIED datetime NULL
           , VHAJ_LASTMODIFIED datetime NULL
           , HARISKCATEGORY_LASTMODIFIED datetime NULL
           , HAUSERRISKAREA_LASTMODIFIED datetime NULL
           , HAUSERQUESTION_LASTMODIFIED datetime NULL
           , HAQUESTIONSVIEW_LASTMODIFIED datetime NULL
           , HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED datetime NULL
           , HAUSERANSWERS_LASTMODIFIED datetime NULL
           , HAUSERSTARTED_LastUpdateID int NULL
           , CMSUSER_LastUpdateID int NULL
           , USERSETTINGS_LastUpdateID int NULL
           , USERSITE_LastUpdateID int NULL
           , CMSSITE_LastUpdateID datetime NULL
           , ACCT_LastUpdateID datetime NULL
           , HAUSERMODULE_LastUpdateID int NULL
           , VHCJ_LastUpdateID int NULL
           , VHAJ_LastUpdateID int NULL
           , HARISKCATEGORY_LastUpdateID int NULL
           , HAUSERRISKAREA_LastUpdateID int NULL
           , HAUSERQUESTION_LastUpdateID int NULL
           , HAQUESTIONSVIEW_LastUpdateID int NULL
           , HAUSERQUESTIONGROUPRESULTS_LastUpdateID int NULL
           , HAUSERANSWERS_LastUpdateID int NULL
           , LASTUPDATEID int NULL
           , DELETEFLG int NULL
           , SVR nvarchar (128) NULL
           , DBNAME nvarchar (128) NULL
           , DELETEDFLG int NULL
           , RowNbr int NULL
           , TimeZone nvarchar (10) NULL
           , ConvertedToCentralTime bit NULL
) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

SET ANSI_PADDING OFF;

GO

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE name = 'PI_EDW_HealthAssessment_Dates') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_Dates ON dbo.DIM_EDW_HealthAssessment ( ItemCreatedWhen , ItemModifiedWhen , HARiskCategory_ItemModifiedWhen , HAUserRiskArea_ItemModifiedWhen , HAUserQuestion_ItemModifiedWhen , HAUserAnswers_ItemModifiedWhen) ON [PRIMARY];
    END;

GO
IF NOT EXISTS
( SELECT
         name
         FROM sys.indexes
         WHERE name = 'PI_EDW_HealthAssessment_NATKEY') 
    BEGIN
        PRINT 'Adding INDEX PI_EDW_HealthAssessment_NATKEY at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
        CREATE CLUSTERED INDEX PI_EDW_HealthAssessment_NATKEY ON dbo.DIM_EDW_HealthAssessment (
        UserStartedItemID
        , UserGUID
        , PKHashCode , HashCode , DeletedFlg) ;
    END;

GO

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE name = 'PI_EDW_HealthAssessment_Dates') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_Dates ON dbo.DIM_EDW_HealthAssessment
        (
        ITEMMODIFIEDWHEN ASC,
        HAUSERSTARTED_LASTMODIFIED ASC,
        CMSUSER_LASTMODIFIED ASC,
        USERSETTINGS_LASTMODIFIED ASC,
        USERSITE_LASTMODIFIED ASC,
        CMSSITE_LASTMODIFIED ASC,
        ACCT_LASTMODIFIED ASC,
        HAUSERMODULE_LASTMODIFIED ASC,
        VHCJ_LASTMODIFIED ASC,
        VHAJ_LASTMODIFIED ASC,
        HARISKCATEGORY_LASTMODIFIED ASC,
        HAUSERRISKAREA_LASTMODIFIED ASC,
        HAUSERQUESTION_LASTMODIFIED ASC,
        HAQUESTIONSVIEW_LASTMODIFIED ASC,
        HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED ASC,
        HAUSERANSWERS_LASTMODIFIED ASC
        )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
    END;
GO
--ALTER TABLE dbo.DIM_EDW_HealthAssessment SET ( LOCK_ESCALATION = TABLE) ;

GO

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthAssessment';

PRINT 'Create Table [dbo].[TEMP_EDW_RewardUserLevel_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_RewardUserLevel_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_RewardUserLevel_DATA;
    END;
GO

CREATE TABLE dbo.TEMP_EDW_RewardUserLevel_DATA (
             UserId int NOT NULL
           , LevelCompletedDt datetime NOT NULL
           , LevelName nvarchar (100) NOT NULL
           , SiteName nvarchar (100) NOT NULL
           , nodeguid uniqueidentifier NOT NULL
           , SiteGuid uniqueidentifier NOT NULL
           , LevelHeader nvarchar (256) NULL
           , GroupHeadingText nvarchar (40) NULL
           , GroupHeadingDescription nvarchar (1024) NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_RewardUserLevel_IDs ON dbo.TEMP_EDW_RewardUserLevel_DATA ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_RewardUserLevel_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO
-- Create Table [dbo].[DIM_EDW_HealthDefinition]

PRINT 'Create Table [dbo].[DIM_EDW_HealthDefinition]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthDefinition') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthDefinition;
    END;

go

CREATE TABLE dbo.DIM_EDW_HealthDefinition (
             SiteGUID int NULL
           , AccountCD int NULL
           , HANodeID int NOT NULL
           , HANodeName nvarchar (100) NOT NULL
           , HADocumentID int NULL
           , HANodeSiteID int NOT NULL
           , HADocPubVerID int NULL
           , ModTitle varchar (max) NULL
           , IntroText varchar (max) NULL
           , ModDocGuid uniqueidentifier NOT NULL
           , ModWeight int NOT NULL
           , ModIsEnabled bit NOT NULL
           , ModCodeName nvarchar (100) NOT NULL
           , ModDocPubVerID int NULL
           , RCTitle varchar (max) NULL
           , RCWeight int NOT NULL
           , RCDocumentGUID uniqueidentifier NOT NULL
           , RCIsEnabled bit NOT NULL
           , RCCodeName nvarchar (100) NOT NULL
           , RCDocPubVerID int NULL
           , RATytle varchar (max) NULL
           , RAWeight int NOT NULL
           , RADocumentGuid uniqueidentifier NOT NULL
           , RAIsEnabled bit NOT NULL
           , RACodeName nvarchar (100) NOT NULL
           , RAScoringStrategyID int NOT NULL
           , RADocPubVerID int NULL
           , QuestionType nvarchar (100) NOT NULL
           , QuesTitle varchar (max) NULL
           , QuesWeight int NOT NULL
           , QuesIsRequired bit NOT NULL
           , QuesDocumentGuid uniqueidentifier NOT NULL
           , QuesIsEnabled bit NOT NULL
           , QuesIsVisible nvarchar (max) NULL
           , QuesIsSTaging bit NOT NULL
           , QuestionCodeName nvarchar (100) NOT NULL
           , QuesDocPubVerID int NULL
           , AnsValue nvarchar (150) NULL
           , AnsPoints int NULL
           , AnsDocumentGuid uniqueidentifier NULL
           , AnsIsEnabled bit NULL
           , AnsCodeName nvarchar (100) NULL
           , AnsUOM nvarchar (5) NULL
           , AnsDocPUbVerID int NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , CmsTreeNodeGuid uniqueidentifier NOT NULL
           , HANodeGUID uniqueidentifier NOT NULL
           , SiteLastModified int NULL
           , Account_ItemModifiedWhen int NULL
           , Campaign_DocumentModifiedWhen int NULL
           , Assessment_DocumentModifiedWhen datetime NULL
           , Module_DocumentModifiedWhen datetime NULL
           , RiskCategory_DocumentModifiedWhen datetime NULL
           , RiskArea_DocumentModifiedWhen datetime NULL
           , Question_DocumentModifiedWhen datetime NULL
           , Answer_DocumentModifiedWhen datetime NULL
           , AllowMultiSelect bit NULL
           , LocID varchar (5) NOT NULL
           , HashCode nvarchar (75) NULL
           , CMS_Class_CtID int NULL
           , CMS_Class_SCV bigint NULL
           , CMS_Document_CtID int NULL
           , CMS_Document_SCV bigint NULL
           , CMS_Site_CtID int NULL
           , CMS_Site_SCV bigint NULL
           , CMS_Tree_CtID int NULL
           , CMS_Tree_SCV bigint NULL
           , CMS_User_CtID int NULL
           , CMS_User_SCV bigint NULL
           , COM_SKU_CtID int NULL
           , COM_SKU_SCV bigint NULL
           , HFit_HealthAssesmentMatrixQuestion_CtID int NULL
           , HFit_HealthAssesmentMatrixQuestion_SCV bigint NULL
           , HFit_HealthAssesmentModule_CtID int NULL
           , HFit_HealthAssesmentModule_SCV bigint NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CtID int NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_SCV bigint NULL
           , HFit_HealthAssesmentRiskArea_CtID int NULL
           , HFit_HealthAssesmentRiskArea_SCV bigint NULL
           , HFit_HealthAssesmentRiskCategory_CtID int NULL
           , HFit_HealthAssesmentRiskCategory_SCV bigint NULL
           , HFit_HealthAssessment_CtID int NULL
           , HFit_HealthAssessment_SCV bigint NULL
           , HFit_HealthAssessmentFreeForm_CtID int NULL
           , HFit_HealthAssessmentFreeForm_SCV bigint NULL
           , CMS_Class_CHANGE_OPERATION nchar (1) NULL
           , CMS_Document_CHANGE_OPERATION nchar (1) NULL
           , CMS_Site_CHANGE_OPERATION nchar (1) NULL
           , CMS_Tree_CHANGE_OPERATION nchar (1) NULL
           , CMS_User_CHANGE_OPERATION nchar (1) NULL
           , COM_SKU_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentModule_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskArea_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessment_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessmentFreeForm_CHANGE_OPERATION nchar (1) NULL
           , CHANGED_FLG int NULL
           , CHANGE_TYPE_CODE nchar (1) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

-- Create Table [dbo].[DIM_EDW_HealthInterestList]

PRINT 'Create Table [dbo].[DIM_EDW_HealthInterestList]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthInterestList') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthInterestList;
    END;
GO

CREATE TABLE dbo.DIM_EDW_HealthInterestList (
             HealthAreaID int NOT NULL
           , NodeID int NOT NULL
           , NodeGuid uniqueidentifier NOT NULL
           , AccountCD nvarchar (8) NULL
           , HealthAreaName nvarchar (100) NOT NULL
           , HealthAreaDescription nvarchar (255) NULL
           , CodeName nvarchar (20) NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime2 (7) NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_HealthInterestList ON dbo.DIM_EDW_HealthInterestList ( HealthAreaID , NodeID , NodeGuid , AccountCD) ON [PRIMARY];

GO

CREATE NONCLUSTERED INDEX PI_EDW_HealthInterestList_RowNbrCDate ON dbo.DIM_EDW_HealthInterestList ( RowNbr , LastModifiedDate , DeletedFlg) ON [PRIMARY];
--ALTER TABLE dbo.DIM_EDW_HealthInterestList SET ( LOCK_ESCALATION = TABLE) ;

GO

PRINT 'Create Table [dbo].[TEMP_EDW_Coaches_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_Coaches_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_Coaches_DATA;
    END;
go

CREATE TABLE dbo.TEMP_EDW_Coaches_DATA (
             UserGUID uniqueidentifier NULL
           , SiteGUID uniqueidentifier NULL
           , AccountID int NULL
           , AccountCD nvarchar (8) NULL
           , CoachID int NOT NULL
           , LastName nvarchar (20) NOT NULL
           , FirstName nvarchar (20) NOT NULL
           , StartDate datetime NOT NULL
           , Phone nvarchar (15) NOT NULL
           , email nvarchar (50) NOT NULL
           , Supervisor int NOT NULL
           , SuperCoach bit NOT NULL
           , MaxParticipants int NOT NULL
           , Inactive bit NOT NULL
           , MaxRiskLevel nvarchar (10) NOT NULL
           , Locked bit NOT NULL
           , TimeLocked datetime NULL
           , terminated bit NOT NULL
           , APMaxParticipants int NULL
           , RNMaxParticipants int NULL
           , RNPMaxParticipants int NULL
           , Change_Type nvarchar (1) NULL
           , Last_Update_Dt datetime NULL
           , HashCode nvarchar (75) NULL) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_Coaches_IDs ON dbo.TEMP_EDW_Coaches_DATA ( UserGUID , SiteGUID , AccountID , AccountCD , CoachID , email) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_Coaches_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO
-- Create Table [dbo].[DIM_EDW_Trackers]

PRINT 'Create Table [dbo].[DIM_EDW_Trackers]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_Trackers') 

    BEGIN

        DROP TABLE
             DIM_EDW_Trackers;
    END;

GO

CREATE TABLE dbo.DIM_EDW_Trackers (
             TrackerNameAggregateTable varchar (32) NOT NULL
           , ItemID int NOT NULL
           , EventDate datetime NOT NULL
           , IsProfessionallyCollected bit NOT NULL
           , TrackerCollectionSourceID int NOT NULL
           , Notes nvarchar (1000) NULL
           , UserID int NOT NULL
           , CollectionSourceName_Internal nvarchar (100) NULL
           , CollectionSourceName_External nvarchar (100) NULL
           , EventName varchar (7) NOT NULL
           , UOM varchar (10) NOT NULL
           , KEY1 varchar (18) NOT NULL
           , VAL1 float NULL
           , KEY2 varchar (13) NOT NULL
           , VAL2 float NULL
           , KEY3 varchar (12) NOT NULL
           , VAL3 float NULL
           , KEY4 varchar (9) NOT NULL
           , VAL4 float NULL
           , KEY5 varchar (12) NOT NULL
           , VAL5 float NULL
           , KEY6 varchar (11) NOT NULL
           , VAL6 float NULL
           , KEY7 varchar (10) NOT NULL
           , VAL7 float NULL
           , KEY8 varchar (3) NOT NULL
           , VAL8 float NULL
           , KEY9 varchar (2) NOT NULL
           , VAL9 int NULL
           , KEY10 varchar (2) NOT NULL
           , VAL10 int NULL
           , ItemCreatedBy int NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedBy int NULL
           , ItemModifiedWhen datetime NULL
           , IsProcessedForHa bit NULL
           , TXTKEY1 varchar (10) NOT NULL
           , TXTVAL1 nvarchar (500) NULL
           , TXTKEY2 varchar (8) NOT NULL
           , TXTVAL2 nvarchar (255) NULL
           , TXTKEY3 varchar (2) NOT NULL
           , TXTVAL3 int NULL
           , ItemOrder int NULL
           , ItemGuid uniqueidentifier NULL
           , UserGuid uniqueidentifier NOT NULL
           , MPI varchar (50) NOT NULL
           , ClientCode varchar (12) NULL
           , SiteGUID uniqueidentifier NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , IsAvailable bit NULL
           , IsCustom bit NULL
           , UniqueName nvarchar (50) NULL
           , ColDesc nvarchar (50) NULL
           , VendorID int NULL
           , VendorName nvarchar (32) NULL
           , CT_ItemID int NULL
           , CT_ChangeVersion bigint NULL
           , CMS_Operation nchar (1) NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10) 
           , ItemLastUpdated datetime NULL
) 
ON [PRIMARY];

GO

CREATE NONCLUSTERED INDEX PI_EDW_Tracker_Dates ON dbo.DIM_EDW_Trackers ( TrackerNameAggregateTable , ItemID , ItemModifiedWhen) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_Trackers SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_RewardAwardDetail]

PRINT 'Create Table [dbo].[DIM_EDW_RewardAwardDetail]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_RewardAwardDetail') 

    BEGIN

        DROP TABLE
             DIM_EDW_RewardAwardDetail;
    END;
go

CREATE TABLE dbo.DIM_EDW_RewardAwardDetail (
             UserGUID uniqueidentifier NOT NULL
           , SiteGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , RewardLevelGUID uniqueidentifier NOT NULL
           , AwardType int NOT NULL
           , AwardDisplayName nvarchar (100) NOT NULL
           , RewardValue float NULL
           , ThresholdNumber int NOT NULL
           , UserNotified bit NOT NULL
           , IsFulfilled bit NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO


CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_IDs ON dbo.DIM_EDW_RewardAwardDetail ( UserGUID , SiteGUID , HFitUserMpiNumber , RewardLevelGUID , AwardType , AwardDisplayName , RewardValue , ThresholdNumber , UserNotified , IsFulfilled , AccountID , AccountCD) ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_RewardAwardDetail_IDs ON dbo.DIM_EDW_RewardAwardDetail ( UserGUID , SiteGUID , HFitUserMpiNumber , RewardLevelGUID , AwardType , AwardDisplayName , RewardValue , ThresholdNumber , UserNotified , IsFulfilled , AccountID , AccountCD) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_RewardAwardDetail SET ( LOCK_ESCALATION = TABLE) ;

GO
-- Create Table [dbo].[DIM_EDW_HealthInterestDetail]

PRINT 'Create Table [dbo].[DIM_EDW_HealthInterestDetail]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthInterestDetail') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthInterestDetail;
    END;
GO

CREATE TABLE dbo.DIM_EDW_HealthInterestDetail (
             UserID int NULL
           , UserGUID uniqueidentifier NULL
           , HFitUserMpiNumber bigint NULL
           , SiteGUID uniqueidentifier NULL
           , CoachingHealthInterestID int NULL
           , FirstHealthAreaID int NULL
           , FirstNodeID int NULL
           , FirstNodeGuid uniqueidentifier NULL
           , FirstHealthAreaName nvarchar (100) NULL
           , FirstHealthAreaDescription nvarchar (255) NULL
           , FirstCodeName nvarchar (20) NULL
           , SecondHealthAreaID int NULL
           , SecondNodeID int NULL
           , SecondNodeGuid uniqueidentifier NULL
           , SecondHealthAreaName nvarchar (100) NULL
           , SecondHealthAreaDescription nvarchar (255) NULL
           , SecondCodeName nvarchar (20) NULL
           , ThirdHealthAreaID int NULL
           , ThirdNodeID int NULL
           , ThirdNodeGuid uniqueidentifier NULL
           , ThirdHealthAreaName nvarchar (100) NULL
           , ThirdHealthAreaDescription nvarchar (255) NULL
           , ThirdCodeName nvarchar (20) NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedWhen datetime NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime2 (7) NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10) NULL) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_HealthInterestDetail ON dbo.DIM_EDW_HealthInterestDetail ( UserID , UserGUID , HFitUserMpiNumber , SiteGUID , CoachingHealthInterestID , FirstNodeID , SecondNodeGuid , ThirdNodeGuid) ON [PRIMARY];

GO
CREATE NONCLUSTERED INDEX PI_EDW_HealthInterestDetail_RowNbrCDate ON dbo.DIM_EDW_HealthInterestDetail ( LastModifiedDate , DeletedFlg) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_HealthInterestDetail SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_HealthAssesmentClientView]

PRINT 'Create Table [dbo].[DIM_EDW_HealthAssesmentClientView]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthAssesmentClientView') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthAssesmentClientView;
    END;

GO

CREATE TABLE dbo.DIM_EDW_HealthAssesmentClientView (
             AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , AccountName nvarchar (200) NULL
           , ClientGuid uniqueidentifier NOT NULL
           , SiteGUID uniqueidentifier NOT NULL
           , CompanyID int NULL
           , CompanyGUID int NULL
           , CompanyName int NULL
           , DocumentName nvarchar (100) NOT NULL
           , HAStartDate datetime NULL
           , HAEndDate datetime NULL
           , NodeSiteID int NOT NULL
           , Title nvarchar (150) NOT NULL
           , CodeName nvarchar (100) NOT NULL
           , IsEnabled bit NOT NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , AssesmentModule_DocumentModifiedWhen datetime NULL
           , DocumentCulture_HAAssessmentMod nvarchar (10) NOT NULL
           , DocumentCulture_HACampaign nvarchar (10) NOT NULL
           , DocumentCulture_HAJoined nvarchar (10) NOT NULL
           , BiometricCampaignStartDate datetime NULL
           , BiometricCampaignEndDate datetime NULL
           , CampaignStartDate datetime NOT NULL
           , CampaignEndDate datetime NOT NULL
           , Name nvarchar (200) NOT NULL
           , CampaignNodeGuid uniqueidentifier NOT NULL
           , HACampaignID int NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime2 (7) NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_HealthAssesmentClientView ON dbo.DIM_EDW_HealthAssesmentClientView ( AccountID , AccountCD , AccountName , ClientGuid , SiteGUID , NodeSiteID , CampaignNodeGuid , HACampaignID , CodeName) ON [PRIMARY];

GO
CREATE NONCLUSTERED INDEX PI_EDW_HealthAssesmentClientView_RowNbrCDate ON dbo.DIM_EDW_HealthAssesmentClientView ( RowNbr , LastModifiedDate , DeletedFlg) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_HealthAssesmentClientView SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_CoachingDetail]

PRINT 'Create Table [dbo].[DIM_EDW_CoachingDetail]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_CoachingDetail') 

    BEGIN

        DROP TABLE
             DIM_EDW_CoachingDetail;
    END;

GO

CREATE TABLE dbo.DIM_EDW_CoachingDetail (
             ItemID int NOT NULL
           , ItemGUID uniqueidentifier NOT NULL
           , GoalID int NOT NULL
           , UserID int NOT NULL
           , UserGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , SiteGUID uniqueidentifier NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , AccountName nvarchar (200) NULL
           , IsCreatedByCoach bit NOT NULL
           , BaselineAmount float NOT NULL
           , GoalAmount float NOT NULL
           , DocumentID int NULL
           , GoalStatusLKPID int NOT NULL
           , GoalStatusLKPName nvarchar (100) NOT NULL
           , EvaluationStartDate datetime NULL
           , EvaluationEndDate datetime NULL
           , GoalStartDate datetime NOT NULL
           , CoachDescription nvarchar (500) NULL
           , EvaluationDate datetime NULL
           , Passed bit NULL
           , WeekendDate datetime NULL
           , ChangeType varchar (1) NOT NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedWhen datetime NULL
           , NodeGUID uniqueidentifier NOT NULL
           , CloseReasonLKPID int NOT NULL
           , CloseReason varchar (250) NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_CoachingDetail_IDs ON dbo.DIM_EDW_CoachingDetail ( ItemID , ItemGUID , GoalID , UserID , UserGUID , HFitUserMpiNumber , SiteGUID , AccountID , AccountCD , WeekendDate) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_CoachingDetail SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_RewardUserDetail]

PRINT 'Create Table [dbo].[DIM_EDW_RewardUserDetail]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_RewardUserDetail') 

    BEGIN

        DROP TABLE
             DIM_EDW_RewardUserDetail;
    END;

CREATE TABLE dbo.DIM_EDW_RewardUserDetail (
             UserGUID uniqueidentifier NOT NULL
           , SiteGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , RewardActivityGUID uniqueidentifier NULL
           , RewardProgramName nvarchar (100) NOT NULL
           , RewardModifiedDate datetime NULL
           , RewardGroupGUID uniqueidentifier NULL
           , RewardLevelModifiedDate datetime NULL
           , LevelCompletedDt datetime NOT NULL
           , ActivityPointsEarned int NOT NULL
           , ActivityCompletedDt datetime NOT NULL
           , RewardActivityModifiedDate datetime NULL
           , ActivityPoints float NULL
           , UserAccepted int NULL
           , UserExceptionAppliedTo int NULL
           , RewardTriggerGUID uniqueidentifier NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , HashCode nvarchar (75) NULL
           , DeletedFlg int NULL
           , LastModifiedDate datetime2 (7) NULL
           , RowNbr int NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10) 
           , RewardExceptionModifiedDate datetime NULL) ;

GO

CREATE CLUSTERED INDEX PI_EDW_RewardUserDetail ON dbo.DIM_EDW_RewardUserDetail ( UserGUID , AccountID , AccountCD , SiteGUID , HFitUserMpiNumber , RewardActivityGUID , RewardTriggerGUID) ON [PRIMARY];

GO

CREATE NONCLUSTERED INDEX PI_EDW_RewardUserDetail_RowNbrCDate ON dbo.DIM_EDW_RewardUserDetail ( RowNbr , LastModifiedDate , DeletedFlg) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_RewardUserDetail SET ( LOCK_ESCALATION = TABLE) ;

GO
-- Create Table [dbo].[DIM_EDW_Coaches]

PRINT 'Create Table [dbo].[DIM_EDW_Coaches]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_Coaches') 

    BEGIN

        DROP TABLE
             DIM_EDW_Coaches;
    END;
GO

CREATE TABLE dbo.DIM_EDW_Coaches (
             UserGUID uniqueidentifier NULL
           , SiteGUID uniqueidentifier NULL
           , AccountID int NULL
           , AccountCD nvarchar (8) NULL
           , CoachID int NOT NULL
           , LastName nvarchar (20) NOT NULL
           , FirstName nvarchar (20) NOT NULL
           , StartDate datetime NOT NULL
           , Phone nvarchar (15) NOT NULL
           , email nvarchar (50) NOT NULL
           , Supervisor int NOT NULL
           , SuperCoach bit NOT NULL
           , MaxParticipants int NOT NULL
           , Inactive bit NOT NULL
           , MaxRiskLevel nvarchar (10) NOT NULL
           , Locked bit NOT NULL
           , TimeLocked datetime NULL
           , terminated bit NOT NULL
           , APMaxParticipants int NULL
           , RNMaxParticipants int NULL
           , RNPMaxParticipants int NULL
           , Change_Type nvarchar (1) NULL
           , Last_Update_Dt datetime NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO
CREATE CLUSTERED INDEX PI_EDW_Coaches_IDs ON dbo.DIM_EDW_Coaches ( UserGUID , SiteGUID , AccountID , AccountCD , CoachID , email) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_Coaches SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_RewardTriggerParameters]

PRINT 'Create Table [dbo].[DIM_EDW_RewardTriggerParameters]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_RewardTriggerParameters') 

    BEGIN

        DROP TABLE
             DIM_EDW_RewardTriggerParameters;
    END;
GO

CREATE TABLE dbo.DIM_EDW_RewardTriggerParameters (
             SiteGUID uniqueidentifier NOT NULL
           , RewardTriggerID int NOT NULL
           , TriggerName nvarchar (100) NOT NULL
           , RewardTriggerParameterOperatorLKPDisplayName nvarchar (255) NOT NULL
           , ParameterDisplayName nvarchar (250) NOT NULL
           , RewardTriggerParameterOperator int NOT NULL
           , [Value] float NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentGuid uniqueidentifier NULL
           , NodeGuid uniqueidentifier NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , RewardTriggerParameter_DocumentModifiedWhen datetime NULL
           , documentculture_VHFRTPJ nvarchar (10) NOT NULL
           , documentculture_VHFRTJ nvarchar (10) NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_RewardTriggerParameters_IDs ON dbo.DIM_EDW_RewardTriggerParameters ( SiteGUID , RewardTriggerID , ParameterDisplayName , RewardTriggerParameterOperator , [Value] , AccountID , AccountCD , DocumentGuid , NodeGuid) ON [PRIMARY];

GO
--ALTER TABLE dbo.DIM_EDW_RewardTriggerParameters SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[TEMP_EDW_RewardTriggerParameters_DATA]

PRINT 'Create Table [dbo].[TEMP_EDW_RewardTriggerParameters_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_RewardTriggerParameters_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_RewardTriggerParameters_DATA;
    END;

GO

CREATE TABLE dbo.TEMP_EDW_RewardTriggerParameters_DATA (
             SiteGUID uniqueidentifier NOT NULL
           , RewardTriggerID int NOT NULL
           , TriggerName nvarchar (100) NOT NULL
           , RewardTriggerParameterOperatorLKPDisplayName nvarchar (255) NOT NULL
           , ParameterDisplayName nvarchar (250) NOT NULL
           , RewardTriggerParameterOperator int NOT NULL
           , [Value] float NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentGuid uniqueidentifier NULL
           , NodeGuid uniqueidentifier NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , RewardTriggerParameter_DocumentModifiedWhen datetime NULL
           , documentculture_VHFRTPJ nvarchar (10) NOT NULL
           , documentculture_VHFRTJ nvarchar (10) NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_HealthAssessment_IDs ON dbo.TEMP_EDW_RewardTriggerParameters_DATA ( SiteGUID , RewardTriggerID , ParameterDisplayName , RewardTriggerParameterOperator , [Value] , AccountID , AccountCD , DocumentGuid , NodeGuid) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_RewardTriggerParameters_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[TEMP_EDW_CoachingDetail_DATA]

PRINT 'Create Table [dbo].[TEMP_EDW_CoachingDetail_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_CoachingDetail_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_CoachingDetail_DATA;
    END;
GO

CREATE TABLE dbo.TEMP_EDW_CoachingDetail_DATA (
             ItemID int NOT NULL
           , ItemGUID uniqueidentifier NOT NULL
           , GoalID int NOT NULL
           , UserID int NOT NULL
           , UserGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , SiteGUID uniqueidentifier NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , AccountName nvarchar (200) NULL
           , IsCreatedByCoach bit NOT NULL
           , BaselineAmount float NOT NULL
           , GoalAmount float NOT NULL
           , DocumentID int NULL
           , GoalStatusLKPID int NOT NULL
           , GoalStatusLKPName nvarchar (100) NOT NULL
           , EvaluationStartDate datetime NULL
           , EvaluationEndDate datetime NULL
           , GoalStartDate datetime NOT NULL
           , CoachDescription nvarchar (500) NULL
           , EvaluationDate datetime NULL
           , Passed bit NULL
           , WeekendDate datetime NULL
           , ChangeType varchar (1) NOT NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedWhen datetime NULL
           , NodeGUID uniqueidentifier NOT NULL
           , CloseReasonLKPID int NOT NULL
           , CloseReason varchar (250) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_CoachingDetail_IDs ON dbo.TEMP_EDW_CoachingDetail_DATA ( ItemID , ItemGUID , GoalID , UserID , UserGUID , HFitUserMpiNumber , SiteGUID , AccountID , AccountCD , WeekendDate) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_CoachingDetail_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[TEMP_EDW_HealthDefinition_DATA]

PRINT 'Create Table [dbo].[TEMP_EDW_HealthDefinition_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_HealthDefinition_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_HealthDefinition_DATA;
    END;
GO

CREATE TABLE dbo.TEMP_EDW_HealthDefinition_DATA (
             SiteGUID int NULL
           , AccountCD int NULL
           , HANodeID int NOT NULL
           , HANodeName nvarchar (100) NOT NULL
           , HADocumentID int NULL
           , HANodeSiteID int NOT NULL
           , HADocPubVerID int NULL
           , ModTitle varchar (max) NULL
           , IntroText varchar (max) NULL
           , ModDocGuid uniqueidentifier NOT NULL
           , ModWeight int NOT NULL
           , ModIsEnabled bit NOT NULL
           , ModCodeName nvarchar (100) NOT NULL
           , ModDocPubVerID int NULL
           , RCTitle varchar (max) NULL
           , RCWeight int NOT NULL
           , RCDocumentGUID uniqueidentifier NOT NULL
           , RCIsEnabled bit NOT NULL
           , RCCodeName nvarchar (100) NOT NULL
           , RCDocPubVerID int NULL
           , RATytle varchar (max) NULL
           , RAWeight int NOT NULL
           , RADocumentGuid uniqueidentifier NOT NULL
           , RAIsEnabled bit NOT NULL
           , RACodeName nvarchar (100) NOT NULL
           , RAScoringStrategyID int NOT NULL
           , RADocPubVerID int NULL
           , QuestionType nvarchar (100) NOT NULL
           , QuesTitle varchar (max) NULL
           , QuesWeight int NOT NULL
           , QuesIsRequired bit NOT NULL
           , QuesDocumentGuid uniqueidentifier NOT NULL
           , QuesIsEnabled bit NOT NULL
           , QuesIsVisible nvarchar (max) NULL
           , QuesIsSTaging bit NOT NULL
           , QuestionCodeName nvarchar (100) NOT NULL
           , QuesDocPubVerID int NULL
           , AnsValue nvarchar (150) NULL
           , AnsPoints int NULL
           , AnsDocumentGuid uniqueidentifier NULL
           , AnsIsEnabled bit NULL
           , AnsCodeName nvarchar (100) NULL
           , AnsUOM nvarchar (5) NULL
           , AnsDocPUbVerID int NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , CmsTreeNodeGuid uniqueidentifier NOT NULL
           , HANodeGUID uniqueidentifier NOT NULL
           , SiteLastModified int NULL
           , Account_ItemModifiedWhen int NULL
           , Campaign_DocumentModifiedWhen int NULL
           , Assessment_DocumentModifiedWhen datetime NULL
           , Module_DocumentModifiedWhen datetime NULL
           , RiskCategory_DocumentModifiedWhen datetime NULL
           , RiskArea_DocumentModifiedWhen datetime NULL
           , Question_DocumentModifiedWhen datetime NULL
           , Answer_DocumentModifiedWhen datetime NULL
           , AllowMultiSelect bit NULL
           , LocID varchar (5) NOT NULL
           , HashCode nvarchar (75) NULL
           , CMS_Class_CtID int NULL
           , CMS_Class_SCV bigint NULL
           , CMS_Document_CtID int NULL
           , CMS_Document_SCV bigint NULL
           , CMS_Site_CtID int NULL
           , CMS_Site_SCV bigint NULL
           , CMS_Tree_CtID int NULL
           , CMS_Tree_SCV bigint NULL
           , CMS_User_CtID int NULL
           , CMS_User_SCV bigint NULL
           , COM_SKU_CtID int NULL
           , COM_SKU_SCV bigint NULL
           , HFit_HealthAssesmentMatrixQuestion_CtID int NULL
           , HFit_HealthAssesmentMatrixQuestion_SCV bigint NULL
           , HFit_HealthAssesmentModule_CtID int NULL
           , HFit_HealthAssesmentModule_SCV bigint NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CtID int NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_SCV bigint NULL
           , HFit_HealthAssesmentRiskArea_CtID int NULL
           , HFit_HealthAssesmentRiskArea_SCV bigint NULL
           , HFit_HealthAssesmentRiskCategory_CtID int NULL
           , HFit_HealthAssesmentRiskCategory_SCV bigint NULL
           , HFit_HealthAssessment_CtID int NULL
           , HFit_HealthAssessment_SCV bigint NULL
           , HFit_HealthAssessmentFreeForm_CtID int NULL
           , HFit_HealthAssessmentFreeForm_SCV bigint NULL
           , CMS_Class_CHANGE_OPERATION nchar (1) NULL
           , CMS_Document_CHANGE_OPERATION nchar (1) NULL
           , CMS_Site_CHANGE_OPERATION nchar (1) NULL
           , CMS_Tree_CHANGE_OPERATION nchar (1) NULL
           , CMS_User_CHANGE_OPERATION nchar (1) NULL
           , COM_SKU_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentModule_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskArea_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessment_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessmentFreeForm_CHANGE_OPERATION nchar (1) NULL
           , CHANGED_FLG int NULL
           , CHANGE_TYPE_CODE nchar (1) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_HealthAssessment_IDs ON dbo.TEMP_EDW_HealthDefinition_DATA ( RCDocumentGUID , RADocumentGuid , RACodeName , QuesDocumentGuid , AnsDocumentGuid , HANodeSiteID) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_HealthDefinition_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[TEMP_EDW_Tracker_DATA]

PRINT 'Create Table [dbo].[TEMP_EDW_Tracker_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_Tracker_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_Tracker_DATA;
    END;
GO

CREATE TABLE dbo.TEMP_EDW_Tracker_DATA (
             TrackerNameAggregateTable varchar (32) NOT NULL
           , ItemID int NOT NULL
           , EventDate datetime NOT NULL
           , IsProfessionallyCollected bit NOT NULL
           , TrackerCollectionSourceID int NOT NULL
           , Notes nvarchar (1000) NULL
           , UserID int NOT NULL
           , CollectionSourceName_Internal nvarchar (100) NULL
           , CollectionSourceName_External nvarchar (100) NULL
           , EventName varchar (7) NOT NULL
           , UOM varchar (10) NOT NULL
           , KEY1 varchar (18) NOT NULL
           , VAL1 float NULL
           , KEY2 varchar (13) NOT NULL
           , VAL2 float NULL
           , KEY3 varchar (12) NOT NULL
           , VAL3 float NULL
           , KEY4 varchar (9) NOT NULL
           , VAL4 float NULL
           , KEY5 varchar (12) NOT NULL
           , VAL5 float NULL
           , KEY6 varchar (11) NOT NULL
           , VAL6 float NULL
           , KEY7 varchar (10) NOT NULL
           , VAL7 float NULL
           , KEY8 varchar (3) NOT NULL
           , VAL8 float NULL
           , KEY9 varchar (2) NOT NULL
           , VAL9 int NULL
           , KEY10 varchar (2) NOT NULL
           , VAL10 int NULL
           , ItemCreatedBy int NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedBy int NULL
           , ItemModifiedWhen datetime NULL
           , IsProcessedForHa bit NULL
           , TXTKEY1 varchar (10) NOT NULL
           , TXTVAL1 nvarchar (500) NULL
           , TXTKEY2 varchar (8) NOT NULL
           , TXTVAL2 nvarchar (255) NULL
           , TXTKEY3 varchar (2) NOT NULL
           , TXTVAL3 int NULL
           , ItemOrder int NULL
           , ItemGuid uniqueidentifier NULL
           , UserGuid uniqueidentifier NOT NULL
           , MPI varchar (50) NOT NULL
           , ClientCode varchar (12) NULL
           , SiteGUID uniqueidentifier NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , IsAvailable bit NULL
           , IsCustom bit NULL
           , UniqueName nvarchar (50) NULL
           , ColDesc nvarchar (50) NULL
           , VendorID int NULL
           , VendorName nvarchar (32) NULL
           , CT_ItemID int NULL
           , CT_ChangeVersion bigint NULL
           , CMS_Operation nchar (1) NULL
           , DeleteFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10) 
           , ItemLastUpdated datetime NULL) 
ON [PRIMARY];

GO

ALTER TABLE dbo.TEMP_EDW_Tracker_DATA
ADD
            CONSTRAINT DF__TEMP_Stag__ItemL__251061DB DEFAULT GETDATE () FOR ItemLastUpdated;

GO

CREATE CLUSTERED INDEX temp_PI_EDW_Tracker_IDs ON dbo.TEMP_EDW_Tracker_DATA ( TrackerNameAggregateTable , ItemID , ItemModifiedWhen) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_Tracker_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO
-- Create Table [dbo].[DIM_EDW_HealthAssessmentDefinition]

PRINT 'Create Table [dbo].[DIM_EDW_HealthAssessmentDefinition]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_HealthAssessmentDefinition') 

    BEGIN

        DROP TABLE
             DIM_EDW_HealthAssessmentDefinition;
    END;
GO

CREATE TABLE dbo.DIM_EDW_HealthAssessmentDefinition (
             SiteGUID int NULL
           , AccountCD int NULL
           , HANodeID int NOT NULL
           , HANodeName nvarchar (100) NOT NULL
           , HADocumentID int NULL
           , HANodeSiteID int NOT NULL
           , HADocPubVerID int NULL
           , ModTitle varchar (max) NULL
           , IntroText varchar (max) NULL
           , ModDocGuid uniqueidentifier NOT NULL
           , ModWeight int NOT NULL
           , ModIsEnabled bit NOT NULL
           , ModCodeName nvarchar (100) NOT NULL
           , ModDocPubVerID int NULL
           , RCTitle varchar (max) NULL
           , RCWeight int NOT NULL
           , RCDocumentGUID uniqueidentifier NOT NULL
           , RCIsEnabled bit NOT NULL
           , RCCodeName nvarchar (100) NOT NULL
           , RCDocPubVerID int NULL
           , RATytle varchar (max) NULL
           , RAWeight int NOT NULL
           , RADocumentGuid uniqueidentifier NOT NULL
           , RAIsEnabled bit NOT NULL
           , RACodeName nvarchar (100) NOT NULL
           , RAScoringStrategyID int NOT NULL
           , RADocPubVerID int NULL
           , QuestionType nvarchar (100) NOT NULL
           , QuesTitle varchar (max) NULL
           , QuesWeight int NOT NULL
           , QuesIsRequired bit NOT NULL
           , QuesDocumentGuid uniqueidentifier NOT NULL
           , QuesIsEnabled bit NOT NULL
           , QuesIsVisible nvarchar (max) NULL
           , QuesIsSTaging bit NOT NULL
           , QuestionCodeName nvarchar (100) NOT NULL
           , QuesDocPubVerID int NULL
           , AnsValue nvarchar (150) NULL
           , AnsPoints int NULL
           , AnsDocumentGuid uniqueidentifier NULL
           , AnsIsEnabled bit NULL
           , AnsCodeName nvarchar (100) NULL
           , AnsUOM nvarchar (5) NULL
           , AnsDocPUbVerID int NULL
           , ChangeType varchar (1) NOT NULL
           , DocumentCreatedWhen datetime NULL
           , DocumentModifiedWhen datetime NULL
           , CmsTreeNodeGuid uniqueidentifier NOT NULL
           , HANodeGUID uniqueidentifier NOT NULL
           , SiteLastModified int NULL
           , Account_ItemModifiedWhen int NULL
           , Campaign_DocumentModifiedWhen int NULL
           , Assessment_DocumentModifiedWhen datetime NULL
           , Module_DocumentModifiedWhen datetime NULL
           , RiskCategory_DocumentModifiedWhen datetime NULL
           , RiskArea_DocumentModifiedWhen datetime NULL
           , Question_DocumentModifiedWhen datetime NULL
           , Answer_DocumentModifiedWhen datetime NULL
           , AllowMultiSelect bit NULL
           , LocID varchar (5) NOT NULL
           , CMS_Class_CtID int NULL
           , CMS_Class_SCV bigint NULL
           , CMS_Document_CtID int NULL
           , CMS_Document_SCV bigint NULL
           , CMS_Site_CtID int NULL
           , CMS_Site_SCV bigint NULL
           , CMS_Tree_CtID int NULL
           , CMS_Tree_SCV bigint NULL
           , CMS_User_CtID int NULL
           , CMS_User_SCV bigint NULL
           , COM_SKU_CtID int NULL
           , COM_SKU_SCV bigint NULL
           , HFit_HealthAssesmentMatrixQuestion_CtID int NULL
           , HFit_HealthAssesmentMatrixQuestion_SCV bigint NULL
           , HFit_HealthAssesmentModule_CtID int NULL
           , HFit_HealthAssesmentModule_SCV bigint NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CtID int NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_SCV bigint NULL
           , HFit_HealthAssesmentRiskArea_CtID int NULL
           , HFit_HealthAssesmentRiskArea_SCV bigint NULL
           , HFit_HealthAssesmentRiskCategory_CtID int NULL
           , HFit_HealthAssesmentRiskCategory_SCV bigint NULL
           , HFit_HealthAssessment_CtID int NULL
           , HFit_HealthAssessment_SCV bigint NULL
           , HFit_HealthAssessmentFreeForm_CtID int NULL
           , HFit_HealthAssessmentFreeForm_SCV bigint NULL
           , CMS_Class_CHANGE_OPERATION nchar (1) NULL
           , CMS_Document_CHANGE_OPERATION nchar (1) NULL
           , CMS_Site_CHANGE_OPERATION nchar (1) NULL
           , CMS_Tree_CHANGE_OPERATION nchar (1) NULL
           , CMS_User_CHANGE_OPERATION nchar (1) NULL
           , COM_SKU_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentModule_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskArea_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessment_CHANGE_OPERATION nchar (1) NULL
           , HFit_HealthAssessmentFreeForm_CHANGE_OPERATION nchar (1) NULL
           , CHANGED_FLG int NULL
           , CHANGE_TYPE_CODE nchar (1) NULL) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_HealthAssessmentDefinition SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_SmallSteps]

PRINT 'Create Table [dbo].[DIM_EDW_SmallSteps]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_SmallSteps') 

    BEGIN

        DROP TABLE
             dbo.DIM_EDW_SmallSteps;
    END;

GO

SET ANSI_NULLS ON;

GO

SET QUOTED_IDENTIFIER ON;

GO

SET ANSI_PADDING ON;

GO

CREATE TABLE dbo.DIM_EDW_SmallSteps (
             UserID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , SiteGUID uniqueidentifier NOT NULL
           , SSItemID int NOT NULL
           , SSItemCreatedBy int NULL
           , SSItemCreatedWhen datetime NULL
           , SSItemModifiedBy int NULL
           , SSItemModifiedWhen datetime NULL
           , SSItemOrder int NULL
           , SSItemGUID uniqueidentifier NOT NULL
           , SSHealthAssesmentUserStartedItemID int NOT NULL
           , SSOutcomeMessageGuid uniqueidentifier NOT NULL
           , SSOutcomeMessage nvarchar (max) NULL
           , HACampaignNodeGUID uniqueidentifier NOT NULL
           , HACampaignName nvarchar (200) NOT NULL
           , HACampaignStartDate datetime NOT NULL
           , HACampaignEndDate datetime NOT NULL
           , HAStartedDate datetime NOT NULL
           , HACompletedDate datetime NULL
           , HAStartedMode int NOT NULL
           , HACompletedMode int NOT NULL
           , HaCodeName nvarchar (100) NULL
           , HFitUserMPINumber bigint NULL
           , HashCode nvarchar (75) NULL
           , ChangeType nchar (1) NULL
           , CT_UserSettingsID int NULL
           , CT_UserSettings_CHANGE_OPERATION nchar (1) NULL
           , CT_CMS_UserSettings_SCV bigint NULL
           , SiteID_CtID int NULL
           , SiteID_CHANGE_OPERATION nchar (1) NULL
           , SITE_SCV bigint NULL
           , Campaign_CtID int NULL
           , Campaign_CHANGE_OPERATION nchar (1) NULL
           , Campaign_SCV bigint NULL
           , HealthAssesmentUserStarted_CtID int NULL
           , HealthAssesmentUserStarted_CHANGE_OPERATION nchar (1) NULL
           , HealthAssesmentUserStarted_SCV bigint NULL
           , OutComeMessages_CtID int NULL
           , OutComeMessages_CHANGE_OPERATION nchar (1) NULL
           , OutComeMessages_SCV bigint NULL
           , HFit_Account_CtID int NULL
           , HFit_Account_CHANGE_OPERATION nchar (1) NULL
           , HFit_Account_SCV bigint NULL
           , ToDoSmallSteps_CtID int NULL
           , ToDoSmallSteps_CHANGE_OPERATION nchar (1) NULL
           , ToDoSmallSteps_SCV bigint NULL
           , LastModifiedDate datetime2 (7) NULL
           , RowNbr uniqueidentifier NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_SmallSteps ON dbo.DIM_EDW_SmallSteps ( AccountCD , SiteGUID , SSItemID , SSItemGUID , SSHealthAssesmentUserStartedItemID , SSOutcomeMessageGuid , HFitUserMPINumber , HACampaignNodeGUID , HAStartedMode , HACompletedMode , HaCodeName , HACampaignStartDate , HACampaignEndDate) ON [PRIMARY];

GO

IF NOT EXISTS ( SELECT
                       name
                       FROM sys.indexes
                       WHERE name = 'PI_FACT_Hfit_SmallStepResponses') 
AND EXISTS (SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'FACT_Hfit_SmallStepResponses') 
    BEGIN

        CREATE NONCLUSTERED INDEX PI_FACT_Hfit_SmallStepResponses
        ON dbo.FACT_Hfit_SmallStepResponses ( UserID , HealthAssesmentUserStartedItemID) 
        INCLUDE ( ItemID , OutComeMessageGUID , ItemCreatedBy , ItemCreatedWhen , ItemModifiedBy , ItemModifiedWhen , ItemOrder , ItemGUID) ;
    END;
GO

CREATE NONCLUSTERED INDEX PI_EDW_SmallSteps_RowNbrCDate ON dbo.DIM_EDW_SmallSteps ( RowNbr , LastModifiedDate , DeletedFlg) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_SmallSteps SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[TEMP_EDW_RewardAwardDetail_DATA]

PRINT 'Create Table [dbo].[TEMP_EDW_RewardAwardDetail_DATA]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'TEMP_EDW_RewardAwardDetail_DATA') 

    BEGIN

        DROP TABLE
             TEMP_EDW_RewardAwardDetail_DATA;
    END;
GO

CREATE TABLE dbo.TEMP_EDW_RewardAwardDetail_DATA (
             UserGUID uniqueidentifier NOT NULL
           , SiteGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , RewardLevelGUID uniqueidentifier NOT NULL
           , AwardType int NOT NULL
           , AwardDisplayName nvarchar (100) NOT NULL
           , RewardValue float NULL
           , ThresholdNumber int NOT NULL
           , UserNotified bit NOT NULL
           , IsFulfilled bit NOT NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX temp_PI_EDW_HealthAssessment_IDs ON dbo.TEMP_EDW_RewardAwardDetail_DATA ( UserGUID , SiteGUID , HFitUserMpiNumber , RewardLevelGUID , AwardType , AwardDisplayName , RewardValue , ThresholdNumber , UserNotified , IsFulfilled , AccountID , AccountCD) ON [PRIMARY];

GO

--ALTER TABLE dbo.TEMP_EDW_RewardAwardDetail_DATA SET ( LOCK_ESCALATION = TABLE) ;

GO

-- Create Table [dbo].[DIM_EDW_RewardUserLevel]

PRINT 'Create Table [dbo].[DIM_EDW_RewardUserLevel]';

GO

SET ANSI_NULLS ON;

SET QUOTED_IDENTIFIER ON;

SET ANSI_PADDING ON;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_RewardUserLevel') 

    BEGIN

        DROP TABLE
             DIM_EDW_RewardUserLevel;
    END;
GO

CREATE TABLE dbo.DIM_EDW_RewardUserLevel (
             UserId int NOT NULL
           , LevelCompletedDt datetime NOT NULL
           , LevelName nvarchar (100) NOT NULL
           , SiteName nvarchar (100) NOT NULL
           , nodeguid uniqueidentifier NOT NULL
           , SiteGuid uniqueidentifier NOT NULL
           , LevelHeader nvarchar (256) NULL
           , GroupHeadingText nvarchar (40) NULL
           , GroupHeadingDescription nvarchar (1024) NULL
           , HashCode nvarchar (75) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
           , TimeZone nvarchar (10)) 
ON [PRIMARY];

GO

CREATE CLUSTERED INDEX PI_EDW_RewardUserLevel_IDs ON dbo.DIM_EDW_RewardUserLevel ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid) ON [PRIMARY];

GO

--ALTER TABLE dbo.DIM_EDW_RewardUserLevel SET ( LOCK_ESCALATION = TABLE) ;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'DIM_EDW_BioMetrics') 
    BEGIN
        DROP TABLE
             DIM_EDW_BioMetrics;
    END;
GO

CREATE TABLE dbo.DIM_EDW_BioMetrics (
             UserID int NOT NULL
           , UserGUID uniqueidentifier NOT NULL
           , HFitUserMpiNumber bigint NULL
           , SiteID int NOT NULL
           , SiteGUID uniqueidentifier NOT NULL
           , CreatedDate datetime NULL
           , ModifiedDate datetime NULL
           , Notes nvarchar (1000) NULL
           , IsProfessionallyCollected bit NULL
           , EventDate datetime NULL
           , EventName varchar (13) NOT NULL
           , PPTWeight float NULL
           , PPTHbA1C float NULL
           , Fasting bit NULL
           , HDL float NULL
           , LDL float NULL
           , Ratio float NULL
           , Total float NULL
           , Triglycerides int NULL
           , Glucose int NULL
           , FastingState bit NULL
           , Systolic int NULL
           , Diastolic int NULL
           , PPTBodyFatPCT float NULL
           , BMI float NULL
           , WaistInches float NULL
           , HipInches float NULL
           , ThighInches float NULL
           , ArmInches float NULL
           , ChestInches float NULL
           , CalfInches float NULL
           , NeckInches float NULL
           , Height float NULL
           , HeartRate int NULL
           , FluShot bit NULL
           , PneumoniaShot bit NULL
           , PSATest bit NULL
           , OtherExam bit NULL
           , TScore float NULL
           , DRA float NULL
           , CotinineTest bit NULL
           , ColoCareKit bit NULL
           , CustomTest float NULL
           , CustomDesc varchar (500) NULL
           , CollectionSource nvarchar (100) NULL
           , AccountID int NOT NULL
           , AccountCD nvarchar (8) NULL
           , ChangeType varchar (1) NOT NULL
           , ItemCreatedWhen datetime NULL
           , ItemModifiedWhen datetime NULL
           , TrackerCollectionSourceID int NOT NULL
           , itemid int NOT NULL
           , TBL varchar (32) NOT NULL
           , VendorID int NULL
           , VendorName nvarchar (32) NULL
           , HashCode nvarchar (75) NULL
           , CMS_Site_CtID int NULL
           , CMS_Site_SCV bigint NULL
           , CMS_UserSettings_CtID int NULL
           , CMS_UserSettings_SCV bigint NULL
           , CMS_UserSite_CtID int NULL
           , CMS_UserSite_SCV bigint NULL
           , HFit_Account_CtID int NULL
           , HFit_Account_SCV bigint NULL
           , HFit_UserTracker_CtID int NULL
           , HFit_UserTracker_SCV bigint NULL
           , CMS_Site_CHGTYPE nchar (1) NULL
           , CMS_UserSettings_CHGTYPE nchar (1) NULL
           , CMS_UserSite_CHGTYPE nchar (1) NULL
           , HFit_Account_CHGTYPE nchar (1) NULL
           , HFit_UserTracker_CHGTYPE nchar (1) NULL
           , HFit_TrackerSource_CHGTYPE nchar (1) NULL
           , CT_ChangeType nchar (1) NULL
           , LastModifiedDate datetime NULL
           , RowNbr int NULL
           , DeletedFlg bit NULL
           , ConvertedToCentralTime bit NULL
) 
ON [PRIMARY];

GO

--Add needed columns to temp tables
IF EXISTS ( SELECT
                   name
                   FROM sys.tables
                   WHERE name = 'Temp_HealthInterestDetail') 
    BEGIN
        EXEC proc_Add_EDW_CT_StdCols 'Temp_HealthInterestDetail';
    END;

GO

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardsDefinition';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthAssessment';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_RewardUserLevel_DATA';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthDefinition';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthInterestList';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_Coaches_DATA';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_Trackers';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardAwardDetail';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthInterestDetail';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthAssesmentClientView';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_CoachingDetail';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardUserDetail';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_Coaches';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardTriggerParameters';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_RewardTriggerParameters_DATA';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_CoachingDetail_DATA';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_HealthDefinition_DATA';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_Tracker_DATA';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthAssessmentDefinition';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_SmallSteps';

EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_RewardAwardDetail_DATA';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardUserLevel';

EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_BioMetrics';

GO

PRINT 'Created the STAGING tables';

GO 

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'FROM CreateTable_CT_VersionTracking.Sql';
PRINT 'Creating table CT_VersionTracking';
IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE
                  name = 'CT_VersionTracking') 
    BEGIN
        DROP TABLE
             CT_VersionTracking;
    END;
GO
IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE
                      name = 'CT_VersionTracking') 
    BEGIN
        CREATE TABLE dbo.CT_VersionTracking (
                     SVRName nvarchar (100) NOT NULL
                   , DBName nvarchar (100) NOT NULL
                   , TgtView nvarchar ( 100) NOT NULL
                   , ExtractionDate datetime2 (7) NOT NULL
                   , ExtractedVersion int NOT NULL
                   , CurrentDbVersion int NULL
                   , ExtractedRowCnt int NOT NULL
                   , StartTime datetime2 ( 7) NOT NULL
                   , EndTime datetime2 ( 7) NULL
                   , CNT_Insert int NULL
                   , CNT_Update int NULL
                   , CNT_Delete int NULL
                   , CNT_StagingTable bigint NULL
                   , CNT_PulledRecords bigint NULL
                   , RowNbr int IDENTITY (1, 1) NOT NULL
                   , CONSTRAINT PK_CT_VersionTracking PRIMARY KEY CLUSTERED
                     (
                     SVRName, DBName, ExtractedVersion , TgtView, ExtractionDate ASC
                     ) 
                         WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , IGNORE_DUP_KEY = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON)
ON [PRIMARY]
        ) 
        ON [PRIMARY];

        ALTER TABLE dbo.CT_VersionTracking
        ADD
                    CONSTRAINT DF_CT_VersionTracking_StartTime  DEFAULT GETDATE () FOR StartTime;
    END;

GO
PRINT 'Created table CT_VersionTracking';
GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating Table EDW_CT_ExecutionLog';
PRINT 'FROM: createTable_EDW_CT_ExecutionLog.sql';
GO
--drop table EDW_CT_ExecutionLog

/*
alter table EDW_CT_ExecutionLog add CT_Inserts bigint NULL
alter table EDW_CT_ExecutionLog add CT_Updates bigint NULL
alter table EDW_CT_ExecutionLog add CT_Deletes bigint NULL	
*/

SET QUOTED_IDENTIFIER ON;

IF NOT EXISTS ( SELECT
                       name
                       FROM sys.tables
                       WHERE name = 'EDW_CT_ExecutionLog') 
    BEGIN

        CREATE TABLE dbo.EDW_CT_ExecutionLog (
                     CT_NAME nvarchar ( 80) NOT NULL
                   , CT_Start datetime NOT NULL
                   , CT_End datetime NULL
                   , CT_TotalMinutes int NULL
                   , CT_RecordsProcessed bigint NULL
                   , CT_Inserts bigint NULL
                   , CT_Updates bigint NULL
                   , CT_Deletes bigint NULL
                   , RecordID uniqueidentifier NOT NULL
                   , CONSTRAINT PK_EDW_CT_ExecutionLog PRIMARY KEY CLUSTERED ( RecordID ASC)) ;

        ALTER TABLE dbo.EDW_CT_ExecutionLog
        ADD
                    CONSTRAINT DF_EDW_CT_ExecutionLog_RecordID DEFAULT NEWID () FOR RecordID;

    END;
ELSE
    BEGIN
        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               column_name = 'CT_Inserts'
                           AND table_name = 'EDW_CT_ExecutionLog') 
            BEGIN
                ALTER TABLE EDW_CT_ExecutionLog
                ADD
                            CT_Inserts bigint NULL;
            END;
        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               column_name = 'CT_Updates'
                           AND table_name = 'EDW_CT_ExecutionLog') 
            BEGIN
                ALTER TABLE EDW_CT_ExecutionLog
                ADD
                            CT_Updates bigint NULL;
            END;
        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               column_name = 'CT_Deletes'
                           AND table_name = 'EDW_CT_ExecutionLog') 
            BEGIN
                ALTER TABLE EDW_CT_ExecutionLog
                ADD
                            CT_Deletes bigint NULL;
            END;
    END;
GO

PRINT 'CREATED Table EDW_CT_ExecutionLog';
GO

PRINT 'CREATING PROC proc_EDW_CT_ExecutionLog_Update';
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_CT_ExecutionLog_Update') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_CT_ExecutionLog_Update;
    END;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_CT_ExecutionLog_Update_Counts') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_CT_ExecutionLog_Update_Counts;
    END;

GO

CREATE PROCEDURE proc_EDW_CT_ExecutionLog_Update_Counts (
       @RecordID AS uniqueidentifier
     , @TypeAction AS char (1) 
     , @iCnt AS bigint = 0) 
AS
BEGIN

/*
    @TypeAction:
    T = Total of processed records.
    I = Update the count of inserted records
    U = Update the count of updated records
    D = Update the count of flaged as deleted records
    */

    IF @TypeAction = 'T'
        BEGIN
            DECLARE
                   @TotRecs AS bigint = (SELECT
                                                ISNULL (CT_INSERTs, 0) + ISNULL (CT_Updates, 0) + ISNULL (CT_Deletes, 0) 
                                                FROM EDW_CT_ExecutionLog
                                                WHERE RecordID = @RecordID);

            IF @iCnt > 0
                BEGIN
                    PRINT 'Executing Log Update T0 on ' + CAST (@iCnt AS nvarchar (50)) + ' records.';
                    UPDATE dbo.EDW_CT_ExecutionLog
                           SET
                               CT_RecordsProcessed = @iCnt
                    WHERE
                          RecordID = @RecordID;
                END;
            ELSE
                BEGIN
                    PRINT 'Executing Log Update T1 on ' + CAST (@TotRecs AS nvarchar (50)) + ' records.';
                    UPDATE dbo.EDW_CT_ExecutionLog
                           SET
                               CT_RecordsProcessed = @TotRecs
                    WHERE
                          RecordID = @RecordID;
                END;
        END;
    IF @TypeAction = 'I'
        BEGIN
            UPDATE dbo.EDW_CT_ExecutionLog
                   SET
                       CT_Inserts = @iCnt
            WHERE
                  RecordID = @RecordID;
        END;
    IF @TypeAction = 'U'
        BEGIN
            UPDATE dbo.EDW_CT_ExecutionLog
                   SET
                       CT_Updates = @iCnt
            WHERE
                  RecordID = @RecordID;
        END;
    IF @TypeAction = 'D'
        BEGIN
            UPDATE dbo.EDW_CT_ExecutionLog
                   SET
                       CT_Deletes = @iCnt
            WHERE
                  RecordID = @RecordID;
        END;
END;
GO
CREATE PROCEDURE proc_EDW_CT_ExecutionLog_Update (
       @RecordID AS uniqueidentifier
     , @CT_NAME AS nvarchar (80) 
     , @CT_DateTimeNow AS datetime
     , @CT_RecordsProcessed AS bigint = 0
     , @Action AS nvarchar (5)) 
AS
BEGIN
    IF @Action = 'I'
        BEGIN
            INSERT INTO dbo.EDW_CT_ExecutionLog (
                   CT_NAME
                 , CT_Start
                 , CT_End
                 , CT_TotalMinutes
                 , CT_RecordsProcessed
                 , RecordID) 
            VALUES
                   (
                   @CT_NAME , @CT_DateTimeNow , NULL , NULL , NULL , @RecordID) ;
        END;
    IF @Action = 'U'
        BEGIN
            --declare @STime as datetime = getdate() -1 ;
            --declare @CT_DateTimeNow as datetime = getdate();
            --select DATEDIFF (MINUTE, @STime , @CT_DateTimeNow);
            DECLARE
                   @STime AS datetime = ( SELECT
                                                 CT_Start
                                                 FROM EDW_CT_ExecutionLog
                                                 WHERE RecordID = @RecordID );

            PRINT '@Stime = ' + CAST ( @Stime AS nvarchar ( 50)) ;
            DECLARE
                   @Mins AS int = DATEDIFF ( MINUTE , @STime , @CT_DateTimeNow) ;
            PRINT '@Mins = ' + CAST ( @Mins AS nvarchar ( 50)) ;
            UPDATE dbo.EDW_CT_ExecutionLog
                   SET
                       CT_End = @CT_DateTimeNow
                     ,CT_TotalMinutes = DATEDIFF ( MINUTE , @STime , @CT_DateTimeNow) 
                     ,CT_RecordsProcessed = @CT_RecordsProcessed
            WHERE
                  RecordID = @RecordID;

        END;

END;

GO
PRINT 'CREATED PROC proc_EDW_CT_ExecutionLog_Update';
GO

--Test the PROC

/*
declare @RecordID AS uniqueidentifier = newid();
declare @CT_NAME as nvarchar(50) = 'TESTRUN' ;
declare @CT_DateTimeNow as datetime = getdate() -1 ;
declare @CT_RecordsProcessed as bigint = 0 ; 
declare @Action AS nvarchar (5) = 'I';

exec proc_EDW_CT_ExecutionLog_Update @RecordID, @CT_NAME, @CT_DateTimeNow, @CT_RecordsProcessed, 'I';
select * from EDW_CT_ExecutionLog ;
set @CT_DateTimeNow = getdate() ;
set @CT_RecordsProcessed = 9999;
exec proc_EDW_CT_ExecutionLog_Update @RecordID, @CT_NAME, @CT_DateTimeNow, @CT_RecordsProcessed, 'U';
select * from EDW_CT_ExecutionLog ;
truncate table EDW_CT_ExecutionLog;
*/--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
-- use KenticoCMS_Prod1

GO

PRINT ' FROM view_EDW_HealthAssesment_CT.sql';

PRINT 'Processing view_EDW_HealthAssesment_CT';

/*-------------------------------------------------------------------------------------------------------------------
*******************************************************************************************************************
SELECT count(*) FROM view_EDW_HealthAssesment_CT  WHERE [ChangeType] IS NOT NULL group by [ChangeType] ;	   --6587671
SELECT count(*) FROM view_EDW_HealthAssesment_CT  group by [ChangeType] ;
SELECT count(*) FROM view_EDW_HealthAssesment_CT WHERE [ChangeType] = 'U';    
SELECT top 100 * FROM view_EDW_HealthAssesment_CT WHERE [ChangeType] = 'U';  
*******************************************************************************************************************
*/

GO

IF NOT EXISTS ( SELECT
                       name
                       FROM sys.indexes
                       WHERE name = 'CI_HFit_HealthAssesmentUserRiskArea_HARiskCategoryItemID') 

    BEGIN

        CREATE NONCLUSTERED INDEX CI_HFit_HealthAssesmentUserRiskArea_HARiskCategoryItemID ON dbo.HFit_HealthAssesmentUserRiskArea (
        HARiskCategoryItemID) INCLUDE (
        ItemID
        , HARiskAreaScore
        , ItemModifiedWhen
        , CodeName
        , PreWeightedScore
        , HARiskAreaNodeGUID) ;
    END;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.views
                   WHERE name = 'view_EDW_HealthAssesment_CT') 

    BEGIN

        DROP VIEW
             view_EDW_HealthAssesment_CT;
    END;

GO

/*------------------------------------------------------------------------
************************************************************************
**************************************************************************
select top 100 * from [view_EDW_HealthAssesment_CT] 

select * 
into #TEMP_HA
from [view_EDW_HealthAssesment_CT] 
where CHANGED_FLG is not null

select * from #TEMP_HA

--07.09.2015 (WDM) - Dea and I discussed the need to capture and present the Health Assessment Type.
--				Mark and I discussed how best to do this and the data, basically, was already in 
--				the view. I added the field HealthAssessmentType to the view.

**************************************************************************
************************************************************************
*/
CREATE VIEW dbo.view_EDW_HealthAssesment_CT
AS SELECT
          HAUserStarted.ItemID AS UserStartedItemID
        , VHAJ.NodeGUID AS HealthAssesmentUserStartedNodeGUID
        , HAUserStarted.UserID
        , CMSUser.UserGUID
        , UserSettings.HFitUserMpiNumber
        , CMSSite.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , ACCT.AccountName
        , HAUserStarted.HAStartedDt
        , HAUserStarted.HACompletedDt
        , HAUserModule.ItemID AS UserModuleItemId
        , HAUserModule.CodeName AS UserModuleCodeName
        , HAUserModule.HAModuleNodeGUID
        , VHAJ.NodeGUID AS CMSNodeGuid
        , NULL AS HAModuleVersionID
        , HARiskCategory.ItemID AS UserRiskCategoryItemID
        , HARiskCategory.CodeName AS UserRiskCategoryCodeName
        , HARiskCategory.HARiskCategoryNodeGUID
        , NULL AS HARiskCategoryVersionID
        , HAUserRiskArea.ItemID AS UserRiskAreaItemID
        , HAUserRiskArea.CodeName AS UserRiskAreaCodeName
        , HAUserRiskArea.HARiskAreaNodeGUID
        , NULL AS HARiskAreaVersionID
        , HAUserQuestion.ItemID AS UserQuestionItemID
        , dbo.udf_StripHTML ( HAQuestionsView.Title) AS Title
        , HAUserQuestion.HAQuestionNodeGUID AS HAQuestionGuid
        , HAUserQuestion.CodeName AS UserQuestionCodeName
        , NULL AS HAQuestionDocumentID
        , NULL AS HAQuestionVersionID
        , HAUserQuestion.HAQuestionNodeGUID
        , HAUserAnswers.ItemID AS UserAnswerItemID
        , HAUserAnswers.HAAnswerNodeGUID
        , NULL AS HAAnswerVersionID
        , HAUserAnswers.CodeName AS UserAnswerCodeName
        , HAUserAnswers.HAAnswerValue
        , HAUserModule.HAModuleScore
        , HARiskCategory.HARiskCategoryScore
        , HAUserRiskArea.HARiskAreaScore
        , HAUserQuestion.HAQuestionScore
        , HAUserAnswers.HAAnswerPoints
        , HAUserQuestionGroupResults.PointResults
        , HAUserAnswers.UOMCode
        , HAUserStarted.HAScore
        , HAUserModule.PreWeightedScore AS ModulePreWeightedScore
        , HARiskCategory.PreWeightedScore AS RiskCategoryPreWeightedScore
        , HAUserRiskArea.PreWeightedScore AS RiskAreaPreWeightedScore
        , HAUserQuestion.PreWeightedScore AS QuestionPreWeightedScore
        , HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName

          --, CASE
          --	 WHEN [HAUserAnswers].[ItemCreatedWhen] = [HAUserAnswers].[ItemModifiedWhen]
          --	 THEN 'I'
          --	 ELSE 'U'
          --  END AS [ChangeType]

        , COALESCE ( CT_CMS_User.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION , CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION) AS ChangeType

        , HAUserAnswers.ItemCreatedWhen
        , HAUserAnswers.ItemModifiedWhen
        , HAUserQuestion.IsProfessionallyCollected
        , HARiskCategory.ItemModifiedWhen AS HARiskCategory_ItemModifiedWhen
        , HAUserRiskArea.ItemModifiedWhen AS HAUserRiskArea_ItemModifiedWhen
        , HAUserQuestion.ItemModifiedWhen AS HAUserQuestion_ItemModifiedWhen
        , HAUserAnswers.ItemModifiedWhen AS HAUserAnswers_ItemModifiedWhen
        , HAUserStarted.HAPaperFlg
        , HAUserStarted.HATelephonicFlg
        , HAUserStarted.HAStartedMode
        , HAUserStarted.HACompletedMode
        , VHCJ.DocumentCulture AS DocumentCulture_VHCJ
        , HAQuestionsView.DocumentCulture AS DocumentCulture_HAQuestionsView
        , HAUserStarted.HACampaignNodeGUID AS CampaignNodeGUID
        , VHCJ.HACampaignID
        , CAST ( HASHBYTES ( 'sha1' ,
          ISNULL ( CAST ( HAUserStarted.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserStarted.UserID AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSUser.UserGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( UserSettings.HFitUserMpiNumber AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSSite.SiteGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountCD AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountName AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserStarted.HAStartedDt AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACompletedDt AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserModule.ItemID  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.CodeName  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.HAModuleNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.CodeName AS nvarchar (100)) ,
          '-') + ISNULL ( CAST ( HAUserRiskArea.HARiskAreaNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemID AS nvarchar (100)) , '-') + ISNULL ( LEFT ( HAQuestionsView.Title , 1000) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserQuestion.CodeName  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.HAAnswerNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.HAAnswerValue AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.HAModuleScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryScore AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserRiskArea.HARiskAreaScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionScore AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.HAAnswerPoints AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestionGroupResults.PointResults AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserAnswers.UOMCode AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.PreWeightedScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserRiskArea.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST
          ( HAUserQuestionGroupResults.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemCreatedWhen AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.IsProfessionallyCollected AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAPaperFlg AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HATelephonicFlg AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserStarted.HAStartedMode AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACompletedMode AS nvarchar (100)) , '-') + ISNULL ( CAST
          ( HAUserStarted.HACampaignNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHCJ.HACampaignID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-')) AS varchar (100)) AS HashCode
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS varchar (50)) , '-') + ISNULL ( CAST ( UserGUID AS varchar (50)) , '-') + ISNULL ( CAST ( SiteGUID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.AccountID AS varchar (50)) , '-') + ISNULL ( CAST ( AccountCD AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserModule.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAModuleNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategoryNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategory.CodeName AS varchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskAreaNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserRiskArea.CodeName AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.CodeName AS varchar (50)) , '-') + ISNULL ( CAST ( HAQuestionNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAAnswerNodeGUID   AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserStarted.HACampaignNodeGUID AS varchar (50)) , '-')) AS varchar (100)) AS PKHashCode
        , COALESCE ( CT_CMS_User.UserID , CT_CMS_UserSettings.UserSettingsID , CT_CMS_Site.SiteID , CT_CMS_UserSite.UserSiteID , CT_HFit_Account.AccountID , CT_HFit_HealthAssesmentUserAnswers.ItemID , CT_HFit_HealthAssesmentUserModule.ItemID , CT_HFit_HealthAssesmentUserQuestion.ItemID , CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID , CT_HFit_HealthAssesmentUserRiskArea.ItemID , CT_HFit_HealthAssesmentUserRiskCategory.ItemID , CT_HFit_HealthAssesmentUserStarted.ItemID) AS CHANGED_FLG

/*---------------------------------------
***************************************
*****************************************
join changes to the records 
*****************************************
***************************************
*/

        , CT_CMS_User.UserID AS CT_CMS_User_UserID
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CT_CMS_User_CHANGE_OPERATION
        , CT_CMS_UserSettings.UserSettingsID AS CT_UserSettingsID
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CT_UserSettingsID_CHANGE_OPERATION
        , CT_CMS_Site.SiteID AS SiteID_CtID
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS SiteID_CHANGE_OPERATION
        , CT_CMS_UserSite.UserSiteID AS UserSiteID_CtID
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS UserSiteID_CHANGE_OPERATION
        , CT_HFit_Account.AccountID AS AccountID_CtID
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS AccountID__CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserAnswers.ItemID AS HAUserAnswers_CtID
        , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION AS HAUserAnswers_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserModule.ItemID AS HFit_HealthAssesmentUserModule_CtID
        , CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserQuestion.ItemID AS HFit_HealthAssesmentUserQuestion_CtID
        , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID AS HFit_HealthAssesmentUserQuestionGroupResults_CtID
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserRiskArea.ItemID AS HFit_HealthAssesmentUserRiskArea_CtID
        , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserRiskCategory.ItemID AS HFit_HealthAssesmentUserRiskCategory_CtID
        , CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserStarted.ItemID AS HFit_HealthAssesmentUserStarted_CtID
        , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserStarted_CHANGE_OPERATION

          --Get the TYPE of change ID NUMBER

        , CT_CMS_User.SYS_CHANGE_VERSION AS CT_CMS_User_SCV
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CT_CMS_UserSettings_SCV
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CT_CMS_Site_SCV
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CT_CMS_UserSite_SCV
        , CT_HFit_Account.SYS_CHANGE_VERSION AS CT_HFit_Account_SCV
        , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserAnswers_SCV
        , CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserModule_SCV
        , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserQuestion_SCV
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV
        , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserRiskArea_SCV
        , CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserRiskCategory_SCV
        , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserStarted_SCV
        , HAUserAnswers.ItemModifiedWhen AS LastModifiedDate
        , 0 AS DeleteFlg
        , CASE
              WHEN HAUserStarted.HADocumentConfigID IS NULL
                  THEN 'SHORT_VER'
              WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
                  THEN 'LONG_VER'
              ELSE 'UNKNOWN'
          END AS HealthAssessmentType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_HealthAssesmentUserStarted AS HAUserStarted
                    INNER JOIN dbo.CMS_User AS CMSUser
                    ON HAUserStarted.UserID = CMSUser.UserID
                    INNER JOIN dbo.CMS_UserSettings AS UserSettings
                    ON
                       UserSettings.UserSettingsUserID = CMSUser.UserID AND
                       HFitUserMpiNumber >= 0 AND
                       HFitUserMpiNumber IS NOT NULL
                    INNER JOIN dbo.CMS_UserSite AS UserSite
                    ON CMSUser.UserID = UserSite.UserID
                    INNER JOIN dbo.CMS_Site AS CMSSite
                    ON UserSite.SiteID = CMSSite.SiteID
                    INNER JOIN dbo.HFit_Account AS ACCT
                    ON ACCT.SiteID = CMSSite.SiteID
                    INNER JOIN dbo.HFit_HealthAssesmentUserModule AS HAUserModule
                    ON HAUserStarted.ItemID = HAUserModule.HAStartedItemID
                    INNER JOIN dbo.View_HFit_HACampaign_Joined AS VHCJ
                    ON
                       VHCJ.NodeGUID = HAUserStarted.HACampaignNodeGUID AND
                       VHCJ.NodeSiteID = UserSite.SiteID AND
                       VHCJ.DocumentCulture = 'en-US'
                    INNER JOIN dbo.View_HFit_HealthAssessment_Joined AS VHAJ
                    ON VHAJ.DocumentID = VHCJ.HealthAssessmentID
                    INNER JOIN dbo.HFit_HealthAssesmentUserRiskCategory AS HARiskCategory
                    ON HAUserModule.ItemID = HARiskCategory.HAModuleItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
                    ON HARiskCategory.ItemID = HAUserRiskArea.HARiskCategoryItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserQuestion AS HAUserQuestion
                    ON HAUserRiskArea.ItemID = HAUserQuestion.HARiskAreaItemID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS HAQuestionsView
                    ON
                       HAUserQuestion.HAQuestionNodeGUID = HAQuestionsView.NodeGUID AND
                       HAQuestionsView.DocumentCulture = 'en-US'
                    LEFT OUTER JOIN dbo.HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
                    ON HAUserRiskArea.ItemID = HAUserQuestionGroupResults.HARiskAreaItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserAnswers AS HAUserAnswers
                    ON HAUserQuestion.ItemID = HAUserAnswers.HAQuestionItemID

/*-----------------------------
*****************************
Add in the change tracking data
*****************************
*/
                    LEFT JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON UserSettings.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT JOIN CHANGETABLE (CHANGES CMS_User , NULL) AS CT_CMS_User
                    ON CMSUser.UserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CMSSite.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON UserSite.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON ACCT.AccountID = CT_HFit_Account.AccountID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HACampaign , NULL) AS CT_HFit_HACampaign
                    ON VHCJ.HACampaignID = CT_HFit_HACampaign.HACampaignID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserAnswers , NULL) AS CT_HFit_HealthAssesmentUserAnswers
                    ON HAUserAnswers.ItemID = CT_HFit_HealthAssesmentUserAnswers.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserModule , NULL) AS CT_HFit_HealthAssesmentUserModule
                    ON HAUserModule.ItemID = CT_HFit_HealthAssesmentUserModule.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestion , NULL) AS CT_HFit_HealthAssesmentUserQuestion
                    ON HAUserQuestion.ItemID = CT_HFit_HealthAssesmentUserQuestion.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults , NULL) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                    ON HAUserQuestionGroupResults.ItemID = CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea , NULL) AS CT_HFit_HealthAssesmentUserRiskArea
                    ON HAUserRiskArea.ItemID = CT_HFit_HealthAssesmentUserRiskArea.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskCategory , NULL) AS CT_HFit_HealthAssesmentUserRiskCategory
                    ON HARiskCategory.ItemID = CT_HFit_HealthAssesmentUserRiskCategory.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted , NULL) AS CT_HFit_HealthAssesmentUserStarted
                    ON HAUserStarted.ItemID = CT_HFit_HealthAssesmentUserStarted.ItemID
          WHERE UserSettings.HFitUserMpiNumber NOT IN (
          SELECT
                 RejectMPICode
                 FROM HFit_LKP_EDW_RejectMPI) ;
GO

PRINT 'Processed view_EDW_HealthAssesment_CT';

GO

PRINT ' FROM view_EDW_HealthAssesment_CT.sql';

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures AS CTCNT
             WHERE name = 'proc_EDW_CountDeletedHA') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_CountDeletedHA;
    END;
GO
CREATE PROC proc_EDW_CountDeletedHA
AS
BEGIN
    DECLARE
       @iCnt AS bigint = 0;

    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES CMS_User, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES CMS_Site, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_Account, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HACampaign, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserAnswers, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserModule, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestion, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskCategory, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    print ('HA Deletes found: ' + cast(@iCnt as nvarchar(50)));
    RETURN @iCnt;
END;--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating proc_CkUserTrackerHasChanged';
PRINT 'FROM proc_CkUserTrackerHasChanged.sql';

IF EXISTS (SELECT
              name
                  FROM sys.procedures
                  WHERE name = 'proc_CkUserTrackerHasChanged') 
    BEGIN
        DROP PROCEDURE
           proc_CkUserTrackerHasChanged
    END;
GO

CREATE PROC proc_CkUserTrackerHasChanged
AS
BEGIN

    DECLARE
    @UpdatesFOund TABLE (
       ChangeType nvarchar (10) NULL) ;
    DECLARE
    @b AS bit = 0;

    INSERT INTO @UpdatesFOund
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_UserTracker, NULL) AS CT
    UNION
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_Site, NULL) AS CT
    UNION
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT
    UNION
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT
    UNION
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_Account, NULL) AS CT
    UNION
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_TrackerCollectionSource, NULL) AS CT;

    DECLARE @NbrUpdates AS int = @@ROWCOUNT;

    IF @NbrUpdates = 0
        BEGIN
            PRINT 'No changes found';
            SET @b = 0;
        END;
    ELSE
        BEGIN
            PRINT 'Changes found';
            SET @b = 1;
            IF EXISTS (SELECT
                          ChangeType
                              FROM @UpdatesFOund
                              WHERE ChangeType = 'D') 
                BEGIN
                    PRINT 'DELETES found';
                    SET @b = 2;
                END;
            RETURN @b;
        END;
END;
GO
PRINT 'Created proc_CkUserTrackerHasChanged';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*-----------------------------------------------------------------------------------------------
***********************************************************************************************
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing

exec proc_STAGING_EDW_HA_Changes 0   --Process Changed Data only
exec proc_STAGING_EDW_HA_Changes 1   --Reload ALL
exec proc_STAGING_EDW_HA_Changes 0, @PullLatestVersionOnly = 1

select * from TEMP_EDW_HealthAssessment_DATA
select  * from CT_VersionTracking ; 

select * from information_schema.columns where column_name = 'HAModuleScore'
SELECT top 100 * FROM [HFit_HealthAssesmentUserModule]

update HFit_HealthAssesmentUserModule set HAModuleScore = HAModuleScore + .03 where ItemID = 1526
update HFit_HealthAssesmentUserModule set HAModuleScore = HAModuleScore + .03 where ItemID = 1527

update HFit_HealthAssesmentUserModule set HAModuleScore = HAModuleScore - .03 where ItemID = 1526
update HFit_HealthAssesmentUserModule set HAModuleScore = HAModuleScore - .03 where ItemID = 1527

SELECT COUNT(*) FROM DIM_EDW_HealthAssessment
SELECT COUNT(*) FROM [view_EDW_HealthAssesment_CT]
SELECT top 100 * FROM [view_EDW_HealthAssesment_CT]
SELECT TOP 100 * FROM [DIM_EDW_HealthAssessment];
SELECT COUNT (*) FROM [DIM_EDW_HealthAssessment]; 

select * from DIM_EDW_HealthAssessment where Hashcode = 'f#Kj92%2'
select count(*), HashCode
from DIM_EDW_HealthAssessment
group by HashCode 
having Count(*) > 1
***********************************************************************************************
*/

/*-----------------------------------------------------
USES:
    PROCS:
    dbo.proc_EDW_Procedure_Performance_Monitor
    dbo.proc_EDW_ChangeGmtToCentralTime
    dbo.proc_CkHaDataChanged
    dbo.proc_CT_Performance_History
    dbo.proc_clean_EDW_Staging
    dbo.proc_EDW_PullHA_Temp_Data
    dbo.proc_trace
    dbo.proc_EDW_CT_ExecutionLog_Update_Counts
    dbo.proc_EDW_CT_ExecutionLog_Update
    dbo.proc_EDW_BuildStagingTables
    dbo.proc_CT_HA_AddNewRecs
    dbo.proc_CT_HA_AddUpdatedRecs
    dbo.proc_CT_HA_AddDeletedRecs
    dbo.proc_EDW_Reload_EDW_HealthAssessment
    dbo.proc_QuickRowCount
    dbo.proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI
    
    TABLE:
    CT_VersionTracking
    EDW_Proc_Performance_Monitor

    JOBS:
    job_EDW_GetStagingData_HA_KenticoCMS_ProdXX
*/

GO

PRINT 'FROM proc_STAGING_EDW_HA_Changes.SQL';
PRINT 'Creating proc_STAGING_EDW_HA_Changes';

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_STAGING_EDW_HA_Changes') 

    BEGIN
        PRINT 'Replacing proc_STAGING_EDW_HA_Changes proc';
        DROP PROCEDURE
             proc_STAGING_EDW_HA_Changes;
    END;

GO
-- exec proc_STAGING_EDW_HA_Changes
CREATE PROCEDURE proc_STAGING_EDW_HA_Changes
     @LoadType int = 0
   , @TrackProgress AS bit = 0
   , @CTVersionOverride AS int = NULL
   , @PullLatestVersionOnly AS bit = 0
AS
BEGIN

    SET NOCOUNT ON;

/*------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
***************************************************************************************************
Developer		 : W. Dale Miller
@LoadType		 :	0 load only changes, 
				1 is reload the staging table with all data.
				2 is reload the staging table with all data.
@TrackProgress			 : 1 causes tracing data to be displayed, 0 skips the tracing display
@CTVersionOverride		 : NULL is no action, Any positive number will force the specified version 
					   and all above that to be pulled.
@PullLatestVersionOnly    : 0 pull all changes, 1 pull only data between the last and current CHANGE ID.
***************************************************************************************************
*/

    DECLARE
    @ActivateTestMode AS bit = 0
  , @iTotal AS bigint = 0
  , @NbrOfDetectedChanges AS bigint = 0
  , @CT_NAME AS nvarchar ( 50) = 'proc_Staging_EDW_Data'
  , @CT AS datetime = GETDATE () 
  , @ET AS datetime = GETDATE () 
  , @STime AS datetime = GETDATE () 
  , @RecordID AS uniqueidentifier = NEWID () 
  , @PROC_LOCATION AS nvarchar ( 100) = ''
  , @iCnt AS bigint = 0
  , @proc_RowsProcessed AS bigint = 0
  , @proc_endtime AS datetime
  , @CT_DateTimeNow AS datetime
  , @TOTSECS AS bigint = 0
  , @RowNbr  AS bigint = 0
  , @CNT_StagingTable  AS bigint = 0
  , @MINS AS bigint = 0
  , @proc_elapsedsecs AS bigint = 0;

    DECLARE
    @ExtractionDate AS datetime = GETDATE () ;

    DECLARE
    @CTVersionToPullNow AS bigint = 0
  , @ExtractedVersion AS bigint = 0;

    DECLARE
    @TgtView AS nvarchar ( 100) = 'view_EDW_HealthAssesment';

    DECLARE
    @StartTime AS datetime = GETDATE () 
  , @EndTime AS datetime = GETDATE () ;

    DECLARE
    @SVRName AS nvarchar ( 100) = @@SERVERNAME
  , @DBName AS nvarchar ( 100) = DB_NAME () ;

    DECLARE
    @CNT_Insert AS bigint = 0
  , @CNT_Update  AS bigint = 0
  , @CNT_delete  AS bigint = 0;

    DECLARE
    @proc_RowGuid  AS uniqueidentifier = @RecordID;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_HealthAssessment';

    IF @iTotal <= 1
        BEGIN
            PRINT 'NO RECORDS FOUND IN STAGING TABLE - Reloading all.' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @LoadType = 1;
        END;

    IF @LoadType = NULL
        BEGIN
            SET @LoadType = 0;
        END;

    IF @LoadType = 1
        BEGIN
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '001 RELOAD ALL';
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '002 BEGIN RELOAD ALL';

            --**************************************************************************************************
            PRINT 'START proc_EDW_Reload_EDW_HealthAssessment: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @NbrOfDetectedChanges = proc_EDW_Reload_EDW_HealthAssessment ;
            PRINT 'ENDED proc_EDW_Reload_EDW_HealthAssessment: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            --**************************************************************************************************

            PRINT '00 Number of records loaded: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '003 END RELOAD ALL';

            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '004 Begin Converting Time to Central';
            --**************************************************************************************************
            PRINT 'START Converting Time to Central' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthAssessment';
            PRINT 'END Converting Time to Central' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            --**************************************************************************************************
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '005 Complete Converting Time to Central';

            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '006 Begin Cleaning Staging Data';
            PRINT 'START Cleaning Staging Data' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_clean_EDW_Staging;
            PRINT 'END Cleaning Staging Data' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '007 END Cleaning Staging Data';

            PRINT 'Load Complete' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , 0;

            RETURN;
        END;

    --********************************************************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'START proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI', @CT, NULL;
    EXEC proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI', @CT, @ET;
    --********************************************************************************************************

    DECLARE @LatestDbVersionToPull AS bigint = 0;
    SET @LatestDbVersionToPull = CHANGE_TRACKING_CURRENT_VERSION () - 1;
    PRINT 'The Current Change Version ID is : ' + CAST (@LatestDbVersionToPull AS nvarchar (50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;

    IF @CTVersionOverride IS NOT NULL
   AND @CTVersionOverride >= 0
        BEGIN
            SET @CTVersionToPullNow = @CTVersionOverride;
        END;
    ELSE
        BEGIN
            SET @CTVersionToPullNow = ( SELECT
                                               MAX ( CurrentDbVersion) 
                                               FROM CT_VersionTracking
                                               WHERE
                                               SVRname = @@ServerName
                                           AND DBName = DB_NAME () 
                                           AND TgtView = @TgtView);
        END;

    PRINT 'The Previous Change Version ID is ' + CAST ( @CTVersionToPullNow AS nvarchar (50)) ;

    DECLARE
    @iChgTypes AS int = 0;

    --**************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'START proc_CkHaDataChanged :', @CT, NULL;
    EXEC @iChgTypes = proc_CkHaDataChanged @CTVersionToPullNow, @NbrOfDetectedChanges OUTPUT;
    PRINT 'iChgType is: ' + CAST (@iChgTypes AS nvarchar (50)) ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END proc_CkHaDataChanged :', @CT, @ET;
    --**************************************************************

    IF @CTVersionToPullNow < 0 OR @CTVersionToPullNow IS NULL
        BEGIN
            SET @CTVersionToPullNow = 0;
        END;

    IF @TrackProgress = 1
        BEGIN
            PRINT 'Pulling @CTVersionToPullNow ' + CAST ( @CTVersionToPullNow AS nvarchar (50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
        END;

    IF @CTVersionToPullNow = @LatestDbVersionToPull AND @PullLatestVersionOnly = 1
        BEGIN

            PRINT 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX';
            PRINT 'NO Changes found in the db version of ' + CAST ( @LatestDbVersionToPull AS nvarchar ( 50)) + ' - RETURNING' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            PRINT 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX';

            SET @STime = GETDATE () ;

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , 0;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , 0;
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'D';

            SET @proc_RowsProcessed = 0;
            SET @PROC_LOCATION = 'End Of Run - NO CHANGES FOUND';
            SET @proc_endtime = GETDATE () ;
            EXEC proc_CT_Performance_History @proc_RowGuid , @CT_NAME , @PROC_LOCATION , @STime , @proc_endtime , @proc_elapsedsecs , @proc_RowsProcessed;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '008';
            EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '009';

            RETURN;
        END;
    ELSE
        BEGIN
            PRINT 'PULLING Changes for versions between: ' + CAST ( @CTVersionToPullNow AS nvarchar ( 50)) + '  and ' + CAST ( @LatestDbVersionToPull
                  AS nvarchar ( 50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
        END;

    IF @iChgTypes = 0
        BEGIN
            PRINT '**01 Notice: No changes found to process, done.' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            RETURN 0;
        END;

    /*-------------------------------
    if @iChgTypes = 
    0 - no changes
    1 - updates only
    2 - deletes only
    3 - deletes and updates
    4 - inserts only
    5 - inserts and updates
    6 - inserts and deletes
    7 - inserts, updates, and deletes
    */
    -- EXEC proc_EDW_BuildStagingTables null
    --*********************************************************************************************************
    PRINT '**Populating Staging Tables: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
    EXEC proc_EDW_BuildStagingTables @CTVersionToPullNow;
    PRINT '**ENDED Populating Staging Tables: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
    --*********************************************************************************************************

    DECLARE @ReloadCnt AS bigint = 0;
    IF @iChgTypes > 0 AND @iChgTypes != 2
        BEGIN
            DECLARE @st100 AS datetime = GETDATE () ;
            PRINT 'Loading temp table: version# ' + CAST (@CTVersionToPullNow AS nvarchar (50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @CT = GETDATE () ;
            EXEC proc_trace 'START Loading temp table', @CT, NULL;
            EXEC proc_trace 'START proc_EDW_PullHA_Temp_Data: ', @st100, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '010 pulling changes into Temp Table';
            EXEC @ReloadCnt = proc_EDW_PullHA_Temp_Data @CTVersionToPullNow;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '011 - ENDING data pull';
            PRINT 'ENDED loading temp table: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Loading temp table', @CT, @ET;
            DECLARE @ed100 AS datetime = GETDATE () ;
            EXEC proc_trace 'ENDED loading temp table: ', @st100, @ed100;
        END;

    DECLARE @iInserts AS int = 0
          , @iUpdates AS int = 0
          , @iDeletes AS int = 0;

    SET @CT = GETDATE () ;

    IF @iChgTypes = 1
        BEGIN
            SET @ET = GETDATE () ;
            EXEC proc_trace 'START Processing UPDATES ONLY', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '200 Pulling UPDATES only';
            EXEC @iUpdates = proc_CT_HA_AddUpdatedRecs;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '201 - ENDING data pull';
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 2
        BEGIN
            PRINT '**START Processing DELETES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing DELETES ONLY', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '250 Pulling DELETES only';
            EXEC @iDeletes = proc_CT_HA_AddDeletedRecs ;
            --exec @iDeletes = proc_CT_MarkDeletedRecords ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '251 - ENDING data pull';
            PRINT '** ENDED Processing DELETES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 3
        BEGIN
            PRINT '**START Processing Updates & DELETES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing Updates & DELETES ONLY', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '300 Pulling DELETES and UPDATES';
            EXEC @iUpdates = proc_CT_HA_AddUpdatedRecs;
            PRINT '**ENDED Step 1 - Start Step 2: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @iDeletes = proc_CT_HA_AddDeletedRecs ;
            --exec @iDeletes = proc_CT_MarkDeletedRecords ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '301 - ENDING data pull';
            PRINT '**ENDED Processing Updates & DELETES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 4
        BEGIN
            PRINT '**START Processing INSERTS ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing INSERTS ONLY', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '400 Pulling INSERTS ONLY';
            EXEC @iInserts = proc_CT_HA_AddNewRecs ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '401 - ENDING data pull';
            PRINT '** ENDED Processing INSERTS ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 5
        BEGIN
            PRINT '**START Processing Inserts and UPDATES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing Inserts and UPDATES', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '500 Pulling INSERTS and UPDATES';
            EXEC @iInserts = proc_CT_HA_AddNewRecs ;
            PRINT '**ENDED Step 1 - Start Step 2: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @iUpdates = proc_CT_HA_AddUpdatedRecs;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '501 - ENDING data pull';
            PRINT '**ENDED Processing Inserts and Updates ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 6
        BEGIN
            PRINT '**START Processing INSERTS and DELETES: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing Inserts and DELETES', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '600	     Pulling INSERTS and DELETES';
            EXEC @iInserts = proc_CT_HA_AddNewRecs ;
            PRINT '**ENDED Step 1 Start Step 2: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @iDeletes = proc_CT_HA_AddDeletedRecs ;
            --exec @iDeletes = proc_CT_MarkDeletedRecords ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '601 - ENDING data pull';
            PRINT '**ENDED Processing INSERTS and DELETES: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 7
        BEGIN
            PRINT '**Start Processing INSERTS/DELETES/UPDATES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing INSERTS/DELETES/UPDATES', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '700	 Pulling INSERTS/DELETES/UPDATES';
            EXEC @iInserts = proc_CT_HA_AddNewRecs ;
            PRINT '**ENDED Step 1 - Start Step 2: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @iUpdates = proc_CT_HA_AddUpdatedRecs;
            PRINT '**ENDED Step 2 - Start Step 3: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @iDeletes = proc_CT_HA_AddDeletedRecs ;
            --exec @iDeletes = proc_CT_MarkDeletedRecords ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '701 - ENDING data pull';
            PRINT '**ENDED Processing INSERTS/DELETES/UPDATES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;

    DECLARE @TotalAvailRecs AS bigint = 0;
    EXEC @TotalAvailRecs = proc_QuickRowCount 'DIM_EDW_HealthAssessment';

    IF @ReloadCnt > 0
        BEGIN
            SET @NbrOfDetectedChanges = @ReloadCnt;
        END;
    ELSE
        BEGIN
            SET @NbrOfDetectedChanges = @iInserts + @iUpdates + @iDeletes;
        END;

    INSERT INTO CT_VersionTracking (
           SVRName
         , DBName
         , TgtView
         , ExtractionDate
         , ExtractedVersion
         , CurrentDbVersion
         , ExtractedRowCnt
         , StartTime
         , EndTime
         , CNT_Insert
         , CNT_Update
         , CNT_Delete
         , CNT_StagingTable
         , CNT_PulledRecords) 
    VALUES
           (
           @@SERVERNAME , DB_NAME () , @TgtView , GETDATE () , @LatestDbVersionToPull ,
           @LatestDbVersionToPull , @NbrOfDetectedChanges , @StartTime , GETDATE () , @iInserts ,
           @iUpdates , @iDeletes , @TotalAvailRecs , @NbrOfDetectedChanges) ;

    --************************************************************************************************    
    SET @CT = GETDATE () ;
    EXEC proc_trace 'START Cleaning Staging Data', @CT, NULL;
    EXEC proc_clean_EDW_Staging;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END Process', @CT, @ET;
    --************************************************************************************************
    --************************************************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'START Converting Time to Central', @CT, NULL;
    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthAssessment';
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END Process', @CT, @ET;
    --************************************************************************************************

    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '800 - PROC FINISHED';
    EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '801 - END OF RUN';

    PRINT '015 LOAD Complete: PERF Monitor Table - EDW_Proc_Performance_Monitor' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'RUN COMPETE - TOTAL TIME: ', @STime, @ET;

-- select * from EDW_Proc_Performance_Monitor where TraceName = 'proc_Staging_EDW_Data' order by RowNbr Desc
-- SELECT * FROM CT_VersionTracking
-- select * from EDW_Proc_Performance_Monitor where TraceName = 'proc_Staging_EDW_Data' order by RowNbr
END;

GO

PRINT 'Created proc_STAGING_EDW_HA_Changes';

GO 

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO

-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

/*----------------------------------------------------------------------------
exec proc_STAGING_EDW_HA_Definition 0   --Process Changed Data only
exec proc_STAGING_EDW_HA_Definition 1   --Reload ALL
exec proc_STAGING_EDW_HA_Definition 0,7

select * from ##TEMP_EDW_HealthDefinition_DATA
select  * from CT_VersionTracking ; 
select * from view_EDW_HealthAssessmentDefinition_CT

PULLING Changes for versions between: 42944  and 43281
PULLING Changes for versions between: 43284  and 43287
PULLING Changes for versions between: 43455  and 43468
PULLING Changes for versions between: 43625  and 43627
PULLING Changes for versions between: 43629  and 43632
PULLING Changes for versions between: 43635  and 43691

PULLING Changes for versions between: 11  and 14

SELECT
       COUNT (*) 
       FROM STAGING_EDW_HA_Definition;

SELECT COUNT(*) FROM [view_EDW_HealthAssessmentDefinition_CT]	  --00:01:47
SELECT top 10 * FROM [view_EDW_HealthAssessmentDefinition_CT]
SELECT TOP 100 * FROM [STAGING_EDW_HA_Definition];
SELECT COUNT (*) FROM [STAGING_EDW_HA_Definition]; 

PERF Measurements
03.26.2015 : 4681580 rows - 01:26:36 run time / PROD 1 @ LAB - full reload
03.27.2015 : 4681580 rows - 01:01:20 run time / PROD 1 @ LAB - full reload
03.27.2015 : Prod2  @ LAB : (3711933 row(s) affected) : 01:56:01 - full reload
03.28.2015 : Prod3  @ LAB : (5697805 row(s) affected) : 05:45:57 - full reload
03.29.2015 : Prod2  @ LAB : (xx row(s) affected) : 01:56:01 - Changed Records

04.16.2015 : WDM - complted the SP and started testing.
05.28.2015 : WDM - completed unit testing 
*/

GO
PRINT 'FROM proc_STAGING_EDW_HA_Definition.SQL';
PRINT 'Creating proc_STAGING_EDW_HA_Definition';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_STAGING_EDW_HA_Definition') 
    BEGIN
        PRINT 'Replacing proc_STAGING_EDW_HA_Definition proc';
        DROP PROCEDURE
             proc_STAGING_EDW_HA_Definition;
    END;
GO

CREATE PROCEDURE proc_STAGING_EDW_HA_Definition
       @Reloadall int = 0
AS
BEGIN

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/
    SET NOCOUNT ON;
    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'STAGING_EDW_HA_Definition';

    IF @iTotal <= 1
        BEGIN
            PRINT 'NO RECORDS FOUND IN STAGING TABLE - Reloading all.';
            SET @Reloadall = 1;
        END;

    DECLARE
    @Synchronization_Version bigint = 0
  , @iVersion AS int
  , @Lastviewpull_Version AS bigint
  , @Lastpullversion AS bigint
  , @CurrentDbVersion AS int
  , @STime AS datetime
  , @TgtView AS nvarchar ( 100) = 'view_EDW_HealthDeffinition'
  , @ExtractionDate AS datetime
  , @ExtractedVersion AS int
  , @ExtractedRowCnt AS int
  , @EndTime AS datetime
  , @CNT_PulledRecords AS int = 0
  , @iCnt AS int = 0
  , @RowNbr AS int = 0
  , @StartTime AS datetime = GETDATE () 
  , @SVRName AS nvarchar ( 100) 
  , @DBName AS nvarchar ( 100) = DB_NAME () 
  , @CNT_Insert AS int = 0
  , @CNT_Update AS int = 0
  , @CNT_Delete AS int = 0
  , @CNT_StagingTable int = 0
  , @VersionNBR int = 0
  , @TrackProgress int = 1;

    SET @SVRName = ( SELECT
                            @@SERVERNAME) ;

    SET @STime = GETDATE () ;

    DECLARE
    @RecordID AS uniqueidentifier = NEWID () ;
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_HA_Definition' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                               FROM sys.tables
                               WHERE name = 'STAGING_EDW_HA_Definition') 
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping STAGING_EDW_HA_Definition for FULL reload.';
                        END;
                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    DROP TABLE
                         STAGING_EDW_HA_Definition;
                END;
            ELSE
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading STAGING_EDW_HA_Definition.';
                        END;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE
                          () AS nvarchar ( 50)) ;
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL EDW HA Data.';

                    SELECT
                           * INTO
                                  STAGING_EDW_HA_Definition
                           FROM view_EDW_HealthAssessmentDefinition_CT;
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @@ROWCOUNT;

                    EXEC proc_Add_EDW_CT_StdCols 'STAGING_EDW_HA_Definition';

                    SET @iCnt = ( SELECT
                                         COUNT ( *) 
                                         FROM STAGING_EDW_HA_Definition) ;
                    PRINT DB_NAME () + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) + ' , loaded ' + CAST ( @iCnt
                          AS nvarchar ( 50)) + ' records.';

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( *) 
                                                      FROM STAGING_EDW_HA_Definition) ;
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                           FROM sys.indexes
                                           WHERE name = 'PI_EDW_HealthAssessment_IDs') 
                        BEGIN
                            PRINT 'Adding INDEX PI_EDW_HealthAssessment_IDs at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                            CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_IDs ON dbo.STAGING_EDW_HA_Definition ( RCDocumentGuid ,
                            RADocumentGuid , RACodeName , QuesDocumentGuid , AnsDocumentGuid , HANodeSiteID) WITH ( PAD_INDEX = OFF ,
                            STATISTICS_NORECOMPUTE = OFF ,
                            SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                        END;

                    SET @ExtractionDate = GETDATE () ;
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( *) 
                                                    FROM STAGING_EDW_HA_Definition) ;
                    --SET @TgtView = 'view_EDW_HealthDeffinition';
                    SET @EndTime = GETDATE () ;

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                         , ExtractedVersion
                         , CurrentDbVersion
                         , ExtractedRowCnt
                         , TgtView
                         , StartTime
                         , EndTime
                         , SVRName
                         , DBName
                         , CNT_Insert
                         , CNT_Update
                         , CNT_delete
                         , CNT_PulledRecords
                         , CNT_StagingTable) 
                    VALUES
                    (
                    @ExtractionDate , @ExtractedVersion , @CurrentDbVersion , @ExtractedRowCnt , @TgtView , @StartTime , @EndTime , @SVRName ,
                    @DBName , @CNT_Insert , @CNT_Update , @CNT_delete , @CNT_PulledRecords , @CNT_StagingTable) ;

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                        END;

                END;
            -- SELECT * INTO [STAGING_EDW_HA_Definition] FROM [view_EDW_HealthAssessmentDefinition_CT];
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            SET @STime = GETDATE () ;

            EXEC proc_EDW_ChangeGmtToCentralTime 'STAGING_EDW_HA_Definition';
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_HA_Definition' , @STime , @CNT_PulledRecords , 'U';
            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                           FROM sys.tables
                           WHERE name = 'STAGING_EDW_HA_Definition') 
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table STAGING_EDW_HA_Definition was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            --IF NOT EXISTS ( SELECT
            --                name
            --                  FROM sys.indexes
            --                  WHERE name = 'PI_EDW_HealthAssessment_IDs') 
            --    BEGIN
            --        IF @TrackProgress = 1
            --            BEGIN
            --                PRINT 'Adding INDEX PI_EDW_HealthAssessment_IDs';
            --            END;
            --        CREATE NONCLUSTERED INDEX PI_EDW_HealthAssessment_IDs ON dbo.STAGING_EDW_HA_Definition ( ItemCreatedWhen ASC , ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC , HAUserQuestion_ItemModifiedWhen ASC , HAUserAnswers_ItemModifiedWhen ASC) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
            --    END;

            IF NOT EXISTS ( SELECT
                                   name
                                   FROM sys.indexes
                                   WHERE name = 'PI_EDW_HealthAssessment_IDs') 
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_HealthAssessment_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_HealthAssessment_IDs ON dbo.STAGING_EDW_HA_Definition ( RCDocumentGuid , RADocumentGuid ,
                    RACodeName , QuesDocumentGuid , AnsDocumentGuid , HANodeSiteID) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF ,
                    SORT_IN_TEMPDB = OFF ,
                    DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                               FROM tempdb.dbo.sysobjects
                               WHERE id = OBJECT_ID ( N'tempdb..##TEMP_EDW_HealthDefinition_DATA')) 
                --FROM sys.tables
                --WHERE name = '##TEMP_EDW_HealthDefinition_DATA') 
                BEGIN
                    PRINT 'Dropping ##TEMP_EDW_HealthDefinition_DATA';
                    DROP TABLE
                         ##TEMP_EDW_HealthDefinition_DATA;
                END;

--*****************************************************************************************

            SELECT
                   * INTO
                          ##TEMP_EDW_HealthDefinition_DATA
                   FROM view_EDW_HealthAssessmentDefinition_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

            EXEC proc_Add_EDW_CT_StdCols '##TEMP_EDW_HealthDefinition_DATA';

            CREATE CLUSTERED INDEX temp_PI_EDW_HealthAssessment_IDs ON dbo.##TEMP_EDW_HealthDefinition_DATA
            (	 RCDocumentGuid ,
            RADocumentGuid ,
            RACodeName ,
            QuesDocumentGuid ,
            AnsDocumentGuid ,
            HANodeSiteID) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF ,
            SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM ##TEMP_EDW_HealthDefinition_DATA) ;

--*****************************************************************************************
-- ADD NEW RECORDS
--*****************************************************************************************
            DECLARE
            @iNewInserts AS int = 0;
            EXEC @iNewInserts = proc_CT_HA_Definition_AddNewRecs ;
            PRINT 'new inserts: ' + CAST ( @iNewInserts AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iNewInserts;

--*****************************************************************************************
-- ADD UPDATED RECORDS
--*****************************************************************************************
            --select top 100 * from ##TEMP_EDW_HealthDefinition_DATA
            DECLARE
            @iUpdates AS int = 0;
            EXEC @iUpdates = proc_CT_HA_Definition_AddUpdatedRecs ;
            PRINT 'Updated Records: ' + CAST ( @iUpdates AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdates;

--*****************************************************************************************
--		  FIND ANY DELETED ROWS
--*****************************************************************************************
            DECLARE
            @iDeleted AS int = 0;
            EXEC @iDeleted = proc_CT_HA_Definition_AddDeletedRecs ;
            PRINT 'MARKED Deleted Records: ' + CAST ( @iDeleted AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDeleted;

--*****************************************************************************************
            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( *) 
                                             FROM STAGING_EDW_HA_Definition) ;
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
                   WHERE
                         RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
                   WHERE
                         RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM ##TEMP_EDW_HealthDefinition_DATA) ;

            EXEC proc_EDW_ChangeGmtToCentralTime 'STAGING_EDW_HA_Definition';
            SET @STime = GETDATE () ;
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_HA_Definition' , @STime , @CNT_PulledRecords , 'U';

        END;
    SET NOCOUNT OFF;
END;

GO
PRINT 'Created proc_STAGING_EDW_HA_Definition';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Processing view_EDW_HealthAssessment_STAGED';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_HealthAssessment_STAGED') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessment_STAGED;
    END;
GO
--select top 100 * from [view_EDW_HealthAssessment_STAGED]
CREATE VIEW dbo.view_EDW_HealthAssessment_STAGED
AS SELECT
          UserStartedItemID
        , HealthAssesmentUserStartedNodeGUID
        , UserID
        , UserGUID
        , HFitUserMpiNumber
        , SiteGUID
        , AccountID
        , AccountCD
        , AccountName
        , cast(HAStartedDt as datetime) as HAStartedDt 
        , cast(HACompletedDt as datetime) as HACompletedDt
        , UserModuleItemId
        , UserModuleCodeName
        , HAModuleNodeGUID
        , CMSNodeGuid
        , HAModuleVersionID
        , UserRiskCategoryItemID
        , UserRiskCategoryCodeName
        , HARiskCategoryNodeGUID						--WDM 8/7/2014 as HARiskCategoryDocumentID
        , HARiskCategoryVersionID			--WDM 10.02.2014 place holder for EDW ETL
        , UserRiskAreaItemID
        , UserRiskAreaCodeName
        , HARiskAreaNodeGUID							--WDM 8/7/2014 as HARiskAreaDocumentID
        , HARiskAreaVersionID			--WDM 10.02.2014 place holder for EDW ETL
        , UserQuestionItemID
        , Title			--WDM 47619 12.29.2014
        , HAQuestionGuid		--WDM 9.2.2014	This is a repeat field but had to stay to match the previous view - this is the NODE GUID and matches to the definition file to get the question. This tells you the question, language agnostic.
        , UserQuestionCodeName
        , HAQuestionDocumentID	--WDM 10.1.2014 - this is GOING AWAY 		--WDM 10.02.2014 place holder for EDW ETL
        , HAQuestionVersionID			--WDM 10.1.2014 - this is GOING AWAY - no versions across environments 		--WDM 10.02.2014 place holder for EDW ETL
        , HAQuestionNodeGUID		--WDM 10.01.2014	Left this in place to preserve column structure.		
        , UserAnswerItemID
        , HAAnswerNodeGUID								--WDM 8/7/2014 as HAAnswerDocumentID
        , HAAnswerVersionID		--WDM 10.1.2014 - this is GOING AWAY - no versions across environments		--WDM 10.02.2014 place holder for EDW ETL
        , UserAnswerCodeName
        , HAAnswerValue
        , HAModuleScore
        , HARiskCategoryScore
        , HARiskAreaScore
        , HAQuestionScore
        , HAAnswerPoints
        , PointResults
        , UOMCode
        , HAScore
        , ModulePreWeightedScore
        , RiskCategoryPreWeightedScore
        , RiskAreaPreWeightedScore
        , QuestionPreWeightedScore
        , QuestionGroupCodeName
        --, ChangeType
        , cast(ItemCreatedWhen as datetime) as ItemCreatedWhen
        , cast(ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProfessionallyCollected
        , cast(HARiskCategory_ItemModifiedWhen as datetime) as HARiskCategory_ItemModifiedWhen
        , cast(HAUserRiskArea_ItemModifiedWhen as datetime) as HAUserRiskArea_ItemModifiedWhen
        , cast(HAUserQuestion_ItemModifiedWhen as datetime) as HAUserQuestion_ItemModifiedWhen
        , cast(HAUserAnswers_ItemModifiedWhen as datetime) as HAUserAnswers_ItemModifiedWhen
        , HAPaperFlg
        , HATelephonicFlg
        , HAStartedMode		--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 
        , HACompletedMode	--12.11.2014 WDM Sowmiya and dale talked and decided to implement this column 12.17.2014 - Added 

        , DocumentCulture_VHCJ
        , DocumentCulture_HAQuestionsView
        , CampaignNodeGUID
	   ,cast(LastModifiedDate as datetime) as LastModifiedDate
          FROM Staging_EDW_HealthAssessment;

GO

PRINT 'Processed view_EDW_HealthAssessment_STAGED';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthAssessment_STAGED.sql';
GO 


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
07.08.2015 : WDM - competed validation testing 
*/

/****************************************************************************
select top 1000 * from DIM_EDW_Trackers

exec proc_STAGING_EDW_CompositeTracker 0   --Process Changed Data only
exec proc_STAGING_EDW_CompositeTracker 1   --Reload ALL
exec proc_STAGING_EDW_CompositeTracker 0,7

select * from DIM_TEMPTBL_Staging_EDW_Tracker_DATA
select  * from CT_VersionTracking ; 
PULLING Changes for versions between: 0  and 36


SELECT COUNT(*) FROM DIM_EDW_Trackers
SELECT COUNT(*) FROM [view_EDW_TrackerCompositeDetails_CT]
SELECT top 10 * FROM [view_EDW_TrackerCompositeDetails_CT]
SELECT TOP 100 * FROM [DIM_EDW_Trackers];
SELECT COUNT (*) FROM [DIM_EDW_Trackers]; 

PERF Measurements
03.26.2015 : 4681580 rows - 01:26:36 run time / PROD 1 @ LAB - full reload
03.29.2015 : Prod2  @ LAB : (xx row(s) affected) : 01:56:01 - Changed Records
04.23.2015 : 00 rows - 00:00:00 run time / PROD 1 @ LAB - full reload
****************************************************************************/

GO
PRINT 'FROM proc_STAGING_EDW_CompositeTracker.SQL';
PRINT 'Creating proc_STAGING_EDW_CompositeTracker';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_STAGING_EDW_CompositeTracker' )
    BEGIN
        PRINT 'Replacing proc_STAGING_EDW_CompositeTracker proc';
        DROP PROCEDURE
             proc_STAGING_EDW_CompositeTracker;
    END;
GO

IF EXISTS ( SELECT
                   table_name
              FROM information_schema.tables
              WHERE table_name = 'DIM_TEMPTBL_Staging_EDW_Tracker_DATA' )
    BEGIN
        IF NOT EXISTS ( SELECT
                               column_name
                          FROM information_schema.columns
                          WHERE
                               column_name = 'DeletedFlg'
                           AND table_name = 'DIM_TEMPTBL_Staging_EDW_Tracker_DATA' )
            BEGIN
                ALTER TABLE DIM_TEMPTBL_Staging_EDW_Tracker_DATA
                ADD
                            DeletedFlg bit NULL;
            END;
    END ;
ELSE
    BEGIN
        PRINT 'Creating DIM_TEMPTBL_Staging_EDW_Tracker_DATA Table';
        CREATE TABLE dbo.DIM_TEMPTBL_Staging_EDW_Tracker_DATA(
                     TrackerNameAggregateTable varchar( 32 ) NOT NULL ,
                     ItemID int NOT NULL ,
                     EventDate datetime NOT NULL ,
                     IsProfessionallyCollected bit NOT NULL ,
                     TrackerCollectionSourceID int NOT NULL ,
                     Notes nvarchar( 1000 ) NULL ,
                     UserID int NOT NULL ,
                     CollectionSourceName_Internal nvarchar( 100 ) NULL ,
                     CollectionSourceName_External nvarchar( 100 ) NULL ,
                     EventName varchar( 7 ) NOT NULL ,
                     UOM varchar( 10 ) NOT NULL ,
                     KEY1 varchar( 18 ) NOT NULL ,
                     VAL1 float NULL ,
                     KEY2 varchar( 13 ) NOT NULL ,
                     VAL2 float NULL ,
                     KEY3 varchar( 12 ) NOT NULL ,
                     VAL3 float NULL ,
                     KEY4 varchar( 9 ) NOT NULL ,
                     VAL4 float NULL ,
                     KEY5 varchar( 12 ) NOT NULL ,
                     VAL5 float NULL ,
                     KEY6 varchar( 11 ) NOT NULL ,
                     VAL6 float NULL ,
                     KEY7 varchar( 10 ) NOT NULL ,
                     VAL7 float NULL ,
                     KEY8 varchar( 3 ) NOT NULL ,
                     VAL8 float NULL ,
                     KEY9 varchar( 2 ) NOT NULL ,
                     VAL9 int NULL ,
                     KEY10 varchar( 2 ) NOT NULL ,
                     VAL10 int NULL ,
                     ItemCreatedBy int NULL ,
                     ItemCreatedWhen datetime NULL ,
                     ItemModifiedBy int NULL ,
                     ItemModifiedWhen datetime NULL ,
                     IsProcessedForHa bit NULL ,
                     TXTKEY1 varchar( 10 ) NOT NULL ,
                     TXTVAL1 nvarchar( 500 ) NULL ,
                     TXTKEY2 varchar( 8 ) NOT NULL ,
                     TXTVAL2 nvarchar( 255 ) NULL ,
                     TXTKEY3 varchar( 2 ) NOT NULL ,
                     TXTVAL3 int NULL ,
                     ItemOrder int NULL ,
                     ItemGuid uniqueidentifier NULL ,
                     UserGuid uniqueidentifier NOT NULL ,
                     MPI varchar( 50 ) NOT NULL ,
                     ClientCode varchar( 12 ) NULL ,
                     SiteGUID uniqueidentifier NOT NULL ,
                     AccountID int NOT NULL ,
                     AccountCD nvarchar( 8 ) NULL ,
                     IsAvailable bit NULL ,
                     IsCustom bit NULL ,
                     UniqueName nvarchar( 50 ) NULL ,
                     ColDesc nvarchar( 50 ) NULL ,
                     VendorID int NULL ,
                     VendorName nvarchar( 32 ) NULL ,
                     CT_ItemID int NULL ,
                     CT_ChangeVersion bigint NULL ,
                     CMS_Operation nchar( 1 ) NULL ,
                     DeleteFlg bit NULL ,
                     ConvertedToCentralTime bit NULL ,
                     TimeZone nvarchar( 10 ) NULL ,
                     ItemLastUpdated datetime NULL ,
                     DeletedFlg bit NULL
        )
        ON [PRIMARY];
    END;
GO

CREATE PROCEDURE proc_STAGING_EDW_CompositeTracker
@Reloadall int = 0
, @VersionNBR AS int = NULL
, @TrackProgress AS bit = 0
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE
       @iChangesFound AS int = 0;
    EXEC @iChangesFound = proc_CkTrackerDataChanged ;
    IF @iChangesFound = 0
        BEGIN
            PRINT 'No tracker changes found, run compete.';
		  set nocount off;
            RETURN;
        END;
    IF @iChangesFound = 1
        BEGIN
            PRINT 'Tracker changes found, UPDATES or INSERTS only - no deletes.';
        END;
    IF @iChangesFound = 2
        BEGIN
            PRINT 'Tracker changes found, UPDATES or INSERTS and DELETES.';
        END;

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_Trackers';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

    DECLARE
       @Synchronization_Version bigint = 0
       ,@iVersion AS int
       ,@Lastviewpull_Version AS bigint
       ,@Lastpullversion AS bigint
       ,@CurrentDbVersion AS int
       ,@STime AS datetime
       ,@TgtView AS nvarchar ( 100 ) = 'view_EDW_TrackerCompositeDetails'
       ,@ExtractionDate AS datetime
       ,@ExtractedVersion AS int
       ,@ExtractedRowCnt AS int
       ,@EndTime AS datetime
       ,@CNT_PulledRecords AS int = 0
       ,@iCnt AS int = 0
       ,@RowNbr AS int = 0
       ,@StartTime AS datetime = GETDATE ( )
       ,@SVRName AS nvarchar ( 100 )
       ,@DBName AS nvarchar ( 100 ) = DB_NAME ( )
       ,@CNT_Insert AS int = 0
       ,@CNT_Update AS int = 0
       ,@CNT_Delete AS int = 0
       ,@CNT_StagingTable int = 0;

    PRINT '*******************************************************************************************';
    PRINT '********** NOTICE *************************************************************************';
    PRINT 'ONLY RECORDS WITH A CORRESPONDING CHANGE TRACKING RECORD WILL BE RETURNED BY THIS PROC.';
    PRINT '*******************************************************************************************';

    SET @SVRName = ( SELECT
                            @@SERVERNAME );
    DECLARE
       @RecordID AS uniqueidentifier = NEWID ( );
    SET @STime = GETDATE ( );
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_CompositeTracker' , @STime , 0 , 'I';
    IF @Reloadall = NULL
        BEGIN
            SET @Reloadall = 0;
        END;
    IF @Reloadall = 1
        BEGIN

            --print 'Loc #01' ;

            SET @VersionNBR = NULL;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'RELOAD is ON: ' + CAST ( @Reloadall AS nvarchar ( 50 ));
                    PRINT 'Change Version is: ' + CAST ( @VersionNBR AS nvarchar ( 50 ));
                END;
        END;
    ELSE
        BEGIN

            --print 'Loc #02' ;

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'RELOAD is OFF: ' + CAST ( @Reloadall AS nvarchar ( 50 ));
                    PRINT 'Change Version is: ' + CAST ( @VersionNBR AS nvarchar ( 50 ));
                END;
        END;
    SET @CurrentDbVersion = CHANGE_TRACKING_CURRENT_VERSION ( );

    --print 'Loc #03' ;

    IF @Reloadall = 1
        BEGIN

            --print 'Loc #04' ;

            IF EXISTS ( SELECT
                               NAME
                          FROM sys.tables
                          WHERE name = 'DIM_EDW_Trackers' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_EDW_Trackers for FULL reload.';
                        END;
                    DROP TABLE
                         DIM_EDW_Trackers;
                END;
            ELSE
                BEGIN

                    --print 'Loc #05' ;

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading DIM_EDW_Trackers.';
                        END;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA data - this could take several hours, Started at: ' + CAST ( GETDATE ( ) AS
                          nvarchar ( 50 ));
                END;
            IF @Reloadall = 1
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'RELOADING ALL EDW HA Data.';
                        END;

                    --print 'Loc #06' ;

                    SELECT
                           * INTO
                                  DIM_EDW_Trackers
                      FROM view_EDW_TrackerCompositeDetails_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_Trackers';

                    ALTER TABLE DIM_EDW_Trackers
                    ADD
                                ItemLastUpdated datetime NULL;

                    IF @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( * )
                                            FROM DIM_EDW_Trackers );
                            PRINT DB_NAME ( ) + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt
                                  AS nvarchar ( 50 )) + ' records.';
                        END;

                    --print 'Loc #10' ;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( * )
                                                 FROM DIM_EDW_Trackers );
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                      FROM sys.indexes
                                      WHERE name = 'PI_Staging_EDW_Tracker_Dates' )
                        BEGIN
                            IF @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_Staging_EDW_Tracker_Dates at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                                END;
                            CREATE NONCLUSTERED INDEX PI_Staging_EDW_Tracker_Dates ON dbo.DIM_EDW_Trackers ( TrackerNameAggregateTable , itemID ,
                            ItemModifiedWhen ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
                            ONLINE = OFF ,
                            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                        END;
                    SET @ExtractionDate = GETDATE ( );
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( * )
                                               FROM DIM_EDW_Trackers );
                    SET @EndTime = GETDATE ( );
                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                           ,ExtractedVersion
                           ,CurrentDbVersion
                           ,ExtractedRowCnt
                           ,TgtView
                           ,StartTime
                           ,EndTime
                           ,SVRName
                           ,DBName
                           ,CNT_Insert
                           ,CNT_Update
                           ,CNT_delete
                           ,CNT_PulledRecords
                           ,CNT_StagingTable )
                    VALUES
                    (
                    @ExtractionDate ,
                    @ExtractedVersion ,
                    @CurrentDbVersion ,
                    @ExtractedRowCnt ,
                    @TgtView ,
                    @StartTime ,
                    @EndTime ,
                    @SVRName ,
                    @DBName ,
                    @CNT_Insert ,
                    @CNT_Update ,
                    @CNT_delete ,
                    @CNT_PulledRecords ,
                    @CNT_StagingTable );
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;

                    --print 'Loc #12' ;

                    SET @iCnt = @@ROWCOUNT;
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt;
                END;

            -- SELECT * INTO [DIM_EDW_Trackers] FROM [view_EDW_TrackerCompositeDetails_CT];

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;
            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_Staging_EDW_Tracker_Dates' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Adding INDEX PI_Staging_EDW_Tracker_Dates at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;
                    CREATE NONCLUSTERED INDEX PI_Staging_EDW_Tracker_Dates ON dbo.DIM_EDW_Trackers ( TrackerNameAggregateTable , itemID ,
                    ItemModifiedWhen ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
                    ONLINE = OFF ,
                    ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            --print 'Loc #13' ;

            SET @STime = GETDATE ( );

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Trackers';

            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_CompositeTracker' , @STime , @CNT_PulledRecords , 'U';
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @iCnt;

            --print 'Loc #15' ;        
            SET NOCOUNT OFF;
            RETURN;
        END;

    --print 'Loc #16' ;

    IF NOT EXISTS ( SELECT
                           NAME
                      FROM sys.tables
                      WHERE name = 'DIM_EDW_Trackers' )
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_Trackers was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            --print 'Loc #17' ;

            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_Staging_EDW_Tracker_Dates' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Adding INDEX PI_Staging_EDW_Tracker_Dates';
                        END;
                    CREATE NONCLUSTERED INDEX PI_Staging_EDW_Tracker_Dates ON dbo.DIM_EDW_Trackers ( TrackerNameAggregateTable , itemID ,
                    ItemModifiedWhen ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
                    ONLINE = OFF ,
                    ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;
            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_Staging_EDW_Tracker_IDs' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Adding INDEX PI_Staging_EDW_Tracker_IDs';
                        END;
                    CREATE CLUSTERED INDEX PI_Staging_EDW_Tracker_IDs ON dbo.DIM_EDW_Trackers ( TrackerNameAggregateTable , itemID ) WITH ( PAD_INDEX = OFF ,
                    STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON ,
                    ALLOW_PAGE_LOCKS = ON );
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name

                        --FROM tempdb.dbo.sysobjects
                        --WHERE id = OBJECT_ID ( N'tempdb..#DIM_TEMPTBL_Staging_EDW_Tracker_DATA')) 

                          FROM sys.tables
                          WHERE name = 'DIM_TEMPTBL_Staging_EDW_Tracker_DATA' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_TEMPTBL_Staging_EDW_Tracker_DATA';
                        END;
                    DROP TABLE
                         DIM_TEMPTBL_Staging_EDW_Tracker_DATA;
                END;
            PRINT 'Standby, PULL HA changes- this could take several hours: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
            SET @LastpullVersion = ( SELECT
                                            MAX ( CurrentDbVersion )
                                       FROM CT_VersionTracking
                                       WHERE
                                            SVRname = @@ServerName
                                        AND DBName = DB_NAME ( )
                                        AND TgtView = @TgtView );
            SET @LastViewPull_Version = ( SELECT
                                                 MAX ( ExtractedVersion )
                                            FROM CT_VersionTracking
                                            WHERE
                                                 SVRname = @@ServerName
                                             AND DBName = DB_NAME ( )
                                             AND TgtView = @TgtView );
            IF
                   @LastpullVersion < 0
                OR @LastpullVersion IS NULL
                BEGIN
                    SET @LastpullVersion = 0;
                END;
            IF
                   @LastViewPull_Version < 0
                OR @LastpullVersion IS NULL
                BEGIN
                    SET @LastViewPull_Version = 0;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Pulling @LastpullVersion ' + CAST ( @LastpullVersion AS nvarchar ( 50 ));
                    PRINT 'Pulling @LastViewPull_Version ' + CAST ( @LastViewPull_Version AS nvarchar ( 50 ));
                END;

            --****************************************************************************
            --FILL THE TEMP TABLE WITH DATA
            --****************************************************************************

            SELECT
                   * INTO
                          DIM_TEMPTBL_Staging_EDW_Tracker_DATA
              FROM view_EDW_TrackerCompositeDetails_CT
              WHERE CMS_Operation IS NOT NULL;

            EXEC proc_Add_EDW_CT_StdCols 'DIM_TEMPTBL_Staging_EDW_Tracker_DATA';

            SET @CNT_PulledRecords = @@ROWCOUNT;

            IF NOT EXISTS ( SELECT
                                   column_name
                              FROM information_schema.columns
                              WHERE
                                   column_name = 'DeletedFlg'
                               AND table_name = 'DIM_TEMPTBL_Staging_EDW_Tracker_DATA' )
                BEGIN
                    ALTER TABLE DIM_TEMPTBL_Staging_EDW_Tracker_DATA
                    ADD
                                DeletedFlg bit NULL;
                END;

            --ALTER TABLE DIM_TEMPTBL_Staging_EDW_Tracker_DATA
            --ADD
            --            DeletedFlg bit NULL;

            ALTER TABLE DIM_TEMPTBL_Staging_EDW_Tracker_DATA
            ADD
                        ItemLastUpdated datetime NULL;
            UPDATE DIM_TEMPTBL_Staging_EDW_Tracker_DATA
              SET
                  ItemLastUpdated = GETDATE ( );
            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'temp_PI_Staging_EDW_Tracker_IDs' )
                BEGIN
                    CREATE CLUSTERED INDEX temp_PI_Staging_EDW_Tracker_IDs ON dbo.DIM_TEMPTBL_Staging_EDW_Tracker_DATA ( TrackerNameAggregateTable , itemID ,
                    ItemModifiedWhen ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
                    ONLINE = OFF ,
                    ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;

            IF @TrackProgress = 1
                BEGIN
                    SET @iCnt = ( SELECT
                                         COUNT ( * )
                                    FROM DIM_TEMPTBL_Staging_EDW_Tracker_DATA );
                    PRINT DB_NAME ( ) + ' - Completed PULL at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50 )) + ' records.';
                END;
            SET @STime = GETDATE ( );
            SET @CurrentDbVersion = CHANGE_TRACKING_CURRENT_VERSION ( );
            IF @TrackProgress = 1
                BEGIN
                    PRINT '@CurrentDbVersion: ' + CAST ( @CurrentDbVersion AS nvarchar ( 50 ));
                END;
            SET @ExtractionDate = GETDATE ( );
            SET @ExtractedRowCnt = ( SELECT
                                            COUNT ( * )
                                       FROM DIM_TEMPTBL_Staging_EDW_Tracker_DATA );

            --SET @TgtView = 'view_EDW_TrackerCompositeDetails';

            SET @EndTime = GETDATE ( );
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'ADDING THE TRACKING RECORD.';
                END;
            INSERT INTO CT_VersionTracking (
                   ExtractionDate
                   ,ExtractedVersion
                   ,CurrentDbVersion
                   ,ExtractedRowCnt
                   ,TgtView
                   ,StartTime
                   ,EndTime
                   ,SVRName
                   ,DBName
                   ,CNT_Insert
                   ,CNT_Update
                   ,CNT_delete
                   ,CNT_PulledRecords )
            VALUES
            (
            @ExtractionDate ,

            --@LastpullVersion ,

            @CurrentDbVersion ,
            @CurrentDbVersion ,
            @ExtractedRowCnt ,
            @TgtView ,
            @StartTime ,
            @EndTime ,
            @SVRName ,
            @DBName ,
            @CNT_Insert ,
            @CNT_Update ,
            @CNT_delete ,
            @CNT_PulledRecords );
            SET @RowNbr = ( SELECT
                                   MAX ( RowNbr )
                              FROM CT_VersionTracking
                              WHERE
                                   SVRName = @SVRName
                               AND DBName = @DBName
                               AND TgtView = @TgtView );
            --SET @CNT_PulledRecords = ( SELECT
            --                              COUNT ( *) 
            --                                  FROM DIM_TEMPTBL_Staging_EDW_Tracker_DATA );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            --SELECT * FROM CT_VersionTracking
            --The temp table is loaded.
            --Check to see if NEW records exist and if not, insert them into the staging table

            SET @iCnt = ( SELECT
                                 COUNT ( * )
                            FROM
                                 DIM_TEMPTBL_Staging_EDW_Tracker_DATA AS T1 LEFT JOIN
                                      DIM_EDW_Trackers AS T2
                                                                     ON
                                 T1.TrackerNameAggregateTable = T2.TrackerNameAggregateTable
                             AND T1.ItemId = T2.ItemId
                            WHERE T2.ItemID IS NULL );
            IF @TrackProgress = 1
                BEGIN
                    PRINT '#New Records found: ' + CAST ( @iCnt AS nvarchar ( 50 )) + '. Updating VersionTracking RowNbr: ' + CAST ( @RowNbr AS
                          nvarchar ( 5 ));
                END;
            UPDATE CT_VersionTracking
              SET
                  CNT_Insert = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            --***************************************************
            --FIND AND PROCESS NEW RECORDS
            --***************************************************
            EXEC @iCnt = proc_CT_TrackerComposite_AddNewRecs ;
            --***************************************************            

            PRINT 'NEW RECORDS FOUND : ' + CAST ( @iCnt AS nvarchar ( 50 ));
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @iCnt;

            --Check to see if CURRENT records have differnet HASH codes and if so, update the staging table

            SET @iCnt = ( SELECT
                                 COUNT ( * )
                            FROM
                                 DIM_EDW_Trackers AS T2 JOIN
                                      DIM_TEMPTBL_Staging_EDW_Tracker_DATA AS T1
                                                            ON
                                 T1.TrackerNameAggregateTable = T2.TrackerNameAggregateTable
                             AND T1.ItemId = T2.ItemId
                            WHERE T1.CMS_Operation IS NOT NULL );
            IF @TrackProgress = 1
                BEGIN
                    PRINT '#Records found to update: ' + CAST ( @iCnt AS nvarchar ( 50 )) + '. Updating VersionTracking RowNbr: ' + CAST ( @RowNbr AS
                          nvarchar ( 5 ));
                END;
            UPDATE CT_VersionTracking
              SET
                  CNT_Update = @iCnt
              WHERE
                    RowNbr = @RowNbr;

		  /**********************************************************************************************
		  FIND AND PROCESS UPDATED ROWS
		  Set and record the Current DB change version and use it to prevent updating the data twice.
		  **********************************************************************************************/
            EXEC @iCnt = proc_CT_TrackerComposite_AddUpdatedRecs ;            
            PRINT 'UPDATED RECORDS FOUND : ' + CAST ( @iCnt AS nvarchar ( 50 ));

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iCnt;
            --EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iCnt;
            

            /* update DIM_TEMPTBL_Staging_EDW_Tracker_DATA Set CMS_Operation = 'D' where ItemID in (Select top 100 ItemID from DIM_TEMPTBL_Staging_EDW_Tracker_DATA) */
		  --***************************************
		  -- MARK Delted records
		  exec @iCnt = proc_CT_TrackerComposite_AddDeletedRecs ;            
            PRINT 'DELETED RECORDS FLAGGED : ' + CAST ( @iCnt AS nvarchar ( 50 ));

		  UPDATE CT_VersionTracking
              SET
                  CNT_delete = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iCnt;
            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( * )
                                        FROM DIM_EDW_Trackers );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;
            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
              WHERE
                    RowNbr = @RowNbr;
            SET @STime = GETDATE ( );

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Trackers';
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_STAGING_EDW_CompositeTracker' , @STime , @CNT_PulledRecords , 'U';

            --EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D', @iCnt;

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @CNT_PulledRecords;
        END;
    SET NOCOUNT OFF;
END;
GO
PRINT 'Created proc_STAGING_EDW_CompositeTracker';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





--IF EXISTS (SELECT name FROM sys.triggers where name = 'trgSchemaMonitor')    
--DISABLE TRIGGER trgSchemaMonitor ON DATABASE;

GO
PRINT '***** FROM: view_EDW_TrackerCompositeDetails.sql';
PRINT 'Processing: view_EDW_TrackerCompositeDetails ';
GO
--SELECT * from view_EDW_TrackerCompositeDetails
IF EXISTS ( SELECT DISTINCT
                   TABLE_NAME
                   FROM INFORMATION_SCHEMA.VIEWS
                   WHERE
                   TABLE_NAME = 'view_EDW_TrackerCompositeDetails') 
    BEGIN
        DROP VIEW
             view_EDW_TrackerCompositeDetails;
    END;
GO
--count with UNION ALL xx @ 00:00:24
--count with UNION ALL and DISTINCT xx @ 00:00:24
--count with UNION 3,218,556 @ 00:00:24
--SELECT count(*) from view_EDW_TrackerCompositeDetails;
GO
CREATE VIEW dbo.view_EDW_TrackerCompositeDetails
AS
--************************************************************************************************************************************
-- NOTES:
--************************************************************************************************************************************
--WDM 6/26/2014
--This view is needed by EDW in order to process the Tracker tables' data.
--As of now, the Tracker tables are representative of objects and that would cause 
--	large volumes of ETL to be devloped and maintained. 
--This view represents a columnar representation of all tracker tables in a Key/Value pair representation.
--Each tracker table to be processed into the EDW must be represented in this view.
--ALL new tracker tables need only be entered once using the structure contained within this view
--	and the same EDW ETL should be able to process it.
--If there is a change to the strucuture of any one query in this view, then all have to be modified 
--	to be support the change.
--Column TrackerNameAggregratetable (AggregateTableName) will be NULL if the Tracker is not a member 
--		of the DISPLAYED Trackers. This allows us to capture all trackers, displayed or not.

--7/29/2014
--ISSUE: HFit_TrackerBMI,  HFit_TrackerCholesterol, and HFit_TrackerHeight are not in the HFIT_Tracker
--		table. This causes T.IsAvailable, T.IsCustom, T.UniqueName to be NULL. 
--		This raises the need for the Tracker Definition Table.

--NOTE: It is a goal to keep this view using BASE tables in order to gain max performance. Nested views will 
--		be avoided here if possible.

--**************** SPECIFIC TRACKER DATA **********************
--**************** on 7/29/2014          **********************
--Tracker GUID or Unique ID across all DB Instances (ItemGuid)
--Tracker NodeID (we use it for the External ID for Audit and error Triage)  (John: can use ItemID in this case)
--Tracker Table Name or Value Group Name (e.g. Body Measurements) - Categorization (TrackerNameAggregateTable)
--Tracker Column Unique Name ( In English)  Must be consistent across all DB Instances  ([UniqueName] will be 
--		the TABLE NAME if tracker name not found in the HFIT_Tracker table)
--Tracker Column Description (In English) (???)
--Tracker Column Data Type (e.g. Character, Numeric, Date, Bit or Yes/No)  so that we can set up the answer type
--	NULLS accepted for No Answer?	(KEY1, KEY2, VAL1, VAL2, etc)
--Tracker Active flag (IsAvailable will be null if tracker name not found in the HFIT_Tracker table)
--Tracker Unit of Measure (character) (Currently, the UOM is supplied in the view based on the table and type of Tracker)
--Tracker Insert Date ([ItemCreatedWhen])
--Tracker Last Update Date ([ItemModifiedWhen])
--NOTE: Convert all numerics to floats 7/30/2104 John/Dale
--****************************************************************************************************************************
-- 12.21.2014 - Added Select Distincts to avoid possible dups.
-- 12.23.2014 - Added the Vendor ID and Vendor name to the view via the HFit_LKP_TrackerVendor table
-- 12.25.2014 - Tested the view to see that it returned the correct VendorID description
--****************************************************************************************************************************
-- NEW ADDITIONS: 02.01.2015	Need for the updates to be completed and then we add.
--	  HFit_TrackerTobaccoAttestation
--	  HFit_TrackerPreventiveCare
--	  HFit_TrackerCotinine
--(03.20.2015) - (WDM) The DISTINCT in this qry in should eliminate duplicate rows found by John C.
--			 All worked correctly in 12.25.2014, NO changes effected since then, and unexplicably rows stated to 
--			 duplicate in three tables (tracker views) Shots, Tests, and TrackerInstance
--(03.20.2015) - WDM : HFit_TrackerInstance_Tracker has a problem that will require developer help - it is still OPEN.
--			    John C. and I looked at the issue and the LEFT join is causing a cartisian as there is no KEY 
--			    on which to join.
-- TGT (PRod1) NO DISTINCT: 
--  SELECT DISTINCT count(*) from view_EDW_TrackerCompositeDetails 00:08:36 @ 3,210,081
--- TGT (PRod1) WITH DISTINCT and Union all: 
--  SELECT DISTINCT count(*) from view_EDW_TrackerCompositeDetails 00:00:30 @ 3,210,081
--- TGT (PRod1) No DISTINCT and UNion all: 
--  SELECT DISTINCT count(*) from view_EDW_TrackerCompositeDetails 00:00:14 @ 3,218,556
--(03.21.2015) - WDM : Implemented bew code for TrackerInstance and it returns data properly now.
--(03.22.2015) - WDM : Found and corrected the Shots and Tests duplicate rows. No DUPS at this point.
--(
--****************************************************************************************************************************
--Best USE is:		(however, I do not believe Laura is allowing this view to be called in this fashion)
--SELECT * from view_EDW_TrackerCompositeDetails where EventDate between '2013-11-04 00:00:00' and '2013-11-04 23:59:59'

--Set statistics IO ON
--GO

SELECT DISTINCT
       'HFit_TrackerBloodPressure' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mm/Hg' AS UOM
     , 'Systolic' AS KEY1
     , CAST ( Systolic AS float) AS VAL1
     , 'Diastolic' AS KEY2
     , CAST ( Diastolic AS float) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'bp') AS UniqueName
     , ISNULL ( T.UniqueName , 'bp') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerBloodPressure AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBloodPressure'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBloodSugarAndGlucose' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/L' AS UOM
     , 'Units' AS KEY1
     , CAST ( Units AS float) AS VAL1
     , 'FastingState' AS KEY2
     , CAST ( FastingState AS float) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'glucose') AS UniqueName
     , ISNULL ( T.UniqueName , 'glucose') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerBloodSugarAndGlucose AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBMI' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'kg/m2' AS UOM
     , 'BMI' AS KEY1
     , CAST ( BMI AS float) AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerBMI AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBMI'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBodyFat' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'PCT' AS UOM
     , 'Value' AS KEY1
     , CAST ( [Value] AS float) AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerBodyFat AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBodyFat'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
--******************************************************************************
SELECT DISTINCT
       'HFit_TrackerBodyMeasurements' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Inch' AS UOM
     , 'WaistInches' AS KEY1
     , CAST ( WaistInches AS float) AS VAL1
     , 'HipInches' AS KEY2
     , CAST ( HipInches AS float) AS VAL2
     , 'ThighInches' AS KEY3
     , CAST ( ThighInches AS float) AS VAL3
     , 'ArmInches' AS KEY4
     , CAST ( ArmInches AS float) AS VAL4
     , 'ChestInches' AS KEY5
     , CAST ( ChestInches AS float) AS VAL5
     , 'CalfInches' AS KEY6
     , CAST ( CalfInches AS float) AS VAL6
     , 'NeckInches' AS KEY7
     , CAST ( NeckInches AS float) AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerBodyMeasurements AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
--******************************************************************************
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCardio' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'Minutes' AS KEY1
     , CAST ( Minutes AS float) AS VAL1
     , 'Distance' AS KEY2
     , CAST ( Distance AS float) AS VAL2
     , 'DistanceUnit' AS KEY3
     , CAST ( DistanceUnit AS float) AS VAL3
     , 'Intensity' AS KEY4
     , CAST ( Intensity AS float) AS VAL4
     , 'ActivityID' AS KEY5
     , CAST ( ActivityID AS float) AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerCardio AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCardio'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCholesterol' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mg/dL' AS UOM
     , 'HDL' AS KEY1
     , CAST ( HDL AS float) AS VAL1
     , 'LDL' AS KEY2
     , CAST ( LDL AS float) AS VAL2
     , 'Total' AS KEY3
     , CAST ( Total AS float) AS VAL3
     , 'Tri' AS KEY4
     , CAST ( Tri AS float) AS VAL4
     , 'Ratio' AS KEY5
     , CAST ( Ratio AS float) AS VAL5
     , 'Fasting' AS KEY6
     , CAST ( Fasting AS float) AS VAL6
     , 'VLDL' AS VLDL
     , CAST ( VLDL AS float) AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerCholesterol AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCholesterol'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerDailySteps' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Step' AS UOM
     , 'Steps' AS KEY1
     , CAST ( Steps AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerDailySteps AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerDailySteps'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFlexibility' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasStretched' AS KEY1
     , CAST ( HasStretched AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerFlexibility AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerFlexibility'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFruits' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST ( Cups AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerFruits AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerFruits'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/mol' AS UOM
     , 'Value' AS KEY1
     , CAST ( [Value] AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerHbA1c AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHbA1c'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHeight' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'inch' AS UOM
     , 'Height' AS KEY1
     , Height AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS UniqueName
     , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerHeight AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHeight'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighFatFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerHighFatFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHighFatFoods'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighSodiumFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerHighSodiumFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHighSodiumFoods'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
--w/o  distinct 00:02:07 @ 477120 PRD1
--with distinct 00:03:20 @ 475860 PRD1
--(03.20.2015) - (WDM) verified SELECT DISTINCT to this qry in order to eliminate duplicate rows found by John C.
SELECT DISTINCT 'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable ,
                     TT.ItemID ,
                     cast(EventDate as datetime) as EventDate ,
                     TT.IsProfessionallyCollected ,
                     TT.TrackerCollectionSourceID ,
                     Notes ,
                     TT.UserID ,
                     CollectionSourceName_Internal ,
                     CollectionSourceName_External ,
                     'MISSING' AS EventName ,
                     'Y/N' AS UOM ,
                     'TrackerDefID' AS KEY1 ,
                     CAST (TrackerDefID AS float) AS VAL1 ,
                     'YesNoValue' AS KEY2 ,
                     CAST (YesNoValue AS float) AS VAL2 ,
                     'NA' AS KEY3 ,
                     NULL AS VAL3 ,
                     'NA' AS KEY4 ,
                     NULL AS VAL4 ,
                     'NA' AS KEY5 ,
                     NULL AS VAL5 ,
                     'NA' AS KEY6 ,
                     NULL AS VAL6 ,
                     'NA' AS KEY7 ,
                     NULL AS VAL7 ,
                     'NA' AS KEY8 ,
                     NULL AS VAL8 ,
                     'NA' AS KEY9 ,
                     NULL AS VAL9 ,
                     'NA' AS KEY10 ,
                     NULL AS VAL10 ,
                     TT.ItemCreatedBy ,
                     cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen ,
                     TT.ItemModifiedBy ,
                     cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen ,
                     NULL AS IsProcessedForHa ,
                     'NA' AS TXTKEY1 ,
                     NULL AS TXTVAL1 ,
                     'NA' AS TXTKEY2 ,
                     NULL AS TXTVAL2 ,
                     'NA' AS TXTKEY3 ,
                     NULL AS TXTVAL3 ,
                     NULL AS ItemOrder ,
                     NULL AS ItemGuid ,
                     C.UserGuid ,
                     PP.MPI ,
                     PP.ClientCode ,
                     S.SiteGUID ,
                     ACCT.AccountID ,
                     ACCT.AccountCD ,
                     T.IsAvailable ,
                     T.IsCustom ,
                     T.UniqueName ,
                     T.UniqueName AS ColDesc ,
                     NULL AS VendorID,
                     NULL AS VendorName
          FROM dbo.HFit_TrackerInstance_Tracker AS TT
                              INNER JOIN dbo.HFit_TrackerDef_Tracker TDT     
                                  ON TDT.trackerid = TT.trackerDefID
                           INNER JOIN dbo.CMS_User AS C
                                  ON C.UserID = TT.UserID
                           INNER JOIN dbo.hfit_ppteligibility AS PP
                                  ON TT.UserID = PP.userID
                           INNER JOIN dbo.HFit_Account AS ACCT
                                  ON PP.ClientCode = ACCT.AccountCD
                           INNER JOIN dbo.CMS_Site AS S
                                  ON ACCT.SiteID = S.SiteID
                           INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                                  ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                           LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                                  ON T.AggregateTableName = 'HFit_TrackerInstance_Tracker'
                                                         AND T.uniquename = TDT.name
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST ( Portions AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerMealPortions AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerMealPortions'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FollowedPlan' AS KEY1
     , CAST ( FollowedPlan AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerMedicalCarePlan AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerMedicalCarePlan'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRegularMeals' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Units' AS KEY1
     , CAST ( Units AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerRegularMeals AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerRegularMeals'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRestingHeartRate' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'BPM' AS UOM
     , 'HeartRate' AS KEY1
     , CAST ( HeartRate AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerRestingHeartRate AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
--With DISTINCT 00:14 @ 40041
--With NO DISTINCT 00:14 @ 40060
--(03.20.2015) - (WDM) added a SELECT DISTINCT to this qry in order to eliminate duplicate rows found by John C.
SELECT DISTINCT
       'HFit_TrackerShots' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FluShot' AS KEY1
     , CAST ( FluShot AS float) AS VAL1
     , 'PneumoniaShot' AS KEY2
     , CAST ( PneumoniaShot AS float) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerShots AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerShots'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSitLess' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST ( Times AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerSitLess AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSitLess'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSleepPlan' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'HR' AS UOM
     , 'DidFollow' AS KEY1
     , CAST ( DidFollow AS float) AS VAL1
     , 'HoursSlept' AS KEY2
     , HoursSlept AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Techniques' AS TXTKEY1
     , Techniques AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerSleepPlan AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSleepPlan'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStrength' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasTrained' AS KEY1
     , CAST ( HasTrained AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerStrength AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStrength'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStress' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'Intensity' AS KEY1
     , CAST ( Intensity AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Awareness' AS TXTKEY1
     , Awareness AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerStress AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStress'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStressManagement' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'HasPracticed' AS KEY1
     , CAST ( HasPracticed AS float) AS VAL1
     , 'Effectiveness' AS KEY2
     , CAST ( Effectiveness AS float) AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerStressManagement AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStressManagement'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryDrinks' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST ( Ounces AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerSugaryDrinks AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSugaryDrinks'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST ( Portions AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerSugaryFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSugaryFoods'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
--Using DISTINCT PROD1 - 00:08:41 @ 40313
--Using DISTINCT PRD1 - 00:00:09 @ 45502
--Using NO DISTINCT PRD1 00:19 @ 40332
--Using DISTINCT PRD1 - 00:00:11 @ 44483
--(03.20.2015) - (WDM) added a SELECT DISTINCT to this qry in order to eliminate duplicate rows found by John C.
SELECT DISTINCT
       'HFit_TrackerTests' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PSATest' AS KEY1
     , CAST ( PSATest AS float) AS VAL1
     , 'OtherExam' AS KEY1
     , CAST ( OtherExam AS float) AS VAL2
     , 'TScore' AS KEY3
     , CAST ( TScore AS float) AS VAL3
     , 'DRA' AS KEY4
     , CAST ( DRA AS float) AS VAL4
     , 'CotinineTest' AS KEY5
     , CAST ( CotinineTest AS float) AS VAL5
     , 'ColoCareKit' AS KEY6
     , CAST ( ColoCareKit AS float) AS VAL6
     , 'CustomTest' AS KEY7
     , CAST ( CustomTest AS float) AS VAL7
     , 'TSH' AS KEY8
     , CAST ( TSH AS float) AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'CustomDesc' AS TXTKEY1
     , CustomDesc AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerTests AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTests'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoFree' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'WasTobaccoFree' AS KEY1
     , CAST ( WasTobaccoFree AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'QuitAids' AS TXTKEY1
     , QuitAids AS TXTVAL1
     , 'QuitMeds' AS TXTKEY2
     , QuitMeds AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerTobaccoFree AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTobaccoFree'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerVegetables' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST ( Cups AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerVegetables AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerVegetables'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWater' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST ( Ounces AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerWater AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWater'
--left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWeight' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'LBS' AS UOM
     , 'Value' AS KEY1
     , [Value] AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
       FROM
            dbo.HFit_TrackerWeight AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWeight'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWholeGrains' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-serving' AS UOM
     , 'Servings' AS KEY1
     , CAST ( Servings AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     ,
       NULL AS VendorName --VENDOR.VendorName
       FROM
            dbo.HFit_TrackerWholeGrains AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWholeGrains'
			 --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
UNION ALL

SELECT DISTINCT
       'HFit_TrackerCotinine' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'NicotineAssessment' AS KEY1
     , CAST ( NicotineAssessment AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
       FROM
            dbo.HFit_TrackerCotinine AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCotinine'
--LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.VendorID = VENDOR.ItemID;

UNION ALL
SELECT DISTINCT
       'HFit_TrackerPreventiveCare' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PreventiveCare' AS KEY1
     , CAST ( PreventiveCare AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
       FROM
            dbo.HFit_TrackerPreventiveCare AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerPreventiveCare'
--LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.VendorID = VENDOR.ItemID;
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoAttestation' AS TrackerNameAggregateTable
     , TT.ItemID
     , cast(EventDate as datetime) as EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'TobaccoAttestation' AS KEY1
     , CAST ( TobaccoAttestation AS float) AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
       FROM
            dbo.HFit_TrackerTobaccoAttestation AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTobaccoAttestation';
--LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
--	ON TT.VendorID = VENDOR.ItemID;

GO

--  
--  
GO
PRINT '***** CREATED: view_EDW_TrackerCompositeDetails.sql';
GO 

--IF EXISTS (SELECT name FROM sys.triggers where name = 'trgSchemaMonitor')    
--enable TRIGGER trgSchemaMonitor ON DATABASE;

GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1
PRINT 'Processing: view_EDW_TrackerCompositeDetails_CT ';
GO

--SELECT * from view_EDW_TrackerCompositeDetails_CT where CMS_Operation is not null

IF EXISTS ( SELECT
                   TABLE_NAME
                   FROM INFORMATION_SCHEMA.VIEWS
                   WHERE TABLE_NAME = 'view_EDW_TrackerCompositeDetails_CT') 
    BEGIN
        DROP VIEW
             view_EDW_TrackerCompositeDetails_CT;
    END;
GO

CREATE VIEW dbo.view_EDW_TrackerCompositeDetails_CT
AS SELECT DISTINCT
          'HFit_TrackerBloodPressure' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mm/Hg' AS UOM
        , 'Systolic' AS KEY1
        , CAST ( Systolic AS float) AS VAL1
        , 'Diastolic' AS KEY2
        , CAST ( Diastolic AS float) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'bp') AS UniqueName
        , ISNULL ( T.UniqueName , 'bp') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
         , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	   FROM
               dbo.HFit_TrackerBloodPressure AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerBloodPressure'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodPressure, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerBloodSugarAndGlucose' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mmol/L' AS UOM
        , 'Units' AS KEY1
        , CAST ( Units AS float) AS VAL1
        , 'FastingState' AS KEY2
        , CAST ( FastingState AS float) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'glucose') AS UniqueName
        , ISNULL ( T.UniqueName , 'glucose') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerBloodSugarAndGlucose AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodSugarAndGlucose, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerBMI' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'kg/m2' AS UOM
        , 'BMI' AS KEY1
        , CAST ( BMI AS float) AS VAL1
        , 'NA' AS KEY2
        , 0 AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerBMI AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerBMI'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBMI, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerBodyFat' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'PCT' AS UOM
        , 'Value' AS KEY1
        , CAST ( [Value] AS float) AS VAL1
        , 'NA' AS KEY2
        , 0 AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerBodyFat AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerBodyFat'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyFat, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL

   SELECT DISTINCT
          'HFit_TrackerBodyMeasurements' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Inch' AS UOM
        , 'WaistInches' AS KEY1
        , CAST ( WaistInches AS float) AS VAL1
        , 'HipInches' AS KEY2
        , CAST ( HipInches AS float) AS VAL2
        , 'ThighInches' AS KEY3
        , CAST ( ThighInches AS float) AS VAL3
        , 'ArmInches' AS KEY4
        , CAST ( ArmInches AS float) AS VAL4
        , 'ChestInches' AS KEY5
        , CAST ( ChestInches AS float) AS VAL5
        , 'CalfInches' AS KEY6
        , CAST ( CalfInches AS float) AS VAL6
        , 'NeckInches' AS KEY7
        , CAST ( NeckInches AS float) AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerBodyMeasurements AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyMeasurements, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerCardio' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'Minutes' AS KEY1
        , CAST ( Minutes AS float) AS VAL1
        , 'Distance' AS KEY2
        , CAST ( Distance AS float) AS VAL2
        , 'DistanceUnit' AS KEY3
        , CAST ( DistanceUnit AS float) AS VAL3
        , 'Intensity' AS KEY4
        , CAST ( Intensity AS float) AS VAL4
        , 'ActivityID' AS KEY5
        , CAST ( ActivityID AS float) AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerCardio AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerCardio' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCardio, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerCholesterol' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mg/dL' AS UOM
        , 'HDL' AS KEY1
        , CAST ( HDL AS float) AS VAL1
        , 'LDL' AS KEY2
        , CAST ( LDL AS float) AS VAL2
        , 'Total' AS KEY3
        , CAST ( Total AS float) AS VAL3
        , 'Tri' AS KEY4
        , CAST ( Tri AS float) AS VAL4
        , 'Ratio' AS KEY5
        , CAST ( Ratio AS float) AS VAL5
        , 'Fasting' AS KEY6
        , CAST ( Fasting AS float) AS VAL6
        , 'VLDL' AS VLDL
        , CAST ( VLDL AS float) AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerCholesterol AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerCholesterol'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCholesterol, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerDailySteps' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Step' AS UOM
        , 'Steps' AS KEY1
        , CAST ( Steps AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerDailySteps AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerDailySteps' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerDailySteps, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerFlexibility' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'HasStretched' AS KEY1
        , CAST ( HasStretched AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerFlexibility AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerFlexibility' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerFlexibility, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerFruits' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'CUP(8oz)' AS UOM
        , 'Cups' AS KEY1
        , CAST ( Cups AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerFruits AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerFruits' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerFruits, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mmol/mol' AS UOM
        , 'Value' AS KEY1
        , CAST ( [Value] AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerHbA1c AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerHbA1c'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHbA1c, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHeight' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'inch' AS UOM
        , 'Height' AS KEY1
        , Height AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerHeight AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerHeight'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHeight, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHighFatFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerHighFatFoods AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerHighFatFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHighFatFoods, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHighSodiumFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerHighSodiumFoods AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerHighSodiumFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHighSodiumFoods, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'TrackerDefID' AS KEY1
        , CAST ( TrackerDefID AS float) AS VAL1
        , 'YesNoValue' AS KEY2
        , CAST ( YesNoValue AS float) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerInstance_Tracker AS TT
                   INNER JOIN dbo.HFit_TrackerDef_Tracker AS TDT
                   ON TDT.trackerid = TT.trackerDefID
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON
          T.AggregateTableName = 'HFit_TrackerInstance_Tracker'
      AND T.uniquename = TDT.name
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerInstance_Tracker, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-portion' AS UOM
        , 'Portions' AS KEY1
        , CAST ( Portions AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerMealPortions AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerMealPortions' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerMealPortions, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'FollowedPlan' AS KEY1
        , CAST ( FollowedPlan AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerMedicalCarePlan AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerMedicalCarePlan' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerMedicalCarePlan, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerRegularMeals' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Units' AS KEY1
        , CAST ( Units AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerRegularMeals AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerRegularMeals' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerRegularMeals, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerRestingHeartRate' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'BPM' AS UOM
        , 'HeartRate' AS KEY1
        , CAST ( HeartRate AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerRestingHeartRate AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerRestingHeartRate, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerShots;' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'FluShot' AS KEY1
        , CAST ( FluShot AS float) AS VAL1
        , 'PneumoniaShot' AS KEY2
        , CAST ( PneumoniaShot AS float) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerShots AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerShots'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerShots, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSitLess' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerSitLess AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerSitLess' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerSitLess, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSleepPlan' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'HR' AS UOM
        , 'DidFollow' AS KEY1
        , CAST ( DidFollow AS float) AS VAL1
        , 'HoursSlept' AS KEY2
        , HoursSlept AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Techniques' AS TXTKEY1
        , Techniques AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerSleepPlan AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerSleepPlan' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerSleepPlan, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerStrength' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'HasTrained' AS KEY1
        , CAST ( HasTrained AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerStrength AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerStrength' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerStrength, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerStress' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'gradient' AS UOM
        , 'Intensity' AS KEY1
        , CAST ( Intensity AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Awareness' AS TXTKEY1
        , Awareness AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerStress AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerStress' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerStress, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerStressManagement' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'gradient' AS UOM
        , 'HasPracticed' AS KEY1
        , CAST ( HasPracticed AS float) AS VAL1
        , 'Effectiveness' AS KEY2
        , CAST ( Effectiveness AS float) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerStressManagement AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerStressManagement' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerStressManagement, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSugaryDrinks' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'OZ' AS UOM
        , 'Ounces' AS KEY1
        , CAST ( Ounces AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerSugaryDrinks AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerSugaryDrinks' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerSugaryDrinks, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSugaryFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-portion' AS UOM
        , 'Portions' AS KEY1
        , CAST ( Portions AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerSugaryFoods AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerSugaryFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerSugaryFoods, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerTests' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'PSATest' AS KEY1
        , CAST ( PSATest AS float) AS VAL1
        , 'OtherExam' AS KEY1
        , CAST ( OtherExam AS float) AS VAL2
        , 'TScore' AS KEY3
        , CAST ( TScore AS float) AS VAL3
        , 'DRA' AS KEY4
        , CAST ( DRA AS float) AS VAL4
        , 'CotinineTest' AS KEY5
        , CAST ( CotinineTest AS float) AS VAL5
        , 'ColoCareKit' AS KEY6
        , CAST ( ColoCareKit AS float) AS VAL6
        , 'CustomTest' AS KEY7
        , CAST ( CustomTest AS float) AS VAL7
        , 'TSH' AS KEY8
        , CAST ( TSH AS float) AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'CustomDesc' AS TXTKEY1
        , CustomDesc AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerTests AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerTests'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerTests, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerTobaccoFree' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'WasTobaccoFree' AS KEY1
        , CAST ( WasTobaccoFree AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'QuitAids' AS TXTKEY1
        , QuitAids AS TXTVAL1
        , 'QuitMeds' AS TXTKEY2
        , QuitMeds AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerTobaccoFree AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerTobaccoFree' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerTobaccoFree, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerVegetables' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'CUP(8oz)' AS UOM
        , 'Cups' AS KEY1
        , CAST ( Cups AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerVegetables AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerVegetables' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerVegetables, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerWater' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'OZ' AS UOM
        , 'Ounces' AS KEY1
        , CAST ( Ounces AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerWater AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerWater' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerWater, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerWeight' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'LBS' AS UOM
        , 'Value' AS KEY1
        , [Value] AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerWeight AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerWeight'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerWeight, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerWholeGrains' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-serving' AS UOM
        , 'Servings' AS KEY1
        , CAST ( Servings AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerWholeGrains AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerWholeGrains' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerWholeGrains, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerCotinine' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'NicotineAssessment' AS KEY1
        , CAST ( NicotineAssessment AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerCotinine AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerCotinine' --LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
               --	ON TT.VendorID = VENDOR.ItemID;
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCotinine, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerPreventiveCare' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'PreventiveCare' AS KEY1
        , CAST ( PreventiveCare AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerPreventiveCare AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerPreventiveCare' --LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
               --	ON TT.VendorID = VENDOR.ItemID;
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerPreventiveCare, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerTobaccoAttestation' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'TobaccoAttestation' AS KEY1
        , CAST ( TobaccoAttestation AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerTobaccoAttestation AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerTobaccoAttestation'
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerTobaccoAttestation, NULL) AS CT
                   ON TT.itemid = CT.itemid;

GO

--  
--  
GO
PRINT '***** FROM: view_EDW_TrackerCompositeDetails_CT.sql';
PRINT '***** CREATED view_EDW_TrackerCompositeDetails_CT ';
GO 


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Processing: view_EDW_TrackerCompositeDetails_CT_ONLY ';
GO
--SELECT * FROM HFit_TrackerCotinine
--select * from view_EDW_TrackerCompositeDetails_CT_ONLY
--select * from HFit_TrackerBMI
--select * from HFit_TrackerCholesterol
--update HFit_TrackerBMI set Notes = 'TEST CHANGE' where ItemID in (15234,15235,15236)
--update HFit_TrackerCholesterol set Notes = 'TEST CHANGE' where ItemID BETWEEN 55922 AND 55928
--update HFit_TrackerCotinine set Notes = 'TEST CHANGE' where ItemID = 3
IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
                  WHERE TABLE_NAME = 'view_EDW_TrackerCompositeDetails_CT_ONLY'
) 
    BEGIN
        DROP VIEW
             view_EDW_TrackerCompositeDetails_CT_ONLY;
    END;
GO

CREATE VIEW dbo.view_EDW_TrackerCompositeDetails_CT_ONLY
AS
--************************************************************************************************************************************
-- NOTES:
--************************************************************************************************************************************
--WDM 6/26/2014
--This view is needed by EDW in order to process the Tracker tables' data.
--As of now, the Tracker tables are representative of objects and that would cause 
--	large volumes of ETL to be devloped and maintained. 
--This view represents a columnar representation of all tracker tables in a Key/Value pair representation.
--Each tracker table to be processed into the EDW must be represented in this view.
--ALL new tracker tables need only be entered once using the structure contained within this view
--	and the same EDW ETL should be able to process it.
--If there is a change to the strucuture of any one query in this view, then all have to be modified 
--	to be support the change.
--Column TrackerNameAggregratetable (AggregateTableName) will be NULL if the Tracker is not a member 
--		of the DISPLAYED Trackers. This allows us to capture all trackers, displayed or not.

--7/29/2014
--ISSUE: HFit_TrackerBMI,  HFit_TrackerCholesterol, and HFit_TrackerHeight are not in the HFIT_Tracker
--		table. This causes T.IsAvailable, T.IsCustom, T.UniqueName to be NULL. 
--		This raises the need for the Tracker Definition Table.

--NOTE: It is a goal to keep this view using BASE tables in order to gain max performance. Nested views will 
--		be avoided here if possible.

--**************** SPECIFIC TRACKER DATA **********************
--**************** on 7/29/2014          **********************
--Tracker GUID or Unique ID across all DB Instances (ItemGuid)
--Tracker NodeID (we use it for the External ID for Audit and error Triage)  (John: can use ItemID in this case)
--Tracker Table Name or Value Group Name (e.g. Body Measurements) - Categorization (TrackerNameAggregateTable)
--Tracker Column Unique Name ( In English)  Must be consistent across all DB Instances  ([UniqueName] will be 
--		the TABLE NAME if tracker name not found in the HFIT_Tracker table)
--Tracker Column Description (In English) (???)
--Tracker Column Data Type (e.g. Character, Numeric, Date, Bit or Yes/No)  so that we can set up the answer type
--	NULLS accepted for No Answer?	(KEY1, KEY2, VAL1, VAL2, etc)
--Tracker Active flag (IsAvailable will be null if tracker name not found in the HFIT_Tracker table)
--Tracker Unit of Measure (character) (Currently, the UOM is supplied in the view based on the table and type of Tracker)
--Tracker Insert Date ([ItemCreatedWhen])
--Tracker Last Update Date ([ItemModifiedWhen])
--NOTE: Convert all numerics to floats 7/30/2104 John/Dale
--****************************************************************************************************************************
-- 12.23.2014 - Added the Vendor ID and Vendor name to the view via the HFit_LKP_TrackerVendor table
-- 12.25.2014 - Tested the view to see that it returned the correct VendorID description
--****************************************************************************************************************************
-- NEW ADDITIONS: 02.01.2015	Need for the updates to be completed and then we add.
--HFit_TrackerTobaccoAttestation
--HFit_TrackerPreventiveCare
--HFit_TrackerCotinine
--****************************************************************************************************************************
--USE:
--select * from view_EDW_TrackerCompositeDetails_CT_ONLY where EventDate between '2013-11-01 15:02:00.000' and '2013-12-01 15:02:00.000'

--Set statistics IO ON
--GO

SELECT DISTINCT
       'HFit_TrackerBloodPressure' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mm/Hg' AS UOM
     , 'Systolic' AS KEY1
     , CAST (Systolic AS float
       )AS VAL1
     , 'Diastolic' AS KEY2
     , CAST (Diastolic AS float
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'bp'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'bp'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerBloodPressure AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBloodPressure'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodPressure, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBloodSugarAndGlucose' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/L' AS UOM
     , 'Units' AS KEY1
     , CAST (Units AS float
       )AS VAL1
     , 'FastingState' AS KEY2
     , CAST (FastingState AS float
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'glucose'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'glucose'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerBloodSugarAndGlucose AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodSugarAndGlucose, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL

/*
SELECT Distinct
	  [CT].[ItemID]
  FROM CHANGETABLE (CHANGES [HFit_TrackerBMI] , NULL) AS [CT];

*/

SELECT DISTINCT
       'HFit_TrackerBMI' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'kg/m2' AS UOM
     , 'BMI' AS KEY1
     , CAST (BMI AS float
       )AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'HFit_TrackerBMI'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'HFit_TrackerBMI'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerBMI AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBMI'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerBMI, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBodyFat' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'PCT' AS UOM
     , 'Value' AS KEY1
     , CAST ([Value] AS float
       )AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'HFit_TrackerBodyFat'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'HFit_TrackerBodyFat'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerBodyFat AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBodyFat'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyFat, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
--******************************************************************************
SELECT DISTINCT
       'HFit_TrackerBodyMeasurements' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Inch' AS UOM
     , 'WaistInches' AS KEY1
     , CAST (WaistInches AS float
       )AS VAL1
     , 'HipInches' AS KEY2
     , CAST (HipInches AS float
       )AS VAL2
     , 'ThighInches' AS KEY3
     , CAST (ThighInches AS float
       )AS VAL3
     , 'ArmInches' AS KEY4
     , CAST (ArmInches AS float
       )AS VAL4
     , 'ChestInches' AS KEY5
     , CAST (ChestInches AS float
       )AS VAL5
     , 'CalfInches' AS KEY6
     , CAST (CalfInches AS float
       )AS VAL6
     , 'NeckInches' AS KEY7
     , CAST (NeckInches AS float
       )AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerBodyMeasurements AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID --******************************************************************************
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyMeasurements, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCardio' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'Minutes' AS KEY1
     , CAST (Minutes AS float
       )AS VAL1
     , 'Distance' AS KEY2
     , CAST (Distance AS float
       )AS VAL2
     , 'DistanceUnit' AS KEY3
     , CAST (DistanceUnit AS float
       )AS VAL3
     , 'Intensity' AS KEY4
     , CAST (Intensity AS float
       )AS VAL4
     , 'ActivityID' AS KEY5
     , CAST (ActivityID AS float
       )AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerCardio AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCardio' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerCardio, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCholesterol' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mg/dL' AS UOM
     , 'HDL' AS KEY1
     , CAST (HDL AS float
       )AS VAL1
     , 'LDL' AS KEY2
     , CAST (LDL AS float
       )AS VAL2
     , 'Total' AS KEY3
     , CAST (Total AS float
       )AS VAL3
     , 'Tri' AS KEY4
     , CAST (Tri AS float
       )AS VAL4
     , 'Ratio' AS KEY5
     , CAST (Ratio AS float
       )AS VAL5
     , 'Fasting' AS KEY6
     , CAST (Fasting AS float
       )AS VAL6
     , 'VLDL' AS VLDL
     , CAST (VLDL AS float
       )AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'HFit_TrackerCholesterol'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'HFit_TrackerCholesterol'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerCholesterol AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCholesterol'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerCholesterol, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerDailySteps' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Step' AS UOM
     , 'Steps' AS KEY1
     , CAST (Steps AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'HFit_TrackerDailySteps'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'HFit_TrackerDailySteps'
       )AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerDailySteps AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerDailySteps' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerDailySteps, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFlexibility' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasStretched' AS KEY1
     , CAST (HasStretched AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerFlexibility AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerFlexibility' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerFlexibility, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFruits' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST (Cups AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerFruits AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerFruits' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerFruits, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/mol' AS UOM
     , 'Value' AS KEY1
     , CAST ([Value] AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerHbA1c AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHbA1c'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerHbA1c, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHeight' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'inch' AS UOM
     , 'Height' AS KEY1
     , Height AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'HFit_TrackerHeight'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'HFit_TrackerHeight'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerHeight AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHeight'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerHeight, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighFatFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST (Times AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerHighFatFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHighFatFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerHighFatFoods, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighSodiumFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST (Times AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerHighSodiumFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHighSodiumFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerHighSodiumFoods, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'TrackerDefID' AS KEY1
     , CAST (TrackerDefID AS float
       )AS VAL1
     , 'YesNoValue' AS KEY2
     , CAST (YesNoValue AS float
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerInstance_Tracker AS TT
                INNER JOIN dbo.HFit_TrackerDef_Tracker AS TDT
                ON TDT.trackerid = TT.trackerDefID
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON
       T.AggregateTableName = 'HFit_TrackerInstance_Tracker'
   AND T.uniquename = TDT.name
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerInstance_Tracker, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST (Portions AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerMealPortions AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerMealPortions' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerMealPortions, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FollowedPlan' AS KEY1
     , CAST (FollowedPlan AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerMedicalCarePlan AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerMedicalCarePlan' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerMedicalCarePlan, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRegularMeals' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Units' AS KEY1
     , CAST (Units AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerRegularMeals AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerRegularMeals' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerRegularMeals, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRestingHeartRate' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'BPM' AS UOM
     , 'HeartRate' AS KEY1
     , CAST (HeartRate AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerRestingHeartRate AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerRestingHeartRate, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerShots' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FluShot' AS KEY1
     , CAST (FluShot AS float
       )AS VAL1
     , 'PneumoniaShot' AS KEY2
     , CAST (PneumoniaShot AS float
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerShots AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerShots'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerShots, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSitLess' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST (Times AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerSitLess AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSitLess' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerSitLess, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSleepPlan' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'HR' AS UOM
     , 'DidFollow' AS KEY1
     , CAST (DidFollow AS float
       )AS VAL1
     , 'HoursSlept' AS KEY2
     , HoursSlept AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Techniques' AS TXTKEY1
     , Techniques AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerSleepPlan AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSleepPlan' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerSleepPlan, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStrength' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasTrained' AS KEY1
     , CAST (HasTrained AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerStrength AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStrength' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerStrength, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStress' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'Intensity' AS KEY1
     , CAST (Intensity AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Awareness' AS TXTKEY1
     , Awareness AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerStress AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStress' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerStress, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStressManagement' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'HasPracticed' AS KEY1
     , CAST (HasPracticed AS float
       )AS VAL1
     , 'Effectiveness' AS KEY2
     , CAST (Effectiveness AS float
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerStressManagement AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStressManagement' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerStressManagement, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryDrinks' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST (Ounces AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerSugaryDrinks AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSugaryDrinks' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerSugaryDrinks, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST (Portions AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerSugaryFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSugaryFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerSugaryFoods, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTests' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PSATest' AS KEY1
     , CAST (PSATest AS float
       )AS VAL1
     , 'OtherExam' AS KEY1
     , CAST (OtherExam AS float
       )AS VAL2
     , 'TScore' AS KEY3
     , CAST (TScore AS float
       )AS VAL3
     , 'DRA' AS KEY4
     , CAST (DRA AS float
       )AS VAL4
     , 'CotinineTest' AS KEY5
     , CAST (CotinineTest AS float
       )AS VAL5
     , 'ColoCareKit' AS KEY6
     , CAST (ColoCareKit AS float
       )AS VAL6
     , 'CustomTest' AS KEY7
     , CAST (CustomTest AS float
       )AS VAL7
     , 'TSH' AS KEY8
     , CAST (TSH AS float
       )AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'CustomDesc' AS TXTKEY1
     , CustomDesc AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerTests AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTests'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerTests, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoFree' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'WasTobaccoFree' AS KEY1
     , CAST (WasTobaccoFree AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'QuitAids' AS TXTKEY1
     , QuitAids AS TXTVAL1
     , 'QuitMeds' AS TXTKEY2
     , QuitMeds AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerTobaccoFree AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTobaccoFree' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerTobaccoFree, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerVegetables' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST (Cups AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerVegetables AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerVegetables' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerVegetables, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWater' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST (Ounces AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerWater AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWater' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerWater, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWeight' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'LBS' AS UOM
     , 'Value' AS KEY1
     , [Value] AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerWeight AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWeight'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerWeight, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWholeGrains' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-serving' AS UOM
     , 'Servings' AS KEY1
     , CAST (Servings AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerWholeGrains AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWholeGrains' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerWholeGrains, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCotinine' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'NicotineAssessment' AS KEY1
     , CAST (NicotineAssessment AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerCotinine AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCotinine' --LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
            --	ON TT.VendorID = VENDOR.ItemID;
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerCotinine, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerPreventiveCare' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PreventiveCare' AS KEY1
     , CAST (PreventiveCare AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerPreventiveCare AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerPreventiveCare' --LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
            --	ON TT.VendorID = VENDOR.ItemID;
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerPreventiveCare, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoAttestation' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'TobaccoAttestation' AS KEY1
     , CAST (TobaccoAttestation AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerTobaccoAttestation AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTobaccoAttestation'
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerTobaccoAttestation, NULL) AS CT
                ON TT.itemid = CT.itemid;

GO

--  
--  
GO
PRINT '***** FROM: view_EDW_TrackerCompositeDetails_CT_ONLY.sql';
PRINT '***** CREATED view_EDW_TrackerCompositeDetails_CT_ONLY ';
GO 


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'From CreateJobPullEdwData.sql';
PRINT 'Creating : job_EDW_GetStagingData_HA_' + DB_NAME();
GO

/****** Object:  Job [job_EDW_GetStagingData]    Script Date: 3/28/2015 12:29:16 PM ******/

BEGIN TRANSACTION;
DECLARE
   @DB  AS nvarchar (100) = DB_NAME (),
   @JobName AS nvarchar (100) = '',
    @JNAME AS nvarchar (100) = '',
   @ReturnCode int;

SELECT
       @ReturnCode = 0;

SET @JobName = 'job_EDW_GetStagingData_HA_' + @DB;
print('CREATING Procedure ' + @JobName) ;
set @JNAME = @JobName ;
IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
	   print('UPDATING Procedure ' + @JobName) ;
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/28/2015 12:29:16 PM ******/

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JobName,
@enabled = 1,
@notify_level_eventlog = 0,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'DMiller',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [PullThedata]    Script Date: 3/28/2015 12:29:17 PM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'PullThedata',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_STAGING_EDW_HA_Changes 0 ',
@database_name = @DB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Edw Staging Data Schedule',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150328,
@active_end_date = 99991231,
@active_start_time = 0,
@active_end_time = 235959
--@schedule_uid = N'1de52534-38dc-4155-baf3-0eb7259df6c1';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

GO

PRINT 'CREATED : job_EDW_GetStagingData_HA_ ' + DB_NAME();;

GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Processing: view_EDW_HealthAssesmentClientView ';
GO

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
             WHERE TABLE_NAME = 'view_EDW_HealthAssesmentClientView') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssesmentClientView;
    END;
GO

--GRANT SELECT
--	ON [dbo].[view_EDW_HealthAssesmentClientView]
--	TO [EDWReader_PRD]
--GO

--******************************************************************************
--8/8/2014 - Generated corrected view in DEV (WDM)
--09.11.2014 (wdm) added to facilitate EDW last mod date
--02.04.2015 (wdm) #48828 added , HACampaign.BiometricCampaignStartDate, 
--		  HACampaign.BiometricCampaignEndDate, HACampaign.CampaignStartDate, 
--		  HACampaign.CampaignEndDate, HACampaign.Name, 
--		  HACampaign.NodeGuid as CampaignNodeGuid
--02.05.2015 Ashwin and I reviewed and approved
-- select top 100 * from view_EDW_HealthAssesmentClientView
--03.27.2015 ( Sowmiya V) - made changes to the view to look at the HealthAssesmentID 
--  only in the join condition.
--  The fix was needed to handle the SR#51281: Platform CampaignNodeGuid missing. 
--	   for view view_EDW_HealthAssesmentClientView
--  Leaving the old code as commented with notes. 
-- 03.13.2015 - (WDM) set the view up for change tracking - the SIMPLE version that does not 
--			 require change tracking tables to be involved.
--select count(*) from view_EDW_HealthAssesmentClientView
--SELECT * FROM   INFORMATION_SCHEMA.VIEWS WHERE  VIEW_DEFINITION like '%view_EDW_HealthAssesmentClientView%'
--******************************************************************************
CREATE VIEW dbo.view_EDW_HealthAssesmentClientView
AS SELECT 
          HFitAcct.AccountID
        , HFitAcct.AccountCD
        , HFitAcct.AccountName
        , HFitAcct.ItemGUID AS ClientGuid
        , CMSSite.SiteGUID
        , NULL AS CompanyID
        , NULL AS CompanyGUID
        , NULL AS CompanyName
        , HAJoined.DocumentName
        , cast(HACampaign.DocumentPublishFrom as datetime) AS HAStartDate
        , cast(HACampaign.DocumentPublishTo as datetime) AS HAEndDate
        , HACampaign.NodeSiteID
        , HAAssessmentMod.Title
        , HAAssessmentMod.CodeName
        , HAAssessmentMod.IsEnabled
        , CASE
              WHEN CAST (HACampaign.DocumentCreatedWhen AS date) = CAST (HACampaign.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , cast(HACampaign.DocumentCreatedWhen as datetime) as DocumentCreatedWhen
        , cast(HACampaign.DocumentModifiedWhen as datetime) as DocumentModifiedWhen
        , cast(HAAssessmentMod.DocumentModifiedWhen  as datetime) AS AssesmentModule_DocumentModifiedWhen     --09.11.2014 (wdm) added to facilitate EDW last mod date
        , HAAssessmentMod.DocumentCulture AS DocumentCulture_HAAssessmentMod
        , HACampaign.DocumentCulture AS DocumentCulture_HACampaign
        , HAJoined.DocumentCulture AS DocumentCulture_HAJoined
        , cast(HACampaign.BiometricCampaignStartDate as datetime)as BiometricCampaignStartDate
        , cast(HACampaign.BiometricCampaignEndDate as datetime)as BiometricCampaignEndDate
        , cast(HACampaign.CampaignStartDate as datetime)as CampaignStartDate
        , cast(HACampaign.CampaignEndDate as datetime)as CampaignEndDate
        , HACampaign.Name
        , HACampaign.NodeGuid AS CampaignNodeGuid
        , HACampaign.HACampaignID
          FROM
               dbo.View_HFit_HACampaign_Joined AS HACampaign
                   INNER JOIN dbo.CMS_Site AS CMSSite
                       ON HACampaign.NodeSiteID = CMSSite.SiteID
                   INNER JOIN dbo.HFit_Account AS HFitAcct
                       ON HACampaign.NodeSiteID = HFitAcct.SiteID
                   INNER JOIN dbo.View_HFit_HealthAssessment_Joined AS HAJoined
                       ON HACampaign.HealthAssessmentID = HAJoined.DocumentID      --  added line to handle    SR #51281   
                          -- ON CASE ----03.27.2015 - Commented code to release the SR #51281
                          --WHEN [HACampaign].[HealthAssessmentConfigurationID] < 0
                          --THEN [HACampaign].[HealthAssessmentID]
                          --ELSE [HACampaign].[HealthAssessmentConfigurationID]
                          --END = HAJoined.DocumentID
                      AND HAJoined.DocumentCulture = 'en-US'
                   INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS HAAssessmentMod
                       ON HAJoined.nodeid = HAAssessmentMod.NodeParentID
                      AND HAAssessmentMod.DocumentCulture = 'en-US'
     WHERE HACampaign.DocumentCulture = 'en-US';
GO

PRINT 'Created: view_EDW_HealthAssesmentClientView ';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthAssesmentClientView.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Processing: view_EDW_RewardUserDetail ';
GO

IF EXISTS (SELECT
                  NAME
                  FROM sys.VIEWS
                  WHERE NAME = 'view_EDW_RewardUserDetail') 
    BEGIN
        DROP VIEW
             view_EDW_RewardUserDetail;
    END;
GO
-- select count(*) from view_EDW_RewardUserDetail --334654
CREATE VIEW dbo.view_EDW_RewardUserDetail
AS

--**************************************************************************************************************************************************
--select * from [view_EDW_RewardUserDetail] where ItemModifiedWhen between '2000-11-14' and '2014-11-15'
--select * from [view_EDW_RewardUserDetail] where ItemModifiedWhen between '2014-05-12' and '2014-05-13' 
--8/7/2014 - added and commented out DocumentGuid and NodeGuid in case needed later
--8/08/2014 - Generated corrected view in DEV (WDM)
--8/12/2014 - Performance Issue - 00:06:49 @ 258502
--8/12/2014 - Performance Issue - Add PI01_view_EDW_RewardUserDetail
--8/12/2014 - Performance Issue - 00:03:46 @ 258502
--8/12/2014 - Performance Issue - Add PI02_view_EDW_RewardUserDetail
--8/12/2014 - Performance Issue - 00:03:45 @ 258502
--8/19/2014 - (WDM) Added where clause to make the query return english data only.	
--09.11.2014 : (wdm) Verified last mod date available to EDW - RewardsUserActivity_ItemModifiedWhen
--				RewardExceptionModifiedDate, RewardTrigger_DocumentModifiedWhen. Warned Laura this might create many dups.
--11.14.2014 : (wdm) The dups have surfaced. The combination of  HFRUAD.ActivityCompletedDt, 
--				HFRUAD.ItemModifiedWhen, HFRE.ItemModifiedWhen, HFRUAD.ItemModifiedWhen, VHFRTJ.DocumentModifiedWhen has exposed
--				tens of thousands of semi-redundant rows. Today, I commented these dates out and added a distinct and went from \
--				returning more than 100,000 rows for a given MPI and Client to 4 rows. I left in place the original dates of 
--				HFRULD.ItemCreatedWhen and HFRULD.ItemModifiedWhen. This gives us whether it is an insert or update. If multiple 
--				dates are used to determine changes, then it will be necessary to use a DATE filter to bring back only the 
--				rows indicating a change.
--11.18.2014 : (wdm) Found a USERID qualifier missing on the join of HFit_RewardsUserActivityDetail. Added this qualifier to USERID
--				and the view now appears to be functioning correctly returning about 160K rows in 2.5 minutes. The DISTINCT clause
--				made no difference in the number of returned rows, so it was removed and the execution time of the query was cut in half.
--11.18.2014 (wdm) added this filter so that only USER Detail was returned.
--01.01.2015 (WDM) added left outer join HFit_LKP_RewardActivity AND VHFRAJ.RewardActivityLKPName to the view - reference CR-47520
--01.01.2015 (WDM) Tested modifications - reference CR-47520
--02.17.2015 (WDM) and (SR) - modified the indexes and moved the where into a join to force the execution plan to modifiy itself. The 
--				view would not run in several hours since the deployment of this past Friday. Now, runs in a few minutes (less than 2).
-- 03.03.2015 Reviewed by nathan and dale and changes made as noted within.
--			ADDED THE FOLLOWING:
--				VHFRAJ.NodeGuid as RewardActivityGUID	--(03.03.2015 dale/nathan corrected)
--				VHFRPJ.DocumentGuid 	--(03.03.2015 dale/nathan corrected)
--				VHFRPJ.NodeGuid		--as RewardProgramGUID	--(03.03.2015 dale/nathan corrected)
--				VHFRGJ.NodeGuid	as RewardGroupGUID	--(03.03.2015 dale/nathan corrected)
--				VHFRTJ.NodeGuid AS RewardTriggerGUID	--(03.03.2015 dale/nathan corrected)
--03.19.2015 : by request of the EDW team, removed all columns not specificially requested
--			 and verified that was the request before initiating. The commented out columns
--			 were removed as a the solution to this request. 
--03.26.2015 : RewardGroupGUID removed per Shankar
--03.26.2015 : RewardExceptionModifiedDate Removed per Shankar
--03.26.2015 : Removed the following per Shankar  (ItemModifiedWhen/RewardExceptionModifiedDate)
--05.02.2015 : WDM - modified view for change tracking implementation (testing only)
--05.13.2015 : PUT IT BACK per discussion with Lee Allison. However, I can easily remove it again. (ItemModifiedWhen/RewardExceptionModifiedDate)
--05.13.2015 : Pulled the column from HFRUAD.ActivityCompletedDt AS RewardExceptionModifiedDate per Nathan 
--05.14.2015 : VHFRGJ.NodeGuid AS RewardGroupGUID	 --(03.03.2015 dale/nathan corrected) and removed 03.26.2015 per Shankar; put back 03.30.2015 deemed needed; removed 05.14.2015 who knows why.
--06.26.2015 : Dhaval and Dale discuss change request to view. 
--			 HFRUAD -> HFit_RewardsUserActivityDetail, we are asked to change a field (UserExceptionAppliedTo)
--			 to now point to ActivityCompletedId -> HFit_RewardsUserActivityDetail. This req made today 
--			 from Corina thru Laura. Dhaval and I CONNOT make this change without a CR. 
--			 We decided to implement as: HFRAUD.ActivityCompletedId as UserExceptionAppliedTo
--06.28.2015 : Reviewed, tested, and Passed by Corina
--07.13.2015 : #55054 raised by Corina indicates there may be data anomolies (returned number of rows) based on whether 
--			 a LEFT or INNER join is used. WDM tested the return counts on all machines using both inner and left joins.
--				288,480 with inner join   P5/P1	 @ 07.13.2015
--				288,480 with left join	 P5/P1	 @ 07.13.2015
--				372,060 with 2 left join	 P5/P1	 @ 07.13.2015
--				24,833 with inner join    P5/P2	 @ 07.13.2015
--				24,833 with left join	 P5/P2	 @ 07.13.2015
--				40,738 with 2 left join	 P5/P2	 @ 07.13.2015    
--				374,876 with inner join   P5/P3	 @ 07.13.2015
--				374,876 with left join	 P5/P3	 @ 07.13.2015
--				523,203 with 2 left join	 P5/P3	 @ 07.13.2015		  
--			 NOTE: In all instances on Prod5 and TGT, the returned row count is the same.
--08.02.2015	 Corina and Dale reviewed and tested the view DDL with corrections suggested by Corina that will cause a more 
--			 complete set of User Rewards to be returned.
--08.06.2015	 Yesterday the ciew was approved by Corina and is being scheduled for implementation tonight.
--**************************************************************************************************************************************************

SELECT DISTINCT
       cu.UserGUID
     , CS2.SiteGUID
     , cus2.HFitUserMpiNumber
     , VHFRAJ.NodeGuid AS RewardActivityGUID	--(03.03.2015 dale/nathan corrected)
     , VHFRPJ.RewardProgramName
     , CAST (VHFRPJ.DocumentModifiedWhen AS datetime) AS RewardModifiedDate

     , CAST (VHFRLJ.DocumentModifiedWhen  AS datetime) AS RewardLevelModifiedDate
     , CAST (HFRULD.LevelCompletedDt AS datetime) AS LevelCompletedDt
     , HFRUAD.ActivityPointsEarned
     , CAST (HFRUAD.ActivityCompletedDt AS datetime) AS ActivityCompletedDt
     , CAST (HFRUAD.ItemModifiedWhen  AS datetime) AS RewardActivityModifiedDate
     , VHFRAJ.ActivityPoints
     , HFRE.UserAccepted		  --Corina, please verify whether this column is needde or not
       --, HFRE.UserExceptionAppliedTo
     , HFRUAD.ActivityCompletedId AS UserExceptionAppliedTo
     , VHFRTJ.NodeGuid AS RewardTriggerGUID	--(03.03.2015 dale/nathan corrected)
     , HFA.AccountID
     , HFA.AccountCD
     , CASE
           WHEN CAST (HFRULD.ItemCreatedWhen AS date) = CAST (HFRULD.ItemModifiedWhen AS date) 
               THEN 'I'
           ELSE 'U'
       END AS ChangeType
     , CAST (HFRUAD.ActivityCompletedDt AS datetime) AS RewardExceptionModifiedDate

       FROM
           dbo.HFit_RewardsUserActivityDetail AS HFRUAD WITH (NOLOCK) 
               INNER JOIN dbo.View_HFit_RewardActivity_Joined AS VHFRAJ WITH (NOLOCK) 
                   ON VHFRAJ.NodeID = HFRUAD.ActivityNodeID
                  AND VHFRAJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardGroup_Joined AS VHFRGJ WITH (NOLOCK) 
                   ON HFRUAD.rewardgroupnodeid = VHFRGJ.NodeID
                  AND VHFRGJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardProgram_Joined AS VHFRPJ WITH (NOLOCK) 
                   ON HFRUAD.rewardprogramnodeid = VHFRPJ.NodeID
                  AND VHFRPJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardLevel_Joined AS VHFRLJ WITH (NOLOCK) 
                   ON HFRUAD.rewardlevelnodeid = VHFRLJ.NodeID
                  AND VHFRLJ.DocumentCulture = 'en-us'
               INNER JOIN dbo.CMS_User AS CU WITH (NOLOCK) 
                   ON cu.UserID = HFRUAD.userid
               INNER JOIN dbo.CMS_UserSite AS CUS WITH (NOLOCK) 
                   ON CU.UserID = CUS.UserID
               INNER JOIN dbo.CMS_Site AS CS2 WITH (NOLOCK) 
                   ON CUS.SiteID = CS2.SiteID
               INNER JOIN dbo.HFit_Account AS HFA WITH (NOLOCK) 
                   ON cs2.SiteID = HFA.SiteID
               INNER JOIN dbo.CMS_UserSettings AS CUS2 WITH (NOLOCK) 
                   ON cu.UserID = cus2.UserSettingsUserID
               LEFT JOIN dbo.HFit_RewardsUserLevelDetail AS HFRULD WITH (NOLOCK) 
                   ON HFRUAD.rewardlevelnodeid = HFRULD.LevelNodeID
                  AND HFRULD.rewardgroupnodeid = HFRUAD.rewardgroupnodeid
                  AND HFRULD.rewardprogramnodeid = HFRUAD.rewardprogramnodeid
                  AND HFRULD.userid = HFRUAD.userid
               LEFT OUTER JOIN dbo.View_HFit_RewardTrigger_Joined AS VHFRTJ WITH (NOLOCK) 
                   ON VHFRAJ.NodeID = VHFRTJ.NodeParentID
                  AND VHFRTJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.HFit_RewardException AS HFRE WITH (NOLOCK) 
                   ON HFRE.RewardActivityID = VHFRAJ.RewardActivityID
                  AND HFRE.UserID = cu.UserID
       WHERE  cus2.HFitUserMpiNumber > 0;

GO
PRINT 'Completed : view_EDW_RewardUserDetail ';
GO

/*----------------------------------------
(WDM) Kept only these columns IAW CR-51005
UserGUID
SiteGUID 
HFitUserMPINumber
RewardActivityGUID
RewardProgramName
RewardModifiedDate
RewardGroupGUID
RewardLevelModifiedDate
LevelCompletedDt
ActivityPointsEarned
ActivityCompletedDt
RewardActivityModifiedDate
ActivityPoints
UserAccepted
UserExceptionAppliedTo
RewardTriggerGUID
AccountID
AccountCD 
ChangeType
RewardExceptionModifiedDate
*/

PRINT '***** FROM: view_EDW_RewardUserDetail.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

GO

PRINT 'Processing: view_EDW_RewardUserDetail_CT ';

GO

IF EXISTS ( SELECT
                   NAME
                   FROM sys.VIEWS
                   WHERE NAME = 'view_EDW_RewardUserDetail_CT') 

    BEGIN

        DROP VIEW
             view_EDW_RewardUserDetail_CT;
    END;

GO

/*----------------------------
TABLES USED IN VIEW:
CMS_Class
CMS_Document
CMS_Site
CMS_Tree
CMS_User
CMS_UserSettings
CMS_UserSite
COM_SKU
HFit_Account
HFit_LKP_RewardActivity
HFit_LKP_RewardLevelType
HFit_LKP_RewardTrigger
HFit_LKP_RewardType
HFit_RewardActivity
HFit_RewardException
HFit_RewardGroup
HFit_RewardLevel
HFit_RewardProgram
HFit_RewardsUserActivityDetail
HFit_RewardsUserLevelDetail
HFit_RewardTrigger
*/
--**************************************************************************************************************************************************
--06.26.2015 : Dhaval and Dale discuss change request to view. 
--			 HFRUAD -> HFit_RewardsUserActivityDetail, we are asked to change a field (UserExceptionAppliedTo)
--			 to now point to ActivityCompletedId -> HFit_RewardsUserActivityDetail. This req made today 
--			 from Corina thru Laura. Dhaval and I CONNOT make this change without a CR. 
--			 We decided to implement as: HFRAUD.ActivityCompletedId as UserExceptionAppliedTo
--**************************************************************************************************************************************************
-- select top 100 LevelCompletedDt, from view_EDW_RewardUserDetail_CT

CREATE VIEW dbo.view_EDW_RewardUserDetail_CT
AS 
SELECT DISTINCT
       cu.UserGUID
     , CS2.SiteGUID
     , cus2.HFitUserMpiNumber
     , VHFRAJ.NodeGuid AS RewardActivityGUID	--(03.03.2015 dale/nathan corrected)
     , VHFRPJ.RewardProgramName
     , CAST (VHFRPJ.DocumentModifiedWhen AS datetime) AS RewardModifiedDate

     , CAST (VHFRLJ.DocumentModifiedWhen  AS datetime) AS RewardLevelModifiedDate
     , CAST (HFRULD.LevelCompletedDt AS datetime) AS LevelCompletedDt
     , HFRUAD.ActivityPointsEarned
     , CAST (HFRUAD.ActivityCompletedDt AS datetime) AS ActivityCompletedDt
     , CAST (HFRUAD.ItemModifiedWhen  AS datetime) AS RewardActivityModifiedDate
     , VHFRAJ.ActivityPoints
     , HFRE.UserAccepted		  --Corina, please verify whether this column is needde or not
       --, HFRE.UserExceptionAppliedTo
     , HFRUAD.ActivityCompletedId AS UserExceptionAppliedTo
     , VHFRTJ.NodeGuid AS RewardTriggerGUID	--(03.03.2015 dale/nathan corrected)
     , HFA.AccountID
     , HFA.AccountCD
     , CASE
           WHEN CAST (HFRULD.ItemCreatedWhen AS date) = CAST (HFRULD.ItemModifiedWhen AS date) 
               THEN 'I'
           ELSE 'U'
       END AS ChangeType
     , CAST (HFRUAD.ActivityCompletedDt AS datetime) AS RewardExceptionModifiedDate

       FROM
           dbo.HFit_RewardsUserActivityDetail AS HFRUAD WITH (NOLOCK) 
               INNER JOIN dbo.View_HFit_RewardActivity_Joined AS VHFRAJ WITH (NOLOCK) 
                   ON VHFRAJ.NodeID = HFRUAD.ActivityNodeID
                  AND VHFRAJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardGroup_Joined AS VHFRGJ WITH (NOLOCK) 
                   ON HFRUAD.rewardgroupnodeid = VHFRGJ.NodeID
                  AND VHFRGJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardProgram_Joined AS VHFRPJ WITH (NOLOCK) 
                   ON HFRUAD.rewardprogramnodeid = VHFRPJ.NodeID
                  AND VHFRPJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardLevel_Joined AS VHFRLJ WITH (NOLOCK) 
                   ON HFRUAD.rewardlevelnodeid = VHFRLJ.NodeID
                  AND VHFRLJ.DocumentCulture = 'en-us'
               INNER JOIN dbo.CMS_User AS CU WITH (NOLOCK) 
                   ON cu.UserID = HFRUAD.userid
               INNER JOIN dbo.CMS_UserSite AS CUS WITH (NOLOCK) 
                   ON CU.UserID = CUS.UserID
               INNER JOIN dbo.CMS_Site AS CS2 WITH (NOLOCK) 
                   ON CUS.SiteID = CS2.SiteID
               INNER JOIN dbo.HFit_Account AS HFA WITH (NOLOCK) 
                   ON cs2.SiteID = HFA.SiteID
               INNER JOIN dbo.CMS_UserSettings AS CUS2 WITH (NOLOCK) 
                   ON cu.UserID = cus2.UserSettingsUserID
               LEFT JOIN dbo.HFit_RewardsUserLevelDetail AS HFRULD WITH (NOLOCK) 
                   ON HFRUAD.rewardlevelnodeid = HFRULD.LevelNodeID
                  AND HFRULD.rewardgroupnodeid = HFRUAD.rewardgroupnodeid
                  AND HFRULD.rewardprogramnodeid = HFRUAD.rewardprogramnodeid
                  AND HFRULD.userid = HFRUAD.userid
               LEFT OUTER JOIN dbo.View_HFit_RewardTrigger_Joined AS VHFRTJ WITH (NOLOCK) 
                   ON VHFRAJ.NodeID = VHFRTJ.NodeParentID
                  AND VHFRTJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.HFit_RewardException AS HFRE WITH (NOLOCK) 
                   ON HFRE.RewardActivityID = VHFRAJ.RewardActivityID
                  AND HFRE.UserID = cu.UserID
       WHERE  cus2.HFitUserMpiNumber > 0;

GO

PRINT 'Completed : view_EDW_RewardUserDetail_CT ';

GO

PRINT '***** FROM: view_EDW_RewardUserDetail_CT.sql';

GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'creating proc_EDW_RewardUserDetail';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_RewardUserDetail') 
    BEGIN
        PRINT 'Replacing proc_EDW_RewardUserDetail';
        DROP PROCEDURE
             proc_EDW_RewardUserDetail;
    END;

GO

/*---------------------------------------
exec proc_EDW_RewardUserDetail 0 
exec proc_EDW_RewardUserDetail 1
*/

CREATE PROCEDURE proc_EDW_RewardUserDetail
       @Reloadall int = 0
AS
BEGIN
    --declare @Reloadall as int = 1 ; 
    SET NOCOUNT ON;

/*-------------------------------------------------
RETURNS:	  Integer -   0 = no changes
				    1 = updates or inserts, no deletes
				    2 = DELETES and possibly updates or inserts
*/
    DECLARE @iChanges AS int = 0;
    EXEC @iChanges = proc_CkRewardUserDetailHasChanged ;
    IF @iChanges = 0
        BEGIN
            PRINT 'NO Changes found for Reward USer Details, competed.';
            RETURN;
        END;

    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardUserDetail';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

    DECLARE
    @RecordID AS uniqueidentifier = NEWID () 
  , @CT_DateTimeNow AS datetime = GETDATE () 
  , @CT_NAME AS nvarchar ( 50) = 'proc_EDW_RewardUserDetail';

    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            PRINT 'RELOADING all proc_EDW_RewardUserDetail data';
            IF EXISTS ( SELECT
                               name
                               FROM sys.tables
                               WHERE name = 'DIM_EDW_RewardUserDetail') 
                BEGIN
                    DROP TABLE
                         DIM_EDW_RewardUserDetail;
                END;

            IF NOT EXISTS ( SELECT
                                   name
                                   FROM sys.tables
                                   WHERE name = 'DIM_EDW_RewardUserDetail') 
                BEGIN
                    SELECT
                           * INTO
                                  DIM_EDW_RewardUserDetail
                           FROM view_EDW_RewardUserDetail_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardUserDetail';

                    DECLARE
                    @iCnt2 AS int = @@ROWCOUNT;
                    PRINT 'Processed ' + CAST ( @iCnt2 AS nvarchar ( 50)) ;

                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt2;
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @iCnt2;
                    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @iCnt2 , 'U';

                    SET ANSI_PADDING ON;

                    CREATE CLUSTERED INDEX PI_EDW_RewardUserDetail ON dbo.
                    DIM_EDW_RewardUserDetail
                    (
                    UserGUID ASC ,
                    AccountID ASC ,
                    AccountCD ASC ,
                    SiteGUID ASC ,
                    HFitUserMpiNumber ASC ,
                    RewardActivityGUID ASC ,
                    RewardTriggerGUID ASC
                    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
                    DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                    CREATE NONCLUSTERED INDEX PI_EDW_RewardUserDetail_RowNbrCDate ON dbo.
                    DIM_EDW_RewardUserDetail
                    (
                    RowNbr , LastModifiedDate , DeletedFlg
                    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
                    DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                    PRINT 'ALL Records reloaded successfully';
                    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserDetail';

                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iCnt2;
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @iCnt2;

                    SET NOCOUNT OFF;

                    RETURN;
                END;
        END;

    PRINT 'RELOADING Changes Only';
    IF EXISTS ( SELECT
                       name
                       FROM tempdb.dbo.sysobjects
                       WHERE id = OBJECT_ID ( N'tempdb..##Temp_RewardUserDetail')) 
        BEGIN
            PRINT 'Dropping ##Temp_RewardUserDetail';
            DROP TABLE
                 ##Temp_RewardUserDetail;
        END;

if @iChanges = 1
begin
    print 'Changes and NO DELETES Found, loading only changed data.';
    SELECT
           *
    INTO
         ##Temp_RewardUserDetail
           FROM view_EDW_RewardUserDetail_CT;
end ;
if @iChanges = 2
begin
    print 'DELETES Found, loading all data for compare.';
    declare @MySql as nvarchar(2000) = 'SELECT * INTO ##Temp_RewardUserDetail FROM view_EDW_RewardUserDetail_CT ' ; 
    exec (@MySql) ;
end ;

    DECLARE
    @iCnt AS int = @@ROWCOUNT;

    ALTER TABLE ##Temp_RewardUserDetail
    ADD
                LastModifiedDate datetime2 (7) NULL;
    ALTER TABLE ##Temp_RewardUserDetail
    ADD
                RowNbr int IDENTITY ( 1 , 1) ;

    ALTER TABLE ##Temp_RewardUserDetail
    ADD
                DeletedFlg bit NULL;

    ALTER TABLE ##Temp_RewardUserDetail
    ADD
                ConvertedToCentralTime bit NULL;

    ALTER TABLE ##Temp_RewardUserDetail
    ADD
                TimeZone nvarchar (10) NULL;

    CREATE CLUSTERED INDEX PI_TEMP_EDW_RewardUserDetail ON ##Temp_RewardUserDetail
    (
    UserGUID ASC ,
    AccountID ASC ,
    AccountCD ASC ,
    SiteGUID ASC ,
    HFitUserMpiNumber ASC ,
    RewardActivityGUID ASC ,
    RewardTriggerGUID ASC
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
    DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @iCnt , 'U';
    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , @iCnt;

    --************************************************
    --get the NEW records and insert them
    --************************************************
    DECLARE
    @iIns AS int = 0;
    EXEC @iIns = proc_CT_RewardUserDetail_AddNewRecs ;
    PRINT 'INSERTED Count: ' + CAST ( @iIns AS nvarchar (50)) ;
    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iIns;

    --************************************************
    --get the changed records and update them
    --************************************************
    DECLARE
    @iUpdt AS int = 0;
    EXEC @iUpdt = proc_CT_RewardUserDetail_AddUpdatedRecs ;
    PRINT 'Records Updated: ' + CAST ( @iUpdt AS nvarchar (5)) ;
    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdt;

/*---------------------------------------------
***********************************************
    FIND DELETED ROWS
***********************************************
*/
    DECLARE
    @iDel AS int = 0;
    EXEC @iDel = proc_CT_RewardUserDetail_AddDeletedRecs ;
    PRINT 'Records Marked As Deleted: ' + CAST ( @iDel AS nvarchar (50)) ;

    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDel;
    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserDetail';

    SET NOCOUNT OFF;

END;

GO
PRINT 'Created proc_EDW_RewardUserDetail';
PRINT GETDATE () ;

--select top 100 * from DIM_EDW_RewardUserDetail

GO
PRINT 'CREATED proc_EDW_RewardUserDetail';
PRINT GETDATE () ;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
-- use KenticoCMS_Prod1

GO

PRINT ' FROM view_EDW_HealthAssesment_CT.sql';

PRINT 'Processing view_EDW_HealthAssesment_CT';

/*-------------------------------------------------------------------------------------------------------------------
*******************************************************************************************************************
SELECT count(*) FROM view_EDW_HealthAssesment_CT  WHERE [ChangeType] IS NOT NULL group by [ChangeType] ;	   --6587671
SELECT count(*) FROM view_EDW_HealthAssesment_CT  group by [ChangeType] ;
SELECT count(*) FROM view_EDW_HealthAssesment_CT WHERE [ChangeType] = 'U';    
SELECT top 100 * FROM view_EDW_HealthAssesment_CT WHERE [ChangeType] = 'U';  
*******************************************************************************************************************
*/

GO

IF NOT EXISTS ( SELECT
                       name
                       FROM sys.indexes
                       WHERE name = 'CI_HFit_HealthAssesmentUserRiskArea_HARiskCategoryItemID') 

    BEGIN

        CREATE NONCLUSTERED INDEX CI_HFit_HealthAssesmentUserRiskArea_HARiskCategoryItemID ON dbo.HFit_HealthAssesmentUserRiskArea (
        HARiskCategoryItemID) INCLUDE (
        ItemID
        , HARiskAreaScore
        , ItemModifiedWhen
        , CodeName
        , PreWeightedScore
        , HARiskAreaNodeGUID) ;
    END;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.views
                   WHERE name = 'view_EDW_HealthAssesment_CT') 

    BEGIN

        DROP VIEW
             view_EDW_HealthAssesment_CT;
    END;

GO

/*------------------------------------------------------------------------
************************************************************************
**************************************************************************
select top 100 * from [view_EDW_HealthAssesment_CT] 

select * 
into #TEMP_HA
from [view_EDW_HealthAssesment_CT] 
where CHANGED_FLG is not null

select * from #TEMP_HA

--07.09.2015 (WDM) - Dea and I discussed the need to capture and present the Health Assessment Type.
--				Mark and I discussed how best to do this and the data, basically, was already in 
--				the view. I added the field HealthAssessmentType to the view.

**************************************************************************
************************************************************************
*/
CREATE VIEW dbo.view_EDW_HealthAssesment_CT
AS SELECT
          HAUserStarted.ItemID AS UserStartedItemID
        , VHAJ.NodeGUID AS HealthAssesmentUserStartedNodeGUID
        , HAUserStarted.UserID
        , CMSUser.UserGUID
        , UserSettings.HFitUserMpiNumber
        , CMSSite.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , ACCT.AccountName
        , HAUserStarted.HAStartedDt
        , HAUserStarted.HACompletedDt
        , HAUserModule.ItemID AS UserModuleItemId
        , HAUserModule.CodeName AS UserModuleCodeName
        , HAUserModule.HAModuleNodeGUID
        , VHAJ.NodeGUID AS CMSNodeGuid
        , NULL AS HAModuleVersionID
        , HARiskCategory.ItemID AS UserRiskCategoryItemID
        , HARiskCategory.CodeName AS UserRiskCategoryCodeName
        , HARiskCategory.HARiskCategoryNodeGUID
        , NULL AS HARiskCategoryVersionID
        , HAUserRiskArea.ItemID AS UserRiskAreaItemID
        , HAUserRiskArea.CodeName AS UserRiskAreaCodeName
        , HAUserRiskArea.HARiskAreaNodeGUID
        , NULL AS HARiskAreaVersionID
        , HAUserQuestion.ItemID AS UserQuestionItemID
        , dbo.udf_StripHTML ( HAQuestionsView.Title) AS Title
        , HAUserQuestion.HAQuestionNodeGUID AS HAQuestionGuid
        , HAUserQuestion.CodeName AS UserQuestionCodeName
        , NULL AS HAQuestionDocumentID
        , NULL AS HAQuestionVersionID
        , HAUserQuestion.HAQuestionNodeGUID
        , HAUserAnswers.ItemID AS UserAnswerItemID
        , HAUserAnswers.HAAnswerNodeGUID
        , NULL AS HAAnswerVersionID
        , HAUserAnswers.CodeName AS UserAnswerCodeName
        , HAUserAnswers.HAAnswerValue
        , HAUserModule.HAModuleScore
        , HARiskCategory.HARiskCategoryScore
        , HAUserRiskArea.HARiskAreaScore
        , HAUserQuestion.HAQuestionScore
        , HAUserAnswers.HAAnswerPoints
        , HAUserQuestionGroupResults.PointResults
        , HAUserAnswers.UOMCode
        , HAUserStarted.HAScore
        , HAUserModule.PreWeightedScore AS ModulePreWeightedScore
        , HARiskCategory.PreWeightedScore AS RiskCategoryPreWeightedScore
        , HAUserRiskArea.PreWeightedScore AS RiskAreaPreWeightedScore
        , HAUserQuestion.PreWeightedScore AS QuestionPreWeightedScore
        , HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName

          --, CASE
          --	 WHEN [HAUserAnswers].[ItemCreatedWhen] = [HAUserAnswers].[ItemModifiedWhen]
          --	 THEN 'I'
          --	 ELSE 'U'
          --  END AS [ChangeType]

        , COALESCE ( CT_CMS_User.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION , CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION) AS ChangeType

        , HAUserAnswers.ItemCreatedWhen
        , HAUserAnswers.ItemModifiedWhen
        , HAUserQuestion.IsProfessionallyCollected
        , HARiskCategory.ItemModifiedWhen AS HARiskCategory_ItemModifiedWhen
        , HAUserRiskArea.ItemModifiedWhen AS HAUserRiskArea_ItemModifiedWhen
        , HAUserQuestion.ItemModifiedWhen AS HAUserQuestion_ItemModifiedWhen
        , HAUserAnswers.ItemModifiedWhen AS HAUserAnswers_ItemModifiedWhen
        , HAUserStarted.HAPaperFlg
        , HAUserStarted.HATelephonicFlg
        , HAUserStarted.HAStartedMode
        , HAUserStarted.HACompletedMode
        , VHCJ.DocumentCulture AS DocumentCulture_VHCJ
        , HAQuestionsView.DocumentCulture AS DocumentCulture_HAQuestionsView
        , HAUserStarted.HACampaignNodeGUID AS CampaignNodeGUID
        , VHCJ.HACampaignID
        , CAST ( HASHBYTES ( 'sha1' ,
          ISNULL ( CAST ( HAUserStarted.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserStarted.UserID AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSUser.UserGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( UserSettings.HFitUserMpiNumber AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSSite.SiteGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountCD AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountName AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserStarted.HAStartedDt AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACompletedDt AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserModule.ItemID  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.CodeName  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.HAModuleNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.CodeName AS nvarchar (100)) ,
          '-') + ISNULL ( CAST ( HAUserRiskArea.HARiskAreaNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemID AS nvarchar (100)) , '-') + ISNULL ( LEFT ( HAQuestionsView.Title , 1000) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserQuestion.CodeName  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.HAAnswerNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.HAAnswerValue AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.HAModuleScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryScore AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserRiskArea.HARiskAreaScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionScore AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.HAAnswerPoints AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestionGroupResults.PointResults AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserAnswers.UOMCode AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.PreWeightedScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserRiskArea.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST
          ( HAUserQuestionGroupResults.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemCreatedWhen AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.IsProfessionallyCollected AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAPaperFlg AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HATelephonicFlg AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserStarted.HAStartedMode AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACompletedMode AS nvarchar (100)) , '-') + ISNULL ( CAST
          ( HAUserStarted.HACampaignNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHCJ.HACampaignID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-')) AS varchar (100)) AS HashCode
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS varchar (50)) , '-') + ISNULL ( CAST ( UserGUID AS varchar (50)) , '-') + ISNULL ( CAST ( SiteGUID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.AccountID AS varchar (50)) , '-') + ISNULL ( CAST ( AccountCD AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserModule.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAModuleNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategoryNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategory.CodeName AS varchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskAreaNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserRiskArea.CodeName AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.CodeName AS varchar (50)) , '-') + ISNULL ( CAST ( HAQuestionNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAAnswerNodeGUID   AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserStarted.HACampaignNodeGUID AS varchar (50)) , '-')) AS varchar (100)) AS PKHashCode
        , COALESCE ( CT_CMS_User.UserID , CT_CMS_UserSettings.UserSettingsID , CT_CMS_Site.SiteID , CT_CMS_UserSite.UserSiteID , CT_HFit_Account.AccountID , CT_HFit_HealthAssesmentUserAnswers.ItemID , CT_HFit_HealthAssesmentUserModule.ItemID , CT_HFit_HealthAssesmentUserQuestion.ItemID , CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID , CT_HFit_HealthAssesmentUserRiskArea.ItemID , CT_HFit_HealthAssesmentUserRiskCategory.ItemID , CT_HFit_HealthAssesmentUserStarted.ItemID) AS CHANGED_FLG

/*---------------------------------------
***************************************
*****************************************
join changes to the records 
*****************************************
***************************************
*/

        , CT_CMS_User.UserID AS CT_CMS_User_UserID
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CT_CMS_User_CHANGE_OPERATION
        , CT_CMS_UserSettings.UserSettingsID AS CT_UserSettingsID
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CT_UserSettingsID_CHANGE_OPERATION
        , CT_CMS_Site.SiteID AS SiteID_CtID
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS SiteID_CHANGE_OPERATION
        , CT_CMS_UserSite.UserSiteID AS UserSiteID_CtID
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS UserSiteID_CHANGE_OPERATION
        , CT_HFit_Account.AccountID AS AccountID_CtID
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS AccountID__CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserAnswers.ItemID AS HAUserAnswers_CtID
        , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION AS HAUserAnswers_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserModule.ItemID AS HFit_HealthAssesmentUserModule_CtID
        , CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserQuestion.ItemID AS HFit_HealthAssesmentUserQuestion_CtID
        , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID AS HFit_HealthAssesmentUserQuestionGroupResults_CtID
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserRiskArea.ItemID AS HFit_HealthAssesmentUserRiskArea_CtID
        , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserRiskCategory.ItemID AS HFit_HealthAssesmentUserRiskCategory_CtID
        , CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserStarted.ItemID AS HFit_HealthAssesmentUserStarted_CtID
        , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserStarted_CHANGE_OPERATION

          --Get the TYPE of change ID NUMBER

        , CT_CMS_User.SYS_CHANGE_VERSION AS CT_CMS_User_SCV
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CT_CMS_UserSettings_SCV
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CT_CMS_Site_SCV
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CT_CMS_UserSite_SCV
        , CT_HFit_Account.SYS_CHANGE_VERSION AS CT_HFit_Account_SCV
        , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserAnswers_SCV
        , CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserModule_SCV
        , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserQuestion_SCV
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV
        , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserRiskArea_SCV
        , CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserRiskCategory_SCV
        , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserStarted_SCV
        , HAUserAnswers.ItemModifiedWhen AS LastModifiedDate
        , 0 AS DeleteFlg
        , CASE
              WHEN HAUserStarted.HADocumentConfigID IS NULL
                  THEN 'SHORT_VER'
              WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
                  THEN 'LONG_VER'
              ELSE 'UNKNOWN'
          END AS HealthAssessmentType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_HealthAssesmentUserStarted AS HAUserStarted
                    INNER JOIN dbo.CMS_User AS CMSUser
                    ON HAUserStarted.UserID = CMSUser.UserID
                    INNER JOIN dbo.CMS_UserSettings AS UserSettings
                    ON
                       UserSettings.UserSettingsUserID = CMSUser.UserID AND
                       HFitUserMpiNumber >= 0 AND
                       HFitUserMpiNumber IS NOT NULL
                    INNER JOIN dbo.CMS_UserSite AS UserSite
                    ON CMSUser.UserID = UserSite.UserID
                    INNER JOIN dbo.CMS_Site AS CMSSite
                    ON UserSite.SiteID = CMSSite.SiteID
                    INNER JOIN dbo.HFit_Account AS ACCT
                    ON ACCT.SiteID = CMSSite.SiteID
                    INNER JOIN dbo.HFit_HealthAssesmentUserModule AS HAUserModule
                    ON HAUserStarted.ItemID = HAUserModule.HAStartedItemID
                    INNER JOIN dbo.View_HFit_HACampaign_Joined AS VHCJ
                    ON
                       VHCJ.NodeGUID = HAUserStarted.HACampaignNodeGUID AND
                       VHCJ.NodeSiteID = UserSite.SiteID AND
                       VHCJ.DocumentCulture = 'en-US'
                    INNER JOIN dbo.View_HFit_HealthAssessment_Joined AS VHAJ
                    ON VHAJ.DocumentID = VHCJ.HealthAssessmentID
                    INNER JOIN dbo.HFit_HealthAssesmentUserRiskCategory AS HARiskCategory
                    ON HAUserModule.ItemID = HARiskCategory.HAModuleItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
                    ON HARiskCategory.ItemID = HAUserRiskArea.HARiskCategoryItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserQuestion AS HAUserQuestion
                    ON HAUserRiskArea.ItemID = HAUserQuestion.HARiskAreaItemID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS HAQuestionsView
                    ON
                       HAUserQuestion.HAQuestionNodeGUID = HAQuestionsView.NodeGUID AND
                       HAQuestionsView.DocumentCulture = 'en-US'
                    LEFT OUTER JOIN dbo.HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
                    ON HAUserRiskArea.ItemID = HAUserQuestionGroupResults.HARiskAreaItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserAnswers AS HAUserAnswers
                    ON HAUserQuestion.ItemID = HAUserAnswers.HAQuestionItemID

/*-----------------------------
*****************************
Add in the change tracking data
*****************************
*/
                    LEFT JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON UserSettings.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT JOIN CHANGETABLE (CHANGES CMS_User , NULL) AS CT_CMS_User
                    ON CMSUser.UserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CMSSite.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON UserSite.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON ACCT.AccountID = CT_HFit_Account.AccountID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HACampaign , NULL) AS CT_HFit_HACampaign
                    ON VHCJ.HACampaignID = CT_HFit_HACampaign.HACampaignID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserAnswers , NULL) AS CT_HFit_HealthAssesmentUserAnswers
                    ON HAUserAnswers.ItemID = CT_HFit_HealthAssesmentUserAnswers.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserModule , NULL) AS CT_HFit_HealthAssesmentUserModule
                    ON HAUserModule.ItemID = CT_HFit_HealthAssesmentUserModule.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestion , NULL) AS CT_HFit_HealthAssesmentUserQuestion
                    ON HAUserQuestion.ItemID = CT_HFit_HealthAssesmentUserQuestion.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults , NULL) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                    ON HAUserQuestionGroupResults.ItemID = CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea , NULL) AS CT_HFit_HealthAssesmentUserRiskArea
                    ON HAUserRiskArea.ItemID = CT_HFit_HealthAssesmentUserRiskArea.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskCategory , NULL) AS CT_HFit_HealthAssesmentUserRiskCategory
                    ON HARiskCategory.ItemID = CT_HFit_HealthAssesmentUserRiskCategory.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted , NULL) AS CT_HFit_HealthAssesmentUserStarted
                    ON HAUserStarted.ItemID = CT_HFit_HealthAssesmentUserStarted.ItemID
          WHERE UserSettings.HFitUserMpiNumber NOT IN (
          SELECT
                 RejectMPICode
                 FROM HFit_LKP_EDW_RejectMPI) ;
GO

PRINT 'Processed view_EDW_HealthAssesment_CT';

GO

PRINT ' FROM view_EDW_HealthAssesment_CT.sql';

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1


GO
PRINT 'Processing: view_EDW_HealthAssessmentDefinition_CT ' + CAST (GETDATE () AS nvarchar (50)) ;
GO

/*
select count(*), HashCode 
from view_EDW_HealthAssessmentDefinition_CT
group by HashCode 
having count(*) > 1

select * from view_EDW_HealthAssessmentDefinition_CT
select top 100 lastModifiedDate,* from view_EDW_HealthAssessmentDefinition_CT
select count(*) from view_EDW_HealthAssessmentDefinition_CT
select count(*) from view_EDW_HealthAssessmentDefinition_CT
--RCDocPubVerID
Select * from HFit_HealthAssesmentMultipleChoiceQuestion where HealthAssesmentMultipleChoiceQuestionID = 495
update HFit_HealthAssesmentMultipleChoiceQuestion set AllowMultiSelect = -1  where HealthAssesmentMultipleChoiceQuestionID = 495
update HFit_HealthAssesmentMultipleChoiceQuestion set AllowMultiSelect = 0  where HealthAssesmentMultipleChoiceQuestionID = 495

select * 
into STAGED_EDW_HealthAssessmentDefinition
from view_EDW_HealthAssessmentDefinition_CT
where
CHANGED_FLG IS NOT NULL

PK: SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID

select count(*) SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID 
from view_EDW_HealthAssessmentDefinition_CT
group by SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID
having count(*)  >1

*/

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
             WHERE TABLE_NAME = 'view_EDW_HealthAssessmentDefinition_CT') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessmentDefinition_CT;
    END;
GO

/*
select * 
into Staging_EDW_HealthAssesmentDeffinition
from view_EDW_HealthAssessmentDefinition_CT
select * from Staging_EDW_HealthAssesmentDeffinition
*/

--**************************************************************************************************************
--NOTE: The column DocumentModifiedWhen comes from the CMS_TREE join - it was left 
--		unchanged when other dates added for the Last Mod Date additions. 
--		Therefore, the 'ChangeType' was left dependent upon this date only. 09.12.2014 (wdm)
--*****************************************************************************************************************************************************
--Test Queries:
--select * from view_EDW_HealthAssessmentDefinition_CT where AnsDocumentGuid is not NULL
--Changes:
--WDM - 6/25/2014
--Query was returning a NULL dataset. Found that it is being caused by the AccountCD join.
--Worked with Shane to discover the CMS Tree had been modified.
--Modified the code so that reads it reads the CMS tree correctly - working.
--7/14/2014 1:29 time to run - 79024 rows - DEV
--7/14/2014 0:58 time to run - 57472 rows - PROD1
--7/15/2014 - Query was returning NodeName of 'Campaigns' only
--	Found the issue in view View_HFit_HACampaign_Joined. Documented the change in the view.
--7/16/2014 - Full Select: Using a DocumentModifiedWhen filter 00:17:28 - Record Cnt: 793,520
--8/7/2014 - Executed in DEV with GUID changes and returned 1.13M Rows in 23:14.
--8/8/2014 - Executed in DEV with GUID changes, new views, and returned 1.13M Rows in 20:16.
--8/8/2014 - Generated corrected view in DEV
--8/12/2014 - John C. explained that Account Code and Site Guid are not needed, NULLED
--				them out. With them in the QRY, returned 43104 rows, with them nulled
--				out, returned 43104 rows. Using a DISTINCT, 28736 rows returned and execution
--				time doubled approximately.
--				Has to add a DISTINCT to all the queries - .
--				Original Query 0:25 @ 43104
--				Original Query 0:46 @ 28736 (distinct)
--				Filter added - VHFHAQ.DocumentCulture 0:22 @ 14368
--				Filter added - and VHFHARCJ.DocumentCulture = 'en-us'	 0:06 @ 3568
--				Filter added - and VHFHARAJ.DocumentCulture = 'en-us'	 0:03 @ 1784
--8/12/2014 - Applied the language filters with John C. and performance improved, as expected,
--				such that when running the view in QA: 
--8/12/2014 - select * from [view_EDW_HealthAssessmentDefinition_CT] where DocumentModifiedWhen between '2000-11-14' and 
--				'2014-11-15' now runs exceptionally fast
--08/12/2014 - ProdStaging 00:21:52 @ 2442
--08/12/2014 - ProdStaging 00:21:09 @ 13272 (UNION ALL   --UNION)
--08/12/2014 - ProdStaging 00:21:37 @ 13272 (UNION ONLY)
--08/12/2014 - ProdStaging 00:06:26 @ 1582 (UNION ONLY & Select Filters Added for Culture)
--08/12/2014 - ProdStaging 00:10:07 @ 6636 (UNION ALL   --UNION) and all selected
--08/12/2014 - ProdStaging added PI PI_View_CMS_Tree_Joined_Regular_DocumentCulture: 00:2:34 @ 6636 
--08/12/2014 - DEV 00:00:58 @ 3792
--09.11.2014 - (wdm) added the needed date fields to help EDW in determining the last mod date of a row.
--10.01.2014 - Dale and Mark reworked this view to use NodeGUIDS and eliminated the CMS_TREE View from participating as 
--				well as Site and Account data
--11.25.2014 - (wdm) added multi-select column capability. The values can be 0,1, NULL
--12.29.2014 - (wdm) Added HTML stripping to two columns #47619, the others mentioned already had stripping applied
--12.31.2014 - (wdm) Started the review to apply CR-47517: Eliminate Matrix Questions with NULL Answer GUID's
--01.07.2014 - (wdm) 47619 The Health Assessment Definition interface view contains HTML tags - corrected with udf_StripHTML
--************************************************************************************************************************************************************
CREATE VIEW dbo.view_EDW_HealthAssessmentDefinition_CT
AS SELECT DISTINCT

          NULL AS SiteGUID --cs.SiteGUID								--WDM 08.12.2014 per John C.
        , NULL AS AccountCD	 --, HFA.AccountCD						--WDM 08.07.2014 per John C.
        , HA.NodeID AS HANodeID										--WDM 08.07.2014
        , HA.NodeName AS HANodeName									--WDM 08.07.2014
          --, HA.DocumentID AS HADocumentID								--WDM 08.07.2014 commented out and left in place for history
        , NULL AS HADocumentID										--WDM 08.07.2014; 09.29.2014: Mark and Dale discussed that NODEGUID should be used such that the multi-language/culture is not a problem.
        , HA.NodeSiteID AS HANodeSiteID								--WDM 08.07.2014
        , HA.DocumentPublishedVersionHistoryID AS HADocPubVerID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) AS ModTitle              --WDM 47619
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText              --WDM 47619
        , VHFHAMJ.NodeGuid AS ModDocGuid	--, VHFHAMJ.DocumentID AS ModDocID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHAMJ.Weight AS ModWeight
        , VHFHAMJ.IsEnabled AS ModIsEnabled
        , VHFHAMJ.CodeName AS ModCodeName
        , VHFHAMJ.DocumentPublishedVersionHistoryID AS ModDocPubVerID
        , dbo.udf_StripHTML (VHFHARCJ.Title) AS RCTitle              --WDM 47619
        , VHFHARCJ.Weight AS RCWeight
        , VHFHARCJ.NodeGuid AS RCDocumentGUID	--, VHFHARCJ.DocumentID AS RCDocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHARCJ.IsEnabled AS RCIsEnabled
        , VHFHARCJ.CodeName AS RCCodeName
        , VHFHARCJ.DocumentPublishedVersionHistoryID AS RCDocPubVerID
        , dbo.udf_StripHTML (VHFHARAJ.Title) AS RATytle              --WDM 47619
        , VHFHARAJ.Weight AS RAWeight
        , VHFHARAJ.NodeGuid AS RADocumentGuid	--, VHFHARAJ.DocumentID AS RADocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHARAJ.IsEnabled AS RAIsEnabled
        , VHFHARAJ.CodeName AS RACodeName
        , VHFHARAJ.ScoringStrategyID AS RAScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID AS RADocPubVerID
        , VHFHAQ.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ.Title, 4000)) AS QuesTitle              --WDM 47619
        , VHFHAQ.Weight AS QuesWeight
        , VHFHAQ.IsRequired AS QuesIsRequired

          --, VHFHAQ.DocumentGuid AS QuesDocumentGuid	--, VHFHAQ.DocumentID AS QuesDocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHAQ.NodeGuid AS QuesDocumentGuid	--, VHFHAQ.DocumentID AS QuesDocumentID	--WDM 08.07.2014

        , VHFHAQ.IsEnabled AS QuesIsEnabled
        , LEFT (VHFHAQ.IsVisible, 4000) AS QuesIsVisible
        , VHFHAQ.IsStaging AS QuesIsSTaging
        , VHFHAQ.CodeName AS QuestionCodeName
        , VHFHAQ.DocumentPublishedVersionHistoryID AS QuesDocPubVerID
        , VHFHAA.Value AS AnsValue
        , VHFHAA.Points AS AnsPoints
        , VHFHAA.NodeGuid AS AnsDocumentGuid		--ref: #47517
        , VHFHAA.IsEnabled AS AnsIsEnabled
        , VHFHAA.CodeName AS AnsCodeName
        , VHFHAA.UOM AS AnsUOM
        , VHFHAA.DocumentPublishedVersionHistoryID AS AnsDocPUbVerID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014 ADDED TO the returned Columns
        , HA.NodeGUID AS HANodeGUID
          --, NULL as SiteLastModified
        , NULL AS SiteLastModified
          --, NULL as Account_ItemModifiedWhen
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID01' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ.CodeName, '-') + ISNULL (CAST (VHFHAQ.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA.CodeName , '-') + ISNULL (CAST (VHFHAA.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID01' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ.IsVisible, 1000) , '-') 
          ) AS HashCode

          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US'

/*
		  --** ADD THE CHANGE TRACKING Tables
		  */

                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHARAJ.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'		--WDM 08.12.2014	
       AND VHFHAA.NodeGuid IS NOT NULL		--ref: #47517

   UNION ALL   --UNION
   --WDM Retrieve Matrix Level 1 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title)              --WDM 47619
        , dbo.udf_StripHTML (LEFT (LEFT (VHFHAMJ.IntroText, 4000) , 4000)) AS IntroText              --WDM 47619
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title)              --WDM 47619
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title)              --WDM 47619
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ2.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ2.Title, 4000)) AS QuesTitle              --WDM 47619
        , VHFHAQ2.Weight
        , VHFHAQ2.IsRequired
        , VHFHAQ2.NodeGuid
        , VHFHAQ2.IsEnabled
        , LEFT (VHFHAQ2.IsVisible, 4000) 
        , VHFHAQ2.IsStaging
        , VHFHAQ2.CodeName AS QuestionCodeName
          --,VHFHAQ2.NodeAliasPath
        , VHFHAQ2.DocumentPublishedVersionHistoryID
        , VHFHAA2.Value
        , VHFHAA2.Points
        , VHFHAA2.NodeGuid		--ref: #47517
        , VHFHAA2.IsEnabled
        , VHFHAA2.CodeName
        , VHFHAA2.UOM
          --,VHFHAA2.NodeAliasPath
        , VHFHAA2.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID02' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ2.CodeName, '-') + ISNULL (CAST (VHFHAQ2.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA2.CodeName , '-') + ISNULL (CAST (VHFHAA2.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID02' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ2.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ2.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2
                      ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2
                      ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA2.NodeGuid IS NOT NULL		--ref: #47517

   UNION ALL   --UNION
   --WDM Retrieve Branching Level 1 Question and Matrix Level 1 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ3.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ3.Title, 4000)) AS QuesTitle
        , VHFHAQ3.Weight
        , VHFHAQ3.IsRequired
        , VHFHAQ3.NodeGuid
        , VHFHAQ3.IsEnabled
        , LEFT (VHFHAQ3.IsVisible, 4000) 
        , VHFHAQ3.IsStaging
        , VHFHAQ3.CodeName AS QuestionCodeName
          --,VHFHAQ3.NodeAliasPath
        , VHFHAQ3.DocumentPublishedVersionHistoryID
        , VHFHAA3.Value
        , VHFHAA3.Points
        , VHFHAA3.NodeGuid		--ref: #47517
        , VHFHAA3.IsEnabled
        , VHFHAA3.CodeName
        , VHFHAA3.UOM
          --,VHFHAA3.NodeAliasPath
        , VHFHAA3.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID03' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ3.CodeName, '-') + ISNULL (CAST (VHFHAQ3.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA3.CodeName , '-') + ISNULL (CAST (VHFHAA3.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID03' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ3.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ3.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA3.NodeGuid IS NOT NULL		--ref: #47517
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM Retrieve Branching Level 1 Question and Matrix Level 2 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ7.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ7.Title, 4000)) AS QuesTitle
        , VHFHAQ7.Weight
        , VHFHAQ7.IsRequired
        , VHFHAQ7.NodeGuid
        , VHFHAQ7.IsEnabled
        , LEFT (VHFHAQ7.IsVisible, 4000) 
        , VHFHAQ7.IsStaging
        , VHFHAQ7.CodeName AS QuestionCodeName
          --,VHFHAQ7.NodeAliasPath
        , VHFHAQ7.DocumentPublishedVersionHistoryID
        , VHFHAA7.Value
        , VHFHAA7.Points
        , VHFHAA7.NodeGuid		--ref: #47517
        , VHFHAA7.IsEnabled
        , VHFHAA7.CodeName
        , VHFHAA7.UOM
          --,VHFHAA7.NodeAliasPath
        , VHFHAA7.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID04' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ7.CodeName, '-') + ISNULL (CAST (VHFHAQ7.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA7.CodeName , '-') + ISNULL (CAST (VHFHAA7.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID04' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ7.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ7.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID --LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3 ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID

              --Matrix Level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7
                      ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7
                      ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA7.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************

   UNION ALL   --UNION
   --****************************************************
   --WDM 6/25/2014 Retrieve the Branching level 1 Question Group
   --THE PROBLEM LIES HERE in this part of query : 1:40 minute
   -- Added two perf indexes to the first query: 25 Sec
   --****************************************************
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ8.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ8.Title, 4000)) AS QuesTitle
        , VHFHAQ8.Weight
        , VHFHAQ8.IsRequired
        , VHFHAQ8.NodeGuid
        , VHFHAQ8.IsEnabled
        , LEFT (VHFHAQ8.IsVisible, 4000) 
        , VHFHAQ8.IsStaging
        , VHFHAQ8.CodeName AS QuestionCodeName
          --,VHFHAQ8.NodeAliasPath
        , VHFHAQ8.DocumentPublishedVersionHistoryID
        , VHFHAA8.Value
        , VHFHAA8.Points
        , VHFHAA8.NodeGuid		--ref: #47517
        , VHFHAA8.IsEnabled
        , VHFHAA8.CodeName
        , VHFHAA8.UOM
          --,VHFHAA8.NodeAliasPath
        , VHFHAA8.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID05' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ8.CodeName, '-') + ISNULL (CAST (VHFHAQ8.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA8.CodeName , '-') + ISNULL (CAST (VHFHAA8.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID05' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ8.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ8.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************	

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID --LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3 ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID

              --Matrix Level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7
                      ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7
                      ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID --Matrix branching level 1 question group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8
                      ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8
                      ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA8.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************

   UNION ALL   --UNION
   --****************************************************
   --WDM 6/25/2014 Retrieve the Branching level 2 Question Group
   --THE PROBLEM LIES HERE in this part of query : 1:48  minutes
   --With the new indexes: 29 Secs
   --****************************************************
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ4.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ4.Title, 4000)) AS QuesTitle
        , VHFHAQ4.Weight
        , VHFHAQ4.IsRequired
        , VHFHAQ4.NodeGuid
        , VHFHAQ4.IsEnabled
        , LEFT (VHFHAQ4.IsVisible, 4000) 
        , VHFHAQ4.IsStaging
        , VHFHAQ4.CodeName AS QuestionCodeName
          --,VHFHAQ4.NodeAliasPath
        , VHFHAQ4.DocumentPublishedVersionHistoryID
        , VHFHAA4.Value
        , VHFHAA4.Points
        , VHFHAA4.NodeGuid		--ref: #47517
        , VHFHAA4.IsEnabled
        , VHFHAA4.CodeName
        , VHFHAA4.UOM
          --,VHFHAA4.NodeAliasPath
        , VHFHAA4.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID06' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ4.CodeName, '-') + ISNULL (CAST (VHFHAQ4.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA4.CodeName , '-') + ISNULL (CAST (VHFHAA4.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID06' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ4.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ4.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA4.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 3 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ5.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ5.Title, 4000)) AS QuesTitle
        , VHFHAQ5.Weight
        , VHFHAQ5.IsRequired
        , VHFHAQ5.NodeGuid
        , VHFHAQ5.IsEnabled
        , LEFT (VHFHAQ5.IsVisible, 4000) 
        , VHFHAQ5.IsStaging
        , VHFHAQ5.CodeName AS QuestionCodeName
          --,VHFHAQ5.NodeAliasPath
        , VHFHAQ5.DocumentPublishedVersionHistoryID
        , VHFHAA5.Value
        , VHFHAA5.Points
        , VHFHAA5.NodeGuid		--ref: #47517
        , VHFHAA5.IsEnabled
        , VHFHAA5.CodeName
        , VHFHAA5.UOM
          --,VHFHAA5.NodeAliasPath
        , VHFHAA5.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID07' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ5.CodeName, '-') + ISNULL (CAST (VHFHAQ5.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA5.CodeName , '-') + ISNULL (CAST (VHFHAA5.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID07' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ5.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ5.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA5.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 4 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ6.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ6.Title, 4000)) AS QuesTitle
        , VHFHAQ6.Weight
        , VHFHAQ6.IsRequired
        , VHFHAQ6.NodeGuid
        , VHFHAQ6.IsEnabled
        , LEFT (VHFHAQ6.IsVisible, 4000) 
        , VHFHAQ6.IsStaging
        , VHFHAQ6.CodeName AS QuestionCodeName
          --,VHFHAQ6.NodeAliasPath
        , VHFHAQ6.DocumentPublishedVersionHistoryID
        , VHFHAA6.Value
        , VHFHAA6.Points
        , VHFHAA6.NodeGuid		--ref: #47517
        , VHFHAA6.IsEnabled
        , VHFHAA6.CodeName
        , VHFHAA6.UOM
          --,VHFHAA6.NodeAliasPath
        , VHFHAA6.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID08' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ6.CodeName, '-') + ISNULL (CAST (VHFHAQ6.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA6.CodeName , '-') + ISNULL (CAST (VHFHAA6.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID08' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ6.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ6.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
              --select count(*) from dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID --Branching level 4 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ6
                      ON VHFHAA5.NodeID = VHFHAQ6.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA6
                      ON VHFHAQ6.NodeID = VHFHAA6.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE  VHFHAQ.DocumentCulture = 'en-us'
        AND (VHFHAA.DocumentCulture = 'en-us'
          OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
        AND VHFHARCJ.DocumentCulture = 'en-us'
        AND VHFHARAJ.DocumentCulture = 'en-us'
        AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
        AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
        AND VHFHAA6.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 5 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ9.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ9.Title, 4000)) AS QuesTitle
        , VHFHAQ9.Weight
        , VHFHAQ9.IsRequired
        , VHFHAQ9.NodeGuid
        , VHFHAQ9.IsEnabled
        , LEFT (VHFHAQ9.IsVisible, 4000) 
        , VHFHAQ9.IsStaging
        , VHFHAQ9.CodeName AS QuestionCodeName
          --,VHFHAQ9.NodeAliasPath
        , VHFHAQ9.DocumentPublishedVersionHistoryID
        , VHFHAA9.Value
        , VHFHAA9.Points
        , VHFHAA9.NodeGuid		--ref: #47517
        , VHFHAA9.IsEnabled
        , VHFHAA9.CodeName
        , VHFHAA9.UOM
          --,VHFHAA9.NodeAliasPath
        , VHFHAA9.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID09' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ.CodeName, '-') + ISNULL (CAST (VHFHAQ.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA.CodeName , '-') + ISNULL (CAST (VHFHAA.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID09' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
              --select count(*) from dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID --Branching level 4 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ6
                      ON VHFHAA5.NodeID = VHFHAQ6.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA6
                      ON VHFHAQ6.NodeID = VHFHAA6.NodeParentID --Branching level 5 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ9
                      ON VHFHAA6.NodeID = VHFHAQ9.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA9
                      ON VHFHAQ9.NodeID = VHFHAA9.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE  VHFHAQ.DocumentCulture = 'en-us'
        AND (VHFHAA.DocumentCulture = 'en-us'
          OR VHFHAA.DocumentCulture IS NULL) 
        AND VHFHARCJ.DocumentCulture = 'en-us'
        AND VHFHARAJ.DocumentCulture = 'en-us'
        AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
        AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
        AND VHFHAA9.NodeGuid IS NOT NULL;		--ref: #47517
--********************************************
--AND (
--    CT_CMS_Class.ClassID IS NOT NULL
-- OR CT_CMS_Document.DocumentID IS NOT NULL
-- OR CT_CMS_Site.SiteID IS NOT NULL
-- OR CT_CMS_Tree.NodeID IS NOT NULL
-- OR CT_CMS_User.UserID IS NOT NULL
-- OR CT_COM_SKU.SKUID IS NOT NULL
-- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
-- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
-- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
-- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
-- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
-- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
-- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
-- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
--    );

GO

PRINT 'Processed: view_EDW_HealthAssessmentDefinition_CT ';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthAssessmentDefinition_CT.sql';
GO

--select * 
--into STAGED_EDW_HealthAssessmentDefinition
--from view_EDW_HealthAssessmentDefinition_CT
--go--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1


GO 
print('***** FROM: view_EDW_HealthInterestDetail_CT.sql'); 
GO 
print ('Creating view_EDW_HealthInterestDetail_CT');
GO
--select count(*) from view_EDW_HealthInterestDetail
--select TOP 100 * from view_EDW_HealthInterestDetail_CT order by HashCode
if exists(select name from sys.views where name = 'view_EDW_HealthInterestDetail_CT')
BEGIN 
	drop view view_EDW_HealthInterestDetail_CT ;
END
go

/*  {Potential Natural Key}
select count(*), UserID,UserGUID,HFitUserMpiNumber,SiteGUID,CoachingHealthInterestID,FirstNodeID,SecondNodeGuid,ThirdNodeGuid
from 
view_EDW_HealthInterestDetail_CT
group by UserID,UserGUID,HFitUserMpiNumber,SiteGUID,CoachingHealthInterestID,FirstNodeID,SecondNodeGuid,ThirdNodeGuid
having Count(*) > 1
*/


CREATE VIEW [dbo].[view_EDW_HealthInterestDetail_CT]
AS
	SELECT
		HI.UserID
		,U.UserGUID
		,US.HFitUserMpiNumber
		,S.SiteGUID
		,HI.CoachingHealthInterestID

		,HA1.CoachingHealthAreaID AS FirstHealthAreaID
		,HA1.NodeID AS FirstNodeID
		,HA1.NodeGuid AS FirstNodeGuid
		,HA1.DocumentName AS FirstHealthAreaName
		,HA1.HealthAreaDescription AS FirstHealthAreaDescription
		,HA1.CodeName AS FirstCodeName
	
		,HA2.CoachingHealthAreaID AS SecondHealthAreaID
		,HA2.NodeID AS SecondNodeID
		,HA2.NodeGuid AS SecondNodeGuid
		,HA2.DocumentName AS SecondHealthAreaName
		,HA2.HealthAreaDescription AS SecondHealthAreaDescription
		,HA2.CodeName AS SecondCodeName
	
		,HA3.CoachingHealthAreaID AS ThirdHealthAreaID
		,HA3.NodeID AS ThirdNodeID
		,HA3.NodeGuid AS ThirdNodeGuid
		,HA3.DocumentName AS ThirdHealthAreaName
		,HA3.HealthAreaDescription AS ThirdHealthAreaDescription
		,HA3.CodeName AS ThirdCodeName

		,HI.ItemCreatedWhen
		,HI.ItemModifiedWhen
		,coalesce(HI.IsDeleted,0) as IsDeleted
		, HASHBYTES ('sha1',
				    isNull(HA1.DocumentName,'-')
				    + isNull(left(HA1.HealthAreaDescription,1000),'-')
				    + isNull(HA1.CodeName,'-')
				    + isNull(HA2.DocumentName,'-')
				    + isNull(left(HA2.HealthAreaDescription,1000),'-')
				    + isNull(HA2.CodeName,'-')
				    + isNull(HA3.DocumentName,'-')
				    + isNull(left(HA3.HealthAreaDescription,1000),'-')
				    + isNull(HA3.CodeName,'-')
		  ) as HashCode		  
	, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
		HFit_CoachingHealthInterest AS HI
		JOIN CMS_User AS U ON HI.UserID = U.UserID
		JOIN CMS_UserSettings AS US ON HI.UserID = US.UserSettingsUserID
		JOIN CMS_UserSite AS US1 ON HI.UserID = US1.UserID
		JOIN CMS_Site AS S ON US1.SiteID = S.SiteID	 --Used only to find SiteGuid
		LEFT JOIN View_HFit_CoachingHealthArea_Joined AS HA1 ON HI.FirstInterest = HA1.NodeID
			AND HA1.DocumentCulture = 'en-us'
		LEFT JOIN View_HFit_CoachingHealthArea_Joined AS HA2 ON HI.SecondInterest = HA2.NodeID	
			AND HA2.DocumentCulture = 'en-us'
		LEFT JOIN View_HFit_CoachingHealthArea_Joined AS HA3 ON HI.ThirdInterest = HA3.NodeID
			AND HA3.DocumentCulture = 'en-us'
GO

print ('Created view_EDW_HealthInterestDetail_CT');
GO


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




GO
PRINT 'Creating view_EDW_HealthInterestDetail_STAGED';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE name = 'view_EDW_HealthInterestDetail_STAGED') 
    BEGIN
        DROP VIEW
             view_EDW_HealthInterestDetail_STAGED;
    END;
GO

/*
STAGING_EDW_HealthInterestDetail
select count(*) from view_EDW_HealthInterestDetail_STAGED

select count(*),  HealthAreaID
		,NodeID
		,NodeGuid
		,AccountCD
from view_EDW_HealthInterestDetail_STAGED
group by HealthAreaID
		,NodeID
		,NodeGuid
		,AccountCD
having count(*) > 1
*/

CREATE VIEW dbo.view_EDW_HealthInterestDetail_STAGED
AS SELECT
          UserID
        , UserGUID
        , HFitUserMpiNumber
        , SiteGUID
        , CoachingHealthInterestID
        , FirstHealthAreaID
        , FirstNodeID
        , FirstNodeGuid
        , FirstHealthAreaName
        , FirstHealthAreaDescription
        , FirstCodeName
        , SecondHealthAreaID
        , SecondNodeID
        , SecondNodeGuid
        , SecondHealthAreaName
        , SecondHealthAreaDescription
        , SecondCodeName
        , ThirdHealthAreaID
        , ThirdNodeID
        , ThirdNodeGuid
        , ThirdHealthAreaName
        , ThirdHealthAreaDescription
        , ThirdCodeName
        , ItemCreatedWhen
        , ItemModifiedWhen
          FROM STAGING_EDW_HealthInterestDetail;

GO
PRINT 'Created view_EDW_HealthInterestDetail_STAGED';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthInterestDetail_STAGED.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO

/*---------------------------------------------------------------------------------------------------------------------------
{Potential Natural Key}
select count(*), UserID,UserGUID,HFitUserMpiNumber,SiteGUID,CoachingHealthInterestID,FirstNodeID,SecondNodeGuid,ThirdNodeGuid
from 
view_EDW_HealthInterestDetail_CT
group by UserID,UserGUID,HFitUserMpiNumber,SiteGUID,CoachingHealthInterestID,FirstNodeID,SecondNodeGuid,ThirdNodeGuid
having Count(*) > 1

exec proc_EDW_HealthInterestDetail 1
exec proc_EDW_HealthInterestDetail 0
*/

GO
PRINT 'creating proc_EDW_HealthInterestDetail';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_HealthInterestDetail') 
    BEGIN
        PRINT 'Replacing proc_EDW_HealthInterestDetail';
        DROP PROCEDURE
             proc_EDW_HealthInterestDetail;
    END;

GO

CREATE PROCEDURE proc_EDW_HealthInterestDetail (
       @ReloadAll AS int = 0) 
AS
BEGIN
    BEGIN
        SET NOCOUNT ON;

        DECLARE
        @iTotal AS bigint = 0;

        EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_HealthInterestDetail';

        IF @iTotal <= 1
            BEGIN
                SET @Reloadall = 1;
            END;

        DECLARE
        @RecordID AS uniqueidentifier = NEWID () ;
        DECLARE
        @CT_DateTimeNow AS datetime = GETDATE () ;
        DECLARE
        @CT_NAME AS nvarchar ( 50) = 'proc_EDW_HealthInterestDetail';
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'I';
        IF @ReloadAll = 1
            BEGIN
                PRINT 'RELOADING ALL EDW_HealthInterestDetail records';
                DROP TABLE
                     DIM_EDW_HealthInterestDetail;
            END;
        IF
        @ReloadAll = 0 OR
        @ReloadAll IS NULL
            BEGIN
                PRINT 'RELOADING only changed EDW_HealthInterestDetail records';
            END;

        IF NOT EXISTS ( SELECT
                               name
                               FROM sys.tables
                               WHERE name = 'DIM_EDW_HealthInterestDetail') 
            BEGIN
                SELECT
                       * INTO
                              DIM_EDW_HealthInterestDetail
                       FROM view_EDW_HealthInterestDetail_CT;
                DECLARE
                @irecs AS int = @@ROWCOUNT;
                PRINT 'RECORDS Loaded: ' + CAST ( @irecs AS nvarchar ( 50)) ;

                EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthInterestDetail';

                EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @irecs;
                EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @irecs , 'U';

                SET ANSI_PADDING ON;

                CREATE CLUSTERED INDEX PI_EDW_HealthInterestDetail ON dbo.DIM_EDW_HealthInterestDetail ( UserID , UserGUID , HFitUserMpiNumber , SiteGUID , CoachingHealthInterestID , FirstNodeID , SecondNodeGuid , ThirdNodeGuid) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                CREATE NONCLUSTERED INDEX PI_EDW_HealthInterestDetail_RowNbrCDate ON dbo.DIM_EDW_HealthInterestDetail ( LastModifiedDate , DeletedFlg) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestDetail';

                IF @ReloadAll = 1
                    BEGIN
                        RETURN;
                    END;
            END;

        IF EXISTS ( SELECT
                           table_name
                           FROM tempdb.information_schema.tables
                           WHERE table_name = '##Temp_HealthInterestDetail'
        ) 
            BEGIN
                PRINT 'Dropping ##Temp_HealthInterestDetail';
                DROP TABLE
                     ##Temp_HealthInterestDetail;
            END;

        SELECT
               * INTO
                      ##Temp_HealthInterestDetail
               FROM view_EDW_HealthInterestDetail_CT;

        EXEC proc_Add_EDW_CT_StdCols '##Temp_HealthInterestDetail';
        EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthInterestDetail';

        CREATE CLUSTERED INDEX PI_TEMP_EDW_HealthInterestDetail
        ON ##Temp_HealthInterestDetail
        ( UserID , UserGUID , HFitUserMpiNumber , SiteGUID , CoachingHealthInterestID , FirstNodeID , SecondNodeGuid , ThirdNodeGuid) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

        DECLARE
        @irecs2 AS int = @@ROWCOUNT;
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @irecs2 , 'U';

        --************************************************
        --	   get the NEW records and insert them
        --	   TEST: Truncate table DIM_EDW_HealthInterestDetail
        --************************************************
        --SET IDENTITY_INSERT DIM_EDW_HealthInterestDetail ON ;

        DECLARE
        @inew AS int = 0;
        EXEC @inew = proc_CT_HealthInterestDetail_AddNewRecs ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @inew;
        PRINT 'Records Added: ' + CAST ( @inew AS nvarchar (5)) ;

        --************************************************
        --get the changed records and update them
        --************************************************
        DECLARE
        @iupdate AS int = 0;
        EXEC @iupdate = proc_CT_HealthInterestDetail_AddUpdatedRecs ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iupdate;
        PRINT 'Records Updated: ' + CAST ( @iupdate AS nvarchar (5)) ;

        --************************************************
        --get the deleted records flag them
        --************************************************
        DECLARE
        @idel AS int = 0;
        EXEC @idel = proc_CT_HealthInterestDetail_AddDeletedRecs ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @idel;
        PRINT 'Records Marked As Deleted: ' + CAST ( @idel AS nvarchar (5)) ;

    END;

    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestDetail';
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @irecs , 'U';
    PRINT 'Created proc_EDW_HealthInterestDetail';
    PRINT GETDATE () ;
    SET NOCOUNT OFF;
--select top 100 * from DIM_EDW_HealthInterestDetail
END;

GO
PRINT 'CREATED proc_EDW_HealthInterestDetail';
PRINT GETDATE () ;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




go
-- use KenticoCMS_Prod1

GO
print('Creating view_EDW_HealthInterestList_CT'); 
GO

if exists(select name from sys.views where name = 'view_EDW_HealthInterestList_CT')
BEGIN 
	drop view view_EDW_HealthInterestList_CT ;
END
go

/*
select count(*) from view_EDW_HealthInterestList_CT

select count(*),  HealthAreaID
		,NodeID
		,NodeGuid
		,AccountCD
from view_EDW_HealthInterestList_CT
group by HealthAreaID
		,NodeID
		,NodeGuid
		,AccountCD
having count(*) > 1
*/
CREATE VIEW [dbo].[view_EDW_HealthInterestList_CT]
AS
	--12/03/2014 (wdm) this view was created by Chad Gurka and passed over to Team P to include into the build
	SELECT
		CHA.CoachingHealthAreaID AS HealthAreaID
		,CHA.NodeID
		,CHA.NodeGuid
		,A.AccountCD
		,CHA.NodeName AS HealthAreaName
		,CHA.HealthAreaDescription
		,CHA.CodeName
		,CHA.DocumentCreatedWhen
		,CHA.DocumentModifiedWhen
		   , HASHBYTES ('sha1',
				    isNull(CHA.NodeName,'-')
				    + isNull(CHA.CodeName,'-')
				    + isNull(cast(CHA.DocumentCreatedWhen as nvarchar(50)),'-')
				    + isNull(cast(CHA.DocumentModifiedWhen as nvarchar(50)),'-')
					+ isNull(left(CHA.HealthAreaDescription,1000),'-')
		  ) as HashCode		  
	, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
		View_HFit_CoachingHealthArea_Joined AS CHA
		JOIN HFit_Account AS A ON A.SiteID = CHA.NodeSiteID
	WHERE DocumentCulture = 'en-us'

GO
print('Created view_EDW_HealthInterestList_CT'); 
GO
  --  
  --  
GO 
print('***** FROM: view_EDW_HealthInterestList_CT.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'creating proc_EDW_HealthInterestList';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_HealthInterestList') 
    BEGIN
        PRINT 'UPDATING proc_EDW_HealthInterestList';
        DROP PROCEDURE
             proc_EDW_HealthInterestList;
    END;

GO

/*-------------------------------------------------------------
{Potential Natural Key}
select count(*) as CNT,  HealthAreaID,NodeID,NodeGuid,AccountCD
from 
view_EDW_HealthInterestList_CT
group by HealthAreaID,NodeID,NodeGuid,AccountCD
having Count(*) > 1

exec proc_EDW_HealthInterestList 0
exec proc_EDW_HealthInterestList 1
*/

CREATE PROCEDURE proc_EDW_HealthInterestList (
       @ReloadAll AS int = 0) 
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_HealthInterestList';

    IF @iTotal <= 1
        BEGIN
            SET @Reloadall = 1;
        END;

    --******************************************************************************************************************************
    -- This procedure is added to the job job_EDW_GetStagingData_RewardUserDetail and set to run automatically on a schedule.
    --******************************************************************************************************************************

    BEGIN

        IF @ReloadAll IS NULL
            BEGIN
                SET @ReloadAll = 0;
            END;

        DECLARE
        @RecordID AS uniqueidentifier = NEWID () ;
        DECLARE
        @CT_DateTimeNow AS datetime = GETDATE () ;
        DECLARE
        @CT_NAME AS nvarchar ( 50) = 'proc_EDW_HealthInterestList';
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'I';

        IF @ReloadAll = 1
            BEGIN
                PRINT 'RELOADING ALL EDW_HealthInterestList records';
                PRINT 'Droppoing table DIM_EDW_HealthInterestList';
                IF EXISTS ( SELECT
                                   name
                                   FROM sys.tables
                                   WHERE name = 'DIM_EDW_HealthInterestList') 
                    BEGIN
                        DROP TABLE
                             DIM_EDW_HealthInterestList;
                    END;
            END;

        DECLARE
        @iFound AS int = ( SELECT
                                  COUNT ( *) 
                                  FROM sys.tables
                                  WHERE name = 'DIM_EDW_HealthInterestList') ;

        PRINT '@iFound: ' + CAST ( @iFound AS nvarchar (50)) ;

        IF @iFound = 0
            BEGIN
                PRINT 'CREATING DIM_EDW_HealthInterestList';
                SELECT
                       * INTO
                              DIM_EDW_HealthInterestList
                       FROM view_EDW_HealthInterestList_CT;

                EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_HealthInterestList';

                DECLARE
                @iReloadCnt AS int = @@ROWCOUNT;
                EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @iReloadCnt , 'U';
                EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iReloadCnt;
                --PRINT 'LOC 003';

                SET ANSI_PADDING ON;

                CREATE CLUSTERED INDEX PI_EDW_HealthInterestList ON dbo.DIM_EDW_HealthInterestList ( HealthAreaID , NodeID , NodeGuid , AccountCD) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                CREATE NONCLUSTERED INDEX PI_EDW_HealthInterestList_RowNbrCDate ON dbo.DIM_EDW_HealthInterestList ( RowNbr , LastModifiedDate , DeletedFlg) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                --PRINT 'LOC 004a';
                EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestList';
                SET NOCOUNT OFF;
                RETURN;
            END;

        IF EXISTS ( SELECT
                           table_name
                           FROM tempdb.information_schema.tables
                           WHERE table_name = '##Temp_HealthInterestList'
        ) 
            BEGIN
                PRINT 'Dropping ##Temp_HealthInterestList';
                DROP TABLE
                     ##Temp_HealthInterestList;
            END;

        SELECT
               * INTO
                      ##Temp_HealthInterestList
               FROM view_EDW_HealthInterestList_CT;

        EXEC proc_Add_EDW_CT_StdCols '##Temp_HealthInterestList';
        CREATE CLUSTERED INDEX PI_TEMP_EDW_HealthInterestList ON ##Temp_HealthInterestList ( HealthAreaID , NodeID , NodeGuid , AccountCD) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

        --************************************************
        --get the NEW records and insert them
        --************************************************
        DECLARE
        @iInserts AS int = 0;
        EXEC @iInserts = proc_CT_HealthInterestList_AddNewRecs ;
        PRINT 'NEW Records Added: ' + CAST ( @iInserts AS nvarchar (5)) ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iInserts;

        --************************************************
        --get the changed records and update them
        --************************************************

        DECLARE
        @iUpdates AS int = 0;
        EXEC @iUpdates = proc_CT_HealthInterestList_AddUpdatedRecs ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdates;

        PRINT 'Records Updated: ' + CAST ( @iUpdates AS nvarchar (5)) ;

        --************************************************
        --Mark deleted records
        --************************************************
        DECLARE
        @iDeletes AS int = @@ROWCOUNT;
        EXEC @iDeletes = proc_CT_HealthInterestList_AddDeletedRecs ;
        PRINT 'Records Marked As Deleted: ' + CAST ( @iDeletes AS nvarchar (5)) ;
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDeletes;
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @iReloadCnt , 'U';

    END;

    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthInterestList';
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , @iReloadCnt , 'U';
    PRINT 'Created proc_EDW_HealthInterestList';
    PRINT GETDATE () ;
    SET NOCOUNT OFF;
--select top 100 * from DIM_EDW_HealthInterestList
END;

GO
PRINT 'CREATED proc_EDW_HealthInterestList';
PRINT GETDATE () ;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
PRINT 'Creating JOB job_EDW_GetStagingData_RewardUserDetail' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_RewardUserDetail_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_EDW_RewardUserDetail]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_RewardUserDetail',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_RewardUserDetail; 
		  exec proc_EDW_HealthAssesmentClientView;
		  exec proc_EDW_HealthInterestDetail;
		  exec proc_EDW_HealthInterestList;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_RewardUserDetail',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating view view_EDW_SmallStepResponses';
PRINT 'Generated FROM: view_EDW_SmallStepResponses.SQL';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_SmallStepResponses') 
    BEGIN
        PRINT 'VIEW view_EDW_SmallStepResponses, replacing.';
        DROP VIEW
             view_EDW_SmallStepResponses;
    END;
GO

CREATE VIEW dbo.view_EDW_SmallStepResponses
AS

--********************************************************************************************************
--IVP Version NO: 1.0
--02.13.2014 : (Sowmiya Venkiteswaran) : Updated the view to include  the fields:
--AccountCD, SiteGUID,SSOutcomeMessage as info. text,
-- Small Steps Program Info( HACampaignNodeGUID,HACampaignName,HACampaignStartDate,HACampaignEndDate)
-- HAUserStartedRecord Info (HAStartedDate,HACompletedDate,HAStartedMode,HACompletedMode)
-- Added filters by document culture and replacing HTML quote with a SQL single quote
--********************************************************************************************************
--02.23.2014 : (Dale Miller & Sowmiya V) : Performance tuning - removed the following WHERE clause and 
--			incorporated them into the JOIN statements for perfoamnce enhancement.
--			 WHERE vwOutcome.DocumentCulture = 'en-US' AND vwCamp.DocumentCulture = 'en-US';
--********************************************************************************************************
--02.23.2014 : (Dale Miller & Sowmiya V) : Performance tuning
--	Prod1, 2 and 3 Labs - Incorporated doc. culture to the Joins
-- 1 - executed DBCC dropcleanbuffers everytime
-- 2 - Tested REPLACE against No REPLACE, insignificant perf. hit.
-- Test Controls:
-- Prod1 Lab - NO SQL DISTINCT - 184311 ( rows) - 14 (seconds) 
-- Prod1 Lab - WITH SQL DISTINCT - 184311 ( rows) - 32 (seconds) 
-- Prod2 Lab - NO SQL DISTINCT -  81120( rows) -  10(seconds) 
-- Prod2 Lab - WITH SQL DISTINCT - 81120 ( rows) -  22(seconds) 
-- Prod3 Lab - NO SQL DISTINCT - 136763 ( rows) - 10 (seconds) 
-- Prod3 Lab - WITH SQL DISTINCT - 136763 ( rows) -  21(seconds)  
--02.24.2015 (SV) - Added column SSHealthAssesmentUserStartedItemID per request from John C.
--02.24.2015 (WDM) - Verified changes applied correctly from within the IVP
--02.24.2015 (WDM) - Verified changes are tracked from within the Schema Change Monitor
--02.24.2015 (WDM) - Add the view to the Data/View IVP
--03.02.2015 (WDM) - The view got out of sync most likely due to multiple users with CRUD capability.
--		Re-executed the master DDL.
--03.03.2015 (WDM/SV) - Added new columns HaCodeName and HFitUserMPINumber.
--03.04.2015 (WDM/SV) - Tested view and reviewed output - added DISTINCT and tuned for perf.
--03.04.2015 (WDM/Ashwin) - Ashwin started testing. Modified the JOIN for UserID - now returns expected MPI.
--03.04.2015 (WDM/Ashwin) - Ashwin certified the view as tested.
--04.06.2015 (WDM/JC) John found an error in the JOIN of user ID - changed to CMS_US.UserSettingsUserID = ss.UserID
--04.15.2015 (WDM/Shane) Found an issue with duplicate rows. Added the SiteID to the JOIN (eg.
--			  vwCamp.NodeSiteID = usrste.SiteID and moved the join down in the list.)
--04.16.2015 (WDM) completed CR-51962
--********************************************************************************************************

SELECT DISTINCT
       ss.UserID
     , acct.AccountCD
     , ste.SiteGUID
     , ss.ItemID AS SSItemID
     , ss.ItemCreatedBy AS SSItemCreatedBy
     , cast(ss.ItemCreatedWhen as datetime)  AS SSItemCreatedWhen
     , ss.ItemModifiedBy AS SSItemModifiedBy
     , cast(ss.ItemModifiedWhen  as datetime) AS SSItemModifiedWhen
     , ss.ItemOrder AS SSItemOrder
     , ss.ItemGUID AS SSItemGUID
     , ss.HealthAssesmentUserStartedItemID AS SSHealthAssesmentUserStartedItemID
     , ss.OutComeMessageGUID AS SSOutcomeMessageGuid
     , REPLACE (vwOutcome.Message, '&#39;', '''') AS SSOutcomeMessage
     , usrstd.HACampaignNodeGUID
     , vwCamp.Name AS HACampaignName
     , cast(vwCamp.CampaignStartDate  as datetime) AS HACampaignStartDate
     , cast(vwCamp.CampaignEndDate  as datetime) AS HACampaignEndDate
     , cast(usrstd.HAStartedDt  as datetime) AS HAStartedDate
     , cast(usrstd.HACompletedDt  as datetime) AS HACompletedDate
     , usrstd.HAStartedMode
     , usrstd.HACompletedMode
     , TODO.HaCodeName
     , CMS_US.HFitUserMPINumber

       FROM
           dbo.Hfit_SmallStepResponses AS ss
               JOIN HFit_HealthAssesmentUserStarted AS usrstd
                   ON usrstd.UserID = ss.UserID
                  AND usrstd.ItemID = ss.HealthAssesmentUserStartedItemID
                 JOIN View_HFit_OutComeMessages_Joined AS vwOutcome
                   ON vwOutcome.NodeGUID = ss.OutComeMessageGUID
                  AND vwOutcome.DocumentCulture = 'en-US'
                 JOIN CMS_UserSite AS usrste
                   ON usrste.UserID = ss.UserID
                 JOIN CMS_Site AS ste
                   ON ste.SiteID = usrste.SiteID
                 JOIN View_HFit_HACampaign_Joined AS vwCamp
                   ON vwCamp.NodeGuid = usrstd.HACampaignNodeGUID
                  AND vwCamp.DocumentCulture = 'en-US'
                  AND vwCamp.NodeSiteID = usrste.SiteID
                 JOIN HFit_Account AS acct
                   ON acct.SiteID = usrste.SiteID
                 JOIN HFit_ToDoSmallSteps AS TODO
                   ON ss.OutComeMessageGUID = TODO.OutComeMessageGUID
                 JOIN CMS_UserSettings AS CMS_US
                   ON CMS_US.UserSettingsUserID = ss.UserID
                  AND CMS_US.HFitUserMPINumber > 0
                  AND CMS_US.HFitUserMPINumber IS NOT NULL;

GO
PRINT 'Created view view_EDW_SmallStepResponses';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'creating proc_EDW_SmallSteps';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_SmallSteps') 
    BEGIN
        PRINT 'UPDATING proc_EDW_SmallSteps';
        DROP PROCEDURE
             proc_EDW_SmallSteps;
    END;
GO
-- exec proc_EDW_SmallSteps 0
-- exec proc_EDW_SmallSteps 1
CREATE PROCEDURE proc_EDW_SmallSteps (
       @ReloadAll AS int = 0) 
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_SmallSteps';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

/*------------------------------------------------------------------------------------------------------------------------
    This procedure is added to the job job_EDW_GetStagingData_RewardUserDetail and set to run automatically on a schedule.
*/

    BEGIN
        DECLARE
        @STime AS datetime = GETDATE () 
      , @CNT_PulledRecords AS bigint = 0
      , @RecordID AS uniqueidentifier = NEWID () 
      , @CT_NAME AS nvarchar ( 100) = 'proc_EDW_SmallSteps';

        DECLARE
        @isNullable AS nvarchar ( 20) = NULL;

        SET @STime = GETDATE () ;
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_SmallSteps' , @STime , @CNT_PulledRecords , 'I';
        EXEC proc_EDW_Procedure_Performance_Monitor 'D' , @CT_NAME;
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '001 - start up';

        IF @ReloadAll = 1
            BEGIN
                PRINT 'RELOADING ALL EDW_SmallSteps records';

                IF EXISTS ( SELECT
                                   name
                                   FROM sys.tables
                                   WHERE name = 'DIM_EDW_SmallSteps') 
                    BEGIN
                        PRINT 'Dropping DIM_EDW_SmallSteps';
                        DROP TABLE
                             DIM_EDW_SmallSteps;
                    END;
            END;
        IF
        @ReloadAll = 0 OR
        @ReloadAll IS NULL
            BEGIN
                PRINT 'RELOADING only changed EDW_SmallSteps records';
            END;
        IF NOT EXISTS ( SELECT
                               name
                               FROM sys.tables
                               WHERE name = 'DIM_EDW_SmallSteps') 
            BEGIN
                EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '002 - Starting Data Pulled';
                SELECT
                       * INTO
                              DIM_EDW_SmallSteps
                       FROM view_EDW_SmallStepResponses_CT;
                DECLARE
                @iPulled AS int = @@ROWCOUNT;

                EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_SmallSteps';

                EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '002a - Data Pulled';

                EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @CNT_PulledRecords;
                IF NOT EXISTS ( SELECT
                                       column_name
                                       FROM information_schema.columns
                                       WHERE
                                       table_name = 'DIM_EDW_SmallSteps' AND
                                       column_name = 'LastModifiedDate') 
                    BEGIN
                        ALTER TABLE DIM_EDW_SmallSteps
                        ADD
                                    LastModifiedDate datetime2 ( 7) NULL;
                    END;

                SET @isNullable = ( SELECT
                                           IS_NULLABLE
                                           FROM information_schema.columns
                                           WHERE
                                           table_name = 'DIM_EDW_SmallSteps' AND
                                           column_name = 'LastModifiedDate') ;
                IF @isNullable != 'YES'
                    BEGIN
                        ALTER TABLE dbo.DIM_EDW_SmallSteps ALTER COLUMN LastModifiedDate datetime2 NULL;
                        PRINT 'set LastModifiedDate to be NULLABLE.';
                    END;

                IF NOT EXISTS ( SELECT
                                       column_name
                                       FROM information_schema.columns
                                       WHERE
                                       table_name = 'DIM_EDW_SmallSteps' AND
                                       column_name = 'DeletedFlg') 
                    BEGIN
                        ALTER TABLE DIM_EDW_SmallSteps
                        ADD
                                    DeletedFlg bit NULL;
                    END;

                IF NOT EXISTS ( SELECT
                                       column_name
                                       FROM information_schema.columns
                                       WHERE
                                       table_name = 'DIM_EDW_SmallSteps' AND
                                       column_name = 'ChangeType') 
                    BEGIN
                        ALTER TABLE DIM_EDW_SmallSteps
                        ADD
                                    ChangeType nvarchar ( 5) NULL;
                    END;
                EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '003 - Starting Data indexed';

                SET ANSI_PADDING ON;
                CREATE CLUSTERED INDEX PI_EDW_SmallSteps ON dbo.DIM_EDW_SmallSteps ( AccountCD , SiteGUID , SSItemID , SSItemGUID ,
                SSHealthAssesmentUserStartedItemID , SSOutcomeMessageGuid , HFitUserMPINumber , HACampaignNodeGUID , HAStartedMode , HACompletedMode ,
                HaCodeName ,
                HACampaignStartDate , HACampaignEndDate) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
                DROP_EXISTING = OFF ,
                ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                CREATE NONCLUSTERED INDEX PI_EDW_SmallSteps_RowNbrCDate ON dbo.DIM_EDW_SmallSteps ( SSItemID , LastModifiedDate ,
                DeletedFlg) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
                ALLOW_ROW_LOCKS = ON ,
                ALLOW_PAGE_LOCKS = ON) ;

                CREATE NONCLUSTERED INDEX PI_EDW_SmallSteps_ItemID ON dbo.DIM_EDW_SmallSteps ( SSItemID) 
                WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
                ALLOW_ROW_LOCKS = ON ,
                ALLOW_PAGE_LOCKS = ON) ;

                CREATE NONCLUSTERED INDEX PI_EDW_SmallSteps_HashCode ON dbo.DIM_EDW_SmallSteps ( HFitUserMPINumber , HashCode) 
                WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
                ALLOW_ROW_LOCKS = ON ,
                ALLOW_PAGE_LOCKS = ON) ;

                SET @STime = GETDATE () ;
                EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_SmallSteps' , @STime , @iPulled , 'U';
                EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '003a - Data indexed';
                EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '002a - reload complete';

                EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_SmallSteps';
                SET NOCOUNT OFF;
                EXEC proc_CT_EDW_SmallSteps_NoDups ;
                RETURN;
            END;

        --IF EXISTS ( SELECT
        --                   name
        --              FROM temp..sys.tables
        --              WHERE name = '##Temp_SmallSteps' )
        IF OBJECT_ID ('tempdb..##Temp_SmallSteps') IS NOT NULL
            BEGIN
                PRINT 'Dropping ##Temp_SmallSteps';
                DROP TABLE
                     ##Temp_SmallSteps;
            END;

        DECLARE
        @iChgType AS int = 0;
        EXEC @iChgType = proc_CkSmallStepsHasChanged ;
        PRINT '@iChgType = ' + CAST ( @iChgType AS nvarchar (50)) ;

        IF @iChgType = 0
            BEGIN
                PRINT 'NO CHANGES FOUND, returning.';
                SET @STime = GETDATE () ;
                EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_SmallSteps' , @STime , @iPulled , 'U';
                EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '00Z1 - NO CHANGES';
                EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '00Z2 - reload complete';

                RETURN;
            END;

        DECLARE
        @iCnt AS bigint = 0;

        --select top 10 * from ##Temp_SmallSteps
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '004 - get changes';
        IF @iChgType = 2
            BEGIN
                PRINT 'PULLING ALL records as deletes were detected.';
                SELECT
                       * INTO
                              ##Temp_SmallSteps
                       FROM view_EDW_SmallStepResponses_CT;
            END;
        IF @iChgType = 1
            BEGIN
                DECLARE @S1 AS nvarchar (2000) = '';
                PRINT 'PULLING only changed records as NO deletes were detected.';
                SET @S1 = 'SELECT
                       * INTO
                              ##Temp_SmallSteps
                  FROM view_EDW_SmallStepResponses_CT
                  WHERE ChangeType IS NOT NULL ';
                EXEC (@S1) ;
            END;
        --WHERE ChangeType IS NOT NULL;
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '005 - changes retrieved';
        SET @iCnt = @@ROWCOUNT;
        IF @iCnt = 0
            BEGIN
                PRINT 'No changes detected.';
                EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '005 - NO CHANGES';

                EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_SmallSteps';
                SET NOCOUNT OFF;
                RETURN;
            END;
        ELSE
            BEGIN
                PRINT 'PROCESSING ' + CAST ( @iCnt AS nvarchar ( 50)) + ' rows.';
            END;

        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               table_name = 'DIM_EDW_SmallSteps' AND
                               column_name = 'LastModifiedDate') 
            BEGIN
                ALTER TABLE ##Temp_SmallSteps
                ADD
                            LastModifiedDate datetime2 ( 7) NULL;
            END;

        SET @isNullable = ( SELECT
                                   IS_NULLABLE
                                   FROM information_schema.columns
                                   WHERE
                                   table_name = 'DIM_EDW_SmallSteps' AND
                                   column_name = 'LastModifiedDate') ;
        IF @isNullable != 'YES'
            BEGIN
                ALTER TABLE dbo.DIM_EDW_SmallSteps ALTER COLUMN LastModifiedDate datetime2 NULL;
                PRINT 'set LastModifiedDate to be NULLABLE.';
            END;

        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               table_name = 'DIM_EDW_SmallSteps' AND
                               column_name = 'DeletedFlg') 
            BEGIN
                ALTER TABLE ##Temp_SmallSteps
                ADD
                            DeletedFlg bit NULL;
            END;

        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               table_name = 'DIM_EDW_SmallSteps' AND
                               column_name = 'ChangeType') 
            BEGIN
                ALTER TABLE ##Temp_SmallSteps
                ADD
                            ChangeType nvarchar ( 5) NULL;
            END;

        CREATE CLUSTERED INDEX PI_TEMP_EDW_SmallSteps ON ##Temp_SmallSteps ( AccountCD , SiteGUID , SSItemID , SSItemGUID ,
        SSHealthAssesmentUserStartedItemID , SSOutcomeMessageGuid , HFitUserMPINumber , HACampaignNodeGUID , HAStartedMode , HACompletedMode ,
        HaCodeName ,
        HACampaignStartDate , HACampaignEndDate) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
        ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

        CREATE NONCLUSTERED INDEX PI_TEMP_EDW_SmallSteps_ItemID ON ##Temp_SmallSteps ( SSItemID) 
        WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
        ALLOW_ROW_LOCKS = ON ,
        ALLOW_PAGE_LOCKS = ON) ;

        CREATE NONCLUSTERED INDEX PI_TEMP_EDW_SmallSteps_Hashcode ON ##Temp_SmallSteps ( HFitUserMPINumber , HashCode) 
        WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
        ALLOW_ROW_LOCKS = ON ,
        ALLOW_PAGE_LOCKS = ON) ;

        EXEC proc_CT_EDW_SmallSteps_Temp_NoDups ;

        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '006 - indexes applied';
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '007 - get new records';

        DECLARE
        @iInserted AS int = 0;

        --************************************************************
        --** APPLY ANY NEW RECORDS TO THE STAGING TABLE
        EXEC @iInserted = proc_CT_SmallSteps_AddNewRecs ;
        --************************************************************

        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iInserted;
        PRINT 'Records Added: ' + CAST ( @iInserted AS nvarchar (5)) ;
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '007a - new records added';

        DECLARE
        @RUNDATE AS datetime2 ( 7) = GETDATE () ;

/*-------------------------------------------------
***********************************************
	   get the changed records and update them
	   ***********************************************
*/
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '008 - get changed records';

        DECLARE @iUpdated AS int = 0;
        --************************************************************
        --** APPLY ANY NEW RECORDS TO THE STAGING TABLE
        EXEC @iUpdated = proc_CT_SmallSteps_AddUpdatedRecs ;
        --************************************************************

        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '008a - retrieved changed records';
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdated;
        PRINT 'Records Updated: ' + CAST ( @iUpdated  AS nvarchar (5)) ;
        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '009 - retrieve deleted records';

        DECLARE @iDeleted AS int = @@ROWCOUNT;
        --************************************************************
        --** MARK DELETED RECORDS
        EXEC @iDeleted = proc_CT_SmallSteps_AddDeletedRecords ;
        --************************************************************

        EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '009a - retrieved deleted records';
        EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDeleted;
        PRINT 'Records Marked As Deleted: ' + CAST ( @iDeleted AS nvarchar (5)) ;
        SET @STime = GETDATE () ;
        SET @CNT_PulledRecords = ( SELECT
                                          COUNT ( *) 
                                          FROM ##Temp_SmallSteps) ;
    END;
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_SmallSteps' , @STime , @CNT_PulledRecords , 'U';

    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_SmallSteps';

    PRINT 'Executed proc_EDW_SmallSteps';
    PRINT GETDATE () ;

    EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '010 - retrieved deleted records';
    EXEC proc_CT_EDW_SmallSteps_NoDups;

    SET NOCOUNT OFF;
END;
GO
PRINT 'CREATED proc_EDW_SmallSteps';
PRINT GETDATE () ;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1


GO
PRINT 'Processing: view_EDW_HealthAssessmentDefinition_CT ' + CAST (GETDATE () AS nvarchar (50)) ;
GO

/*
select count(*), HashCode 
from view_EDW_HealthAssessmentDefinition_CT
group by HashCode 
having count(*) > 1

select * from view_EDW_HealthAssessmentDefinition_CT
select top 100 lastModifiedDate,* from view_EDW_HealthAssessmentDefinition_CT
select count(*) from view_EDW_HealthAssessmentDefinition_CT
select count(*) from view_EDW_HealthAssessmentDefinition_CT
--RCDocPubVerID
Select * from HFit_HealthAssesmentMultipleChoiceQuestion where HealthAssesmentMultipleChoiceQuestionID = 495
update HFit_HealthAssesmentMultipleChoiceQuestion set AllowMultiSelect = -1  where HealthAssesmentMultipleChoiceQuestionID = 495
update HFit_HealthAssesmentMultipleChoiceQuestion set AllowMultiSelect = 0  where HealthAssesmentMultipleChoiceQuestionID = 495

select * 
into STAGED_EDW_HealthAssessmentDefinition
from view_EDW_HealthAssessmentDefinition_CT
where
CHANGED_FLG IS NOT NULL

PK: SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID

select count(*) SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID 
from view_EDW_HealthAssessmentDefinition_CT
group by SiteGUID,ModDocGuid,RCDocumentGUID,RADocumentGuid,QuesDocumentGuid,AnsDocumentGuid,CmsTreeNodeGuid,HANodeGUID
having count(*)  >1

*/

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
             WHERE TABLE_NAME = 'view_EDW_HealthAssessmentDefinition_CT') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssessmentDefinition_CT;
    END;
GO

/*
select * 
into Staging_EDW_HealthAssesmentDeffinition
from view_EDW_HealthAssessmentDefinition_CT
select * from Staging_EDW_HealthAssesmentDeffinition
*/

--**************************************************************************************************************
--NOTE: The column DocumentModifiedWhen comes from the CMS_TREE join - it was left 
--		unchanged when other dates added for the Last Mod Date additions. 
--		Therefore, the 'ChangeType' was left dependent upon this date only. 09.12.2014 (wdm)
--*****************************************************************************************************************************************************
--Test Queries:
--select * from view_EDW_HealthAssessmentDefinition_CT where AnsDocumentGuid is not NULL
--Changes:
--WDM - 6/25/2014
--Query was returning a NULL dataset. Found that it is being caused by the AccountCD join.
--Worked with Shane to discover the CMS Tree had been modified.
--Modified the code so that reads it reads the CMS tree correctly - working.
--7/14/2014 1:29 time to run - 79024 rows - DEV
--7/14/2014 0:58 time to run - 57472 rows - PROD1
--7/15/2014 - Query was returning NodeName of 'Campaigns' only
--	Found the issue in view View_HFit_HACampaign_Joined. Documented the change in the view.
--7/16/2014 - Full Select: Using a DocumentModifiedWhen filter 00:17:28 - Record Cnt: 793,520
--8/7/2014 - Executed in DEV with GUID changes and returned 1.13M Rows in 23:14.
--8/8/2014 - Executed in DEV with GUID changes, new views, and returned 1.13M Rows in 20:16.
--8/8/2014 - Generated corrected view in DEV
--8/12/2014 - John C. explained that Account Code and Site Guid are not needed, NULLED
--				them out. With them in the QRY, returned 43104 rows, with them nulled
--				out, returned 43104 rows. Using a DISTINCT, 28736 rows returned and execution
--				time doubled approximately.
--				Has to add a DISTINCT to all the queries - .
--				Original Query 0:25 @ 43104
--				Original Query 0:46 @ 28736 (distinct)
--				Filter added - VHFHAQ.DocumentCulture 0:22 @ 14368
--				Filter added - and VHFHARCJ.DocumentCulture = 'en-us'	 0:06 @ 3568
--				Filter added - and VHFHARAJ.DocumentCulture = 'en-us'	 0:03 @ 1784
--8/12/2014 - Applied the language filters with John C. and performance improved, as expected,
--				such that when running the view in QA: 
--8/12/2014 - select * from [view_EDW_HealthAssessmentDefinition_CT] where DocumentModifiedWhen between '2000-11-14' and 
--				'2014-11-15' now runs exceptionally fast
--08/12/2014 - ProdStaging 00:21:52 @ 2442
--08/12/2014 - ProdStaging 00:21:09 @ 13272 (UNION ALL   --UNION)
--08/12/2014 - ProdStaging 00:21:37 @ 13272 (UNION ONLY)
--08/12/2014 - ProdStaging 00:06:26 @ 1582 (UNION ONLY & Select Filters Added for Culture)
--08/12/2014 - ProdStaging 00:10:07 @ 6636 (UNION ALL   --UNION) and all selected
--08/12/2014 - ProdStaging added PI PI_View_CMS_Tree_Joined_Regular_DocumentCulture: 00:2:34 @ 6636 
--08/12/2014 - DEV 00:00:58 @ 3792
--09.11.2014 - (wdm) added the needed date fields to help EDW in determining the last mod date of a row.
--10.01.2014 - Dale and Mark reworked this view to use NodeGUIDS and eliminated the CMS_TREE View from participating as 
--				well as Site and Account data
--11.25.2014 - (wdm) added multi-select column capability. The values can be 0,1, NULL
--12.29.2014 - (wdm) Added HTML stripping to two columns #47619, the others mentioned already had stripping applied
--12.31.2014 - (wdm) Started the review to apply CR-47517: Eliminate Matrix Questions with NULL Answer GUID's
--01.07.2014 - (wdm) 47619 The Health Assessment Definition interface view contains HTML tags - corrected with udf_StripHTML
--************************************************************************************************************************************************************
CREATE VIEW dbo.view_EDW_HealthAssessmentDefinition_CT
AS SELECT DISTINCT

          NULL AS SiteGUID --cs.SiteGUID								--WDM 08.12.2014 per John C.
        , NULL AS AccountCD	 --, HFA.AccountCD						--WDM 08.07.2014 per John C.
        , HA.NodeID AS HANodeID										--WDM 08.07.2014
        , HA.NodeName AS HANodeName									--WDM 08.07.2014
          --, HA.DocumentID AS HADocumentID								--WDM 08.07.2014 commented out and left in place for history
        , NULL AS HADocumentID										--WDM 08.07.2014; 09.29.2014: Mark and Dale discussed that NODEGUID should be used such that the multi-language/culture is not a problem.
        , HA.NodeSiteID AS HANodeSiteID								--WDM 08.07.2014
        , HA.DocumentPublishedVersionHistoryID AS HADocPubVerID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) AS ModTitle              --WDM 47619
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText              --WDM 47619
        , VHFHAMJ.NodeGuid AS ModDocGuid	--, VHFHAMJ.DocumentID AS ModDocID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHAMJ.Weight AS ModWeight
        , VHFHAMJ.IsEnabled AS ModIsEnabled
        , VHFHAMJ.CodeName AS ModCodeName
        , VHFHAMJ.DocumentPublishedVersionHistoryID AS ModDocPubVerID
        , dbo.udf_StripHTML (VHFHARCJ.Title) AS RCTitle              --WDM 47619
        , VHFHARCJ.Weight AS RCWeight
        , VHFHARCJ.NodeGuid AS RCDocumentGUID	--, VHFHARCJ.DocumentID AS RCDocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHARCJ.IsEnabled AS RCIsEnabled
        , VHFHARCJ.CodeName AS RCCodeName
        , VHFHARCJ.DocumentPublishedVersionHistoryID AS RCDocPubVerID
        , dbo.udf_StripHTML (VHFHARAJ.Title) AS RATytle              --WDM 47619
        , VHFHARAJ.Weight AS RAWeight
        , VHFHARAJ.NodeGuid AS RADocumentGuid	--, VHFHARAJ.DocumentID AS RADocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHARAJ.IsEnabled AS RAIsEnabled
        , VHFHARAJ.CodeName AS RACodeName
        , VHFHARAJ.ScoringStrategyID AS RAScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID AS RADocPubVerID
        , VHFHAQ.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ.Title, 4000)) AS QuesTitle              --WDM 47619
        , VHFHAQ.Weight AS QuesWeight
        , VHFHAQ.IsRequired AS QuesIsRequired

          --, VHFHAQ.DocumentGuid AS QuesDocumentGuid	--, VHFHAQ.DocumentID AS QuesDocumentID	--WDM 08.07.2014	M&D 10.01.2014
        , VHFHAQ.NodeGuid AS QuesDocumentGuid	--, VHFHAQ.DocumentID AS QuesDocumentID	--WDM 08.07.2014

        , VHFHAQ.IsEnabled AS QuesIsEnabled
        , LEFT (VHFHAQ.IsVisible, 4000) AS QuesIsVisible
        , VHFHAQ.IsStaging AS QuesIsSTaging
        , VHFHAQ.CodeName AS QuestionCodeName
        , VHFHAQ.DocumentPublishedVersionHistoryID AS QuesDocPubVerID
        , VHFHAA.Value AS AnsValue
        , VHFHAA.Points AS AnsPoints
        , VHFHAA.NodeGuid AS AnsDocumentGuid		--ref: #47517
        , VHFHAA.IsEnabled AS AnsIsEnabled
        , VHFHAA.CodeName AS AnsCodeName
        , VHFHAA.UOM AS AnsUOM
        , VHFHAA.DocumentPublishedVersionHistoryID AS AnsDocPUbVerID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014 ADDED TO the returned Columns
        , HA.NodeGUID AS HANodeGUID
          --, NULL as SiteLastModified
        , NULL AS SiteLastModified
          --, NULL as Account_ItemModifiedWhen
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID01' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ.CodeName, '-') + ISNULL (CAST (VHFHAQ.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA.CodeName , '-') + ISNULL (CAST (VHFHAA.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID01' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ.IsVisible, 1000) , '-') 
          ) AS HashCode

          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US'

/*
		  --** ADD THE CHANGE TRACKING Tables
		  */

                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHARAJ.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'		--WDM 08.12.2014	
       AND VHFHAA.NodeGuid IS NOT NULL		--ref: #47517

   UNION ALL   --UNION
   --WDM Retrieve Matrix Level 1 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title)              --WDM 47619
        , dbo.udf_StripHTML (LEFT (LEFT (VHFHAMJ.IntroText, 4000) , 4000)) AS IntroText              --WDM 47619
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title)              --WDM 47619
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title)              --WDM 47619
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ2.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ2.Title, 4000)) AS QuesTitle              --WDM 47619
        , VHFHAQ2.Weight
        , VHFHAQ2.IsRequired
        , VHFHAQ2.NodeGuid
        , VHFHAQ2.IsEnabled
        , LEFT (VHFHAQ2.IsVisible, 4000) 
        , VHFHAQ2.IsStaging
        , VHFHAQ2.CodeName AS QuestionCodeName
          --,VHFHAQ2.NodeAliasPath
        , VHFHAQ2.DocumentPublishedVersionHistoryID
        , VHFHAA2.Value
        , VHFHAA2.Points
        , VHFHAA2.NodeGuid		--ref: #47517
        , VHFHAA2.IsEnabled
        , VHFHAA2.CodeName
        , VHFHAA2.UOM
          --,VHFHAA2.NodeAliasPath
        , VHFHAA2.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID02' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ2.CodeName, '-') + ISNULL (CAST (VHFHAQ2.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA2.CodeName , '-') + ISNULL (CAST (VHFHAA2.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ2.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA2.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID02' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ2.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ2.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2
                      ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2
                      ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA2.NodeGuid IS NOT NULL		--ref: #47517

   UNION ALL   --UNION
   --WDM Retrieve Branching Level 1 Question and Matrix Level 1 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ3.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ3.Title, 4000)) AS QuesTitle
        , VHFHAQ3.Weight
        , VHFHAQ3.IsRequired
        , VHFHAQ3.NodeGuid
        , VHFHAQ3.IsEnabled
        , LEFT (VHFHAQ3.IsVisible, 4000) 
        , VHFHAQ3.IsStaging
        , VHFHAQ3.CodeName AS QuestionCodeName
          --,VHFHAQ3.NodeAliasPath
        , VHFHAQ3.DocumentPublishedVersionHistoryID
        , VHFHAA3.Value
        , VHFHAA3.Points
        , VHFHAA3.NodeGuid		--ref: #47517
        , VHFHAA3.IsEnabled
        , VHFHAA3.CodeName
        , VHFHAA3.UOM
          --,VHFHAA3.NodeAliasPath
        , VHFHAA3.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID03' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ3.CodeName, '-') + ISNULL (CAST (VHFHAQ3.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA3.CodeName , '-') + ISNULL (CAST (VHFHAA3.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ3.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA3.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID03' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ3.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ3.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA3.NodeGuid IS NOT NULL		--ref: #47517
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM Retrieve Branching Level 1 Question and Matrix Level 2 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ7.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ7.Title, 4000)) AS QuesTitle
        , VHFHAQ7.Weight
        , VHFHAQ7.IsRequired
        , VHFHAQ7.NodeGuid
        , VHFHAQ7.IsEnabled
        , LEFT (VHFHAQ7.IsVisible, 4000) 
        , VHFHAQ7.IsStaging
        , VHFHAQ7.CodeName AS QuestionCodeName
          --,VHFHAQ7.NodeAliasPath
        , VHFHAQ7.DocumentPublishedVersionHistoryID
        , VHFHAA7.Value
        , VHFHAA7.Points
        , VHFHAA7.NodeGuid		--ref: #47517
        , VHFHAA7.IsEnabled
        , VHFHAA7.CodeName
        , VHFHAA7.UOM
          --,VHFHAA7.NodeAliasPath
        , VHFHAA7.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID04' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ7.CodeName, '-') + ISNULL (CAST (VHFHAQ7.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA7.CodeName , '-') + ISNULL (CAST (VHFHAA7.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ7.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA7.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID04' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ7.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ7.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID --LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3 ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID

              --Matrix Level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7
                      ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7
                      ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA7.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************

   UNION ALL   --UNION
   --****************************************************
   --WDM 6/25/2014 Retrieve the Branching level 1 Question Group
   --THE PROBLEM LIES HERE in this part of query : 1:40 minute
   -- Added two perf indexes to the first query: 25 Sec
   --****************************************************
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ8.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ8.Title, 4000)) AS QuesTitle
        , VHFHAQ8.Weight
        , VHFHAQ8.IsRequired
        , VHFHAQ8.NodeGuid
        , VHFHAQ8.IsEnabled
        , LEFT (VHFHAQ8.IsVisible, 4000) 
        , VHFHAQ8.IsStaging
        , VHFHAQ8.CodeName AS QuestionCodeName
          --,VHFHAQ8.NodeAliasPath
        , VHFHAQ8.DocumentPublishedVersionHistoryID
        , VHFHAA8.Value
        , VHFHAA8.Points
        , VHFHAA8.NodeGuid		--ref: #47517
        , VHFHAA8.IsEnabled
        , VHFHAA8.CodeName
        , VHFHAA8.UOM
          --,VHFHAA8.NodeAliasPath
        , VHFHAA8.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID05' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ8.CodeName, '-') + ISNULL (CAST (VHFHAQ8.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA8.CodeName , '-') + ISNULL (CAST (VHFHAA8.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ8.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA8.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID05' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ8.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ8.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************	

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID --LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3 ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID

              --Matrix Level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7
                      ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7
                      ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID --Matrix branching level 1 question group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8
                      ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8
                      ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA8.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************

   UNION ALL   --UNION
   --****************************************************
   --WDM 6/25/2014 Retrieve the Branching level 2 Question Group
   --THE PROBLEM LIES HERE in this part of query : 1:48  minutes
   --With the new indexes: 29 Secs
   --****************************************************
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ4.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ4.Title, 4000)) AS QuesTitle
        , VHFHAQ4.Weight
        , VHFHAQ4.IsRequired
        , VHFHAQ4.NodeGuid
        , VHFHAQ4.IsEnabled
        , LEFT (VHFHAQ4.IsVisible, 4000) 
        , VHFHAQ4.IsStaging
        , VHFHAQ4.CodeName AS QuestionCodeName
          --,VHFHAQ4.NodeAliasPath
        , VHFHAQ4.DocumentPublishedVersionHistoryID
        , VHFHAA4.Value
        , VHFHAA4.Points
        , VHFHAA4.NodeGuid		--ref: #47517
        , VHFHAA4.IsEnabled
        , VHFHAA4.CodeName
        , VHFHAA4.UOM
          --,VHFHAA4.NodeAliasPath
        , VHFHAA4.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID06' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ4.CodeName, '-') + ISNULL (CAST (VHFHAQ4.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA4.CodeName , '-') + ISNULL (CAST (VHFHAA4.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ4.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA4.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID06' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ4.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ4.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA4.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 3 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ5.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ5.Title, 4000)) AS QuesTitle
        , VHFHAQ5.Weight
        , VHFHAQ5.IsRequired
        , VHFHAQ5.NodeGuid
        , VHFHAQ5.IsEnabled
        , LEFT (VHFHAQ5.IsVisible, 4000) 
        , VHFHAQ5.IsStaging
        , VHFHAQ5.CodeName AS QuestionCodeName
          --,VHFHAQ5.NodeAliasPath
        , VHFHAQ5.DocumentPublishedVersionHistoryID
        , VHFHAA5.Value
        , VHFHAA5.Points
        , VHFHAA5.NodeGuid		--ref: #47517
        , VHFHAA5.IsEnabled
        , VHFHAA5.CodeName
        , VHFHAA5.UOM
          --,VHFHAA5.NodeAliasPath
        , VHFHAA5.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID07' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ5.CodeName, '-') + ISNULL (CAST (VHFHAQ5.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA5.CodeName , '-') + ISNULL (CAST (VHFHAA5.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ5.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA5.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID07' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ5.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ5.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION
          --********************************************		

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE VHFHAQ.DocumentCulture = 'en-us'
       AND (VHFHAA.DocumentCulture = 'en-us'
         OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
       AND VHFHARCJ.DocumentCulture = 'en-us'
       AND VHFHARAJ.DocumentCulture = 'en-us'
       AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
       AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
       AND VHFHAA5.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 4 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ6.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ6.Title, 4000)) AS QuesTitle
        , VHFHAQ6.Weight
        , VHFHAQ6.IsRequired
        , VHFHAQ6.NodeGuid
        , VHFHAQ6.IsEnabled
        , LEFT (VHFHAQ6.IsVisible, 4000) 
        , VHFHAQ6.IsStaging
        , VHFHAQ6.CodeName AS QuestionCodeName
          --,VHFHAQ6.NodeAliasPath
        , VHFHAQ6.DocumentPublishedVersionHistoryID
        , VHFHAA6.Value
        , VHFHAA6.Points
        , VHFHAA6.NodeGuid		--ref: #47517
        , VHFHAA6.IsEnabled
        , VHFHAA6.CodeName
        , VHFHAA6.UOM
          --,VHFHAA6.NodeAliasPath
        , VHFHAA6.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID08' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ6.CodeName, '-') + ISNULL (CAST (VHFHAQ6.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA6.CodeName , '-') + ISNULL (CAST (VHFHAA6.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ6.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA6.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID08' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ6.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ6.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
              --select count(*) from dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID --Branching level 4 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ6
                      ON VHFHAA5.NodeID = VHFHAQ6.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA6
                      ON VHFHAQ6.NodeID = VHFHAA6.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE  VHFHAQ.DocumentCulture = 'en-us'
        AND (VHFHAA.DocumentCulture = 'en-us'
          OR VHFHAA.DocumentCulture IS NULL)	--WDM 08.12.2014		
        AND VHFHARCJ.DocumentCulture = 'en-us'
        AND VHFHARAJ.DocumentCulture = 'en-us'
        AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
        AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
        AND VHFHAA6.NodeGuid IS NOT NULL		--ref: #47517
   --********************************************
   --AND (
   --    CT_CMS_Class.ClassID IS NOT NULL
   -- OR CT_CMS_Document.DocumentID IS NOT NULL
   -- OR CT_CMS_Site.SiteID IS NOT NULL
   -- OR CT_CMS_Tree.NodeID IS NOT NULL
   -- OR CT_CMS_User.UserID IS NOT NULL
   -- OR CT_COM_SKU.SKUID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   -- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
   -- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
   -- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
   -- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
   --    ) 

   UNION ALL   --UNION
   --WDM 6/25/2014 Retrieve the Branching level 5 Question Group
   SELECT DISTINCT
          NULL AS SiteGUID --cs.SiteGUID		--WDM 08.12.2014
        , NULL AS AccountCD	 --, HFA.AccountCD												--WDM 08.07.2014
        , HA.NodeID		--WDM 08.07.2014
        , HA.NodeName		--WDM 08.07.2014
        , NULL AS HADocumentID		--WDM 08.07.2014
        , HA.NodeSiteID		--WDM 08.07.2014
          --,VCTJ.NodeAliasPath
        , HA.DocumentPublishedVersionHistoryID		--WDM 08.07.2014
        , dbo.udf_StripHTML (VHFHAMJ.Title) 
        , dbo.udf_StripHTML (LEFT (VHFHAMJ.IntroText, 4000)) AS IntroText
        , VHFHAMJ.NodeGuid
        , VHFHAMJ.Weight
        , VHFHAMJ.IsEnabled
        , VHFHAMJ.CodeName
          --,VHFHAMJ.NodeAliasPath
        , VHFHAMJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARCJ.Title) 
        , VHFHARCJ.Weight
        , VHFHARCJ.NodeGuid
        , VHFHARCJ.IsEnabled
        , VHFHARCJ.CodeName
          --,VHFHARCJ.NodeAliasPath
        , VHFHARCJ.DocumentPublishedVersionHistoryID
        , dbo.udf_StripHTML (VHFHARAJ.Title) 
        , VHFHARAJ.Weight
        , VHFHARAJ.NodeGuid
        , VHFHARAJ.IsEnabled
        , VHFHARAJ.CodeName
          --,VHFHARAJ.NodeAliasPath
        , VHFHARAJ.ScoringStrategyID
        , VHFHARAJ.DocumentPublishedVersionHistoryID
        , VHFHAQ9.QuestionType
        , dbo.udf_StripHTML (LEFT (VHFHAQ9.Title, 4000)) AS QuesTitle
        , VHFHAQ9.Weight
        , VHFHAQ9.IsRequired
        , VHFHAQ9.NodeGuid
        , VHFHAQ9.IsEnabled
        , LEFT (VHFHAQ9.IsVisible, 4000) 
        , VHFHAQ9.IsStaging
        , VHFHAQ9.CodeName AS QuestionCodeName
          --,VHFHAQ9.NodeAliasPath
        , VHFHAQ9.DocumentPublishedVersionHistoryID
        , VHFHAA9.Value
        , VHFHAA9.Points
        , VHFHAA9.NodeGuid		--ref: #47517
        , VHFHAA9.IsEnabled
        , VHFHAA9.CodeName
        , VHFHAA9.UOM
          --,VHFHAA9.NodeAliasPath
        , VHFHAA9.DocumentPublishedVersionHistoryID
        , CASE
              WHEN CAST (HA.DocumentCreatedWhen AS date) = CAST (HA.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HA.DocumentCreatedWhen
        , HA.DocumentModifiedWhen
        , HA.NodeGuid AS CmsTreeNodeGuid	--WDM 08.07.2014
        , HA.NodeGUID AS HANodeGUID

        , NULL AS SiteLastModified
        , NULL AS Account_ItemModifiedWhen
          --, c.DocumentModifiedWhen as Campaign_DocumentModifiedWhen
        , NULL AS Campaign_DocumentModifiedWhen
        , HA.DocumentModifiedWhen AS Assessment_DocumentModifiedWhen
        , VHFHAMJ.DocumentModifiedWhen AS Module_DocumentModifiedWhen
        , VHFHARCJ.DocumentModifiedWhen AS RiskCategory_DocumentModifiedWhen
        , VHFHARAJ.DocumentModifiedWhen AS RiskArea_DocumentModifiedWhen
        , VHFHAQ.DocumentModifiedWhen AS Question_DocumentModifiedWhen
        , VHFHAA.DocumentModifiedWhen AS Answer_DocumentModifiedWhen
        , HAMCQ.AllowMultiSelect
        , 'SID09' AS LocID
        , HASHBYTES ('sha1',
          + ISNULL (CAST (HA.NodeName  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeSiteID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHAMJ.CodeName, '-') + ISNULL (CAST (VHFHARCJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARCJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.Weight  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.IsEnabled  AS nvarchar (50)) , '-') + ISNULL (VHFHARAJ.CodeName, '-') + ISNULL (CAST (VHFHARAJ.ScoringStrategyID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.QuestionType  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.Weight AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsEnabled AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.IsStaging AS nvarchar (50)) , '-') + ISNULL (VHFHAQ.CodeName, '-') + ISNULL (CAST (VHFHAQ.DocumentPublishedVersionHistoryID AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Value  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.Points AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.IsEnabled AS nvarchar (50)) , '-') + ISNULL (VHFHAA.CodeName , '-') + ISNULL (CAST (VHFHAA.UOM  AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentPublishedVersionHistoryID  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentCreatedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HA.NodeGuid  AS nvarchar (50)) , '-') + ISNULL (CAST (HA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAMJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARCJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHARAJ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAQ.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (VHFHAA.DocumentModifiedWhen AS nvarchar (50)) , '-') + ISNULL (CAST (HAMCQ.AllowMultiSelect AS nvarchar (50)) , '-') + 'SID09' + ISNULL (LEFT (VHFHARAJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHARCJ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAMJ.IntroText, 1000) , '-') + ISNULL (LEFT (VHFHAQ.Title, 1000) , '-') + ISNULL (LEFT (VHFHAQ.IsVisible, 1000) , '-') 
          ) AS HashCode
          --********************************************
        , CT_CMS_Class.ClassID AS CMS_Class_CtID
        , CT_CMS_Class.SYS_CHANGE_VERSION AS CMS_Class_SCV
        , CT_CMS_Document.DocumentID AS CMS_Document_CtID
        , CT_CMS_Document.SYS_CHANGE_VERSION AS CMS_Document_SCV
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_Tree.NodeID AS CMS_Tree_CtID
        , CT_CMS_Tree.SYS_CHANGE_VERSION AS CMS_Tree_SCV
        , CT_CMS_User.UserID AS CMS_User_CtID
        , CT_CMS_User.SYS_CHANGE_VERSION AS CMS_User_SCV
        , CT_COM_SKU.SKUID AS COM_SKU_CtID
        , CT_COM_SKU.SYS_CHANGE_VERSION AS COM_SKU_SCV
        , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMatrixQuestion_CtID
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMatrixQuestion_SCV
        , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID AS HFit_HealthAssesmentModule_CtID
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_VERSION AS HFit_HealthAssesmentModule_SCV
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssesmentMultipleChoiceQuestion_CtID
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_VERSION AS HFit_HealthAssesmentMultipleChoiceQuestion_SCV
          --, CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID AS HFit_HealthAssesmentPredefinedAnswer_CtID
          --, CT_HFit_HealthAssesmentPredefinedAnswer.SYS_CHANGE_VERSION AS HFit_HealthAssesmentPredefinedAnswer_SCV
        , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID AS HFit_HealthAssesmentRiskArea_CtID
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskArea_SCV
        , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID AS HFit_HealthAssesmentRiskCategory_CtID
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_VERSION AS HFit_HealthAssesmentRiskCategory_SCV
        , CT_HFit_HealthAssessment.HealthAssessmentID AS HFit_HealthAssessment_CtID
        , CT_HFit_HealthAssessment.SYS_CHANGE_VERSION AS HFit_HealthAssessment_SCV
        , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID AS HFit_HealthAssessmentFreeForm_CtID
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_VERSION AS HFit_HealthAssessmentFreeForm_SCV

        , CT_CMS_Class.SYS_CHANGE_OPERATION AS CMS_Class_CHANGE_OPERATION
        , CT_CMS_Document.SYS_CHANGE_OPERATION AS CMS_Document_CHANGE_OPERATION
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHANGE_OPERATION
        , CT_CMS_Tree.SYS_CHANGE_OPERATION AS CMS_Tree_CHANGE_OPERATION
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CMS_User_CHANGE_OPERATION
        , CT_COM_SKU.SYS_CHANGE_OPERATION AS COM_SKU_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION AS HFit_HealthAssessment_CHANGE_OPERATION
        , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION AS HFit_HealthAssessmentFreeForm_CHANGE_OPERATION

        , COALESCE (  CT_CMS_Class.ClassID
          , CT_CMS_Document.DocumentID
          , CT_CMS_Site.SiteID
          , CT_CMS_Tree.NodeID
          , CT_CMS_User.UserID
          , CT_COM_SKU.SKUID
          , CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID
          , CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
          , CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
          , CT_HFit_HealthAssessment.HealthAssessmentID
          , CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
          )  AS CHANGED_FLG

        , COALESCE
          (CT_CMS_Class.SYS_CHANGE_OPERATION
          , CT_CMS_Document.SYS_CHANGE_OPERATION
          , CT_CMS_Site.SYS_CHANGE_OPERATION
          , CT_CMS_Tree.SYS_CHANGE_OPERATION
          , CT_CMS_User.SYS_CHANGE_OPERATION
          , CT_COM_SKU.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMatrixQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentModule.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentMultipleChoiceQuestion.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskArea.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssesmentRiskCategory.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessment.SYS_CHANGE_OPERATION
          , CT_HFit_HealthAssessmentFreeForm.SYS_CHANGE_OPERATION
          ) AS CHANGE_TYPE_CODE
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
FROM
              --dbo.View_CMS_Tree_Joined AS VCTJ
              --INNER JOIN dbo.CMS_Site AS CS ON VCTJ.NodeSiteID = cs.SiteID
              --INNER JOIN HFit_Account hfa WITH(NOLOCK) ON cs.SiteID = hfa.SiteID

              --Campaign links Client which links to Assessment
              --INNER JOIN dbo.View_HFit_HACampaign_Joined as c WITH(NOLOCK) ON VCTJ.NodeID = c.NodeParentID	--Note: 

              View_HFit_HealthAssessment_Joined AS HA WITH (NOLOCK) 
                  INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS VHFHAMJ
                      ON HA.NodeID = VHFHAMJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskCategory_Joined AS VHFHARCJ
                      ON VHFHAMJ.DocumentNodeID = VHFHARCJ.NodeParentID
                    INNER JOIN dbo.View_HFit_HealthAssesmentRiskArea_Joined AS VHFHARAJ
                      ON VHFHARCJ.DocumentNodeID = VHFHARAJ.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ
                      ON VHFHARAJ.DocumentNodeID = VHFHAQ.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA
                      ON VHFHAQ.NodeID = VHFHAA.NodeParentID --matrix level 1 questiongroup
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ2 ON VHFHAQ.NodeID = VHFHAQ2.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA2 ON VHFHAQ2.NodeID = VHFHAA2.NodeParentID

              --Branching Level 1 Question 
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ3
                      ON VHFHAA.NodeID = VHFHAQ3.NodeParentID
                    LEFT OUTER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA3
                      ON VHFHAQ3.NodeID = VHFHAA3.NodeParentID --Matrix Level 2 Question Group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ7 ON VHFHAQ3.NodeID = VHFHAQ7.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA7 ON VHFHAQ7.NodeID = VHFHAA7.NodeParentID

              --Matrix branching level 1 question group
              --INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ8 ON VHFHAA7.NodeID = VHFHAQ8.NodeParentID
              --INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA8 ON VHFHAQ8.NodeID = VHFHAA8.NodeParentID

              --Branching level 2 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ4
                      ON VHFHAA3.NodeID = VHFHAQ4.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                      ON VHFHAQ4.NodeID = VHFHAA4.NodeParentID --Branching level 3 Question Group
              --select count(*) from dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA4
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ5
                      ON VHFHAA4.NodeID = VHFHAQ5.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA5
                      ON VHFHAQ5.NodeID = VHFHAA5.NodeParentID --Branching level 4 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ6
                      ON VHFHAA5.NodeID = VHFHAQ6.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA6
                      ON VHFHAQ6.NodeID = VHFHAA6.NodeParentID --Branching level 5 Question Group
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS VHFHAQ9
                      ON VHFHAA6.NodeID = VHFHAQ9.NodeParentID
                    INNER JOIN dbo.View_EDW_HealthAssesmentAnswers AS VHFHAA9
                      ON VHFHAQ9.NodeID = VHFHAA9.NodeParentID
                    LEFT OUTER JOIN View_HFit_HealthAssesmentMultipleChoiceQuestion_Joined AS HAMCQ
                      ON VHFHAQ.Nodeguid = HAMCQ.Nodeguid
                     AND HAMCQ.DocumentCulture = 'en-US' --************************************************************************************************
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Class, NULL) AS CT_CMS_Class
                      ON HA.NodeClassID = CT_CMS_Class.ClassID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Document, NULL) AS CT_CMS_Document
                      ON HA.DocumentID = CT_CMS_Document.DocumentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                      ON HA.NodeSiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT_CMS_Tree
                      ON HA.NodeID = CT_CMS_Tree.NodeID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_User, NULL) AS CT_CMS_User
                      ON HA.DocumentCreatedByUserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES COM_SKU, NULL) AS CT_COM_SKU
                      ON HA.SKUID = CT_COM_SKU.SKUID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT_HFit_HealthAssesmentMatrixQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentModule, NULL) AS CT_HFit_HealthAssesmentModule
                      ON VHFHAMJ.HealthAssesmentModuleID = CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT_HFit_HealthAssesmentMultipleChoiceQuestion
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentPredefinedAnswer, NULL) AS CT_HFit_HealthAssesmentPredefinedAnswer
              --    ON XX_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID = CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskArea, NULL) AS CT_HFit_HealthAssesmentRiskArea
                      ON VHFHARAJ.HealthAssesmentRiskAreaID = CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentRiskCategory, NULL) AS CT_HFit_HealthAssesmentRiskCategory
                      ON VHFHARCJ.HealthAssesmentRiskCategoryID = CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT_HFit_HealthAssessment
                      ON HA.HealthAssessmentID = CT_HFit_HealthAssessment.HealthAssessmentID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT_HFit_HealthAssessmentFreeForm
                      ON HAMCQ.HealthAssesmentMultipleChoiceQuestionID = CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID
     --**********************************************************************************************************
     WHERE  VHFHAQ.DocumentCulture = 'en-us'
        AND (VHFHAA.DocumentCulture = 'en-us'
          OR VHFHAA.DocumentCulture IS NULL) 
        AND VHFHARCJ.DocumentCulture = 'en-us'
        AND VHFHARAJ.DocumentCulture = 'en-us'
        AND VHFHAMJ.DocumentCulture = 'en-us'	--WDM 08.12.2014	
        AND HA.DocumentCulture = 'en-us'	--WDM 08.12.2014		
        AND VHFHAA9.NodeGuid IS NOT NULL;		--ref: #47517
--********************************************
--AND (
--    CT_CMS_Class.ClassID IS NOT NULL
-- OR CT_CMS_Document.DocumentID IS NOT NULL
-- OR CT_CMS_Site.SiteID IS NOT NULL
-- OR CT_CMS_Tree.NodeID IS NOT NULL
-- OR CT_CMS_User.UserID IS NOT NULL
-- OR CT_COM_SKU.SKUID IS NOT NULL
-- OR CT_HFit_HealthAssesmentMatrixQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
-- OR CT_HFit_HealthAssesmentModule.HealthAssesmentModuleID IS NOT NULL
-- OR CT_HFit_HealthAssesmentMultipleChoiceQuestion.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
-- --OR CT_HFit_HealthAssesmentPredefinedAnswer.HealthAssesmentPredefinedAnswerID_CtID IS NOT NULL
-- OR CT_HFit_HealthAssesmentRiskArea.HealthAssesmentRiskAreaID IS NOT NULL
-- OR CT_HFit_HealthAssesmentRiskCategory.HealthAssesmentRiskCategoryID IS NOT NULL
-- OR CT_HFit_HealthAssessment.HealthAssessmentID IS NOT NULL
-- OR CT_HFit_HealthAssessmentFreeForm.HealthAssesmentMultipleChoiceQuestionID IS NOT NULL
--    );

GO

PRINT 'Processed: view_EDW_HealthAssessmentDefinition_CT ';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthAssessmentDefinition_CT.sql';
GO

--select * 
--into STAGED_EDW_HealthAssessmentDefinition
--from view_EDW_HealthAssessmentDefinition_CT
--go--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
PRINT 'Creating JOB job_EDW_GetStagingData_HADefinition' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_HADefinition_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled=1, 
		@notify_level_eventlog=2, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'dmiller', @job_id = @jobId OUTPUT
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_STAGING_EDW_HADefinition]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_STAGING_EDW_HADefinition',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_STAGING_EDW_HA_Definition;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_STAGING_EDW_HADefinition',
@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=8, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20150611, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959
		--@schedule_uid=N'1de52534-38dc-4155-baf3-0eb7259df6c1'
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
print ('Processing: view_EDW_HealthAssessmentDefinition_STAGED ') ;
go

--select top 100 * from [view_EDW_HealthAssessmentDefinition_STAGED]
--select * from [view_EDW_HealthAssessmentDefinition_STAGED]

if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_HealthAssessmentDefinition_STAGED')
BEGIN
	drop view view_EDW_HealthAssessmentDefinition_STAGED ;
END
GO

create view [dbo].[view_EDW_HealthAssessmentDefinition_STAGED]
as
--****************************************************************************
--09/04/2014 WDM
--The view Health Assessment Definition runs very poorly. This view/table is 
--created as as a staging table allowing the data to already exist when the 
--EDW needs it. This is the view that data from the staging table 
--(EDW_HealthAssessmentDefinition) allowing the EDW to launch a much faster 
--start when processing Health Assessment Definition data.
--04.16.2015 - (WDM) Converted to run against the staging table.
--****************************************************************************
SELECT [SiteGUID]
      ,[AccountCD]
      ,[HANodeID]
      ,[HANodeName]
      ,[HADocumentID]
      ,[HANodeSiteID]
      ,[HADocPubVerID]
      ,[ModTitle]
      ,[IntroText]
      ,[ModDocGuid]
      ,[ModWeight]
      ,[ModIsEnabled]
      ,[ModCodeName]
      ,[ModDocPubVerID]
      ,[RCTitle]
      ,[RCWeight]
      ,[RCDocumentGUID]
      ,[RCIsEnabled]
      ,[RCCodeName]
      ,[RCDocPubVerID]
      ,[RATytle]
      ,[RAWeight]
      ,[RADocumentGuid]
      ,[RAIsEnabled]
      ,[RACodeName]
      ,[RAScoringStrategyID]
      ,[RADocPubVerID]
      ,[QuestionType]
      ,[QuesTitle]
      ,[QuesWeight]
      ,[QuesIsRequired]
      ,[QuesDocumentGuid]
      ,[QuesIsEnabled]
      ,[QuesIsVisible]
      ,[QuesIsSTaging]
      ,[QuestionCodeName]
      ,[QuesDocPubVerID]
      ,[AnsValue]
      ,[AnsPoints]
      ,[AnsDocumentGuid]
      ,[AnsIsEnabled]
      ,[AnsCodeName]
      ,[AnsUOM]
      ,[AnsDocPUbVerID]
      ,[ChangeType]
      ,cast([DocumentCreatedWhen] as datetime) as [DocumentCreatedWhen]
      ,cast([DocumentModifiedWhen] as datetime) as [DocumentModifiedWhen]
      ,[CmsTreeNodeGuid]
      ,[HANodeGUID]
      ,[SiteLastModified]
      ,[Account_ItemModifiedWhen]
      ,[Campaign_DocumentModifiedWhen]
      ,[Assessment_DocumentModifiedWhen]
      ,[Module_DocumentModifiedWhen]
      ,[RiskCategory_DocumentModifiedWhen]
      ,[RiskArea_DocumentModifiedWhen]
      ,[Question_DocumentModifiedWhen]
      ,[Answer_DocumentModifiedWhen]
      ,[AllowMultiSelect]
      ,[LocID]
      ,[HashCode]
      ,[CMS_Class_CtID]
      ,[CMS_Class_SCV]
      ,[CMS_Document_CtID]
      ,[CMS_Document_SCV]
      ,[CMS_Site_CtID]
      ,[CMS_Site_SCV]
      ,[CMS_Tree_CtID]
      ,[CMS_Tree_SCV]
      ,[CMS_User_CtID]
      ,[CMS_User_SCV]
      ,[COM_SKU_CtID]
      ,[COM_SKU_SCV]
      ,[HFit_HealthAssesmentMatrixQuestion_CtID]
      ,[HFit_HealthAssesmentMatrixQuestion_SCV]
      ,[HFit_HealthAssesmentModule_CtID]
      ,[HFit_HealthAssesmentModule_SCV]
      ,[HFit_HealthAssesmentMultipleChoiceQuestion_CtID]
      ,[HFit_HealthAssesmentMultipleChoiceQuestion_SCV]
      ,[HFit_HealthAssesmentRiskArea_CtID]
      ,[HFit_HealthAssesmentRiskArea_SCV]
      ,[HFit_HealthAssesmentRiskCategory_CtID]
      ,[HFit_HealthAssesmentRiskCategory_SCV]
      ,[HFit_HealthAssessment_CtID]
      ,[HFit_HealthAssessment_SCV]
      ,[HFit_HealthAssessmentFreeForm_CtID]
      ,[HFit_HealthAssessmentFreeForm_SCV]
      ,[CMS_Class_CHANGE_OPERATION]
      ,[CMS_Document_CHANGE_OPERATION]
      ,[CMS_Site_CHANGE_OPERATION]
      ,[CMS_Tree_CHANGE_OPERATION]
      ,[CMS_User_CHANGE_OPERATION]
      ,[COM_SKU_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentMatrixQuestion_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentModule_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentMultipleChoiceQuestion_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentRiskArea_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentRiskCategory_CHANGE_OPERATION]
      ,[HFit_HealthAssessment_CHANGE_OPERATION]
      ,[HFit_HealthAssessmentFreeForm_CHANGE_OPERATION]
      ,[CHANGED_FLG]
      ,[CHANGE_TYPE_CODE]
      ,[LastModifiedDate]
      ,[RowNbr]
      ,[DeletedFlg]
  FROM [Staging_EDW_HealthDefinition]


GO
print('***** FROM: view_EDW_HealthAssessmentDefinition_STAGED.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
print ('Processing: view_EDW_RewardTriggerParameters_STAGED ') ;
go

if exists(select NAME from sys.VIEWS where NAME = 'view_EDW_RewardTriggerParameters_STAGED')
BEGIN
	drop view view_EDW_RewardTriggerParameters_STAGED ;
END
GO

create VIEW [dbo].[view_EDW_RewardTriggerParameters_STAGED]
AS
select * from STAGING_EDW_RewardTriggerParameters
      

GO


  --  
  --  
GO 
print('***** Created: view_EDW_RewardTriggerParameters_STAGED.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

/*-----------------------------------------------------------------------------
exec proc_EDW_RewardTriggerParameters 0 ,1  --Process Changed Data only
exec proc_EDW_RewardTriggerParameters 1 ,1  --Reload ALL

select * from TEMP_EDW_RewardTriggerParameters_DATA
select  * from CT_VersionTracking ; 
select * from view_EDW_RewardTriggerParameters_CT
select * from [view_EDW_HealthAssessmentDefinition_Staged]

PULLING Changes for versions between: 42944  and 43281
PULLING Changes for versions between: 43284  and 43287
PULLING Changes for versions between: 43455  and 43468
PULLING Changes for versions between: 43625  and 43627
PULLING Changes for versions between: 43629  and 43632
PULLING Changes for versions between: 43635  and 43691

PULLING Changes for versions between: 11  and 14

SELECT
       COUNT (*) 
       FROM DIM_EDW_RewardTriggerParameters;

SELECT COUNT(*) FROM [view_EDW_RewardTriggerParameters_CT]	  --00:01:47
SELECT top 10 * FROM [view_EDW_RewardTriggerParameters_CT]
SELECT TOP 100 * FROM [DIM_EDW_RewardTriggerParameters];
SELECT COUNT (*) FROM [DIM_EDW_RewardTriggerParameters]; 

PERF Measurements
03.26.2015 : 4681580 rows - 01:26:36 run time / PROD 1 @ LAB - full reload
03.27.2015 : 4681580 rows - 01:01:20 run time / PROD 1 @ LAB - full reload
03.27.2015 : Prod2  @ LAB : (3711933 row(s) affected) : 01:56:01 - full reload
03.28.2015 : Prod3  @ LAB : (5697805 row(s) affected) : 05:45:57 - full reload
03.29.2015 : Prod2  @ LAB : (xx row(s) affected) : 01:56:01 - Changed Records

04.16.2015 : WDM - complted the SP and started testing.
*/

GO
PRINT 'FROM proc_EDW_RewardTriggerParameters.SQL';
PRINT 'Creating proc_EDW_RewardTriggerParameters';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE
                   name = 'proc_EDW_RewardTriggerParameters') 
    BEGIN
        PRINT 'Replacing proc_EDW_RewardTriggerParameters proc';
        DROP PROCEDURE
             proc_EDW_RewardTriggerParameters;
    END;
GO

CREATE PROCEDURE proc_EDW_RewardTriggerParameters
       @Reloadall int = 0
     , @TrackProgress int = 0
     , @KeepData AS bit = 0
AS
BEGIN

    SET NOCOUNT ON;

    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardTriggerParameters';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

    DECLARE
    @Synchronization_Version bigint = 0
  , @CurrentDbVersion AS int
  , @STime AS datetime
  , @TgtView AS nvarchar ( 100) = 'view_EDW_RewardTriggerParameters'
  , @ExtractionDate AS datetime
  , @ExtractedVersion AS int
  , @ExtractedRowCnt AS int
  , @EndTime AS datetime
  , @CNT_PulledRecords AS int = 0
  , @iCnt AS int = 0
  , @RowNbr AS int = 0
  , @StartTime AS datetime = GETDATE () 
  , @SVRName AS nvarchar ( 100) 
  , @DBName AS nvarchar ( 100) = DB_NAME () 
  , @CNT_Insert AS int = 0
  , @CNT_Update AS int = 0
  , @CNT_Delete AS int = 0
  , @CNT_StagingTable int = 0
  , @VersionNBR int = 0;

    DECLARE
    @proc_RowGuid AS uniqueidentifier = NEWID () 
  , @CALLING_PROC AS nvarchar ( 100) = 'proc_EDW_RewardTriggerParameters'
  , @PROC_LOCATION AS nvarchar ( 100) = ''
  , @proc_starttime AS datetime = GETDATE () 
  , @proc_endtime AS datetime = NULL
  , @proc_elapsedsecs AS bigint = 0
  , @proc_RowsProcessed AS bigint = 0
  , @PulledCnt AS bigint;

    DECLARE
    @HRPART AS int
  , @MINPART AS int
  , @SECPART AS int
  , @TOTSECS AS int = 0;

    SET @SVRName = ( SELECT
                            @@SERVERNAME) ;

    SET @STime = GETDATE () ;

    EXEC proc_EDW_CT_ExecutionLog_Update @proc_RowGuid , 'proc_EDW_RewardTriggerParameters' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                               FROM sys.tables
                               WHERE
                               name = 'DIM_EDW_RewardTriggerParameters') 
                BEGIN
                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    PRINT 'Dropping DIM_EDW_RewardTriggerParameters for FULL reload.';
                    DROP TABLE
                         DIM_EDW_RewardTriggerParameters;
                END;
            ELSE
                BEGIN
                            PRINT 'Reloading DIM_EDW_RewardTriggerParameters.';                    
                END;
            IF
            @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL EDW HA Data.';

                    SELECT
                           * INTO
                                  DIM_EDW_RewardTriggerParameters
                           FROM view_EDW_RewardTriggerParameters_CT;
				SET @PulledCnt = @@ROWCOUNT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardTriggerParameters';
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @proc_RowGuid , 'I' , @PulledCnt;
                    PRINT 'TOTAL RECORDS PULLED: ' + CAST ( @PulledCnt AS nvarchar ( 50)) ;

                    IF
                    @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( *) 
                                                 FROM DIM_EDW_RewardTriggerParameters) ;
                            PRINT DB_NAME () + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50)) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( *) 
                                                      FROM DIM_EDW_RewardTriggerParameters) ;
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                           FROM sys.indexes
                                           WHERE
                                           name = 'PI_EDW_RewardTriggerParameters_IDs') 
                        BEGIN
                            IF
                            @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_RewardTriggerParameters_IDs at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                                END;
                            CREATE NONCLUSTERED INDEX PI_EDW_RewardTriggerParameters_IDs ON dbo.DIM_EDW_RewardTriggerParameters ( SiteGUID , RewardTriggerID , ParameterDisplayName , RewardTriggerParameterOperator , [Value] , AccountID , AccountCD , DocumentGuid , NodeGuid) 
                            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                        END;

                    SET @ExtractionDate = GETDATE () ;
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( *) 
                                                    FROM DIM_EDW_RewardTriggerParameters) ;
                    --SET @TgtView = 'view_EDW_RewardTriggerParameters';
                    SET @EndTime = GETDATE () ;

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                        END;

                END;
            -- SELECT * INTO [DIM_EDW_RewardTriggerParameters] FROM [view_EDW_RewardTriggerParameters_CT];
            IF
            @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            IF
            @TrackProgress = 1
                BEGIN
                    PRINT
                    'Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            SET @STime = GETDATE () ;
            EXEC proc_EDW_CT_ExecutionLog_Update @proc_RowGuid , 'proc_EDW_RewardTriggerParameters' , @STime , @PulledCnt , 'U';

            SET @HRPART = DATEDIFF ( hour , @proc_starttime , GETDATE ()) ;
            SET @MINPART = DATEDIFF ( minute , @proc_starttime , GETDATE ()) % 60;
            SET @SECPART = DATEDIFF ( second , @proc_starttime , GETDATE ()) % 60;
            SET @TOTSECS = DATEDIFF ( second , @proc_starttime , GETDATE ()) ;

            PRINT 'TIME TO EXECUTE: ' + CAST ( @TOTSECS AS nvarchar ( 10)) + ' Seconds';
            PRINT 'TOTAL RECORDS PULLED: ' + CAST ( @PulledCnt AS nvarchar ( 20)) ;

            SET @proc_RowsProcessed = @PulledCnt;
            SET @PROC_LOCATION = 'End Of Run';
            SET @proc_endtime = GETDATE () ;
            EXEC proc_CT_Performance_History @proc_RowGuid , @CALLING_PROC , @PROC_LOCATION , @proc_starttime , @proc_endtime , @proc_elapsedsecs , @proc_RowsProcessed;

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardTriggerParameters';

            SET NOCOUNT OFF;

            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                           FROM sys.tables
                           WHERE
                           name = 'DIM_EDW_RewardTriggerParameters') 
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_RewardTriggerParameters was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            IF NOT EXISTS ( SELECT
                                   name
                                   FROM sys.indexes
                                   WHERE
                                   name = 'PI_EDW_RewardTriggerParameters_IDs') 
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_RewardTriggerParameters_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_RewardTriggerParameters_IDs ON dbo.DIM_EDW_RewardTriggerParameters (
                    SiteGUID
                    , RewardTriggerID
                    , ParameterDisplayName
                    , RewardTriggerParameterOperator
                    , [Value]
                    , AccountID
                    , AccountCD
                    , DocumentGuid
                    , NodeGuid) 
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                               FROM tempdb.dbo.sysobjects
                               WHERE id = OBJECT_ID ( N'tempdb..##TEMP_RewardTriggerParameters')) 

                BEGIN
                    PRINT 'Dropping ##TEMP_RewardTriggerParameters';
                    DROP TABLE
                         ##TEMP_RewardTriggerParameters;
                END;

/*---------------------------------------------------------------------------
*****************************************************************************
*/

            SELECT
                   * INTO
                          ##TEMP_RewardTriggerParameters
                   FROM view_EDW_RewardTriggerParameters_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

            SET @PulledCnt = @@ROWCOUNT;

            --select * from ##TEMP_RewardTriggerParameters
            --ALTER TABLE ##TEMP_RewardTriggerParameters add SVR nvarchar(100) not NULL default(@@SERVERNAME)
            --ALTER TABLE ##TEMP_RewardTriggerParameters add DBNAME nvarchar(100) not NULL default(DB_NAME())

            EXEC proc_Add_EDW_CT_StdCols '##TEMP_RewardTriggerParameters';

            CREATE CLUSTERED INDEX temp_PI_EDW_RewardTriggerParameters_IDs ON dbo.##TEMP_RewardTriggerParameters (
            SiteGUID
            , RewardTriggerID
            , ParameterDisplayName
            , RewardTriggerParameterOperator
            , [Value]
            , AccountID
            , AccountCD
            , DocumentGuid
            , NodeGuid) 
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

            IF @KeepData = 1
                BEGIN
                    PRINT 'KEEPING TEMP DATA IN TABLE TEMP_EDW_RewardTriggerParameters_DATA';
                    IF EXISTS ( SELECT
                                       name
                                       FROM sys.tables
                                       WHERE
                                       name = 'TEMP_EDW_RewardTriggerParameters_DATA') 
                        BEGIN
                            DROP TABLE
                                 TEMP_EDW_RewardTriggerParameters_DATA;
                        END;

                    SELECT
                           * INTO
                                  TEMP_EDW_RewardTriggerParameters_DATA
                           FROM view_EDW_RewardTriggerParameters_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'TEMP_EDW_RewardTriggerParameters_DATA';

                    CREATE CLUSTERED INDEX temp_PI_EDW_RewardTriggerParameters_IDs ON TEMP_EDW_RewardTriggerParameters_DATA (
                    SiteGUID
                    , RewardTriggerID
                    , ParameterDisplayName
                    , RewardTriggerParameterOperator
                    , [Value]
                    , AccountID
                    , AccountCD
                    , DocumentGuid
                    , NodeGuid) 
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM ##TEMP_RewardTriggerParameters) ;

            --*******************************************************
            -- ADD NEW RECORDS
            --*******************************************************    
            DECLARE
            @iInserts AS int = 0;
            EXEC @iInserts = proc_CT_RewardTriggerParameters_AddNewRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @proc_RowGuid , 'I' , @iInserts;
            PRINT 'TOTAL RECORDS INSERTED: ' + CAST ( @iInserts AS nvarchar ( 50)) ;

            --*******************************************************
            -- ADD UPDATED RECORDS
            --*******************************************************    	   
            DECLARE
            @iUpdates AS int = 0;
            EXEC @iUpdates = proc_CT_RewardTriggerParameters_AddUpdatedRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @proc_RowGuid , 'U' , @iUpdates;
            PRINT 'TOTAL RECORDS UPDATED: ' + CAST ( @iUpdates AS nvarchar ( 50)) ;

            --*******************************************************
            -- FIND DELETED ROWS
            --*******************************************************
            DECLARE
            @iDeletes AS int = 0;
            EXEC @iDeletes = proc_CT_RewardTriggerParameters_AddDeletedRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @proc_RowGuid , 'D' , @iDeletes;
            PRINT 'TOTAL RECORDS DELETED: ' + CAST ( @iDeletes AS nvarchar ( 50)) ;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM ##TEMP_RewardTriggerParameters) ;
            SET @STime = GETDATE () ;
            EXEC proc_EDW_CT_ExecutionLog_Update @proc_RowGuid , 'proc_EDW_RewardTriggerParameters' , @STime , @CNT_PulledRecords , 'U';

            SET @HRPART = DATEDIFF ( hour , @proc_starttime , GETDATE ()) ;
            SET @MINPART = DATEDIFF ( minute , @proc_starttime , GETDATE ()) % 60;
            SET @SECPART = DATEDIFF ( second , @proc_starttime , GETDATE ()) % 60;
            SET @TOTSECS = DATEDIFF ( second , @proc_starttime , GETDATE ()) ;

            PRINT 'TIME TO EXECUTE: ' + CAST ( @TOTSECS AS nvarchar ( 10)) ;
            PRINT 'TOTAL RECORDS ANALYZED: ' + CAST ( @PulledCnt AS nvarchar ( 20)) ;

            SET @proc_RowsProcessed = @PulledCnt;
            SET @PROC_LOCATION = 'End Of Run';
            SET @proc_endtime = GETDATE () ;
            EXEC proc_CT_Performance_History @proc_RowGuid , @CALLING_PROC , @PROC_LOCATION , @proc_starttime , @proc_endtime , @proc_elapsedsecs , @proc_RowsProcessed;

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardTriggerParameters';

            SET NOCOUNT OFF;

        END;
END;

GO
PRINT 'Created proc_EDW_RewardTriggerParameters';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






--proc_EDW_RewardTriggerParameters
go
PRINT 'Creating JOB job_EDW_GetStagingData_RewardTriggerParameters' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_RewardTriggerParameters_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_EDW_RewardTriggerParameters]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_RewardTriggerParameters',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_RewardTriggerParameters',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_RewardTriggerParameters',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
-- use KenticoCMS_Prod1

GO
PRINT 'Processing: view_EDW_RewardAwardDetail_CT ';
PRINT '***** FROM: view_EDW_RewardAwardDetail_CT.sql';
GO
IF EXISTS (SELECT
				  TABLE_NAME
				  FROM INFORMATION_SCHEMA.VIEWS
				  WHERE TABLE_NAME = 'view_EDW_RewardAwardDetail_CT') 
	BEGIN
		DROP VIEW
			 view_EDW_RewardAwardDetail_CT;
	END;
GO
CREATE VIEW dbo.view_EDW_RewardAwardDetail_CT
AS

--*************************************************************************************************
--(WDM) 03.17.2015 modified for change tracking
--select * from view_EDW_RewardAwardDetail_CT
--*************************************************************************************************

SELECT DISTINCT
	   cu.UserGUID
	 , cs.SiteGUID
	 , cus.HFitUserMpiNumber
	 , RL_Joined.NodeGuid AS RewardLevelGUID
	 , RL_Joined.AwardType
	 , HFRAUD.AwardDisplayName
	 , HFRAUD.RewardValue
	 , HFRAUD.ThresholdNumber
	 , HFRAUD.UserNotified
	 , HFRAUD.IsFulfilled
	 , hfa.AccountID
	 , HFA.AccountCD
	 , CASE
		   WHEN CAST (HFRAUD.ItemCreatedWhen AS date) = CAST (HFRAUD.ItemModifiedWhen AS date) 
		   THEN 'I'
		   ELSE 'U'
	   END AS                ChangeType
	   ,hashbytes ('sha1',
		    + isnull(cast(cu.UserGUID as nvarchar(50)),'-')
		    + isnull(cast(cs.SiteGUID as nvarchar(50)),'-')
		    + isnull(cast(cus.HFitUserMpiNumber as nvarchar(50)),'-')
		    + isnull(cast(RL_Joined.NodeGuid as nvarchar(50)),'-')
		    + isnull(cast(RL_Joined.AwardType as nvarchar(100)),'-')
		    + isnull(cast(HFRAUD.AwardDisplayName as nvarchar(250)),'-')
		    + isnull(cast(HFRAUD.RewardValue as nvarchar(50)),'-')
		    + isnull(cast(HFRAUD.ThresholdNumber as nvarchar(50)),'-')
		    + isnull(cast(HFRAUD.UserNotified as nvarchar(50)),'-')
		    + isnull(cast(HFRAUD.IsFulfilled as nvarchar(50)),'-')
		    + isnull(cast(hfa.AccountID as nvarchar(50)),'-')
		    + isnull(cast(HFA.AccountCD as nvarchar(50)),'-')
		  ) as HashCode
	   , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM dbo.HFit_RewardsAwardUserDetail AS HFRAUD
				INNER JOIN dbo.View_HFit_RewardLevel_Joined AS RL_Joined
					ON hfraud.RewardLevelNodeId = RL_Joined.NodeID
				   AND RL_Joined.DocumentCulture = 'en-US'
				   AND HFRAUD.CultureCode = 'en-US'
				 INNER JOIN dbo.CMS_User AS CU
					ON hfraud.UserId = cu.UserID
				 INNER JOIN dbo.CMS_UserSite AS CUS2
					ON cu.UserID = cus2.UserID
				 INNER JOIN dbo.HFit_Account AS HFA
					ON cus2.SiteID = HFA.SiteID
				 INNER JOIN dbo.CMS_Site AS CS
					ON CUS2.SiteID = CS.SiteID
				 INNER JOIN dbo.CMS_UserSettings AS CUS
					ON cu.UserID = cus.UserSettingsUserID;
GO
PRINT 'Processed: view_EDW_RewardAwardDetail_CT ';

GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*---------------------------------------
***************************************
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
***************************************
*/

/*---------------------------------------
***************************************
exec proc_EDW_RewardAwardDetail 0
exec proc_EDW_RewardAwardDetail 1
***************************************
*/

GO

PRINT 'FROM proc_EDW_RewardAwardDetail.SQL';

PRINT 'Creating proc_EDW_RewardAwardDetail';

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE
                   name = 'proc_EDW_RewardAwardDetail') 

    BEGIN

        PRINT 'Replacing proc_EDW_RewardAwardDetail proc';

        DROP PROCEDURE
             proc_EDW_RewardAwardDetail;
    END;

GO

CREATE PROCEDURE proc_EDW_RewardAwardDetail
       @Reloadall int = 0
     , @TrackProgress int = 0
     , @KeepData AS bit = 0
AS
BEGIN

    SET NOCOUNT ON;

    DECLARE
    @Synchronization_Version bigint = 0
  , @CurrentDbVersion AS int
  , @STime AS datetime
  , @TgtView AS nvarchar ( 100) = 'view_EDW_RewardAwardDetail_CT'
  , @ExtractionDate AS datetime
  , @ExtractedVersion AS int
  , @ExtractedRowCnt AS int
  , @EndTime AS datetime
  , @CNT_PulledRecords AS int = 0
  , @iCnt AS int = 0
  , @RowNbr AS int = 0
  , @StartTime AS datetime = GETDATE () 
  , @SVRName AS nvarchar ( 100) 
  , @DBName AS nvarchar ( 100) = DB_NAME () 
  , @CNT_Insert AS int = 0
  , @CNT_Update AS int = 0
  , @CNT_Delete AS int = 0
  , @CNT_StagingTable int = 0
  , @VersionNBR int = 0;

    DECLARE
    @iTotal AS bigint = 0;
    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardAwardDetail';

    IF @iTotal = 1

        BEGIN

            SET @Reloadall = 1;
        END;

    SET @SVRName = ( SELECT
                            @@SERVERNAME) ;

    SET @STime = GETDATE () ;

    DECLARE
    @RecordID AS uniqueidentifier = NEWID () ;
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardAwardDetail' , @STime , 0 , 'I';

    IF @Reloadall = 1

        BEGIN

            IF EXISTS ( SELECT
                               NAME
                               FROM sys.tables
                               WHERE
                               name = 'DIM_EDW_RewardAwardDetail') 

                BEGIN

                    PRINT 'Dropping DIM_EDW_RewardAwardDetail for FULL reload.';

                    DROP TABLE
                         DIM_EDW_RewardAwardDetail;
                END;
            ELSE

                BEGIN

                    IF
                    @TrackProgress = 1

                        BEGIN

                            PRINT 'Reloading DIM_EDW_RewardAwardDetail.';
                        END;
                END;

            IF
            @TrackProgress = 1

                BEGIN

                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            IF @Reloadall = 1

                BEGIN

                    PRINT 'RELOADING ALL EDW HA Data.';

                    SELECT
                           * INTO
                                  DIM_EDW_RewardAwardDetail
                           FROM view_EDW_RewardAwardDetail_CT;
                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardAwardDetail';
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @@ROWCOUNT;

                    IF
                    @TrackProgress = 1

                        BEGIN

                            SET @iCnt = ( SELECT
                                                 COUNT ( *) 
                                                 FROM DIM_EDW_RewardAwardDetail) ;

                            PRINT DB_NAME () + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50)) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( *) 
                                                      FROM DIM_EDW_RewardAwardDetail) ;

                    SET @CNT_StagingTable = @CNT_PulledRecords;

                    IF NOT EXISTS ( SELECT
                                           name
                                           FROM sys.indexes
                                           WHERE
                                           name = 'PI_EDW_RewardAwardDetail_IDs') 

                        BEGIN

                            IF
                            @TrackProgress = 1

                                BEGIN

                                    PRINT 'Adding INDEX PI_EDW_RewardAwardDetail_IDs at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                                END;

                            CREATE NONCLUSTERED INDEX PI_EDW_RewardAwardDetail_IDs ON dbo.DIM_EDW_RewardAwardDetail ( UserGUID
                            , SiteGUID
                            , HFitUserMpiNumber
                            , RewardLevelGUID
                            , AwardType
                            , AwardDisplayName
                            , RewardValue
                            , ThresholdNumber
                            , UserNotified
                            , IsFulfilled
                            , AccountID
                            , AccountCD) 
                            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                        END;

                    SET @ExtractionDate = GETDATE () ;

                    SET @ExtractedVersion = -1;

                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( *) 
                                                    FROM DIM_EDW_RewardAwardDetail) ;

                    --SET @TgtView = 'view_EDW_RewardAwardDetail';

                    SET @EndTime = GETDATE () ;

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                         , ExtractedVersion
                         , CurrentDbVersion
                         , ExtractedRowCnt
                         , TgtView
                         , StartTime
                         , EndTime
                         , SVRName
                         , DBName
                         , CNT_Insert
                         , CNT_Update
                         , CNT_delete
                         , CNT_PulledRecords
                         , CNT_StagingTable
                    ) 
                    VALUES
                    (
                    @ExtractionDate ,
                    @ExtractedVersion ,
                    @CurrentDbVersion ,
                    @ExtractedRowCnt ,
                    @TgtView ,
                    @StartTime ,
                    @EndTime ,
                    @SVRName ,
                    @DBName ,
                    @CNT_Insert ,
                    @CNT_Update ,
                    @CNT_delete ,
                    @CNT_PulledRecords ,
                    @CNT_StagingTable) ;

                    IF
                    @TrackProgress = 1

                        BEGIN

                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                        END;
                END;

            -- SELECT * INTO [DIM_EDW_RewardAwardDetail] FROM [view_EDW_RewardAwardDetail_CT];

            IF
            @TrackProgress = 1

                BEGIN

                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            IF
            @TrackProgress = 1

                BEGIN

                    PRINT
                    'Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            SET @STime = GETDATE () ;
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardAwardDetail';
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardAwardDetail' , @STime , @CNT_PulledRecords , 'U';

            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                           FROM sys.tables
                           WHERE
                           name = 'DIM_EDW_RewardAwardDetail') 

        BEGIN

            PRINT '****************************************************************************';

            PRINT 'FATAL ERROR: table DIM_EDW_RewardAwardDetail was NOT found, aborting.';

            PRINT '****************************************************************************';
        END;
    ELSE

        BEGIN
            IF NOT EXISTS ( SELECT
                                   name
                                   FROM sys.indexes
                                   WHERE
                                   name = 'PI_EDW_RewardAwardDetail_IDs') 

                BEGIN

                    PRINT 'Adding INDEX PI_EDW_RewardAwardDetail_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_RewardAwardDetail_IDs ON dbo.DIM_EDW_RewardAwardDetail (
                    UserGUID
                    , SiteGUID
                    , HFitUserMpiNumber
                    , RewardLevelGUID
                    , AwardType
                    , AwardDisplayName
                    , RewardValue
                    , ThresholdNumber
                    , UserNotified
                    , IsFulfilled
                    , AccountID
                    , AccountCD) 
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                               FROM tempdb.dbo.sysobjects
                               WHERE
                               id = OBJECT_ID ( N'tempdb..#TEMP_EDW_RewardAwardDetail_DATA')) 

                BEGIN

                    PRINT 'Dropping #TEMP_EDW_RewardAwardDetail_DATA';

                    DROP TABLE
                         #TEMP_EDW_RewardAwardDetail_DATA;
                END;

/*---------------------------------------------------------------------------
***************************************************************************
*****************************************************************************
***************************************************************************
*/

            IF EXISTS ( SELECT
                               name
                               FROM sys.tables
                               WHERE
                               name = '#TEMP_EDW_RewardAwardDetail_DATA') 

                BEGIN

                    DROP TABLE
                         #TEMP_EDW_RewardAwardDetail_DATA;
                END;

            SELECT
                   * INTO
                          #TEMP_EDW_RewardAwardDetail_DATA
                   FROM view_EDW_RewardAwardDetail_CT;

            --WHERE CHANGED_FLG IS NOT NULL;

            ALTER TABLE #TEMP_EDW_RewardAwardDetail_DATA
            ADD
                        LastModifiedDate datetime NULL;

            ALTER TABLE #TEMP_EDW_RewardAwardDetail_DATA
            ADD
                        RowNbr  int NULL;

            ALTER TABLE #TEMP_EDW_RewardAwardDetail_DATA
            ADD
                        DeletedFlg  bit NULL;

            ALTER TABLE #TEMP_EDW_RewardAwardDetail_DATA
            ADD
                        ConvertedToCentralTime bit NULL;

            ALTER TABLE #TEMP_EDW_RewardAwardDetail_DATA
            ADD
                        TimeZone nvarchar ( 10) NULL;

            CREATE CLUSTERED INDEX temp_PI_EDW_RewardAwardDetail_IDs ON dbo.#TEMP_EDW_RewardAwardDetail_DATA (
            UserGUID
            , SiteGUID
            , HFitUserMpiNumber
            , RewardLevelGUID
            , AwardType
            , AwardDisplayName
            , RewardValue
            , ThresholdNumber
            , UserNotified
            , IsFulfilled
            , AccountID
            , AccountCD) 
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;

            IF @KeepData = 1

                BEGIN

                    PRINT 'KEEPING TEMP DATA IN TABLE TEMP_EDW_RewardAwardDetail_DATA';

                    IF EXISTS ( SELECT
                                       name
                                       FROM sys.tables
                                       WHERE
                                       name = 'TEMP_EDW_RewardAwardDetail_DATA') 

                        BEGIN

                            DROP TABLE
                                 TEMP_EDW_RewardAwardDetail_DATA;
                        END;

                    SELECT
                           * INTO
                                  TEMP_EDW_RewardAwardDetail_DATA
                           FROM #TEMP_EDW_RewardAwardDetail_DATA;

                    CREATE CLUSTERED INDEX temp_PI_EDW_RewardAwardDetail_IDs ON TEMP_EDW_RewardAwardDetail_DATA (
                    UserGUID
                    , SiteGUID
                    , HFitUserMpiNumber
                    , RewardLevelGUID
                    , AwardType
                    , AwardDisplayName
                    , RewardValue
                    , ThresholdNumber
                    , UserNotified
                    , IsFulfilled
                    , AccountID
                    , AccountCD) 
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM #TEMP_EDW_RewardAwardDetail_DATA) ;

/*------------------------------------------------------------------------------------------------------------------------------------------------------------------
            delete from DIM_EDW_RewardAwardDetail where Hashcode  = (select top 1 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode desc)
*/
            DECLARE
            @iIns AS int = 0;
            EXEC @iIns = proc_CT_RewardAwardDetail_AddNewRecs ;
            PRINT 'ROWS Inserted: ' + CAST ( @iIns AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iIns;

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------
*****************************************************************************************************************************************************************
					   --declare oldhash varbinary(8000) = (select top 1 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode); 
					   --declare tgthash varbinary(8000) = (select top 1 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode desc);
					   update #TEMP_EDW_RewardAwardDetail_DATA set hashcode = (select top 1 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode desc)
					   where hashcode =  (select top 1 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode) ;

            --Check to see if CURRENT records have differnet HASH codes and if so, update the staging table
*****************************************************************************************************************************************************************
*/
exec @Icnt = proc_CT_RewardAwardDetail_AddUpdatedRecs ;

 

            DECLARE
            @iUpdt AS int = @@ROWCOUNT;

            PRINT 'UPDATE Count: ' + CAST ( @iUpdt  AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @@ROWCOUNT;

/*----------------------------------------------------------------------------------------------------------------------------------------------------------------
****************************************************************************************************************************************************************
************************************************************************************************
FIND DELETED ROWS
delete from #TEMP_EDW_RewardAwardDetail_DATA where hashcode in (select top 5 hashcode from #TEMP_EDW_RewardAwardDetail_DATA order by hashcode) ;
******************************************************************************************************************************************************************
****************************************************************************************************************************************************************
*/
            DECLARE
            @idel AS int = @@ROWCOUNT;
		  exec @idel = proc_CT_RewardAwardDetail_AddNewRecs ;

            PRINT 'DELETED Count: ' + CAST ( @idel AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @@ROWCOUNT;

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( *) 
                                             FROM DIM_EDW_RewardAwardDetail) ;

            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
                   WHERE
                         RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
                   WHERE
                         RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM #TEMP_EDW_RewardAwardDetail_DATA) ;
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardAwardDetail';

            SET @STime = GETDATE () ;
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardAwardDetail' , @STime , @CNT_PulledRecords , 'U';
        END;

    SET NOCOUNT OFF;
END;

GO

PRINT 'Created proc_EDW_RewardAwardDetail';

GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






--proc_EDW_RewardAwardDetail
GO
PRINT 'Creating JOB job_EDW_GetStagingData_RewardAwardDetail';
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE
                      name = N'[Uncategorized (Local)]'
                  AND
                      category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF
               @@ERROR <> 0
            OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback;
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_RewardAwardDetail_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1;
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;

/****** Object:  Step [Load_EDW_RewardAwardDetail]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_RewardAwardDetail',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_RewardAwardDetail',
@database_name = @TGTDB,
@flags = 0;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_RewardAwardDetail',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
print 'Creating view_EDW_RewardAwardDetail_STAGED';
go
if exists (select name from sys.views where name = 'view_EDW_RewardAwardDetail_STAGED')
begin
    drop view view_EDW_RewardAwardDetail_STAGED;
end
go
create view view_EDW_RewardAwardDetail_STAGED
as 
SELECT [UserGUID]
      ,[SiteGUID]
      ,[HFitUserMpiNumber]
      ,[RewardLevelGUID]
      ,[AwardType]
      ,[AwardDisplayName]
      ,[RewardValue]
      ,[ThresholdNumber]
      ,[UserNotified]
      ,[IsFulfilled]
      ,[AccountID]
      ,[AccountCD]
      ,[ChangeType]
      ,[HashCode]
      ,[LastModifiedDate]
      ,[RowNbr]
      ,[DeletedFlg]
  FROM [STAGING_EDW_RewardAwardDetail]
GO
print 'Created view_EDW_RewardAwardDetail_STAGED';
go


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
-- use KenticoCMS_Prod1

GO
PRINT 'Creating view view_EDW_RewardUserLevel_CT';
PRINT '***** FROM: view_EDW_RewardUserLevel_CT.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE
                   name = 'view_EDW_RewardUserLevel_CT') 
    BEGIN
        DROP VIEW
             view_EDW_RewardUserLevel_CT;
    END;
GO

CREATE VIEW view_EDW_RewardUserLevel_CT
AS

/***************************************************************************************************
Changes:
04.17.2015 (WDM) Converted to provide Change Tracking

select top 1000 * from view_EDW_RewardUserLevel_CT

select count(*), HashCode from view_EDW_RewardUserLevel_CT group by HashCode having count(*) > 1

select count(*), 
       UserId
     , LevelCompletedDt
     , LevelName
     , SiteName
     , nodeguid
     , SiteGuid
     --, LevelHeader
     --, GroupHeadingText
     --, GroupHeadingDescription
from view_EDW_RewardUserLevel_CT 
group by UserId
     , LevelCompletedDt
     , LevelName
     , SiteName
     , nodeguid
     , SiteGuid
     --, LevelHeader
     --, GroupHeadingText
     --, GroupHeadingDescription
having count(*) > 1

***************************************************************************************************/

SELECT DISTINCT
       us.UserId
     , dl.LevelCompletedDt
     , RL_Joined.NodeName AS LevelName
     , s.SiteName
     , RL_Joined.nodeguid
     , s.SiteGuid
     , RL_Joined.LevelHeader
     , RL_Joined.GroupHeadingText
     , RL_Joined.GroupHeadingDescription
     , HASHBYTES ('sha1',
       ISNULL (CAST (us.UserId AS nvarchar (50)) , '--') + ISNULL (CAST (dl.LevelCompletedDt AS nvarchar (50)) , '--') + ISNULL (CAST (RL_Joined.NodeName AS nvarchar (250)) , '--') + ISNULL (CAST (s.SiteName AS nvarchar (250)) , '--') + ISNULL (CAST (RL_Joined.nodeguid AS nvarchar (50)) , '--') + ISNULL (CAST (s.SiteGuid AS nvarchar (50)) , '--') + ISNULL (CAST (RL_Joined.LevelHeader  AS nvarchar (250)) , '--') + ISNULL (CAST (LEFT (RL_Joined.GroupHeadingText, 1000) AS nvarchar (2000)) , '-') + ISNULL (CAST (LEFT (RL_Joined.GroupHeadingDescription, 2000) AS nvarchar (2000)) , '-') 
       ) AS HashCode
       , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
           HFit_RewardsUserLevelDetail AS dl
               INNER JOIN View_HFit_RewardLevel_Joined AS RL_Joined
                   ON
                      RL_Joined.NodeId = dl.LevelNodeId
				    AND RL_Joined.DocumentCulture= 'EN-US'
                 JOIN CMS_UserSite AS us
                   ON
                      us.UserId = dl.UserId
                 JOIN CMS_Site AS s
                   ON
                      s.SiteId = us.SiteId;

GO

PRINT 'Created view view_EDW_RewardUserLevel_CT';

GO 

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'FROM proc_EDW_RewardUserLevel.SQL';
PRINT 'Creating proc_EDW_RewardUserLevel';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_RewardUserLevel' )
    BEGIN
        PRINT 'Replacing proc_EDW_RewardUserLevel proc';
        DROP PROCEDURE
             proc_EDW_RewardUserLevel;
    END;
GO

/*
exec proc_EDW_RewardUserLevel 1,1,0
exec proc_EDW_RewardUserLevel 1,1,1
exec proc_EDW_RewardUserLevel 1,0,1

exec proc_EDW_RewardUserLevel 0,1,0
exec proc_EDW_RewardUserLevel 0,1,1
exec proc_EDW_RewardUserLevel 0,0,1
*/

CREATE PROCEDURE proc_EDW_RewardUserLevel
@Reloadall int = 0
, @TrackProgress int = 0
, @KeepData AS bit = 0
AS
BEGIN


    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardUserLevel';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;


    DECLARE
       @Synchronization_Version bigint = 0
       ,@CurrentDbVersion AS int
       ,@STime AS datetime
       ,@TgtView AS nvarchar ( 100 ) = 'view_EDW_RewardUserLevel_CT'
       ,@ExtractionDate AS datetime
       ,@ExtractedVersion AS int
       ,@ExtractedRowCnt AS int
       ,@EndTime AS datetime
       ,@CNT_PulledRecords AS int = 0
       ,@iCnt AS int = 0
       ,@RowNbr AS int = 0
       ,@StartTime AS datetime = GETDATE ( )
       ,@SVRName AS nvarchar ( 100 )
       ,@DBName AS nvarchar ( 100 ) = DB_NAME ( )
       ,@CNT_Insert AS int = 0
       ,@CNT_Update AS int = 0
       ,@CNT_Delete AS int = 0
       ,@CNT_StagingTable int = 0
       ,@VersionNBR int = 0;

    SET @SVRName = ( SELECT
                            @@SERVERNAME );

    SET @STime = GETDATE ( );

    DECLARE
       @RecordID AS uniqueidentifier = NEWID ( );
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardUserLevel' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                          FROM sys.tables
                          WHERE name = 'DIM_EDW_RewardUserLevel' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_EDW_RewardUserLevel for FULL reload.';
                        END;
                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    DROP TABLE
                         DIM_EDW_RewardUserLevel;
                END;
            ELSE
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading DIM_EDW_RewardUserLevel.';
                        END;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL EDW HA Data.';

                    SELECT
                           * INTO
                                  DIM_EDW_RewardUserLevel
                      FROM view_EDW_RewardUserLevel_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardUserLevel';

                    IF @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( * )
                                            FROM DIM_EDW_RewardUserLevel );
                            PRINT DB_NAME ( ) + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50 )) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( * )
                                                 FROM DIM_EDW_RewardUserLevel );
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @@ROWCOUNT;
                    SET @CNT_StagingTable = @CNT_PulledRecords;

                    IF NOT EXISTS ( SELECT
                                           name
                                      FROM sys.indexes
                                      WHERE name = 'PI_EDW_RewardUserLevel_IDs' )
                        BEGIN
                            IF @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_RewardUserLevel_IDs at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                                END;
                            CREATE CLUSTERED INDEX PI_EDW_RewardUserLevel_IDs ON dbo.DIM_EDW_RewardUserLevel ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                        END;

                    SET @ExtractionDate = GETDATE ( );
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( * )
                                               FROM DIM_EDW_RewardUserLevel );
                    --SET @TgtView = 'view_EDW_RewardUserLevel';
                    SET @EndTime = GETDATE ( );

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                           ,ExtractedVersion
                           ,CurrentDbVersion
                           ,ExtractedRowCnt
                           ,TgtView
                           ,StartTime
                           ,EndTime
                           ,SVRName
                           ,DBName
                           ,CNT_Insert
                           ,CNT_Update
                           ,CNT_delete
                           ,CNT_PulledRecords
                           ,CNT_StagingTable )
                    VALUES
                    (
                    @ExtractionDate , @ExtractedVersion , @CurrentDbVersion , @ExtractedRowCnt , @TgtView , @StartTime , @EndTime , @SVRName , @DBName , @CNT_Insert , @CNT_Update , @CNT_delete , @CNT_PulledRecords , @CNT_StagingTable );

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;

                END;
            -- SELECT * INTO [DIM_EDW_RewardUserLevel] FROM [view_EDW_RewardUserLevel_CT];
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserLevel';
            SET @STime = GETDATE ( );
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardUserLevel' , @STime , @CNT_PulledRecords , 'U';
            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                      FROM sys.tables
                      WHERE name = 'DIM_EDW_RewardUserLevel' )
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_RewardUserLevel was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            --IF NOT EXISTS ( SELECT
            --                name
            --                  FROM sys.indexes
            --                  WHERE name = 'PI_EDW_RewardUserLevel_IDs') 
            --    BEGIN
            --        IF @TrackProgress = 1
            --            BEGIN
            --                PRINT 'Adding INDEX PI_EDW_RewardUserLevel_IDs';
            --            END;
            --        CREATE NONCLUSTERED INDEX PI_EDW_RewardUserLevel_IDs ON dbo.DIM_EDW_RewardUserLevel ( ItemCreatedWhen ASC , ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC , HAUserQuestion_ItemModifiedWhen ASC , HAUserAnswers_ItemModifiedWhen ASC) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
            --    END;

            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_EDW_RewardUserLevel_IDs' )
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_RewardUserLevel_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_RewardUserLevel_IDs ON dbo.DIM_EDW_RewardUserLevel ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                          FROM tempdb.dbo.sysobjects
                          WHERE id = OBJECT_ID ( N'tempdb..#DIM_TEMPTBL_EDW_RewardUserLevel_DATA' ))

                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping #DIM_TEMPTBL_EDW_RewardUserLevel_DATA';
                        END;
                    DROP TABLE
                         #DIM_TEMPTBL_EDW_RewardUserLevel_DATA;
                END;

            /*******************************************************************************/

            SELECT
                   * INTO
                          #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
              FROM view_EDW_RewardUserLevel_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

            ALTER TABLE #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
            ADD
                        LastModifiedDate datetime NULL;
            ALTER TABLE #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
            ADD
                        RowNbr int NULL;
            ALTER TABLE #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
            ADD
                        DeletedFlg bit NULL;

            CREATE CLUSTERED INDEX temp_PI_EDW_RewardUserLevel_IDs ON dbo.#DIM_TEMPTBL_EDW_RewardUserLevel_DATA ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

            IF @KeepData = 1
                BEGIN
                    PRINT 'KEEPING TEMP DATA IN TABLE DIM_TEMPTBL_EDW_RewardUserLevel_DATA';
                    IF EXISTS ( SELECT
                                       name
                                  FROM sys.tables
                                  WHERE name = 'DIM_TEMPTBL_EDW_RewardUserLevel_DATA' )
                        BEGIN
                            DROP TABLE
                                 DIM_TEMPTBL_EDW_RewardUserLevel_DATA;
                        END;

                    SELECT
                           * INTO
                                  DIM_TEMPTBL_EDW_RewardUserLevel_DATA
                      FROM #DIM_TEMPTBL_EDW_RewardUserLevel_DATA;

                    CREATE CLUSTERED INDEX temp_PI_EDW_RewardUserLevel_IDs ON DIM_TEMPTBL_EDW_RewardUserLevel_DATA ( UserId , LevelCompletedDt , LevelName , SiteName , nodeguid , SiteGuid ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM #DIM_TEMPTBL_EDW_RewardUserLevel_DATA );

            --select * from #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
            --update #DIM_TEMPTBL_EDW_RewardUserLevel_DATA set AnsDocumentGuid = '1B8A2611-B0BF-4555-B609-56CC7D4EFC38' where AnsDocumentGuid = '001FBF56-C327-490F-AA15-4EB6F595D47A' and AnsPOints = 15
            --update #DIM_TEMPTBL_EDW_RewardUserLevel_DATA set AnsDocumentGuid = newid() where AnsDocumentGuid = 'C1D9949E-786D-42F7-8E31-0619D8ED60BD' and AnsPOints = 0
            WITH CTE (
                 UserId
                 ,LevelCompletedDt
                 ,LevelName
                 ,SiteName
                 ,nodeguid
                 ,SiteGuid )
                AS ( SELECT
                            UserId
                            ,LevelCompletedDt
                            ,LevelName
                            ,SiteName
                            ,nodeguid
                            ,SiteGuid
                       FROM #DIM_TEMPTBL_EDW_RewardUserLevel_DATA
                     EXCEPT
                     SELECT
                            UserId
                            ,LevelCompletedDt
                            ,LevelName
                            ,SiteName
                            ,nodeguid
                            ,SiteGuid
                       FROM DIM_EDW_RewardUserLevel
                       WHERE LastModifiedDate IS NULL )
                INSERT INTO dbo.DIM_EDW_RewardUserLevel (
                       UserId
                       ,LevelCompletedDt
                       ,LevelName
                       ,SiteName
                       ,nodeguid
                       ,SiteGuid
                       ,LevelHeader
                       ,GroupHeadingText
                       ,GroupHeadingDescription
                       ,HashCode
                       ,LastModifiedDate
                       ,DeletedFlg )
                SELECT
                       T.UserId
                       ,T.LevelCompletedDt
                       ,T.LevelName
                       ,T.SiteName
                       ,T.nodeguid
                       ,T.SiteGuid
                       ,T.LevelHeader
                       ,T.GroupHeadingText
                       ,T.GroupHeadingDescription
                       ,T.HashCode
                       ,NULL AS LastModifiedDate
                       ,NULL AS DeletedFlg
                  FROM
                       #DIM_TEMPTBL_EDW_RewardUserLevel_DATA AS T JOIN CTE AS S
                       ON
                       S.UserId = T.UserId
                   AND S.LevelCompletedDt = T.LevelCompletedDt
                   AND S.LevelName = T.LevelName
                   AND S.SiteName = T.SiteName
                   AND S.nodeguid = T.nodeguid
                   AND S.SiteGuid = T.SiteGuid;

            DECLARE
               @iIns AS int = @@ROWCOUNT;
            PRINT 'Inset Count: ' + CAST ( @iIns AS nvarchar ( 50 ));
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iIns;

            --Check to see if CURRENT records have differnet HASH codes and if so, update the staging table
            SET @iCnt = ( SELECT
                                 COUNT ( * )
                            FROM
                                 DIM_EDW_RewardUserLevel AS S JOIN #DIM_TEMPTBL_EDW_RewardUserLevel_DATA AS T
                                 ON
                                 S.UserId = T.UserId
                             AND S.LevelCompletedDt = T.LevelCompletedDt
                             AND S.LevelName = T.LevelName
                             AND S.SiteName = T.SiteName
                             AND S.nodeguid = T.nodeguid
                             AND S.SiteGuid = T.SiteGuid
                            WHERE S.HashCode != T.HashCode );
            IF @iCnt > 0
                BEGIN
                    UPDATE S
                      SET
                          S.UserId = T.UserId
                          ,S.LevelCompletedDt = T.LevelCompletedDt
                          ,S.LevelName = T.LevelName
                          ,S.SiteName = T.SiteName
                          ,S.nodeguid = T.nodeguid
                          ,S.SiteGuid = T.SiteGuid
                          ,S.LevelHeader = T.LevelHeader
                          ,S.GroupHeadingText = T.GroupHeadingText
                          ,S.GroupHeadingDescription = T.GroupHeadingDescription
                          ,S.HashCode = T.HashCode
                          ,S.LastModifiedDate = GETDATE ( )
                          ,S.DeletedFlg = NULL
                          ,S.ConvertedToCentralTime = NULL
                      FROM DIM_EDW_RewardUserLevel AS S JOIN #DIM_TEMPTBL_EDW_RewardUserLevel_DATA AS T
                           ON
                           S.UserId = T.UserId
                       AND S.LevelCompletedDt = T.LevelCompletedDt
                       AND S.LevelName = T.LevelName
                       AND S.SiteName = T.SiteName
                       AND S.nodeguid = T.nodeguid
                       AND S.SiteGuid = T.SiteGuid
                      WHERE
                            T.HashCode != S.HashCode;

                    DECLARE
                       @iUpdt AS int = @@ROWCOUNT;
                    PRINT 'Update Count: ' + CAST ( @iUpdt AS nvarchar ( 50 ));
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdt;
                END;

/************************************************
		  FIND DELETED ROWS
		  ************************************************/

            WITH CTE (
                 UserId
                 ,LevelCompletedDt
                 ,LevelName
                 ,SiteName
                 ,nodeguid
                 ,SiteGuid )
                AS ( SELECT
                            UserId
                            ,LevelCompletedDt
                            ,LevelName
                            ,SiteName
                            ,nodeguid
                            ,SiteGuid
                       FROM DIM_EDW_RewardUserLevel
                     EXCEPT
                     SELECT
                            UserId
                            ,LevelCompletedDt
                            ,LevelName
                            ,SiteName
                            ,nodeguid
                            ,SiteGuid
                       FROM #DIM_TEMPTBL_EDW_RewardUserLevel_DATA )
                UPDATE S
                  SET
                      S.DeletedFlg = 1
                  FROM CTE AS T JOIN DIM_EDW_RewardUserLevel AS S
                       ON
                       S.UserId = T.UserId
                   AND S.LevelCompletedDt = T.LevelCompletedDt
                   AND S.LevelName = T.LevelName
                   AND S.SiteName = T.SiteName
                   AND S.nodeguid = T.nodeguid
                   AND S.SiteGuid = T.SiteGuid;

            DECLARE
               @iDel AS int = @@ROWCOUNT;
            PRINT 'Update Count: ' + CAST ( @iDel AS nvarchar ( 50 ));
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDel;

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( * )
                                        FROM DIM_EDW_RewardUserLevel );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
              WHERE
                    RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM #DIM_TEMPTBL_EDW_RewardUserLevel_DATA );
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardUserLevel';
            SET @STime = GETDATE ( );
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardUserLevel' , @STime , @CNT_PulledRecords , 'U';

        END;
END;

GO
PRINT 'Created proc_EDW_RewardUserLevel';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






--proc_EDW_RewardUserLevel
GO
PRINT 'Creating JOB job_EDW_GetStagingData_RewardUserLevel';
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE
                      name = N'[Uncategorized (Local)]'
                  AND
                      category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF
               @@ERROR <> 0
            OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback;
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_RewardUserLevel_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1;
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;

/****** Object:  Step [Load_EDW_RewardUserLevel]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_RewardUserLevel',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_RewardUserLevel',
@database_name = @TGTDB,
@flags = 0;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_RewardUserLevel',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Creating view_EDW_RewardUserLevel_STAGED';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE
                        name = 'view_EDW_RewardUserLevel_STAGED') 
    BEGIN
        DROP VIEW
             view_EDW_RewardUserLevel_STAGED;
    END;
GO

CREATE VIEW view_EDW_RewardUserLevel_STAGED
AS SELECT
 [UserId]
      ,[LevelCompletedDt]
      ,[LevelName]
      ,[SiteName]
      ,[nodeguid]
      ,[SiteGuid]
      ,[LevelHeader]
      ,[GroupHeadingText]
      ,[GroupHeadingDescription]
          FROM dbo.STAGING_EDW_RewardUserLevel;
GO

PRINT 'Created view_EDW_RewardUserLevel_STAGED';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1

print ('Processing: view_EDW_Coaches_CT ') ;
go

if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_Coaches_CT')
BEGIN
	drop view view_EDW_Coaches_CT ;
END
GO

/****************************************************
WDM Verified last mod date available to EDW 9.10.2014

select count(*) from view_EDW_Coaches_CT
select * from view_EDW_Coaches_CT

select count(*), HashCode
from view_EDW_Coaches_CT
group by HashCode 
having count(*) > 1

select * from view_EDW_Coaches_CT
where UserGuid in ('92281FC6-565B-4657-BBC0-D250BE87F59A','DC60654C-8796-4789-B0A0-FC359215BB7B')

select count(*), 
    UserGUID
    ,SiteGUID
    ,AccountID
    ,AccountCD
    ,CoachID
    ,email   
from [view_EDW_Coaches_CT]
group by 
UserGUID
   ,SiteGUID
   ,AccountID
   ,AccountCD
   ,CoachID
   ,email   
having count(*) > 1

****************************************************/
CREATE VIEW [dbo].[view_EDW_Coaches_CT]

AS

SELECT distinct
    cu.UserGUID
   ,cs.SiteGUID
   ,HFA.AccountID
   ,HFA.AccountCD
   ,CoachID
   ,hfc.LastName
   ,hfc.FirstName
   ,hfc.StartDate
   ,hfc.Phone
   ,hfc.email
   ,hfc.Supervisor
   ,hfc.SuperCoach
   ,hfc.MaxParticipants
   ,hfc.Inactive
   ,hfc.MaxRiskLevel
   ,hfc.Locked
   ,hfc.TimeLocked
   ,hfc.terminated
   ,hfc.APMaxParticipants
   ,hfc.RNMaxParticipants
   ,hfc.RNPMaxParticipants
   ,hfc.Change_Type
   ,hfc.Last_Update_Dt
,hashbytes ('sha1',
    isnull(cast(cu.UserGUID as nvarchar(100)),'-')
   + isnull(cast(cs.SiteGUID as nvarchar(100)),'-')
   + isnull(cast(HFA.AccountID as nvarchar(100)),'-')
   + isnull(cast(HFA.AccountCD as nvarchar(100)),'-')
   + isnull(cast(CoachID as nvarchar(100)),'-')
   + isnull(cast(hfc.LastName as nvarchar(250)),'-')
   + isnull(cast(hfc.FirstName as nvarchar(250)),'-')
   + isnull(cast(hfc.StartDate as nvarchar(100)),'-')
   + isnull(cast(hfc.Phone as nvarchar(100)),'-')
   + isnull(cast(hfc.email as nvarchar(250)),'-')
   + isnull(cast(hfc.Supervisor as nvarchar(100)),'-')
   + isnull(cast(hfc.SuperCoach as nvarchar(100)),'-')
   + isnull(cast(hfc.MaxParticipants as nvarchar(100)),'-')
   + isnull(cast(hfc.Inactive as nvarchar(100)),'-')
   + isnull(cast(hfc.MaxRiskLevel as nvarchar(100)),'-')
   + isnull(cast(hfc.Locked as nvarchar(100)),'-')
   + isnull(cast(hfc.TimeLocked as nvarchar(100)),'-')
   + isnull(cast(hfc.terminated as nvarchar(100)),'-')
   + isnull(cast(hfc.APMaxParticipants as nvarchar(100)),'-')
   + isnull(cast(hfc.RNMaxParticipants as nvarchar(100)),'-')
   + isnull(cast(hfc.RNPMaxParticipants as nvarchar(100)),'-')
   + isnull(cast(hfc.Last_Update_Dt as nvarchar(100)),'-')
) as HashCode
, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
    dbo.HFit_Coaches AS HFC
LEFT OUTER JOIN dbo.CMS_User AS CU ON hfc.KenticoUserID = cu.UserID
LEFT OUTER JOIN dbo.CMS_UserSite AS CUS ON cu.userid = cus.UserID
LEFT OUTER JOIN dbo.CMS_Site AS CS ON CS.SiteID = CUS.SiteID
LEFT OUTER JOIN dbo.HFit_Account AS HFA ON cs.SiteID = hfa.SiteID

GO


  --  
  --  
GO 
print('***** FROM: view_EDW_Coaches_CT.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'FROM proc_EDW_Coaches.SQL';
PRINT 'Creating proc_EDW_Coaches';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE
              name = 'proc_EDW_Coaches' )
    BEGIN
        PRINT 'Replacing proc_EDW_Coaches proc';
        DROP PROCEDURE
             proc_EDW_Coaches;
    END;
GO

/*
exec proc_EDW_Coaches 1,1,0
exec proc_EDW_Coaches 1,1,1
exec proc_EDW_Coaches 1,0,1

exec proc_EDW_Coaches 0,1,0
exec proc_EDW_Coaches 0,1,1
exec proc_EDW_Coaches 0,0,1
*/

CREATE PROCEDURE proc_EDW_Coaches
@Reloadall int = 0
, @TrackProgress int = 0
, @KeepData AS bit = 0
AS
BEGIN
set nocount on ;
    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_Coaches';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

    DECLARE
       @Synchronization_Version bigint = 0
       ,@CurrentDbVersion AS int
       ,@STime AS datetime
       ,@TgtView AS nvarchar ( 100 ) = 'view_EDW_Coaches_CT'
       ,@ExtractionDate AS datetime
       ,@ExtractedVersion AS int
       ,@ExtractedRowCnt AS int
       ,@EndTime AS datetime
       ,@CNT_PulledRecords AS int = 0
       ,@iCnt AS int = 0
       ,@RowNbr AS int = 0
       ,@StartTime AS datetime = GETDATE ( )
       ,@SVRName AS nvarchar ( 100 )
       ,@DBName AS nvarchar ( 100 ) = DB_NAME ( )
       ,@CNT_Insert AS int = 0
       ,@CNT_Update AS int = 0
       ,@CNT_Delete AS int = 0
       ,@CNT_StagingTable int = 0
       ,@VersionNBR int = 0;

    SET @SVRName = ( SELECT
                            @@SERVERNAME );

    SET @STime = GETDATE ( );

    DECLARE
       @RecordID AS uniqueidentifier = NEWID ( );
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_Coaches' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                          FROM sys.tables
                          WHERE
                          name = 'DIM_EDW_Coaches' )
                BEGIN
                    IF
                    @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_EDW_Coaches for FULL reload.';
                        END;
                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    DROP TABLE
                         DIM_EDW_Coaches;
                END;
            ELSE
                BEGIN
                    IF
                    @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading DIM_EDW_Coaches.';
                        END;
                END;
            IF
            @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL Coaches.';

                    SELECT
                           * INTO
                                  DIM_EDW_Coaches
                      FROM view_EDW_Coaches_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_Coaches';

                    IF
                    @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( * )
                                            FROM DIM_EDW_Coaches );
                            PRINT DB_NAME ( ) + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50 )) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( * )
                                                 FROM DIM_EDW_Coaches );
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                      FROM sys.indexes
                                      WHERE
                                      name = 'PI_EDW_Coaches_IDs' )
                        BEGIN
                            IF
                            @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_Coaches_IDs at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                                END;
                            CREATE CLUSTERED INDEX PI_EDW_Coaches_IDs ON dbo.DIM_EDW_Coaches (
                            UserGUID
                            , SiteGUID
                            , AccountID
                            , AccountCD
                            , CoachID
                            , email
                            )
                            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                        END;

                    SET @ExtractionDate = GETDATE ( );
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( * )
                                               FROM DIM_EDW_Coaches );
                    --SET @TgtView = 'view_EDW_Coaches';
                    SET @EndTime = GETDATE ( );

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                           ,ExtractedVersion
                           ,CurrentDbVersion
                           ,ExtractedRowCnt
                           ,TgtView
                           ,StartTime
                           ,EndTime
                           ,SVRName
                           ,DBName
                           ,CNT_Insert
                           ,CNT_Update
                           ,CNT_delete
                           ,CNT_PulledRecords
                           ,CNT_StagingTable
                    )
                    VALUES
                    (
                    @ExtractionDate ,
                    @ExtractedVersion ,
                    @CurrentDbVersion ,
                    @ExtractedRowCnt ,
                    @TgtView ,
                    @StartTime ,
                    @EndTime ,
                    @SVRName ,
                    @DBName ,
                    @CNT_Insert ,
                    @CNT_Update ,
                    @CNT_delete ,
                    @CNT_PulledRecords ,
                    @CNT_StagingTable );

                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @@ROWCOUNT;

                    IF
                    @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;

                END;
            -- SELECT * INTO [DIM_EDW_Coaches] FROM [view_EDW_Coaches_CT];
            IF
            @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF
            @TrackProgress = 1
                BEGIN
                    PRINT
                    'Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Coaches';
            SET @STime = GETDATE ( );
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_Coaches' , @STime , @CNT_PulledRecords , 'U';
	   set nocount off ;
            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                      FROM sys.tables
                      WHERE
                      name = 'DIM_EDW_Coaches' )
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_Coaches was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            --IF NOT EXISTS ( SELECT
            --                name
            --                  FROM sys.indexes
            --                  WHERE name = 'PI_EDW_Coaches_IDs') 
            --    BEGIN
            --        IF @TrackProgress = 1
            --            BEGIN
            --                PRINT 'Adding INDEX PI_EDW_Coaches_IDs';
            --            END;
            --        CREATE NONCLUSTERED INDEX PI_EDW_Coaches_IDs ON dbo.DIM_EDW_Coaches ( ItemCreatedWhen ASC , ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC , HAUserQuestion_ItemModifiedWhen ASC , HAUserAnswers_ItemModifiedWhen ASC) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
            --    END;

            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE
                              name = 'PI_EDW_Coaches_IDs' )
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_Coaches_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_Coaches_IDs ON dbo.DIM_EDW_Coaches (
                    UserGUID
                    , SiteGUID
                    , AccountID
                    , AccountCD
                    , CoachID
                    , email )
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                          FROM tempdb.dbo.sysobjects
                          WHERE
                          id = OBJECT_ID ( N'tempdb..##DIM_TEMPTBL_EDW_Coaches_DATA' ))

                BEGIN
                    IF
                    @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping ##DIM_TEMPTBL_EDW_Coaches_DATA';
                        END;
                    DROP TABLE
                         ##DIM_TEMPTBL_EDW_Coaches_DATA;
                END;

            /*******************************************************************************/

            SELECT
                   * INTO
                          ##DIM_TEMPTBL_EDW_Coaches_DATA
              FROM view_EDW_Coaches_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

            ALTER TABLE ##DIM_TEMPTBL_EDW_Coaches_DATA
            ADD
                        LastModifiedDate datetime NULL;
            ALTER TABLE ##DIM_TEMPTBL_EDW_Coaches_DATA
            ADD
                        RowNbr  int NULL;
            ALTER TABLE ##DIM_TEMPTBL_EDW_Coaches_DATA
            ADD
                        DeletedFlg  bit NULL;

            CREATE CLUSTERED INDEX temp_PI_EDW_Coaches_IDs ON dbo.##DIM_TEMPTBL_EDW_Coaches_DATA (
            UserGUID
            , SiteGUID
            , AccountID
            , AccountCD
            , CoachID
            , email )
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

            IF @KeepData = 1
                BEGIN
                    PRINT 'KEEPING TEMP DATA IN TABLE DIM_TEMPTBL_EDW_Coaches_DATA';
                    IF EXISTS ( SELECT
                                       name
                                  FROM sys.tables
                                  WHERE
                                  name = 'DIM_TEMPTBL_EDW_Coaches_DATA' )
                        BEGIN
                            DROP TABLE
                                 DIM_TEMPTBL_EDW_Coaches_DATA;
                        END;

                    SELECT
                           * INTO
                                  DIM_TEMPTBL_EDW_Coaches_DATA
                      FROM ##DIM_TEMPTBL_EDW_Coaches_DATA;

                    CREATE CLUSTERED INDEX temp_PI_EDW_Coaches_IDs ON DIM_TEMPTBL_EDW_Coaches_DATA (
                    UserGUID
                    , SiteGUID
                    , AccountID
                    , AccountCD
                    , CoachID
                    , email )
                    WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##DIM_TEMPTBL_EDW_Coaches_DATA );

/************************************************/
declare @iInserts as int = 0 ;
exec @iInserts = proc_CT_Coaching_AddNewRecs ;
EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iInserts;
/************************************************/
declare @iUpdates as int = 0 
exec @iUpdates = proc_CT_Coaching_AddUpdatedRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdates;
/************************************************/
declare @idels as int = 0 ;
exec @iUpdates = proc_CT_Coaching_AddDeletedRecs ;
/************************************************/

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( * )
                                        FROM DIM_EDW_Coaches );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
              WHERE
                    RowNbr = @RowNbr;

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @idels;
            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##DIM_TEMPTBL_EDW_Coaches_DATA );

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_Coaches';
            SET @STime = GETDATE ( );
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_Coaches' , @STime , @CNT_PulledRecords , 'U';
set nocount off ;
        END;
END;

GO
PRINT 'Created proc_EDW_Coaches';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
print ('Creating view_EDW_Coaches_STAGED');
go
if exists (select name from sys.views where name = 'view_EDW_Coaches_STAGED')
begin
    drop view view_EDW_Coaches_STAGED;
end
go

create view view_EDW_Coaches_STAGED
as
SELECT [UserGUID]
      ,[SiteGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[CoachID]
      ,[LastName]
      ,[FirstName]
      ,[StartDate]
      ,[Phone]
      ,[email]
      ,[Supervisor]
      ,[SuperCoach]
      ,[MaxParticipants]
      ,[Inactive]
      ,[MaxRiskLevel]
      ,[Locked]
      ,[TimeLocked]
      ,[terminated]
      ,[APMaxParticipants]
      ,[RNMaxParticipants]
      ,[RNPMaxParticipants]
      ,[Change_Type]
      ,[Last_Update_Dt]
      ,[HashCode]
      ,[LastModifiedDate]
      ,[RowNbr]
      ,[DeletedFlg]
  FROM [dbo].[STAGING_EDW_Coaches]
GO
print ('Created view_EDW_Coaches_STAGED');
go


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
print('***** FROM: view_EDW_CoachingDetail.sql'); 
go

print ('Processing: view_EDW_CoachingDetail ') ;
go

if exists(select NAME from sys.indexes where NAME = 'CI2_View_CMS_Tree_Joined_Regular')
BEGIN
    print ('ANALYZING index CI2_View_CMS_Tree_Joined_Regular');
	drop index View_CMS_Tree_Joined_Regular.CI2_View_CMS_Tree_Joined_Regular;
END
GO

if not exists(select NAME from sys.indexes where NAME = 'CI2_View_CMS_Tree_Joined_Regular')
BEGIN
    print ('Updating index CI2_View_CMS_Tree_Joined_Regular');

	SET ARITHABORT ON
	SET CONCAT_NULL_YIELDS_NULL ON
	SET QUOTED_IDENTIFIER ON
	SET ANSI_NULLS ON
	SET ANSI_PADDING ON
	SET ANSI_WARNINGS ON
	SET NUMERIC_ROUNDABORT OFF

	CREATE NONCLUSTERED INDEX [CI2_View_CMS_Tree_Joined_Regular] ON [dbo].[View_CMS_Tree_Joined_Regular]
(
	[ClassName] ASC,
	[DocumentForeignKeyValue],
	[DocumentCulture] ASC
)
INCLUDE ( 	[NodeID], [NodeGUID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

END
GO

-- select count(*) from view_EDW_CoachingDetail
if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_CoachingDetail')
BEGIN
	drop view view_EDW_CoachingDetail ;
END
GO

--GRANT SELECT
--	ON [dbo].[[view_EDW_CoachingDetail]]
--	TO [EDWReader_PRD]
--GO

/* TEST Queries
select * from [view_EDW_CoachingDetail]
select * from [view_EDW_CoachingDetail] where CloseReasonLKPID != 0
select count(*) from [view_EDW_CoachingDetail]
*/

create VIEW [dbo].[view_EDW_CoachingDetail]
AS
--********************************************************************************************
--8/7/2014 - added and commented out DocumentGuid in case needed later
--8/8/2014 - Generated corrected view in DEV (WDM)
-- Verified last mod date available to EDW 9.10.2014
-- 01.02.2014 (WDM) added column HFUG.CloseReasonLKPID in order to satisfy Story #47923
-- 01.06.2014 (WDM) Tested with team B and found that the data was being returned. Stipulating that 
--					we converted the inner join to left outer join dbo.HFit_GoalOutcome. This 
--					allows data to be returned with the meaning that if NULL HFGO.EvaluationDate
--					is returned, the GOAL may exist without any input/update from the coach or
--					PPT
-- 01.07.2014 (WDM) This also takes care of 47976
--********************************************************************************************
	SELECT	DISTINCT
		HFUG.ItemID
		, HFUG.ItemGUID
		, GJ.GoalID
		, HFUG.UserID
		, cu.UserGUID
		, cus.HFitUserMpiNumber
		, cs.SiteGUID
		, hfa.AccountID
		, hfa.AccountCD
		, hfa.AccountName
		, HFUG.IsCreatedByCoach
		, HFUG.BaselineAmount
		, HFUG.GoalAmount
		, Null As DocumentID
		, HFUG.GoalStatusLKPID
		, HFLGS.GoalStatusLKPName
		, cast(HFUG.EvaluationStartDate as datetime) as EvaluationStartDate
		, cast(HFUG.EvaluationEndDate as datetime) as EvaluationEndDate
		, cast(HFUG.GoalStartDate as datetime) as GoalStartDate
		, HFUG.CoachDescription
		, cast(HFGO.EvaluationDate as datetime) as EvaluationDate
		, HFGO.Passed
		, cast(HFGO.WeekendDate as datetime) as WeekendDate
		, CASE	WHEN CAST(HFUG.ItemCreatedWhen AS DATE) = CAST(HFUG.ItemModifiedWhen AS DATE)
				THEN 'I'
				ELSE 'U'
			END AS ChangeType
		, cast(HFUG.ItemCreatedWhen as datetime) as ItemCreatedWhen
		, cast(HFUG.ItemModifiedWhen as datetime) as ItemModifiedWhen
		, GJ.NodeGUID
		, HFUG.CloseReasonLKPID
		, GRC.CloseReason

	FROM
		dbo.HFit_UserGoal AS HFUG WITH ( NOLOCK )
	INNER JOIN (
					SELECT
						VHFGJ.GoalID
						, VHFGJ.NodeID
						, VHFGJ.NodeGUID
						, VHFGJ.DocumentCulture
						, VHFGJ.DocumentGuid
						, VHFGJ.DocumentModifiedWhen	--WDM added 9.10.2014
					FROM
						dbo.View_HFit_Goal_Joined AS VHFGJ WITH ( NOLOCK )
					UNION ALL
					SELECT
						VHFTGJ.GoalID
						, VHFTGJ.NodeID
						, VHFTGJ.NodeGUID
						, VHFTGJ.DocumentCulture
						, VHFTGJ.DocumentGuid
						, VHFTGJ.DocumentModifiedWhen	--WDM added 9.10.2014
					FROM
						dbo.View_HFit_Tobacco_Goal_Joined AS VHFTGJ WITH ( NOLOCK )
				) AS GJ ON hfug.NodeID = gj.NodeID and GJ.DocumentCulture = 'en-us'		
	left outer join dbo.HFit_GoalOutcome AS HFGO WITH ( NOLOCK ) ON HFUG.ItemID = HFGO.UserGoalItemID	
	INNER JOIN dbo.HFit_LKP_GoalStatus AS HFLGS WITH ( NOLOCK ) ON HFUG.GoalStatusLKPID = HFLGS.GoalStatusLKPID	
	INNER JOIN dbo.CMS_User AS CU WITH ( NOLOCK ) ON HFUG.UserID = cu.UserID
	INNER JOIN dbo.CMS_UserSettings AS CUS WITH ( NOLOCK ) ON CU.UserGUID = CUS.UserSettingsUserGUID
	INNER JOIN dbo.CMS_UserSite AS CUS2 WITH ( NOLOCK ) ON cu.UserID = CUS2.UserID	
	INNER JOIN dbo.CMS_Site AS CS WITH ( NOLOCK ) ON CUS2.SiteID = CS.SiteID
	INNER JOIN dbo.HFit_Account AS HFA WITH ( NOLOCK ) ON cs.SiteID = hfa.SiteID
	left outer join HFit_LKP_GoalCloseReason as GRC on GRC.CloseReasonID = HFUG.CloseReasonLKPID
GO

  --  
  --  
GO 
print('***** Created: view_EDW_CoachingDetail'); 
GO 

--Testing History
--1.1.2015: WDM Tested table creation, data entry, and view join
--Testing Criteria
--select * from HFit_LKP_GoalCloseReason
--select * from view_EDW_CoachingDetail
--select * from view_EDW_CoachingDetail where userid in (13470, 107, 13299) and CloseReasonLKPID != 0 
--select * from view_EDW_CoachingDetail where UserGUID = '9C7F1657-8568-4D5D-A797-C6AEEA86834F'
--select * from view_EDW_CoachingDetail where EvaluationDate is null 
--select * from view_EDW_CoachingDetail  where HFitUserMpiNumber in (6238677) and CloseReasonLKPID != 0 
--select * from HFit_UserGoal where UserGUID = '9C7F1657-8568-4D5D-A797-C6AEEA86834F'
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1


GO
PRINT '***** FROM: view_EDW_CoachingDetail_CT.sql';
GO

PRINT 'Processing: view_EDW_CoachingDetail_CT ';
GO

--if exists(select NAME from sys.indexes where NAME = 'CI2_View_CMS_Tree_Joined_Regular')
--BEGIN
--    print ('ANALYZING index CI2_View_CMS_Tree_Joined_Regular');
--	drop index View_CMS_Tree_Joined_Regular.CI2_View_CMS_Tree_Joined_Regular;
--END
--GO

--if not exists(select NAME from sys.indexes where NAME = 'CI2_View_CMS_Tree_Joined_Regular')
--BEGIN
--    print ('Updating index CI2_View_CMS_Tree_Joined_Regular');

--	SET ARITHABORT ON
--	SET CONCAT_NULL_YIELDS_NULL ON
--	SET QUOTED_IDENTIFIER ON
--	SET ANSI_NULLS ON
--	SET ANSI_PADDING ON
--	SET ANSI_WARNINGS ON
--	SET NUMERIC_ROUNDABORT OFF

--	CREATE NONCLUSTERED INDEX [CI2_View_CMS_Tree_Joined_Regular] ON [dbo].[View_CMS_Tree_Joined_Regular]
--(
--	[ClassName] ASC,
--	[DocumentForeignKeyValue],
--	[DocumentCulture] ASC
--)
--INCLUDE ( 	[NodeID], [NodeGUID]) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

--END
--GO

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
                  WHERE
                  TABLE_NAME = 'view_EDW_CoachingDetail_CT') 
    BEGIN
        DROP VIEW
             view_EDW_CoachingDetail_CT;
    END;
GO

--GRANT SELECT
--	ON [dbo].[[view_EDW_CoachingDetail_CT]]
--	TO [EDWReader_PRD]
--GO

/* TEST Queries
select * from [view_EDW_CoachingDetail_CT]
select * from [view_EDW_CoachingDetail_CT] where CloseReasonLKPID != 0
select count(*) from [view_EDW_CoachingDetail_CT]
*/

CREATE VIEW dbo.view_EDW_CoachingDetail_CT
AS

--********************************************************************************************

/*
select count(*),
	   ItemID
	   , ItemGUID
	   , GoalID
	   , UserID
	   , UserGUID
	   , HFitUserMpiNumber
	   , SiteGUID
	   , AccountID
	   , AccountCD
	   --, IsCreatedByCoach
	   , WeekendDate
	   , NodeGUID		
from [view_EDW_CoachingDetail_CT]
group by 
	   ItemID
	   , ItemGUID
	   , GoalID
	   , UserID
	   , UserGUID
	   , HFitUserMpiNumber
	   , SiteGUID
	   , AccountID
	   , AccountCD
	   --, IsCreatedByCoach
	   , WeekendDate
	   , NodeGUID		
having count(*) > 1
*/

SELECT	DISTINCT
       HFUG.ItemID
     , HFUG.ItemGUID
     , GJ.GoalID
     , HFUG.UserID
     , cu.UserGUID
     , cus.HFitUserMpiNumber
     , cs.SiteGUID
     , hfa.AccountID
     , hfa.AccountCD
     , hfa.AccountName
     , HFUG.IsCreatedByCoach
     , HFUG.BaselineAmount
     , HFUG.GoalAmount
     , NULL AS DocumentID
     , HFUG.GoalStatusLKPID
     , HFLGS.GoalStatusLKPName
     , HFUG.EvaluationStartDate
     , HFUG.EvaluationEndDate
     , HFUG.GoalStartDate
     , HFUG.CoachDescription
     , HFGO.EvaluationDate
     , HFGO.Passed
     , HFGO.WeekendDate
     , CASE
           WHEN
       CAST (HFUG.ItemCreatedWhen AS date) = CAST (HFUG.ItemModifiedWhen AS date) 
               THEN 'I'
           ELSE 'U'
       END AS ChangeType
     , HFUG.ItemCreatedWhen
     , HFUG.ItemModifiedWhen
     , GJ.NodeGUID
     , HFUG.CloseReasonLKPID
     , GRC.CloseReason
     , HASHBYTES ('sha1',
		  ISNULL (CAST (HFUG.ItemID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.ItemGUID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( GJ.GoalID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.UserID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( cu.UserGUID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( cus.HFitUserMpiNumber AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( cs.SiteGUID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( hfa.AccountID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( hfa.AccountCD AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( hfa.AccountName AS nvarchar (500)) , '-') 
		  + ISNULL (CAST ( HFUG.IsCreatedByCoach AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.BaselineAmount AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.GoalAmount AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.GoalStatusLKPID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFLGS.GoalStatusLKPName AS nvarchar (500)) , '-') 
		  + ISNULL (CAST ( HFUG.EvaluationStartDate AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.EvaluationEndDate AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.GoalStartDate AS nvarchar (100)) , '-') 
		  + ISNULL (LEFT (HFUG.CoachDescription, 1000) , '-') 
		  + ISNULL (CAST ( HFGO.EvaluationDate AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFGO.Passed AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFGO.WeekendDate AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.ItemCreatedWhen AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.ItemModifiedWhen AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( GJ.NodeGUID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( HFUG.CloseReasonLKPID AS nvarchar (100)) , '-') 
		  + ISNULL (CAST ( GRC.CloseReason AS nvarchar (100)) , '-') 
       ) AS HashCode
, @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  
       FROM dbo.HFit_UserGoal AS HFUG WITH (NOLOCK) 
            INNER JOIN(
            SELECT
                   VHFGJ.GoalID
                 , VHFGJ.NodeID
                 , VHFGJ.NodeGUID
                 , VHFGJ.DocumentCulture
                 , VHFGJ.DocumentGuid
                 , VHFGJ.DocumentModifiedWhen	--WDM added 9.10.2014
                   FROM dbo.View_HFit_Goal_Joined AS VHFGJ WITH (NOLOCK) 
            UNION ALL
            SELECT
                   VHFTGJ.GoalID
                 , VHFTGJ.NodeID
                 , VHFTGJ.NodeGUID
                 , VHFTGJ.DocumentCulture
                 , VHFTGJ.DocumentGuid
                 , VHFTGJ.DocumentModifiedWhen	--WDM added 9.10.2014
                   FROM dbo.View_HFit_Tobacco_Goal_Joined AS VHFTGJ WITH (NOLOCK))AS GJ
                    ON
       hfug.NodeID = gj.NodeID
   AND GJ.DocumentCulture = 'en-us'
            LEFT OUTER JOIN dbo.HFit_GoalOutcome AS HFGO WITH (NOLOCK) 
                    ON HFUG.ItemID = HFGO.UserGoalItemID
            INNER JOIN dbo.HFit_LKP_GoalStatus AS HFLGS WITH (NOLOCK) 
                    ON HFUG.GoalStatusLKPID = HFLGS.GoalStatusLKPID
            INNER JOIN dbo.CMS_User AS CU WITH (NOLOCK) 
                    ON HFUG.UserID = cu.UserID
            INNER JOIN dbo.CMS_UserSettings AS CUS WITH (NOLOCK) 
                    ON CU.UserGUID = CUS.UserSettingsUserGUID
            INNER JOIN dbo.CMS_UserSite AS CUS2 WITH (NOLOCK) 
                    ON cu.UserID = CUS2.UserID
            INNER JOIN dbo.CMS_Site AS CS WITH (NOLOCK) 
                    ON CUS2.SiteID = CS.SiteID
            INNER JOIN dbo.HFit_Account AS HFA WITH (NOLOCK) 
                    ON cs.SiteID = hfa.SiteID
            LEFT OUTER JOIN HFit_LKP_GoalCloseReason AS GRC
                    ON GRC.CloseReasonID = HFUG.CloseReasonLKPID;
GO

--  
--  
GO
PRINT '***** Created: view_EDW_CoachingDetail_CT';
GO

--Testing History
--1.1.2015: WDM Tested table creation, data entry, and view join
--Testing Criteria
--select * from HFit_LKP_GoalCloseReason
--select * from view_EDW_CoachingDetail_CT
--select * from view_EDW_CoachingDetail_CT where userid in (13470, 107, 13299) and CloseReasonLKPID != 0 
--select * from view_EDW_CoachingDetail_CT where UserGUID = '9C7F1657-8568-4D5D-A797-C6AEEA86834F'
--select * from view_EDW_CoachingDetail_CT where EvaluationDate is null 
--select * from view_EDW_CoachingDetail_CT  where HFitUserMpiNumber in (6238677) and CloseReasonLKPID != 0 
--select * from HFit_UserGoal where UserGUID = '9C7F1657-8568-4D5D-A797-C6AEEA86834F'
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go

--use KenticoCMS_Prod1

/*
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'FROM proc_EDW_CoachingDetail.SQL';
PRINT 'Creating proc_EDW_CoachingDetail';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_CoachingDetail' )
    BEGIN
        PRINT 'Replacing proc_EDW_CoachingDetail proc';
        DROP PROCEDURE
             proc_EDW_CoachingDetail;
    END;
GO

/*
exec proc_EDW_CoachingDetail 1,1,0
exec proc_EDW_CoachingDetail 1,1,1
exec proc_EDW_CoachingDetail 1,0,1

exec proc_EDW_CoachingDetail 0,1,0
exec proc_EDW_CoachingDetail 0,1,1
exec proc_EDW_CoachingDetail 0,0,1
*/

CREATE PROCEDURE proc_EDW_CoachingDetail
@Reloadall int = 0
, @TrackProgress int = 0
, @KeepData AS bit = 0
AS
BEGIN

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_CoachingDetail';

    IF @iTotal = 1
        BEGIN
            PRINT 'NO RECORDS FOUND IN STAGING TABLE - Reloading all.';
            SET @Reloadall = 1;
        END;

    DECLARE
       @Synchronization_Version bigint = 0
       ,@CurrentDbVersion AS int
       ,@STime AS datetime
       ,@TgtView AS nvarchar ( 100 ) = 'view_EDW_CoachingDetail_CT'
       ,@ExtractionDate AS datetime
       ,@ExtractedVersion AS int
       ,@ExtractedRowCnt AS int
       ,@EndTime AS datetime
       ,@CNT_PulledRecords AS int = 0
       ,@iCnt AS int = 0
       ,@RowNbr AS int = 0
       ,@StartTime AS datetime = GETDATE ( )
       ,@SVRName AS nvarchar ( 100 )
       ,@DBName AS nvarchar ( 100 ) = DB_NAME ( )
       ,@CNT_Insert AS int = 0
       ,@CNT_Update AS int = 0
       ,@CNT_Delete AS int = 0
       ,@CNT_StagingTable int = 0
       ,@VersionNBR int = 0;

    SET @SVRName = ( SELECT
                            @@SERVERNAME );

    SET @STime = GETDATE ( );

    DECLARE
       @RecordID AS uniqueidentifier = NEWID ( );
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_CoachingDetail' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                          FROM sys.tables
                          WHERE name = 'DIM_EDW_CoachingDetail' )
                BEGIN

                    PRINT 'Dropping DIM_EDW_CoachingDetail for FULL reload.';
                    DROP TABLE
                         DIM_EDW_CoachingDetail;
                END;
            ELSE
                BEGIN
                    PRINT 'Reloading DIM_EDW_CoachingDetail.';
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE
                          ( ) AS nvarchar ( 50 ));
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL EDW HA Data.';
                    SELECT
                           * INTO
                                  DIM_EDW_CoachingDetail
                      FROM view_EDW_CoachingDetail_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_CoachingDetail';

                    IF @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( * )
                                            FROM DIM_EDW_CoachingDetail );
                            PRINT DB_NAME ( ) + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt
                                  AS nvarchar ( 50 )) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( * )
                                                 FROM DIM_EDW_CoachingDetail );
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                      FROM sys.indexes
                                      WHERE name = 'PI_EDW_CoachingDetail_IDs' )
                        BEGIN
                            IF @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_CoachingDetail_IDs at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                                END;
                            CREATE CLUSTERED INDEX PI_EDW_CoachingDetail_IDs ON dbo.DIM_EDW_CoachingDetail ( ItemID
                            , ItemGUID
                            , GoalID
                            , UserGUID
                            , SiteGUID
                            , AccountID
                            , AccountCD
                            , WeekendDate
                            , NodeGUID )
                            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
                            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                        END;

                    SET @ExtractionDate = GETDATE ( );
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( * )
                                               FROM DIM_EDW_CoachingDetail );
                    --SET @TgtView = 'view_EDW_CoachingDetail';
                    SET @EndTime = GETDATE ( );

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                           ,ExtractedVersion
                           ,CurrentDbVersion
                           ,ExtractedRowCnt
                           ,TgtView
                           ,StartTime
                           ,EndTime
                           ,SVRName
                           ,DBName
                           ,CNT_Insert
                           ,CNT_Update
                           ,CNT_delete
                           ,CNT_PulledRecords
                           ,CNT_StagingTable )
                    VALUES
                    (
                    @ExtractionDate , @ExtractedVersion , @CurrentDbVersion , @ExtractedRowCnt , @TgtView , @StartTime , @EndTime , @SVRName ,
                    @DBName , @CNT_Insert , @CNT_Update , @CNT_delete , @CNT_PulledRecords , @CNT_StagingTable );

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;

                END;
            -- SELECT * INTO [DIM_EDW_CoachingDetail] FROM [view_EDW_CoachingDetail_CT];
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            SET @STime = GETDATE ( );
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_CoachingDetail';
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_CoachingDetail' , @STime , @CNT_PulledRecords , 'U';
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @CNT_PulledRecords;

            EXEC proc_CT_EDW_CoachingDetail_NoDups ;
            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                      FROM sys.tables
                      WHERE name = 'DIM_EDW_CoachingDetail' )
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_CoachingDetail was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN

            --IF NOT EXISTS ( SELECT
            --                name
            --                  FROM sys.indexes
            --                  WHERE name = 'PI_EDW_CoachingDetail_IDs') 
            --    BEGIN
            --        IF @TrackProgress = 1
            --            BEGIN
            --                PRINT 'Adding INDEX PI_EDW_CoachingDetail_IDs';
            --            END;
            --        CREATE NONCLUSTERED INDEX PI_EDW_CoachingDetail_IDs ON dbo.DIM_EDW_CoachingDetail ( ItemCreatedWhen ASC , ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC , HAUserQuestion_ItemModifiedWhen ASC , HAUserAnswers_ItemModifiedWhen ASC) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
            --    END;

            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_EDW_CoachingDetail_IDs' )
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_CoachingDetail_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_CoachingDetail_IDs ON dbo.DIM_EDW_CoachingDetail ( ItemID
                    , ItemGUID
                    , GoalID
                    , UserGUID
                    , SiteGUID
                    , AccountID
                    , AccountCD
                    , WeekendDate
                    , NodeGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF ,
                    SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                          FROM tempdb.dbo.sysobjects
                          WHERE id = OBJECT_ID ( N'tempdb..##TEMP_EDW_CoachingDetail_DATA' ))

                BEGIN
                            PRINT 'Dropping ##TEMP_EDW_CoachingDetail_DATA';
                    DROP TABLE
                         ##TEMP_EDW_CoachingDetail_DATA;
                END;

            /*******************************************************************************/

            SELECT
                   * INTO
                          ##TEMP_EDW_CoachingDetail_DATA
              FROM view_EDW_CoachingDetail_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

		  --EXEC proc_Add_EDW_CT_StdCols '##TEMP_EDW_CoachingDetail_DATA';
		  ALTER TABLE ##TEMP_EDW_CoachingDetail_DATA ADD LastModifiedDate datetime NULL;  
		  ALTER TABLE ##TEMP_EDW_CoachingDetail_DATA ADD RowNbr int NULL;  
		  ALTER TABLE ##TEMP_EDW_CoachingDetail_DATA add DeletedFlg bit NULL; 
		  ALTER TABLE ##TEMP_EDW_CoachingDetail_DATA add TimeZone nvarchar (10) NULL;  
		  ALTER TABLE ##TEMP_EDW_CoachingDetail_DATA add ConvertedToCentralTime bit NULL; 

            CREATE CLUSTERED INDEX temp_PI_EDW_CoachingDetail_IDs ON dbo.##TEMP_EDW_CoachingDetail_DATA ( ItemID
            , ItemGUID
            , GoalID
            , UserGUID
            , SiteGUID
            , AccountID
            , AccountCD
            , WeekendDate
            , NodeGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF ,
            SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

            IF @KeepData = 1
                BEGIN
                    PRINT 'KEEPING TEMP DATA IN TABLE TEMP_EDW_CoachingDetail_DATA';
                    IF EXISTS ( SELECT
                                       name
                                  FROM sys.tables
                                  WHERE name = 'TEMP_EDW_CoachingDetail_DATA' )
                        BEGIN
                            DROP TABLE
                                 TEMP_EDW_CoachingDetail_DATA;
                        END;

                    SELECT
                           * INTO
                                  TEMP_EDW_CoachingDetail_DATA
                      FROM ##TEMP_EDW_CoachingDetail_DATA;

                    CREATE CLUSTERED INDEX temp_PI_EDW_CoachingDetail_IDs ON TEMP_EDW_CoachingDetail_DATA ( ItemID
                    , ItemGUID
                    , GoalID
                    , UserGUID
                    , SiteGUID
                    , AccountID
                    , AccountCD
                    , WeekendDate
                    , NodeGUID ) WITH ( PAD_INDEX = OFF ,
                    STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##TEMP_EDW_CoachingDetail_DATA );

            --***************************************************************
            -- ADD NEW INSERTS
            DECLARE
               @iInsert AS int = 0;
            EXEC @iInsert = proc_CT_CoachingDetail_AddNewRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iInsert;

            --***************************************************************
            -- FIND UPDATES
            DECLARE
               @iUpdt AS int = 0;
            EXEC @iUpdt = proc_CT_CoachingDetail_AddUpdatedRecs ;
            PRINT 'Updated Count: ' + CAST ( @iUpdt AS nvarchar ( 50 ));

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdt;

            --***********************************************
            --FIND DELETED ROWS
            DECLARE
               @iDels AS int = 0;
            EXEC @iDels = proc_CT_CoachingDetail_AddDeletedRecs ;

            PRINT 'Deleted Count: ' + CAST ( @iDels AS nvarchar ( 50 ));

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDels;

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( * )
                                        FROM DIM_EDW_CoachingDetail );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
              WHERE
                    RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##TEMP_EDW_CoachingDetail_DATA );

            EXEC proc_CT_EDW_CoachingDetail_NoDups ;
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_CoachingDetail';
            SET @STime = GETDATE ( );
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_CoachingDetail' , @STime , @CNT_PulledRecords , 'U';

        END;
END;

GO
PRINT 'Created proc_EDW_CoachingDetail';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT '***** FROM: view_EDW_CoachingDetail_STAGE.sql';
GO

PRINT 'Processing: view_EDW_CoachingDetail_STAGED ';
GO

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
                  WHERE TABLE_NAME = 'view_EDW_CoachingDetail_STAGED') 
    BEGIN
        DROP VIEW
             view_EDW_CoachingDetail_STAGED;
    END;
GO

--GRANT SELECT
--	ON [dbo].[[view_EDW_CoachingDetail_STAGED]]
--	TO [EDWReader_PRD]
--GO

/* TEST Queries
select * from [view_EDW_CoachingDetail_STAGED]
select * from [view_EDW_CoachingDetail_STAGED] where CloseReasonLKPID != 0
select count(*) from [view_EDW_CoachingDetail_STAGED]
*/

CREATE VIEW dbo.view_EDW_CoachingDetail_STAGED
AS SELECT
          ItemID
        , ItemGUID
        , GoalID
        , UserID
        , UserGUID
        , HFitUserMpiNumber
        , SiteGUID
        , AccountID
        , AccountCD
        , AccountName
        , IsCreatedByCoach
        , BaselineAmount
        , GoalAmount
        , DocumentID
        , GoalStatusLKPID
        , GoalStatusLKPName
        , EvaluationStartDate
        , EvaluationEndDate
        , GoalStartDate
        , CoachDescription
        , EvaluationDate
        , Passed
        , WeekendDate
        , ChangeType
        , ItemCreatedWhen
        , ItemModifiedWhen
        , NodeGUID
        , CloseReasonLKPID
        , CloseReason
          FROM STAGING_EDW_CoachingDetail;
GO
PRINT '***** Created: view_EDW_CoachingDetail_STAGED';
GO 

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






--proc_EDW_CoachingDetail
GO
PRINT 'Creating JOB job_EDW_GetStagingData_CoachingDetail';
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE
                      name = N'[Uncategorized (Local)]'
                  AND
                      category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF
               @@ERROR <> 0
            OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback;
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_CoachingDetail_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1;
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;

/****** Object:  Step [Load_EDW_CoachingDetail]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_CoachingDetail',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_CoachingDetail',
@database_name = @TGTDB,
@flags = 0;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_CoachingDetail',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO 
PRINT 'Creating view_EDW_CT_ExecutionLog';
PRINT 'FROM view_EDW_CT_ExecutionLog.sql';
GO
--exec sp_depends 'EDW_CT_ExecutionLog'
IF EXISTS( SELECT
                  name
             FROM sys.views
             WHERE name = 'view_EDW_CT_ExecutionLog' )
    BEGIN
        DROP VIEW
             view_EDW_CT_ExecutionLog
    END;
GO
CREATE VIEW view_EDW_CT_ExecutionLog
AS SELECT
          *
     FROM EDW_CT_ExecutionLog;
GO
PRINT 'CREATED view_EDW_CT_ExecutionLog';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_Prod1

GO
PRINT '***** FROM: view_EDW_RewardsDefinition_CT.sql';
GO
PRINT 'Processing: view_EDW_RewardsDefinition_CT:';
GO
IF EXISTS (SELECT
                  NAME
                  FROM sys.VIEWS
                  WHERE NAME = 'view_EDW_RewardsDefinition_CT') 
    BEGIN
        DROP VIEW
             view_EDW_RewardsDefinition_CT;
    END;
GO

--GRANT SELECT
--	ON [dbo].[view_EDW_RewardsDefinition_CT]
--	TO [EDWReader_PRD]
--GO

/*-------------------------------------------------

select top 100 * from view_EDW_RewardsDefinition_CT

select * 
into TEMP_view_EDW_RewardsDefinition_CT
from view_EDW_RewardsDefinition_CT
*/

CREATE VIEW dbo.view_EDW_RewardsDefinition_CT
AS
--select count(*) from view_EDW_RewardsDefinition_CT
SELECT DISTINCT
       cs.SiteGUID
     , HFA.AccountID
     , hfa.AccountCD
     , VHFRPJ.NodeGuid AS RewardProgramGUID
     , RewardProgramName
     , RewardProgramPeriodStart
     , RewardProgramPeriodEnd
     , VHFRGJ.NodeGuid AS RewardGroupGuid
     , GroupName
     , VHFRLJ.NodeGuid AS RewardLevelGuid
     , Level
     , RewardLevelTypeLKPName
     , AwardDisplayName
     , AwardType
     , AwardThreshold1
     , AwardThreshold2
     , AwardThreshold3
     , AwardThreshold4
     , AwardValue1
     , AwardValue2
     , AwardValue3
     , AwardValue4
     , ExternalFulfillmentRequired
     , VHFRAJ.NodeGuid AS RewardActivityGuid
     , VHFRAJ.ActivityName
     , VHFRAJ.ActivityFreqOrCrit
     , VHFRAJ.ActivityPoints
     , VHFRAJ.IsBundle
     , VHFRAJ.IsRequired
     , VHFRAJ.MaxThreshold
     , VHFRAJ.AwardPointsIncrementally
     , VHFRAJ.AllowMedicalExceptions
     , VHFRTJ.NodeGuid AS RewardTriggerGuid
     , HFLRT.RewardTriggerDynamicValue
     , TriggerName
     , VHFRTPJ.RewardTriggerParameterOperator
     , VHFRTPJ.NodeGuid AS RewardTriggerParmGUID --(WDM/NJ) added 03.03.2015     
     , VHFRTPJ.Value
     , CASE
           WHEN CAST (VHFRPJ.DocumentCreatedWhen AS date) = CAST (VHFRPJ.DocumentModifiedWhen AS date) 
               THEN 'I'
           ELSE 'U'
       END AS ChangeType
     , VHFRAJ.DocumentCulture AS DocumentCulture_VHFRAJ
     , VHFRPJ.DocumentCulture AS DocumentCulture_VHFRPJ
     , VHFRGJ.DocumentCulture AS DocumentCulture_VHFRGJ
     , VHFRLJ.DocumentCulture AS DocumentCulture_VHFRLJ
     , VHFRTPJ.DocumentCulture AS DocumentCulture_VHFRTPJ
     , LevelName
     , HASHBYTES ('sha1',
       ISNULL (CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL (CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL (CAST ( hfa.AccountCD AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRPJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (LEFT ( RewardProgramName, 250) , '-') + ISNULL (CAST ( RewardProgramPeriodStart AS nvarchar (50)) , '-') + ISNULL (CAST ( RewardProgramPeriodEnd AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRGJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (LEFT ( GroupName, 250) , '-') + ISNULL (CAST ( VHFRLJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST ( Level AS nvarchar (50)) , '-') + ISNULL (LEFT ( RewardLevelTypeLKPName, 250) , '-') + ISNULL (LEFT ( AwardDisplayName, 250) , '-') + ISNULL (CAST ( AwardType AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardThreshold1 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardThreshold2 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardThreshold3 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardThreshold4 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardValue1 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardValue2 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardValue3 AS nvarchar (50)) , '-') + ISNULL (CAST ( AwardValue4 AS nvarchar (50)) , '-') + ISNULL (CAST ( ExternalFulfillmentRequired AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (LEFT ( VHFRAJ.ActivityName, 250) , '-') + ISNULL (CAST ( VHFRAJ.ActivityFreqOrCrit AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.ActivityPoints AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.IsBundle AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.IsRequired AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.MaxThreshold AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.AwardPointsIncrementally AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRAJ.AllowMedicalExceptions AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRTJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST ( HFLRT.RewardTriggerDynamicValue AS nvarchar (50)) , '-') + ISNULL (LEFT ( TriggerName, 250) , '-') + ISNULL (CAST ( VHFRTPJ.RewardTriggerParameterOperator AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRTPJ.NodeGuid AS nvarchar (50)) , '-') + ISNULL (CAST ( VHFRTPJ.Value AS nvarchar (50)) , '-') 
       ) AS HashCode
       FROM
           dbo.View_EDW_RewardProgram_Joined AS VHFRPJ
               INNER JOIN dbo.View_HFit_RewardGroup_Joined AS VHFRGJ
                   ON VHFRPJ.NodeID = VHFRGJ.NodeParentID
                  AND VHFRPJ.DocumentCulture = 'en-US'
                  AND VHFRGJ.DocumentCulture = 'en-US'
               INNER JOIN dbo.View_HFit_RewardLevel_Joined AS VHFRLJ
                   ON VHFRGJ.NodeID = VHFRLJ.NodeParentID
                  AND VHFRLJ.DocumentCulture = 'en-US'
               INNER JOIN dbo.HFit_LKP_RewardLevelType AS HFLRLT
                   ON VHFRLJ.LevelType = HFLRLT.RewardLevelTypeLKPID
               INNER JOIN dbo.View_HFit_RewardActivity_Joined AS VHFRAJ
                   ON VHFRLJ.NodeID = VHFRAJ.NodeParentID
                  AND VHFRAJ.DocumentCulture = 'en-US'
               LEFT OUTER JOIN HFit_LKP_RewardActivity AS LKPRA
                   ON LKPRA.RewardActivityLKPID = VHFRAJ.RewardActivityLKPID --Added 1.2.2015 for SR-47520
               INNER JOIN dbo.View_HFit_RewardTrigger_Joined AS VHFRTJ
                   ON VHFRAJ.NodeID = VHFRTJ.NodeParentID
                  AND VHFRTJ.DocumentCulture = 'en-US'
               INNER JOIN dbo.View_HFit_RewardTriggerParameter_Joined AS VHFRTPJ
                   ON vhfrtj.nodeid = vhfrtpj.nodeparentid
                  AND VHFRTPJ.DocumentCulture = 'en-US'
               INNER JOIN dbo.HFit_LKP_RewardTrigger AS HFLRT
                   ON VHFRTJ.RewardTriggerLKPID = HFLRT.RewardTriggerLKPID
               INNER JOIN dbo.CMS_Site AS CS
                   ON VHFRPJ.NodeSiteID = cs.SiteID
               INNER JOIN dbo.HFit_Account AS HFA
                   ON cs.SiteID = HFA.SiteID
               LEFT JOIN HFit_LKP_RewardTriggerParameterOperator AS LKPRTP
                   ON LKPRTP.RewardTriggerParameterOperatorLKPID = VHFRTPJ.RewardTriggerParameterOperator;

GO
PRINT 'Processed: view_EDW_RewardsDefinition_CT ';
GO
/*-------------------------------------------------
(WDM) Kept only these coulmns IAW CR-51005
SiteGUID 
AccountID
AccountCD 
RewardProgramGUID
RewardProgramName
RewardProgramPeriodStart
RewardProgramPeriodEnd
RewardGroupGUID
GroupName
RewardLevelGUID
Level
RewardLevelTypeLKPName
AwardDisplayName
AwardType
AwardThreshold1
AwardThreshold2
AwardThreshold3
AwardThreshold4
AwardValue1
AwardValue2
AwardValue3
AwardValue4
ExternalFulfillmentRequired
RewardActivityGUID
RewardActivityName	--VHFRAJ.ActivityName
ActivityFreqOrCrit
ActivityPoints
IsBundle
IsRequired
MaxThreshold
AwardPointsIncrementally
AllowMedicalExceptions
RewardTriggerGUID
RewardTriggerDynamicValue
TriggerName
RewardTriggerParameterOperator
RewardTriggerParameterGUID  --RewardTriggerParmGUID
Value
ChangeType
DocumentCulture_VHFRAJ
DocumentCulture_VHFRPJ
DocumentCulture_VHFRGJ
DocumentCulture_
DocumentCulture_VHFRTPJ
LevelName
*/
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
-- use KenticoCMS_Prod1

/*
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'FROM proc_EDW_RewardsDefinition.SQL';
PRINT 'Creating proc_EDW_RewardsDefinition';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_RewardsDefinition' )
    BEGIN
        PRINT 'Replacing proc_EDW_RewardsDefinition proc';
        DROP PROCEDURE
             proc_EDW_RewardsDefinition;
    END;
GO

/*
exec proc_EDW_RewardsDefinition 1,1,0
exec proc_EDW_RewardsDefinition 1,1,1
exec proc_EDW_RewardsDefinition 1,0,1

exec proc_EDW_RewardsDefinition 0,1,0
exec proc_EDW_RewardsDefinition 0,1,1
exec proc_EDW_RewardsDefinition 0,0,1
*/

CREATE PROCEDURE proc_EDW_RewardsDefinition
@Reloadall int = 0
, @TrackProgress int = 0
, @KeepData AS bit = 0
AS
BEGIN

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardsDefinition';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;


    DECLARE
       @Synchronization_Version bigint = 0
       ,@CurrentDbVersion AS int
       ,@STime AS datetime
       ,@TgtView AS nvarchar ( 100 ) = 'view_EDW_RewardsDefinition_CT'
       ,@ExtractionDate AS datetime
       ,@ExtractedVersion AS int
       ,@ExtractedRowCnt AS int
       ,@EndTime AS datetime
       ,@CNT_PulledRecords AS int = 0
       ,@iCnt AS int = 0
       ,@RowNbr AS int = 0
       ,@StartTime AS datetime = GETDATE ( )
       ,@SVRName AS nvarchar ( 100 )
       ,@DBName AS nvarchar ( 100 ) = DB_NAME ( )
       ,@CNT_Insert AS int = 0
       ,@CNT_Update AS int = 0
       ,@CNT_Delete AS int = 0
       ,@CNT_StagingTable int = 0
       ,@VersionNBR int = 0;

    SET @SVRName = ( SELECT
                            @@SERVERNAME );

    SET @STime = GETDATE ( );

    DECLARE
       @RecordID AS uniqueidentifier = NEWID ( );
    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardsDefinition' , @STime , 0 , 'I';

    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                          FROM sys.tables
                          WHERE name = 'DIM_EDW_RewardsDefinition' )
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_EDW_RewardsDefinition for FULL reload.';
                        END;
                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    DROP TABLE
                         DIM_EDW_RewardsDefinition;
                END;
            ELSE
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading DIM_EDW_RewardsDefinition.';
                        END;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @Reloadall = 1
                BEGIN

                    PRINT 'RELOADING ALL RewardsDefinition Data.';

                    SELECT
                           * INTO
                                  DIM_EDW_RewardsDefinition
                      FROM view_EDW_RewardsDefinition_CT;

                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_RewardsDefinition';

                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @@ROWCOUNT;

                    IF @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( * )
                                            FROM DIM_EDW_RewardsDefinition );
                            PRINT DB_NAME ( ) + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 )) + ' , loaded ' + CAST ( @iCnt AS nvarchar ( 50 )) + ' records.';
                        END;

                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( * )
                                                 FROM DIM_EDW_RewardsDefinition );
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                      FROM sys.indexes
                                      WHERE name = 'PI_EDW_RewardsDefinition_IDs' )
                        BEGIN
                            IF @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_RewardsDefinition_IDs at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                                END;
                            CREATE CLUSTERED INDEX PI_EDW_RewardsDefinition_IDs ON dbo.DIM_EDW_RewardsDefinition ( SiteGUID , AccountID , AccountCD , RewardProgramGUID , RewardGroupGuid , RewardLevelGuid , RewardActivityGuid , RewardTriggerGuid , RewardTriggerParmGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                        END;

                    SET @ExtractionDate = GETDATE ( );
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( * )
                                               FROM DIM_EDW_RewardsDefinition );
                    --SET @TgtView = 'view_EDW_RewardsDefinition';
                    SET @EndTime = GETDATE ( );

                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                           ,ExtractedVersion
                           ,CurrentDbVersion
                           ,ExtractedRowCnt
                           ,TgtView
                           ,StartTime
                           ,EndTime
                           ,SVRName
                           ,DBName
                           ,CNT_Insert
                           ,CNT_Update
                           ,CNT_delete
                           ,CNT_PulledRecords
                           ,CNT_StagingTable )
                    VALUES
                    (
                    @ExtractionDate , @ExtractedVersion , @CurrentDbVersion , @ExtractedRowCnt , @TgtView , @StartTime , @EndTime , @SVRName , @DBName , @CNT_Insert , @CNT_Update , @CNT_delete , @CNT_PulledRecords , @CNT_StagingTable );

                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                        END;

                END;
            -- SELECT * INTO [DIM_EDW_RewardsDefinition] FROM [view_EDW_RewardsDefinition_CT];
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
                END;

            SET @STime = GETDATE ( );

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardsDefinition';

            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardsDefinition' , @STime , @CNT_PulledRecords , 'U';
            RETURN;
        END;

    IF NOT EXISTS ( SELECT
                           NAME
                      FROM sys.tables
                      WHERE name = 'DIM_EDW_RewardsDefinition' )
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_RewardsDefinition was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN
            IF NOT EXISTS ( SELECT
                                   name
                              FROM sys.indexes
                              WHERE name = 'PI_EDW_RewardsDefinition_IDs' )
                BEGIN

                    PRINT 'Adding INDEX PI_EDW_RewardsDefinition_IDs';

                    CREATE CLUSTERED INDEX PI_EDW_RewardsDefinition_IDs ON dbo.DIM_EDW_RewardsDefinition ( SiteGUID , AccountID , AccountCD , RewardProgramGUID , RewardGroupGuid , RewardLevelGuid , RewardActivityGuid , RewardTriggerGuid , RewardTriggerParmGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                          FROM tempdb.dbo.sysobjects
                          WHERE id = OBJECT_ID ( N'tempdb..##TEMP_EDW_RewardsDefinition_DATA' ))

                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping ##TEMP_EDW_RewardsDefinition_DATA';
                        END;
                    DROP TABLE
                         ##TEMP_EDW_RewardsDefinition_DATA;
                END;

            /*******************************************************************************/

            SELECT
                   * INTO
                          ##TEMP_EDW_RewardsDefinition_DATA
              FROM view_EDW_RewardsDefinition_CT;
            --WHERE CHANGED_FLG IS NOT NULL;

		  EXEC proc_Add_EDW_CT_StdCols '##TEMP_EDW_RewardsDefinition_DATA';

            CREATE CLUSTERED INDEX temp_PI_EDW_RewardsDefinition_IDs ON dbo.##TEMP_EDW_RewardsDefinition_DATA ( SiteGUID , AccountID , AccountCD , RewardProgramGUID , RewardGroupGuid , RewardLevelGuid , RewardActivityGuid , RewardTriggerGuid , RewardTriggerParmGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

            IF @KeepData = 1
                BEGIN
                    PRINT 'KEEPING TEMP DATA IN TABLE TEMP_EDW_RewardsDefinition_DATA';
                    IF EXISTS ( SELECT
                                       name
                                  FROM sys.tables
                                  WHERE name = 'TEMP_EDW_RewardsDefinition_DATA' )
                        BEGIN
                            DROP TABLE
                                 TEMP_EDW_RewardsDefinition_DATA;
                        END;

                    SELECT
                           * INTO
                                  TEMP_EDW_RewardsDefinition_DATA
                      FROM ##TEMP_EDW_RewardsDefinition_DATA;

                    CREATE CLUSTERED INDEX temp_PI_EDW_RewardsDefinition_IDs ON TEMP_EDW_RewardsDefinition_DATA ( SiteGUID , AccountID , AccountCD , RewardProgramGUID , RewardGroupGuid , RewardLevelGuid , RewardActivityGuid , RewardTriggerGuid , RewardTriggerParmGUID ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

                END;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##TEMP_EDW_RewardsDefinition_DATA );

            --select * from ##TEMP_EDW_RewardsDefinition_DATA
            --update ##TEMP_EDW_RewardsDefinition_DATA set AnsDocumentGuid = '1B8A2611-B0BF-4555-B609-56CC7D4EFC38' where AnsDocumentGuid = '001FBF56-C327-490F-AA15-4EB6F595D47A' and AnsPOints = 15
            --update ##TEMP_EDW_RewardsDefinition_DATA set AnsDocumentGuid = newid() where AnsDocumentGuid = 'C1D9949E-786D-42F7-8E31-0619D8ED60BD' and AnsPOints = 0
		  --*********************************************************
		  -- ADD NEW RECORDS
		  --*********************************************************
            DECLARE
               @iIns AS int = 0;
		  exec @iIns = proc_CT_RewardsDefinition_AddNewRecs ;
            PRINT 'Insert Count: ' + CAST ( @iIns AS nvarchar ( 50 ));
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iIns;

            --*********************************************************
		  -- ADD UPDATED RECORDS
		  --*********************************************************            
                    DECLARE
                       @iUpdt AS int = 0;
		  exec @iUpdt = proc_CT_RewardsDefinition_AddUpdatedRecs;
                    PRINT 'Update Count: ' + CAST ( @iUpdt AS nvarchar ( 50 ));
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdt;


		  --*********************************************************
		  -- FIND DELETED ROWS
		  --*********************************************************            
            DECLARE
               @idel AS int = 0;
		  exec @idel = proc_CT_RewardsDefinition_AddDeletedRecs ;
            PRINT 'Delete Count: ' + CAST ( @idel AS nvarchar ( 50 ));
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @idel;

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( * )
                                        FROM DIM_EDW_RewardsDefinition );
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
              WHERE
                    RowNbr = @RowNbr;

            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
              WHERE
                    RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( * )
                                         FROM ##TEMP_EDW_RewardsDefinition_DATA );
            SET @STime = GETDATE ( );

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_RewardsDefinition';
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_RewardsDefinition' , @STime , @CNT_PulledRecords , 'U';

        END;
END;

GO
PRINT 'Created proc_EDW_RewardsDefinition';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
-- select top 100 * from view_EDW_RewardsDefinition_STAGED
print 'Creating view_EDW_RewardsDefinition_STAGED' ;
print 'FROM view_EDW_RewardsDefinition_STAGE.sql' ;
go
if exists (select name from sys.views where name = 'view_EDW_RewardsDefinition_STAGED')
    drop view view_EDW_RewardsDefinition_STAGED;
go
create view view_EDW_RewardsDefinition_STAGED
as
SELECT [SiteGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[RewardProgramGUID]
      ,[RewardProgramName]
      ,[RewardProgramPeriodStart]
      ,[RewardProgramPeriodEnd]
      ,[RewardGroupGuid]
      ,[GroupName]
      ,[RewardLevelGuid]
      ,[Level]
      ,[RewardLevelTypeLKPName]
      ,[AwardDisplayName]
      ,[AwardType]
      ,[AwardThreshold1]
      ,[AwardThreshold2]
      ,[AwardThreshold3]
      ,[AwardThreshold4]
      ,[AwardValue1]
      ,[AwardValue2]
      ,[AwardValue3]
      ,[AwardValue4]
      ,[ExternalFulfillmentRequired]
      ,[RewardActivityGuid]
      ,[ActivityName]
      ,[ActivityFreqOrCrit]
      ,[ActivityPoints]
      ,[IsBundle]
      ,[IsRequired]
      ,[MaxThreshold]
      ,[AwardPointsIncrementally]
      ,[AllowMedicalExceptions]
      ,[RewardTriggerGuid]
      ,[RewardTriggerDynamicValue]
      ,[TriggerName]
      ,[RewardTriggerParameterOperator]
      ,[RewardTriggerParmGUID]
      ,[Value]
      ,[ChangeType]
      ,[DocumentCulture_VHFRAJ]
      ,[DocumentCulture_VHFRPJ]
      ,[DocumentCulture_VHFRGJ]
      ,[DocumentCulture_VHFRLJ]
      ,[DocumentCulture_VHFRTPJ]
      ,[LevelName]
      ,[HashCode]
      ,[LastModifiedDate]
      ,[RowNbr]
      ,[DeletedFlg]
  FROM [dbo].[STAGING_EDW_RewardsDefinition]
GO
print 'CREATED view_EDW_RewardsDefinition_STAGED' ;
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating JOB job_EDW_GetStagingData_RewardsDefinition';
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS( SELECT
                      name
                 FROM msdb.dbo.syscategories
                 WHERE
                      name = N'[Uncategorized (Local)]'
                  AND category_class = 1 )
    BEGIN EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB' , @type = N'LOCAL' , @name = N'[Uncategorized (Local)]';
        IF
               @@ERROR <> 0
            OR @ReturnCode <> 0
            BEGIN
                GOTO QuitWithRollback;
            END;

    END;

DECLARE
   @TGTDB AS nvarchar( 50 ) = DB_NAME( );
DECLARE
   @JNAME AS nvarchar( 100 ) = 'job_EDW_GetStagingData_RewardsDefinition_' + @TGTDB;

IF EXISTS( SELECT
                  job_id
             FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME )
    BEGIN EXEC msdb.dbo.sp_delete_job @job_name = @JNAME , @delete_unused_schedule = 1;
    END;

DECLARE
   @jobId binary( 16 );
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME , @enabled = 1 , @notify_level_eventlog = 2 , @notify_level_email = 2 , @notify_level_netsend = 0 , @notify_level_page = 0 , @delete_level = 0 , @description = N'No description available.' , @category_name = N'[Uncategorized (Local)]' , @owner_login_name = N'sa' , @notify_email_operator_name = N'DBA_Notify' , @job_id = @jobId OUTPUT;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;

/****** Object:  Step [Load_EDW_RewardsDefinition]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId , @step_name = N'Load_EDW_RewardsDefinition' , @step_id = 1 , @cmdexec_success_code = 0 , @on_success_action = 1 , @on_success_step_id = 0 , @on_fail_action = 2 , @on_fail_step_id = 0 , @retry_attempts = 0 , @retry_interval = 0 , @os_run_priority = 0 , @subsystem = N'TSQL' , @command = N'exec proc_EDW_RewardsDefinition;' , @database_name = @TGTDB , @flags = 0;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId , @start_step_id = 1;
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId , @name = N'Schedule_EDW_RewardsDefinition' , @enabled = 1 , @freq_type = 4 , @freq_interval = 1 , @freq_subday_type = 8 , @freq_subday_interval = 8 , @freq_relative_interval = 0 , @freq_recurrence_factor = 0 , @active_start_date = 20150412 , @active_end_date = 99991231 , @active_start_time = 10000 , 
@active_end_time = 235959 
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId , @server_name = N'(local)';
IF
       @@ERROR <> 0
    OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN
        ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





print ('Processing: view_EDW_TrackerTests ') ;

GO


if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_TrackerTests')
BEGIN
	drop view view_EDW_TrackerTests ;
END

GO


--********************************************************************************************************
--09.11.2014 : (wdm) Verified last mod date available to EDW 
-- Select count(*) from [view_EDW_TrackerTests] 40322 vs. 40313 with distinct 44502 / 44483 on TGT P1
--									   44502 vs. 44483 with distinct on Prod5 / P1
--********************************************************************************************************
CREATE VIEW [dbo].[view_EDW_TrackerTests]
AS
	SELECT 
		HFTT.UserID
		, cus.UserSettingsUserGUID
		, CUS.HFitUserMpiNumber
		, CS.SiteID
		, cs.SiteGUID
		, cast(HFTT.EventDate as datetime) as EventDate
		, HFTT.IsProfessionallyCollected
		, HFTT.TrackerCollectionSourceID
		, HFTT.Notes
		, HFTT.PSATest
		, HFTT.OtherExam
		, HFTT.TScore
		, HFTT.DRA
		, HFTT.CotinineTest
		, HFTT.ColoCareKit
		, HFTT.CustomTest
		, HFTT.CustomDesc
		, HFTT.TSH
		, cast(HFTT.ItemCreatedWhen as datetime) as ItemCreatedWhen
		, cast(HFTT.ItemModifiedWhen as datetime) as ItemModifiedWhen
		, HFTT.ItemGUID
	FROM
		dbo.HFit_TrackerTests AS HFTT
	INNER JOIN dbo.HFit_PPTEligibility AS HFPE WITH ( NOLOCK ) ON HFTT.UserID = HFPE.UserID
	INNER JOIN dbo.CMS_UserSettings AS CUS WITH ( NOLOCK ) ON HFTT.UserID = cus.UserSettingsUserID
	INNER JOIN dbo.CMS_UserSite AS CUS2 WITH ( NOLOCK ) ON cus.UserSettingsUserID = cus2.UserID
	INNER JOIN dbo.CMS_Site AS CS WITH ( NOLOCK ) ON cus2.SiteID = CS.SiteID
	INNER JOIN dbo.HFit_Account AS HFA WITH ( NOLOCK ) ON CS.SiteID = HFA.SiteID
GO


  --  
  --  
GO 
print('***** FROM: view_EDW_TrackerTests.sql'); 
GO 

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





print ('Processing: view_EDW_TrackerShots ') ;



if exists(select TABLE_NAME from INFORMATION_SCHEMA.VIEWS where TABLE_NAME = 'view_EDW_TrackerShots')
BEGIN
	drop view view_EDW_TrackerShots ;
END
go

/****** Object:  View [dbo].[view_EDW_TrackerShots]    Script Date: 9/11/2014 11:14:43 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO
--********************************************************************************************************
--09.11.2014 : (wdm) Verified last mod date available to EDW 
--********************************************************************************************************
CREATE VIEW [dbo].[view_EDW_TrackerShots]
AS
	SELECT DISTINCT
		HFTS.UserID
		, cus.UserSettingsUserGUID
		, CUS.HFitUserMpiNumber
		, CS.SiteID
		, cs.SiteGUID
		, HFTS.ItemID
		, cast(HFTS.EventDate as datetime ) as EventDate
		, HFTS.IsProfessionallyCollected
		, HFTS.TrackerCollectionSourceID
		, HFTS.Notes
		, HFTS.FluShot
		, HFTS.PneumoniaShot
		, cast(HFTS.ItemCreatedWhen as datetime ) as ItemCreatedWhen
		, cast(HFTS.ItemModifiedWhen as datetime ) as ItemModifiedWhen
		, HFTS.ItemGUID
	FROM
		dbo.HFit_TrackerShots AS HFTS
	INNER JOIN dbo.HFit_PPTEligibility AS HFPE WITH ( NOLOCK ) ON HFTS.UserID = HFPE.UserID
	INNER JOIN dbo.CMS_UserSettings AS CUS WITH ( NOLOCK ) ON HFTS.UserID = cus.UserSettingsUserID
	INNER JOIN dbo.CMS_UserSite AS CUS2 WITH ( NOLOCK ) ON cus.UserSettingsUserID = cus2.UserID
	INNER JOIN dbo.CMS_Site AS CS WITH ( NOLOCK ) ON cus2.SiteID = CS.SiteID
	INNER JOIN dbo.HFit_Account AS HFA WITH ( NOLOCK ) ON CS.SiteID = HFA.SiteID

GO


  --  
  --  
GO 
print('***** FROM: view_EDW_TrackerShots.sql'); 
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




go
PRINT 'Creating JOB job_EDW_GetStagingData_Trackers' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_Trackers_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_EDW_Trackers]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_Trackers',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_STAGING_EDW_CompositeTracker;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_Trackers',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating view view_EDW_SmallStepResponses';
PRINT 'Generated FROM: view_EDW_SmallStepResponses.SQL';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_SmallStepResponses') 
    BEGIN
        PRINT 'VIEW view_EDW_SmallStepResponses, replacing.';
        DROP VIEW
             view_EDW_SmallStepResponses;
    END;
GO

CREATE VIEW dbo.view_EDW_SmallStepResponses
AS

--********************************************************************************************************
--IVP Version NO: 1.0
--02.13.2014 : (Sowmiya Venkiteswaran) : Updated the view to include  the fields:
--AccountCD, SiteGUID,SSOutcomeMessage as info. text,
-- Small Steps Program Info( HACampaignNodeGUID,HACampaignName,HACampaignStartDate,HACampaignEndDate)
-- HAUserStartedRecord Info (HAStartedDate,HACompletedDate,HAStartedMode,HACompletedMode)
-- Added filters by document culture and replacing HTML quote with a SQL single quote
--********************************************************************************************************
--02.23.2014 : (Dale Miller & Sowmiya V) : Performance tuning - removed the following WHERE clause and 
--			incorporated them into the JOIN statements for perfoamnce enhancement.
--			 WHERE vwOutcome.DocumentCulture = 'en-US' AND vwCamp.DocumentCulture = 'en-US';
--********************************************************************************************************
--02.23.2014 : (Dale Miller & Sowmiya V) : Performance tuning
--	Prod1, 2 and 3 Labs - Incorporated doc. culture to the Joins
-- 1 - executed DBCC dropcleanbuffers everytime
-- 2 - Tested REPLACE against No REPLACE, insignificant perf. hit.
-- Test Controls:
-- Prod1 Lab - NO SQL DISTINCT - 184311 ( rows) - 14 (seconds) 
-- Prod1 Lab - WITH SQL DISTINCT - 184311 ( rows) - 32 (seconds) 
-- Prod2 Lab - NO SQL DISTINCT -  81120( rows) -  10(seconds) 
-- Prod2 Lab - WITH SQL DISTINCT - 81120 ( rows) -  22(seconds) 
-- Prod3 Lab - NO SQL DISTINCT - 136763 ( rows) - 10 (seconds) 
-- Prod3 Lab - WITH SQL DISTINCT - 136763 ( rows) -  21(seconds)  
--02.24.2015 (SV) - Added column SSHealthAssesmentUserStartedItemID per request from John C.
--02.24.2015 (WDM) - Verified changes applied correctly from within the IVP
--02.24.2015 (WDM) - Verified changes are tracked from within the Schema Change Monitor
--02.24.2015 (WDM) - Add the view to the Data/View IVP
--03.02.2015 (WDM) - The view got out of sync most likely due to multiple users with CRUD capability.
--		Re-executed the master DDL.
--03.03.2015 (WDM/SV) - Added new columns HaCodeName and HFitUserMPINumber.
--03.04.2015 (WDM/SV) - Tested view and reviewed output - added DISTINCT and tuned for perf.
--03.04.2015 (WDM/Ashwin) - Ashwin started testing. Modified the JOIN for UserID - now returns expected MPI.
--03.04.2015 (WDM/Ashwin) - Ashwin certified the view as tested.
--04.06.2015 (WDM/JC) John found an error in the JOIN of user ID - changed to CMS_US.UserSettingsUserID = ss.UserID
--04.15.2015 (WDM/Shane) Found an issue with duplicate rows. Added the SiteID to the JOIN (eg.
--			  vwCamp.NodeSiteID = usrste.SiteID and moved the join down in the list.)
--04.16.2015 (WDM) completed CR-51962
--********************************************************************************************************

SELECT DISTINCT
       ss.UserID
     , acct.AccountCD
     , ste.SiteGUID
     , ss.ItemID AS SSItemID
     , ss.ItemCreatedBy AS SSItemCreatedBy
     , cast(ss.ItemCreatedWhen as datetime)  AS SSItemCreatedWhen
     , ss.ItemModifiedBy AS SSItemModifiedBy
     , cast(ss.ItemModifiedWhen  as datetime) AS SSItemModifiedWhen
     , ss.ItemOrder AS SSItemOrder
     , ss.ItemGUID AS SSItemGUID
     , ss.HealthAssesmentUserStartedItemID AS SSHealthAssesmentUserStartedItemID
     , ss.OutComeMessageGUID AS SSOutcomeMessageGuid
     , REPLACE (vwOutcome.Message, '&#39;', '''') AS SSOutcomeMessage
     , usrstd.HACampaignNodeGUID
     , vwCamp.Name AS HACampaignName
     , cast(vwCamp.CampaignStartDate  as datetime) AS HACampaignStartDate
     , cast(vwCamp.CampaignEndDate  as datetime) AS HACampaignEndDate
     , cast(usrstd.HAStartedDt  as datetime) AS HAStartedDate
     , cast(usrstd.HACompletedDt  as datetime) AS HACompletedDate
     , usrstd.HAStartedMode
     , usrstd.HACompletedMode
     , TODO.HaCodeName
     , CMS_US.HFitUserMPINumber

       FROM
           dbo.Hfit_SmallStepResponses AS ss
               JOIN HFit_HealthAssesmentUserStarted AS usrstd
                   ON usrstd.UserID = ss.UserID
                  AND usrstd.ItemID = ss.HealthAssesmentUserStartedItemID
                 JOIN View_HFit_OutComeMessages_Joined AS vwOutcome
                   ON vwOutcome.NodeGUID = ss.OutComeMessageGUID
                  AND vwOutcome.DocumentCulture = 'en-US'
                 JOIN CMS_UserSite AS usrste
                   ON usrste.UserID = ss.UserID
                 JOIN CMS_Site AS ste
                   ON ste.SiteID = usrste.SiteID
                 JOIN View_HFit_HACampaign_Joined AS vwCamp
                   ON vwCamp.NodeGuid = usrstd.HACampaignNodeGUID
                  AND vwCamp.DocumentCulture = 'en-US'
                  AND vwCamp.NodeSiteID = usrste.SiteID
                 JOIN HFit_Account AS acct
                   ON acct.SiteID = usrste.SiteID
                 JOIN HFit_ToDoSmallSteps AS TODO
                   ON ss.OutComeMessageGUID = TODO.OutComeMessageGUID
                 JOIN CMS_UserSettings AS CMS_US
                   ON CMS_US.UserSettingsUserID = ss.UserID
                  AND CMS_US.HFitUserMPINumber > 0
                  AND CMS_US.HFitUserMPINumber IS NOT NULL;

GO
PRINT 'Created view view_EDW_SmallStepResponses';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO

-- use KenticoCMS_Prod1

PRINT 'Creating view view_EDW_SmallStepResponses_CT';
PRINT 'Generated FROM: view_EDW_SmallStepResponses_CT.SQL';

GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_SmallStepResponses_CT') 
    BEGIN
        PRINT 'VIEW view_EDW_SmallStepResponses_CT, replacing.';
        DROP VIEW
             view_EDW_SmallStepResponses_CT;
    END;
GO

CREATE VIEW dbo.view_EDW_SmallStepResponses_CT
AS
/*
select top 100 * from view_EDW_SmallStepResponses_CT

select distinct count(*), SSItemID
from view_EDW_SmallStepResponses_CT
group by SSItemID 
having count(*) > 1

drop table ##Temp_SmallSteps
go
select  TOP 10 *
into STAGING_EDW_SmallSteps
from view_EDW_SmallStepResponses_CT
select * from ##Temp_SmallSteps
*/

SELECT  
       SS.UserID
     , ACCT.AccountCD
     , CMSSITE.SiteGUID
     , SS.ItemID AS SSItemID
     , SS.ItemCreatedBy AS SSItemCreatedBy
     , SS.ItemCreatedWhen AS SSItemCreatedWhen
     , SS.ItemModifiedBy AS SSItemModifiedBy
     , SS.ItemModifiedWhen AS SSItemModifiedWhen
     , SS.ItemOrder AS SSItemOrder
     , SS.ItemGUID AS SSItemGUID
     , SS.HealthAssesmentUserStartedItemID AS SSHealthAssesmentUserStartedItemID
     , SS.OutComeMessageGUID AS SSOutcomeMessageGuid
     , REPLACE (OutcomeMSG.Message, '&#39;', '''') AS SSOutcomeMessage
     , HAUS.HACampaignNodeGUID
       --, HAUS.ItemID AS HAUSItemID
     , vwCamp.Name AS HACampaignName
     , vwCamp.CampaignStartDate AS HACampaignStartDate
     , vwCamp.CampaignEndDate AS HACampaignEndDate
     , HAUS.HAStartedDt AS HAStartedDate
     , HAUS.HACompletedDt AS HACompletedDate
     , HAUS.HAStartedMode
     , HAUS.HACompletedMode
     , TODO.HaCodeName
     , CMS_US.HFitUserMPINumber
     , null AS DeletedFlg
	, getdate() as LastModifiedDate
     , cast( HASHBYTES ('sha1', ISNULL (LEFT (OutcomeMSG.Message, 2000) , '-') 
			 + ISNULL ( CAST (SS.ItemModifiedBy AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (SS.ItemModifiedWhen AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (SS.ItemOrder AS nvarchar (50)) , '-') 
			 + ISNULL (vwCamp.Name, '-') 
			 + ISNULL ( CAST (vwCamp.CampaignStartDate AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (vwCamp.CampaignEndDate AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (HAUS.HAStartedDt AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (HAUS.HACompletedDt AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (HAUS.HAStartedMode AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (HAUS.HACompletedMode AS nvarchar (50)) , '-') 
			 + ISNULL ( TODO.HaCodeName, '-') 
			 + ISNULL ( CAST (SS.ItemGUID AS nvarCHAR (50)) , '-') 
			 + ISNULL ( CAST (vwCamp.CampaignStartDate AS nvarchar (50)) , '-') 
			 + ISNULL ( CAST (vwCamp.CampaignEndDate AS nvarchar (50)) , '-') 
			 + ISNULL(CAST(CMS_US.HFitUserMPINumber AS NVARCHAR(50)),'-')
			 ) as nvarchar(100)) AS HashCode
     , COALESCE ( 
		  --CT_Hfit_SmallStepResponses.SYS_CHANGE_OPERATION,
				CT_HFit_ToDoSmallSteps.SYS_CHANGE_OPERATION,
				CT_HFit_Account.SYS_CHANGE_OPERATION,
				CT_HFit_OutComeMessages.SYS_CHANGE_OPERATION,
				CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION,
				CT_HFit_HACampaign.SYS_CHANGE_OPERATION,
				CT_CMS_Site.SYS_CHANGE_OPERATION,
				CT_CMS_UserSettings.SYS_CHANGE_OPERATION
       ) AS ChangeType

    --   /********************************************/

     , CT_CMS_UserSettings.UserSettingsID AS CT_UserSettingsID     
     , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CT_CMS_UserSettings_SCV

     , CT_CMS_Site.SiteID AS SiteID_CtID
     , CT_CMS_Site.SYS_CHANGE_OPERATION AS SiteID_CHANGE_OPERATION
     , CT_CMS_Site.SYS_CHANGE_VERSION AS SITE_SCV

     , CT_HFit_HACampaign.HACampaignID AS Campaign_CtID
     , CT_HFit_HACampaign.SYS_CHANGE_VERSION AS Campaign_SCV

     , CT_HFit_HealthAssesmentUserStarted.ItemID AS HealthAssesmentUserStarted_CtID
     , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_VERSION AS HealthAssesmentUserStarted_SCV

     , CT_HFit_OutComeMessages.OutComeMessagesID AS OutComeMessages_CtID
     , CT_HFit_OutComeMessages.SYS_CHANGE_VERSION AS OutComeMessages_SCV

     , CT_HFit_Account.AccountID AS HFit_Account_CtID
     , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV

     , CT_HFit_ToDoSmallSteps.ItemID AS ToDoSmallSteps_CtID
     , CT_HFit_ToDoSmallSteps.SYS_CHANGE_VERSION AS ToDoSmallSteps_SCV

	, CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CT_UserSettings_CHANGE_OPERATION
     , CT_HFit_HACampaign.SYS_CHANGE_OPERATION AS Campaign_CHANGE_OPERATION
     , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION AS HealthAssesmentUserStarted_CHANGE_OPERATION
     , CT_HFit_OutComeMessages.SYS_CHANGE_OPERATION AS OutComeMessages_CHANGE_OPERATION
     , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHANGE_OPERATION
     , CT_HFit_ToDoSmallSteps.SYS_CHANGE_OPERATION AS ToDoSmallSteps_CHANGE_OPERATION

    /* THE BELOW CAUSES A MASSIVE PERFORMANCE HIT - SO IT IS COMMENTED OUT (WDM) */
    , CT_Hfit_SmallStepResponses.ItemID AS SmallStepResponses_CtID
    , CT_Hfit_SmallStepResponses.SYS_CHANGE_VERSION AS SmallStepResponses_SCV
    , CT_Hfit_SmallStepResponses.SYS_CHANGE_OPERATION AS SmallStepResponses_CHANGE_OPERATION

    --, newid() AS RowNbr

       , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
           dbo.Hfit_SmallStepResponses AS SS
               JOIN HFit_HealthAssesmentUserStarted AS HAUS
                   ON HAUS.UserID = SS.UserID
                  AND HAUS.ItemID = SS.HealthAssesmentUserStartedItemID
                 JOIN View_HFit_OutComeMessages_Joined AS OutcomeMSG
                   ON OutcomeMSG.NodeGUID = SS.OutComeMessageGUID
                  AND OutcomeMSG.DocumentCulture = 'en-US'
                 JOIN CMS_UserSite AS USERSITE
                   ON USERSITE.UserID = SS.UserID
                 JOIN CMS_Site AS CMSSITE
                   ON CMSSITE.SiteID = USERSITE.SiteID
                 JOIN View_HFit_HACampaign_Joined AS vwCamp
                   ON vwCamp.NodeGuid = HAUS.HACampaignNodeGUID
                  AND vwCamp.DocumentCulture = 'en-US'
                  AND vwCamp.NodeSiteID = USERSITE.SiteID
                 JOIN HFit_Account AS ACCT
                   ON ACCT.SiteID = USERSITE.SiteID
                 JOIN HFit_ToDoSmallSteps AS TODO
                   ON SS.OutComeMessageGUID = TODO.OutComeMessageGUID
                 JOIN CMS_UserSettings AS CMS_US
                   ON CMS_US.UserSettingsUserID = SS.UserID
                  AND CMS_US.HFitUserMPINumber > 0
                  AND CMS_US.HFitUserMPINumber IS NOT NULL

           /*********************************************/
			 LEFT JOIN CHANGETABLE (CHANGES Hfit_SmallStepResponses, NULL) AS CT_Hfit_SmallStepResponses
                   ON SS.ItemID = CT_Hfit_SmallStepResponses.ItemID
                 LEFT JOIN CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT_CMS_UserSettings
                   ON CMS_US.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site, NULL) AS CT_CMS_Site
                   ON CMSSite.SiteID = CT_CMS_Site.SiteID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HACampaign, NULL) AS CT_HFit_HACampaign
                   ON vwCamp.HACampaignID = CT_HFit_HACampaign.HACampaignID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted, NULL) AS CT_HFit_HealthAssesmentUserStarted
                   ON HAUS.ItemID = CT_HFit_HealthAssesmentUserStarted.ItemID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_OutComeMessages, NULL) AS CT_HFit_OutComeMessages
                   ON OutcomeMSG.OutComeMessagesID = CT_HFit_OutComeMessages.OutComeMessagesID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account, NULL) AS CT_HFit_Account
                   ON ACCT.AccountID = CT_HFit_Account.AccountID
                 LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_ToDoSmallSteps, NULL) AS CT_HFit_ToDoSmallSteps
                   ON TODO.ItemID = CT_HFit_ToDoSmallSteps.ItemID

			 --where 
			 --CT_UserSettings_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null 
				-- Campaign_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null OR
				-- HealthAssesmentUserStarted_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null OR
				-- OutComeMessages_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null OR
				-- HFit_Account_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null OR
				-- ToDoSmallSteps_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null OR
				-- SmallStepResponses_CHANGE_OPERATION.SYS_CHANGE_OPERATION is not null


GO
PRINT 'Created view view_EDW_SmallStepResponses_CT';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Processing view_EDW_BioMetrics: ' + CAST (GETDATE () AS nvarchar (50)) + '  *** view_EDW_BioMetrics.sql (CR11690)';
GO
--drop table [EDW_BiometricViewRejectCriteria]
IF NOT EXISTS (SELECT [name]
			  FROM [sys].[tables]
			  WHERE [name] = 'EDW_BiometricViewRejectCriteria') 
    BEGIN
	   PRINT 'EDW_BiometricViewRejectCriteria NOT found, creating';
	   --This table contains the REJECT specifications for Biometric data. An entry causes all records before a date for a Client or SITE to be ignored.
	   --Use AccountCD and ItemCreatedWhen together OR SiteID and ItemCreatedWhen together. They work and reject in pairs.
	   CREATE TABLE [dbo].[EDW_BiometricViewRejectCriteria]
	   (
	   [AccountCD] nvarchar (8) NOT NULL
	 , [ItemCreatedWhen] datetime2 (7) NOT NULL
	 , [SiteID] int NOT NULL
	 , [RejectGUID] uniqueidentifier NULL
	   );

	   ALTER TABLE [dbo].[EDW_BiometricViewRejectCriteria]
	   ADD CONSTRAINT
		  [DF_EDW_BiometricViewRejectCriteria_RejectGUID] DEFAULT NEWID () FOR [RejectGUID];

	   ALTER TABLE [dbo].[EDW_BiometricViewRejectCriteria] SET (LOCK_ESCALATION = TABLE) ;

	   EXEC [sp_addextendedproperty]
	   @name = N'PURPOSE' , @value = 'This table contains the REJECT specifications for Biometric data. An entry causes all records before a date for a Client or SITE to be ignored. The data is entered as SiteID and Rejection Date OR AccountCD and Rejection Date. All dates prior to the rejection date wil be ignored.' ,
	   @level0type = N'Schema' , @level0name = 'dbo' ,
	   @level1type = N'Table' , @level1name = 'EDW_BiometricViewRejectCriteria';
	   --@level2type = N'Column', @level2name = NULL

	   EXEC [sp_addextendedproperty]
	   @name = N'MS_Description' , @value = 'Use AccountCD and ItemCreatedWhen together, entering a non-existant value for SiteID. They work and reject in pairs and this type of entry will only take AccountCD and ItemCreatedWhen date into consideration.' ,
	   @level0type = N'Schema' , @level0name = 'dbo' ,
	   @level1type = N'Table' , @level1name = 'EDW_BiometricViewRejectCriteria' ,
	   @level2type = N'Column' , @level2name = 'AccountCD';

	   EXEC [sp_addextendedproperty]
	   @name = N'USAGE' , @value = 'Use SiteID and ItemCreatedWhen together, entering a non-existant value for AccountCD. They work and reject in pairs.' ,
	   @level0type = N'Schema' , @level0name = 'dbo' ,
	   @level1type = N'Table' , @level1name = 'EDW_BiometricViewRejectCriteria' ,
	   @level2type = N'Column' , @level2name = 'SiteID';

	   EXEC [sp_addextendedproperty]
	   @name = N'USAGE' , @value = 'Use AccountCD or SiteID and ItemCreatedWhen together. They work and reject in pairs. Any date before this date will NOT be retrieved.' ,
	   @level0type = N'Schema' , @level0name = 'dbo' ,
	   @level1type = N'Table' , @level1name = 'EDW_BiometricViewRejectCriteria' ,
	   @level2type = N'Column' , @level2name = 'ItemCreatedWhen';
    END;
GO

IF EXISTS (SELECT [name]
		   FROM [sys].[views]
		   WHERE [name] = 'view_EDW_BiometricViewRejectCriteria') 
    BEGIN
	   PRINT 'view_EDW_BiometricViewRejectCriteria found, updating';
	   DROP VIEW [view_EDW_BiometricViewRejectCriteria];
    END;
GO

CREATE VIEW [view_EDW_BiometricViewRejectCriteria]
AS SELECT [AccountCD]
	   , [ItemCreatedWhen]
	   , [SiteID]
	   , [RejectGUID]
	FROM [dbo].[EDW_BiometricViewRejectCriteria];
GO
PRINT 'view_EDW_BiometricViewRejectCriteria, updated';
GO

IF NOT EXISTS (SELECT [name]
			  FROM [sys].[indexes]
			  WHERE [name] = 'PKI_EDW_BiometricViewRejectCriteria') 
    BEGIN
	   PRINT 'PKI_EDW_BiometricViewRejectCriteria NOT found, creating';
	   CREATE UNIQUE CLUSTERED INDEX [PKI_EDW_BiometricViewRejectCriteria] ON [dbo].[EDW_BiometricViewRejectCriteria]
	   (
	   [AccountCD] ASC ,
	   [ItemCreatedWhen] ASC ,
	   [SiteID] ASC
	   );
    END;
ELSE
    BEGIN
	   PRINT 'PKI_EDW_BiometricViewRejectCriteria created';
    END;

GO

IF EXISTS (SELECT [name]
		   FROM [sys].[procedures]
		   WHERE [name] = 'proc_Insert_EDW_BiometricViewRejectCriteria') 
    BEGIN
	   PRINT 'proc_Insert_EDW_BiometricViewRejectCriteria found, updating.';
	   DROP PROCEDURE [proc_Insert_EDW_BiometricViewRejectCriteria];
    END;
ELSE
    BEGIN
	   PRINT 'Creating proc_Insert_EDW_BiometricViewRejectCriteria';
    END;
GO

CREATE PROC [proc_Insert_EDW_BiometricViewRejectCriteria] (
	  @AccountCD AS nvarchar (50) , @ItemCreatedWhen AS datetime , @SiteID AS int) 
AS
BEGIN

    IF @SiteID IS NULL
	   BEGIN
		  SET @SiteID = -1;
	   END;

    DECLARE @iCnt integer = 0;
    SET @iCnt = (SELECT COUNT (*) 
			    FROM [EDW_BiometricViewRejectCriteria]
			    WHERE [AccountCD] = @AccountCD
				 AND [SiteID] = @SiteID) ;
    IF @iCnt <= 0
	   BEGIN
		  INSERT INTO [dbo].[EDW_BiometricViewRejectCriteria]
		  ([AccountCD]
		 , [ItemCreatedWhen]
		 , [SiteID]
		  ) 
		  VALUES
		  (@AccountCD
		  , @ItemCreatedWhen
		  , @SiteID
		  );
		  PRINT 'ADDED ' + @AccountCD + ' to EDW_BiometricViewRejectCriteria.';
	   END;
    ELSE
	   BEGIN
		  PRINT 'Account ' + @AccountCD + ' already defined to EDW_BiometricViewRejectCriteria.';
	   END;
END;

GO

IF EXISTS (SELECT [name]
		   FROM [sys].[procedures]
		   WHERE [name] = 'proc_Delete_EDW_BiometricViewRejectCriteria_Acct') 
    BEGIN
	   PRINT 'proc_Delete_EDW_BiometricViewRejectCriteria_Acct  found, updating.';
	   DROP PROCEDURE [proc_Delete_EDW_BiometricViewRejectCriteria_Acct];
    END;
ELSE
    BEGIN
	   PRINT 'Creating proc_Delete_EDW_BiometricViewRejectCriteria_Acct';
    END;

GO

CREATE PROC [proc_Delete_EDW_BiometricViewRejectCriteria_Acct] (
	  @AccountCD AS nvarchar (50) , @ItemCreatedWhen AS datetime) 
AS
BEGIN
    DELETE FROM [dbo].[EDW_BiometricViewRejectCriteria]
	 WHERE [AccountCD] = @AccountCD
	   AND [ItemCreatedWhen] = @ItemCreatedWhen;
END;

GO
IF EXISTS (SELECT [name]
		   FROM [sys].[procedures]
		   WHERE [name] = 'proc_Delete_EDW_BiometricViewRejectCriteria_Site') 
    BEGIN
	   PRINT 'proc_Delete_EDW_BiometricViewRejectCriteria_Site  found, updating.';
	   DROP PROCEDURE [proc_Delete_EDW_BiometricViewRejectCriteria_Site];
    END;
ELSE
    BEGIN
	   PRINT 'Creating proc_Delete_EDW_BiometricViewRejectCriteria_Site';
    END;

GO

CREATE PROC [proc_Delete_EDW_BiometricViewRejectCriteria_Site] (
	  @SiteID AS int , @ItemCreatedWhen AS datetime) 
AS
BEGIN
    DELETE FROM [dbo].[EDW_BiometricViewRejectCriteria]
	 WHERE [SiteID] = @SiteID
	   AND [ItemCreatedWhen] = @ItemCreatedWhen;

END;
GO

IF EXISTS (SELECT [name]
		   FROM [sys].[views]
		   WHERE [name] = 'view_EDW_BioMetrics') 
    BEGIN
	   PRINT 'Removing current view_EDW_BioMetrics.';
	   DROP VIEW [view_EDW_BioMetrics];
    END;
GO
PRINT 'Creating view_EDW_BioMetrics.';
GO

CREATE VIEW [dbo].[view_EDW_BioMetrics]
AS
--*****************************************************************************************************************************************
--************** TEST Criteria and Results for view_EDW_BioMetrics ************************************************************************
--INSERT INTO [dbo].[EDW_BiometricViewRejectCriteria] ([AccountCD],[ItemCreatedWhen],[SiteID]) VALUES('XX','2013-12-01',17  )  
--NOTE:		XX is used so that the AccountCD is NOT taken into account and only SiteID and ItemCreatedWhen is used.
--GO	--Tested by wdm on 11.21.2014

-- select count(*) from view_EDW_BioMetrics		--(wdm) & (jc) : testing on {ProdStaging = 136348} / With reject on 136339 = 9

--select * from view_EDW_BioMetrics	 where AccountCD = 'peabody' AND COALESCE (EventDate,ItemCreatedWhen) is not NULL and COALESCE (EventDate,ItemCreatedWhen) < '2013-12-01'	: 9 
--select * from view_Hfit_BioMetrics where AccountCD = 'peabody' AND COALESCE (EventDate,ItemCreatedWhen) is not NULL and COALESCE (EventDate,ItemCreatedWhen) < '2013-12-01'	: 9 

--select * from view_EDW_BioMetrics	where AccountCD = 'peabody' and ItemCreatedWhen < '2013-12-01 00:00:00.000'		: 7 
--select * from view_EDW_BioMetrics	where AccountCD = 'peaboOK dy' and EventDate < '2013-12-01 00:00:00.000'		: 9 

--select count(*) from view_EDW_BioMetrics		--NO REJECT FILTER : 136348
--select count(*) from view_EDW_BioMetrics		--REJECT FILTER ON : 136339 == 9 GOOD TEST

--select count(*) from view_Hfit_BioMetrics	:136393
--select count(*) from view_Hfit_BioMetrics where COALESCE (EventDate,ItemCreatedWhen) is not NULL 	:136348

--NOTE: All tests passed 11.21.2014, 11.23.2014, 12.2.2014, 12,4,2014

--truncate table EDW_BiometricViewRejectCriteria

--INSERT INTO [dbo].[EDW_BiometricViewRejectCriteria]([AccountCD],[ItemCreatedWhen],[SiteID])VALUES('peabody','2013-12-01',-1)         
--NOTE:		-1 is used so that the SiteID is NOT taken into account and only AccountCD and ItemCreatedWhen is used.
--GO	--Tested by wdm on 11.21.2014

--select * from view_EDW_BioMetrics where ItemCreatedWhen < '2013-12-01' and AccountCD = 'peabody' returns 1034
--		so the number should be 43814 - 1034 = 42780 with AccountCD = 'peabody' and ItemCreatedWhen = '2014-03-19'
--		in table EDW_BiometricViewRejectCriteria. And it worked (wdm) 11.21.2014
--GO	--Tested by wdm on 11.21.2014

--select * from view_EDW_BioMetrics where SiteID = 17 and ItemCreatedWhen < '2014-03-19' returns 22,974
--		so the number should be 43814 - 22974 = 20840 with SIteID = 17 and ItemCreatedWhen = '2014-03-19'
--		in table EDW_BiometricViewRejectCriteria. And it worked (wdm) 11.21.2014
--GO	--Tested by wdm on 11.21.2014

--	11.24.2014 (wdm) -	requested a review of this code and validation with EDW.

-- 12.22.2014 - Received an SR from John C. via Richard to add two fields to the view, Table name and Item ID.
-- 12.23.2014 - Added the Vendor ID and Vendor name to the view via the HFit_LKP_TrackerVendor table
-- 12.25.2014 - Added the EDW_BiometricViewRejectCriteria to allow selective rejection of historical records
-- 01.19.2014 - Prepared for Simpson Willams

--*****************************************************************************************************************************************
SELECT DISTINCT
--HFit_UserTracker
[HFUT].[UserID]
, [cus].[UserSettingsUserGUID] AS [UserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast(NULL as datetime) AS [CreatedDate]
, cast(NULL as datetime) AS [ModifiedDate]
, NULL AS [Notes]
, NULL AS [IsProfessionallyCollected]
, NULL AS [EventDate]
, 'Not Build Yet' AS [EventName]

--HFit_TrackerWeight
, NULL AS [PPTWeight]

--HFit_TrackerHbA1C
, NULL AS [PPTHbA1C]

--HFit_TrackerCholesterol
, NULL AS [Fasting]
, NULL AS [HDL]
, NULL AS [LDL]
, NULL AS [Ratio]
, NULL AS [Total]
, NULL AS [Triglycerides]

--HFit_TrackerBloodSugarandGlucose
, NULL AS [Glucose]
, NULL AS [FastingState]

--HFit_TrackerBloodPressure
, NULL AS [Systolic]
, NULL AS [Diastolic]

--HFit_TrackerBodyFat
, NULL AS [PPTBodyFatPCT]

--HFit_TrackerBMI
, NULL AS [BMI]

--HFit_TrackerBodyMeasurements
, NULL AS [WaistInches]
, NULL AS [HipInches]
, NULL AS [ThighInches]
, NULL AS [ArmInches]
, NULL AS [ChestInches]
, NULL AS [CalfInches]
, NULL AS [NeckInches]

--HFit_TrackerHeight
, NULL AS [Height]

--HFit_TrackerRestingHeartRate
, NULL AS [HeartRate]
, --HFit_TrackerShots
NULL AS [FluShot]
, NULL AS [PneumoniaShot]

--HFit_TrackerTests
, NULL AS [PSATest]
, NULL AS [OtherExam]
, NULL AS [TScore]
, NULL AS [DRA]
, NULL AS [CotinineTest]
, NULL AS [ColoCareKit]
, NULL AS [CustomTest]
, NULL AS [CustomDesc]
, NULL AS [CollectionSource]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFUT].[ItemCreatedWhen] = COALESCE ([HFUT].[ItemModifiedWhen] , [hfut].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFUT].[ItemCreatedWhen] as datetime) as ItemCreatedWhen
, cast([HFUT].[ItemModifiedWhen] as datetime) as ItemModifiedWhen
, 0   AS [TrackerCollectionSourceID]
, [HFUT].[itemid]
, 'HFit_UserTracker' AS [TBL]
, NULL AS [VendorID]		--VENDOR.ItemID as VendorID
, NULL AS [VendorName]		--VENDOR.VendorName
  FROM
	  [dbo].[HFit_UserTracker] AS [HFUT]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [hfut].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
  --left outer join HFit_LKP_TrackerVendor as VENDOR on HFUT.VendorID = VENDOR.ItemID
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE [HFUT].[ItemCreatedWhen] < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND [HFUT].[ItemCreatedWhen] < [ItemCreatedWhen]) 
	   --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified within table EDW_BiometricViewRejectCriteria
    AND [HFUT].[ItemCreatedWhen] IS NOT NULL		--Add per Robert and Laura 12.4.2014

UNION ALL
SELECT distinct
[hftw].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTW].[ItemCreatedWhen] as datetime) as ItemCreatedWhen
, cast([HFTW].[ItemModifiedWhen] as datetime) as ItemModifiedWhen
, [HFTW].[Notes]
, [HFTW].[IsProfessionallyCollected]
, cast([HFTW].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, [hftw].Value AS [PPTWeight]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTW].[ItemCreatedWhen] = COALESCE ([HFTW].[ItemModifiedWhen] , [HFTW].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTW].[ItemCreatedWhen] as datetime) as ItemCreatedWhen
, cast([HFTW].[ItemModifiedWhen] as datetime) as ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTW].[itemid]
, 'HFit_TrackerWeight' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerWeight] AS [HFTW]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTW].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTW].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTW].[VendorID] = [VENDOR].[ItemID]
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTW].[EventDate] , [HFTW].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTW].[EventDate] , [HFTW].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTW].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTW].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014			

UNION ALL
SELECT distinct
[HFTHA].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTHA].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTHA].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTHA].[Notes]
, [HFTHA].[IsProfessionallyCollected]
, cast([HFTHA].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, [HFTHA].Value AS [PPTHbA1C]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTHA].[ItemCreatedWhen] = COALESCE ([HFTHA].[ItemModifiedWhen] , [HFTHA].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTHA].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTHA].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTHA].[itemid]
, 'HFit_TrackerHbA1c' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerHbA1c] AS [HFTHA]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTHA].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTHA].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTHA].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTHA].[EventDate] , [HFTHA].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTHA].[EventDate] , [HFTHA].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTHA].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTHA].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTC].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTC].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTC].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTC].[Notes]
, [HFTC].[IsProfessionallyCollected]
, cast([HFTC].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, [HFTC].[Fasting]
, [HFTC].[HDL]
, [HFTC].[LDL]
, [HFTC].[Ratio]
, [HFTC].[Total]
, [HFTC].[Tri]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTC].[ItemCreatedWhen] = COALESCE ([HFTC].[ItemModifiedWhen] , [HFTC].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTC].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTC].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTC].[itemid]
, 'HFit_TrackerCholesterol' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerCholesterol] AS [HFTC]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTC].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTC].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTC].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTC].[EventDate] , [HFTC].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTC].[EventDate] , [HFTC].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTC].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTC].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTBSAG].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTBSAG].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBSAG].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTBSAG].[Notes]
, [HFTBSAG].[IsProfessionallyCollected]
, cast([HFTBSAG].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTBSAG].[Units]
, [HFTBSAG].[FastingState]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTBSAG].[ItemCreatedWhen] = COALESCE ([HFTBSAG].[ItemModifiedWhen] , [HFTBSAG].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTBSAG].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBSAG].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTBSAG].[itemid]
, 'HFit_TrackerBloodSugarAndGlucose' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerBloodSugarAndGlucose] AS [HFTBSAG]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTBSAG].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTBSAG].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTBSAG].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTBSAG].[EventDate] , [HFTBSAG].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTBSAG].[EventDate] , [HFTBSAG].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTBSAG].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTBSAG].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTBP].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTBP].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBP].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTBP].[Notes]
, [HFTBP].[IsProfessionallyCollected]
, cast([HFTBP].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTBP].[Systolic]
, [HFTBP].[Diastolic]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTBP].[ItemCreatedWhen] = COALESCE ([HFTBP].[ItemModifiedWhen] , [HFTBP].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTBP].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBP].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTBP].[itemid]
, 'HFit_TrackerBloodPressure' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerBloodPressure] AS [HFTBP]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTBP].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTBP].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTBP].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTBP].[EventDate] , [HFTBP].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTBP].[EventDate] , [HFTBP].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTBP].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTBP].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTBF].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTBF].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBF].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTBF].[Notes]
, [HFTBF].[IsProfessionallyCollected]
, cast([HFTBF].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTBF].Value AS [PPTBodyFatPCT]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTBF].[ItemCreatedWhen] = COALESCE ([HFTBF].[ItemModifiedWhen] , [HFTBF].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTBF].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBF].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTBF].[itemid]
, 'HFit_TrackerBodyFat' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerBodyFat] AS [HFTBF]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTBF].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTBF].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTBF].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTBF].[EventDate] , [HFTBF].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTBF].[EventDate] , [HFTBF].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTBF].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTBF].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTB].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTB].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTB].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTB].[Notes]
, [HFTB].[IsProfessionallyCollected]
, cast([HFTB].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTB].[BMI]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTB].[ItemCreatedWhen] = COALESCE ([HFTB].[ItemModifiedWhen] , [HFTB].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTB].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTB].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTB].[itemid]
, 'HFit_TrackerBMI' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerBMI] AS [HFTB]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTB].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTB].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTB].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified within table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTB].[EventDate] , [HFTB].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTB].[EventDate] , [HFTB].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTB].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTB].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTBM].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTBM].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBM].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTBM].[Notes]
, [HFTBM].[IsProfessionallyCollected]
, cast([HFTBM].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTBM].[WaistInches]
, [HFTBM].[HipInches]
, [HFTBM].[ThighInches]
, [HFTBM].[ArmInches]
, [HFTBM].[ChestInches]
, [HFTBM].[CalfInches]
, [HFTBM].[NeckInches]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTBM].[ItemCreatedWhen] = COALESCE ([HFTBM].[ItemModifiedWhen] , [HFTBM].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTBM].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTBM].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTBM].[itemid]
, 'HFit_TrackerBodyMeasurements' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerBodyMeasurements] AS [HFTBM]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTBM].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTBM].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTBM].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTBM].[EventDate] , [HFTBM].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTBM].[EventDate] , [HFTBM].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTBM].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTBM].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTH].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTH].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTH].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTH].[Notes]
, [HFTH].[IsProfessionallyCollected]
, cast([HFTH].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTH].[Height]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTH].[ItemCreatedWhen] = COALESCE ([HFTH].[ItemModifiedWhen] , [HFTH].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTH].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTH].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTH].[itemid]
, 'HFit_TrackerHeight' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerHeight] AS [HFTH]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTH].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTH].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTH].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria		
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTH].[EventDate] , [HFTH].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTH].[EventDate] , [HFTH].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTH].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTH].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014
UNION ALL
SELECT distinct
[HFTRHR].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTRHR].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTRHR].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTRHR].[Notes]
, [HFTRHR].[IsProfessionallyCollected]
, cast([HFTRHR].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTRHR].[HeartRate]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTRHR].[ItemCreatedWhen] = COALESCE ([HFTRHR].[ItemModifiedWhen] , [HFTRHR].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTRHR].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTRHR].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTRHR].[itemid]
, 'HFit_TrackerRestingHeartRate' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerRestingHeartRate] AS [HFTRHR]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTRHR].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTRHR].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTRHR].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTRHR].[EventDate] , [HFTRHR].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTRHR].[EventDate] , [HFTRHR].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTRHR].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTRHR].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTS].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTS].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTS].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTS].[Notes]
, [HFTS].[IsProfessionallyCollected]
, cast([HFTS].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTS].[FluShot]
, [HFTS].[PneumoniaShot]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTS].[ItemCreatedWhen] = COALESCE ([HFTS].[ItemModifiedWhen] , [HFTS].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTS].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTS].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTS].[itemid]
, 'HFit_TrackerShots' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerShots] AS [HFTS]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTS].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTS].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTS].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTS].[EventDate] , [HFTS].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTS].[EventDate] , [HFTS].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTS].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTS].[EventDate] IS NOT NULL)		--Add per RObert and Laura 12.4.2014

UNION ALL
SELECT distinct
[HFTT].[UserID]
, [cus].[UserSettingsUserGUID]
, [cus].[HFitUserMpiNumber]
, [cus2].[SiteID]
, [cs].[SiteGUID]
, cast([HFTT].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTT].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTT].[Notes]
, [HFTT].[IsProfessionallyCollected]
, cast([HFTT].[EventDate] as datetime ) as EventDate
, 'Not Build Yet' AS [EventName]
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, NULL
, [HFTT].[PSATest]
, [HFTT].[OtherExam]
, [HFTT].[TScore]
, [HFTT].[DRA]
, [HFTT].[CotinineTest]
, [HFTT].[ColoCareKit]
, [HFTT].[CustomTest]
, [HFTT].[CustomDesc]
, [HFTCS].[CollectionSourceName_External]
, [HFA].[AccountID]
, [HFA].[AccountCD]
, CASE
	 WHEN [HFTT].[ItemCreatedWhen] = COALESCE ([HFTT].[ItemModifiedWhen] , [HFTT].[ItemCreatedWhen]) 
	 THEN 'I'
	 ELSE 'U'
  END AS [ChangeType]
, cast([HFTT].[ItemCreatedWhen] as datetime) ItemCreatedWhen
, cast([HFTT].[ItemModifiedWhen] as datetime) ItemModifiedWhen
, [HFTCS].[TrackerCollectionSourceID]
, [HFTT].[itemid]
, 'HFit_TrackerTests' AS [TBL]
, [VENDOR].[ItemID] AS [VendorID]
, [VENDOR].[VendorName]
  FROM
	  [dbo].[HFit_TrackerTests] AS [HFTT]
		 INNER JOIN [dbo].[HFit_TrackerCollectionSource] AS [HFTCS]
			ON [HFTT].[TrackerCollectionSourceID] = [HFTCS].[TrackerCollectionSourceID]
		 INNER JOIN [dbo].[CMS_UserSettings] AS [CUS]
			ON [HFTT].[UserID] = [cus].[UserSettingsUserID]
		 INNER JOIN [dbo].[CMS_UserSite] AS [CUS2]
			ON [cus].[UserSettingsUserID] = [cus2].[UserID]
		 INNER JOIN [dbo].[CMS_Site] AS [CS]
			ON [CUS2].[SiteID] = [CS].[SiteID]
		 INNER JOIN [dbo].[HFit_Account] AS [HFA]
			ON [cs].[SiteID] = [HFA].[SiteID]
		 LEFT OUTER JOIN [HFit_LKP_TrackerVendor] AS [VENDOR]
			ON [HFTT].[VendorID] = [VENDOR].[ItemID]
  --11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified wihtin table EDW_BiometricViewRejectCriteria
  WHERE [CS].[SITEID] NOT IN (SELECT [SiteID]
						  FROM [EDW_BiometricViewRejectCriteria]
						  WHERE COALESCE ([HFTT].[EventDate] , [HFTT].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND [HFA].[AccountCD] NOT IN (SELECT [AccountCD]
							 FROM [EDW_BiometricViewRejectCriteria]
							 WHERE [HFA].[AccountCD] = [AccountCD]
							   AND COALESCE ([HFTT].[EventDate] , [HFTT].[ItemCreatedWhen]) < [ItemCreatedWhen]) 
    AND ([HFTT].[ItemCreatedWhen] IS NOT NULL
	 OR [HFTT].[EventDate] IS NOT NULL);		--Add per RObert and Laura 12.4.2014

--HFit_TrackerBMI
--HFit_TrackerBodyMeasurements
--HFit_TrackerHeight
--HFit_TrackerRestingHeartRate
--HFit_TrackerShots
--HFit_TrackerTests

GO

PRINT 'Created view_EDW_BioMetrics: ' + CAST (GETDATE () AS nvarchar (50)) ;
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_BioMetrics.sql';
GO

----***************************************************************************************************************************
----** REMOVE THE INSERTS AFTER INTITAL LOAD
----***************************************************************************************************************************
--truncate table EDW_BiometricViewRejectCriteria ;
--go 
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'trstmark','11/4/2013',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'entergy','1/6/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'mcwp','1/27/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'stateneb','4/1/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'jnj','5/28/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'coopers','7/1/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'cnh','8/4/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'amat','8/4/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'dupont','8/18/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'ejones','9/3/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'avera','9/15/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'sprvalu','9/18/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'firstgrp','10/6/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'rexnord','12/2/2014',-1) ;
--GO
PRINT '***** COMPLETED : view_EDW_BioMetrics.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
-- use KenticoCMS_Prod1

GO

PRINT 'Creating view_EDW_BioMetrics_CT: ' + CAST ( GETDATE () AS nvarchar (50)) + '  *** FROM: view_EDW_BioMetrics_CT.sql';

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.views
                   WHERE name = 'view_EDW_BioMetrics_CT') 

    BEGIN

        DROP VIEW
             view_EDW_BioMetrics_CT;
    END;

GO

/*-----------------------------------------------------------------
******************************************
--select * from HFit_UserTracker
--update HFit_UserTracker set UserID = 71 where ItemID in (1,2,4,5)
--update HFit_UserTracker set UserID = 70 where ItemID in (1,2,4,5)

1160148
select count(*) from view_EDW_BioMetrics_CT
WHERE CT_ChangeType IS NOT NULL

0
select count(*) from view_EDW_BioMetrics_CT
WHERE CT_ChangeType IS NULL

select top 100 * from view_EDW_BioMetrics_CT
******************************************
*/

CREATE VIEW dbo.view_EDW_BioMetrics_CT
AS SELECT DISTINCT
          HFUT.UserID
        , cus.UserSettingsUserGUID AS UserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , NULL AS CreatedDate
        , NULL AS ModifiedDate
        , NULL AS Notes
        , NULL AS IsProfessionallyCollected
        , NULL AS EventDate
        , 'Not Build Yet' AS EventName
        , NULL AS PPTWeight
        , NULL AS PPTHbA1C
        , NULL AS Fasting
        , NULL AS HDL
        , NULL AS LDL
        , NULL AS Ratio
        , NULL AS Total
        , NULL AS Triglycerides
        , NULL AS Glucose
        , NULL AS FastingState
        , NULL AS Systolic
        , NULL AS Diastolic
        , NULL AS PPTBodyFatPCT
        , NULL AS BMI
        , NULL AS WaistInches
        , NULL AS HipInches
        , NULL AS ThighInches
        , NULL AS ArmInches
        , NULL AS ChestInches
        , NULL AS CalfInches
        , NULL AS NeckInches
        , NULL AS Height
        , NULL AS HeartRate
        , NULL AS FluShot
        , NULL AS PneumoniaShot
        , NULL AS PSATest
        , NULL AS OtherExam
        , NULL AS TScore
        , NULL AS DRA
        , NULL AS CotinineTest
        , NULL AS ColoCareKit
        , NULL AS CustomTest
        , NULL AS CustomDesc
        , NULL AS CollectionSource
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFUT.ItemCreatedWhen = COALESCE ( HFUT.ItemModifiedWhen , hfut.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFUT.ItemCreatedWhen
        , HFUT.ItemModifiedWhen
        , 0 AS TrackerCollectionSourceID
        , HFUT.itemid
        , 'HFit_UserTracker' AS TBL
        , NULL AS VendorID
        , NULL AS VendorName

        , HASHBYTES ( 'SHA1' ,
          ISNULL ( CAST ( HFUT.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID  AS nvarchar (50)) , '-') + ISNULL ( CAST (
          cus.HFitUserMpiNumber  AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( cs.SiteGUID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD  AS nvarchar (50)) , '-') + ISNULL (
          CAST (
          HFUT.ItemCreatedWhen  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFUT.ItemModifiedWhen  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFUT.itemid  AS nvarchar (50)) , '-') + 'HFit_UserTracker') 
          AS HashCode

        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , NULL AS HFit_TrackerSource_CHGTYPE

          --**********************************************************************************************************
          --	   THE FOLLOWING COALESCE STATEMENT IS DIFFERENT FROM ALL OTHERS IN THAT TRACKER SOURCE IS NOT NEEDED 
          --**********************************************************************************************************
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_UserTracker AS HFUT
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON hfut.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_UserTracker , NULL) AS CT_TrackerTable
                    ON HFUT.ItemID = CT_TrackerTable.ItemID --NOT Needed in this instance only
               --LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource, NULL) AS [CT_TrackerSource] 
               --    ON HFTCS.[ItemID] = CT_TrackerTable.[ItemID]   
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE HFUT.ItemCreatedWhen < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 HFUT.ItemCreatedWhen < ItemCreatedWhen) AND
          HFUT.ItemCreatedWhen IS NOT NULL

/*------------------------------------------------------------------------------------------------------------------------------------------------
************************************************************************************************************************************************
11.21.2014 (wdm) add so that Account or Site data rows could be rejected if prior to a date specified within table EDW_BiometricViewRejectCriteria
12.04.2014  (wdm) Add per Robert and Laura 
************************************************************************************************************************************************
*/

   UNION ALL
   SELECT DISTINCT
          hftw.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTW.ItemCreatedWhen
        , HFTW.ItemModifiedWhen
        , HFTW.Notes
        , HFTW.IsProfessionallyCollected
        , HFTW.EventDate
        , 'Not Build Yet' AS EventName
        , hftw.Value AS PPTWeight
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTW.ItemCreatedWhen = COALESCE ( HFTW.ItemModifiedWhen , HFTW.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTW.ItemCreatedWhen
        , HFTW.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTW.itemid
        , 'HFit_TrackerWeight' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , +ISNULL ( CAST ( hftw.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTW.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTW.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTW.Notes , 1000) , '-') + ISNULL ( CAST ( HFTW.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTW.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( hftw.Value AS nvarchar (50)) , '-') + ISNULL ( HFTCS.CollectionSourceName_External , '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTW.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTW.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTW.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 500) , '-') + 'HFit_TrackerWeight') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerWeight AS HFTW
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTW.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTW.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTW.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerWeight , NULL) AS CT_TrackerTable
                    ON HFTW.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTW.EventDate , HFTW.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTW.EventDate , HFTW.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTW.ItemCreatedWhen IS NOT NULL OR
            HFTW.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014			

   UNION ALL
   SELECT DISTINCT
          HFTHA.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTHA.ItemCreatedWhen
        , HFTHA.ItemModifiedWhen
        , HFTHA.Notes
        , HFTHA.IsProfessionallyCollected
        , HFTHA.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , HFTHA.Value AS PPTHbA1C
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTHA.ItemCreatedWhen = COALESCE ( HFTHA.ItemModifiedWhen , HFTHA.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTHA.ItemCreatedWhen
        , HFTHA.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTHA.itemid
        , 'HFit_TrackerHbA1c' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , +ISNULL ( CAST ( HFTHA.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTHA.Notes , 1000) , '-') + ISNULL ( CAST ( HFTHA.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.Value AS nvarchar (250)) , '-') + ISNULL ( LEFT (
                               HFTCS.CollectionSourceName_External , 1000) , '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTHA.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTHA.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 250) , '-') + 'HFit_TrackerHbA1c') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerHbA1c AS HFTHA
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTHA.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTHA.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTHA.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHbA1c , NULL) AS CT_TrackerTable
                    ON HFTHA.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTHA.EventDate , HFTHA.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTHA.EventDate , HFTHA.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTHA.ItemCreatedWhen IS NOT NULL OR
            HFTHA.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTC.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTC.ItemCreatedWhen
        , HFTC.ItemModifiedWhen
        , HFTC.Notes
        , HFTC.IsProfessionallyCollected
        , HFTC.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , HFTC.Fasting
        , HFTC.HDL
        , HFTC.LDL
        , HFTC.Ratio
        , HFTC.Total
        , HFTC.Tri
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTC.ItemCreatedWhen = COALESCE ( HFTC.ItemModifiedWhen , HFTC.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTC.ItemCreatedWhen
        , HFTC.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTC.itemid
        , 'HFit_TrackerCholesterol' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' ,
          + ISNULL ( CAST ( HFTC.UserID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID  AS nvarchar (50)) , '-') + ISNULL (
          CAST ( cus.HFitUserMpiNumber  AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( cs.SiteGUID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.ItemCreatedWhen  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.ItemModifiedWhen  AS nvarchar (50)) ,
          '-') + ISNULL ( LEFT ( HFTC.Notes , 1000) , '-') + ISNULL ( CAST ( HFTC.IsProfessionallyCollected  AS nvarchar (50)) , '-') + ISNULL ( CAST
          ( HFTC.EventDate  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.Fasting  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.HDL  AS nvarchar (50)) ,
          '-') + ISNULL ( CAST ( HFTC.LDL  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.Ratio  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.Total  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.Tri  AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 250) , '-') + ISNULL ( CAST
          ( HFA.AccountID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.ItemCreatedWhen
          AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.ItemModifiedWhen  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID  AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTC.itemid  AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID  AS nvarchar (50)) , '-') + ISNULL (
          LEFT ( VENDOR.VendorName , 250) , '-') + 'HFit_TrackerCholesterol') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerCholesterol AS HFTC
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTC.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTC.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTC.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCholesterol , NULL) AS CT_TrackerTable
                    ON HFTC.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTC.EventDate , HFTC.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTC.EventDate , HFTC.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTC.ItemCreatedWhen IS NOT NULL OR
            HFTC.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTBSAG.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTBSAG.ItemCreatedWhen
        , HFTBSAG.ItemModifiedWhen
        , HFTBSAG.Notes
        , HFTBSAG.IsProfessionallyCollected
        , HFTBSAG.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTBSAG.Units
        , HFTBSAG.FastingState
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTBSAG.ItemCreatedWhen = COALESCE ( HFTBSAG.ItemModifiedWhen , HFTBSAG.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTBSAG.ItemCreatedWhen
        , HFTBSAG.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTBSAG.itemid
        , 'HFit_TrackerBloodSugarAndGlucose' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , +ISNULL ( CAST ( HFTBSAG.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBSAG.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTBSAG.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTBSAG.Notes , 250) , '-') + ISNULL ( CAST ( HFTBSAG.IsProfessionallyCollected
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBSAG.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBSAG.Units AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBSAG.FastingState AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 250) , '-') + ISNULL ( CAST (
                               HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBSAG.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTBSAG.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTBSAG.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT (
                               VENDOR.VendorName , 250) , '-') + 'HFit_TrackerBloodSugarAndGlucose') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerBloodSugarAndGlucose AS HFTBSAG
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTBSAG.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTBSAG.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTBSAG.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodSugarAndGlucose , NULL) AS CT_TrackerTable
                    ON HFTBSAG.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTBSAG.EventDate , HFTBSAG.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTBSAG.EventDate , HFTBSAG.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTBSAG.ItemCreatedWhen IS NOT NULL OR
            HFTBSAG.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTBP.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTBP.ItemCreatedWhen
        , HFTBP.ItemModifiedWhen
        , HFTBP.Notes
        , HFTBP.IsProfessionallyCollected
        , HFTBP.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTBP.Systolic
        , HFTBP.Diastolic
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTBP.ItemCreatedWhen = COALESCE ( HFTBP.ItemModifiedWhen , HFTBP.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTBP.ItemCreatedWhen
        , HFTBP.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTBP.itemid
        , 'HFit_TrackerBloodPressure' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , +ISNULL ( CAST ( HFTBP.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBP.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBP.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTBP.Notes , 500) , '-') + ISNULL ( CAST ( HFTBP.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL
                               ( CAST ( HFTBP.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBP.Systolic AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTBP.Diastolic AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 500) , '-') + ISNULL ( CAST ( HFA.AccountID
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBP.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBP.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTBP.itemid
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName ,
                               500) , '-') + 'HFit_TrackerBloodPressure') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerBloodPressure AS HFTBP
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTBP.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTBP.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTBP.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodPressure , NULL) AS CT_TrackerTable
                    ON HFTBP.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTBP.EventDate , HFTBP.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTBP.EventDate , HFTBP.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTBP.ItemCreatedWhen IS NOT NULL OR
            HFTBP.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTBF.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTBF.ItemCreatedWhen
        , HFTBF.ItemModifiedWhen
        , HFTBF.Notes
        , HFTBF.IsProfessionallyCollected
        , HFTBF.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTBF.Value AS PPTBodyFatPCT
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTBF.ItemCreatedWhen = COALESCE ( HFTBF.ItemModifiedWhen , HFTBF.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTBF.ItemCreatedWhen
        , HFTBF.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTBF.itemid
        , 'HFit_TrackerBodyFat' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTBF.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTBF.Notes , 1000) , '-') + ISNULL ( CAST ( HFTBF.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.Value AS nvarchar (50)) , '-') + ISNULL ( LEFT (
                               HFTCS.CollectionSourceName_External , 250) , '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTBF.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBF.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 250) , '-') + 'HFit_TrackerBodyFat') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerBodyFat AS HFTBF
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTBF.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTBF.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTBF.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyFat , NULL) AS CT_TrackerTable
                    ON HFTBF.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTBF.EventDate , HFTBF.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTBF.EventDate , HFTBF.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTBF.ItemCreatedWhen IS NOT NULL OR
            HFTBF.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTB.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTB.ItemCreatedWhen
        , HFTB.ItemModifiedWhen
        , HFTB.Notes
        , HFTB.IsProfessionallyCollected
        , HFTB.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTB.BMI
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTB.ItemCreatedWhen = COALESCE ( HFTB.ItemModifiedWhen , HFTB.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTB.ItemCreatedWhen
        , HFTB.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTB.itemid
        , 'HFit_TrackerBMI' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTB.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cs.SiteGUID
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.ItemModifiedWhen AS nvarchar (50)) ,
                               '-') + ISNULL ( LEFT ( HFTB.Notes , 1000) , '-') + ISNULL ( CAST ( HFTB.IsProfessionallyCollected AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTB.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.BMI AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 1000) ,
                               '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTB.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerBMI') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerBMI AS HFTB
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTB.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTB.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTB.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBMI , NULL) AS CT_TrackerTable
                    ON HFTB.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTB.EventDate , HFTB.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTB.EventDate , HFTB.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTB.ItemCreatedWhen IS NOT NULL OR
            HFTB.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTBM.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTBM.ItemCreatedWhen
        , HFTBM.ItemModifiedWhen
        , HFTBM.Notes
        , HFTBM.IsProfessionallyCollected
        , HFTBM.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTBM.WaistInches
        , HFTBM.HipInches
        , HFTBM.ThighInches
        , HFTBM.ArmInches
        , HFTBM.ChestInches
        , HFTBM.CalfInches
        , HFTBM.NeckInches
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTBM.ItemCreatedWhen = COALESCE ( HFTBM.ItemModifiedWhen , HFTBM.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTBM.ItemCreatedWhen
        , HFTBM.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTBM.itemid
        , 'HFit_TrackerBodyMeasurements' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTBM.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTBM.Notes , 1000) , '-') + ISNULL ( CAST ( HFTBM.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.WaistInches AS nvarchar (50)) , '-') + ISNULL ( CAST
                               ( HFTBM.HipInches AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.ThighInches AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.ArmInches AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTBM.ChestInches AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.CalfInches AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTBM.NeckInches AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 1000) , '-') + ISNULL ( CAST
                               ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTBM.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTBM.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTBM.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT (
                               VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerBodyMeasurements') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerBodyMeasurements AS HFTBM
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTBM.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTBM.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTBM.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyMeasurements , NULL) AS CT_TrackerTable
                    ON HFTBM.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTBM.EventDate , HFTBM.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTBM.EventDate , HFTBM.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTBM.ItemCreatedWhen IS NOT NULL OR
            HFTBM.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTH.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTH.ItemCreatedWhen
        , HFTH.ItemModifiedWhen
        , HFTH.Notes
        , HFTH.IsProfessionallyCollected
        , HFTH.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTH.Height
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTH.ItemCreatedWhen = COALESCE ( HFTH.ItemModifiedWhen , HFTH.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTH.ItemCreatedWhen
        , HFTH.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTH.itemid
        , 'HFit_TrackerHeight' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTH.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cs.SiteGUID
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTH.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTH.ItemModifiedWhen AS nvarchar (50)) ,
                               '-') + ISNULL ( LEFT ( HFTH.Notes , 1000) , '-') + ISNULL ( CAST ( HFTH.IsProfessionallyCollected AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTH.EventDate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTH.Height AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External ,
                               1000) , '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTH.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTH.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST
                               ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTH.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerHeight') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerHeight AS HFTH
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTH.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTH.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTH.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHeight , NULL) AS CT_TrackerTable
                    ON HFTH.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTH.EventDate , HFTH.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTH.EventDate , HFTH.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTH.ItemCreatedWhen IS NOT NULL OR
            HFTH.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTRHR.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTRHR.ItemCreatedWhen
        , HFTRHR.ItemModifiedWhen
        , HFTRHR.Notes
        , HFTRHR.IsProfessionallyCollected
        , HFTRHR.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTRHR.HeartRate
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTRHR.ItemCreatedWhen = COALESCE ( HFTRHR.ItemModifiedWhen , HFTRHR.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTRHR.ItemCreatedWhen
        , HFTRHR.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTRHR.itemid
        , 'HFit_TrackerRestingHeartRate' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTRHR.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTRHR.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTRHR.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTRHR.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTRHR.EventDate AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTRHR.HeartRate AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTRHR.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST (
                               HFTRHR.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTRHR.itemid AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT ( HFTRHR.Notes , 1000) , '-') + ISNULL (
                               LEFT ( HFTCS.CollectionSourceName_External , 1000) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerRestingHeartRate') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerRestingHeartRate AS HFTRHR
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTRHR.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTRHR.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTRHR.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerRestingHeartRate , NULL) AS CT_TrackerTable
                    ON HFTRHR.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTRHR.EventDate , HFTRHR.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTRHR.EventDate , HFTRHR.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTRHR.ItemCreatedWhen IS NOT NULL OR
            HFTRHR.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTS.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTS.ItemCreatedWhen
        , HFTS.ItemModifiedWhen
        , HFTS.Notes
        , HFTS.IsProfessionallyCollected
        , HFTS.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTS.FluShot
        , HFTS.PneumoniaShot
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTS.ItemCreatedWhen = COALESCE ( HFTS.ItemModifiedWhen , HFTS.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTS.ItemCreatedWhen
        , HFTS.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTS.itemid
        , 'HFit_TrackerShots' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , ISNULL ( CAST ( HFTS.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cs.SiteGUID
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.ItemModifiedWhen AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( HFTS.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.EventDate AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTS.FluShot AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.PneumoniaShot AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTS.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTS.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT (
                               HFTS.Notes , 1000) , '-') + ISNULL ( LEFT ( HFTCS.CollectionSourceName_External , 1000) , '-') + ISNULL ( LEFT ( VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerShots') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerShots AS HFTS
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTS.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTS.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTS.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerShots , NULL) AS CT_TrackerTable
                    ON HFTS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTS.EventDate , HFTS.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTS.EventDate , HFTS.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTS.ItemCreatedWhen IS NOT NULL OR
            HFTS.EventDate IS NOT NULL) 

   --Add per RObert and Laura 12.4.2014

   UNION ALL
   SELECT DISTINCT
          HFTT.UserID
        , cus.UserSettingsUserGUID
        , cus.HFitUserMpiNumber
        , cus2.SiteID
        , cs.SiteGUID
        , HFTT.ItemCreatedWhen
        , HFTT.ItemModifiedWhen
        , HFTT.Notes
        , HFTT.IsProfessionallyCollected
        , HFTT.EventDate
        , 'Not Build Yet' AS EventName
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , NULL
        , HFTT.PSATest
        , HFTT.OtherExam
        , HFTT.TScore
        , HFTT.DRA
        , HFTT.CotinineTest
        , HFTT.ColoCareKit
        , HFTT.CustomTest
        , HFTT.CustomDesc
        , HFTCS.CollectionSourceName_External
        , HFA.AccountID
        , HFA.AccountCD
        , CASE
              WHEN HFTT.ItemCreatedWhen = COALESCE ( HFTT.ItemModifiedWhen , HFTT.ItemCreatedWhen) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HFTT.ItemCreatedWhen
        , HFTT.ItemModifiedWhen
        , HFTCS.TrackerCollectionSourceID
        , HFTT.itemid
        , 'HFit_TrackerTests' AS TBL
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , HASHBYTES ( 'SHA1' , +ISNULL ( CAST ( HFTT.UserID AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus.UserSettingsUserGUID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cus.HFitUserMpiNumber AS nvarchar (50)) , '-') + ISNULL ( CAST ( cus2.SiteID AS nvarchar (50)) ,
                               '-') + ISNULL ( CAST ( cs.SiteGUID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.IsProfessionallyCollected AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.EventDate
                               AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.PSATest AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.OtherExam AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTT.TScore AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.DRA AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.CotinineTest AS nvarchar (50)) ,
                               '-') + ISNULL (
                               CAST ( HFTT.ColoCareKit AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.CustomTest AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFA.AccountID AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFA.AccountCD AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.ItemCreatedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTT.ItemModifiedWhen AS nvarchar (50)) , '-') + ISNULL ( CAST ( HFTCS.TrackerCollectionSourceID AS nvarchar (50)) , '-') + ISNULL (
                               CAST ( HFTT.itemid AS nvarchar (50)) , '-') + ISNULL ( CAST ( VENDOR.ItemID AS nvarchar (50)) , '-') + ISNULL ( LEFT (
                               HFTCS.CollectionSourceName_External , 1000) , '-') + ISNULL ( LEFT ( HFTT.Notes , 1000) , '-') + ISNULL ( LEFT ( HFTT.CustomDesc , 1000) , '-') + ISNULL (
                               LEFT ( VENDOR.VendorName , 1000) , '-') + 'HFit_TrackerTests') AS HashCode
        , CT_CMS_Site.SiteID AS CMS_Site_CtID
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CMS_Site_SCV
        , CT_CMS_UserSettings.UserSettingsID AS CMS_UserSettings_CtID
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CMS_UserSettings_SCV
        , CT_CMS_UserSite.UserSiteID AS CMS_UserSite_CtID
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CMS_UserSite_SCV
        , CT_HFit_Account.AccountID AS HFit_Account_CtID
        , CT_HFit_Account.SYS_CHANGE_VERSION AS HFit_Account_SCV
        , CT_TrackerTable.ItemID AS HFit_UserTracker_CtID
        , CT_TrackerTable.SYS_CHANGE_VERSION AS HFit_UserTracker_SCV
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS CMS_Site_CHGTYPE
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CMS_UserSettings_CHGTYPE
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS CMS_UserSite_CHGTYPE
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS HFit_Account_CHGTYPE
        , CT_TrackerTable.SYS_CHANGE_OPERATION AS HFit_UserTracker_CHGTYPE
        , CT_TrackerSource.SYS_CHANGE_OPERATION AS HFit_TrackerSource_CHGTYPE
        , COALESCE (CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION
          , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION
          , CT_TrackerTable.SYS_CHANGE_OPERATION , CT_TrackerSource.SYS_CHANGE_OPERATION , NULL) AS CT_ChangeType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_TrackerTests AS HFTT
                    INNER JOIN dbo.HFit_TrackerCollectionSource AS HFTCS
                    ON HFTT.TrackerCollectionSourceID = HFTCS.TrackerCollectionSourceID
                    INNER JOIN dbo.CMS_UserSettings AS CUS
                    ON HFTT.UserID = cus.UserSettingsUserID
                    INNER JOIN dbo.CMS_UserSite AS CUS2
                    ON cus.UserSettingsUserID = cus2.UserID
                    INNER JOIN dbo.CMS_Site AS CS
                    ON CUS2.SiteID = CS.SiteID
                    INNER JOIN dbo.HFit_Account AS HFA
                    ON cs.SiteID = HFA.SiteID
                    LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                    ON HFTT.VendorID = VENDOR.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerTests , NULL) AS CT_TrackerTable
                    ON HFTT.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCollectionSource , NULL) AS CT_TrackerSource
                    ON HFTCS.ItemID = CT_TrackerTable.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CS.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON CUS.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON CUS2.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON HFA.AccountID = CT_HFit_Account.AccountID
          WHERE
          CS.SITEID NOT IN (
          SELECT
                 SiteID
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE COALESCE ( HFTT.EventDate , HFTT.ItemCreatedWhen) < ItemCreatedWhen) AND
          HFA.AccountCD NOT IN (
          SELECT
                 AccountCD
                 FROM EDW_BiometricViewRejectCriteria
                 WHERE
                 HFA.AccountCD = AccountCD AND
                 COALESCE ( HFTT.EventDate , HFTT.ItemCreatedWhen) < ItemCreatedWhen) AND
          (
            HFTT.ItemCreatedWhen IS NOT NULL OR
            HFTT.EventDate IS NOT NULL);

--Add per RObert and Laura 12.4.2014
--HFit_TrackerBMI
--HFit_TrackerBodyMeasurements
--HFit_TrackerHeight
--HFit_TrackerRestingHeartRate
--HFit_TrackerShots
--HFit_TrackerTests

GO

PRINT 'Created view_EDW_BioMetrics_CT: ' + CAST ( GETDATE () AS nvarchar (50)) ;

GO

--  
--  

GO

PRINT '***** FROM: view_EDW_BioMetrics_CT.sql';

GO

----***************************************************************************************************************************
----** REMOVE THE INSERTS AFTER INTITAL LOAD
----***************************************************************************************************************************
--truncate table EDW_BiometricViewRejectCriteria ;
--go 
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'trstmark','11/4/2013',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'entergy','1/6/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'mcwp','1/27/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'stateneb','4/1/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'jnj','5/28/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'coopers','7/1/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'cnh','8/4/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'amat','8/4/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'dupont','8/18/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'ejones','9/3/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'avera','9/15/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'sprvalu','9/18/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'firstgrp','10/6/2014',-1) ;
--GO
--insert into EDW_BiometricViewRejectCriteria (AccountCD, ItemCreatedWhen, SiteID)
--Values (
--'rexnord','12/2/2014',-1) ;
--GO

PRINT '***** COMPLETED : view_EDW_BioMetrics_CT.sql';

GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
-- use KenticoCMS_Prod1


GO
PRINT 'Processing: view_EDW_HealthAssesmentClientView_CT ';
GO

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
             WHERE TABLE_NAME = 'view_EDW_HealthAssesmentClientView_CT') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssesmentClientView_CT;
    END;
GO

CREATE VIEW dbo.view_EDW_HealthAssesmentClientView_CT
AS SELECT 
          HFitAcct.AccountID
        , HFitAcct.AccountCD
        , HFitAcct.AccountName
        , HFitAcct.ItemGUID AS ClientGuid
        , CMSSite.SiteGUID
        , NULL AS CompanyID
        , NULL AS CompanyGUID
        , NULL AS CompanyName
        , HAJoined.DocumentName
        , HACampaign.DocumentPublishFrom AS HAStartDate
        , HACampaign.DocumentPublishTo AS HAEndDate
        , HACampaign.NodeSiteID
        , HAAssessmentMod.Title
        , HAAssessmentMod.CodeName
        , HAAssessmentMod.IsEnabled
        , CASE
              WHEN CAST (HACampaign.DocumentCreatedWhen AS date) = CAST (HACampaign.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , HACampaign.DocumentCreatedWhen
        , HACampaign.DocumentModifiedWhen
        , HAAssessmentMod.DocumentModifiedWhen AS AssesmentModule_DocumentModifiedWhen     --09.11.2014 (wdm) added to facilitate EDW last mod date
        , HAAssessmentMod.DocumentCulture AS DocumentCulture_HAAssessmentMod
        , HACampaign.DocumentCulture AS DocumentCulture_HACampaign
        , HAJoined.DocumentCulture AS DocumentCulture_HAJoined
        , HACampaign.BiometricCampaignStartDate
        , HACampaign.BiometricCampaignEndDate
        , HACampaign.CampaignStartDate
        , HACampaign.CampaignEndDate
        , HACampaign.Name
        , HACampaign.NodeGuid AS CampaignNodeGuid
        , HACampaign.HACampaignID
,	   HASHBYTES ('sha1', isNull(cast(HFitAcct.AccountID as nvarchar(50)), '-') 
					+ isNull(cast(HFitAcct.AccountCD as nvarchar(50)), '-') 
					+ isNull(cast(HFitAcct.AccountName as nvarchar(50)), '-') 
					+ isNull(cast(HFitAcct.ItemGUID as nvarchar(50)), '-') 
					+ isNull(cast(CMSSite.SiteGUID as nvarchar(50)), '-') 
					+ isNull(cast(HAJoined.DocumentName as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.DocumentPublishFrom as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.DocumentPublishTo  as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.NodeSiteID as nvarchar(50)), '-') 
					+ isNull(cast(left(HAAssessmentMod.Title,2000) as nvarchar(50)), '-') 
					+ isNull(cast(HAAssessmentMod.CodeName as nvarchar(50)), '-') 
					+ isNull(cast(HAAssessmentMod.IsEnabled as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.DocumentCreatedWhen as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.DocumentModifiedWhen as nvarchar(50)), '-') 
					+ isNull(cast(HAAssessmentMod.DocumentModifiedWhen as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.BiometricCampaignStartDate as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.BiometricCampaignEndDate as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.CampaignStartDate as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.CampaignEndDate as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.Name as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.NodeGuid as nvarchar(50)), '-') 
					+ isNull(cast(HACampaign.HACampaignID as nvarchar(50)), '-') )as HashCode
         , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	   FROM
               dbo.View_HFit_HACampaign_Joined AS HACampaign
                   INNER JOIN dbo.CMS_Site AS CMSSite
                       ON HACampaign.NodeSiteID = CMSSite.SiteID
                   INNER JOIN dbo.HFit_Account AS HFitAcct
                       ON HACampaign.NodeSiteID = HFitAcct.SiteID
                   INNER JOIN dbo.View_HFit_HealthAssessment_Joined AS HAJoined
                       ON HACampaign.HealthAssessmentID = HAJoined.DocumentID      --  added line to handle    SR #51281   
                          -- ON CASE ----03.27.2015 - Commented code to release the SR #51281
                          --WHEN [HACampaign].[HealthAssessmentConfigurationID] < 0
                          --THEN [HACampaign].[HealthAssessmentID]
                          --ELSE [HACampaign].[HealthAssessmentConfigurationID]
                          --END = HAJoined.DocumentID
                      AND HAJoined.DocumentCulture = 'en-US'
                   INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS HAAssessmentMod
                       ON HAJoined.nodeid = HAAssessmentMod.NodeParentID
                      AND HAAssessmentMod.DocumentCulture = 'en-US'
     WHERE HACampaign.DocumentCulture = 'en-US';


GO

PRINT 'Created: view_EDW_HealthAssesmentClientView_CT ';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthAssesmentClientView_CT.sql';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating function udf_CkUserTrackerHasChanged.';
PRINT 'FROM udf_CkUserTrackerHasChanged.sql';
GO
IF EXISTS (SELECT
              *
                  FROM   sys.objects
                  WHERE
                  object_id = OBJECT_ID (N'[dbo].[udf_CkUserTrackerHasChanged]') 
              AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT')) 
    BEGIN
        DROP FUNCTION
           dbo.udf_CkUserTrackerHasChanged
    END;
GO
/*
declare @iChg as int = (select dbo.udf_CkUserTrackerHasChanged ()) ;
print @iChg;
*/
CREATE FUNCTION udf_CkUserTrackerHasChanged ()
                --@TF bit) 
RETURNS int
AS
BEGIN

/*
    If a 0 is returned, NO updates were found.
    If a 1 is returned, updates were found.
    If a 2 is returned, deletes were found.
*/

    DECLARE
           @UpdatesFound AS TABLE
           (
   chgFlg nvarchar (10) NULL) ;

    DECLARE
           @b AS int = 0;

    INSERT INTO @UpdatesFound (
       chgFlg)    
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_Class, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_Document, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_Site, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_Tree, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_User, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES COM_SKU, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_Account, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HACampaign, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentMatrixQuestion, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentMultipleChoiceQuestion, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserAnswers, NULL) AS CT
	   UNION ALL
	   
Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserModule, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestion, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskCategory, NULL) AS CT

	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssessment, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_HealthAssessmentFreeForm, NULL) AS CT
	   UNION ALL
	   Select distinct SYS_CHANGE_OPERATION FROM CHANGETABLE (CHANGES HFit_LKP_EDW_RejectMPI, NULL) AS CT ;

    DECLARE
           @iDel AS int = 0;
    DECLARE
           @iUpdt AS int = 0;

    SET @iUpdt = (SELECT
                     COUNT (*) 
                         FROM @UpdatesFound);
    SET @iDel = (SELECT
                    COUNT (*) 
                        FROM @UpdatesFound
                        WHERE chgFlg = 'D');

    IF @iUpdt > 0
        BEGIN
            SET @b = 1;
        END
    ELSE
        BEGIN
            SET @b = 0;
        END;

    IF @iDel > 0
        BEGIN
            SET @b = 2
        END;

    RETURN @b;

END;
GO
PRINT 'Created function udf_CkUserTrackerHasChanged.';
PRINT 'FROM udf_CkUserTrackerHasChanged.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO

PRINT 'Creating table EDW_Proc_Performance_Monitor';
PRINT 'FROM EDW_Proc_Performance_Monitor.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'EDW_Proc_Performance_Monitor') 
    BEGIN
        DROP TABLE
             dbo.EDW_Proc_Performance_Monitor
    END;

GO

/****** Object:  Table [dbo].[EDW_Proc_Performance_Monitor]    Script Date: 5/11/2015 2:07:52 PM ******/

SET ANSI_NULLS ON;
GO

SET QUOTED_IDENTIFIER ON;
GO
/*
alter table EDW_Proc_Performance_Monitor alter column ElapsedSecs float null 
alter table EDW_Proc_Performance_Monitor alter column ElapsedMin float null 
alter table EDW_Proc_Performance_Monitor alter column ElapsedHrs float null 
*/
CREATE TABLE dbo.EDW_Proc_Performance_Monitor (
TraceName nvarchar (100) NOT NULL
           ,TrackID nvarchar (50) NOT NULL
           ,StartTime datetime NOT NULL
           ,EndTime datetime NULL
           ,ElapsedTime int NULL
           ,ElapsedTimeUnits nvarchar (50) NULL
		  ,AccumulatedTime int NULL
		  ,ElapsedSecs float
		  ,ElapsedMin  float
		  ,ElapsedHrs  float
           ,Rownbr int IDENTITY (1, 1) 
                       NOT NULL
           ,CONSTRAINT PK_EDW_Proc_Performance_Monitor PRIMARY KEY CLUSTERED
             (
             TraceName ASC, TrackID asc, Rownbr
             ) 
                WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) 
ON [PRIMARY];

GO

ALTER TABLE dbo.EDW_Proc_Performance_Monitor
ADD
            CONSTRAINT DF_EDW_Proc_Performance_Monitor_StartTime  DEFAULT GETDATE () FOR StartTime;
GO

PRINT 'CREATED table EDW_Proc_Performance_Monitor';
PRINT 'FROM EDW_Proc_Performance_Monitor.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating view_EDW_BioMetrics_STAGED';
PRINT 'FROM: view_EDW_BioMetrics_STAGE.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE
                        name = 'view_EDW_BioMetrics_STAGED') 
    BEGIN
        DROP VIEW
             view_EDW_BioMetrics_STAGED
    END;

GO
CREATE VIEW view_EDW_BioMetrics_STAGED
AS SELECT
          [UserID]
      ,[UserGUID]
      ,[HFitUserMpiNumber]
      ,[SiteID]
      ,[SiteGUID]
      ,[CreatedDate]
      ,[ModifiedDate]
      ,[Notes]
      ,[IsProfessionallyCollected]
      ,[EventDate]
      ,[EventName]
      ,[PPTWeight]
      ,[PPTHbA1C]
      ,[Fasting]
      ,[HDL]
      ,[LDL]
      ,[Ratio]
      ,[Total]
      ,[Triglycerides]
      ,[Glucose]
      ,[FastingState]
      ,[Systolic]
      ,[Diastolic]
      ,[PPTBodyFatPCT]
      ,[BMI]
      ,[WaistInches]
      ,[HipInches]
      ,[ThighInches]
      ,[ArmInches]
      ,[ChestInches]
      ,[CalfInches]
      ,[NeckInches]
      ,[Height]
      ,[HeartRate]
      ,[FluShot]
      ,[PneumoniaShot]
      ,[PSATest]
      ,[OtherExam]
      ,[TScore]
      ,[DRA]
      ,[CotinineTest]
      ,[ColoCareKit]
      ,[CustomTest]
      ,[CustomDesc]
      ,[CollectionSource]
      ,[AccountID]
      ,[AccountCD]
      ,[ChangeType]
      ,[ItemCreatedWhen]
      ,[ItemModifiedWhen]
      ,[TrackerCollectionSourceID]
      ,[itemid]
      ,[TBL]
      ,[VendorID]
      ,[VendorName]
          FROM dbo.STAGING_EDW_BioMetrics;
GO
PRINT 'CREATED view_EDW_BioMetrics_STAGE.sql';
GO


--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
Print 'Creating view_EDW_SmallStepResponses_STAGED.sql' ;
go

if exists (select name from sys.views where name = 'view_EDW_SmallStepResponses_STAGED')
 drop view view_EDW_SmallStepResponses_STAGED ;
go

create view view_EDW_SmallStepResponses_STAGED as 
SELECT [UserID]
      ,[AccountCD]
      ,[SiteGUID]
      ,[SSItemID]
      ,[SSItemCreatedBy]
      ,[SSItemCreatedWhen]
      ,[SSItemModifiedBy]
      ,[SSItemModifiedWhen]
      ,[SSItemOrder]
      ,[SSItemGUID]
      ,[SSHealthAssesmentUserStartedItemID]
      ,[SSOutcomeMessageGuid]
      ,[SSOutcomeMessage]
      ,[HACampaignNodeGUID]
      ,[HACampaignName]
      ,[HACampaignStartDate]
      ,[HACampaignEndDate]
      ,[HAStartedDate]
      ,[HACompletedDate]
      ,[HAStartedMode]
      ,[HACompletedMode]
      ,[HaCodeName]
      ,[HFitUserMPINumber]
  FROM [dbo].STAGING_EDW_SmallSteps
GO


Print 'Created view_EDW_SmallStepResponses_STAGED' ;
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating view view_EDW_TrackersComposite_STAGED';
PRINT 'Generated FROM: view_EDW_TrackersComposite_STAGED.SQL';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_TrackersComposite_STAGED') 
    BEGIN
        PRINT 'VIEW view_EDW_TrackersComposite_STAGED, replacing.';
        DROP VIEW
             view_EDW_TrackersComposite_STAGED;
    END;
GO

--select top 1000 * from view_EDW_TrackersComposite_STAGED

create view view_EDW_TrackersComposite_STAGED
as
SELECT [TrackerNameAggregateTable]
      ,[ItemID]
      ,[EventDate]
      ,[IsProfessionallyCollected]
      ,[TrackerCollectionSourceID]
      ,[Notes]
      ,[UserID]
      ,[CollectionSourceName_Internal]
      ,[CollectionSourceName_External]
      ,[EventName]
      ,[UOM]
      ,[KEY1]
      ,[VAL1]
      ,[KEY2]
      ,[VAL2]
      ,[KEY3]
      ,[VAL3]
      ,[KEY4]
      ,[VAL4]
      ,[KEY5]
      ,[VAL5]
      ,[KEY6]
      ,[VAL6]
      ,[KEY7]
      ,[VAL7]
      ,[KEY8]
      ,[VAL8]
      ,[KEY9]
      ,[VAL9]
      ,[KEY10]
      ,[VAL10]
      ,[ItemCreatedBy]
      ,[ItemCreatedWhen]
      ,[ItemModifiedBy]
      ,[ItemModifiedWhen]
      ,[IsProcessedForHa]
      ,[TXTKEY1]
      ,[TXTVAL1]
      ,[TXTKEY2]
      ,[TXTVAL2]
      ,[TXTKEY3]
      ,[TXTVAL3]
      ,[ItemOrder]
      ,[ItemGuid]
      ,[UserGuid]
      ,[MPI]
      ,[ClientCode]
      ,[SiteGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[IsAvailable]
      ,[IsCustom]
      ,[UniqueName]
      ,[ColDesc]
      ,[VendorID]
      ,[VendorName]
  FROM [dbo].Staging_EDW_Trackers
GO

PRINT 'Created view view_EDW_TrackersComposite_STAGED';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;







GO
PRINT 'Creating view view_EDW_HealthAssesmentClientView_STAGED';
PRINT 'Generated FROM: view_EDW_HealthAssesmentClientView_STAGED.SQL';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
             WHERE name = 'view_EDW_HealthAssesmentClientView_STAGED') 
    BEGIN
        PRINT 'VIEW view_EDW_HealthAssesmentClientView_STAGED, replacing.';
        DROP VIEW
             view_EDW_HealthAssesmentClientView_STAGED;
    END;
GO

create view view_EDW_HealthAssesmentClientView_STAGED
as 
SELECT [AccountID]
      ,[AccountCD]
      ,[AccountName]
      ,[ClientGuid]
      ,[SiteGUID]
      ,[CompanyID]
      ,[CompanyGUID]
      ,[CompanyName]
      ,[DocumentName]
      ,[HAStartDate]
      ,[HAEndDate]
      ,[NodeSiteID]
      ,[Title]
      ,[CodeName]
      ,[IsEnabled]
      ,[ChangeType]
      ,[DocumentCreatedWhen]
      ,[DocumentModifiedWhen]
      ,[AssesmentModule_DocumentModifiedWhen]
      ,[DocumentCulture_HAAssessmentMod]
      ,[DocumentCulture_HACampaign]
      ,[DocumentCulture_HAJoined]
      ,[BiometricCampaignStartDate]
      ,[BiometricCampaignEndDate]
      ,[CampaignStartDate]
      ,[CampaignEndDate]
      ,[Name]
      ,[CampaignNodeGuid]
      ,[HACampaignID]
  FROM [dbo].[view_EDW_HealthAssesmentClientView]
GO

PRINT 'Created view view_EDW_HealthAssesmentClientView_STAGED';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
print 'Creating view_EDW_RewardUserDetail_STAGED.sql'

go
if exists (select name from sys.views where name = 'view_EDW_RewardUserDetail_STAGED')
    drop view view_EDW_RewardUserDetail_STAGED;
go

create view view_EDW_RewardUserDetail_STAGED
as
SELECT [UserGUID]
      ,[SiteGUID]
      ,[HFitUserMpiNumber]
      ,[RewardActivityGUID]
      ,[RewardProgramName]
      ,[RewardModifiedDate]
      ,[RewardLevelModifiedDate]
      ,[LevelCompletedDt]
      ,[ActivityPointsEarned]
      ,[ActivityCompletedDt]
      ,[RewardActivityModifiedDate]
      ,[ActivityPoints]
      ,[UserAccepted]
      ,[UserExceptionAppliedTo]
      ,[RewardTriggerGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[ChangeType]
      ,[RewardExceptionModifiedDate]
  FROM [dbo].STAGING_EDW_RewardUserDetail
GO
print 'Created view_EDW_RewardUserDetail_STAGED.sql'
go--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*
73 Changes found
0 Inserts found
73 Updates found
0 Deletes found
**Notice: Changes found, NO DELETES found, processing only new HA inserts and updates.
Jun  8 2015  7:14PM
TEMP RECORDS RETURNED:252021
ENDTIME: 
Jun  8 2015  8:28PM
**********
@secs = 4428.000
@mins = 73.800
@@hrs = 1.230
***INFO: Number of records that have changes: 252021
TIME TO PULL DATA in minutes: 74.00 minutes.
TIME TO PULL DATA in hours: 1.00 hours.
 

--*********************************************************
3 Changes found
0 Inserts found
3 Updates found
0 Deletes found
**Notice: NO DELETES found, processing only HA inserts and updates.
Jun  5 2015  2:54PM
TEMP RECORDS RETURNED:252021
ENDTIME: 
Jun  5 2015  3:53PM
**********
@secs = 3539.000
@mins = 58.983
@@hrs = 0.983
***INFO: Number of records that have changes: 252021
TIME TO PULL DATA in minutes: 59.00 minutes.
TIME TO PULL DATA in hours: 1.00 hours.
 --**********************************************************
2 Changes found
0 Inserts found
2 Updates found
0 Deletes found
**Notice: NO DELETES found, processing only inserts and updates.
TIME TO BUILD TEMP TABLES in seconds: 4
***INFO: Number of records to evaluate for changes: 221
***INFO: Number of records removed that do not have changes: 221
***INFO: Number of records left to process: 0
Time REMOVE non-changed: 0
TIME TO PULL DATA in seconds: 4 @ 0.00 minutes.
TIME TO CONVERT HASH in seconds: 0 @ Minutes = 0.00
TIME TOTAL Elapsed Time in seconds: 8 @ Minutes = 0.00
** LOADING STAGING Data to table DIM_EDW_HealthAssessment.
TIME TOTAL TO Load from @HARECS : 2 @ Minutes = 0.00
TOTAL RECORDS PULLED: 0
 

*/

GO

PRINT 'Creating procedure PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA';
PRINT 'FROM PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA.sql';

GO

/*    
    select * into TEMP_HA_DO_NOT_KEEP from TEMP_EDW_HealthAssessment_DATA
*/

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA' )

    BEGIN

        DROP PROCEDURE
             PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA;
    END;

GO

CREATE PROCEDURE PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA ( @ReloadAllData AS int = 0
                                                                , @StartID AS bigint = -1
                                                                , @EndID AS bigint = 0 )
AS
BEGIN

    --***********************************************************************
    --EXEC PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA 1 ;
    --EXEC PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA 0;
    --PullChangesOnly = 0; fills the TEMP table ONLY with data that has changed
    --PullChangesOnly = 1; fills the TEMP STAGING TABLE for FULL Reloads.
    --@StartID >= 0 and @EndID > 0 and PullChangesOnly = 0, then only changes 
    --		 between the Start and End ID will be pulled.
    --Select count(*) from TEMP_EDW_HealthAssessment_DATA
    --Select top 1000 * from TEMP_EDW_HealthAssessment_DATA
    --***********************************************************************
    --** CHANGES:
    --05.11.2015 - (WDM) Changed proc to FILL the TEMP table
    --***********************************************************************

    SET NOCOUNT ON;

    --declare @ReloadAllData as int  = 0 ;

    DECLARE
       @startdate datetime2 = GETDATE ( )
       ,@startPullDate datetime2 = GETDATE ( )
       ,@RecordsPulled AS int
       ,@HRPART AS decimal ( 10 , 2 )
       ,@MINPART AS decimal ( 10 , 2 )
       ,@SECPART AS decimal ( 10 , 2 )
       ,@TOTSECS AS decimal ( 10 , 2 ) = 0
       ,@proc_RowGuid AS uniqueidentifier = NEWID ( )
       ,@CALLING_PROC AS nvarchar ( 100 ) = 'PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA'
       ,@PROC_LOCATION AS nvarchar ( 100 ) = ''
       ,@proc_starttime AS datetime = GETDATE ( )
       ,@proc_endtime AS datetime = NULL
       ,@proc_elapsedsecs AS bigint = 0
       ,@proc_RowsProcessed AS bigint = 0
       ,@MINS AS decimal ( 10 , 2 ) = 0;

    EXEC proc_EDW_Procedure_Performance_Monitor 'D' , @CALLING_PROC;
    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , '001';

    --  exec proc_CT_Performance_History @proc_RowGuid, @CALLING_PROC, @PROC_LOCATION, @proc_starttime, @proc_endtime, @proc_elapsedsecs, @proc_RowsProcessed ;

    IF
           @ReloadAllData = 0
        OR @ReloadAllData IS NULL
        BEGIN
            SET @PROC_LOCATION = 'LOAD CHANGES ONLY';
        END;

    IF @ReloadAllData = 1
        BEGIN
            SET @PROC_LOCATION = 'FULL RELOAD';
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , 'START FULL RELOAD';
            --***************************************************
            EXEC @RecordsPulled = proc_Load_HA_CT_TempTable 2 , @StartID , @EndID;
            --***************************************************
            PRINT '***INFO: Number of records to evaluate: ' + CAST ( @RecordsPulled AS nvarchar ( 20 ));
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , 'FULL RELOAD';
            EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CALLING_PROC;
            PRINT '***MSG: ALL HA DATA RELOADED';
            RETURN @RecordsPulled;
        END;

    --********************************************************************************
    -- ** BEFORE WE DO ANYTHING, LET'S SEE IF THERE ARE CHANGES TO PROCESS
    --********************************************************************************
    -- 0 = no changes, 1 = changes found and no deletes, 2 = DELETES found


declare @iChgTypes as int = 0 ; 
declare @NbrOfDetectedChanges as bigint = 0 ; 
    EXEC @iChgTypes = proc_CkHaDataChanged NULL, @NbrOfDetectedChanges OUTPUT;
    PRINT 'iChgType is: ' + CAST (@iChgTypes AS nvarchar (50)) ;
    PRINT 'Total Number Of Changes to process is: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) ;

    IF
    @iChgTypes = 0
        BEGIN
            PRINT '**NO CHANGES FOUND, RETURNING.';
            EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CALLING_PROC;
            RETURN 0;
        END;

    IF
           @ReloadAllData = 0
       AND @StartID >= 0
       AND @EndID > 0
        BEGIN
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , 'PULLING CHANGES BETWEEN IDs';
            PRINT '***INFO: PULLING CHANGES BETWEEN CHANGE TRACKING IDs.';
            --***************************************************
            EXEC @RecordsPulled = proc_Load_HA_CT_TempTable 3 , @StartID , @EndID;
            --***************************************************
            PRINT '***INFO: PULLING CHANGES BETWEEN CHANGE TRACKING IDs.';
            PRINT '***INFO: Number of records to evaluate: ' + CAST ( @RecordsPulled AS nvarchar ( 20 ));
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , 'FULL RELOAD';
            EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CALLING_PROC;
            PRINT '***MSG: ALL HA DATA RELOADED';
            RETURN @RecordsPulled;
        END;

    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , '006 - Populate Table VAR';
    IF @iChgTypes = 2
        BEGIN
            PRINT '**Notice: DELETES found, processing ALL HA records.';
            SET @PROC_LOCATION = 'CHANGES WITH DELETES';

            --** Changes were found but no deletes, so remove NON-changed data
            EXEC @RecordsPulled = proc_Load_HA_CT_TempTable 1 , @StartID , @EndID;

            PRINT '***INFO: Number of records to evaluate: ' + CAST ( @RecordsPulled AS nvarchar ( 20 ));
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , '007 - DATA Extract DELETES found';
        END;
    IF @iChgTypes = 1
        BEGIN
            PRINT '**Notice: Changes found, NO DELETES found, processing only new HA inserts and updates.';
            SET @PROC_LOCATION = 'CHANGES ONLY No DELETES';

            DECLARE
               @START_CLEANUP_TIME AS datetime = GETDATE ( );

            --** Changes were found but no deletes
            EXEC @RecordsPulled = proc_Load_HA_CT_TempTable 0 , @StartID , @EndID;

            PRINT '***INFO: Number of records that have changes: ' + CAST ( @RecordsPulled AS nvarchar ( 20 ));
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , '007 - DATA Extract changes Only';
        END;
    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CALLING_PROC , '007 - DATA PULL';

    SET @HRPART = DATEDIFF ( hour , @startPullDate , GETDATE ( ));
    SET @MINPART = DATEDIFF ( minute , @startPullDate , GETDATE ( ));
    SET @SECPART = DATEDIFF ( second , @startPullDate , GETDATE ( ));
    SET @TOTSECS = DATEDIFF ( second , @startPullDate , GETDATE ( ));
    SET @MINS = @TOTSECS / 60;

    PRINT 'TIME TO PULL DATA in minutes: ' + CAST ( @MINPART AS nvarchar( 10 )) + ' minutes.';
    PRINT 'TIME TO PULL DATA in hours: ' + CAST ( @HRPART AS nvarchar( 10 )) + ' hours.';

    EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CALLING_PROC;
    RETURN @RecordsPulled;
END;

GO

PRINT 'Created procedure PROC_STAGING_Pull_EDW_HealthAssesment_TEMPDATA';

GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'FROM: proc_genTableVar.sql';
PRINT 'Creating proc_getPKeyCols';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_getPKeyCols') 
    BEGIN
        DROP PROCEDURE
             proc_getPKeyCols;
    END;
GO
-- exec proc_getPKeyCols FACT_HFit_UserTracker, a
CREATE PROCEDURE proc_getPKeyCols (
     @tblname AS nvarchar (250) 
   , @pkcols nvarchar (max) OUTPUT) 
AS
BEGIN

/*****************************************************************************************************************
Author:	  W. Dale Miller
Date:	  09.22.2003
Copyright:  DMA, Ltd.
Purpose:	  Returns a list of columns used to define the PRIMARY key associated with this table if any are defined.
*****************************************************************************************************************/

    DECLARE
    @collist nvarchar ( max) 
  , @col AS nvarchar ( 250) 
  , @i AS int = 0;
    DECLARE PK_Cur CURSOR
        FOR
            SELECT
                   column_name
                   FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE
                   WHERE
                   OBJECTPROPERTY ( OBJECT_ID ( constraint_name) , 'IsPrimaryKey') = 1
               AND table_name = @tblname
                   ORDER BY
                            column_name;
    OPEN PK_Cur;
    FETCH NEXT FROM PK_Cur INTO @col;
    SET @collist = '';
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @i = 0
                BEGIN
                    SET @collist = @collist + @col;
                END;
            ELSE
                BEGIN
                    SET @collist = @collist + ', ' + @col;
                END;
            FETCH NEXT FROM PK_Cur INTO  @col;
            SET @i = @i + 1;
        END;

    --PRINT @collist;

    CLOSE PK_Cur;
    DEALLOCATE PK_Cur;
    SET @pkcols = @collist;

	   select @pkcols;

END;
GO
PRINT 'Created proc_getPKeyCols';
GO
PRINT 'Creating proc_genTableVar';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_genTableVar') 
    BEGIN
        DROP PROCEDURE
             proc_genTableVar;
    END;
GO

-- exec proc_genTableVar 'View_HFit_HealthAssessment_Joined'
-- exec proc_genTableVar 'TEMP_HA_HashKeys_2'
-- exec proc_genTableVar 'View_HFit_HACampaign_Joined'
-- exec proc_genTableVar 'HFit_HealthAssesmentUserQuestion'
-- exec proc_genTableVar 'CMS_SITE'
-- exec proc_genTableVar 'CMS_USER'
-- exec proc_genTableVar 'CMS_Document'

/********************************************************
    SELECT * FROM information_schema.columns
    WHERE table_name = 'CMS_Document'
    ORDER BY ORDINAL_POSITION;    --DocumentGroupWebParts
********************************************************/

-- exec proc_genTableVar FACT_HFit_UserTracker
CREATE PROCEDURE proc_genTableVar (
     @TBLNAME AS nvarchar (250)) 
AS
BEGIN

/*********************************************************************************
Author:	  W. Dale Miller
Date:	  09.22.2003
Copyright:  DMA, Ltd.
Purpose:	  Generates the SQL to create a TABLE VAR from an existing table or view.
*********************************************************************************/

    DECLARE
    @TBL nvarchar ( 100) 
  , @COL nvarchar ( 100) 
  , @DType AS nvarchar ( 50) 
  , @LEN AS int
  , @PRECISION AS int
  , @SCALE AS int
  , @mysql AS nvarchar ( max) 
  , @i AS int = 0
  , @IS_NULLABLE AS nvarchar ( 10) ;
    DECLARE db_cursor CURSOR
        FOR
            SELECT
                   table_name
                 , COLUMN_NAME
                 , DATA_TYPE
                 , character_maximum_length
                 , numeric_precision
                 , numeric_scale
                 , IS_NULLABLE
                   FROM information_schema.columns
                   WHERE table_name = @TBLNAME
                   ORDER BY
                            ORDINAL_POSITION;
    OPEN db_cursor;
    FETCH NEXT FROM db_cursor INTO @TBL , @COL , @DType , @LEN , @PRECISION , @SCALE , @IS_NULLABLE;
    SET @mysql = 'DECLARE' + CHAR ( 10) ;
    SET @mysql = @mysql + '@' + @TBL + CHAR ( 10) ;
    SET @mysql = @mysql + 'TABLE' + CHAR ( 10) ;
    SET @mysql = @mysql + '(' + CHAR ( 10) ;
    WHILE @@FETCH_STATUS = 0
        BEGIN
            SET @i = @i + 1;
            IF @i = 1
                BEGIN
                    SET @mysql = @mysql + @col + ' ' + @DType + ' ';
                END;
            ELSE
                BEGIN
                    SET @mysql = @mysql + CHAR ( 10) + ', ';
                    SET @mysql = @mysql + @col + ' ' + @DType + ' ';
                END;

            IF @DType = 'decimal'
                BEGIN
                    SET @mysql = @mysql + '(' + CAST ( @PRECISION AS nvarchar ( 100)) + ',' + CAST ( @SCALE AS nvarchar ( 100)) + ')';
                END;
            IF @DType = 'datetime2'
                BEGIN
                    SET @mysql = @mysql + '(7)';
                END;
            IF @LEN IS NOT NULL
                BEGIN
                    IF @LEN < 0
                        BEGIN
                            SET @mysql = @mysql + '(max)';
                        END;
                    ELSE
                        BEGIN
                            SET @mysql = @mysql + ' (' + CAST ( @LEN AS nvarchar ( 100)) + ')';
                        END;
                END;

            IF @IS_NULLABLE = 'NO'
                BEGIN
                    SET @mysql = @mysql + ' NOT NULL ';
                END;
            ELSE
                BEGIN
                    SET @mysql = @mysql + ' NULL ';
                END;

            FETCH NEXT FROM db_cursor INTO  @TBL , @COL , @DType , @LEN , @PRECISION , @SCALE , @IS_NULLABLE;
        END;
    DECLARE
    @KCols AS nvarchar ( max) ;
    EXEC proc_getPKeyCols @TBL , @KCols OUTPUT;

    --PRINT '@KCols: ' + @KCols;

    SET @KCols = LTRIM ( RTRIM ( @KCols)) ;
    DECLARE
    @collen AS int = ( SELECT
                              DATALENGTH ( @KCols));
    IF @collen > 0
        BEGIN
            SET @mysql = @mysql + CHAR ( 10) + ' PRIMARY KEY ( ' + CAST ( @KCols AS nvarchar ( max)) + ' )' + CHAR ( 10) ;
        END;
    ELSE
        BEGIN
            SET @mysql = @mysql + CHAR ( 10) + ' -- PRIMARY KEY (col1, col2)' + CHAR ( 10) ;
        END;
    SET @mysql = @mysql + ')' + CHAR ( 10) ;

    --PRINT  '**************************';
    
    CLOSE db_cursor;
    DEALLOCATE db_cursor;

    PRINT @mysql;
    select @mysql;

END;
GO
PRINT 'Created proc_genTableVar';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





PRINT 'Creating proc_genTempTable';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_genTempTable' )
    BEGIN
        DROP PROCEDURE
             proc_genTempTable;
    END;
GO

    -- exec proc_genTempTable 'view_EDW_HealthAssesment_CT'
    -- exec proc_genTempTable 'CT_Performance_History'
    -- exec proc_genTempTable 'STAGING_EDW_HealthInterestDetail'
    -- exec proc_genTempTable 'CMS_TREE'
    -- exec proc_genTempTable 'CMS_SITE'
    -- exec proc_genTempTable 'CMS_USER'
    -- exec proc_genTempTable 'CMS_Document'
    /*
    SELECT * FROM information_schema.columns
    WHERE table_name = 'CMS_Document'
    ORDER BY ORDINAL_POSITION;    --DocumentGroupWebParts
    */

CREATE PROCEDURE proc_genTempTable ( @TBLNAME AS nvarchar( 250 ))
AS
BEGIN
/*
Author:	  W. Dale Miller
Date:	  09.22.2003
Copyright:  DMA, Ltd.
Purpose:	  Generates a temp table from another table or view.
*/

    DECLARE
       @TBL nvarchar( 100 )
       ,@COL nvarchar( 100 )
       ,@DType AS nvarchar( 50 )
       ,@LEN AS int
       ,@PRECISION AS int
       ,@SCALE AS int
       ,@mysql AS nvarchar( max )
       ,@i AS int = 0
       ,@IS_NULLABLE AS nvarchar( 10 );

    DECLARE db_cursor CURSOR
        FOR
            --select table_name, COLUMN_NAME,DATA_TYPE,character_maximum_length , numeric_precision, numeric_scale, IS_NULLABLE
            SELECT
                   table_name ,
                   COLUMN_NAME ,
                   DATA_TYPE ,
                   character_maximum_length ,
                   numeric_precision ,
                   numeric_scale ,
                   IS_NULLABLE
              FROM information_schema.columns
              WHERE table_name = @TBLNAME
              ORDER BY
                       ORDINAL_POSITION;

    OPEN db_cursor;
    FETCH NEXT FROM db_cursor INTO @TBL , @COL , @DType , @LEN , @PRECISION , @SCALE , @IS_NULLABLE;

    SET @mysql = 'IF EXISTS ( SELECT name FROM tempdb.dbo.sysobjects WHERE id = OBJECT_ID (N''tempdb..#TEMP_'+@TBL+''' )) ' + char(10) ;
    SET @mysql =  @mysql + '    BEGIN '  + char(10) ;
    SET @mysql =  @mysql + '        DROP TABLE '  + char(10) ;
    SET @mysql =  @mysql + '            #TEMP_'+@TBL + char(10) ;
    SET @mysql =  @mysql + '    END; '  + char(10) ;
    print @mysql ; 
    print ' ' ; 


    SET @mysql = 'CREATE TABLE ' + CHAR( 10 );
    SET @mysql = @mysql + '#TEMP_' + @TBL + CHAR( 10 );
    SET @mysql = @mysql + '(' + CHAR( 10 );
    WHILE @@FETCH_STATUS = 0
        BEGIN
            SET @i = @i + 1;
            IF @i = 1
                BEGIN
                    SET @mysql = @mysql + @col + ' ' + @DType + ' ';
                END;
            ELSE
                BEGIN
                    SET @mysql = @mysql + CHAR( 10 ) + ', ';
                    SET @mysql = @mysql + @col + ' ' + @DType + ' ';
                END;

            --PRINT '@TBL: ' + CAST( @TBL AS nvarchar( 100 ));
            --PRINT  '@@COL: ' + CAST( @COL AS nvarchar( 100 ));
            --PRINT  '@@DType: ' + CAST( @DType AS nvarchar( 100 ));
            --PRINT  '@@LEN: ' + CAST( @LEN AS nvarchar( 100 ));
            --PRINT  '@@PRECISION: ' + CAST( @PRECISION AS nvarchar( 100 ));
            --PRINT  '@@SCALE: ' + CAST( @SCALE AS nvarchar( 100 ));
            --PRINT  '@@IS_NULLABLE: ' + CAST( @IS_NULLABLE AS nvarchar( 100 ));
            --PRINT ' - ';
            IF @DType = 'decimal'
                BEGIN
                    SET @mysql = @mysql + '(' + CAST( @PRECISION AS nvarchar( 100 )) + ',' + CAST( @SCALE AS nvarchar( 100 )) + ')';
                END;
            IF @DType = 'datetime2'
                BEGIN
                    SET @mysql = @mysql + '(7)';
                END;

            IF @LEN IS NOT NULL
                BEGIN
				if @LEN < 0 
				    SET @mysql = @mysql + '(max)';
				else 
				    SET @mysql = @mysql + ' (' + CAST( @LEN AS nvarchar( 100 )) + ')';
                END;

            IF @IS_NULLABLE = 'NO'
                BEGIN
                    SET @mysql = @mysql + ' NOT NULL ';
                END;
            ELSE
                BEGIN
                    SET @mysql = @mysql + ' NULL ';
                END;

            --PRINT '@@mysql: ' + CAST( @mysql AS nvarchar( max ));
            --PRINT  '**************************';

            FETCH NEXT FROM db_cursor INTO  @TBL , @COL , @DType , @LEN , @PRECISION , @SCALE , @IS_NULLABLE;
        END;

    DECLARE
       @KCols AS nvarchar( max );
    EXEC proc_getPKeyCols @TBL , @KCols OUTPUT;

    --PRINT '@KCols: ' + @KCols;

    set @KCols = ltrim(rtrim(@KCols)) ;

    declare @collen as int = (select datalength(@KCols)) ;

    IF @collen > 0 
        BEGIN
            SET @mysql = @mysql + CHAR( 10 ) + ' PRIMARY KEY ( ' + CAST( @KCols AS nvarchar( max )) + ' )' + CHAR( 10 );
        END;
    ELSE
        BEGIN
            SET @mysql = @mysql + CHAR( 10 ) + ' -- PRIMARY KEY (col1, col2)' + CHAR( 10 );
        END;

    SET @mysql = @mysql + ')' + CHAR( 10 );
    --PRINT  '**************************';
    PRINT @mysql;
    select @mysql;
    CLOSE db_cursor;
    DEALLOCATE db_cursor;

END;

go

PRINT 'Created proc_genTempTable';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'proc_EDW_HA_TempTable_Load_All_Data.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_HA_TempTable_Load_All_Data' )
    BEGIN
        DROP PROCEDURE
             proc_EDW_HA_TempTable_Load_All_Data
    END;
GO

CREATE PROCEDURE proc_EDW_HA_TempTable_Load_All_Data
AS
BEGIN

    truncate TABLE TEMP_EDW_HealthAssessment_DATA;

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_Dates' )
        BEGIN
            PRINT 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_Dates at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));

            CREATE NONCLUSTERED INDEX PI_TEMP_EDW_HealthAssessment_DATA_Dates ON dbo.TEMP_EDW_HealthAssessment_DATA ( ItemCreatedWhen ASC ,
            ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC ,
            HAUserQuestion_ItemModifiedWhen ASC ,
            HAUserAnswers_ItemModifiedWhen ASC ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
            DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
        END;

    IF NOT EXISTS
    ( SELECT
             name
        FROM sys.indexes
        WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_NATKEY' )
        BEGIN
            PRINT 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_NATKEY at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
            CREATE INDEX PI_TEMP_EDW_HealthAssessment_DATA_NATKEY ON dbo.TEMP_EDW_HealthAssessment_DATA (
            UserStartedItemID
            , UserGUID
            , PKHashCode
            );
        END;

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_IDs' )
        BEGIN
            EXEC PrintNow 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_IDs';
            CREATE INDEX PI_TEMP_EDW_HealthAssessment_DATA_IDs ON dbo.TEMP_EDW_HealthAssessment_DATA (
            UserStartedItemID
            , HealthAssesmentUserStartedNodeGUID
            , UserGUID
            , SiteGUID
            , AccountCD
            , HAModuleNodeGUID
            , CMSNodeGuid
            , HARiskCategoryNodeGUID
            , UserRiskAreaItemID
            , HARiskAreaNodeGUID
            , UserQuestionItemID
            , HAQuestionGuid
            , HAQuestionNodeGUID
            , UserAnswerItemID
            , HAAnswerNodeGUID
            , CampaignNodeGUID
            )
            INCLUDE ( AccountID , UserModuleItemId , UserRiskCategoryItemID , DeletedFlg , HASHCODE , LastModifiedDate )
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON ,
            ALLOW_PAGE_LOCKS = ON );
        END;

    INSERT INTO TEMP_EDW_HealthAssessment_DATA
    (
           UserStartedItemID
           ,HealthAssesmentUserStartedNodeGUID
           ,UserID
           ,UserGUID
           ,HFitUserMpiNumber
           ,SiteGUID
           ,AccountID
           ,AccountCD
           ,AccountName
           ,HAStartedDt
           ,HACompletedDt
           ,UserModuleItemId
           ,UserModuleCodeName
           ,HAModuleNodeGUID
           ,CMSNodeGuid
           ,HAModuleVersionID
           ,UserRiskCategoryItemID
           ,UserRiskCategoryCodeName
           ,HARiskCategoryNodeGUID
           ,HARiskCategoryVersionID
           ,UserRiskAreaItemID
           ,UserRiskAreaCodeName
           ,HARiskAreaNodeGUID
           ,HARiskAreaVersionID
           ,UserQuestionItemID
           ,Title
           ,HAQuestionGuid
           ,UserQuestionCodeName
           ,HAQuestionDocumentID
           ,HAQuestionVersionID
           ,HAQuestionNodeGUID
           ,UserAnswerItemID
           ,HAAnswerNodeGUID
           ,HAAnswerVersionID
           ,UserAnswerCodeName
           ,HAAnswerValue
           ,HAModuleScore
           ,HARiskCategoryScore
           ,HARiskAreaScore
           ,HAQuestionScore
           ,HAAnswerPoints
           ,PointResults
           ,UOMCode
           ,HAScore
           ,ModulePreWeightedScore
           ,RiskCategoryPreWeightedScore
           ,RiskAreaPreWeightedScore
           ,QuestionPreWeightedScore
           ,QuestionGroupCodeName
           ,ChangeType
           ,ItemCreatedWhen
           ,ItemModifiedWhen
           ,IsProfessionallyCollected
           ,HARiskCategory_ItemModifiedWhen
           ,HAUserRiskArea_ItemModifiedWhen
           ,HAUserQuestion_ItemModifiedWhen
           ,HAUserAnswers_ItemModifiedWhen
           ,HAPaperFlg
           ,HATelephonicFlg
           ,HAStartedMode
           ,HACompletedMode
           ,DocumentCulture_VHCJ
           ,DocumentCulture_HAQuestionsView
           ,CampaignNodeGUID
           ,HACampaignID
           ,HashCode
           ,PKHashCode
           ,CHANGED_FLG
           ,CT_CMS_User_UserID
           ,CT_CMS_User_CHANGE_OPERATION
           ,CT_UserSettingsID
           ,CT_UserSettingsID_CHANGE_OPERATION
           ,SiteID_CtID
           ,SiteID_CHANGE_OPERATION
           ,UserSiteID_CtID
           ,UserSiteID_CHANGE_OPERATION
           ,AccountID_CtID
           ,AccountID__CHANGE_OPERATION
           ,HAUserAnswers_CtID
           ,HAUserAnswers_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserModule_CtID
           ,HFit_HealthAssesmentUserModule_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserQuestion_CtID
           ,HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserQuestionGroupResults_CtID
           ,HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserRiskArea_CtID
           ,HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserRiskCategory_CtID
           ,HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserStarted_CtID
           ,HFit_HealthAssesmentUserStarted_CHANGE_OPERATION
           --, CT_CMS_User_SCV 
           --, CT_CMS_UserSettings_SCV 
           --, CT_CMS_Site_SCV 
           --, CT_CMS_UserSite_SCV 
           --, CT_HFit_Account_SCV 
           --, CT_HFit_HealthAssesmentUserAnswers_SCV 
           --, CT_HFit_HealthAssesmentUserModule_SCV 
           --, CT_HFit_HealthAssesmentUserQuestion_SCV 
           --, CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV 
           --, CT_HFit_HealthAssesmentUserRiskArea_SCV 
           --, CT_HFit_HealthAssesmentUserRiskCategory_SCV 
           --, CT_HFit_HealthAssesmentUserStarted_SCV 
           ,LastModifiedDate
           ,DeleteFlg )
    SELECT
           UserStartedItemID
           ,HealthAssesmentUserStartedNodeGUID
           ,UserID
           ,UserGUID
           ,HFitUserMpiNumber
           ,SiteGUID
           ,AccountID
           ,AccountCD
           ,AccountName
           ,HAStartedDt
           ,HACompletedDt
           ,UserModuleItemId
           ,UserModuleCodeName
           ,HAModuleNodeGUID
           ,CMSNodeGuid
           ,HAModuleVersionID
           ,UserRiskCategoryItemID
           ,UserRiskCategoryCodeName
           ,HARiskCategoryNodeGUID
           ,HARiskCategoryVersionID
           ,UserRiskAreaItemID
           ,UserRiskAreaCodeName
           ,HARiskAreaNodeGUID
           ,HARiskAreaVersionID
           ,UserQuestionItemID
           ,Title
           ,HAQuestionGuid
           ,UserQuestionCodeName
           ,HAQuestionDocumentID
           ,HAQuestionVersionID
           ,HAQuestionNodeGUID
           ,UserAnswerItemID
           ,HAAnswerNodeGUID
           ,HAAnswerVersionID
           ,UserAnswerCodeName
           ,HAAnswerValue
           ,HAModuleScore
           ,HARiskCategoryScore
           ,HARiskAreaScore
           ,HAQuestionScore
           ,HAAnswerPoints
           ,PointResults
           ,UOMCode
           ,HAScore
           ,ModulePreWeightedScore
           ,RiskCategoryPreWeightedScore
           ,RiskAreaPreWeightedScore
           ,QuestionPreWeightedScore
           ,QuestionGroupCodeName
           ,ChangeType
           ,ItemCreatedWhen
           ,ItemModifiedWhen
           ,IsProfessionallyCollected
           ,HARiskCategory_ItemModifiedWhen
           ,HAUserRiskArea_ItemModifiedWhen
           ,HAUserQuestion_ItemModifiedWhen
           ,HAUserAnswers_ItemModifiedWhen
           ,HAPaperFlg
           ,HATelephonicFlg
           ,HAStartedMode
           ,HACompletedMode
           ,DocumentCulture_VHCJ
           ,DocumentCulture_HAQuestionsView
           ,CampaignNodeGUID
           ,HACampaignID
           ,HashCode
           ,PKHashCode
           ,CHANGED_FLG
           ,CT_CMS_User_UserID
           ,CT_CMS_User_CHANGE_OPERATION
           ,CT_UserSettingsID
           ,CT_UserSettingsID_CHANGE_OPERATION
           ,SiteID_CtID
           ,SiteID_CHANGE_OPERATION
           ,UserSiteID_CtID
           ,UserSiteID_CHANGE_OPERATION
           ,AccountID_CtID
           ,AccountID__CHANGE_OPERATION
           ,HAUserAnswers_CtID
           ,HAUserAnswers_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserModule_CtID
           ,HFit_HealthAssesmentUserModule_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserQuestion_CtID
           ,HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserQuestionGroupResults_CtID
           ,HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserRiskArea_CtID
           ,HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserRiskCategory_CtID
           ,HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION
           ,HFit_HealthAssesmentUserStarted_CtID
           ,HFit_HealthAssesmentUserStarted_CHANGE_OPERATION
           --, CT_CMS_User_SCV 
           --, CT_CMS_UserSettings_SCV 
           --, CT_CMS_Site_SCV 
           --, CT_CMS_UserSite_SCV 
           --, CT_HFit_Account_SCV 
           --, CT_HFit_HealthAssesmentUserAnswers_SCV 
           --, CT_HFit_HealthAssesmentUserModule_SCV 
           --, CT_HFit_HealthAssesmentUserQuestion_SCV 
           --, CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV 
           --, CT_HFit_HealthAssesmentUserRiskArea_SCV 
           --, CT_HFit_HealthAssesmentUserRiskCategory_SCV 
           --, CT_HFit_HealthAssesmentUserStarted_SCV 
           ,NULL AS LastModifiedDate
           ,NULL AS DeleteFlg
      FROM view_EDW_HealthAssesment_CT;

END;

GO
PRINT 'CREATED proc_EDW_HA_TempTable_Load_All_Data.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'proc_EDW_HA_TempTable_Load_Changed_Data.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_EDW_HA_TempTable_Load_Changed_Data' )
    BEGIN
        DROP PROCEDURE
             proc_EDW_HA_TempTable_Load_Changed_Data
    END;
GO

CREATE PROCEDURE proc_EDW_HA_TempTable_Load_Changed_Data
AS
BEGIN

    truncate TABLE TEMP_EDW_HealthAssessment_DATA;

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_Dates' )
        BEGIN
            PRINT 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_Dates at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));

            CREATE NONCLUSTERED INDEX PI_TEMP_EDW_HealthAssessment_DATA_Dates ON dbo.TEMP_EDW_HealthAssessment_DATA ( ItemCreatedWhen ASC ,
            ItemModifiedWhen ASC , HARiskCategory_ItemModifiedWhen ASC , HAUserRiskArea_ItemModifiedWhen ASC ,
            HAUserQuestion_ItemModifiedWhen ASC ,
            HAUserAnswers_ItemModifiedWhen ASC ) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
            DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );
        END;

    IF NOT EXISTS
    ( SELECT
             name
        FROM sys.indexes
        WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_NATKEY' )
        BEGIN
            PRINT 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_NATKEY at: ' + CAST ( GETDATE ( ) AS nvarchar ( 50 ));
            CREATE INDEX PI_TEMP_EDW_HealthAssessment_DATA_NATKEY ON dbo.TEMP_EDW_HealthAssessment_DATA (
            UserStartedItemID
            , UserGUID
            , PKHashCode
            );
        END;

    IF NOT EXISTS ( SELECT
                           name
                      FROM sys.indexes
                      WHERE name = 'PI_TEMP_EDW_HealthAssessment_DATA_IDs' )
        BEGIN
            EXEC PrintNow 'Adding INDEX PI_TEMP_EDW_HealthAssessment_DATA_IDs';
            CREATE INDEX PI_TEMP_EDW_HealthAssessment_DATA_IDs ON dbo.TEMP_EDW_HealthAssessment_DATA (
            UserStartedItemID
            , HealthAssesmentUserStartedNodeGUID
            , UserGUID
            , SiteGUID
            , AccountCD
            , HAModuleNodeGUID
            , CMSNodeGuid
            , HARiskCategoryNodeGUID
            , UserRiskAreaItemID
            , HARiskAreaNodeGUID
            , UserQuestionItemID
            , HAQuestionGuid
            , HAQuestionNodeGUID
            , UserAnswerItemID
            , HAAnswerNodeGUID
            , CampaignNodeGUID
            )
            INCLUDE ( AccountID , UserModuleItemId , UserRiskCategoryItemID , DeletedFlg , HASHCODE , LastModifiedDate )
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON ,
            ALLOW_PAGE_LOCKS = ON );
        END;

    INSERT INTO TEMP_EDW_HealthAssessment_DATA
    (
          [UserStartedItemID]
      ,[HealthAssesmentUserStartedNodeGUID]
      ,[UserID]
      ,[UserGUID]
      ,[HFitUserMpiNumber]
      ,[SiteGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[AccountName]
      ,[HAStartedDt]
      ,[HACompletedDt]
      ,[UserModuleItemId]
      ,[UserModuleCodeName]
      ,[HAModuleNodeGUID]
      ,[CMSNodeGuid]
      ,[HAModuleVersionID]
      ,[UserRiskCategoryItemID]
      ,[UserRiskCategoryCodeName]
      ,[HARiskCategoryNodeGUID]
      ,[HARiskCategoryVersionID]
      ,[UserRiskAreaItemID]
      ,[UserRiskAreaCodeName]
      ,[HARiskAreaNodeGUID]
      ,[HARiskAreaVersionID]
      ,[UserQuestionItemID]
      ,[Title]
      ,[HAQuestionGuid]
      ,[UserQuestionCodeName]
      ,[HAQuestionDocumentID]
      ,[HAQuestionVersionID]
      ,[HAQuestionNodeGUID]
      ,[UserAnswerItemID]
      ,[HAAnswerNodeGUID]
      ,[HAAnswerVersionID]
      ,[UserAnswerCodeName]
      ,[HAAnswerValue]
      ,[HAModuleScore]
      ,[HARiskCategoryScore]
      ,[HARiskAreaScore]
      ,[HAQuestionScore]
      ,[HAAnswerPoints]
      ,[PointResults]
      ,[UOMCode]
      ,[HAScore]
      ,[ModulePreWeightedScore]
      ,[RiskCategoryPreWeightedScore]
      ,[RiskAreaPreWeightedScore]
      ,[QuestionPreWeightedScore]
      ,[QuestionGroupCodeName]
      ,[ItemCreatedWhen]
      ,[ItemModifiedWhen]
      ,[IsProfessionallyCollected]
      ,[HARiskCategory_ItemModifiedWhen]
      ,[HAUserRiskArea_ItemModifiedWhen]
      ,[HAUserQuestion_ItemModifiedWhen]
      ,[HAUserAnswers_ItemModifiedWhen]
      ,[HAPaperFlg]
      ,[HATelephonicFlg]
      ,[HAStartedMode]
      ,[HACompletedMode]
      ,[DocumentCulture_VHCJ]
      ,[DocumentCulture_HAQuestionsView]
      ,[CampaignNodeGUID]
      ,[HACampaignID]
      ,[HashCode]
      ,[ChangeType]
      ,[CHANGED_FLG]
      ,[LastModifiedDate]
      ,[DeleteFlg]
      ,[CT_CMS_User_UserID]
      ,[CT_CMS_User_CHANGE_OPERATION]
      ,[CT_UserSettingsID]
      ,[CT_UserSettingsID_CHANGE_OPERATION]
      ,[SiteID_CtID]
      ,[SiteID_CHANGE_OPERATION]
      ,[UserSiteID_CtID]
      ,[UserSiteID_CHANGE_OPERATION]
      ,[AccountID_CtID]
      ,[AccountID__CHANGE_OPERATION]
      ,[HAUserAnswers_CtID]
      ,[HAUserAnswers_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserModule_CtID]
      ,[HFit_HealthAssesmentUserModule_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserQuestion_CtID]
      ,[HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserQuestionGroupResults_CtID]
      ,[HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserRiskArea_CtID]
      ,[HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserRiskCategory_CtID]
      ,[HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserStarted_CtID]
      ,[HFit_HealthAssesmentUserStarted_CHANGE_OPERATION]
      ,[CT_CMS_User_SCV]
      ,[CT_CMS_UserSettings_SCV]
      ,[CT_CMS_Site_SCV]
      ,[CT_CMS_UserSite_SCV]
      ,[CT_HFit_Account_SCV]
      ,[CT_HFit_HealthAssesmentUserAnswers_SCV]
      ,[CT_HFit_HealthAssesmentUserModule_SCV]
      ,[CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV]
      ,[CT_HFit_HealthAssesmentUserRiskArea_SCV]
      ,[CT_HFit_HealthAssesmentUserRiskCategory_SCV]
      ,[CT_HFit_HealthAssesmentUserStarted_SCV]
      ,[PKHashCode])
    SELECT
           [UserStartedItemID]
      ,[HealthAssesmentUserStartedNodeGUID]
      ,[UserID]
      ,[UserGUID]
      ,[HFitUserMpiNumber]
      ,[SiteGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[AccountName]
      ,[HAStartedDt]
      ,[HACompletedDt]
      ,[UserModuleItemId]
      ,[UserModuleCodeName]
      ,[HAModuleNodeGUID]
      ,[CMSNodeGuid]
      ,[HAModuleVersionID]
      ,[UserRiskCategoryItemID]
      ,[UserRiskCategoryCodeName]
      ,[HARiskCategoryNodeGUID]
      ,[HARiskCategoryVersionID]
      ,[UserRiskAreaItemID]
      ,[UserRiskAreaCodeName]
      ,[HARiskAreaNodeGUID]
      ,[HARiskAreaVersionID]
      ,[UserQuestionItemID]
      ,[Title]
      ,[HAQuestionGuid]
      ,[UserQuestionCodeName]
      ,[HAQuestionDocumentID]
      ,[HAQuestionVersionID]
      ,[HAQuestionNodeGUID]
      ,[UserAnswerItemID]
      ,[HAAnswerNodeGUID]
      ,[HAAnswerVersionID]
      ,[UserAnswerCodeName]
      ,[HAAnswerValue]
      ,[HAModuleScore]
      ,[HARiskCategoryScore]
      ,[HARiskAreaScore]
      ,[HAQuestionScore]
      ,[HAAnswerPoints]
      ,[PointResults]
      ,[UOMCode]
      ,[HAScore]
      ,[ModulePreWeightedScore]
      ,[RiskCategoryPreWeightedScore]
      ,[RiskAreaPreWeightedScore]
      ,[QuestionPreWeightedScore]
      ,[QuestionGroupCodeName]
      ,[ItemCreatedWhen]
      ,[ItemModifiedWhen]
      ,[IsProfessionallyCollected]
      ,[HARiskCategory_ItemModifiedWhen]
      ,[HAUserRiskArea_ItemModifiedWhen]
      ,[HAUserQuestion_ItemModifiedWhen]
      ,[HAUserAnswers_ItemModifiedWhen]
      ,[HAPaperFlg]
      ,[HATelephonicFlg]
      ,[HAStartedMode]
      ,[HACompletedMode]
      ,[DocumentCulture_VHCJ]
      ,[DocumentCulture_HAQuestionsView]
      ,[CampaignNodeGUID]
      ,[HACampaignID]
      ,[HashCode]
      ,[ChangeType]
      ,[CHANGED_FLG]
      ,[LastModifiedDate]
      ,[DeleteFlg]
      ,[CT_CMS_User_UserID]
      ,[CT_CMS_User_CHANGE_OPERATION]
      ,[CT_UserSettingsID]
      ,[CT_UserSettingsID_CHANGE_OPERATION]
      ,[SiteID_CtID]
      ,[SiteID_CHANGE_OPERATION]
      ,[UserSiteID_CtID]
      ,[UserSiteID_CHANGE_OPERATION]
      ,[AccountID_CtID]
      ,[AccountID__CHANGE_OPERATION]
      ,[HAUserAnswers_CtID]
      ,[HAUserAnswers_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserModule_CtID]
      ,[HFit_HealthAssesmentUserModule_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserQuestion_CtID]
      ,[HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserQuestionGroupResults_CtID]
      ,[HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserRiskArea_CtID]
      ,[HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserRiskCategory_CtID]
      ,[HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION]
      ,[HFit_HealthAssesmentUserStarted_CtID]
      ,[HFit_HealthAssesmentUserStarted_CHANGE_OPERATION]
      ,[CT_CMS_User_SCV]
      ,[CT_CMS_UserSettings_SCV]
      ,[CT_CMS_Site_SCV]
      ,[CT_CMS_UserSite_SCV]
      ,[CT_HFit_Account_SCV]
      ,[CT_HFit_HealthAssesmentUserAnswers_SCV]
      ,[CT_HFit_HealthAssesmentUserModule_SCV]
      ,[CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV]
      ,[CT_HFit_HealthAssesmentUserRiskArea_SCV]
      ,[CT_HFit_HealthAssesmentUserRiskCategory_SCV]
      ,[CT_HFit_HealthAssesmentUserStarted_SCV]
      ,[PKHashCode]
      FROM view_EDW_HealthAssesment_CT
	   where ChangeType is not NULL ;
END;

GO
PRINT 'CREATED proc_EDW_HA_TempTable_Load_Changed_Data.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating proc_CT_GetHaDeletedDataIDS';
PRINT 'FROM proc_CT_GetHaDeletedDataIDS.sql';

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_GetHaDeletedDataIDS' )
    BEGIN
        DROP PROCEDURE
             proc_CT_GetHaDeletedDataIDS;
    END;
GO
-- exec proc_CT_GetHaDeletedDataIDS
-- drop table #HA_DELETES
CREATE PROC proc_CT_GetHaDeletedDataIDS
AS
BEGIN

    CREATE TABLE #HA_DELETES (
                 TABLE_NAME varchar( 100 ) NULL ,
                 SYS_CHANGE_VERSION bigint NULL ,
                 SYS_CHANGE_CREATION_VERSION bigint NULL ,
                 SYS_CHANGE_OPERATION nchar( 1 ) NULL ,
                 SYS_CHANGE_COLUMNS varbinary( 4100 ) NULL ,
                 SYS_CHANGE_CONTEXT varbinary( 128 ) NULL ,
                 ClassID int NOT NULL );

    DECLARE
       @b AS bit = 0;

    INSERT INTO #HA_DELETES
    SELECT
           'CMS_Class' ,
           *
      FROM CHANGETABLE( CHANGES CMS_Class , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'CMS_Document' ,
           *
      FROM CHANGETABLE( CHANGES CMS_Document , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'CMS_Site' ,
           *
      FROM CHANGETABLE( CHANGES CMS_Site , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'CMS_Tree' ,
           *
      FROM CHANGETABLE( CHANGES CMS_Tree , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from view_EDW_HealthAssesment_CT
    --select top 100 * from CMS_User
    --delete from CMS_User where 
    SELECT
           'CMS_User' ,
           *
      FROM CHANGETABLE( CHANGES CMS_User , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'CMS_UserSettings' ,
           *
      FROM CHANGETABLE( CHANGES CMS_UserSettings , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'CMS_UserSite' ,
           *
      FROM CHANGETABLE( CHANGES CMS_UserSite , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'COM_SKU' ,
           *
      FROM CHANGETABLE( CHANGES COM_SKU , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
--update HFit_Account set  AccountName = 'TrustMark' where AccountName = 'TrustMarl'
    SELECT
           'HFit_Account' ,
           *
      FROM CHANGETABLE( CHANGES HFit_Account , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HACampaign
    --update HFit_HACampaign set SocialProofID = -1 where SocialProofID is null
    SELECT
           'HFit_HACampaign' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HACampaign , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssesmentMatrixQuestion' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentMatrixQuestion , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssesmentMultipleChoiceQuestion' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentMultipleChoiceQuestion , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HealthAssesmentUserAnswers
    --update HFit_HealthAssesmentUserAnswers set HAAnswerValue = null where UserID = 662 and HAAnswerValue is null
    SELECT
           'HFit_HealthAssesmentUserAnswers' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserAnswers , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HealthAssesmentUserModule
    --delete from HFit_HealthAssesmentUserModule where ItemID = 1529
    SELECT
           'HFit_HealthAssesmentUserModule' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserModule , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HealthAssesmentUserQuestion
    --delete from HFit_HealthAssesmentUserModule where ItemID = 15054
    SELECT
           'HFit_HealthAssesmentUserQuestion' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserQuestion , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssesmentUserQuestionGroupResults' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserQuestionGroupResults , NULL )AS CT
    --where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssesmentUserRiskArea' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserRiskArea , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssesmentUserRiskCategory' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserRiskCategory , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HealthAssesmentUserStarted
    --delete from HFit_HealthAssesmentUserStarted where itemid = 823
    SELECT
           'HFit_HealthAssesmentUserStarted' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserStarted , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    --select top 100 * from HFit_HealthAssessment
    SELECT
           'HFit_HealthAssessment' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssessment , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_HealthAssessmentFreeForm' ,
           *
      FROM CHANGETABLE( CHANGES HFit_HealthAssessmentFreeForm , NULL )AS CT       ----where SYS_CHANGE_OPERATION = 'D'
    UNION ALL
    SELECT
           'HFit_LKP_EDW_RejectMPI' ,
           *
      FROM CHANGETABLE( CHANGES HFit_LKP_EDW_RejectMPI , NULL )AS CT;       ----where SYS_CHANGE_OPERATION = 'D';

    DECLARE
                                                                               @NbrUpdates AS int = @@ROWCOUNT;
    DECLARE
       @iInsert AS int = 0;
    DECLARE
       @iUpdate AS int = 0;
    DECLARE
       @iDel AS int = 0;

    IF @NbrUpdates = 0
        BEGIN
            PRINT 'No changes found';
            SET @b = 0;
        END;
    ELSE
        BEGIN
            SET @iInsert = ( SELECT
                                    COUNT ( * )
                               FROM #HA_DELETES
                               WHERE SYS_CHANGE_OPERATION = 'I' );
            SET @iUpdate = ( SELECT
                                    COUNT ( * )
                               FROM #HA_DELETES
                               WHERE SYS_CHANGE_OPERATION = 'U' );
            SET @iDel = ( SELECT
                                 COUNT ( * )
                            FROM #HA_DELETES
                            WHERE SYS_CHANGE_OPERATION = 'D' );
            PRINT CAST ( @NbrUpdates AS nvarchar ( 50 )) + ' Changes found';
            PRINT CAST ( @iInsert AS nvarchar ( 50 )) + ' Inserts found';
            PRINT CAST ( @iUpdate AS nvarchar ( 50 )) + ' Updates found';
            PRINT CAST ( @iDel AS nvarchar ( 50 )) + ' Deletes found';
            SET @b = 1;
            IF @iDel > 0
                BEGIN
                    SET @b = 2;
                END;
        END;
    SELECT
           *
      FROM #HA_DELETES;
END;
GO
PRINT 'Created proc_CT_GetHaDeletedDataIDS';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating procedure proc_clean_EDW_Staging';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_clean_EDW_Staging' )
    BEGIN
        PRINT 'Recreating procedure proc_clean_EDW_Staging';
        DROP PROCEDURE
             proc_clean_EDW_Staging;
    END;
GO
--exec proc_clean_EDW_Staging
CREATE PROCEDURE proc_clean_EDW_Staging
AS
BEGIN
    WITH CTE (
         UserStartedItemID
         ,UserGUID
         ,PKHashCode ,
         DeletedFlg ,
         LastModifiedDate ,
         DuplicateCount )
        AS (
        SELECT
               UserStartedItemID
               ,UserGUID
               ,PKHashCode ,
               DeletedFlg ,
               LastModifiedDate ,
               ROW_NUMBER( ) OVER( PARTITION BY UserStartedItemID ,
                                                UserGUID ,
                                                PKHashCode ORDER BY UserStartedItemID, UserGUID, PKHashCode , DeletedFlg , LastModifiedDate ) AS DuplicateCount
          FROM DIM_EDW_HealthAssessment
        )
        DELETE
        FROM CTE
          WHERE
                DuplicateCount > 1;
END;

GO
PRINT 'Recreated procedure proc_clean_EDW_Staging';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
print 'Creating proc_MonitorLogStats.SQL' ;
go

/*
DBCC SQLPERF( logspace );
*/

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'spSQLPerf' )
    BEGIN
        DROP PROCEDURE
             spSQLPerf
    END;
GO

CREATE PROC dbo.spSQLPerf
AS
BEGIN
    DBCC SQLPERF( logspace );
END;
GO

/*
exec spGetSQLPerfStats ;
go
select * from logSpaceStats order by id desc
*/
IF NOT EXISTS ( SELECT
                       name
                  FROM sys.tables
                  WHERE name = 'logSpaceStats' )
    BEGIN
        CREATE TABLE dbo.logSpaceStats
        (
                     id int IDENTITY ( 1 , 1 ) ,
                     logDate datetime DEFAULT GETDATE( ) ,
                     databaseName sysname ,
                     logSize decimal( 18 , 5 ) ,
                     logUsed decimal( 18 , 5 )
        );
    END;
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'spGetSQLPerfStats' )
    BEGIN
        DROP PROCEDURE
             spGetSQLPerfStats
    END;
GO

CREATE PROC dbo.spGetSQLPerfStats
AS
BEGIN
    SET NOCOUNT ON;

    CREATE TABLE #tFileList
    (
                 databaseName sysname ,
                 logSize decimal( 18 , 5 ) ,
                 logUsed decimal( 18 , 5 ) ,
                 status int
    );

    INSERT INTO #tFileList
    EXEC spSQLPerf;

    INSERT INTO logSpaceStats (
           databaseName ,
           logSize ,
           logUsed )
    SELECT
           databasename ,
           logSize ,
           logUsed
      FROM #tFileList;

    DROP TABLE
         #tFileList;
END;
GO

EXEC spGetSQLPerfStats;

--SELECT * FROM dbo.logSpaceStats;

GO

PRINT 'Creating JOB job_MonitorLogStats' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;


DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_MonitorLogStats_' + @TGTDB;

IF EXISTS (SELECT job_id 
            FROM msdb.dbo.sysjobs_view 
            WHERE name = @JNAME)
begin
    EXEC msdb..sp_delete_job @job_name = @JNAME;
end;


/****** Object:  Job [job_MonitorLogStats]    Script Date: 6/14/2015 8:10:16 AM ******/
BEGIN TRANSACTION
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 6/14/2015 8:10:16 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name= @JNAME, 
		@enabled=1, 
		@notify_level_eventlog=2, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Track the daily SQL log growth', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'dmiller', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [acquireStats]    Script Date: 6/14/2015 8:10:17 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'acquireStats', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXEC spGetSQLPerfStats;', 
		@database_name= @TGTDB, 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'LogMonitorSchedule', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=1, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20150614, 
		@active_end_date=99991231, 
		@active_start_time=210000, 
		@active_end_time=235959, 
		@schedule_uid=N'7fc5fb9d-207b-4814-97c2-0a512a65c47e'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:


go
--select * from view_logSpaceStats
if exists (select name from sys.views where name = 'view_logSpaceStats')
    drop view view_logSpaceStats ;
go
create view view_logSpaceStats
as
SELECT [id]
      ,[logDate] as LogEntryDate
      ,[databaseName]
      ,[logSize] as LogSizeMB
      ,[logUsed] as LogPctUsed
  FROM [dbo].[logSpaceStats]
GO

print 'Created proc_MonitorLogStats.SQL' ;

go

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
print 'Creating proc_Denormalize_EDW_Views.sql';
go

if exists (select name from sys.procedures where name = 'proc_Denormalize_EDW_Views')
    drop procedure proc_Denormalize_EDW_Views;
--exec proc_Denormalize_EDW_Views
go
CREATE PROCEDURE proc_Denormalize_EDW_Views
AS
BEGIN
/*
Author:	  W. Dale Miller
Created:	  06.15.2015
USE:		  exec proc_Denormalize_EDW_Views
PERF:	  Appox 50 minutes
*/
SET NOCOUNT ON;
    IF EXISTS ( SELECT
                       name
                  FROM tempdb.dbo.sysobjects
                  WHERE id = OBJECT_ID ( N'tempdb..##TEMP_HFit_HealthAssesmentUserQuestion' ))

        BEGIN

            DROP TABLE
                 ##TEMP_HFit_HealthAssesmentUserQuestion;
        END;

    SELECT
           USERQUES.ItemID
           ,USERQUES.HAQuestionNodeGUID
           ,USERQUES.CodeName
           ,USERQUES.HAQuestionScore
           ,USERQUES.PreWeightedScore
           ,USERQUES.IsProfessionallyCollected
           ,USERQUES.ItemModifiedWhen
           ,USERQUES.HARiskAreaItemID
           ,CT_HFit_HealthAssesmentUserQuestion.ItemID AS HFit_HealthAssesmentUserQuestion_CtID
           ,CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION
           ,CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserQuestion_SCV
		  
    INTO
         ##TEMP_HFit_HealthAssesmentUserQuestion
      FROM
           HFit_HealthAssesmentUserQuestion AS USERQUES LEFT OUTER JOIN
                CHANGETABLE( CHANGES HFit_HealthAssesmentUserQuestion , NULL )AS CT_HFit_HealthAssesmentUserQuestion
                                                        ON USERQUES.ItemID = CT_HFit_HealthAssesmentUserQuestion.ItemID;
    
    -- select top 100 * from ##TEMP_HFit_HealthAssesmentUserQuestion

    CREATE UNIQUE CLUSTERED INDEX TEMP_USERQUES ON ##TEMP_HFit_HealthAssesmentUserQuestion
    (
    ItemID
    , HARiskAreaItemID
    , HAQuestionNodeGUID
    , CodeName
    , HAQuestionScore
    , PreWeightedScore
    , ItemModifiedWhen
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , IGNORE_DUP_KEY = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

    CREATE NONCLUSTERED INDEX PI_USERQUES_RiskAreaID
    ON ##TEMP_HFit_HealthAssesmentUserQuestion ( HARiskAreaItemID )
    INCLUDE ( ItemID , HAQuestionNodeGUID , CodeName , HAQuestionScore , PreWeightedScore , IsProfessionallyCollected , ItemModifiedWhen );

    IF EXISTS ( SELECT
                       name
                  FROM tempdb.dbo.sysobjects
                  WHERE id = OBJECT_ID ( N'tempdb..##TEMP_View_HFit_HACampaign_Joined' ))

        BEGIN

            --PRINT 'Dropping ##TEMP_View_HFit_HACampaign_Joined';

            DROP TABLE
                 ##TEMP_View_HFit_HACampaign_Joined;
        END;

    SELECT
           campaign.DocumentCulture
           ,campaign.HACampaignID
           ,campaign.NodeGUID
           ,campaign.NodeSiteID
           ,campaign.HealthAssessmentID
    INTO
         ##TEMP_View_HFit_HACampaign_Joined
      FROM View_HFit_HACampaign_Joined AS campaign;

    CREATE UNIQUE CLUSTERED INDEX TEMP_campaign ON ##TEMP_View_HFit_HACampaign_Joined
    (
    DocumentCulture ASC ,
    HACampaignID ASC ,
    NodeGUID ASC ,
    HealthAssessmentID
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , IGNORE_DUP_KEY = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

    IF EXISTS ( SELECT
                       name
                  FROM tempdb.dbo.sysobjects
                  WHERE id = OBJECT_ID ( N'tempdb..##TEMP_View_HFit_HealthAssessment_Joined' ))

        BEGIN

            --PRINT 'Dropping ##TEMP_View_HFit_HealthAssessment_Joined';

            DROP TABLE
                 ##TEMP_View_HFit_HealthAssessment_Joined;
        END;

    SELECT
           HAJOINED.NodeGUID
           ,HAJOINED.DocumentID
    INTO
         ##TEMP_View_HFit_HealthAssessment_Joined
      FROM View_HFit_HealthAssessment_Joined AS HAJOINED;

    SET ANSI_PADDING ON;

    CREATE UNIQUE CLUSTERED INDEX TEMP_HAJOINED ON ##TEMP_View_HFit_HealthAssessment_Joined
    (
    NodeGUID ASC ,
    DocumentID ASC
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , IGNORE_DUP_KEY = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

    IF EXISTS ( SELECT
                       name
                  FROM tempdb.dbo.sysobjects
                  WHERE id = OBJECT_ID ( N'tempdb..##TEMP_View_EDW_HealthAssesmentQuestions' ))

        BEGIN

            --PRINT 'Dropping ##TEMP_View_EDW_HealthAssesmentQuestions';

            DROP TABLE
                 ##TEMP_View_EDW_HealthAssesmentQuestions;
        END;

    SELECT
           dbo.udf_StripHTML ( QUES.Title ) AS Title
           ,QUES.DocumentCulture
           ,QUES.NodeGUID
    INTO
         ##TEMP_View_EDW_HealthAssesmentQuestions
      FROM View_EDW_HealthAssesmentQuestions AS QUES;

    SET ANSI_PADDING ON;

    CREATE UNIQUE CLUSTERED INDEX TEMP_Ques ON ##TEMP_View_EDW_HealthAssesmentQuestions
    (
    DocumentCulture ASC ,
    NodeGUID ASC
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , IGNORE_DUP_KEY = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON );

END;

go
print 'Created proc_Denormalize_EDW_Views.sql';
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--HFit_HealthAssesmentUserRiskCategory
--CREATE INDEX [CI_HFit_HealthAssesmentUserRiskCategory] ON [dbo].[HFit_HealthAssesmentUserRiskCategory]
--(
--	ItemID include(ItemModifiedWhen, HARiskCategoryScore, PreWeightedScore,HARiskCategoryNodeGUID)
--)

GO

PRINT 'Creating proc_Stage_EDW_Views.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_Stage_EDW_Views' )
    BEGIN
        DROP PROCEDURE
             proc_Stage_EDW_Views
    END;
GO
CREATE PROCEDURE proc_Stage_EDW_Views
AS
BEGIN

    IF EXISTS ( SELECT
                       name
                  FROM sys.tables
                  WHERE name = 'STAGED_View_HFit_HealthAssessment_Joined' )
        BEGIN
            DROP TABLE
                 STAGED_View_HFit_HealthAssessment_Joined
        END;

    SELECT
           * INTO
                  STAGED_View_HFit_HealthAssessment_Joined
      FROM View_HFit_HealthAssessment_Joined;
    CREATE CLUSTERED INDEX PI_STAGED_View_HFit_HealthAssessment_Joined ON dbo.STAGED_View_HFit_HealthAssessment_Joined
    (
    DocumentID
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON ) ON [PRIMARY];

    IF EXISTS ( SELECT
                       name
                  FROM sys.tables
                  WHERE name = 'STAGED_View_HFit_HACampaign_Joined' )
        BEGIN
            DROP TABLE
                 STAGED_View_HFit_HACampaign_Joined
        END;

    SELECT
           * INTO
                  STAGED_View_HFit_HACampaign_Joined
      FROM View_HFit_HACampaign_Joined
      WHERE DocumentCulture = 'en-US';
    CREATE CLUSTERED INDEX PI_STAGED_View_HFit_HACampaign_Joined ON dbo.STAGED_View_HFit_HACampaign_Joined
    (
    NodeGUID , NodeSiteID , DocumentCulture
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON ) ON [PRIMARY];

    IF EXISTS ( SELECT
                       name
                  FROM sys.tables
                  WHERE name = 'STAGED_View_EDW_HealthAssesmentQuestions' )
        BEGIN
            DROP TABLE
                 STAGED_View_EDW_HealthAssesmentQuestions
        END;

    SELECT
           * INTO
                  STAGED_View_EDW_HealthAssesmentQuestions
      FROM View_EDW_HealthAssesmentQuestions
      WHERE documentculture = 'en-US';
    CREATE CLUSTERED INDEX PI_STAGED_View_EDW_HealthAssesmentQuestions ON dbo.STAGED_View_EDW_HealthAssesmentQuestions
    (
    NodeGUID , DocumentCulture
    )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON ) ON [PRIMARY];
END;

GO
PRINT 'Created proc_Stage_EDW_Views.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating CI_ItemID_HealthAssesmentUserAnswers.sql';
GO

IF NOT EXISTS ( SELECT
                       name
                  FROM sys.indexes
                  WHERE name = 'CI_ItemID_HealthAssesmentUserAnswers' )
    BEGIN
        CREATE NONCLUSTERED INDEX CI_ItemID_HealthAssesmentUserAnswers ON dbo.HFit_HealthAssesmentUserAnswers
        ( ItemID , HAQuestionItemID )
        INCLUDE(
        HAAnswerNodeGUID ,
        CodeName ,
        HAAnswerValue ,
        HAAnswerPoints ,
        UOMCode ,
        ItemCreatedWhen ,
        ItemModifiedWhen
        )WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON ) ON [PRIMARY]
    END;

GO
PRINT 'Created CI_ItemID_HealthAssesmentUserAnswers.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'EXecuting proc_CkSmallStepsHasChanged.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CkSmallStepsHasChanged' )
    BEGIN
        DROP PROCEDURE
             proc_CkSmallStepsHasChanged
    END;

GO
--exec [proc_CkSmallStepsHasChanged]
CREATE PROCEDURE proc_CkSmallStepsHasChanged
AS
BEGIN
/*
Author:	  W. Dale Miller
RETURNS:	  Integer -   0 = no changes
				    1 = updates or inserts, no deletes
				    2 = DELETES and possibly updates or inserts
*/
    DECLARE
       @b AS int = 0,
       @dels AS int = 0,
       @ins AS int = 0,
       @updt AS int = 0;

    DECLARE
       @TempSmallSteps AS TABLE
       (
                                SYS_CHANGE_OPERATION nvarchar( 10 )
       );

    INSERT INTO @TempSmallSteps
    (
           SYS_CHANGE_OPERATION
    )
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_Class , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_Document , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_Site , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_Tree , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_User , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_UserSettings , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_UserSite , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES COM_SKU , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_Account , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_HACampaign , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_HealthAssesmentUserStarted , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_OutComeMessages , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES Hfit_SmallStepResponses , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_ToDoSmallSteps , NULL )AS CT;

    SET @b = ( SELECT
                      COUNT( * )
                 FROM @TempSmallSteps );
    PRINT 'Number of changes found: ' + CAST( @b AS nvarchar( 50 ));


    IF @b > 0
        BEGIN

            SET @dels = ( SELECT
                                 COUNT( * )
                            FROM @TempSmallSteps
                            WHERE SYS_CHANGE_OPERATION = 'D' );
            SET @ins = ( SELECT
                                COUNT( * )
                           FROM @TempSmallSteps
                           WHERE SYS_CHANGE_OPERATION = 'I' );
            SET @updt = ( SELECT
                                 COUNT( * )
                            FROM @TempSmallSteps
                            WHERE SYS_CHANGE_OPERATION = 'U' );

            PRINT 'Number of inserts: ' + CAST( @ins AS nvarchar( 50 ));
            PRINT 'Number of updates: ' + CAST( @updt AS nvarchar( 50 ));
            PRINT 'Number of deletes: ' + CAST( @dels AS nvarchar( 50 ));

            IF @dels > 0
                BEGIN
                    SET @b = 2 ;
                END
            ELSE
                BEGIN
                    SET @b = 1;
                END;
        END;
    print 'Returned Value: ' + cast(@b as nvarchar(50)) ;
    RETURN @b;

END;

GO
PRINT 'EXecuted proc_CkSmallStepsHasChanged.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go 
print 'Executing proc_CT_SmallSteps_AddDeletedRecords.SQL'
go
if exists (select name from sys.procedures where name = 'proc_CT_SmallSteps_AddDeletedRecords')
    drop procedure proc_CT_SmallSteps_AddDeletedRecords;
go

create procedure proc_CT_SmallSteps_AddDeletedRecords
AS
DECLARE
           @DELDATE AS datetime2 ( 7 ) = GETDATE ( );
        WITH CTE_DEL (
             AccountCD
             ,SiteGUID
             ,SSItemID
             ,SSItemGUID
             ,SSHealthAssesmentUserStartedItemID
             ,SSOutcomeMessageGuid
             ,HFitUserMPINumber
             ,HACampaignNodeGUID
             ,HAStartedMode
             ,HACompletedMode
             ,HaCodeName
             ,HACampaignStartDate
             ,HACampaignEndDate )
            AS ( SELECT
                        AccountCD
                        ,SiteGUID
                        ,SSItemID
                        ,SSItemGUID
                        ,SSHealthAssesmentUserStartedItemID
                        ,SSOutcomeMessageGuid
                        ,HFitUserMPINumber
                        ,HACampaignNodeGUID
                        ,HAStartedMode
                        ,HACompletedMode
                        ,HaCodeName
                        ,HACampaignStartDate
                        ,HACampaignEndDate
                   FROM DIM_EDW_SmallSteps
                 EXCEPT
                 SELECT
                        AccountCD
                        ,SiteGUID
                        ,SSItemID
                        ,SSItemGUID
                        ,SSHealthAssesmentUserStartedItemID
                        ,SSOutcomeMessageGuid
                        ,HFitUserMPINumber
                        ,HACampaignNodeGUID
                        ,HAStartedMode
                        ,HACompletedMode
                        ,HaCodeName
                        ,HACampaignStartDate
                        ,HACampaignEndDate
                   FROM Temp_SmallSteps )
            UPDATE S
              SET
                  DeletedFlg = 1
                  ,LastModifiedDate = @DELDATE
              FROM DIM_EDW_SmallSteps AS S JOIN
                        CTE_DEL AS C
                                               ON
                   S.AccountCD = C.AccountCD
               AND S.SiteGUID = C.SiteGUID
               AND S.SSItemID = C.SSItemID
               AND S.SSItemGUID = C.SSItemGUID
               AND S.SSHealthAssesmentUserStartedItemID = C.SSHealthAssesmentUserStartedItemID
               AND S.SSOutcomeMessageGuid = C.SSOutcomeMessageGuid
               AND S.HFitUserMPINumber = C.HFitUserMPINumber
               AND S.HACampaignNodeGUID = C.HACampaignNodeGUID
               AND s.HACampaignStartDate = c.HACampaignStartDate
               AND s.HACampaignEndDate = C.HACampaignEndDate
               AND S.HAStartedMode = C.HAStartedMode
               AND S.HACompletedMode = C.HACompletedMode
               AND S.HaCodeName = C.HaCodeName;
        DECLARE
           @iDeleted AS int = @@ROWCOUNT;
    return @iDeleted ;
go 
print 'Executed proc_CT_SmallSteps_AddDeletedRecords.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go 
print 'Executing proc_CT_SmallSteps_AddUpdatedRecs.SQL'
go
if exists (select name from sys.procedures where name = 'proc_CT_SmallSteps_AddUpdatedRecs')    
    drop procedure proc_CT_SmallSteps_AddUpdatedRecs;
go

create procedure proc_CT_SmallSteps_AddUpdatedRecs
AS
DECLARE
		  @RUNDATE AS datetime2 ( 7 ) = GETDATE ( );

        UPDATE S
          SET
              S.UserID = T.UserID
              ,S.AccountCD = T.AccountCD
              ,S.SiteGUID = T.SiteGUID
              ,S.SSItemID = T.SSItemID
              ,S.SSItemCreatedBy = T.SSItemCreatedBy
              ,S.SSItemCreatedWhen = T.SSItemCreatedWhen
              ,S.SSItemModifiedBy = T.SSItemModifiedBy
              ,S.SSItemModifiedWhen = T.SSItemModifiedWhen
              ,S.SSItemOrder = T.SSItemOrder
              ,S.SSItemGUID = T.SSItemGUID
              ,S.SSHealthAssesmentUserStartedItemID = T.SSHealthAssesmentUserStartedItemID
              ,S.SSOutcomeMessageGuid = T.SSOutcomeMessageGuid
              ,S.SSOutcomeMessage = T.SSOutcomeMessage
              ,S.HACampaignNodeGUID = T.HACampaignNodeGUID
              ,S.HACampaignName = T.HACampaignName
              ,S.HACampaignStartDate = T.HACampaignStartDate
              ,S.HACampaignEndDate = T.HACampaignEndDate
              ,S.HAStartedDate = T.HAStartedDate
              ,S.HACompletedDate = T.HACompletedDate
              ,S.HAStartedMode = T.HAStartedMode
              ,S.HACompletedMode = T.HACompletedMode
              ,S.HaCodeName = T.HaCodeName
              ,S.HFitUserMPINumber = T.HFitUserMPINumber
              ,S.HashCode = T.HashCode
              ,S.ChangeType = 'U'
              ,S.LastModifiedDate = GETDATE ( )
              ,S.DeletedFlg = NULL
              ,S.ConvertedToCentralTime = NULL
          FROM ##Temp_SmallSteps AS T JOIN
                    DIM_EDW_SmallSteps AS S
                                    ON
                   S.AccountCD = T.AccountCD
               AND S.SiteGUID = T.SiteGUID
               AND S.SSItemID = T.SSItemID
               AND S.SSItemGUID = T.SSItemGUID
               AND S.SSHealthAssesmentUserStartedItemID = T.SSHealthAssesmentUserStartedItemID
               AND S.SSOutcomeMessageGuid = T.SSOutcomeMessageGuid
               AND S.HFitUserMPINumber = T.HFitUserMPINumber
               AND S.HACampaignNodeGUID = T.HACampaignNodeGUID
               AND S.HAStartedMode = T.HAStartedMode
               AND S.HACompletedMode = T.HACompletedMode
               AND S.HaCodeName = T.HaCodeName
               AND S.HACampaignStartDate = t.HACampaignStartDate
               AND S.HACampaignEndDate = t.HACampaignEndDate
           AND S.HASHCODE != T.HASHCODE
           AND S.DeletedFlg IS NULL;
        DECLARE
           @iUpdated AS int = + @@ROWCOUNT;
    RETURN @iUpdated  ;
go 
print 'Executed proc_CT_SmallSteps_AddUpdatedRecs.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go 
print 'Executing proc_CT_SmallSteps_AddNewRecs.SQL'
go

if exists (select name from sys.procedures where name = 'proc_CT_SmallSteps_AddNewRecs')    
    drop procedure proc_CT_SmallSteps_AddNewRecs;
go
--exec proc_CT_SmallSteps_AddNewRecs
create procedure proc_CT_SmallSteps_AddNewRecs
as
WITH CTE_NEW (HFitUserMPINumber, HashCode )
            AS ( SELECT
                        HFitUserMPINumber, HashCode
                   FROM ##Temp_SmallSteps
                 EXCEPT
                 SELECT
                        HFitUserMPINumber, HashCode
                   FROM dbo.DIM_EDW_SmallSteps
                   WHERE DeletedFlg is null )
            INSERT INTO DIM_EDW_SmallSteps
            (
                   UserID
                   ,AccountCD
                   ,SiteGUID
                   ,SSItemID
                   ,SSItemCreatedBy
                   ,SSItemCreatedWhen
                   ,SSItemModifiedBy
                   ,SSItemModifiedWhen
                   ,SSItemOrder
                   ,SSItemGUID
                   ,SSHealthAssesmentUserStartedItemID
                   ,SSOutcomeMessageGuid
                   ,SSOutcomeMessage
                   ,HACampaignNodeGUID
                   ,HACampaignName
                   ,HACampaignStartDate
                   ,HACampaignEndDate
                   ,HAStartedDate
                   ,HACompletedDate
                   ,HAStartedMode
                   ,HACompletedMode
                   ,HaCodeName
                   ,HFitUserMPINumber
                   ,DeletedFlg
                   ,LastModifiedDate
                   ,HashCode
                   ,ChangeType
                   ,CT_UserSettingsID
                   ,CT_CMS_UserSettings_SCV
                   ,SiteID_CtID
                   ,SiteID_CHANGE_OPERATION
                   ,SITE_SCV
                   ,Campaign_CtID
                   ,Campaign_SCV
                   ,HealthAssesmentUserStarted_CtID
                   ,HealthAssesmentUserStarted_SCV
                   ,OutComeMessages_CtID
                   ,OutComeMessages_SCV
                   ,HFit_Account_CtID
                   ,HFit_Account_SCV
                   ,ToDoSmallSteps_CtID
                   ,ToDoSmallSteps_SCV
                   ,CT_UserSettings_CHANGE_OPERATION
                   ,Campaign_CHANGE_OPERATION
                   ,HealthAssesmentUserStarted_CHANGE_OPERATION
                   ,OutComeMessages_CHANGE_OPERATION
                   ,HFit_Account_CHANGE_OPERATION
                   ,ToDoSmallSteps_CHANGE_OPERATION
                   ,SmallStepResponses_CtID
                   ,SmallStepResponses_SCV
                   ,SmallStepResponses_CHANGE_OPERATION
                   --,RowNbr
                   ,TimeZone
                   ,ConvertedToCentralTime )
            SELECT
                   T.UserID
                   ,T.AccountCD
                   ,T.SiteGUID
                   ,T.SSItemID
                   ,T.SSItemCreatedBy
                   ,T.SSItemCreatedWhen
                   ,T.SSItemModifiedBy
                   ,T.SSItemModifiedWhen
                   ,T.SSItemOrder
                   ,T.SSItemGUID
                   ,T.SSHealthAssesmentUserStartedItemID
                   ,T.SSOutcomeMessageGuid
                   ,T.SSOutcomeMessage
                   ,T.HACampaignNodeGUID
                   ,T.HACampaignName
                   ,T.HACampaignStartDate
                   ,T.HACampaignEndDate
                   ,T.HAStartedDate
                   ,T.HACompletedDate
                   ,T.HAStartedMode
                   ,T.HACompletedMode
                   ,T.HaCodeName
                   ,T.HFitUserMPINumber
                   ,null AS DeletedFlg
                   ,null as LastModifiedDate
                   ,T.HashCode
                   ,T.ChangeType
                   ,T.CT_UserSettingsID
                   ,T.CT_CMS_UserSettings_SCV
                   ,T.SiteID_CtID
                   ,T.SiteID_CHANGE_OPERATION
                   ,T.SITE_SCV
                   ,T.Campaign_CtID
                   ,T.Campaign_SCV
                   ,T.HealthAssesmentUserStarted_CtID
                   ,T.HealthAssesmentUserStarted_SCV
                   ,T.OutComeMessages_CtID
                   ,T.OutComeMessages_SCV
                   ,T.HFit_Account_CtID
                   ,T.HFit_Account_SCV
                   ,T.ToDoSmallSteps_CtID
                   ,T.ToDoSmallSteps_SCV
                   ,T.CT_UserSettings_CHANGE_OPERATION
                   ,T.Campaign_CHANGE_OPERATION
                   ,T.HealthAssesmentUserStarted_CHANGE_OPERATION
                   ,T.OutComeMessages_CHANGE_OPERATION
                   ,T.HFit_Account_CHANGE_OPERATION
                   ,T.ToDoSmallSteps_CHANGE_OPERATION
                   ,T.SmallStepResponses_CtID
                   ,T.SmallStepResponses_SCV
                   ,T.SmallStepResponses_CHANGE_OPERATION
                   --,NULL AS RowNbr
                   ,NULL AS TimeZone
                   ,NULL AS ConvertedToCentralTime
              FROM
                   ##Temp_SmallSteps AS T JOIN
                        CTE_NEW AS C
                                        ON
				T.HFitUserMPINumber = C.HFitUserMPINumber
				AND T.HashCode = C.HashCode;

        DECLARE
           @iInserted AS int = @@ROWCOUNT;
	   PRINT 'Records Added: ' + CAST ( @iInserted AS nvarchar( 5 ));
	   return @iInserted ;
go 
print 'Executed proc_CT_SmallSteps_AddNewRecs.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_Coaching_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_Coaching_AddNewRecs' )
    BEGIN
        DROP PROCEDURE
             proc_CT_Coaching_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_Coaching_AddNewRecs
AS
BEGIN

    WITH CTE (
         UserGUID
         ,SiteGUID
         ,AccountID
         ,AccountCD
         ,CoachID
         ,email
    )
        AS (
        SELECT
               UserGUID
               ,isnull(SiteGUID,'00000000-0000-0000-0000-000000000000') 
               ,isnull(AccountID,' ')
               ,isnull(AccountCD, ' ' )
               ,isnull(CoachID,-1)
               ,email
          FROM ##DIM_TEMPTBL_EDW_Coaches_DATA
        EXCEPT
        SELECT
               UserGUID
               ,isnull(SiteGUID,'00000000-0000-0000-0000-000000000000') 
               ,isnull(AccountID,' ')
               ,isnull(AccountCD, ' ' )
               ,isnull(CoachID,-1)
               ,email
          FROM DIM_EDW_Coaches
          WHERE LastModifiedDate IS NULL
        )
        INSERT INTO dbo.DIM_EDW_Coaches
        (
               UserGUID
               ,SiteGUID
               ,AccountID
               ,AccountCD
               ,CoachID
               ,LastName
               ,FirstName
               ,StartDate
               ,Phone
               ,email
               ,Supervisor
               ,SuperCoach
               ,MaxParticipants
               ,Inactive
               ,MaxRiskLevel
               ,Locked
               ,TimeLocked
               ,terminated
               ,APMaxParticipants
               ,RNMaxParticipants
               ,RNPMaxParticipants
               ,Change_Type
               ,Last_Update_Dt
               ,HashCode
               ,LastModifiedDate
               ,DeletedFlg
        )
        SELECT
               T.UserGUID
               ,T.SiteGUID
               ,T.AccountID
               ,T.AccountCD
               ,T.CoachID
               ,T.LastName
               ,T.FirstName
               ,T.StartDate
               ,T.Phone
               ,T.email
               ,T.Supervisor
               ,T.SuperCoach
               ,T.MaxParticipants
               ,T.Inactive
               ,T.MaxRiskLevel
               ,T.Locked
               ,T.TimeLocked
               ,T.terminated
               ,T.APMaxParticipants
               ,T.RNMaxParticipants
               ,T.RNPMaxParticipants
               ,T.Change_Type
               ,T.Last_Update_Dt
               ,T.HashCode
               ,NULL AS LastModifiedDate
               ,NULL AS DeletedFlg
          FROM
               ##DIM_TEMPTBL_EDW_Coaches_DATA AS T JOIN
                    CTE AS S
                                                    ON
               S.UserGUID = T.UserGUID
           AND ISNULL( S.SiteGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.SiteGUID , '00000000-0000-0000-0000-000000000000' )
           AND ISNULL( S.AccountID , '' ) = ISNULL( T.AccountID , '' )
           AND ISNULL( S.AccountCD , '' ) = ISNULL( T.AccountCD , '' )
           AND ISNULL( S.CoachID , -1 ) = ISNULL( T.CoachID , -1 )
           AND S.email = T.email;

    DECLARE
       @iInserts AS int = @@ROWCOUNT;
    PRINT 'Insert Count: ' + CAST ( @iInserts AS nvarchar( 50 ));
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_Coaching_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing proc_CT_Coaching_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_Coaching_AddUpdatedRecs' )
    BEGIN
        DROP PROCEDURE
             proc_CT_Coaching_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_Coaching_AddUpdatedRecs
AS
BEGIN

    UPDATE S
      SET
          S.UserGUID = T.UserGUID
          ,S.SiteGUID = T.SiteGUID
          ,S.AccountID = T.AccountID
          ,S.AccountCD = T.AccountCD
          ,S.CoachID = T.CoachID
          ,S.LastName = T.LastName
          ,S.FirstName = T.FirstName
          ,S.StartDate = T.StartDate
          ,S.Phone = T.Phone
          ,S.email = T.email
          ,S.Supervisor = T.Supervisor
          ,S.SuperCoach = T.SuperCoach
          ,S.MaxParticipants = T.MaxParticipants
          ,S.Inactive = T.Inactive
          ,S.MaxRiskLevel = T.MaxRiskLevel
          ,S.Locked = T.Locked
          ,S.TimeLocked = T.TimeLocked
          ,S.terminated = T.terminated
          ,S.APMaxParticipants = T.APMaxParticipants
          ,S.RNMaxParticipants = T.RNMaxParticipants
          ,S.RNPMaxParticipants = T.RNPMaxParticipants
          ,S.Change_Type = T.Change_Type
          ,S.Last_Update_Dt = T.Last_Update_Dt
          ,S.HashCode = T.HashCode
          ,S.LastModifiedDate = GETDATE ( )
          ,S.DeletedFlg = NULL
          ,S.ConvertedToCentralTime = NULL
      FROM DIM_EDW_Coaches AS S JOIN
                ##DIM_TEMPTBL_EDW_Coaches_DATA AS T
                                    ON
           S.UserGUID = T.UserGUID
       AND ISNULL( S.SiteGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.SiteGUID , '00000000-0000-0000-0000-000000000000' )
       AND ISNULL( S.AccountID , '' ) = ISNULL( T.AccountID , '' )
       AND ISNULL( S.AccountCD , '' ) = ISNULL( T.AccountCD , '' )
       AND ISNULL( S.CoachID , -1 ) = ISNULL( T.CoachID , -1 )
       AND S.email = T.email
      WHERE
           T.HashCode != S.HashCode
       AND S.DeletedFlg IS NULL;

    DECLARE
       @iUpdates AS int = @@ROWCOUNT;
    PRINT 'Updated Count: ' + CAST ( @iUpdates AS nvarchar( 50 ));
    RETURN @iUpdates;
END;

GO
PRINT 'Executed proc_CT_Coaching_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_Coaching_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_Coaching_AddDeletedRecs' )
    BEGIN
        DROP PROCEDURE
             proc_CT_Coaching_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_Coaching_AddDeletedRecs
AS
BEGIN

    WITH CTE (
         UserGUID
         ,SiteGUID
         ,AccountID
         ,AccountCD
         ,CoachID
         ,email )
        AS (
        SELECT
               UserGUID
               ,isnull(SiteGUID,'00000000-0000-0000-0000-000000000000') 
               ,isnull(AccountID,' ')
               ,isnull(AccountCD, ' ' )
               ,isnull(CoachID,-1)
               ,email
          FROM DIM_EDW_Coaches
        EXCEPT
        SELECT
               UserGUID
               ,isnull(SiteGUID,'00000000-0000-0000-0000-000000000000') 
               ,isnull(AccountID,' ')
               ,isnull(AccountCD, ' ' )
               ,isnull(CoachID,-1)
               ,email
          FROM ##DIM_TEMPTBL_EDW_Coaches_DATA
        )
        UPDATE S
          SET
              S.DeletedFlg = 1
          FROM CTE AS T JOIN
                    DIM_EDW_Coaches AS S
                        ON
               S.UserGUID = T.UserGUID
           AND ISNULL( S.SiteGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.SiteGUID , '00000000-0000-0000-0000-000000000000' )
           AND ISNULL( S.AccountID , '' ) = ISNULL( T.AccountID , '' )
           AND ISNULL( S.AccountCD , '' ) = ISNULL( T.AccountCD , '' )
           AND ISNULL( S.CoachID , -1 ) = ISNULL( T.CoachID , -1 )
           AND S.email = T.email;

    DECLARE
       @idels AS int = @@ROWCOUNT;
    PRINT 'Deleted Count: ' + CAST ( @idels  AS nvarchar( 50 ));
    RETURN @idels;
END;

GO
PRINT 'Executed proc_CT_Coaching_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO

PRINT 'Execute proc_CT_EDW_CoachingDetail_NoDups.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_EDW_CoachingDetail_NoDups') 
    BEGIN
        DROP PROCEDURE
             proc_CT_EDW_CoachingDetail_NoDups
    END;
GO

-- exec proc_CT_EDW_CoachingDetail_NoDups

CREATE PROCEDURE proc_CT_EDW_CoachingDetail_NoDups
AS
BEGIN

/*------------------------
 Delete Duplicate records 
*/
    WITH CTE (
         ItemID
       , ItemGUID
       , GoalID
       , UserGUID
       , SiteGUID
       , AccountID
       , AccountCD
       , WeekendDate
       , NodeGUID, DuplicateCount) 
        AS (   SELECT
                      ItemID
                    , ItemGUID
                    , GoalID
                    , UserGUID
                    , SiteGUID
                    , AccountID
                    , AccountCD
                    , WeekendDate
                    , NodeGUID
                    , ROW_NUMBER () OVER (PARTITION BY   ItemID
                                                       , ItemGUID
                                                       , GoalID
                                                       , UserGUID
                                                       , SiteGUID
                                                       , AccountID
                                                       , AccountCD
                                                       , WeekendDate
                                                       , NodeGUID
                      ORDER BY   ItemID
                      , ItemGUID
                      , GoalID
                      , UserGUID
                      , SiteGUID
                      , AccountID
                      , AccountCD
                      , WeekendDate
                      , NodeGUID) AS DuplicateCount
                      FROM DIM_EDW_CoachingDetail
        ) 
        DELETE
        FROM CTE
               WHERE
                     DuplicateCount > 1;
END;
GO
PRINT 'Executed proc_CT_EDW_CoachingDetail_NoDups.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_CoachingDetail_AddUpdatedRecs.sql';
GO
-- exec proc_CT_CoachingDetail_AddUpdatedRecs
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_CoachingDetail_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_CoachingDetail_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_CoachingDetail_AddUpdatedRecs
AS
BEGIN

    UPDATE S
      SET
          S.ItemID = T.ItemID
        ,S.ItemGUID = T.ItemGUID
        ,S.GoalID = T.GoalID
        ,S.UserID = T.UserID
        ,S.UserGUID = T.UserGUID
        ,S.HFitUserMpiNumber = T.HFitUserMpiNumber
        ,S.SiteGUID = T.SiteGUID
        ,S.AccountID = T.AccountID
        ,S.AccountCD = T.AccountCD
        ,S.AccountName = T.AccountName
        ,S.IsCreatedByCoach = T.IsCreatedByCoach
        ,S.BaselineAmount = T.BaselineAmount
        ,S.GoalAmount = T.GoalAmount
        ,S.DocumentID = T.DocumentID
        ,S.GoalStatusLKPID = T.GoalStatusLKPID
        ,S.GoalStatusLKPName = T.GoalStatusLKPName
        ,S.EvaluationStartDate = T.EvaluationStartDate
        ,S.EvaluationEndDate = T.EvaluationEndDate
        ,S.GoalStartDate = T.GoalStartDate
        ,S.CoachDescription = T.CoachDescription
        ,S.EvaluationDate = T.EvaluationDate
        ,S.Passed = T.Passed
        ,S.WeekendDate = T.WeekendDate
        ,S.ChangeType = T.ChangeType
        ,S.ItemCreatedWhen = T.ItemCreatedWhen
        ,S.ItemModifiedWhen = T.ItemModifiedWhen
        ,S.NodeGUID = T.NodeGUID
        ,S.CloseReasonLKPID = T.CloseReasonLKPID
        ,S.CloseReason = T.CloseReason
        ,S.HashCode = T.HashCode
        ,S.RowNbr = NULL
        ,S.TimeZone = NULL
        ,S.LastModifiedDate = GETDATE () 
        ,S.DeletedFlg = NULL
        ,S.ConvertedToCentralTime = NULL
          FROM DIM_EDW_CoachingDetail AS S
                    JOIN ##TEMP_EDW_CoachingDetail_DATA AS T
                    ON
                    S.ItemGUID = T.ItemGUID AND
                    S.GoalID = T.GoalID AND
                    S.UserGUID = T.UserGUID AND
                    S.SiteGUID = T.SiteGUID AND
                    S.AccountID = T.AccountID AND
                    S.AccountCD = T.AccountCD AND
                    S.WeekendDate = T.WeekendDate AND
                    S.NodeGUID = T.NodeGUID

           WHERE
                 T.HashCode != S.HashCode AND
                 T.LastModifiedDate IS NULL;

    DECLARE
    @iCnt AS int = @@ROWCOUNT;
    PRINT 'Updated Count: ' + CAST ( @iCnt AS nvarchar (50)) ;
    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CT_CoachingDetail_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_CoachingDetail_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_CoachingDetail_AddDeletedRecs' )
    BEGIN
        DROP PROCEDURE
             proc_CT_CoachingDetail_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_CoachingDetail_AddDeletedRecs
AS
BEGIN
    WITH CTE (
         ItemGUID
         ,GoalID
         ,UserGUID
         ,SiteGUID
         ,AccountID
         ,AccountCD
         ,WeekendDate
         ,NodeGUID )
        AS ( SELECT
                    ISNULL( ItemGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( GoalID , -1 )
                    ,ISNULL( UserGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( SiteGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( AccountID , ' ' )
                    ,ISNULL( AccountCD , ' ' )
                    ,ISNULL( WeekendDate , '01/01/1900' )
                    ,ISNULL( NodeGUID , '00000000-0000-0000-0000-000000000000' )
               FROM DIM_EDW_CoachingDetail
               WHERE DeletedFlg IS NULL -- and HFitUserMpiNumber > 0  
             EXCEPT
             SELECT
                    ISNULL( ItemGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( GoalID , -1 )
                    ,ISNULL( UserGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( SiteGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( AccountID , ' ' )
                    ,ISNULL( AccountCD , ' ' )
                    ,ISNULL( WeekendDate , '01/01/1900' )
                    ,ISNULL( NodeGUID , '00000000-0000-0000-0000-000000000000' )
               FROM ##TEMP_EDW_CoachingDetail_DATA )
        UPDATE S
          SET
              S.DeletedFlg = 1
          FROM CTE AS T JOIN
                    DIM_EDW_CoachingDetail AS S
                        ON
               ISNULL( S.ItemGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.ItemGUID , '00000000-0000-0000-0000-000000000000' )
           AND ISNULL( S.GoalID , -1 ) = ISNULL( T.GoalID , -1 )
           AND ISNULL( S.UserGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.UserGUID , '00000000-0000-0000-0000-000000000000' )
           AND ISNULL( S.SiteGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.SiteGUID , '00000000-0000-0000-0000-000000000000' )
           AND ISNULL( S.AccountID , ' ' ) = ISNULL( T.AccountID , ' ' )
           AND ISNULL( S.AccountCD , ' ' ) = ISNULL( T.AccountCD , ' ' )
           AND ISNULL( S.WeekendDate , '01/01/1900' ) = ISNULL( T.WeekendDate , '01/01/1900' )
           AND ISNULL( S.NodeGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.NodeGUID , '00000000-0000-0000-0000-000000000000' );

    DECLARE
       @iCnt AS int = @@ROWCOUNT;
    PRINT 'Updated Count: ' + CAST ( @iCnt AS nvarchar( 50 ));
    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CT_CoachingDetail_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_CoachingDetail_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_CoachingDetail_AddNewRecs' )
    BEGIN
        DROP PROCEDURE
             proc_CT_CoachingDetail_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_CoachingDetail_AddNewRecs
AS
BEGIN

    WITH CTE (
         ItemGUID
         ,GoalID
         ,UserGUID
         ,SiteGUID
         ,AccountID
         ,AccountCD
         ,WeekendDate
         ,NodeGUID )
        AS ( SELECT
                    ISNULL( ItemGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( GoalID , -1 )
                    ,ISNULL( UserGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( SiteGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( AccountID , ' ' )
                    ,ISNULL( AccountCD , ' ' )
                    ,ISNULL( WeekendDate , '01/01/1900' )
                    ,ISNULL( NodeGUID , '00000000-0000-0000-0000-000000000000' )
               FROM ##TEMP_EDW_CoachingDetail_DATA
             EXCEPT
             SELECT
                    ISNULL( ItemGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( GoalID , -1 )
                    ,ISNULL( UserGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( SiteGUID , '00000000-0000-0000-0000-000000000000' )
                    ,ISNULL( AccountID , ' ' )
                    ,ISNULL( AccountCD , ' ' )
                    ,ISNULL( WeekendDate , '01/01/1900' )
                    ,ISNULL( NodeGUID , '00000000-0000-0000-0000-000000000000' )
               FROM DIM_EDW_CoachingDetail
               WHERE LastModifiedDate IS NULL )
        INSERT INTO dbo.DIM_EDW_CoachingDetail (
               ItemID
               ,ItemGUID
               ,GoalID
               ,UserID
               ,UserGUID
               ,HFitUserMpiNumber
               ,SiteGUID
               ,AccountID
               ,AccountCD
               ,AccountName
               ,IsCreatedByCoach
               ,BaselineAmount
               ,GoalAmount
               ,DocumentID
               ,GoalStatusLKPID
               ,GoalStatusLKPName
               ,EvaluationStartDate
               ,EvaluationEndDate
               ,GoalStartDate
               ,CoachDescription
               ,EvaluationDate
               ,Passed
               ,WeekendDate
               ,ChangeType
               ,ItemCreatedWhen
               ,ItemModifiedWhen
               ,NodeGUID
               ,CloseReasonLKPID
               ,CloseReason
               ,HashCode
               ,LastModifiedDate
               ,DeletedFlg )
        SELECT
               T.ItemID
               ,T.ItemGUID
               ,T.GoalID
               ,T.UserID
               ,T.UserGUID
               ,T.HFitUserMpiNumber
               ,T.SiteGUID
               ,T.AccountID
               ,T.AccountCD
               ,T.AccountName
               ,T.IsCreatedByCoach
               ,T.BaselineAmount
               ,T.GoalAmount
               ,T.DocumentID
               ,T.GoalStatusLKPID
               ,T.GoalStatusLKPName
               ,T.EvaluationStartDate
               ,T.EvaluationEndDate
               ,T.GoalStartDate
               ,T.CoachDescription
               ,T.EvaluationDate
               ,T.Passed
               ,T.WeekendDate
               ,T.ChangeType
               ,T.ItemCreatedWhen
               ,T.ItemModifiedWhen
               ,T.NodeGUID
               ,T.CloseReasonLKPID
               ,T.CloseReason
               ,T.HashCode
               ,NULL AS LastModifiedDate
               ,NULL AS DeletedFlg
          FROM
               ##TEMP_EDW_CoachingDetail_DATA AS T JOIN
                    CTE AS S
                                                           ON
               ISNULL( S.ItemGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.ItemGUID , '00000000-0000-0000-0000-000000000000' )
           AND ISNULL( S.GoalID , -1 ) = ISNULL( T.GoalID , -1 )
           AND ISNULL( S.UserGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.UserGUID , '00000000-0000-0000-0000-000000000000' )
           AND ISNULL( S.SiteGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.SiteGUID , '00000000-0000-0000-0000-000000000000' )
           AND ISNULL( S.AccountID , ' ' ) = ISNULL( T.AccountID , ' ' )
           AND ISNULL( S.AccountCD , ' ' ) = ISNULL( T.AccountCD , ' ' )
           AND ISNULL( S.WeekendDate , '01/01/1900' ) = ISNULL( T.WeekendDate , '01/01/1900' )
           AND ISNULL( S.NodeGUID , '00000000-0000-0000-0000-000000000000' ) = ISNULL( T.NodeGUID , '00000000-0000-0000-0000-000000000000' );

    DECLARE
       @iInserts AS int = @@ROWCOUNT;
    PRINT 'Insert Count: ' + CAST ( @iInserts AS nvarchar( 50 ));
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_CoachingDetail_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_CoachingDefinition_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_CoachingDefinition_AddUpdatedRecs' )
    BEGIN
        DROP PROCEDURE
             proc_CT_CoachingDefinition_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_CoachingDefinition_AddUpdatedRecs
AS
BEGIN
    UPDATE S
      SET
          S.GoalID = T.GoalID
          ,S.DocumentGuid = T.DocumentGuid
          ,S.NodeSiteID = T.NodeSiteID
          ,S.SiteGUID = T.SiteGUID
          ,S.GoalImage = T.GoalImage
          ,S.Goal = T.Goal
          ,S.GoalText = T.GoalText
          ,S.GoalSummary = T.GoalSummary
          ,S.TrackerAssociation = T.TrackerAssociation
          ,S.GoalFrequency = T.GoalFrequency
          ,S.FrequencySingular = T.FrequencySingular
          ,S.FrequencyPlural = T.FrequencyPlural
          ,S.GoalUnitOfMeasure = T.GoalUnitOfMeasure
          ,S.UnitOfMeasure = T.UnitOfMeasure
          ,S.GoalDirection = T.GoalDirection
          ,S.GoalPrecision = T.GoalPrecision
          ,S.GoalAbsoluteMin = T.GoalAbsoluteMin
          ,S.GoalAbsoluteMax = T.GoalAbsoluteMax
          ,S.SetGoalText = T.SetGoalText
          ,S.HelpText = T.HelpText
          ,S.EvaluationType = T.EvaluationType
          ,S.CatalogDisplay = T.CatalogDisplay
          ,S.AllowModification = T.AllowModification
          ,S.ActivityText = T.ActivityText
          ,S.SetgoalModifyText = T.SetgoalModifyText
          ,S.IsLifestyleGoal = T.IsLifestyleGoal
          ,S.CodeName = T.CodeName
          ,S.ChangeType = 'U'
          ,S.DocumentCreatedWhen = T.DocumentCreatedWhen
          ,S.DocumentModifiedWhen = T.DocumentModifiedWhen
          ,S.DocumentCulture = T.DocumentCulture
          ,S.HashCode = T.HashCode
          ,S.LastModifiedDate = GETDATE( )
          ,S.DeletedFlg = NULL
      FROM
      STAGING_EDW_CoachingDefinition AS S JOIN
           ##TEMP_STAGING_EDW_CoachingDefinition_DATA AS T
                                          ON
           S.GoalID = T.GoalID
       AND S.DocumentGuid = T.DocumentGuid
       AND S.NodeSiteID = T.NodeSiteID
       AND S.SiteGUID = T.SiteGUID
       AND S.HashCode != T.HashCode
       AND S.DeletedFlg IS NULL;

    DECLARE
       @iCnt AS int = @@ROWCOUNT;
    PRINT 'Updated Count: ' + CAST ( @iCnt AS nvarchar( 50 ));
    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CT_CoachingDefinition_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'EXecuting proc_CkParticipantHasChanged.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CkParticipantHasChanged' )
    BEGIN
        DROP PROCEDURE
             proc_CkParticipantHasChanged
    END;

GO
--exec [proc_CkParticipantHasChanged]
CREATE PROCEDURE proc_CkParticipantHasChanged
AS
BEGIN
/*
Author:	  W. Dale Miller
RETURNS:	  Integer -   0 = no changes
				    1 = updates or inserts, no deletes
				    2 = DELETES and possibly updates or inserts
*/
    DECLARE
       @b AS int = 0,
       @dels AS int = 0,
       @ins AS int = 0,
       @updt AS int = 0;

    DECLARE
       @TempParticipant AS TABLE
       (
                                SYS_CHANGE_OPERATION nvarchar( 10 )
       );

    INSERT INTO @TempParticipant
    (
           SYS_CHANGE_OPERATION
    )
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_User , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_UserSite , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_Site , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES HFit_Account , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_UserSettings , NULL )AS CT
    UNION ALL
    SELECT
           SYS_CHANGE_OPERATION
      FROM CHANGETABLE( CHANGES CMS_UserSettings , NULL )AS CT ;

    SET @b = ( SELECT
                      COUNT( * )
                 FROM @TempParticipant );
    PRINT 'Number of changes found: ' + CAST( @b AS nvarchar( 50 ));


    IF @b > 0
        BEGIN

            SET @dels = ( SELECT
                                 COUNT( * )
                            FROM @TempParticipant
                            WHERE SYS_CHANGE_OPERATION = 'D' );
            SET @ins = ( SELECT
                                COUNT( * )
                           FROM @TempParticipant
                           WHERE SYS_CHANGE_OPERATION = 'I' );
            SET @updt = ( SELECT
                                 COUNT( * )
                            FROM @TempParticipant
                            WHERE SYS_CHANGE_OPERATION = 'U' );

            PRINT 'Number of inserts: ' + CAST( @ins AS nvarchar( 50 ));
            PRINT 'Number of updates: ' + CAST( @updt AS nvarchar( 50 ));
            PRINT 'Number of deletes: ' + CAST( @dels AS nvarchar( 50 ));

            IF @dels > 0
                BEGIN
                    SET @b = 2 ;
                END
            ELSE
                BEGIN
                    SET @b = 1;
                END;
        END;
    print 'Returned Value: ' + cast(@b as nvarchar(50)) ;
    RETURN @b;

END;

GO
PRINT 'EXecuted proc_CkParticipantHasChanged.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO

PRINT 'Execute proc_CT_EDW_SmallSteps_NoDups.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_EDW_SmallSteps_NoDups' )
    BEGIN
        DROP PROCEDURE
             proc_CT_EDW_SmallSteps_NoDups;
    END;
GO

/*
exec proc_CT_EDW_SmallSteps_NoDups
delete from DIM_EDW_SmallSteps where userID < 0 or userID is null
select count(*), HFitUserMPINumber, HashCode from DIM_EDW_SmallSteps group by HFitUserMPINumber, HashCode having count(*) > 1
select * from DIM_EDW_SmallSteps where HFitUserMPINumber = 9336928 and  HashCode = 0x2136D91AC7B41EC83EE3AB2F79E87A65FD815C6D
*/

CREATE PROCEDURE proc_CT_EDW_SmallSteps_NoDups
AS
BEGIN

    /* Delete Duplicate records */
    WITH CTE (
         HFitUserMPINumber ,
         HashCode ,
         DuplicateCount )
        AS ( SELECT HFitUserMPINumber ,HashCode
                    ,ROW_NUMBER( ) OVER( PARTITION BY  HFitUserMPINumber ,
                                                       HashCode
                    ORDER BY   HFitUserMPINumber , HashCode
                    ) AS DuplicateCount
               FROM DIM_EDW_SmallSteps
               WHERE DeletedFlg IS NULL
        )
        DELETE
        FROM CTE
          WHERE
                DuplicateCount > 1;
	   declare @i as int = @@ROWCOUNT ;
	   print 'Duplicates found and removed: ' + cast(@i as nvarchar(50)) ;
END;
GO
PRINT 'Executed proc_CT_EDW_SmallSteps_NoDups.sql';
GO

GO

PRINT 'Execute proc_CT_EDW_SmallSteps_Temp_NoDups.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_EDW_SmallSteps_Temp_NoDups' )
    BEGIN
        DROP PROCEDURE
             proc_CT_EDW_SmallSteps_Temp_NoDups;
    END;
GO

/*
exec proc_CT_EDW_SmallSteps_Temp_NoDups
delete from DIM_EDW_SmallSteps where userID < 0 or userID is null
select count(*), HFitUserMPINumber, HashCode from DIM_EDW_SmallSteps group by HFitUserMPINumber, HashCode having count(*) > 1
select * from DIM_EDW_SmallSteps where HFitUserMPINumber = 9336928 and  HashCode = 0x2136D91AC7B41EC83EE3AB2F79E87A65FD815C6D
*/

CREATE PROCEDURE proc_CT_EDW_SmallSteps_Temp_NoDups
AS
BEGIN

    /* Delete Duplicate records */
    IF OBJECT_ID('tempdb..##Temp_SmallSteps') IS NOT NULL 
            BEGIN
                return ;
            END;

    WITH CTE (
         HFitUserMPINumber ,
         HashCode ,
         DuplicateCount )
        AS ( SELECT
                    HFitUserMPINumber ,
                    HashCode
                    ,ROW_NUMBER( ) OVER( PARTITION BY  HFitUserMPINumber ,
                                                       HashCode
                    ORDER BY   HFitUserMPINumber , HashCode
                    ) AS DuplicateCount
               FROM ##Temp_SmallSteps
        )
        DELETE
        FROM CTE
          WHERE
                DuplicateCount > 1;
END;
GO
PRINT 'Executed proc_CT_EDW_SmallSteps_Temp_NoDups.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing proc_CT_SmallSteps_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CT_SmallSteps_AddDeletedRecs' )
    BEGIN
        DROP PROCEDURE
             proc_CT_SmallSteps_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_SmallSteps_AddDeletedRecs
AS
BEGIN

    WITH CTE (
         HFitUserMPINumber ,
         HashCode )
        AS ( SELECT
                    HFitUserMPINumber ,
                    HashCode
               FROM DIM_EDW_SmallSteps
             EXCEPT
             SELECT
                    HFitUserMPINumber ,
                    HashCode
               FROM ##Temp_SmallSteps )
        UPDATE S
          SET
              S.DeletedFlg = 1 ,
              LastModifiedDate = GETDATE( )
          FROM CTE AS T JOIN
                    DIM_EDW_SmallSteps AS S
                        ON
               S.HFitUserMPINumber = T.HFitUserMPINumber
           AND S.DeletedFlg IS NULL
           AND S.HashCode = T.HashCode;

    DECLARE
       @iCnt AS int = @@ROWCOUNT;
    PRINT 'Deleted Count: ' + CAST ( @iCnt AS nvarchar( 50 ));
    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CT_SmallSteps_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go 
print 'Executing proc_CT_SmallSteps_AddUpdatedRecs.SQL'
go
if exists (select name from sys.procedures where name = 'proc_CT_SmallSteps_AddUpdatedRecs')    
    drop procedure proc_CT_SmallSteps_AddUpdatedRecs;
go

create procedure proc_CT_SmallSteps_AddUpdatedRecs
AS
DECLARE
		  @RUNDATE AS datetime2 ( 7 ) = GETDATE ( );

        UPDATE S
          SET
              S.UserID = T.UserID
              ,S.AccountCD = T.AccountCD
              ,S.SiteGUID = T.SiteGUID
              ,S.SSItemID = T.SSItemID
              ,S.SSItemCreatedBy = T.SSItemCreatedBy
              ,S.SSItemCreatedWhen = T.SSItemCreatedWhen
              ,S.SSItemModifiedBy = T.SSItemModifiedBy
              ,S.SSItemModifiedWhen = T.SSItemModifiedWhen
              ,S.SSItemOrder = T.SSItemOrder
              ,S.SSItemGUID = T.SSItemGUID
              ,S.SSHealthAssesmentUserStartedItemID = T.SSHealthAssesmentUserStartedItemID
              ,S.SSOutcomeMessageGuid = T.SSOutcomeMessageGuid
              ,S.SSOutcomeMessage = T.SSOutcomeMessage
              ,S.HACampaignNodeGUID = T.HACampaignNodeGUID
              ,S.HACampaignName = T.HACampaignName
              ,S.HACampaignStartDate = T.HACampaignStartDate
              ,S.HACampaignEndDate = T.HACampaignEndDate
              ,S.HAStartedDate = T.HAStartedDate
              ,S.HACompletedDate = T.HACompletedDate
              ,S.HAStartedMode = T.HAStartedMode
              ,S.HACompletedMode = T.HACompletedMode
              ,S.HaCodeName = T.HaCodeName
              ,S.HFitUserMPINumber = T.HFitUserMPINumber
              ,S.HashCode = T.HashCode
              ,S.ChangeType = 'U'
              ,S.LastModifiedDate = GETDATE ( )
              ,S.DeletedFlg = NULL
              ,S.ConvertedToCentralTime = NULL
          FROM ##Temp_SmallSteps AS T JOIN
                    DIM_EDW_SmallSteps AS S
                                    ON
                   S.AccountCD = T.AccountCD
               AND S.SiteGUID = T.SiteGUID
               AND S.SSItemID = T.SSItemID
               AND S.SSItemGUID = T.SSItemGUID
               AND S.SSHealthAssesmentUserStartedItemID = T.SSHealthAssesmentUserStartedItemID
               AND S.SSOutcomeMessageGuid = T.SSOutcomeMessageGuid
               AND S.HFitUserMPINumber = T.HFitUserMPINumber
               AND S.HACampaignNodeGUID = T.HACampaignNodeGUID
               AND S.HAStartedMode = T.HAStartedMode
               AND S.HACompletedMode = T.HACompletedMode
               AND S.HaCodeName = T.HaCodeName
               AND S.HACampaignStartDate = t.HACampaignStartDate
               AND S.HACampaignEndDate = t.HACampaignEndDate
           AND S.HASHCODE != T.HASHCODE
           AND S.DeletedFlg IS NULL;
        DECLARE
           @iUpdated AS int = + @@ROWCOUNT;
    RETURN @iUpdated  ;
go 
print 'Executed proc_CT_SmallSteps_AddUpdatedRecs.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go 
print 'Executing proc_CT_SmallSteps_AddNewRecs.SQL'
go

if exists (select name from sys.procedures where name = 'proc_CT_SmallSteps_AddNewRecs')    
    drop procedure proc_CT_SmallSteps_AddNewRecs;
go
--exec proc_CT_SmallSteps_AddNewRecs
create procedure proc_CT_SmallSteps_AddNewRecs
as
WITH CTE_NEW (HFitUserMPINumber, HashCode )
            AS ( SELECT
                        HFitUserMPINumber, HashCode
                   FROM ##Temp_SmallSteps
                 EXCEPT
                 SELECT
                        HFitUserMPINumber, HashCode
                   FROM dbo.DIM_EDW_SmallSteps
                   WHERE DeletedFlg is null )
            INSERT INTO DIM_EDW_SmallSteps
            (
                   UserID
                   ,AccountCD
                   ,SiteGUID
                   ,SSItemID
                   ,SSItemCreatedBy
                   ,SSItemCreatedWhen
                   ,SSItemModifiedBy
                   ,SSItemModifiedWhen
                   ,SSItemOrder
                   ,SSItemGUID
                   ,SSHealthAssesmentUserStartedItemID
                   ,SSOutcomeMessageGuid
                   ,SSOutcomeMessage
                   ,HACampaignNodeGUID
                   ,HACampaignName
                   ,HACampaignStartDate
                   ,HACampaignEndDate
                   ,HAStartedDate
                   ,HACompletedDate
                   ,HAStartedMode
                   ,HACompletedMode
                   ,HaCodeName
                   ,HFitUserMPINumber
                   ,DeletedFlg
                   ,LastModifiedDate
                   ,HashCode
                   ,ChangeType
                   ,CT_UserSettingsID
                   ,CT_CMS_UserSettings_SCV
                   ,SiteID_CtID
                   ,SiteID_CHANGE_OPERATION
                   ,SITE_SCV
                   ,Campaign_CtID
                   ,Campaign_SCV
                   ,HealthAssesmentUserStarted_CtID
                   ,HealthAssesmentUserStarted_SCV
                   ,OutComeMessages_CtID
                   ,OutComeMessages_SCV
                   ,HFit_Account_CtID
                   ,HFit_Account_SCV
                   ,ToDoSmallSteps_CtID
                   ,ToDoSmallSteps_SCV
                   ,CT_UserSettings_CHANGE_OPERATION
                   ,Campaign_CHANGE_OPERATION
                   ,HealthAssesmentUserStarted_CHANGE_OPERATION
                   ,OutComeMessages_CHANGE_OPERATION
                   ,HFit_Account_CHANGE_OPERATION
                   ,ToDoSmallSteps_CHANGE_OPERATION
                   ,SmallStepResponses_CtID
                   ,SmallStepResponses_SCV
                   ,SmallStepResponses_CHANGE_OPERATION
                   --,RowNbr
                   ,TimeZone
                   ,ConvertedToCentralTime )
            SELECT
                   T.UserID
                   ,T.AccountCD
                   ,T.SiteGUID
                   ,T.SSItemID
                   ,T.SSItemCreatedBy
                   ,T.SSItemCreatedWhen
                   ,T.SSItemModifiedBy
                   ,T.SSItemModifiedWhen
                   ,T.SSItemOrder
                   ,T.SSItemGUID
                   ,T.SSHealthAssesmentUserStartedItemID
                   ,T.SSOutcomeMessageGuid
                   ,T.SSOutcomeMessage
                   ,T.HACampaignNodeGUID
                   ,T.HACampaignName
                   ,T.HACampaignStartDate
                   ,T.HACampaignEndDate
                   ,T.HAStartedDate
                   ,T.HACompletedDate
                   ,T.HAStartedMode
                   ,T.HACompletedMode
                   ,T.HaCodeName
                   ,T.HFitUserMPINumber
                   ,null AS DeletedFlg
                   ,null as LastModifiedDate
                   ,T.HashCode
                   ,T.ChangeType
                   ,T.CT_UserSettingsID
                   ,T.CT_CMS_UserSettings_SCV
                   ,T.SiteID_CtID
                   ,T.SiteID_CHANGE_OPERATION
                   ,T.SITE_SCV
                   ,T.Campaign_CtID
                   ,T.Campaign_SCV
                   ,T.HealthAssesmentUserStarted_CtID
                   ,T.HealthAssesmentUserStarted_SCV
                   ,T.OutComeMessages_CtID
                   ,T.OutComeMessages_SCV
                   ,T.HFit_Account_CtID
                   ,T.HFit_Account_SCV
                   ,T.ToDoSmallSteps_CtID
                   ,T.ToDoSmallSteps_SCV
                   ,T.CT_UserSettings_CHANGE_OPERATION
                   ,T.Campaign_CHANGE_OPERATION
                   ,T.HealthAssesmentUserStarted_CHANGE_OPERATION
                   ,T.OutComeMessages_CHANGE_OPERATION
                   ,T.HFit_Account_CHANGE_OPERATION
                   ,T.ToDoSmallSteps_CHANGE_OPERATION
                   ,T.SmallStepResponses_CtID
                   ,T.SmallStepResponses_SCV
                   ,T.SmallStepResponses_CHANGE_OPERATION
                   --,NULL AS RowNbr
                   ,NULL AS TimeZone
                   ,NULL AS ConvertedToCentralTime
              FROM
                   ##Temp_SmallSteps AS T JOIN
                        CTE_NEW AS C
                                        ON
				T.HFitUserMPINumber = C.HFitUserMPINumber
				AND T.HashCode = C.HashCode;

        DECLARE
           @iInserted AS int = @@ROWCOUNT;
	   PRINT 'Records Added: ' + CAST ( @iInserted AS nvarchar( 5 ));
	   return @iInserted ;
go 
print 'Executed proc_CT_SmallSteps_AddNewRecs.SQL'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating proc_CkTrackerDataChanged';
PRINT 'FROM proc_CkTrackerDataChanged.sql';

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CkTrackerDataChanged' )
    BEGIN
        DROP PROCEDURE
             proc_CkTrackerDataChanged;
    END;
GO

-- exec proc_CkTrackerDataChanged

CREATE PROC proc_CkTrackerDataChanged
AS
BEGIN
    set nocount on ;
    IF OBJECT_ID('tempdb..##TempCompositeData') IS NOT NULL DROP TABLE ##TempCompositeData ;
    CREATE TABLE ##TempCompositeData(
                 TGTTBL varchar( 50 ) NOT NULL ,
                 SYS_CHANGE_VERSION bigint NULL ,
                 SYS_CHANGE_CREATION_VERSION bigint NULL ,
                 SYS_CHANGE_OPERATION nvarchar( 10 ) NULL ,
                 SYS_CHANGE_COLUMNS varbinary( max ) NULL ,
                 SYS_CHANGE_CONTEXT varbinary( max ) NULL ,
                 ItemID int NOT NULL
    );
   /****** Object:  Index [PI_Staging_EDW_Participant_IDs]    Script Date: 7/1/2015 9:02:43 AM ******/
    CREATE CLUSTERED INDEX [PK_TempCompositeData] ON ##TempCompositeData
    (
	    TGTTBL ASC,
	    ItemID ASC
    )
    DECLARE
       @b AS bit = 0;

    INSERT INTO ##TempCompositeData
    SELECT
           'CMS_Site' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES CMS_Class , NULL )AS CT;
    INSERT INTO ##TempCompositeData
    SELECT
           'CMS_User' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES CMS_User , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_Account' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_Account , NULL )AS CT;

    INSERT INTO ##TempCompositeData 
SELECT
           'HFit_LKP_TrackerVendor' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_LKP_TrackerVendor, NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'hfit_ppteligibility' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES hfit_ppteligibility , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFIT_Tracker' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFIT_Tracker , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerBloodPressure' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerBloodPressure , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerBloodSugarAndGlucose' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerBloodSugarAndGlucose , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerBMI' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerBMI , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerBodyFat' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerBodyFat , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerBodyMeasurements' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerBodyMeasurements , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerCardio' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerCardio , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerCholesterol' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerCholesterol , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerCollectionSource' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerCollectionSource , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerCotinine' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerCotinine , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerDailySteps' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerDailySteps , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerDef_Tracker' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerDef_Tracker , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerFlexibility' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerFlexibility , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerFruits' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerFruits , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerHbA1c' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerHbA1c , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerHeight' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerHeight , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerHighFatFoods' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerHighFatFoods , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerHighSodiumFoods' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerHighSodiumFoods , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerInstance_Tracker' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerInstance_Tracker , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerMealPortions' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerMealPortions , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerMedicalCarePlan' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerMedicalCarePlan , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerPreventiveCare' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerPreventiveCare , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerRegularMeals' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerRegularMeals , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerRestingHeartRate' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerRestingHeartRate , NULL )AS CT;
    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerShots' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerShots , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerSitLess' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerSitLess , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerSleepPlan' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerSleepPlan , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerStrength' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerStrength , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerStress' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerStress , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerStressManagement' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerStressManagement , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerSugaryDrinks' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerSugaryDrinks , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerSugaryFoods' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerSugaryFoods , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerTests' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerTests , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerTobaccoAttestation' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerTobaccoAttestation , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerTobaccoFree' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerTobaccoFree , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerVegetables' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerVegetables , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerWater' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerWater , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerWeight' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerWeight , NULL )AS CT;

    INSERT INTO ##TempCompositeData
    SELECT
           'HFit_TrackerWholeGrains' as TGTTBL ,
           *
      FROM CHANGETABLE( CHANGES HFit_TrackerWholeGrains , NULL )AS CT;

--select * from ##TempCompositeData ;

    DECLARE
       @NbrUpdates AS int = (select count(*) from ##TempCompositeData);
    DECLARE
       @iInsert AS int = 0;
    DECLARE
       @iUpdate AS int = 0;
    DECLARE
       @iDel AS int = 0;

    IF @NbrUpdates = 0
        BEGIN
            PRINT 'No changes found';
            SET @b = 0;
        END;
    ELSE
        BEGIN
            SET @iInsert = ( SELECT
                                    COUNT ( * )
                               FROM ##TempCompositeData
                               WHERE SYS_CHANGE_OPERATION = 'I' );
            SET @iUpdate = ( SELECT
                                    COUNT ( * )
                               FROM ##TempCompositeData
                               WHERE SYS_CHANGE_OPERATION = 'U' );
            SET @iDel = ( SELECT
                                 COUNT ( * )
                            FROM ##TempCompositeData
                            WHERE SYS_CHANGE_OPERATION = 'D' );
            PRINT CAST ( @NbrUpdates AS nvarchar ( 50 )) + ' Changes found: proc_CkTrackerDataChanged';
            PRINT CAST ( @iInsert AS nvarchar ( 50 )) + ' Inserts found: proc_CkTrackerDataChanged';
            PRINT CAST ( @iUpdate AS nvarchar ( 50 )) + ' Updates found: proc_CkTrackerDataChanged';
            PRINT CAST ( @iDel AS nvarchar ( 50 )) + ' Deletes found: proc_CkTrackerDataChanged';
            SET @b = 1;
            IF @iDel > 0
                BEGIN
                    SET @b = 2;
                END;
	   set nocount off ;
            RETURN @b;
        END;
END;
GO
PRINT 'Created proc_CkTrackerDataChanged';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--use KenticoCMS_Prod1
GO
PRINT 'Executing proc_CT_RewardAwardDetail_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardAwardDetail_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardAwardDetail_AddNewRecs;
    END;
GO

CREATE PROCEDURE proc_CT_RewardAwardDetail_AddNewRecs
AS
BEGIN

    WITH CTE_NEW (
         UserGUID
         ,AccountID
         ,AccountCD
         ,SiteGUID
         ,HFitUserMpiNumber
         ,RewardActivityGUID
         ,RewardTriggerGUID
    --, RewardGroupGUID
    )
        AS (
        SELECT
               UserGUID
               ,AccountID
               ,AccountCD
               ,SiteGUID
               ,HFitUserMpiNumber
               ,RewardActivityGUID
               ,RewardTriggerGUID
        --, RewardGroupGUID
          FROM ##Temp_RewardUserDetail
        EXCEPT
        SELECT
               UserGUID
               ,AccountID
               ,AccountCD
               ,SiteGUID
               ,HFitUserMpiNumber
               ,RewardActivityGUID
               ,RewardTriggerGUID
        --, RewardGroupGUID
          FROM DIM_EDW_RewardUserDetail
          WHERE LastModifiedDate IS NULL
        )
        INSERT INTO DIM_EDW_RewardUserDetail
        SELECT
               T.UserGUID
               ,T.SiteGUID
               ,T.HFitUserMpiNumber
               ,T.RewardActivityGUID
               ,T.RewardProgramName
               ,T.RewardModifiedDate
               ,T.RewardLevelModifiedDate
               ,T.LevelCompletedDt
               ,T.ActivityPointsEarned
               ,T.ActivityCompletedDt
               ,T.RewardActivityModifiedDate
               ,T.ActivityPoints
               ,T.UserAccepted
               ,T.UserExceptionAppliedTo
               ,T.RewardTriggerGUID
               ,T.AccountID
               ,T.AccountCD
               ,T.ChangeType
               ,T.RewardExceptionModifiedDate
               ,T.HASHCODE
               ,NULL AS LastModifiedDate
               ,NULL AS RowNbr
               ,NULL AS DeletedFlg
               ,NULL AS TimeZone
               ,NULL AS ConvertedToCentralTime
          FROM
               ##Temp_RewardUserDetail AS T JOIN CTE_NEW AS C
               ON
               C.UserGUID = T.UserGUID
           AND C.AccountID = T.AccountID
           AND C.AccountCD = T.AccountCD
           AND C.SiteGUID = T.SiteGUID
           AND C.HFitUserMpiNumber = T.HFitUserMpiNumber
           AND C.RewardActivityGUID = T.RewardActivityGUID
           AND C.RewardTriggerGUID = T.RewardTriggerGUID;
    

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardAwardDetail_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_RewardAwardDetail_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardAwardDetail_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardAwardDetail_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardAwardDetail_AddUpdatedRecs
AS
BEGIN

    UPDATE S
      SET
          S.UserGUID = T.UserGUID
        ,S.SiteGUID = T.SiteGUID
        ,S.HFitUserMpiNumber = T.HFitUserMpiNumber
        ,S.RewardLevelGUID = T.RewardLevelGUID
        ,S.AwardType = T.AwardType
        ,S.AwardDisplayName = T.AwardDisplayName
        ,S.RewardValue = T.RewardValue
        ,S.ThresholdNumber = T.ThresholdNumber
        ,S.UserNotified = T.UserNotified
        ,S.IsFulfilled = T.IsFulfilled
        ,S.AccountID = T.AccountID
        ,S.AccountCD = T.AccountCD
        ,S.ChangeType = T.ChangeType
        ,S.HashCode = T.HashCode
        ,S.LastModifiedDate = GETDATE () 
        ,S.DeletedFlg = T.DeletedFlg
        ,S.ConvertedToCentralTime = NULL
          FROM DIM_EDW_RewardAwardDetail AS S JOIN
          ##TEMP_EDW_RewardAwardDetail_DATA AS T
                                                  ON
                                                  S.UserGUID = T.UserGUID AND
                                                  S.SiteGUID = T.SiteGUID AND
                                                  S.HFitUserMpiNumber = T.HFitUserMpiNumber AND
                                                  S.RewardLevelGUID = T.RewardLevelGUID AND
                                                  S.AwardType = T.AwardType AND
                                                  S.AwardDisplayName = T.AwardDisplayName AND
                                                  S.RewardValue = T.RewardValue AND
                                                  S.ThresholdNumber = T.ThresholdNumber AND
                                                  S.UserNotified = T.UserNotified AND
                                                  S.IsFulfilled = T.IsFulfilled AND
                                                  S.AccountID = T.AccountID AND
                                                  S.AccountCD = T.AccountCD AND
                                                  ISNULL (S.DeletedFlg , 0) = 0
           WHERE
                 T.HashCode != S.HashCode;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardAwardDetail_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_RewardAwardDetail_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardAwardDetail_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardAwardDetail_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardAwardDetail_AddDeletedRecs
AS
BEGIN

     WITH CTE (
         UserGUID
       , SiteGUID
       , HFitUserMpiNumber
       , RewardLevelGUID
       , AwardType
       , AwardDisplayName
       , RewardValue
       , ThresholdNumber
       , UserNotified
       , IsFulfilled
       , AccountID
       , AccountCD, DeletedFlg) 
        AS (
        SELECT
               UserGUID
             , SiteGUID
             , HFitUserMpiNumber
             , RewardLevelGUID
             , AwardType
             , AwardDisplayName
             , RewardValue
             , ThresholdNumber
             , UserNotified
             , IsFulfilled
             , AccountID
             , AccountCD
		  , isNUll(DeletedFlg, 0) as DeletedFlg
               FROM DIM_EDW_RewardAwardDetail
		  --WHERE DeletedFlg IS NULL
        EXCEPT
        SELECT
               UserGUID
             , SiteGUID
             , HFitUserMpiNumber
             , RewardLevelGUID
             , AwardType
             , AwardDisplayName
             , RewardValue
             , ThresholdNumber
             , UserNotified
             , IsFulfilled
             , AccountID
             , AccountCD
		  , 0 as DeletedFlg
	   FROM ##TEMP_EDW_RewardAwardDetail_DATA                              
        ) 
        UPDATE S
          SET
              S.DeletedFlg = 1, LastModifiedDate = getdate()
              FROM CTE AS T JOIN
              DIM_EDW_RewardAwardDetail AS S
                            ON
                            S.UserGUID = T.UserGUID AND
                            S.SiteGUID = T.SiteGUID AND
                            S.HFitUserMpiNumber = T.HFitUserMpiNumber AND
                            S.RewardLevelGUID = T.RewardLevelGUID AND
                            S.AwardType = T.AwardType AND
                            S.AwardDisplayName = T.AwardDisplayName AND
                            S.RewardValue = T.RewardValue AND
                            S.ThresholdNumber = T.ThresholdNumber AND
                            S.UserNotified = T.UserNotified AND
                            S.IsFulfilled = T.IsFulfilled AND
                            S.AccountID = T.AccountID AND
                            S.AccountCD = T.AccountCD 
					   AND isNUll(S.DeletedFlg,0) = isNUll(T.DeletedFlg,0)
					   AND isNUll(S.DeletedFlg,0) = 0 ;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    update DIM_EDW_RewardAwardDetail set LastModifiedDate = getdate() where LastModifiedDate is null and DeletedFlg is NOT null ;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardAwardDetail_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_RewardUserDetail_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardUserDetail_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardUserDetail_AddNewRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardUserDetail_AddNewRecs
AS
BEGIN

    WITH CTE (
         UserGUID
         ,AccountID
         ,AccountCD
         ,SiteGUID
         ,HFitUserMpiNumber
         ,RewardActivityGUID
         ,RewardTriggerGUID
    --, RewardGroupGUID
    ) 
        AS (
        SELECT
               UserGUID
         ,AccountID
         ,AccountCD
         ,SiteGUID
         ,HFitUserMpiNumber
         ,RewardActivityGUID
         ,RewardTriggerGUID
    --, RewardGroupGUID
               FROM ##Temp_RewardUserDetail
        EXCEPT
        SELECT
               UserGUID
         ,AccountID
         ,AccountCD
         ,SiteGUID
         ,HFitUserMpiNumber
         ,RewardActivityGUID
         ,RewardTriggerGUID
    --, RewardGroupGUID
               FROM DIM_EDW_RewardUserDetail
               WHERE DeletedFlg IS NULL
        ) 

        INSERT INTO dbo.DIM_EDW_RewardUserDetail
        (
              [UserGUID]
      ,[SiteGUID]
      ,[HFitUserMpiNumber]
      ,[RewardActivityGUID]
      ,[RewardProgramName]
      ,[RewardModifiedDate]
      ,[RewardLevelModifiedDate]
      ,[LevelCompletedDt]
      ,[ActivityPointsEarned]
      ,[ActivityCompletedDt]
      ,[RewardActivityModifiedDate]
      ,[ActivityPoints]
      ,[UserAccepted]
      ,[UserExceptionAppliedTo]
      ,[RewardTriggerGUID]
      ,[AccountID]
      ,[AccountCD]
      ,[ChangeType]
      ,[RewardExceptionModifiedDate]
      ,[HASHCODE]
      ,[LastModifiedDate]
      ,[RowNbr]
      ,[DeletedFlg]
      ,[TimeZone]
      ,[ConvertedToCentralTime]
        ) 
        SELECT
               T.[UserGUID]
      ,T.[SiteGUID]
      ,T.[HFitUserMpiNumber]
      ,T.[RewardActivityGUID]
      ,T.[RewardProgramName]
      ,T.[RewardModifiedDate]
      ,T.[RewardLevelModifiedDate]
      ,T.[LevelCompletedDt]
      ,T.[ActivityPointsEarned]
      ,T.[ActivityCompletedDt]
      ,T.[RewardActivityModifiedDate]
      ,T.[ActivityPoints]
      ,T.[UserAccepted]
      ,T.[UserExceptionAppliedTo]
      ,T.[RewardTriggerGUID]
      ,T.[AccountID]
      ,T.[AccountCD]
      ,T.[ChangeType]
      ,T.[RewardExceptionModifiedDate]
      ,T.[HASHCODE]
      ,null as [LastModifiedDate]
      ,null as [RowNbr]
      ,null as [DeletedFlg]
      ,null as [TimeZone]
      ,null as [ConvertedToCentralTime]
               FROM
                    ##Temp_RewardUserDetail AS T JOIN CTE AS S
                                                                  ON
							 S.UserGUID = T.UserGUID AND
							 S.SiteGUID = T.SiteGUID AND
							 S.HFitUserMpiNumber = T.HFitUserMpiNumber AND
							 S.RewardActivityGUID = T.RewardActivityGUID AND
							 S.RewardTriggerGUID = T.RewardTriggerGUID AND
							 S.AccountID = T.AccountID AND
							 S.AccountCD = T.AccountCD;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardUserDetail_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_RewardUserDetail_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardUserDetail_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardUserDetail_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardUserDetail_AddDeletedRecs
AS
BEGIN

DECLARE
   @DELDATE AS  datetime2 ( 7 ) = GETDATE ( );
    WITH CTE_DEL (
         UserGUID
         ,AccountID
         ,AccountCD
         ,SiteGUID
         ,HFitUserMpiNumber
         ,RewardActivityGUID
         ,RewardTriggerGUID
    --, RewardGroupGUID
    )
        AS (
        SELECT
               UserGUID
               ,AccountID
               ,AccountCD
               ,SiteGUID
               ,HFitUserMpiNumber
               ,RewardActivityGUID
               ,RewardTriggerGUID
        --, RewardGroupGUID
          FROM DIM_EDW_RewardUserDetail
          WHERE DeletedFlg IS NULL
        EXCEPT
        SELECT
               UserGUID
               ,AccountID
               ,AccountCD
               ,SiteGUID
               ,HFitUserMpiNumber
               ,RewardActivityGUID
               ,RewardTriggerGUID
        --, RewardGroupGUID
          FROM ##Temp_RewardUserDetail
        )

        UPDATE S
          SET
              DeletedFlg = 1
              ,LastModifiedDate = @DELDATE
          FROM
          DIM_EDW_RewardUserDetail AS S JOIN
          CTE_DEL AS C
          ON
               S.UserGUID = C.UserGUID
           AND S.AccountID = C.AccountID
           AND S.AccountCD = C.AccountCD
           AND S.SiteGUID = C.SiteGUID
           AND S.HFitUserMpiNumber = C.HFitUserMpiNumber
               --AND S.RewardGroupGUID = C.RewardGroupGUID
           AND S.RewardActivityGUID = C.RewardActivityGUID
           AND S.RewardTriggerGUID = C.RewardTriggerGUID
	   AND isnull(DeletedFlg,0) = 0 ;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    update DIM_EDW_RewardUserDetail set LastModifiedDate = getdate() where LastModifiedDate is null and DeletedFlg is NOT null ;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardUserDetail_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_RewardUserDetail_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_RewardUserDetail_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_RewardUserDetail_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_RewardUserDetail_AddUpdatedRecs
AS
BEGIN

    DECLARE
       @RUNDATE AS  datetime2 ( 7 ) = GETDATE ( );

    UPDATE S
      SET
          S.RewardProgramName = T.RewardProgramName
          ,S.RewardModifiedDate = T.RewardModifiedDate
          ,S.RewardLevelModifiedDate = T.RewardLevelModifiedDate
          ,S.LevelCompletedDt = T.LevelCompletedDt
          ,S.ActivityPointsEarned = T.ActivityPointsEarned
          ,S.ActivityCompletedDt = T.ActivityCompletedDt
          ,S.RewardActivityModifiedDate = T.RewardActivityModifiedDate
          ,S.ActivityPoints = T.ActivityPoints
          ,S.UserAccepted = T.UserAccepted
          ,S.UserExceptionAppliedTo = T.UserExceptionAppliedTo
          ,S.ChangeType = T.ChangeType
          ,S.HashCode = T.HashCode
          ,S.LastModifiedDate = GETDATE ( )
          ,S.RewardExceptionModifiedDate = T.RewardExceptionModifiedDate
          ,S.ConvertedToCentralTime = NULL
      FROM ##Temp_RewardUserDetail AS T JOIN DIM_EDW_RewardUserDetail AS S
           ON
           S.UserGUID = T.UserGUID
       AND S.AccountID = T.AccountID
       AND S.AccountCD = T.AccountCD
       AND S.SiteGUID = T.SiteGUID
       AND S.HFitUserMpiNumber = T.HFitUserMpiNumber
           --AND S.RewardGroupGUID = T.RewardGroupGUID
       AND S.RewardActivityGUID = T.RewardActivityGUID
       AND S.RewardTriggerGUID = T.RewardTriggerGUID
       AND S.HASHCODE != T.HASHCODE
       AND S.LastModifiedDate IS NULL;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_RewardUserDetail_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*
-CMS_Class
-CMS_Document
-CMS_Site
-CMS_Tree
-CMS_User
-CMS_UserSettings
-CMS_UserSite
-COM_SKU
-HFit_Account
HFit_LKP_RewardActivity
HFit_LKP_RewardLevelType
HFit_LKP_RewardTrigger
HFit_LKP_RewardType
HFit_RewardActivity
HFit_RewardException
HFit_RewardGroup
HFit_RewardLevel
HFit_RewardProgram
HFit_RewardsUserActivityDetail
HFit_RewardsUserLevelDetail
HFit_RewardTrigger
*/

GO
PRINT 'EXecuting proc_CkRewardUserDetailHasChanged.sql';
GO

IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_CkRewardUserDetailHasChanged' )
    BEGIN
        DROP PROCEDURE
             proc_CkRewardUserDetailHasChanged
    END;

GO
--exec [proc_CkRewardUserDetailHasChanged]
CREATE PROCEDURE proc_CkRewardUserDetailHasChanged
AS
BEGIN
/*
Author:	  W. Dale Miller
RETURNS:	  Integer -   0 = no changes
				    1 = updates or inserts, no deletes
				    2 = DELETES and possibly updates or inserts
*/
    DECLARE
       @b AS int = 0,
       @dels AS int = 0,
       @ins AS int = 0,
       @updt AS int = 0;

    DECLARE
       @TempRewardUserDetail AS TABLE
       (
                                SYS_CHANGE_OPERATION nvarchar( 10 )
       );

    INSERT INTO @TempRewardUserDetail
    (
           SYS_CHANGE_OPERATION
    )
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES CMS_Class , NULL )AS CT
    UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES CMS_Document , NULL )AS CT
    UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES CMS_Site , NULL )AS CT
    UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES CMS_Tree , NULL )AS CT
    UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES CMS_User , NULL )AS CT
    UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES CMS_UserSettings , NULL )AS CT
    UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES CMS_UserSite , NULL )AS CT
    UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES COM_SKU , NULL )AS CT
    UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_Account , NULL )AS CT

UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_Account , NULL )AS CT

UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_LKP_RewardActivity , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_LKP_RewardLevelType , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_LKP_RewardTrigger , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_LKP_RewardType , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_RewardActivity , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_RewardException , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_RewardGroup , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_RewardLevel , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_RewardProgram , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_RewardsUserActivityDetail , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_RewardsUserLevelDetail , NULL )AS CT
UNION ALL
    SELECT SYS_CHANGE_OPERATION FROM CHANGETABLE( CHANGES HFit_RewardTrigger , NULL )AS CT
    

    SET @b = ( SELECT
                      COUNT( * )
                 FROM @TempRewardUserDetail );
    PRINT 'Number of changes found: ' + CAST( @b AS nvarchar( 50 ));


    IF @b > 0
        BEGIN

            SET @dels = ( SELECT
                                 COUNT( * )
                            FROM @TempRewardUserDetail
                            WHERE SYS_CHANGE_OPERATION = 'D' );
            SET @ins = ( SELECT
                                COUNT( * )
                           FROM @TempRewardUserDetail
                           WHERE SYS_CHANGE_OPERATION = 'I' );
            SET @updt = ( SELECT
                                 COUNT( * )
                            FROM @TempRewardUserDetail
                            WHERE SYS_CHANGE_OPERATION = 'U' );

            PRINT 'Number of inserts: ' + CAST( @ins AS nvarchar( 50 ));
            PRINT 'Number of updates: ' + CAST( @updt AS nvarchar( 50 ));
            PRINT 'Number of deletes: ' + CAST( @dels AS nvarchar( 50 ));

            IF @dels > 0
                BEGIN
                    SET @b = 2 ;
                END
            ELSE
                BEGIN
                    SET @b = 1;
                END;
        END;
    print 'Returned Value: ' + cast(@b as nvarchar(50)) ;
    RETURN @b;

END;

GO
PRINT 'EXecuted proc_CkRewardUserDetailHasChanged.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating JOB job_EDW_GetStagingData_BioMetrics';
GO

BEGIN TRANSACTION;
DECLARE
@ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                      WHERE name = N'[Uncategorized (Local)]'
                        AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback;
            END;

    END;

DECLARE
@TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
@JNAME AS nvarchar (100) = 'job_EDW_GetStagingData_BioMetrics_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
                  WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1;
    END;

DECLARE
@jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;

/*--------------------------------------------------------------------------------------
***** Object:  Step [Load_EDW_BioMetrics]    Script Date: 4/12/2015 9:59:37 AM *****
*/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_BioMetrics',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_EDW_BioMetrics;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_BioMetrics',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 10000,
@active_end_time = 235959;
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'executing proc_CkBioMetricChanges.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CkBioMetricChanges') 
    BEGIN
        DROP PROCEDURE
             proc_CkBioMetricChanges
    END;

GO

CREATE PROCEDURE proc_CkBioMetricChanges
AS
BEGIN

    IF EXISTS ( SELECT
                       name
                       FROM tempdb.dbo.sysobjects
                       WHERE id = OBJECT_ID ( N'tempdb..##TEMP_BIO_TYPECHANGES') 

    ) 
        BEGIN
            PRINT 'Dropping ##TEMP_BIO_TYPECHANGES';
            DROP TABLE
                 ##TEMP_BIO_TYPECHANGES;
        END;
    --select * from  ##TEMP_BIO_TYPECHANGES
    DECLARE @iType AS int = 0;
    SELECT
           * INTO
                  ##TEMP_BIO_TYPECHANGES
           FROM(
                SELECT
                       SYS_CHANGE_OPERATION
                       FROM CHANGETABLE (CHANGES FACT_HFit_UserTracker, NULL) AS CT
                UNION ALL
                SELECT
                       SYS_CHANGE_OPERATION
                       FROM CHANGETABLE (CHANGES FACT_CMS_Site, NULL) AS CT
                UNION ALL
                SELECT
                       SYS_CHANGE_OPERATION
                       FROM CHANGETABLE (CHANGES FACT_CMS_UserSettings, NULL) AS CT
                UNION ALL
                SELECT
                       SYS_CHANGE_OPERATION
                       FROM CHANGETABLE (CHANGES FACT_CMS_UserSettings, NULL) AS CT
                UNION ALL
                SELECT
                       SYS_CHANGE_OPERATION
                       FROM CHANGETABLE (CHANGES FACT_HFit_Account, NULL) AS CT
                UNION ALL
                SELECT
                       SYS_CHANGE_OPERATION
                       FROM CHANGETABLE (CHANGES FACT_HFit_TrackerCollectionSource, NULL) AS CT)AS t;

    DECLARE
    @iUpdatesPresent AS int = @@ROWCOUNT;

    DECLARE
    @iDeletesPresent AS int = ( SELECT
                                       COUNT ( *) 

                                       FROM ##TEMP_BIO_TYPECHANGES
                                       WHERE SYS_CHANGE_OPERATION = 'D');
    IF @iDeletesPresent > 0
        BEGIN
            SET @iType = 2;
            RETURN @iType;
        END;

    IF @iUpdatesPresent > 0
        BEGIN
            SET @iType = 1;
        END;
    ELSE
        BEGIN
            SET @iType = 0;
        END;

    RETURN @iType;

END;

GO
PRINT 'executed proc_CkBioMetricChanges.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- USe KenticoCMS_Prod1

PRINT 'Executing proc_CT_BioMetrics_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_BioMetrics_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_BioMetrics_AddNewRecs;
    END;
GO
-- proc_CT_BioMetrics_AddNewRecs
CREATE PROCEDURE proc_CT_BioMetrics_AddNewRecs
AS
BEGIN
            
    WITH CTE (
         UserID
       , UserGUID
       , SiteID
       , SiteGUID
       , itemid
       , TBL) 
        AS ( SELECT
                    UserID
                  , UserGUID
                  , SiteID
                  , SiteGUID
                  , itemid
                  , TBL
                    FROM ##Temp_BioMetrics
             EXCEPT
             SELECT
                    UserID
                  , UserGUID
                  , SiteID
                  , SiteGUID
                  , itemid
                  , TBL
                    FROM DIM_EDW_BioMetrics
                    WHERE LastModifiedDate IS NULL) 
        INSERT INTO dbo.DIM_EDW_BioMetrics (
               UserID
             , UserGUID
             , HFitUserMpiNumber
             , SiteID
             , SiteGUID
             , CreatedDate
             , ModifiedDate
             , Notes
             , IsProfessionallyCollected
             , EventDate
             , EventName
             , PPTWeight
             , PPTHbA1C
             , Fasting
             , HDL
             , LDL
             , Ratio
             , Total
             , Triglycerides
             , Glucose
             , FastingState
             , Systolic
             , Diastolic
             , PPTBodyFatPCT
             , BMI
             , WaistInches
             , HipInches
             , ThighInches
             , ArmInches
             , ChestInches
             , CalfInches
             , NeckInches
             , Height
             , HeartRate
             , FluShot
             , PneumoniaShot
             , PSATest
             , OtherExam
             , TScore
             , DRA
             , CotinineTest
             , ColoCareKit
             , CustomTest
             , CustomDesc
             , CollectionSource
             , AccountID
             , AccountCD
             , ChangeType
             , ItemCreatedWhen
             , ItemModifiedWhen
             , TrackerCollectionSourceID
             , itemid
             , TBL
             , VendorID
             , VendorName
             , HashCode
             , LastModifiedDate
             , DeletedFlg) 
        SELECT
               T.UserID
             , T.UserGUID
             , T.HFitUserMpiNumber
             , T.SiteID
             , T.SiteGUID
             , T.CreatedDate
             , T.ModifiedDate
             , T.Notes
             , T.IsProfessionallyCollected
             , T.EventDate
             , T.EventName
             , T.PPTWeight
             , T.PPTHbA1C
             , T.Fasting
             , T.HDL
             , T.LDL
             , T.Ratio
             , T.Total
             , T.Triglycerides
             , T.Glucose
             , T.FastingState
             , T.Systolic
             , T.Diastolic
             , T.PPTBodyFatPCT
             , T.BMI
             , T.WaistInches
             , T.HipInches
             , T.ThighInches
             , T.ArmInches
             , T.ChestInches
             , T.CalfInches
             , T.NeckInches
             , T.Height
             , T.HeartRate
             , T.FluShot
             , T.PneumoniaShot
             , T.PSATest
             , T.OtherExam
             , T.TScore
             , T.DRA
             , T.CotinineTest
             , T.ColoCareKit
             , T.CustomTest
             , T.CustomDesc
             , T.CollectionSource
             , T.AccountID
             , T.AccountCD
             , T.ChangeType
             , T.ItemCreatedWhen
             , T.ItemModifiedWhen
             , T.TrackerCollectionSourceID
             , T.itemid
             , T.TBL
             , T.VendorID
             , T.VendorName
             , T.HashCode
             , NULL AS LastModifiedDate
             , NULL AS DeletedFlg
               FROM
                    ##Temp_BioMetrics AS T
                         JOIN CTE AS S
                         ON
                            S.UserID = T.UserID AND
                            S.UserGUID = T.UserGUID AND
                            S.SiteID = T.SiteID AND
                            S.SiteGUID = T.SiteGUID AND
                            S.itemid = T.itemid AND
                            S.TBL = T.TBL;
    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_BioMetrics_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- USe KenticoCMS_Prod1

PRINT 'Executing proc_CT_BioMetrics_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_BioMetrics_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_BioMetrics_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_BioMetrics_AddDeletedRecs
AS
BEGIN
/*
select 
*/
    --FIND AND MARK DELETED ROWS
    WITH CTE (
         UserID
       , UserGUID
       , SiteID
       , SiteGUID
       , itemid
       , TBL) 
        AS ( SELECT
                    UserID
                  , UserGUID
                  , SiteID
                  , SiteGUID
                  , itemid
                  , TBL
                    FROM DIM_EDW_BioMetrics
             EXCEPT
             SELECT
                    UserID
                  , UserGUID
                  , SiteID
                  , SiteGUID
                  , itemid
                  , TBL
                    FROM ##Temp_BioMetrics) 
        UPDATE S
          SET
              S.DeletedFlg = 1
              FROM CTE AS T
                        JOIN DIM_EDW_BioMetrics AS S
                        ON
                        S.UserID = T.UserID AND
                        S.UserGUID = T.UserGUID AND
                        S.SiteID = T.SiteID AND
                        S.SiteGUID = T.SiteGUID AND
                        S.itemid = T.itemid AND
                        S.TBL = T.TBL AND
                        S.DeletedFlg IS NULL;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;

    UPDATE DIM_EDW_BioMetrics
      SET
          LastModifiedDate = GETDATE () 
           WHERE
                 LastModifiedDate IS NULL AND
                 DeletedFlg IS NOT NULL;

    PRINT 'Deleted Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_BioMetrics_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- USe KenticoCMS_Prod1
PRINT 'Executing proc_CT_BioMetrics_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_BioMetrics_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_BioMetrics_AddUpdatedRecs;
    END;
GO
CREATE PROCEDURE proc_CT_BioMetrics_AddUpdatedRecs
AS
BEGIN

    DECLARE
    @RUNDATE AS  datetime2 ( 7) = GETDATE () ;

    UPDATE S
      SET
          S.UserID = T.UserID
        ,S.UserGUID = T.UserGUID
        ,S.HFitUserMpiNumber = T.HFitUserMpiNumber
        ,S.SiteID = T.SiteID
        ,S.SiteGUID = T.SiteGUID
        ,S.CreatedDate = T.CreatedDate
        ,S.ModifiedDate = T.ModifiedDate
        ,S.Notes = T.Notes
        ,S.IsProfessionallyCollected = T.IsProfessionallyCollected
        ,S.EventDate = T.EventDate
        ,S.EventName = T.EventName
        ,S.PPTWeight = T.PPTWeight
        ,S.PPTHbA1C = T.PPTHbA1C
        ,S.Fasting = T.Fasting
        ,S.HDL = T.HDL
        ,S.LDL = T.LDL
        ,S.Ratio = T.Ratio
        ,S.Total = T.Total
        ,S.Triglycerides = T.Triglycerides
        ,S.Glucose = T.Glucose
        ,S.FastingState = T.FastingState
        ,S.Systolic = T.Systolic
        ,S.Diastolic = T.Diastolic
        ,S.PPTBodyFatPCT = T.PPTBodyFatPCT
        ,S.BMI = T.BMI
        ,S.WaistInches = T.WaistInches
        ,S.HipInches = T.HipInches
        ,S.ThighInches = T.ThighInches
        ,S.ArmInches = T.ArmInches
        ,S.ChestInches = T.ChestInches
        ,S.CalfInches = T.CalfInches
        ,S.NeckInches = T.NeckInches
        ,S.Height = T.Height
        ,S.HeartRate = T.HeartRate
        ,S.FluShot = T.FluShot
        ,S.PneumoniaShot = T.PneumoniaShot
        ,S.PSATest = T.PSATest
        ,S.OtherExam = T.OtherExam
        ,S.TScore = T.TScore
        ,S.DRA = T.DRA
        ,S.CotinineTest = T.CotinineTest
        ,S.ColoCareKit = T.ColoCareKit
        ,S.CustomTest = T.CustomTest
        ,S.CustomDesc = T.CustomDesc
        ,S.CollectionSource = T.CollectionSource
        ,S.AccountID = T.AccountID
        ,S.AccountCD = T.AccountCD
        ,S.ChangeType = T.ChangeType
        ,S.ItemCreatedWhen = T.ItemCreatedWhen
        ,S.ItemModifiedWhen = T.ItemModifiedWhen
        ,S.TrackerCollectionSourceID = T.TrackerCollectionSourceID
        ,S.itemid = T.itemid
        ,S.TBL = T.TBL
        ,S.VendorID = T.VendorID
        ,S.VendorName = T.VendorName
        ,S.HashCode = T.HashCode
        ,S.LastModifiedDate = GETDATE () 
        ,S.DeletedFlg = NULL
          FROM DIM_EDW_BioMetrics AS S
                    JOIN ##Temp_BioMetrics AS T
                    ON
                    S.UserID = T.UserID AND
                    S.UserGUID = T.UserGUID AND
                    S.SiteID = T.SiteID AND
                    S.SiteGUID = T.SiteGUID AND
                    S.itemid = T.itemid AND
                    S.TBL = T.TBL
           WHERE
                 S.HashCode != T.HashCode AND
                 S.DeletedFlg IS NULL;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_BioMetrics_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO

PRINT 'Execute proc_CT_EDW_CoachingDetail_NoDups.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_EDW_CoachingDetail_NoDups') 
    BEGIN
        DROP PROCEDURE
             proc_CT_EDW_CoachingDetail_NoDups
    END;
GO

-- exec proc_CT_EDW_CoachingDetail_NoDups

CREATE PROCEDURE proc_CT_EDW_CoachingDetail_NoDups
AS
BEGIN

/*------------------------
 Delete Duplicate records 
*/
    WITH CTE (
         ItemID
       , ItemGUID
       , GoalID
       , UserGUID
       , SiteGUID
       , AccountID
       , AccountCD
       , WeekendDate
       , NodeGUID, DuplicateCount) 
        AS (   SELECT
                      ItemID
                    , ItemGUID
                    , GoalID
                    , UserGUID
                    , SiteGUID
                    , AccountID
                    , AccountCD
                    , WeekendDate
                    , NodeGUID
                    , ROW_NUMBER () OVER (PARTITION BY   ItemID
                                                       , ItemGUID
                                                       , GoalID
                                                       , UserGUID
                                                       , SiteGUID
                                                       , AccountID
                                                       , AccountCD
                                                       , WeekendDate
                                                       , NodeGUID
                      ORDER BY   ItemID
                      , ItemGUID
                      , GoalID
                      , UserGUID
                      , SiteGUID
                      , AccountID
                      , AccountCD
                      , WeekendDate
                      , NodeGUID) AS DuplicateCount
                      FROM DIM_EDW_CoachingDetail
        ) 
        DELETE
        FROM CTE
               WHERE
                     DuplicateCount > 1;
END;
GO
PRINT 'Executed proc_CT_EDW_CoachingDetail_NoDups.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'FROM proc_EDW_BioMetrics.SQL';
PRINT 'Creating proc_EDW_BioMetrics';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_BioMetrics') 
    BEGIN
        PRINT 'Replacing proc_EDW_BioMetrics proc';
        DROP PROCEDURE
             proc_EDW_BioMetrics;
    END;
GO

/*--------------------------------------------------
****************************************************
quickcount DIM_EDW_BioMetrics;
exec proc_EDW_BioMetrics 1,1,0
exec proc_EDW_BioMetrics 1,1,1
exec proc_EDW_BioMetrics 1,0,1

exec proc_EDW_BioMetrics 0,1,0
exec proc_EDW_BioMetrics 0,1,1
exec proc_EDW_BioMetrics 0,0,1

--1201906 / 1199488 / 2418
select count(*) from DIM_EDW_BioMetrics 
    where DeletedFlg is null
****************************************************
*/

CREATE PROCEDURE proc_EDW_BioMetrics
       @Reloadall int = 0
     , @TrackProgress int = 0
     , @KeepData AS bit = 0
AS
BEGIN

    --declare @Reloadall int = 0 ;
    --declare @TrackProgress int = 0 ;
    --declare @KeepData AS bit = 0 ;

    SET NOCOUNT ON;

    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_BioMetrics';

    IF @iTotal <= 1
        BEGIN
            SET @Reloadall = 1;
        END;

    DECLARE
    @Synchronization_Version bigint = 0
  , @CurrentDbVersion AS int = CHANGE_TRACKING_CURRENT_VERSION () 
  , @STime AS datetime
  , @TgtView AS nvarchar ( 100) = 'view_EDW_BioMetrics_CT'
  , @ExtractionDate AS datetime
  , @ExtractedVersion AS int
  , @ExtractedRowCnt AS int
  , @EndTime AS datetime
  , @CNT_PulledRecords AS int = 0
  , @iCnt AS int = 0
  , @RowNbr AS int = 0
  , @StartTime AS datetime = GETDATE () 
  , @SVRName AS nvarchar ( 100) 
  , @DBName AS nvarchar ( 100) = DB_NAME () 
  , @CNT_Insert AS int = 0
  , @CNT_Update AS int = 0
  , @CNT_Delete AS int = 0
  , @CNT_StagingTable int = 0
  , @VersionNBR int = 0
  , @LoadStartTime AS datetime = GETDATE () ;

    SET @SVRName = ( SELECT
                            @@SERVERNAME) ;
    SET @STime = GETDATE () ;

    DECLARE
    @Mins AS decimal ( 10 , 2) ;
    DECLARE
    @RecordID AS uniqueidentifier = NEWID () ;

    DECLARE
    @startdate datetime2 = GETDATE () 
  , @HRPART AS decimal ( 10 , 2) 
  , @MINPART AS decimal ( 10 , 2) 
  , @SECPART AS decimal ( 10 , 2) 
  , @TOTSECS AS decimal ( 10 , 2) = 0
  , @proc_RowGuid AS uniqueidentifier = NEWID () 
  , @CALLING_PROC AS nvarchar ( 100) = 'proc_EDW_BioMetrics'
  , @PROC_LOCATION AS nvarchar ( 100) = ''
  , @proc_starttime AS datetime = GETDATE () 
  , @proc_endtime AS datetime = NULL
  , @proc_elapsedsecs AS bigint = 0
  , @proc_RowsProcessed AS bigint = 0;

    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_BioMetrics' , @STime , 0 , 'I';
    IF @Reloadall = 1
        BEGIN
            IF EXISTS ( SELECT
                               NAME
                               FROM sys.tables
                               WHERE name = 'DIM_EDW_BioMetrics') 
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Dropping DIM_EDW_BioMetrics for FULL reload.';
                        END;

                    --*******************************	 
                    --** DROP THE TABLE AND RECREATE
                    --*******************************
                    DROP TABLE
                         DIM_EDW_BioMetrics;
                END;
            ELSE
                BEGIN
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Reloading DIM_EDW_BioMetrics.';
                        END;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Standby, performing initial load of the HA definitions - this could take a couple of hours, Started at: ' + CAST ( GETDATE
                          () AS nvarchar ( 50)) ;
                END;
            IF @Reloadall = 1
                BEGIN
                    PRINT 'RELOADING ALL EDW HA Data.';
                    SELECT
                           * INTO
                                  DIM_EDW_BioMetrics
                           FROM view_EDW_BioMetrics_CT;

                    SET @proc_RowsProcessed = @@rowcount;
                    EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @proc_RowsProcessed;

                    --*************************************************************************
                    EXEC proc_Add_EDW_CT_StdCols 'DIM_EDW_BioMetrics';
                    --*************************************************************************

                    IF @TrackProgress = 1
                        BEGIN
                            SET @iCnt = ( SELECT
                                                 COUNT ( *) 
                                                 FROM DIM_EDW_BioMetrics) ;
                            PRINT DB_NAME () + ' - Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) + ' , loaded ' + CAST ( @iCnt
                                  AS nvarchar ( 50)) + ' records.';
                        END;
                    SET @CNT_PulledRecords = ( SELECT
                                                      COUNT ( *) 
                                                      FROM DIM_EDW_BioMetrics) ;
                    SET @CNT_StagingTable = @CNT_PulledRecords;
                    IF NOT EXISTS ( SELECT
                                           name
                                           FROM sys.indexes
                                           WHERE name = 'PI_EDW_BioMetrics_IDs') 
                        BEGIN
                            IF @TrackProgress = 1
                                BEGIN
                                    PRINT 'Adding INDEX PI_EDW_BioMetrics_IDs at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                                END;
                            CREATE CLUSTERED INDEX PI_EDW_BioMetrics_IDs ON dbo.DIM_EDW_BioMetrics ( UserID , UserGUID , SiteID ,
                            SiteGUID , itemid , TBL) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF ,
                            DROP_EXISTING = OFF , ONLINE = OFF ,
                            ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                        END;
                    SET @ExtractionDate = GETDATE () ;
                    SET @ExtractedVersion = -1;
                    SET @ExtractedRowCnt = ( SELECT
                                                    COUNT ( *) 
                                                    FROM DIM_EDW_BioMetrics) ;

                    --SET @TgtView = 'view_EDW_BioMetrics';

                    SET @EndTime = GETDATE () ;
                    INSERT INTO CT_VersionTracking (
                           ExtractionDate
                         , ExtractedVersion
                         , CurrentDbVersion
                         , ExtractedRowCnt
                         , TgtView
                         , StartTime
                         , EndTime
                         , SVRName
                         , DBName
                         , CNT_Insert
                         , CNT_Update
                         , CNT_delete
                         , CNT_PulledRecords
                         , CNT_StagingTable) 
                    VALUES
                    (
                    @ExtractionDate ,
                    @ExtractedVersion ,
                    @CurrentDbVersion ,
                    @ExtractedRowCnt ,
                    @TgtView ,
                    @StartTime ,
                    @EndTime ,
                    @SVRName ,
                    @DBName ,
                    @CNT_Insert ,
                    @CNT_Update ,
                    @CNT_delete ,
                    @CNT_PulledRecords ,
                    @CNT_StagingTable) ;
                    IF @TrackProgress = 1
                        BEGIN
                            PRINT 'Completed , RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                        END;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed , reloading at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;
            IF @TrackProgress = 1
                BEGIN
                    PRINT 'Completed FULL RELOAD at: ' + CAST ( GETDATE () AS nvarchar ( 50)) ;
                END;

            SET @STime = GETDATE () ;
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_BioMetrics' , @STime , @CNT_PulledRecords , 'U';

            SET @HRPART = DATEDIFF ( hour , @startdate , GETDATE ()) ;
            SET @MINPART = DATEDIFF ( minute , @startdate , GETDATE ()) % 60;
            SET @SECPART = DATEDIFF ( second , @startdate , GETDATE ()) % 60;
            SET @TOTSECS = DATEDIFF ( second , @LoadStartTime , GETDATE ()) ;

            SET @Mins = @TOTSECS / 60;
            PRINT 'TIME TOTAL time to PULL : ' + CAST ( @TOTSECS AS nvarchar ( 10)) + ' @ Seconds or ' + CAST ( @Mins AS nvarchar ( 50)) + ' minutes.';
            PRINT 'TOTAL RECORDS PULLED    : ' + CAST ( @proc_RowsProcessed AS nvarchar ( 20)) ;

            SET @PROC_LOCATION = 'End Of Run';

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_BioMetrics';

            SET @proc_endtime = GETDATE () ;
            EXEC proc_CT_Performance_History @proc_RowGuid , @CALLING_PROC , @PROC_LOCATION , @proc_starttime , @proc_endtime , @proc_elapsedsecs , @proc_RowsProcessed;

            SET NOCOUNT OFF;

            RETURN;
        END;
    IF NOT EXISTS ( SELECT
                           NAME
                           FROM sys.tables
                           WHERE name = 'DIM_EDW_BioMetrics') 
        BEGIN
            PRINT '****************************************************************************';
            PRINT 'FATAL ERROR: table DIM_EDW_BioMetrics was NOT found, aborting.';
            PRINT '****************************************************************************';
        END;
    ELSE
        BEGIN
            PRINT 'Trace 100';
            IF NOT EXISTS ( SELECT
                                   name
                                   FROM sys.indexes
                                   WHERE name = 'PI_EDW_BioMetrics_IDs') 
                BEGIN
                    PRINT 'Adding INDEX PI_EDW_BioMetrics_IDs';
                    CREATE CLUSTERED INDEX PI_EDW_BioMetrics_IDs ON dbo.DIM_EDW_BioMetrics ( UserID , UserGUID , SiteID , SiteGUID ,
                    itemid , TBL) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
                    ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;

            --The staging table exists, CHANGES will be determined and applied.

            IF EXISTS ( SELECT
                               name
                               FROM tempdb.dbo.sysobjects
                               WHERE id = OBJECT_ID ( N'tempdb..##Temp_BioMetrics') 

            ) 
                BEGIN
                    PRINT 'Dropping ##Temp_BioMetrics';
                    DROP TABLE
                         ##Temp_BioMetrics;
                END;
            PRINT 'Trace 200';

            DECLARE @iChanges AS int = 0;

            EXEC @iChanges = proc_CkBioMetricChanges ;

            IF @iChanges = 0
                BEGIN
                    PRINT 'Trace 275;';
                    PRINT '----------------------------------------------';
                    PRINT 'NO UPDATES FOUND, ending.';

                    SET @STime = GETDATE () ;
                    EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_BioMetrics' , @STime , 0 , 'U';

                    SET @HRPART = DATEDIFF ( hour , @startdate , GETDATE ()) ;
                    SET @MINPART = DATEDIFF ( minute , @startdate , GETDATE ()) % 60;
                    SET @SECPART = DATEDIFF ( second , @startdate , GETDATE ()) % 60;
                    SET @TOTSECS = DATEDIFF ( second , @LoadStartTime , GETDATE ()) ;

                    SET @Mins = @TOTSECS / 60;
                    PRINT 'TIME TOTAL time to PULL : ' + CAST ( @TOTSECS AS nvarchar ( 10)) + ' @ Seconds or ' + CAST ( @Mins AS nvarchar ( 50)) + ' minutes.';

                    PRINT 'TOTAL RECORDS PULLED: ' + CAST ( @proc_RowsProcessed AS nvarchar ( 20)) ;

                    SET @PROC_LOCATION = 'End Of Run - No changes found';

                    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_BioMetrics';
                    SET @proc_endtime = GETDATE () ;
                    EXEC proc_CT_Performance_History @proc_RowGuid , @CALLING_PROC , @PROC_LOCATION , @proc_starttime , @proc_endtime , @proc_elapsedsecs , @proc_RowsProcessed;

                    SET NOCOUNT OFF;
                    RETURN;
                END;
            PRINT 'Trace 300;';
            PRINT '@iChanges = ' + CAST (@iChanges AS nvarchar (50)) ;
            PRINT '-----------------------';

            DECLARE @MySql AS nvarchar (2000) = '';

            IF @iChanges = 2
                BEGIN   --00:40:46
                    PRINT 'Trace 300A;';
                    PRINT 'DELETES found - processing all records';
                    PRINT 'Trace 310';
                    SET @MySql = ' SELECT * INTO ##Temp_BioMetrics FROM view_EDW_BioMetrics_CT; ';
                    EXEC (@MySql) ;
                    SET @proc_RowsProcessed = @@rowcount;
                --WHERE CT_ChangeType IS NOT NULL;
                END;

            IF @iChanges = 1
                BEGIN
                    --select * from ##Temp_BioMetrics
                    PRINT 'Trace 300B;';
                    PRINT 'Changes found with No deletes - processing only changed records';
                    SET @MySql = ' SELECT * INTO ##Temp_BioMetrics FROM view_EDW_BioMetrics_CT WHERE CT_ChangeType IS NOT NULL; ';
                    EXEC (@MySql) ;
                    SET @proc_RowsProcessed = @@rowcount;
                    PRINT '#Changes found: ' + CAST ( @proc_RowsProcessed AS nvarchar ( 50)) ;
                END;
            PRINT 'Trace 300C;';
            --*************************************************************************
            EXEC proc_Add_EDW_CT_StdCols '##Temp_BioMetrics';
            --*************************************************************************
            PRINT 'Trace 400';

            IF NOT EXISTS ( SELECT
                                   name
                                   FROM sys.indexes
                                   WHERE name = 'temp_PI_EDW_BioMetrics_IDs') 
                BEGIN
                    CREATE CLUSTERED INDEX temp_PI_EDW_BioMetrics_IDs ON dbo.##Temp_BioMetrics ( UserID , UserGUID , SiteID , SiteGUID ,
                    itemid , TBL) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
                    ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;
            PRINT 'Trace 500';
            IF @KeepData = 1
                BEGIN
                    PRINT '*** KEEPING TEMP DATA IN TABLE TEMP_EDW_BioMetrics_BACKUP_DATA';
                    IF EXISTS ( SELECT
                                       name
                                       FROM sys.tables
                                       WHERE name = 'TEMP_EDW_BioMetrics_BACKUP_DATA') 
                        BEGIN
                            DROP TABLE
                                 TEMP_EDW_BioMetrics_BACKUP_DATA;
                        END;
                    SELECT
                           * INTO
                                  TEMP_EDW_BioMetrics_BACKUP_DATA
                           FROM ##Temp_BioMetrics;
                    CREATE CLUSTERED INDEX temp_PI_TEMP_EDW_BioMetrics_BACKUP_DATA ON TEMP_EDW_BioMetrics_BACKUP_DATA ( UserID , UserGUID , SiteID ,
                    SiteGUID , itemid , TBL) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF ,
                    ONLINE = OFF ,
                    ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;
            PRINT 'Trace 600';

            --**********************************************************************
            --	 Find any new records and insert them into the staging table.
            --**********************************************************************
            DECLARE
            @iInserted AS int = @@ROWCOUNT;
            EXEC @iInserted = proc_CT_BioMetrics_AddNewRecs ;
            SET @CNT_PulledRecords = @iInserted;
            PRINT 'NEW Records Inserted: ' + CAST ( @iInserted AS nvarchar ( 50)) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , @iInserted;

            --**********************************************************************
            --Update records that have differnet HASH codes as they have changed.
            --**********************************************************************
            DECLARE
            @iUpdates AS int = 0;
            EXEC @iUpdates = proc_CT_BioMetrics_AddUpdatedRecs ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'U' , @iUpdates;
            PRINT 'Records Updated: ' + CAST ( @iUpdates AS nvarchar ( 50)) ;

            --**********************************************************************
            --Update records that have been deleted.
            --**********************************************************************            
            DECLARE
            @iDeleted AS int = 0;
            IF @iChanges = 2
                BEGIN
                    PRINT '@iChanges indicates deteles are present, processing all deletes';
                    EXEC @iDeleted = proc_CT_BioMetrics_AddDeletedRecs	   ;
                END;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'D' , @iDeleted;
            PRINT 'Records Marked as Deleted: ' + CAST ( @iDeleted AS nvarchar ( 50)) ;

            SET @CNT_StagingTable = ( SELECT
                                             COUNT ( *) 
                                             FROM DIM_EDW_BioMetrics) ;
            UPDATE CT_VersionTracking
              SET
                  CNT_PulledRecords = @iCnt
                   WHERE
                         RowNbr = @RowNbr;

            SET @CNT_PulledRecords = ( SELECT
                                              COUNT ( *) 
                                              FROM ##Temp_BioMetrics) ;
            UPDATE CT_VersionTracking
              SET
                  CNT_StagingTable = @CNT_StagingTable
                   WHERE
                         RowNbr = @RowNbr;

            SET @STime = GETDATE () ;
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , 'proc_EDW_BioMetrics' , @STime , @CNT_PulledRecords , 'U';

            SET @HRPART = DATEDIFF ( hour , @startdate , GETDATE ()) ;
            SET @MINPART = DATEDIFF ( minute , @startdate , GETDATE ()) % 60;
            SET @SECPART = DATEDIFF ( second , @startdate , GETDATE ()) % 60;
            SET @TOTSECS = DATEDIFF ( second , @LoadStartTime , GETDATE ()) ;

            SET @Mins = @TOTSECS / 60;
            PRINT 'TIME TOTAL time to PULL : ' + CAST ( @TOTSECS AS nvarchar ( 10)) + ' @ Seconds or ' + CAST ( @Mins AS nvarchar ( 50)) + ' minutes.';
            PRINT 'TOTAL RECORDS PULLED: ' + CAST ( @proc_RowsProcessed AS nvarchar ( 20)) ;

            SET @PROC_LOCATION = 'End Of Run';

            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_BioMetrics';
            SET @proc_endtime = GETDATE () ;
            EXEC proc_CT_Performance_History @proc_RowGuid , @CALLING_PROC , @PROC_LOCATION , @proc_starttime , @proc_endtime , @proc_elapsedsecs , @proc_RowsProcessed;

            SET NOCOUNT OFF;

        END;
END;
GO
PRINT 'Created proc_EDW_BioMetrics';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_HA_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HA_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_AddNewRecs;
    END;
GO
-- exec proc_CT_HA_AddNewRecs
CREATE PROCEDURE proc_CT_HA_AddNewRecs
AS
BEGIN

    WITH CTE_NEW (
         UserStartedItemID
       , UserGUID
       , PKHashCode
    ) 
        AS (
        SELECT
               UserStartedItemID
             , UserGUID
             , PKHashCode
               FROM ##HealthAssessmentData
        EXCEPT
        SELECT
               UserStartedItemID
             , UserGUID
             , PKHashCode
               FROM DIM_EDW_HealthAssessment
               WHERE LastModifiedDate IS NULL
        ) 

        INSERT INTO DIM_EDW_HealthAssessment
        (
               UserStartedITEMID
             , HEALTHASSESMENTUserStartedNODEGUID
             , USERID
             , USERGUID
             , HFITUSERMPINUMBER
             , SITEGUID
             , ACCOUNTID
             , ACCOUNTCD
             , ACCOUNTNAME
             , HASTARTEDDT
             , HACOMPLETEDDT
             , USERMODULEITEMID
             , USERMODULECODENAME
             , HAMODULENODEGUID
             , CMSNODEGUID
             , HAMODULEVERSIONID
             , USERRISKCATEGORYITEMID
             , USERRISKCATEGORYCODENAME
             , HARISKCATEGORYNODEGUID
             , HARISKCATEGORYVERSIONID
             , USERRISKAREAITEMID
             , USERRISKAREACODENAME
             , HARISKAREANODEGUID
             , HARISKAREAVERSIONID
             , USERQUESTIONITEMID
             , TITLE
             , HAQUESTIONGUID
             , USERQUESTIONCODENAME
             , HAQUESTIONDOCUMENTID
             , HAQUESTIONVERSIONID
             , HAQUESTIONNODEGUID
             , USERANSWERITEMID
             , HAANSWERNODEGUID
             , HAANSWERVERSIONID
             , USERANSWERCODENAME
             , HAANSWERVALUE
             , HAMODULESCORE
             , HARISKCATEGORYSCORE
             , HARISKAREASCORE
             , HAQUESTIONSCORE
             , HAANSWERPOINTS
             , POINTRESULTS
             , UOMCODE
             , HASCORE
             , MODULEPREWEIGHTEDSCORE
             , RISKCATEGORYPREWEIGHTEDSCORE
             , RISKAREAPREWEIGHTEDSCORE
             , QUESTIONPREWEIGHTEDSCORE
             , QUESTIONGROUPCODENAME
             , ITEMCREATEDWHEN
             , ITEMMODIFIEDWHEN
             , ISPROFESSIONALLYCOLLECTED
             , HARISKCATEGORY_ITEMMODIFIEDWHEN
             , HAUSERRISKAREA_ITEMMODIFIEDWHEN
             , HAUSERQUESTION_ITEMMODIFIEDWHEN
             , HAUSERANSWERS_ITEMMODIFIEDWHEN
             , HAPAPERFLG
             , HATELEPHONICFLG
             , HASTARTEDMODE
             , HACOMPLETEDMODE
             , DOCUMENTCULTURE_VHCJ
             , DOCUMENTCULTURE_HAQUESTIONSVIEW
             , CAMPAIGNNODEGUID
             , HACAMPAIGNID
             , HASHCODE
             , PKHASHCODE
             , CHANGED_FLG
             , LASTMODIFIEDDATE
             , HEALTHASSESSMENTTYPE
             , HAUserStarted_LASTMODIFIED
             , CMSUSER_LASTMODIFIED
             , USERSETTINGS_LASTMODIFIED
             , USERSITE_LASTMODIFIED
             , CMSSITE_LASTMODIFIED
             , ACCT_LASTMODIFIED
             , HAUSERMODULE_LASTMODIFIED
             , VHCJ_LASTMODIFIED
             , VHAJ_LASTMODIFIED
             , HARISKCATEGORY_LASTMODIFIED
             , HAUSERRISKAREA_LASTMODIFIED
             , HAUSERQUESTION_LASTMODIFIED
             , HAQUESTIONSVIEW_LASTMODIFIED
             , HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED
             , HAUSERANSWERS_LASTMODIFIED
             , HAUserStarted_LastUpdateID
             , CMSUSER_LastUpdateID
             , USERSETTINGS_LastUpdateID
             , USERSITE_LastUpdateID
             , ACCT_LastUpdateID
             , HAUSERMODULE_LastUpdateID
             , VHCJ_LastUpdateID
             , VHAJ_LastUpdateID
             , HARISKCATEGORY_LastUpdateID
             , HAUSERRISKAREA_LastUpdateID
             , HAUSERQUESTION_LastUpdateID
             , HAQUESTIONSVIEW_LastUpdateID
             , HAUSERQUESTIONGROUPRESULTS_LastUpdateID
             , HAUSERANSWERS_LastUpdateID
               --,[LASTUPDATEID]
             , DELETEFLG
             , SVR
             , DBNAME
             , DELETEDFLG
		   , ChangeType
        ) 
        SELECT
               T.UserStartedITEMID
             , T.HEALTHASSESMENTUserStartedNODEGUID
             , T.USERID
             , T.USERGUID
             , T.HFITUSERMPINUMBER
             , T.SITEGUID
             , T.ACCOUNTID
             , T.ACCOUNTCD
             , T.ACCOUNTNAME
             , T.HASTARTEDDT
             , T.HACOMPLETEDDT
             , T.USERMODULEITEMID
             , T.USERMODULECODENAME
             , T.HAMODULENODEGUID
             , T.CMSNODEGUID
             , T.HAMODULEVERSIONID
             , T.USERRISKCATEGORYITEMID
             , T.USERRISKCATEGORYCODENAME
             , T.HARISKCATEGORYNODEGUID
             , T.HARISKCATEGORYVERSIONID
             , T.USERRISKAREAITEMID
             , T.USERRISKAREACODENAME
             , T.HARISKAREANODEGUID
             , T.HARISKAREAVERSIONID
             , T.USERQUESTIONITEMID
             , T.TITLE
             , T.HAQUESTIONGUID
             , T.USERQUESTIONCODENAME
             , T.HAQUESTIONDOCUMENTID
             , T.HAQUESTIONVERSIONID
             , T.HAQUESTIONNODEGUID
             , T.USERANSWERITEMID
             , T.HAANSWERNODEGUID
             , T.HAANSWERVERSIONID
             , T.USERANSWERCODENAME
             , T.HAANSWERVALUE
             , T.HAMODULESCORE
             , T.HARISKCATEGORYSCORE
             , T.HARISKAREASCORE
             , T.HAQUESTIONSCORE
             , T.HAANSWERPOINTS
             , T.POINTRESULTS
             , T.UOMCODE
             , T.HASCORE
             , T.MODULEPREWEIGHTEDSCORE
             , T.RISKCATEGORYPREWEIGHTEDSCORE
             , T.RISKAREAPREWEIGHTEDSCORE
             , T.QUESTIONPREWEIGHTEDSCORE
             , T.QUESTIONGROUPCODENAME
             , T.ITEMCREATEDWHEN
             , T.ITEMMODIFIEDWHEN
             , T.ISPROFESSIONALLYCOLLECTED
             , T.HARISKCATEGORY_ITEMMODIFIEDWHEN
             , T.HAUSERRISKAREA_ITEMMODIFIEDWHEN
             , T.HAUSERQUESTION_ITEMMODIFIEDWHEN
             , T.HAUSERANSWERS_ITEMMODIFIEDWHEN
             , T.HAPAPERFLG
             , T.HATELEPHONICFLG
             , T.HASTARTEDMODE
             , T.HACOMPLETEDMODE
             , T.DOCUMENTCULTURE_VHCJ
             , T.DOCUMENTCULTURE_HAQUESTIONSVIEW
             , T.CAMPAIGNNODEGUID
             , T.HACAMPAIGNID
             , T.HASHCODE
             , T.PKHASHCODE
             , T.CHANGED_FLG
             , T.LASTMODIFIEDDATE
             , T.HEALTHASSESSMENTTYPE
             , T.HAUserStarted_LASTMODIFIED
             , T.CMSUSER_LASTMODIFIED
             , T.USERSETTINGS_LASTMODIFIED
             , T.USERSITE_LASTMODIFIED
             , T.CMSSITE_LASTMODIFIED
             , T.ACCT_LASTMODIFIED
             , T.HAUSERMODULE_LASTMODIFIED
             , T.VHCJ_LASTMODIFIED
             , T.VHAJ_LASTMODIFIED
             , T.HARISKCATEGORY_LASTMODIFIED
             , T.HAUSERRISKAREA_LASTMODIFIED
             , T.HAUSERQUESTION_LASTMODIFIED
             , T.HAQUESTIONSVIEW_LASTMODIFIED
             , T.HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED
             , T.HAUSERANSWERS_LASTMODIFIED
             , T.HAUserStarted_LastUpdateID
             , T.CMSUSER_LastUpdateID
             , T.USERSETTINGS_LastUpdateID
             , T.USERSITE_LastUpdateID
             , T.ACCT_LastUpdateID
             , T.HAUSERMODULE_LastUpdateID
             , T.VHCJ_LastUpdateID
             , T.VHAJ_LastUpdateID
             , T.HARISKCATEGORY_LastUpdateID
             , T.HAUSERRISKAREA_LastUpdateID
             , T.HAUSERQUESTION_LastUpdateID
             , T.HAQUESTIONSVIEW_LastUpdateID
             , T.HAUSERQUESTIONGROUPRESULTS_LastUpdateID
             , T.HAUSERANSWERS_LastUpdateID
               --,T.[LASTUPDATEID]
             , T.DELETEFLG
             , T.SVR
             , T.DBNAME
             , T.DELETEDFLG
			 , 'I' as ChangeType
               FROM
                   ##HealthAssessmentData AS T
                       JOIN CTE_NEW AS C
                           ON C.UserStartedItemID = T.UserStartedItemID
                          AND C.UserGUID = T.UserGUID
                          AND C.PKHashCode = T.PKHashCode;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HA_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_HA_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HA_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_AddUpdatedRecs;
    END;
GO

-- exec proc_CT_HA_AddUpdatedRecs
CREATE PROCEDURE proc_CT_HA_AddUpdatedRecs
AS
BEGIN

    DECLARE
    @RUNDATE AS  datetime2 ( 7) = GETDATE () ;

    UPDATE S
           SET
               S.UserStartedITEMID = T.UserStartedITEMID
             ,S.HEALTHASSESMENTUserStartedNODEGUID = T.HEALTHASSESMENTUserStartedNODEGUID
             ,S.USERID = T.USERID
             ,S.USERGUID = T.USERGUID
             ,S.HFITUSERMPINUMBER = T.HFITUSERMPINUMBER
             ,S.SITEGUID = T.SITEGUID
             ,S.ACCOUNTID = T.ACCOUNTID
             ,S.ACCOUNTCD = T.ACCOUNTCD
             ,S.ACCOUNTNAME = T.ACCOUNTNAME
             ,S.HASTARTEDDT = T.HASTARTEDDT
             ,S.HACOMPLETEDDT = T.HACOMPLETEDDT
             ,S.USERMODULEITEMID = T.USERMODULEITEMID
             ,S.USERMODULECODENAME = T.USERMODULECODENAME
             ,S.HAMODULENODEGUID = T.HAMODULENODEGUID
             ,S.CMSNODEGUID = T.CMSNODEGUID
             ,S.HAMODULEVERSIONID = T.HAMODULEVERSIONID
             ,S.USERRISKCATEGORYITEMID = T.USERRISKCATEGORYITEMID
             ,S.USERRISKCATEGORYCODENAME = T.USERRISKCATEGORYCODENAME
             ,S.HARISKCATEGORYNODEGUID = T.HARISKCATEGORYNODEGUID
             ,S.HARISKCATEGORYVERSIONID = T.HARISKCATEGORYVERSIONID
             ,S.USERRISKAREAITEMID = T.USERRISKAREAITEMID
             ,S.USERRISKAREACODENAME = T.USERRISKAREACODENAME
             ,S.HARISKAREANODEGUID = T.HARISKAREANODEGUID
             ,S.HARISKAREAVERSIONID = T.HARISKAREAVERSIONID
             ,S.USERQUESTIONITEMID = T.USERQUESTIONITEMID
             ,S.TITLE = T.TITLE
             ,S.HAQUESTIONGUID = T.HAQUESTIONGUID
             ,S.USERQUESTIONCODENAME = T.USERQUESTIONCODENAME
             ,S.HAQUESTIONDOCUMENTID = T.HAQUESTIONDOCUMENTID
             ,S.HAQUESTIONVERSIONID = T.HAQUESTIONVERSIONID
             ,S.HAQUESTIONNODEGUID = T.HAQUESTIONNODEGUID
             ,S.USERANSWERITEMID = T.USERANSWERITEMID
             ,S.HAANSWERNODEGUID = T.HAANSWERNODEGUID
             ,S.HAANSWERVERSIONID = T.HAANSWERVERSIONID
             ,S.USERANSWERCODENAME = T.USERANSWERCODENAME
             ,S.HAANSWERVALUE = T.HAANSWERVALUE
             ,S.HAMODULESCORE = T.HAMODULESCORE
             ,S.HARISKCATEGORYSCORE = T.HARISKCATEGORYSCORE
             ,S.HARISKAREASCORE = T.HARISKAREASCORE
             ,S.HAQUESTIONSCORE = T.HAQUESTIONSCORE
             ,S.HAANSWERPOINTS = T.HAANSWERPOINTS
             ,S.POINTRESULTS = T.POINTRESULTS
             ,S.UOMCODE = T.UOMCODE
             ,S.HASCORE = T.HASCORE
             ,S.MODULEPREWEIGHTEDSCORE = T.MODULEPREWEIGHTEDSCORE
             ,S.RISKCATEGORYPREWEIGHTEDSCORE = T.RISKCATEGORYPREWEIGHTEDSCORE
             ,S.RISKAREAPREWEIGHTEDSCORE = T.RISKAREAPREWEIGHTEDSCORE
             ,S.QUESTIONPREWEIGHTEDSCORE = T.QUESTIONPREWEIGHTEDSCORE
             ,S.QUESTIONGROUPCODENAME = T.QUESTIONGROUPCODENAME
             ,S.ITEMCREATEDWHEN = T.ITEMCREATEDWHEN
             ,S.ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
             ,S.ISPROFESSIONALLYCOLLECTED = T.ISPROFESSIONALLYCOLLECTED
             ,S.HARISKCATEGORY_ITEMMODIFIEDWHEN = T.HARISKCATEGORY_ITEMMODIFIEDWHEN
             ,S.HAUSERRISKAREA_ITEMMODIFIEDWHEN = T.HAUSERRISKAREA_ITEMMODIFIEDWHEN
             ,S.HAUSERQUESTION_ITEMMODIFIEDWHEN = T.HAUSERQUESTION_ITEMMODIFIEDWHEN
             ,S.HAUSERANSWERS_ITEMMODIFIEDWHEN = T.HAUSERANSWERS_ITEMMODIFIEDWHEN
             ,S.HAPAPERFLG = T.HAPAPERFLG
             ,S.HATELEPHONICFLG = T.HATELEPHONICFLG
             ,S.HASTARTEDMODE = T.HASTARTEDMODE
             ,S.HACOMPLETEDMODE = T.HACOMPLETEDMODE
             ,S.DOCUMENTCULTURE_VHCJ = T.DOCUMENTCULTURE_VHCJ
             ,S.DOCUMENTCULTURE_HAQUESTIONSVIEW = T.DOCUMENTCULTURE_HAQUESTIONSVIEW
             ,S.CAMPAIGNNODEGUID = T.CAMPAIGNNODEGUID
             ,S.HACAMPAIGNID = T.HACAMPAIGNID
             ,S.HASHCODE = T.HASHCODE
             ,S.CHANGED_FLG = T.CHANGED_FLG
             ,S.HEALTHASSESSMENTTYPE = T.HEALTHASSESSMENTTYPE

             ,S.HAUserStarted_LASTMODIFIED = T.HAUserStarted_LASTMODIFIED
             ,S.CMSUSER_LASTMODIFIED = T.CMSUSER_LASTMODIFIED
             ,S.USERSETTINGS_LASTMODIFIED = T.USERSETTINGS_LASTMODIFIED
             ,S.USERSITE_LASTMODIFIED = T.USERSITE_LASTMODIFIED
             ,S.CMSSITE_LASTMODIFIED = T.CMSSITE_LASTMODIFIED
             ,S.ACCT_LASTMODIFIED = T.ACCT_LASTMODIFIED
             ,S.HAUSERMODULE_LASTMODIFIED = T.HAUSERMODULE_LASTMODIFIED
             ,S.VHCJ_LASTMODIFIED = T.VHCJ_LASTMODIFIED
             ,S.VHAJ_LASTMODIFIED = T.VHAJ_LASTMODIFIED
             ,S.HARISKCATEGORY_LASTMODIFIED = T.HARISKCATEGORY_LASTMODIFIED
             ,S.HAUSERRISKAREA_LASTMODIFIED = T.HAUSERRISKAREA_LASTMODIFIED
             ,S.HAUSERQUESTION_LASTMODIFIED = T.HAUSERQUESTION_LASTMODIFIED
             ,S.HAQUESTIONSVIEW_LASTMODIFIED = T.HAQUESTIONSVIEW_LASTMODIFIED
             ,S.HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED = T.HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED
             ,S.HAUSERANSWERS_LASTMODIFIED = T.HAUSERANSWERS_LASTMODIFIED
             ,S.HAUserStarted_LastUpdateID = T.HAUserStarted_LastUpdateID
             ,S.CMSUSER_LastUpdateID = T.CMSUSER_LastUpdateID
             ,S.USERSETTINGS_LastUpdateID = T.USERSETTINGS_LastUpdateID
             ,S.USERSITE_LastUpdateID = T.USERSITE_LastUpdateID
             ,S.ACCT_LastUpdateID = T.ACCT_LastUpdateID
             ,S.HAUSERMODULE_LastUpdateID = T.HAUSERMODULE_LastUpdateID
             ,S.VHCJ_LastUpdateID = T.VHCJ_LastUpdateID
             ,S.VHAJ_LastUpdateID = T.VHAJ_LastUpdateID
             ,S.HARISKCATEGORY_LastUpdateID = T.HARISKCATEGORY_LastUpdateID
             ,S.HAUSERRISKAREA_LastUpdateID = T.HAUSERRISKAREA_LastUpdateID
             ,S.HAUSERQUESTION_LastUpdateID = T.HAUSERQUESTION_LastUpdateID
             ,S.HAQUESTIONSVIEW_LastUpdateID = T.HAQUESTIONSVIEW_LastUpdateID
             ,S.HAUSERQUESTIONGROUPRESULTS_LastUpdateID = T.HAUSERQUESTIONGROUPRESULTS_LastUpdateID
             ,S.HAUSERANSWERS_LastUpdateID = T.HAUSERANSWERS_LastUpdateID

             ,S.DELETEFLG = T.DELETEFLG
             ,S.SVR = T.SVR
             ,S.DBNAME = T.DBNAME

             ,S.ConvertedToCentralTime = NULL
             ,S.LastModifiedDate = GETDATE () 
             ,S.RowNbr = NULL
             ,S.DeletedFlg = NULL
             ,S.TimeZone = NULL
             ,S.PKHashCode = T.PKHashCode
		   ,S.ChangeType = 'U'
               FROM
               ##HealthAssessmentData AS T
                   JOIN
                   DIM_EDW_HealthAssessment AS S
                       ON
                       S.UserStartedItemID = T.UserStartedItemID
                   AND S.UserGUID = T.UserGUID
                   AND S.PKHashCode = T.PKHashCode
                   AND S.HashCode != T.HashCode;

    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    PRINT 'Updated Record Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HA_AddUpdatedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_HA_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HA_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_AddDeletedRecs;
    END;
GO
-- exec proc_CT_HA_AddDeletedRecs
CREATE PROCEDURE proc_CT_HA_AddDeletedRecs
AS
BEGIN
    DECLARE @ST AS datetime = GETDATE () ;
    DECLARE @CT AS datetime = GETDATE () ;
    DECLARE @ET AS datetime = GETDATE () ;

    SET @ET = GETDATE () ;
    EXEC proc_trace 'END Process', @CT, NULL;
/*--------------------------------------------
    IF ##EdwHAHashkeys is missing, build the 
    HASH KEY TABLE. Normally, this will take 
    about 45 minutes and must be done if 
    DELETES are detected.
*/
    IF OBJECT_ID ('tempdb..##EdwHAHashkeys') IS NULL
        BEGIN
            EXEC proc_EDW_BuildHAHashkeys ;
        END;

    DELETE FROM DIM_EDW_HealthAssessment
    WHERE
          PKHashCode IS NULL;

    DELETE FROM ##EdwHAHashkeys
    WHERE
          PKHashCode IS NULL;

    DECLARE
    @DELDATE AS  datetime2 ( 7) = GETDATE () ;
    -- select top 100 * from ##EdwHAHashkeys
    WITH CTE_DEL (
         UserStartedItemID
       , UserGUID
       , PKHashCode
    ) 
        AS (
        SELECT
               UserStartedItemID
             , UserGUID
             , PKHashCode
               FROM DIM_EDW_HealthAssessment
               WHERE DeletedFlg IS NULL
        EXCEPT
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
               FROM ##EdwHAHashkeys
        --FROM view_EDW_PullHAData_NoCT
        ) 

        UPDATE S
               SET
                   DeletedFlg = 1
                 ,LastModifiedDate = @DELDATE
                 ,ChangeType = 'D'
                   FROM DIM_EDW_HealthAssessment AS S
                            JOIN
                            CTE_DEL AS C
                                ON
                                C.UserStartedItemID = S.UserStartedItemID
                            AND C.UserGUID = S.UserGUID
                            AND C.PKHashCode = S.PKHashCode;

    DECLARE
    @iDels AS int = @@ROWCOUNT;

    UPDATE DIM_EDW_HealthAssessment
           SET
               LastModifiedDate = GETDATE () 
    WHERE
          LastModifiedDate IS NULL
      AND DeletedFlg IS NOT NULL;

    PRINT 'Deleted Record Count: ' + CAST ( @iDels AS nvarchar (50)) ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END Process', @CT, @ET;
    RETURN @iDels;
END;

GO
PRINT 'Executed proc_CT_HA_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*---------------------------------------------------
drop table ##TEMP_HA_DATA 
go
select top 10000 * from view_EDW_HealthAssesment_CT
where CHANGETYPE is NOT NULL
select * into ##TEMP_HA_DATA from view_EDW_HealthAssesment_CT
where CHANGETYPE is NOT NULL
*/
GO
PRINT 'Executing view_EDW_HealthAssesment_CT.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE name = 'view_EDW_HealthAssesment_CT') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssesment_CT;
    END;
GO
CREATE VIEW view_EDW_HealthAssesment_CT
AS SELECT
          HAUSERSTARTED.ITEMID AS USERSTARTEDITEMID
        , VHAJ.NODEGUID AS HEALTHASSESMENTUSERSTARTEDNODEGUID
        , HAUSERSTARTED.USERID
        , CMSUSER.USERGUID
        , USERSETTINGS.HFITUSERMPINUMBER
        , CMSSITE.SITEGUID
        , ACCT.ACCOUNTID
        , ACCT.ACCOUNTCD
        , ACCT.ACCOUNTNAME
        , HAUSERSTARTED.HASTARTEDDT
        , HAUSERSTARTED.HACOMPLETEDDT
        , HAUSERMODULE.ITEMID AS USERMODULEITEMID
        , HAUSERMODULE.CODENAME AS USERMODULECODENAME
        , HAUSERMODULE.HAMODULENODEGUID
        , VHAJ.NODEGUID AS CMSNODEGUID
        , NULL AS HAMODULEVERSIONID
        , HARISKCATEGORY.ITEMID AS USERRISKCATEGORYITEMID
        , HARISKCATEGORY.CODENAME AS USERRISKCATEGORYCODENAME
        , HARISKCATEGORY.HARISKCATEGORYNODEGUID
        , NULL AS HARISKCATEGORYVERSIONID
        , HAUSERRISKAREA.ITEMID AS USERRISKAREAITEMID
        , HAUSERRISKAREA.CODENAME AS USERRISKAREACODENAME
        , HAUSERRISKAREA.HARISKAREANODEGUID
        , NULL AS HARISKAREAVERSIONID
        , HAUSERQUESTION.ITEMID AS USERQUESTIONITEMID
        , HAQUESTIONSVIEW.TITLE
        , HAUSERQUESTION.HAQUESTIONNODEGUID AS HAQUESTIONGUID
        , HAUSERQUESTION.CODENAME AS USERQUESTIONCODENAME
        , NULL AS HAQUESTIONDOCUMENTID
        , NULL AS HAQUESTIONVERSIONID
        , HAUSERQUESTION.HAQUESTIONNODEGUID
        , HAUSERANSWERS.ITEMID AS USERANSWERITEMID
        , HAUSERANSWERS.HAANSWERNODEGUID
        , NULL AS HAANSWERVERSIONID
        , HAUSERANSWERS.CODENAME AS USERANSWERCODENAME
        , HAUSERANSWERS.HAANSWERVALUE
        , HAUSERMODULE.HAMODULESCORE
        , HARISKCATEGORY.HARISKCATEGORYSCORE
        , HAUSERRISKAREA.HARISKAREASCORE
        , HAUSERQUESTION.HAQUESTIONSCORE
        , HAUSERANSWERS.HAANSWERPOINTS
        , HAUSERQUESTIONGROUPRESULTS.POINTRESULTS
        , HAUSERANSWERS.UOMCODE
        , HAUSERSTARTED.HASCORE
        , HAUSERMODULE.PREWEIGHTEDSCORE AS MODULEPREWEIGHTEDSCORE
        , HARISKCATEGORY.PREWEIGHTEDSCORE AS RISKCATEGORYPREWEIGHTEDSCORE
        , HAUSERRISKAREA.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
        , HAUSERQUESTION.PREWEIGHTEDSCORE AS QUESTIONPREWEIGHTEDSCORE
        , HAUSERQUESTIONGROUPRESULTS.CODENAME AS QUESTIONGROUPCODENAME
        , COALESCE ( CT_CMS_USER.SYS_CHANGE_OPERATION , CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION , CT_CMS_SITE.SYS_CHANGE_OPERATION , CT_CMS_USERSITE.SYS_CHANGE_OPERATION , CT_HFIT_ACCOUNT.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_OPERATION) AS CHANGETYPE
        , HAUSERANSWERS.ITEMCREATEDWHEN
        , HAUSERANSWERS.ITEMMODIFIEDWHEN
        , HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED
        , HARISKCATEGORY.ITEMMODIFIEDWHEN AS HARISKCATEGORY_ITEMMODIFIEDWHEN
        , HAUSERRISKAREA.ITEMMODIFIEDWHEN AS HAUSERRISKAREA_ITEMMODIFIEDWHEN
        , HAUSERQUESTION.ITEMMODIFIEDWHEN AS HAUSERQUESTION_ITEMMODIFIEDWHEN
        , HAUSERANSWERS.ITEMMODIFIEDWHEN AS HAUSERANSWERS_ITEMMODIFIEDWHEN
        , HAUSERSTARTED.HAPAPERFLG
        , HAUSERSTARTED.HATELEPHONICFLG
        , HAUSERSTARTED.HASTARTEDMODE
        , HAUSERSTARTED.HACOMPLETEDMODE
        , VHCJ.DOCUMENTCULTURE AS DOCUMENTCULTURE_VHCJ
        , HAQUESTIONSVIEW.DOCUMENTCULTURE AS DOCUMENTCULTURE_HAQUESTIONSVIEW
        , HAUSERSTARTED.HACAMPAIGNNODEGUID AS CAMPAIGNNODEGUID
        , VHCJ.HACAMPAIGNID
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUSERSTARTED.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.USERID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( USERSETTINGS.HFITUSERMPINUMBER AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTNAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASTARTEDDT AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACOMPLETEDDT AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( LEFT ( HAQUESTIONSVIEW.TITLE , 1000) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERVALUE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULESCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREASCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERPOINTS AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.POINTRESULTS AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.UOMCODE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.PREWEIGHTEDSCORE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.CODENAME AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMCREATEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HAPAPERFLG AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HATELEPHONICFLG AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASTARTEDMODE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACOMPLETEDMODE AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACAMPAIGNNODEGUID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( VHCJ.HACAMPAIGNID AS NVARCHAR (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS NVARCHAR (100)) , '-')) AS VARCHAR (100)) AS HASHCODE
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUSERSTARTED.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( USERGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( SITEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( ACCOUNTCD AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAMODULENODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORYNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS VARCHAR (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HARISKAREANODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAQUESTIONNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAANSWERNODEGUID AS VARCHAR (50)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACAMPAIGNNODEGUID AS VARCHAR (50)) , '-')) AS VARCHAR (100)) AS PKHASHCODE
          --, COALESCE ( CT_CMS_USER.USERID , CT_CMS_USERSETTINGS.USERSETTINGSID , CT_CMS_SITE.SITEID , CT_CMS_USERSITE.USERSITEID , CT_HFIT_ACCOUNT.ACCOUNTID , CT_HFIT_HealthAssesmentUserAnswers.ITEMID , CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID , CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID , CT_HFIT_HEALTHASSESMENTUSERSTARTED.ITEMID) AS CHANGED_FLG
        , NULL AS CHANGED_FLG

          --*************************************
          --join changes to the records 

          --, CT_CMS_USER.USERID AS CT_CMS_USER_USERID
        , CT_CMS_USER.SYS_CHANGE_OPERATION AS CT_CMS_USER_CHANGE_OPERATION
          --, CT_CMS_USERSETTINGS.USERSETTINGSID AS CT_USERSETTINGSID
        , CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION AS CT_USERSETTINGSID_CHANGE_OPERATION
          --, CT_CMS_SITE.SITEID AS SITEID_CTID
        , CT_CMS_SITE.SYS_CHANGE_OPERATION AS SITEID_CHANGE_OPERATION
          --, CT_CMS_USERSITE.USERSITEID AS USERSITEID_CTID
        , CT_CMS_USERSITE.SYS_CHANGE_OPERATION AS USERSITEID_CHANGE_OPERATION
          --, CT_HFIT_ACCOUNT.ACCOUNTID AS ACCOUNTID_CTID
        , CT_HFIT_ACCOUNT.SYS_CHANGE_OPERATION AS ACCOUNTID__CHANGE_OPERATION
          --, CT_HFIT_HealthAssesmentUserAnswers.ITEMID AS HAUSERANSWERS_CTID
        , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION AS HAUSERANSWERS_CHANGE_OPERATION
          --, CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID AS HFIT_HEALTHASSESMENTUSERMODULE_CTID
        , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERMODULE_CHANGE_OPERATION
          --, CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID AS HFIT_HEALTHASSESMENTUSERQUESTION_CTID
        , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERQUESTION_CHANGE_OPERATION
          --, CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID AS HFIT_HealthAssesmentUserQuestionGroupResults_CTID
        , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION AS HFIT_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
          --, CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID AS HFIT_HEALTHASSESMENTUSERRISKAREA_CTID
        , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERRISKAREA_CHANGE_OPERATION
          --, CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID AS HFIT_HEALTHASSESMENTUSERRISKCATEGORY_CTID
        , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERRISKCATEGORY_CHANGE_OPERATION
          --, CT_HFIT_HEALTHASSESMENTUSERSTARTED.ITEMID AS HFIT_HEALTHASSESMENTUSERSTARTED_CTID
        , CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_OPERATION AS HFIT_HEALTHASSESMENTUSERSTARTED_CHANGE_OPERATION

          --Get the TYPE of change ID NUMBER
          , CT_CMS_USER.SYS_CHANGE_VERSION AS CT_CMS_USER_SCV
          , CT_CMS_USERSETTINGS.SYS_CHANGE_VERSION AS CT_CMS_USERSETTINGS_SCV
          , CT_CMS_SITE.SYS_CHANGE_VERSION AS CT_CMS_SITE_SCV
          , CT_CMS_USERSITE.SYS_CHANGE_VERSION AS CT_CMS_USERSITE_SCV
          , CT_HFIT_ACCOUNT.SYS_CHANGE_VERSION AS CT_HFIT_ACCOUNT_SCV
          , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION AS CT_HFIT_HealthAssesmentUserAnswers_SCV
          , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERMODULE_SCV
          , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERQUESTION_SCV
          , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION AS CT_HFIT_HealthAssesmentUserQuestionGroupResults_SCV
          , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERRISKAREA_SCV
          , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY_SCV
          , CT_HFIT_HEALTHASSESMENTUSERSTARTED.SYS_CHANGE_VERSION AS CT_HFIT_HEALTHASSESMENTUSERSTARTED_SCV

        , HAUSERANSWERS.ITEMMODIFIEDWHEN AS LASTMODIFIEDDATE
        , 0 AS DELETEFLG
        , CASE
              WHEN HAUserStarted.HADocumentConfigID IS NULL
                  THEN 'SHORT_VER'
              WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
                  THEN 'LONG_VER'
              ELSE 'UNKNOWN'
          END AS HealthAssessmentType
        , 0 AS LASTUPDATEID
        , GETDATE () AS LASTLOADEDDATE
        , @@Servername AS SVR
        , DB_NAME () AS DBNAME
        , 0 AS DeletedFlg
   --INTO ##TEMP_HA_DATA
          FROM
               DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED AS HAUSERSTARTED
                    INNER JOIN DIM_EDW_CMS_USER AS CMSUSER
                       ON HAUSERSTARTED.USERID = CMSUSER.USERID
                    INNER JOIN DIM_EDW_CMS_USERSETTINGS AS USERSETTINGS
                       ON
                          USERSETTINGS.USERSETTINGSUSERID = CMSUSER.USERID AND
                          HFITUSERMPINUMBER >= 0 AND
                          HFITUSERMPINUMBER IS NOT NULL
                    INNER JOIN DIM_EDW_CMS_USERSITE AS USERSITE
                       ON CMSUSER.USERID = USERSITE.USERID
                    INNER JOIN DBO.CMS_SITE AS CMSSITE
                       ON USERSITE.SITEID = CMSSITE.SITEID
                    INNER JOIN DBO.HFIT_ACCOUNT AS ACCT
                       ON ACCT.SITEID = CMSSITE.SITEID
                    
				INNER JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE
                       ON HAUSERSTARTED.ITEMID = HAUSERMODULE.HASTARTEDITEMID
				    
                    INNER JOIN DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED AS VHCJ
                       ON
                          VHCJ.NODEGUID = HAUSERSTARTED.HACAMPAIGNNODEGUID AND
                          VHCJ.NODESITEID = USERSITE.SITEID AND
                          VHCJ.DOCUMENTCULTURE = 'en-US'
                    INNER JOIN DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED AS VHAJ
                       ON VHAJ.DOCUMENTID = VHCJ.HEALTHASSESSMENTID
                    INNER JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY
                       ON HAUSERMODULE.ITEMID = HARISKCATEGORY.HAMODULEITEMID
                    INNER JOIN DIM_EDW_HFit_HealthAssesmentUserRiskArea AS HAUSERRISKAREA
                       ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
                    INNER JOIN DIM_EDW_HFit_HealthAssesmentUserQuestion AS HAUSERQUESTION
                       ON HAUSERRISKAREA.ITEMID = HAUSERQUESTION.HARISKAREAITEMID
                    INNER JOIN DIM_EDW_View_EDW_HealthAssesmentQuestions AS HAQUESTIONSVIEW
                       ON HAUSERQUESTION.HAQUESTIONNODEGUID = HAQUESTIONSVIEW.NODEGUID
                    LEFT OUTER JOIN DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults AS HAUSERQUESTIONGROUPRESULTS
                       ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
                    INNER JOIN DIM_EDW_HFIT_HealthAssesmentUserAnswers AS HAUSERANSWERS
                       ON HAUSERQUESTION.ITEMID = HAUSERANSWERS.HAQUESTIONITEMID 
               --Add in the change tracking data
                    LEFT JOIN CHANGETABLE (CHANGES CMS_USERSETTINGS , NULL) AS CT_CMS_USERSETTINGS
                       ON USERSETTINGS.USERSETTINGSID = CT_CMS_USERSETTINGS.USERSETTINGSID
                    LEFT JOIN CHANGETABLE (CHANGES CMS_USER , NULL) AS CT_CMS_USER
                       ON CMSUSER.USERID = CT_CMS_USER.USERID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_SITE , NULL) AS CT_CMS_SITE
                       ON CMSSITE.SITEID = CT_CMS_SITE.SITEID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_USERSITE , NULL) AS CT_CMS_USERSITE
                       ON USERSITE.USERSITEID = CT_CMS_USERSITE.USERSITEID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFIT_ACCOUNT , NULL) AS CT_HFIT_ACCOUNT
                       ON ACCT.ACCOUNTID = CT_HFIT_ACCOUNT.ACCOUNTID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFIT_HACAMPAIGN , NULL) AS CT_HFIT_HACAMPAIGN
                       ON VHCJ.HACAMPAIGNID = CT_HFIT_HACAMPAIGN.HACAMPAIGNID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFIT_HealthAssesmentUserAnswers , NULL) AS CT_HFIT_HealthAssesmentUserAnswers
                       ON HAUSERANSWERS.ITEMID = CT_HFIT_HealthAssesmentUserAnswers.ITEMID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERMODULE , NULL) AS CT_HFIT_HEALTHASSESMENTUSERMODULE
                       ON HAUSERMODULE.ITEMID = CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERQUESTION , NULL) AS CT_HFIT_HEALTHASSESMENTUSERQUESTION
                       ON HAUSERQUESTION.ITEMID = CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFIT_HealthAssesmentUserQuestionGroupResults , NULL) AS CT_HFIT_HealthAssesmentUserQuestionGroupResults
                       ON HAUSERQUESTIONGROUPRESULTS.ITEMID = CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERRISKAREA , NULL) AS CT_HFIT_HEALTHASSESMENTUSERRISKAREA
                       ON HAUSERRISKAREA.ITEMID = CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERRISKCATEGORY , NULL) AS CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY
                       ON HARISKCATEGORY.ITEMID = CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFIT_HEALTHASSESMENTUSERSTARTED , NULL) AS CT_HFIT_HEALTHASSESMENTUSERSTARTED
                       ON HAUSERSTARTED.ITEMID = CT_HFIT_HEALTHASSESMENTUSERSTARTED.ITEMID
          WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
          SELECT
                 REJECTMPICODE
                 FROM HFIT_LKP_EDW_REJECTMPI) ;

GO
PRINT 'Executed view_EDW_HealthAssesment_CT.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing proc_EDW_PullHA_Temp_Data.SQL';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EDW_PullHA_Temp_Data') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_PullHA_Temp_Data;
    END;
GO
-- exec proc_EDW_PullHA_Temp_Data 12578
CREATE PROCEDURE proc_EDW_PullHA_Temp_Data
     @CTversion AS int
AS
BEGIN
/*------------------------------------------------------------------------------------------
Author	  :	 W. Dale Miller
Date		  :	 July 30. 2015
@CTversion  :	 When NULL, causes all changes to be pulled.
			 When a number is provided, only changes after that version number are processed.
			 This can save massive amounts of time and resouce if limited by last pulled version ID. 
*/
    IF OBJECT_ID ( 'tempdb..##HealthAssessmentData') IS NOT NULL
        BEGIN
            DROP TABLE
                 ##HealthAssessmentData;
        END;

    PRINT 'START the count: ' + CONVERT (varchar, SYSDATETIME () , 121) ;
    DECLARE @iCnt AS int = 0;
    SET @iCnt = (
                SELECT
                       COUNT (*) 
                       FROM VIEW_EDW_PULLHADATA_NOCT
                       WHERE
                       HAUserStarted_LastUpdateID >= @CTversion
                    OR CMSUSER_LastUpdateID >= @CTversion
                    OR USERSETTINGS_LastUpdateID >= @CTversion
                    OR USERSITE_LastUpdateID >= @CTversion
                       --or  CMSSITE_LastUpdateID >= @CTversion
                       --or  ACCT_LastUpdateID >= @CTversion
                    OR HAUSERMODULE_LastUpdateID >= @CTversion
                    OR VHCJ_LastUpdateID >= @CTversion
                    OR VHAJ_LastUpdateID >= @CTversion
                    OR HARISKCATEGORY_LastUpdateID >= @CTversion
                    OR HAUSERRISKAREA_LastUpdateID >= @CTversion
                    OR HAUSERQUESTION_LastUpdateID >= @CTversion
                    OR HAQUESTIONSVIEW_LastUpdateID >= @CTversion
                    OR HAUSERQUESTIONGROUPRESULTS_LastUpdateID >= @CTversion
                    OR HAUSERANSWERS_LastUpdateID >= @CTversion);

    PRINT 'Pending Changes: ' + CAST ( @iCnt AS nvarchar (50)) ;
    PRINT 'END the count: ' + CONVERT (varchar, SYSDATETIME () , 121) ;
    PRINT 'START the pull: ' + CONVERT (varchar, SYSDATETIME () , 121) ;

    SELECT TOP (@iCnt) 
           *
    INTO
         ##HealthAssessmentData
           FROM VIEW_EDW_PULLHADATA_NOCT
           WHERE
           HAUserStarted_LastUpdateID >= @CTversion
        OR CMSUSER_LastUpdateID >= @CTversion
        OR USERSETTINGS_LastUpdateID >= @CTversion
        OR USERSITE_LastUpdateID >= @CTversion
           --or  CMSSITE_LastUpdateID >= @CTversion
           --or  ACCT_LastUpdateID >= @CTversion
        OR HAUSERMODULE_LastUpdateID >= @CTversion
        OR VHCJ_LastUpdateID >= @CTversion
        OR VHAJ_LastUpdateID >= @CTversion
        OR HARISKCATEGORY_LastUpdateID >= @CTversion
        OR HAUSERRISKAREA_LastUpdateID >= @CTversion
        OR HAUSERQUESTION_LastUpdateID >= @CTversion
        OR HAQUESTIONSVIEW_LastUpdateID >= @CTversion
        OR HAUSERQUESTIONGROUPRESULTS_LastUpdateID >= @CTversion
        OR HAUSERANSWERS_LastUpdateID >= @CTversion;

    declare @pulledCnt as bigint = @@ROWCOUNT;

    PRINT 'END the pull: ' + CONVERT (varchar, SYSDATETIME () , 121) ;
    PRINT 'START the indexing: ' + CONVERT (varchar, SYSDATETIME () , 121) ;

    IF NOT EXISTS ( SELECT
                           name
                           FROM sys.indexes
                           WHERE name = 'temp_PI_EDW_HealthAssessment_ChangeType') 

        BEGIN

            CREATE INDEX temp_PI_EDW_HealthAssessment_ChangeType ON ##HealthAssessmentData ( ChangeType) 
            WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF ,
            ALLOW_ROW_LOCKS = ON ,
            ALLOW_PAGE_LOCKS = ON) ;
        END;

    IF NOT EXISTS ( SELECT
                           name
                           FROM sys.indexes
                           WHERE name = 'temp_PI_EDW_HealthAssessment_NATKEY') 

        BEGIN

            CREATE INDEX temp_PI_EDW_HealthAssessment_NATKEY ON dbo.##HealthAssessmentData ( UserStartedItemID , UserGUID , PKHashCode , HashCode , LastModifiedDate
            );
        END;
    PRINT 'END the indexing: ' + CONVERT (varchar, SYSDATETIME () , 121) ;
    PRINT 'Completed proc_EDW_PullHA_Temp_Data: ' + CONVERT (varchar, SYSDATETIME () , 121) ;
    return @pulledCnt ;

END;
GO
PRINT 'Executed proc_EDW_PullHA_Temp_Data.SQL';
GO 
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




GO
PRINT 'Creating proc_EDW_Populate_Staging_Tables.sql';
GO

-- use KenticoCMS_Prod2
-- exec [proc_EDW_Populate_Staging_Tables]
-- select count(*) from HFIT_HealthAssesmentUserAnswers

IF EXISTS ( SELECT
                   NAME
                   FROM SYS.PROCEDURES
                   WHERE NAME = 'proc_EDW_Populate_Staging_Tables') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_Populate_Staging_Tables;
    END;
GO

-- exec proc_EDW_Populate_Staging_Tables
CREATE PROCEDURE proc_EDW_Populate_Staging_Tables
     @LoadType AS int = 0
   , @TRACENAME AS nvarchar (100) = 'proc_EDW_Populate_Staging_Tables'
AS
BEGIN

/*------------------------------------------------------------------------------------------------------------
-------------------------------------------------------
**************************************************************************************************************
Author:	  W. Dale Miller
Created:	  06.15.2015
USE:		  exec proc_EDW_Populate_Staging_Tables
@LoadType:	 0 - Changes found with deletes, load all records in order to find deletes
			 1 - Reload ALL
			 2 - Changes found, no deletes, load only changed records
**************************************************************************************************************
*/

    -- declare @LoadType as int = 0 ;
    IF @LoadType IS NULL
        BEGIN
            SET @LoadType = 0;
        END;

    DECLARE
    @St AS datetime = GETDATE () ;
    PRINT 'proc_EDW_Populate_Staging_Tables Started: ' + CONVERT(VARCHAR, getdate(), 120) ;
    SET NOCOUNT ON;

    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @TRACENAME , '0011a - Start proc_EDW_Populate_Staging_Tables';
    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @TRACENAME , '0011b - Start proc_EDW_BuildStagingTables';
    --*************************************************************************
    EXEC proc_EDW_BuildStagingTables ;
    --*************************************************************************
    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @TRACENAME , '0011c - END proc_EDW_BuildStagingTables';

    DECLARE
    @ms AS decimal (10, 3) = 0,
    @secs AS decimal (10, 3) = 0,
    @min AS decimal (10, 3) = 0,
    @hr AS decimal (10, 3) = 0;

    SET @ms = DATEDIFF ( ms , @st , GETDATE ()) ;
    SET @secs = @ms / 1000;
    SET @min = @secs / 60;
    SET @hr = @min / 60;

    PRINT 'TIME TO BUILD STAGING TABLE DATA';
    PRINT 'TempData Loaded: ' + CONVERT(VARCHAR, getdate(), 120) ;;    
    PRINT 'Elapsed Seconds: ' + CAST ( @secs AS nvarchar (50)) ;
    PRINT 'Elapsed Minutes: ' + CAST ( @min AS nvarchar (50)) ;
    PRINT 'Elapsed Hour: ' + CAST ( @hr AS nvarchar (50)) ;    
    PRINT 'Seconds: ' + CAST ( DATEDIFF ( SECOND , @St , GETDATE ()) AS nvarchar (50)) ;

    DECLARE
    @Stpulltime AS datetime = GETDATE (),
    @Stdataload AS datetime = GETDATE () ;

    IF EXISTS (  SELECT
                        name
                        FROM tempdb.dbo.sysobjects
                        WHERE id = OBJECT_ID ( N'tempdb..##HealthAssessmentData')) 
        BEGIN
            DROP TABLE
                 ##HealthAssessmentData;
        END;

    DECLARE
    @Sttxpulltime AS datetime = GETDATE () ;

    IF @LoadType = 2
        BEGIN
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @TRACENAME , '0011d - proc_EDW_BuildStagingTables ReloadType 2';
            --***********************************************************************
		  exec proc_EDW_Reload_EDW_HealthAssessment;
	   --***********************************************************************
            DECLARE
            @Recs01 AS int = @@Rowcount;

            PRINT 'Temp HA Data Loaded: ';
            PRINT GETDATE () ;
            PRINT 'HA Data Load Seconds: ' + CAST ( DATEDIFF ( SECOND , @Stpulltime , GETDATE ()) AS nvarchar (50)) ;
            PRINT '##HealthAssessmentData rows: ' + CAST ( @Recs01 AS nvarchar (50)) ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @TRACENAME , '0011d - END ReloadType 2';
        END;
    IF @LoadType = 0
        BEGIN
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @TRACENAME , '0011d - proc_EDW_BuildStagingTables ReloadType 0';
            EXEC ('SELECT * INTO ##HealthAssessmentData FROM view_EDW_PullHAData_NoCT') ;
            DECLARE
            @Recs AS int = @@Rowcount;

            PRINT 'Temp HA Data Loaded: ';
            PRINT GETDATE () ;
            PRINT 'HA Data Load Seconds: ' + CAST ( DATEDIFF ( SECOND , @Stpulltime , GETDATE ()) AS nvarchar (50)) ;
            PRINT '##HealthAssessmentData rows: ' + CAST ( @Recs AS nvarchar (50)) ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @TRACENAME , '0011d - END ReloadType 0';
        END;
    IF @LoadType = 1
        BEGIN
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @TRACENAME , '0011d - proc_EDW_BuildStagingTables ReloadType 1';
            DECLARE
            @Startreload AS datetime = GETDATE (), @Recsall AS int = 0;
		  --****************************************************************
             exec @Recsall  = proc_EDW_Reload_EDW_HealthAssessment;
		  --****************************************************************

            DECLARE
            @Reloadsecs AS decimal ( 10 , 2) = DATEDIFF ( second , @Startreload , GETDATE ()) ;
            DECLARE
            @Reloadhrs AS decimal ( 10 , 2) = @Reloadsecs / 60 / 60;

            PRINT 'RELOAD ALL SELECTED - ' + CAST ( @Recsall AS nvarchar ( 50)) + ' records moved into DIM_EDW_HealthAssessment in' + CAST ( @Reloadhrs AS nvarchar ( 50)) + ' hours.';
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @TRACENAME , '0011d - END ReloadType 1';
        END;

    DECLARE
    @Loadtimeha AS decimal ( 10 , 2) = 0;
    DECLARE
    @SEC AS decimal ( 10 , 2) = 0;

    SET @SEC = DATEDIFF ( SECOND , @Stdataload , GETDATE ()) ;
    SET @Loadtimeha = @SEC / 60 / 60;

    PRINT 'HA Data Loaded: ';
    PRINT GETDATE () ;
    PRINT 'Total Records Loaded : ' + CAST ( @Recs AS nvarchar (50)) ;
    PRINT 'Time in Hours to load TEMP TABLE: (Hrs) ' + CAST ( @Loadtimeha AS nvarchar (50)) ;

    DECLARE
    @Stindexing AS datetime = GETDATE () ;
    IF
    @LoadType = 0
 OR @LoadType = 2
        BEGIN
            DECLARE @idxstart AS datetime = GETDATE () ;
            IF NOT EXISTS ( SELECT
                                   NAME
                                   FROM SYS.INDEXES
                                   WHERE NAME = 'temp_PI_EDW_HealthAssessment_ChangeType') 
                BEGIN
                    CREATE INDEX temp_PI_EDW_HealthAssessment_ChangeType ON ##HealthAssessmentData ( CHANGETYPE) WITH ( PAD_INDEX = OFF , STATISTICS_NORECOMPUTE = OFF , SORT_IN_TEMPDB = OFF , DROP_EXISTING = OFF , ONLINE = OFF , ALLOW_ROW_LOCKS = ON , ALLOW_PAGE_LOCKS = ON) ;
                END;
            IF NOT EXISTS ( SELECT
                                   NAME
                                   FROM SYS.INDEXES
                                   WHERE NAME = 'temp_PI_EDW_HealthAssessment_NATKEY') 
                BEGIN
                    CREATE CLUSTERED INDEX TEMP_PI_EDW_HealthAssessment_NATKEY ON DBO.##HealthAssessmentData ( USERSTARTEDITEMID , USERGUID , PKHASHCODE , HASHCODE , DeletedFlg, LASTMODIFIEDDATE) ;
                END;
            DECLARE @idxms  AS decimal (10, 3) = 0;
            SET @idxms = DATEDIFF (ms, @idxstart, GETDATE ()) ;
            SET @idxms = @idxms / 1000;    --seconds
            SET @idxms = @idxms / 60;	    --minutes
            SET @idxms = @idxms / 60;	    --hours
            PRINT 'Time to create TEMP Index (mins): ' + CAST (@idxms * 60 AS nvarchar (50)) ;
            PRINT 'Time to create TEMP Index (hrs): ' + CAST (@idxms AS nvarchar (50)) ;
        END;
    DECLARE
    @millisec AS decimal (10, 3) = 0;
    DECLARE
    @seconds AS decimal (10, 3) = 0;
    DECLARE
    @minutes AS decimal (10, 3) = 0;
    DECLARE
    @hours AS decimal (10, 3) = 0;
    SET @millisec = DATEDIFF ( ms , @st , GETDATE ()) ;
    SET @seconds = @millisec / 1000;
    SET @minutes = @seconds / 60;
    SET @hours = @minutes / 60;
    PRINT 'TIME TO COMPLETE proc_EDW_Populate_Staging_Tables:';
    PRINT 'Elapsed Seconds: ' + CAST ( @seconds AS nvarchar (50)) ;
    PRINT 'Elapsed Minutes: ' + CAST ( @minutes AS nvarchar (50)) ;
    PRINT 'Elapsed Hour: ' + CAST ( @hours AS nvarchar (50)) ;
    PRINT 'TOTAL ROWS: ' + CAST ( @Recs AS nvarchar (50)) ;
    PRINT 'Process Started:';
    PRINT @St;
    PRINT 'Process Ended:';
    PRINT GETDATE () ;
    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @TRACENAME , '0011e -END proc_EDW_BuildStagingTables ReloadType';
    RETURN @Recs;
END;
GO
PRINT 'Created proc_EDW_Populate_Staging_Tables.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_EDW_Reload_EDW_HealthAssessment.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EDW_Reload_EDW_HealthAssessment') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_Reload_EDW_HealthAssessment
    END;

GO
-- exec proc_EDW_Reload_EDW_HealthAssessment
CREATE PROCEDURE proc_EDW_Reload_EDW_HealthAssessment
AS
BEGIN

    DECLARE @i AS bigint = 0;
    truncate TABLE DIM_EDW_HealthAssessment;

INSERT INTO DIM_EDW_HealthAssessment
(
     UserStartedITEMID
      , HEALTHASSESMENTUserStartedNODEGUID 
      , USERID 
      , USERGUID 
      , HFITUSERMPINUMBER 
      , SITEGUID 
      , ACCOUNTID 
      , ACCOUNTCD 
      , ACCOUNTNAME 
      , HASTARTEDDT 
      , HACOMPLETEDDT 
      , USERMODULEITEMID 
      , USERMODULECODENAME 
      , HAMODULENODEGUID 
      , CMSNODEGUID 
      , HAMODULEVERSIONID 
      , USERRISKCATEGORYITEMID 
      , USERRISKCATEGORYCODENAME 
      , HARISKCATEGORYNODEGUID 
      , HARISKCATEGORYVERSIONID 
      , USERRISKAREAITEMID 
      , USERRISKAREACODENAME 
      , HARISKAREANODEGUID 
      , HARISKAREAVERSIONID 
      , USERQUESTIONITEMID 
      , TITLE 
      , HAQUESTIONGUID 
      , USERQUESTIONCODENAME 
      , HAQUESTIONDOCUMENTID 
      , HAQUESTIONVERSIONID 
      , HAQUESTIONNODEGUID 
      , USERANSWERITEMID 
      , HAANSWERNODEGUID 
      , HAANSWERVERSIONID 
      , USERANSWERCODENAME 
      , HAANSWERVALUE 
      , HAMODULESCORE 
      , HARISKCATEGORYSCORE 
      , HARISKAREASCORE 
      , HAQUESTIONSCORE 
      , HAANSWERPOINTS 
      , POINTRESULTS 
      , UOMCODE 
      , HASCORE 
      , MODULEPREWEIGHTEDSCORE 
      , RISKCATEGORYPREWEIGHTEDSCORE 
      , RISKAREAPREWEIGHTEDSCORE 
      , QUESTIONPREWEIGHTEDSCORE 
      , QUESTIONGROUPCODENAME 
      , ITEMCREATEDWHEN 
      , ITEMMODIFIEDWHEN 
      , ISPROFESSIONALLYCOLLECTED 
      , HARISKCATEGORY_ITEMMODIFIEDWHEN 
      , HAUSERRISKAREA_ITEMMODIFIEDWHEN 
      , HAUSERQUESTION_ITEMMODIFIEDWHEN 
      , HAUSERANSWERS_ITEMMODIFIEDWHEN 
      , HAPAPERFLG 
      , HATELEPHONICFLG 
      , HASTARTEDMODE 
      , HACOMPLETEDMODE 
      , DOCUMENTCULTURE_VHCJ 
      , DOCUMENTCULTURE_HAQUESTIONSVIEW 
      , CAMPAIGNNODEGUID 
      , HACAMPAIGNID 
      , HASHCODE 
      , PKHASHCODE 
      , CHANGED_FLG 
      , LASTMODIFIEDDATE 
      , HEALTHASSESSMENTTYPE 
      --, HAUserStarted_LASTMODIFIED 
      --, CMSUSER_LASTMODIFIED 
      --, USERSETTINGS_LASTMODIFIED 
      --, USERSITE_LASTMODIFIED 
      --, CMSSITE_LASTMODIFIED 
      --, ACCT_LASTMODIFIED 
      --, HAUSERMODULE_LASTMODIFIED 
      --, VHCJ_LASTMODIFIED 
      --, VHAJ_LASTMODIFIED 
      --, HARISKCATEGORY_LASTMODIFIED 
      --, HAUSERRISKAREA_LASTMODIFIED 
      --, HAUSERQUESTION_LASTMODIFIED 
      --, HAQUESTIONSVIEW_LASTMODIFIED 
      --, HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED 
      --, HAUSERANSWERS_LASTMODIFIED 
      --, HAUserStarted_LastUpdateID 
      --, CMSUSER_LastUpdateID 
      --, USERSETTINGS_LastUpdateID 
      --, USERSITE_LastUpdateID 
      --, ACCT_LastUpdateID 
      --, HAUSERMODULE_LastUpdateID 
      --, VHCJ_LastUpdateID 
      --, VHAJ_LastUpdateID 
      --, HARISKCATEGORY_LastUpdateID 
      --, HAUSERRISKAREA_LastUpdateID 
      --, HAUSERQUESTION_LastUpdateID 
      --, HAQUESTIONSVIEW_LastUpdateID 
      --, HAUSERQUESTIONGROUPRESULTS_LastUpdateID 
      --, HAUSERANSWERS_LastUpdateID 
      --, LASTUPDATEID 
      --, DELETEFLG 
      , SVR 
      , DBNAME 
      , DELETEDFLG 
      , ChangeType )
 SELECT 
     UserStartedITEMID
     , HEALTHASSESMENTUserStartedNODEGUID 
     , USERID 
     , USERGUID 
     , HFITUSERMPINUMBER 
     , SITEGUID 
     , ACCOUNTID 
     , ACCOUNTCD 
     , ACCOUNTNAME 
     , HASTARTEDDT 
     , HACOMPLETEDDT 
     , USERMODULEITEMID 
     , USERMODULECODENAME 
     , HAMODULENODEGUID 
     , CMSNODEGUID 
     , HAMODULEVERSIONID 
     , USERRISKCATEGORYITEMID 
     , USERRISKCATEGORYCODENAME 
     , HARISKCATEGORYNODEGUID 
     , HARISKCATEGORYVERSIONID 
     , USERRISKAREAITEMID 
     , USERRISKAREACODENAME 
     , HARISKAREANODEGUID 
     , HARISKAREAVERSIONID 
     , USERQUESTIONITEMID 
     , TITLE 
     , HAQUESTIONGUID 
     , USERQUESTIONCODENAME 
     , HAQUESTIONDOCUMENTID 
     , HAQUESTIONVERSIONID 
     , HAQUESTIONNODEGUID 
     , USERANSWERITEMID 
     , HAANSWERNODEGUID 
     , HAANSWERVERSIONID 
     , USERANSWERCODENAME 
     , HAANSWERVALUE 
     , HAMODULESCORE 
     , HARISKCATEGORYSCORE 
     , HARISKAREASCORE 
     , HAQUESTIONSCORE 
     , HAANSWERPOINTS 
     , POINTRESULTS 
     , UOMCODE 
     , HASCORE 
     , MODULEPREWEIGHTEDSCORE 
     , RISKCATEGORYPREWEIGHTEDSCORE 
     , RISKAREAPREWEIGHTEDSCORE 
     , QUESTIONPREWEIGHTEDSCORE 
     , QUESTIONGROUPCODENAME 
     , ITEMCREATEDWHEN 
     , ITEMMODIFIEDWHEN 
     , ISPROFESSIONALLYCOLLECTED 
     , HARISKCATEGORY_ITEMMODIFIEDWHEN 
     , HAUSERRISKAREA_ITEMMODIFIEDWHEN 
     , HAUSERQUESTION_ITEMMODIFIEDWHEN 
     , HAUSERANSWERS_ITEMMODIFIEDWHEN 
     , HAPAPERFLG 
     , HATELEPHONICFLG 
     , HASTARTEDMODE 
     , HACOMPLETEDMODE 
     , DOCUMENTCULTURE_VHCJ 
     , DOCUMENTCULTURE_HAQUESTIONSVIEW 
     , CAMPAIGNNODEGUID 
     , HACAMPAIGNID 
     , HASHCODE 
     , PKHASHCODE 
     , CHANGED_FLG 
     , LASTMODIFIEDDATE 
     , HEALTHASSESSMENTTYPE 
     --, HAUserStarted_LASTMODIFIED 
     --, CMSUSER_LASTMODIFIED 
     --, USERSETTINGS_LASTMODIFIED 
     --, USERSITE_LASTMODIFIED 
     --, CMSSITE_LASTMODIFIED 
     --, ACCT_LASTMODIFIED 
     --, HAUSERMODULE_LASTMODIFIED 
     --, VHCJ_LASTMODIFIED 
     --, VHAJ_LASTMODIFIED 
     --, HARISKCATEGORY_LASTMODIFIED 
     --, HAUSERRISKAREA_LASTMODIFIED 
     --, HAUSERQUESTION_LASTMODIFIED 
     --, HAQUESTIONSVIEW_LASTMODIFIED 
     --, HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED 
     --, HAUSERANSWERS_LASTMODIFIED 
     --, HAUserStarted_LastUpdateID 
     --, CMSUSER_LastUpdateID 
     --, USERSETTINGS_LastUpdateID 
     --, USERSITE_LastUpdateID 
     --, ACCT_LastUpdateID 
     --, HAUSERMODULE_LastUpdateID 
     --, VHCJ_LastUpdateID 
     --, VHAJ_LastUpdateID 
     --, HARISKCATEGORY_LastUpdateID 
     --, HAUSERRISKAREA_LastUpdateID 
     --, HAUSERQUESTION_LastUpdateID 
     --, HAQUESTIONSVIEW_LastUpdateID 
     --, HAUSERQUESTIONGROUPRESULTS_LastUpdateID 
     --, HAUSERANSWERS_LastUpdateID 
     --, LASTUPDATEID 
     --, DELETEFLG 
     , SVR 
     , DBNAME 
     , DELETEDFLG 
     , ChangeType 
         --     , NULL AS RowNbr
         --, NULL AS TimeZone
         --, NULL AS ConvertedToCentralTime
           FROM view_EDW_PullHAData_NoCT;

    SET @i = @@ROWCOUNT;

    PRINT 'Relaoded ' + CAST (@i AS nvarchar (50)) + ' records.';
    RETURN @i;

END;


GO
PRINT 'Executed proc_EDW_Reload_EDW_HealthAssessment.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*-----------------------------------
SELECT TOP 100
       *
       FROM dbo.DIM_EDW_PkHashkey;

UPDATE STAGED_EDW_PkHashkey
       SET
           ChangeDate = GETDATE () 
WHERE
      rOWnBR IN (1101071, 362) ;
*/
GO
PRINT 'Executing proc_Create_STAGED_EDW_PkHashkey_TBL.SQL';

GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Create_STAGED_EDW_PkHashkey_TBL') 
    BEGIN
        DROP PROCEDURE
             proc_Create_STAGED_EDW_PkHashkey_TBL;
    END;

GO
-- exec proc_Create_STAGED_EDW_PkHashkey_TBL
--drop table STAGED_EDW_PkHashkey
CREATE PROCEDURE proc_Create_STAGED_EDW_PkHashkey_TBL
AS
BEGIN

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE name = 'STAGED_EDW_PkHashkey') 
        BEGIN
            PRINT 'Creating STAGED_EDW_PkHashkey';
            CREATE TABLE dbo.DIM_EDW_PkHashkey (
                         HAUSERSTARTED_ITEMID int NULL
                       ,USERGUID uniqueidentifier NOT NULL
                       ,HASHCODE nvarchar (100) NULL
                       ,PKHASHCODE nvarchar (100) NULL
                       ,RowNbr int IDENTITY (1, 1) 
                                   NOT NULL
                       ,ChangeType nchar (1) NULL
                       ,ChangeDate datetime NULL
                       ,DeletedFlg bit NULL
                       ,SVR nvarchar (100) NULL
                       ,DBNAME nvarchar (100) NULL
            );

            ALTER TABLE dbo.DIM_EDW_PkHashkey
            ADD
                        CONSTRAINT DF_STAGED_EDW_PkHashkey_SVR  DEFAULT @@servername FOR SVR;
            ALTER TABLE dbo.DIM_EDW_PkHashkey
            ADD
                        CONSTRAINT DF_STAGED_EDW_PkHashkey_DBNAME  DEFAULT DB_NAME () FOR DBNAME;

            CREATE CLUSTERED INDEX PK_STAGED_EDW_PkHashkey ON dbo.DIM_EDW_PkHashkey
            (
            PKHASHCODE ASC,
            HAUSERSTARTED_ITEMID ASC,
            USERGUID ASC,
            HASHCODE ASC,
            DeletedFlg
            );

            CREATE NONCLUSTERED INDEX CI_STAGED_EDW_PkHashkey_ChangeDate ON dbo.DIM_EDW_PkHashkey
            (
            ChangeDate ASC, RowNbr
            ) 
            INCLUDE ( 	HAUSERSTARTED_ITEMID,
            HASHCODE,
            PKHASHCODE,
            ChangeType,
            DeletedFlg) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ;

            INSERT INTO STAGED_EDW_PkHashkey
            (
                   HAUSERSTARTED_ITEMID
                 , USERGUID
                 , HASHCODE
                 , PKHASHCODE) 
            SELECT
                   HAUSERSTARTED.ITEMID AS HAUSERSTARTED_ITEMID
                 , USERGUID
                 , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUSERSTARTED.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.USERID AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( USERSETTINGS.HFITUSERMPINUMBER AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTNAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASTARTEDDT AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACOMPLETEDDT AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS nvarchar (100)) , '-') + ISNULL ( LEFT ( HAQUESTIONSVIEW.TITLE , 1000) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERVALUE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULESCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREASCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERPOINTS AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.POINTRESULTS AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.UOMCODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMCREATEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HAPAPERFLG AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HATELEPHONICFLG AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASTARTEDMODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACOMPLETEDMODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACAMPAIGNNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHCJ.HACAMPAIGNID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-')) AS varchar (100)) AS HASHCODE
                 , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUSERSTARTED.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( USERGUID AS varchar (50)) , '-') + ISNULL ( CAST ( SITEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCOUNTCD AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAMODULENODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORYNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS varchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKAREANODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS varchar (50)) , '-') + ISNULL ( CAST ( HAQUESTIONNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAANSWERNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACAMPAIGNNODEGUID AS varchar (50)) , '-')) AS varchar (100)) AS PKHASHCODE
                   FROM
                       DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED AS HAUSERSTARTED
                           INNER JOIN DIM_EDW_CMS_USER AS CMSUSER
                               ON HAUSERSTARTED.USERID = CMSUSER.USERID
                           INNER JOIN DIM_EDW_CMS_USERSETTINGS AS USERSETTINGS
                               ON USERSETTINGS.USERSETTINGSUSERID = CMSUSER.USERID
                              AND HFITUSERMPINUMBER >= 0
                              AND HFITUSERMPINUMBER IS NOT NULL
                           INNER JOIN DIM_EDW_CMS_USERSITE AS USERSITE
                               ON CMSUSER.USERID = USERSITE.USERID
                           INNER JOIN DBO.CMS_SITE AS CMSSITE
                               ON USERSITE.SITEID = CMSSITE.SITEID
                           INNER JOIN DBO.HFIT_ACCOUNT AS ACCT
                               ON ACCT.SITEID = CMSSITE.SITEID
                           INNER JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE
                               ON HAUSERSTARTED.ITEMID = HAUSERMODULE.HASTARTEDITEMID
                           INNER JOIN DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED AS VHCJ
                               ON VHCJ.NODEGUID = HAUSERSTARTED.HACAMPAIGNNODEGUID
                              AND VHCJ.NODESITEID = USERSITE.SITEID
                              AND VHCJ.DOCUMENTCULTURE = 'en-US'
                           INNER JOIN DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED AS VHAJ
                               ON VHAJ.DOCUMENTID = VHCJ.HEALTHASSESSMENTID
                           INNER JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY
                               ON HAUSERMODULE.ITEMID = HARISKCATEGORY.HAMODULEITEMID
                           INNER JOIN DIM_EDW_HFit_HealthAssesmentUserRiskArea AS HAUSERRISKAREA
                               ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
                           INNER JOIN DIM_EDW_HFit_HealthAssesmentUserQuestion AS HAUSERQUESTION
                               ON HAUSERRISKAREA.ITEMID = HAUSERQUESTION.HARISKAREAITEMID
                           INNER JOIN DIM_EDW_View_EDW_HealthAssesmentQuestions AS HAQUESTIONSVIEW
                               ON HAUSERQUESTION.HAQUESTIONNODEGUID = HAQUESTIONSVIEW.NODEGUID
                           LEFT OUTER JOIN DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults AS HAUSERQUESTIONGROUPRESULTS
                               ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
                           INNER JOIN DIM_EDW_HFIT_HealthAssesmentUserAnswers AS HAUSERANSWERS
                               ON HAUSERQUESTION.ITEMID = HAUSERANSWERS.HAQUESTIONITEMID --Add in the change tracking data
                   WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
                         SELECT
                                REJECTMPICODE
                                FROM HFIT_LKP_EDW_REJECTMPI);

        END;
END;

GO
DECLARE @i AS int = 0;
EXEC @i = proc_QuickRowCount 'STAGED_EDW_PkHashkey';
PRINT 'Rows processed: ' + CAST (@i AS nvarchar (50)) ;
PRINT 'Executed proc_Create_STAGED_EDW_PkHashkey_TBL.SQL';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing view_EDW_PullHAData_NoCT.sql';
GO
IF EXISTS ( SELECT
                   NAME
              FROM SYS.VIEWS
              WHERE
              NAME = 'view_EDW_PullHAData_NoCT')
    BEGIN
        DROP VIEW
             DBO.VIEW_EDW_PULLHADATA_NOCT;
    END;
GO
/*
select top 10000 * from VIEW_EDW_PULLHADATA_NOCT
where
	   HAUserStarted_LastUpdateID > 0
        or  CMSUSER_LastUpdateID > 0
        or  USERSETTINGS_LastUpdateID > 0
        or  USERSITE_LastUpdateID > 0
        --or  CMSSITE_LastUpdateID > 0
        --or  ACCT_LastUpdateID > 0
        or  HAUSERMODULE_LastUpdateID > 0
        or  VHCJ_LastUpdateID > 0
        or  VHAJ_LastUpdateID > 0
        or  HARISKCATEGORY_LastUpdateID > 0
        or  HAUSERRISKAREA_LastUpdateID > 0
        or  HAUSERQUESTION_LastUpdateID > 0
        or  HAQUESTIONSVIEW_LastUpdateID > 0
        or  HAUSERQUESTIONGROUPRESULTS_LastUpdateID > 0
        or  HAUSERANSWERS_LastUpdateID > 0

select top 1000 * 
into #xxx
from VIEW_EDW_PULLHADATA_NOCT
where
        HAUserStarted_LASTMODIFIED > '2015-07-28'
        OR CMSUSER_LASTMODIFIED > '2015-07-28'
        OR USERSETTINGS_LASTMODIFIED > '2015-07-28'
        OR USERSITE_LASTMODIFIED > '2015-07-28'
        OR CMSSITE_LASTMODIFIED > '2015-07-28'
        OR ACCT_LASTMODIFIED > '2015-07-28'
        OR HAUSERMODULE_LASTMODIFIED > '2015-07-28'
        OR VHCJ_LASTMODIFIED > '2015-07-28'
        OR VHAJ_LASTMODIFIED > '2015-07-28'
        OR HARISKCATEGORY_LASTMODIFIED > '2015-07-28'
        OR HAUSERRISKAREA_LASTMODIFIED > '2015-07-28'
        OR HAUSERQUESTION_LASTMODIFIED > '2015-07-28'
        OR HAQUESTIONSVIEW_LASTMODIFIED > '2015-07-28'
        OR HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED > '2015-07-28'
        OR HAUSERANSWERS_LASTMODIFIED > '2015-07-28'

*/

create VIEW VIEW_EDW_PULLHADATA_NOCT
    WITH SCHEMABINDING
AS SELECT
          HAUserStarted.ITEMID AS UserStartedITEMID
        , VHAJ.NODEGUID AS HEALTHASSESMENTUserStartedNODEGUID
        , HAUserStarted.USERID
        , CMSUSER.USERGUID
        , USERSETTINGS.HFITUSERMPINUMBER
        , CMSSITE.SITEGUID
        , ACCT.ACCOUNTID
        , ACCT.ACCOUNTCD
        , ACCT.ACCOUNTNAME
        , HAUserStarted.HASTARTEDDT
        , HAUserStarted.HACOMPLETEDDT
        , HAUSERMODULE.ITEMID AS USERMODULEITEMID
        , HAUSERMODULE.CODENAME AS USERMODULECODENAME
        , HAUSERMODULE.HAMODULENODEGUID
        , VHAJ.NODEGUID AS CMSNODEGUID
        , NULL AS HAMODULEVERSIONID
        , HARISKCATEGORY.ITEMID AS USERRISKCATEGORYITEMID
        , HARISKCATEGORY.CODENAME AS USERRISKCATEGORYCODENAME
        , HARISKCATEGORY.HARISKCATEGORYNODEGUID
        , NULL AS HARISKCATEGORYVERSIONID
        , HAUSERRISKAREA.ITEMID AS USERRISKAREAITEMID
        , HAUSERRISKAREA.CODENAME AS USERRISKAREACODENAME
        , HAUSERRISKAREA.HARISKAREANODEGUID
        , NULL AS HARISKAREAVERSIONID
        , HAUSERQUESTION.ITEMID AS USERQUESTIONITEMID
        , HAQUESTIONSVIEW.TITLE
        , HAUSERQUESTION.HAQUESTIONNODEGUID AS HAQUESTIONGUID
        , HAUSERQUESTION.CODENAME AS USERQUESTIONCODENAME
        , NULL AS HAQUESTIONDOCUMENTID
        , NULL AS HAQUESTIONVERSIONID
        , HAUSERQUESTION.HAQUESTIONNODEGUID
        , HAUSERANSWERS.ITEMID AS USERANSWERITEMID
        , HAUSERANSWERS.HAANSWERNODEGUID
        , NULL AS HAANSWERVERSIONID
        , HAUSERANSWERS.CODENAME AS USERANSWERCODENAME
        , HAUSERANSWERS.HAANSWERVALUE
        , HAUSERMODULE.HAMODULESCORE
        , HARISKCATEGORY.HARISKCATEGORYSCORE
        , HAUSERRISKAREA.HARISKAREASCORE
        , HAUSERQUESTION.HAQUESTIONSCORE
        , HAUSERANSWERS.HAANSWERPOINTS
        , HAUSERQUESTIONGROUPRESULTS.POINTRESULTS
        , HAUSERANSWERS.UOMCODE
        , HAUserStarted.HASCORE
        , HAUSERMODULE.PREWEIGHTEDSCORE AS MODULEPREWEIGHTEDSCORE
        , HARISKCATEGORY.PREWEIGHTEDSCORE AS RISKCATEGORYPREWEIGHTEDSCORE
        , HAUSERRISKAREA.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
        , HAUSERQUESTION.PREWEIGHTEDSCORE AS QUESTIONPREWEIGHTEDSCORE
        , HAUSERQUESTIONGROUPRESULTS.CODENAME AS QUESTIONGROUPCODENAME

          --, COALESCE ( CT_CMS_USER.SYS_CHANGE_OPERATION , CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION , CT_CMS_SITE.SYS_CHANGE_OPERATION , CT_CMS_USERSITE.SYS_CHANGE_OPERATION , CT_HFIT_ACCOUNT.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUserStarted.SYS_CHANGE_OPERATION) AS CHANGETYPE

        , HAUSERANSWERS.ITEMCREATEDWHEN
        , HAUSERANSWERS.ITEMMODIFIEDWHEN
        , HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED
        , HARISKCATEGORY.ITEMMODIFIEDWHEN AS HARISKCATEGORY_ITEMMODIFIEDWHEN
        , HAUSERRISKAREA.ITEMMODIFIEDWHEN AS HAUSERRISKAREA_ITEMMODIFIEDWHEN
        , HAUSERQUESTION.ITEMMODIFIEDWHEN AS HAUSERQUESTION_ITEMMODIFIEDWHEN
        , HAUSERANSWERS.ITEMMODIFIEDWHEN AS HAUSERANSWERS_ITEMMODIFIEDWHEN
        , HAUserStarted.HAPAPERFLG
        , HAUserStarted.HATELEPHONICFLG
        , HAUserStarted.HASTARTEDMODE
        , HAUserStarted.HACOMPLETEDMODE
        , VHCJ.DOCUMENTCULTURE AS DOCUMENTCULTURE_VHCJ
        , HAQUESTIONSVIEW.DOCUMENTCULTURE AS DOCUMENTCULTURE_HAQUESTIONSVIEW
        , HAUserStarted.HACAMPAIGNNODEGUID AS CAMPAIGNNODEGUID
        , VHCJ.HACAMPAIGNID
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ITEMID AS nvarchar(100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUserStarted.USERID AS nvarchar(100)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( USERSETTINGS.HFITUSERMPINUMBER AS nvarchar(100)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS nvarchar(100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS nvarchar(100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTNAME AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASTARTEDDT AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACOMPLETEDDT AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.CODENAME AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS nvarchar(100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS nvarchar(100)) , '-') + ISNULL ( LEFT ( HAQUESTIONSVIEW.TITLE , 1000) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.CODENAME AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERVALUE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULESCORE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYSCORE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREASCORE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONSCORE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERPOINTS AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.POINTRESULTS AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.UOMCODE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASCORE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.PREWEIGHTEDSCORE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.PREWEIGHTEDSCORE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.PREWEIGHTEDSCORE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.PREWEIGHTEDSCORE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.CODENAME AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMCREATEDWHEN AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED AS nvarchar(100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMMODIFIEDWHEN AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMMODIFIEDWHEN AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMMODIFIEDWHEN AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAPAPERFLG AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUserStarted.HATELEPHONICFLG AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASTARTEDMODE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACOMPLETEDMODE AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACAMPAIGNNODEGUID AS nvarchar(100)) , '-') + ISNULL ( CAST ( VHCJ.HACAMPAIGNID AS nvarchar(100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar(100)) , '-')) AS varchar(100)) AS HASHCODE
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ITEMID AS varchar(50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar(50)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS varchar(50)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS varchar(50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS varchar(50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS varchar(50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar(50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS varchar(50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS varchar(50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS varchar(100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS varchar(50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS varchar(50)) , '-') + ISNULL ( CAST ( HAUserStarted.HACAMPAIGNNODEGUID AS varchar(50)) , '-')) AS varchar(100)) AS PKHASHCODE

          --, COALESCE ( CT_CMS_USER.USERID , CT_CMS_USERSETTINGS.USERSETTINGSID , CT_CMS_SITE.SITEID , CT_CMS_USERSITE.USERSITEID , CT_HFIT_ACCOUNT.ACCOUNTID , CT_HFIT_HealthAssesmentUserAnswers.ITEMID , CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID , CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID , CT_HFIT_HEALTHASSESMENTUserStarted.ITEMID) AS CHANGED_FLG

        , NULL AS CHANGED_FLG
        , HAUSERANSWERS.ITEMMODIFIEDWHEN AS LASTMODIFIEDDATE        
        , CASE
          WHEN HAUserStarted.HADOCUMENTCONFIGID IS NULL
              THEN 'SHORT_VER'
          WHEN HAUserStarted.HADOCUMENTCONFIGID IS NOT NULL
              THEN 'LONG_VER'
              ELSE 'UNKNOWN'
          END AS HEALTHASSESSMENTTYPE    
    
        , HAUserStarted.LASTLOADEDDATE AS HAUserStarted_LASTMODIFIED
        , CMSUSER.LASTLOADEDDATE AS CMSUSER_LASTMODIFIED
        , USERSETTINGS.LASTLOADEDDATE AS USERSETTINGS_LASTMODIFIED
        , USERSITE.LASTLOADEDDATE AS USERSITE_LASTMODIFIED
        , CMSSITE.SITELASTMODIFIED AS CMSSITE_LASTMODIFIED
        , ACCT.ITEMMODIFIEDWHEN AS ACCT_LASTMODIFIED
        , HAUSERMODULE.LASTLOADEDDATE AS HAUSERMODULE_LASTMODIFIED
        , VHCJ.LASTLOADEDDATE AS VHCJ_LASTMODIFIED
        , VHAJ.LASTLOADEDDATE AS VHAJ_LASTMODIFIED
        , HARISKCATEGORY.LASTLOADEDDATE AS HARISKCATEGORY_LASTMODIFIED
        , HAUSERRISKAREA.LASTLOADEDDATE AS HAUSERRISKAREA_LASTMODIFIED
        , HAUSERQUESTION.LASTLOADEDDATE AS HAUSERQUESTION_LASTMODIFIED
        , HAQUESTIONSVIEW.LASTLOADEDDATE AS HAQUESTIONSVIEW_LASTMODIFIED
        , HAUSERQUESTIONGROUPRESULTS.LASTLOADEDDATE AS HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED
        , HAUSERANSWERS.LASTLOADEDDATE AS HAUSERANSWERS_LASTMODIFIED

	   , HAUserStarted.LastUpdateID AS HAUserStarted_LastUpdateID
        , CMSUSER.LastUpdateID AS CMSUSER_LastUpdateID
        , USERSETTINGS.LastUpdateID AS USERSETTINGS_LastUpdateID
        , USERSITE.LastUpdateID AS USERSITE_LastUpdateID
        --, CMSSITE.LastUpdateID AS CMSSITE_LastUpdateID
        , ACCT.ItemModifiedWhen AS ACCT_LastUpdateID
        , HAUSERMODULE.LastUpdateID AS HAUSERMODULE_LastUpdateID
        , VHCJ.LastUpdateID AS VHCJ_LastUpdateID
        , VHAJ.LastUpdateID AS VHAJ_LastUpdateID
        , HARISKCATEGORY.LastUpdateID AS HARISKCATEGORY_LastUpdateID
        , HAUSERRISKAREA.LastUpdateID AS HAUSERRISKAREA_LastUpdateID
        , HAUSERQUESTION.LastUpdateID AS HAUSERQUESTION_LastUpdateID
        , HAQUESTIONSVIEW.LastUpdateID AS HAQUESTIONSVIEW_LastUpdateID
        , HAUSERQUESTIONGROUPRESULTS.LastUpdateID AS HAUSERQUESTIONGROUPRESULTS_LastUpdateID
        , HAUSERANSWERS.LastUpdateID AS HAUSERANSWERS_LastUpdateID

	   , 0 AS LASTUPDATEID
	   , 0 AS DELETEFLG
        , @@Servername AS SVR
        , DB_NAME () AS DBNAME
        , 0 AS DELETEDFLG
	   , null as ChangeType 
     FROM
          DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED AS HAUserStarted
          INNER JOIN DBO.DIM_EDW_CMS_USER AS CMSUSER
              ON HAUserStarted.USERID = CMSUSER.USERID
          INNER JOIN DBO.DIM_EDW_CMS_USERSETTINGS AS USERSETTINGS
              ON USERSETTINGS.USERSETTINGSUSERID = CMSUSER.USERID
             AND USERSETTINGS.HFITUSERMPINUMBER >= 0
             AND USERSETTINGS.HFITUSERMPINUMBER IS NOT NULL
          INNER JOIN DBO.DIM_EDW_CMS_USERSITE AS USERSITE
              ON CMSUSER.USERID = USERSITE.USERID
          INNER JOIN DBO.CMS_SITE AS CMSSITE
              ON USERSITE.SITEID = CMSSITE.SITEID
          INNER JOIN DBO.HFIT_ACCOUNT AS ACCT
              ON ACCT.SITEID = CMSSITE.SITEID
          INNER JOIN DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE
              ON HAUserStarted.ITEMID = HAUSERMODULE.HASTARTEDITEMID
          INNER JOIN DBO.DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED AS VHCJ
              ON VHCJ.NODEGUID = HAUserStarted.HACAMPAIGNNODEGUID
             AND VHCJ.NODESITEID = USERSITE.SITEID
             AND VHCJ.DOCUMENTCULTURE = 'en-US'
          INNER JOIN DBO.DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED AS VHAJ
              ON VHAJ.DOCUMENTID = VHCJ.HEALTHASSESSMENTID
          INNER JOIN DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY
              ON HAUSERMODULE.ITEMID = HARISKCATEGORY.HAMODULEITEMID
          INNER JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserRiskArea AS HAUSERRISKAREA
              ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
          INNER JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserQuestion AS HAUSERQUESTION
              ON HAUSERRISKAREA.ITEMID = HAUSERQUESTION.HARISKAREAITEMID
          INNER JOIN DBO.DIM_EDW_View_EDW_HealthAssesmentQuestions AS HAQUESTIONSVIEW
              ON HAUSERQUESTION.HAQUESTIONNODEGUID = HAQUESTIONSVIEW.NODEGUID
          LEFT JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserQuestionGROUPRESULTS AS HAUSERQUESTIONGROUPRESULTS
              ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
          INNER JOIN DBO.DIM_EDW_HFIT_HealthAssesmentUserAnswers AS HAUSERANSWERS
              ON HAUSERQUESTION.ITEMID = HAUSERANSWERS.HAQUESTIONITEMID
     WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
           SELECT
                  HFIT_LKP_EDW_REJECTMPI.REJECTMPICODE
             FROM DBO.HFIT_LKP_EDW_REJECTMPI);
GO

--CREATE unique clustered INDEX [PI_view_EDW_PullHAData_IDX] ON [dbo].[view_EDW_PullHAData_NoCT]
--(
--UserStartedITEMID
--, PkHashCode
--)
--GO
--CREATE unique clustered INDEX [PI_view_EDW_PullHAData_IDX_DATES] ON [dbo].[view_EDW_PullHAData_NoCT]
--(
--HAUserStarted_LastModified
--, CMSUSER_LastModified
--, USERSETTINGS_LastModified
--, USERSITE_LastModified
--, CMSSITE_LastModified
--, ACCT_LastModified
--, HAUSERMODULE_LastModified
--, VHCJ_LastModified
--, VHAJ_LastModified
--, HARISKCATEGORY_LastModified
--, HAUSERRISKAREA_LastModified
--, HAUSERQUESTION_LastModified
--, HAQUESTIONSVIEW_LastModified
--, HAUSERQUESTIONGROUPRESULTS_LastModified
--, HAUSERANSWERS_LastModified
--)

GO
PRINT 'Executed view_EDW_PullHAData_NoCT.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing view_EDW_PullHAData_NoCT_Inserts.sql';
GO
IF EXISTS ( SELECT
                   NAME
                   FROM SYS.VIEWS
                   WHERE
                   NAME = 'view_EDW_PullHAData_NoCT_Inserts') 
    BEGIN
        DROP VIEW
             DBO.view_EDW_PullHAData_NoCT_Inserts;
    END;
GO
/*---------------------------------------------------------------
select * from view_EDW_PullHAData_NoCT_Inserts
where
	   HAUserStarted_LastUpdateID > 0
        or  CMSUSER_LastUpdateID > 0
        or  USERSETTINGS_LastUpdateID > 0
        or  USERSITE_LastUpdateID > 0
        --or  CMSSITE_LastUpdateID > 0
        --or  ACCT_LastUpdateID > 0
        or  HAUSERMODULE_LastUpdateID > 0
        or  VHCJ_LastUpdateID > 0
        or  VHAJ_LastUpdateID > 0
        or  HARISKCATEGORY_LastUpdateID > 0
        or  HAUSERRISKAREA_LastUpdateID > 0
        or  HAUSERQUESTION_LastUpdateID > 0
        or  HAQUESTIONSVIEW_LastUpdateID > 0
        or  HAUSERQUESTIONGROUPRESULTS_LastUpdateID > 0
        or  HAUSERANSWERS_LastUpdateID > 0

select top 1000 * 
into #xxx
from view_EDW_PullHAData_NoCT_Inserts
where
        HAUserStarted_LASTMODIFIED > '2015-07-28'
        OR CMSUSER_LASTMODIFIED > '2015-07-28'
        OR USERSETTINGS_LASTMODIFIED > '2015-07-28'
        OR USERSITE_LASTMODIFIED > '2015-07-28'
        OR CMSSITE_LASTMODIFIED > '2015-07-28'
        OR ACCT_LASTMODIFIED > '2015-07-28'
        OR HAUSERMODULE_LASTMODIFIED > '2015-07-28'
        OR VHCJ_LASTMODIFIED > '2015-07-28'
        OR VHAJ_LASTMODIFIED > '2015-07-28'
        OR HARISKCATEGORY_LASTMODIFIED > '2015-07-28'
        OR HAUSERRISKAREA_LASTMODIFIED > '2015-07-28'
        OR HAUSERQUESTION_LASTMODIFIED > '2015-07-28'
        OR HAQUESTIONSVIEW_LASTMODIFIED > '2015-07-28'
        OR HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED > '2015-07-28'
        OR HAUSERANSWERS_LASTMODIFIED > '2015-07-28'
*/
CREATE VIEW view_EDW_PullHAData_NoCT_Inserts
    --WITH SCHEMABINDING
AS SELECT
          HAUserStarted.ITEMID AS UserStartedITEMID
        , VHAJ.NODEGUID AS HEALTHASSESMENTUserStartedNODEGUID
        , HAUserStarted.USERID
        , CMSUSER.USERGUID
        , USERSETTINGS.HFITUSERMPINUMBER
        , CMSSITE.SITEGUID
        , ACCT.ACCOUNTID
        , ACCT.ACCOUNTCD
        , ACCT.ACCOUNTNAME
        , HAUserStarted.HASTARTEDDT
        , HAUserStarted.HACOMPLETEDDT
        , HAUSERMODULE.ITEMID AS USERMODULEITEMID
        , HAUSERMODULE.CODENAME AS USERMODULECODENAME
        , HAUSERMODULE.HAMODULENODEGUID
        , VHAJ.NODEGUID AS CMSNODEGUID
        , NULL AS HAMODULEVERSIONID
        , HARISKCATEGORY.ITEMID AS USERRISKCATEGORYITEMID
        , HARISKCATEGORY.CODENAME AS USERRISKCATEGORYCODENAME
        , HARISKCATEGORY.HARISKCATEGORYNODEGUID
        , NULL AS HARISKCATEGORYVERSIONID
        , HAUSERRISKAREA.ITEMID AS USERRISKAREAITEMID
        , HAUSERRISKAREA.CODENAME AS USERRISKAREACODENAME
        , HAUSERRISKAREA.HARISKAREANODEGUID
        , NULL AS HARISKAREAVERSIONID
        , HAUSERQUESTION.ITEMID AS USERQUESTIONITEMID
        , HAQUESTIONSVIEW.TITLE
        , HAUSERQUESTION.HAQUESTIONNODEGUID AS HAQUESTIONGUID
        , HAUSERQUESTION.CODENAME AS USERQUESTIONCODENAME
        , NULL AS HAQUESTIONDOCUMENTID
        , NULL AS HAQUESTIONVERSIONID
        , HAUSERQUESTION.HAQUESTIONNODEGUID
        , HAUSERANSWERS.ITEMID AS USERANSWERITEMID
        , HAUSERANSWERS.HAANSWERNODEGUID
        , NULL AS HAANSWERVERSIONID
        , HAUSERANSWERS.CODENAME AS USERANSWERCODENAME
        , HAUSERANSWERS.HAANSWERVALUE
        , HAUSERMODULE.HAMODULESCORE
        , HARISKCATEGORY.HARISKCATEGORYSCORE
        , HAUSERRISKAREA.HARISKAREASCORE
        , HAUSERQUESTION.HAQUESTIONSCORE
        , HAUSERANSWERS.HAANSWERPOINTS
        , HAUSERQUESTIONGROUPRESULTS.POINTRESULTS
        , HAUSERANSWERS.UOMCODE
        , HAUserStarted.HASCORE
        , HAUSERMODULE.PREWEIGHTEDSCORE AS MODULEPREWEIGHTEDSCORE
        , HARISKCATEGORY.PREWEIGHTEDSCORE AS RISKCATEGORYPREWEIGHTEDSCORE
        , HAUSERRISKAREA.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
        , HAUSERQUESTION.PREWEIGHTEDSCORE AS QUESTIONPREWEIGHTEDSCORE
        , HAUSERQUESTIONGROUPRESULTS.CODENAME AS QUESTIONGROUPCODENAME

          --, COALESCE ( CT_CMS_USER.SYS_CHANGE_OPERATION , CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION , CT_CMS_SITE.SYS_CHANGE_OPERATION , CT_CMS_USERSITE.SYS_CHANGE_OPERATION , CT_HFIT_ACCOUNT.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUserStarted.SYS_CHANGE_OPERATION) AS CHANGETYPE

        , HAUSERANSWERS.ITEMCREATEDWHEN
        , HAUSERANSWERS.ITEMMODIFIEDWHEN
        , HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED
        , HARISKCATEGORY.ITEMMODIFIEDWHEN AS HARISKCATEGORY_ITEMMODIFIEDWHEN
        , HAUSERRISKAREA.ITEMMODIFIEDWHEN AS HAUSERRISKAREA_ITEMMODIFIEDWHEN
        , HAUSERQUESTION.ITEMMODIFIEDWHEN AS HAUSERQUESTION_ITEMMODIFIEDWHEN
        , HAUSERANSWERS.ITEMMODIFIEDWHEN AS HAUSERANSWERS_ITEMMODIFIEDWHEN
        , HAUserStarted.HAPAPERFLG
        , HAUserStarted.HATELEPHONICFLG
        , HAUserStarted.HASTARTEDMODE
        , HAUserStarted.HACOMPLETEDMODE
        , VHCJ.DOCUMENTCULTURE AS DOCUMENTCULTURE_VHCJ
        , HAQUESTIONSVIEW.DOCUMENTCULTURE AS DOCUMENTCULTURE_HAQUESTIONSVIEW
        , HAUserStarted.HACAMPAIGNNODEGUID AS CAMPAIGNNODEGUID
        , VHCJ.HACAMPAIGNID
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.USERID AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( USERSETTINGS.HFITUSERMPINUMBER AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTNAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASTARTEDDT AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACOMPLETEDDT AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS nvarchar (100)) , '-') + ISNULL ( LEFT ( HAQUESTIONSVIEW.TITLE , 1000) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERVALUE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULESCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREASCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERPOINTS AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.POINTRESULTS AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.UOMCODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMCREATEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAPAPERFLG AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HATELEPHONICFLG AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASTARTEDMODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACOMPLETEDMODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACAMPAIGNNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHCJ.HACAMPAIGNID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-')) AS varchar (100)) AS HASHCODE
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS varchar (50)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS varchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserStarted.HACAMPAIGNNODEGUID AS varchar (50)) , '-')) AS varchar (100)) AS PKHASHCODE

          --, COALESCE ( CT_CMS_USER.USERID , CT_CMS_USERSETTINGS.USERSETTINGSID , CT_CMS_SITE.SITEID , CT_CMS_USERSITE.USERSITEID , CT_HFIT_ACCOUNT.ACCOUNTID , CT_HFIT_HealthAssesmentUserAnswers.ITEMID , CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID , CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID , CT_HFIT_HEALTHASSESMENTUserStarted.ITEMID) AS CHANGED_FLG

        , NULL AS CHANGED_FLG
        , HAUSERANSWERS.ITEMMODIFIEDWHEN AS LASTMODIFIEDDATE
        , CASE
              WHEN HAUserStarted.HADOCUMENTCONFIGID IS NULL
                  THEN 'SHORT_VER'
              WHEN HAUserStarted.HADOCUMENTCONFIGID IS NOT NULL
                  THEN 'LONG_VER'
              ELSE 'UNKNOWN'
          END AS HEALTHASSESSMENTTYPE

        , HAUserStarted.LASTLOADEDDATE AS HAUserStarted_LASTMODIFIED
        , CMSUSER.LASTLOADEDDATE AS CMSUSER_LASTMODIFIED
        , USERSETTINGS.LASTLOADEDDATE AS USERSETTINGS_LASTMODIFIED
        , USERSITE.LASTLOADEDDATE AS USERSITE_LASTMODIFIED
        , CMSSITE.SITELASTMODIFIED AS CMSSITE_LASTMODIFIED
        , ACCT.ITEMMODIFIEDWHEN AS ACCT_LASTMODIFIED
        , HAUSERMODULE.LASTLOADEDDATE AS HAUSERMODULE_LASTMODIFIED
        , VHCJ.LASTLOADEDDATE AS VHCJ_LASTMODIFIED
        , VHAJ.LASTLOADEDDATE AS VHAJ_LASTMODIFIED
        , HARISKCATEGORY.LASTLOADEDDATE AS HARISKCATEGORY_LASTMODIFIED
        , HAUSERRISKAREA.LASTLOADEDDATE AS HAUSERRISKAREA_LASTMODIFIED
        , HAUSERQUESTION.LASTLOADEDDATE AS HAUSERQUESTION_LASTMODIFIED
        , HAQUESTIONSVIEW.LASTLOADEDDATE AS HAQUESTIONSVIEW_LASTMODIFIED
        , HAUSERQUESTIONGROUPRESULTS.LASTLOADEDDATE AS HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED
        , HAUSERANSWERS.LASTLOADEDDATE AS HAUSERANSWERS_LASTMODIFIED

        , HAUserStarted.LastUpdateID AS HAUserStarted_LastUpdateID
        , CMSUSER.LastUpdateID AS CMSUSER_LastUpdateID
        , USERSETTINGS.LastUpdateID AS USERSETTINGS_LastUpdateID
        , USERSITE.LastUpdateID AS USERSITE_LastUpdateID
          --, CMSSITE.LastUpdateID AS CMSSITE_LastUpdateID
        , ACCT.ItemModifiedWhen AS ACCT_LastUpdateID
        , HAUSERMODULE.LastUpdateID AS HAUSERMODULE_LastUpdateID
        , VHCJ.LastUpdateID AS VHCJ_LastUpdateID
        , VHAJ.LastUpdateID AS VHAJ_LastUpdateID
        , HARISKCATEGORY.LastUpdateID AS HARISKCATEGORY_LastUpdateID
        , HAUSERRISKAREA.LastUpdateID AS HAUSERRISKAREA_LastUpdateID
        , HAUSERQUESTION.LastUpdateID AS HAUSERQUESTION_LastUpdateID
        , HAQUESTIONSVIEW.LastUpdateID AS HAQUESTIONSVIEW_LastUpdateID
        , HAUSERQUESTIONGROUPRESULTS.LastUpdateID AS HAUSERQUESTIONGROUPRESULTS_LastUpdateID
        , HAUSERANSWERS.LastUpdateID AS HAUSERANSWERS_LastUpdateID

        , 0 AS LASTUPDATEID
        , 0 AS DELETEFLG
        , @@Servername AS SVR
        , DB_NAME () AS DBNAME
        , 0 AS DELETEDFLG
        , NULL AS ChangeType
          FROM
              DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED AS HAUserStarted
                  INNER JOIN DBO.DIM_EDW_CMS_USER AS CMSUSER
                      ON HAUserStarted.USERID = CMSUSER.USERID
                  INNER JOIN DBO.DIM_EDW_CMS_USERSETTINGS AS USERSETTINGS
                      ON USERSETTINGS.USERSETTINGSUSERID = CMSUSER.USERID
                     AND USERSETTINGS.HFITUSERMPINUMBER >= 0
                     AND USERSETTINGS.HFITUSERMPINUMBER IS NOT NULL
                  INNER JOIN DBO.DIM_EDW_CMS_USERSITE AS USERSITE
                      ON CMSUSER.USERID = USERSITE.USERID
                  INNER JOIN DBO.CMS_SITE AS CMSSITE
                      ON USERSITE.SITEID = CMSSITE.SITEID
                  INNER JOIN DBO.HFIT_ACCOUNT AS ACCT
                      ON ACCT.SITEID = CMSSITE.SITEID
                  INNER JOIN DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE
                      ON HAUserStarted.ITEMID = HAUSERMODULE.HASTARTEDITEMID
                  INNER JOIN DBO.DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED AS VHCJ
                      ON VHCJ.NODEGUID = HAUserStarted.HACAMPAIGNNODEGUID
                     AND VHCJ.NODESITEID = USERSITE.SITEID
                     AND VHCJ.DOCUMENTCULTURE = 'en-US'
                  INNER JOIN DBO.DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED AS VHAJ
                      ON VHAJ.DOCUMENTID = VHCJ.HEALTHASSESSMENTID
                  INNER JOIN DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY
                      ON HAUSERMODULE.ITEMID = HARISKCATEGORY.HAMODULEITEMID
                  INNER JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserRiskArea AS HAUSERRISKAREA
                      ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
                  INNER JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserQuestion AS HAUSERQUESTION
                      ON HAUSERRISKAREA.ITEMID = HAUSERQUESTION.HARISKAREAITEMID
                  INNER JOIN DBO.DIM_EDW_View_EDW_HealthAssesmentQuestions AS HAQUESTIONSVIEW
                      ON HAUSERQUESTION.HAQUESTIONNODEGUID = HAQUESTIONSVIEW.NODEGUID
                  LEFT JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserQuestionGROUPRESULTS AS HAUSERQUESTIONGROUPRESULTS
                      ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
                  INNER JOIN DBO.DIM_EDW_HFIT_HealthAssesmentUserAnswers AS HAUSERANSWERS
                      ON HAUSERQUESTION.ITEMID = HAUSERANSWERS.HAQUESTIONITEMID
                  --INNER JOIN dbo.DIM_EDW_PkHashkey AS HKEY
				INNER JOIN dbo.LKUP_NewEdwHAHashkeys AS HKEY
                      ON HKEY.HAUSERSTARTED_ITEMID = HAUserStarted.ITEMID
                     AND HKEY.USERGUID = CMSUSER.USERGUID
                     AND HKEY.PKHASHCODE = PKHASHCODE
                     --AND HKEY.ChangeType = 'I'
                     --AND HKEY.ChangeDate > GETDATE () - 1
          WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
                SELECT
                       HFIT_LKP_EDW_REJECTMPI.REJECTMPICODE
                       FROM DBO.HFIT_LKP_EDW_REJECTMPI);
GO

--CREATE unique clustered INDEX [PI_view_EDW_PullHAData_IDX] ON [dbo].[view_EDW_PullHAData_NoCT_Inserts]
--(
--UserStartedITEMID
--, PkHashCode
--)
--GO
--CREATE unique clustered INDEX [PI_view_EDW_PullHAData_IDX_DATES] ON [dbo].[view_EDW_PullHAData_NoCT_Inserts]
--(
--HAUserStarted_LastModified
--, CMSUSER_LastModified
--, USERSETTINGS_LastModified
--, USERSITE_LastModified
--, CMSSITE_LastModified
--, ACCT_LastModified
--, HAUSERMODULE_LastModified
--, VHCJ_LastModified
--, VHAJ_LastModified
--, HARISKCATEGORY_LastModified
--, HAUSERRISKAREA_LastModified
--, HAUSERQUESTION_LastModified
--, HAQUESTIONSVIEW_LastModified
--, HAUSERQUESTIONGROUPRESULTS_LastModified
--, HAUSERANSWERS_LastModified
--)

GO
PRINT 'Executed view_EDW_PullHAData_NoCT_Inserts.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing view_EDW_PullHAData_NoCT_Updates.sql';
GO
IF EXISTS ( SELECT
                   NAME
                   FROM SYS.VIEWS
                   WHERE
                   NAME = 'view_EDW_PullHAData_NoCT_Updates') 
    BEGIN
        DROP VIEW
             DBO.view_EDW_PullHAData_NoCT_Updates;
    END;
GO
/*---------------------------------------------------------------
select top 10000 * from view_EDW_PullHAData_NoCT_Updates
where
	   HAUserStarted_LastUpdateID > 0
        or  CMSUSER_LastUpdateID > 0
        or  USERSETTINGS_LastUpdateID > 0
        or  USERSITE_LastUpdateID > 0
        --or  CMSSITE_LastUpdateID > 0
        --or  ACCT_LastUpdateID > 0
        or  HAUSERMODULE_LastUpdateID > 0
        or  VHCJ_LastUpdateID > 0
        or  VHAJ_LastUpdateID > 0
        or  HARISKCATEGORY_LastUpdateID > 0
        or  HAUSERRISKAREA_LastUpdateID > 0
        or  HAUSERQUESTION_LastUpdateID > 0
        or  HAQUESTIONSVIEW_LastUpdateID > 0
        or  HAUSERQUESTIONGROUPRESULTS_LastUpdateID > 0
        or  HAUSERANSWERS_LastUpdateID > 0

select top 1000 * 
into #xxx
from view_EDW_PullHAData_NoCT_Updates
where
        HAUserStarted_LASTMODIFIED > '2015-07-28'
        OR CMSUSER_LASTMODIFIED > '2015-07-28'
        OR USERSETTINGS_LASTMODIFIED > '2015-07-28'
        OR USERSITE_LASTMODIFIED > '2015-07-28'
        OR CMSSITE_LASTMODIFIED > '2015-07-28'
        OR ACCT_LASTMODIFIED > '2015-07-28'
        OR HAUSERMODULE_LASTMODIFIED > '2015-07-28'
        OR VHCJ_LASTMODIFIED > '2015-07-28'
        OR VHAJ_LASTMODIFIED > '2015-07-28'
        OR HARISKCATEGORY_LASTMODIFIED > '2015-07-28'
        OR HAUSERRISKAREA_LASTMODIFIED > '2015-07-28'
        OR HAUSERQUESTION_LASTMODIFIED > '2015-07-28'
        OR HAQUESTIONSVIEW_LASTMODIFIED > '2015-07-28'
        OR HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED > '2015-07-28'
        OR HAUSERANSWERS_LASTMODIFIED > '2015-07-28'
*/

-- select * into #tempxx from view_EDW_PullHAData_NoCT_Updates

CREATE VIEW view_EDW_PullHAData_NoCT_Updates
    --WITH SCHEMABINDING
AS SELECT
          HAUserStarted.ITEMID AS UserStartedITEMID
        , VHAJ.NODEGUID AS HEALTHASSESMENTUserStartedNODEGUID
        , HAUserStarted.USERID
        , CMSUSER.USERGUID
        , USERSETTINGS.HFITUSERMPINUMBER
        , CMSSITE.SITEGUID
        , ACCT.ACCOUNTID
        , ACCT.ACCOUNTCD
        , ACCT.ACCOUNTNAME
        , HAUserStarted.HASTARTEDDT
        , HAUserStarted.HACOMPLETEDDT
        , HAUSERMODULE.ITEMID AS USERMODULEITEMID
        , HAUSERMODULE.CODENAME AS USERMODULECODENAME
        , HAUSERMODULE.HAMODULENODEGUID
        , VHAJ.NODEGUID AS CMSNODEGUID
        , NULL AS HAMODULEVERSIONID
        , HARISKCATEGORY.ITEMID AS USERRISKCATEGORYITEMID
        , HARISKCATEGORY.CODENAME AS USERRISKCATEGORYCODENAME
        , HARISKCATEGORY.HARISKCATEGORYNODEGUID
        , NULL AS HARISKCATEGORYVERSIONID
        , HAUSERRISKAREA.ITEMID AS USERRISKAREAITEMID
        , HAUSERRISKAREA.CODENAME AS USERRISKAREACODENAME
        , HAUSERRISKAREA.HARISKAREANODEGUID
        , NULL AS HARISKAREAVERSIONID
        , HAUSERQUESTION.ITEMID AS USERQUESTIONITEMID
        , HAQUESTIONSVIEW.TITLE
        , HAUSERQUESTION.HAQUESTIONNODEGUID AS HAQUESTIONGUID
        , HAUSERQUESTION.CODENAME AS USERQUESTIONCODENAME
        , NULL AS HAQUESTIONDOCUMENTID
        , NULL AS HAQUESTIONVERSIONID
        , HAUSERQUESTION.HAQUESTIONNODEGUID
        , HAUSERANSWERS.ITEMID AS USERANSWERITEMID
        , HAUSERANSWERS.HAANSWERNODEGUID
        , NULL AS HAANSWERVERSIONID
        , HAUSERANSWERS.CODENAME AS USERANSWERCODENAME
        , HAUSERANSWERS.HAANSWERVALUE
        , HAUSERMODULE.HAMODULESCORE
        , HARISKCATEGORY.HARISKCATEGORYSCORE
        , HAUSERRISKAREA.HARISKAREASCORE
        , HAUSERQUESTION.HAQUESTIONSCORE
        , HAUSERANSWERS.HAANSWERPOINTS
        , HAUSERQUESTIONGROUPRESULTS.POINTRESULTS
        , HAUSERANSWERS.UOMCODE
        , HAUserStarted.HASCORE
        , HAUSERMODULE.PREWEIGHTEDSCORE AS MODULEPREWEIGHTEDSCORE
        , HARISKCATEGORY.PREWEIGHTEDSCORE AS RISKCATEGORYPREWEIGHTEDSCORE
        , HAUSERRISKAREA.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
        , HAUSERQUESTION.PREWEIGHTEDSCORE AS QUESTIONPREWEIGHTEDSCORE
        , HAUSERQUESTIONGROUPRESULTS.CODENAME AS QUESTIONGROUPCODENAME

          --, COALESCE ( CT_CMS_USER.SYS_CHANGE_OPERATION , CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION , CT_CMS_SITE.SYS_CHANGE_OPERATION , CT_CMS_USERSITE.SYS_CHANGE_OPERATION , CT_HFIT_ACCOUNT.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUserStarted.SYS_CHANGE_OPERATION) AS CHANGETYPE

        , HAUSERANSWERS.ITEMCREATEDWHEN
        , HAUSERANSWERS.ITEMMODIFIEDWHEN
        , HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED
        , HARISKCATEGORY.ITEMMODIFIEDWHEN AS HARISKCATEGORY_ITEMMODIFIEDWHEN
        , HAUSERRISKAREA.ITEMMODIFIEDWHEN AS HAUSERRISKAREA_ITEMMODIFIEDWHEN
        , HAUSERQUESTION.ITEMMODIFIEDWHEN AS HAUSERQUESTION_ITEMMODIFIEDWHEN
        , HAUSERANSWERS.ITEMMODIFIEDWHEN AS HAUSERANSWERS_ITEMMODIFIEDWHEN
        , HAUserStarted.HAPAPERFLG
        , HAUserStarted.HATELEPHONICFLG
        , HAUserStarted.HASTARTEDMODE
        , HAUserStarted.HACOMPLETEDMODE
        , VHCJ.DOCUMENTCULTURE AS DOCUMENTCULTURE_VHCJ
        , HAQUESTIONSVIEW.DOCUMENTCULTURE AS DOCUMENTCULTURE_HAQUESTIONSVIEW
        , HAUserStarted.HACAMPAIGNNODEGUID AS CAMPAIGNNODEGUID
        , VHCJ.HACAMPAIGNID
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.USERID AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( USERSETTINGS.HFITUSERMPINUMBER AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTNAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASTARTEDDT AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACOMPLETEDDT AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS nvarchar (100)) , '-') + ISNULL ( LEFT ( HAQUESTIONSVIEW.TITLE , 1000) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERVALUE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULESCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREASCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERPOINTS AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.POINTRESULTS AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.UOMCODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMCREATEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAPAPERFLG AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HATELEPHONICFLG AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASTARTEDMODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACOMPLETEDMODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACAMPAIGNNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHCJ.HACAMPAIGNID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-')) AS varchar (100)) AS HASHCODE
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS varchar (50)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS varchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserStarted.HACAMPAIGNNODEGUID AS varchar (50)) , '-')) AS varchar (100)) AS PKHASHCODE

          --, COALESCE ( CT_CMS_USER.USERID , CT_CMS_USERSETTINGS.USERSETTINGSID , CT_CMS_SITE.SITEID , CT_CMS_USERSITE.USERSITEID , CT_HFIT_ACCOUNT.ACCOUNTID , CT_HFIT_HealthAssesmentUserAnswers.ITEMID , CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID , CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID , CT_HFIT_HEALTHASSESMENTUserStarted.ITEMID) AS CHANGED_FLG

        , NULL AS CHANGED_FLG
        , HAUSERANSWERS.ITEMMODIFIEDWHEN AS LASTMODIFIEDDATE
        , CASE
              WHEN HAUserStarted.HADOCUMENTCONFIGID IS NULL
                  THEN 'SHORT_VER'
              WHEN HAUserStarted.HADOCUMENTCONFIGID IS NOT NULL
                  THEN 'LONG_VER'
              ELSE 'UNKNOWN'
          END AS HEALTHASSESSMENTTYPE

        , HAUserStarted.LASTLOADEDDATE AS HAUserStarted_LASTMODIFIED
        , CMSUSER.LASTLOADEDDATE AS CMSUSER_LASTMODIFIED
        , USERSETTINGS.LASTLOADEDDATE AS USERSETTINGS_LASTMODIFIED
        , USERSITE.LASTLOADEDDATE AS USERSITE_LASTMODIFIED
        , CMSSITE.SITELASTMODIFIED AS CMSSITE_LASTMODIFIED
        , ACCT.ITEMMODIFIEDWHEN AS ACCT_LASTMODIFIED
        , HAUSERMODULE.LASTLOADEDDATE AS HAUSERMODULE_LASTMODIFIED
        , VHCJ.LASTLOADEDDATE AS VHCJ_LASTMODIFIED
        , VHAJ.LASTLOADEDDATE AS VHAJ_LASTMODIFIED
        , HARISKCATEGORY.LASTLOADEDDATE AS HARISKCATEGORY_LASTMODIFIED
        , HAUSERRISKAREA.LASTLOADEDDATE AS HAUSERRISKAREA_LASTMODIFIED
        , HAUSERQUESTION.LASTLOADEDDATE AS HAUSERQUESTION_LASTMODIFIED
        , HAQUESTIONSVIEW.LASTLOADEDDATE AS HAQUESTIONSVIEW_LASTMODIFIED
        , HAUSERQUESTIONGROUPRESULTS.LASTLOADEDDATE AS HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED
        , HAUSERANSWERS.LASTLOADEDDATE AS HAUSERANSWERS_LASTMODIFIED

        , HAUserStarted.LastUpdateID AS HAUserStarted_LastUpdateID
        , CMSUSER.LastUpdateID AS CMSUSER_LastUpdateID
        , USERSETTINGS.LastUpdateID AS USERSETTINGS_LastUpdateID
        , USERSITE.LastUpdateID AS USERSITE_LastUpdateID
          --, CMSSITE.LastUpdateID AS CMSSITE_LastUpdateID
        , ACCT.ItemModifiedWhen AS ACCT_LastUpdateID
        , HAUSERMODULE.LastUpdateID AS HAUSERMODULE_LastUpdateID
        , VHCJ.LastUpdateID AS VHCJ_LastUpdateID
        , VHAJ.LastUpdateID AS VHAJ_LastUpdateID
        , HARISKCATEGORY.LastUpdateID AS HARISKCATEGORY_LastUpdateID
        , HAUSERRISKAREA.LastUpdateID AS HAUSERRISKAREA_LastUpdateID
        , HAUSERQUESTION.LastUpdateID AS HAUSERQUESTION_LastUpdateID
        , HAQUESTIONSVIEW.LastUpdateID AS HAQUESTIONSVIEW_LastUpdateID
        , HAUSERQUESTIONGROUPRESULTS.LastUpdateID AS HAUSERQUESTIONGROUPRESULTS_LastUpdateID
        , HAUSERANSWERS.LastUpdateID AS HAUSERANSWERS_LastUpdateID

        , 0 AS LASTUPDATEID
        , 0 AS DELETEFLG
        , @@Servername AS SVR
        , DB_NAME () AS DBNAME
        , 0 AS DELETEDFLG
        , NULL AS ChangeType
          FROM
              DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED AS HAUserStarted
                  INNER JOIN DBO.DIM_EDW_CMS_USER AS CMSUSER
                      ON HAUserStarted.USERID = CMSUSER.USERID
                  INNER JOIN DBO.DIM_EDW_CMS_USERSETTINGS AS USERSETTINGS
                      ON USERSETTINGS.USERSETTINGSUSERID = CMSUSER.USERID
                     AND USERSETTINGS.HFITUSERMPINUMBER >= 0
                     AND USERSETTINGS.HFITUSERMPINUMBER IS NOT NULL
                  INNER JOIN DBO.DIM_EDW_CMS_USERSITE AS USERSITE
                      ON CMSUSER.USERID = USERSITE.USERID
                  INNER JOIN DBO.CMS_SITE AS CMSSITE
                      ON USERSITE.SITEID = CMSSITE.SITEID
                  INNER JOIN DBO.HFIT_ACCOUNT AS ACCT
                      ON ACCT.SITEID = CMSSITE.SITEID
                  INNER JOIN DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE
                      ON HAUserStarted.ITEMID = HAUSERMODULE.HASTARTEDITEMID
                  INNER JOIN DBO.DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED AS VHCJ
                      ON VHCJ.NODEGUID = HAUserStarted.HACAMPAIGNNODEGUID
                     AND VHCJ.NODESITEID = USERSITE.SITEID
                     AND VHCJ.DOCUMENTCULTURE = 'en-US'
                  INNER JOIN DBO.DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED AS VHAJ
                      ON VHAJ.DOCUMENTID = VHCJ.HEALTHASSESSMENTID
                  INNER JOIN DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY
                      ON HAUSERMODULE.ITEMID = HARISKCATEGORY.HAMODULEITEMID
                  INNER JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserRiskArea AS HAUSERRISKAREA
                      ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
                  INNER JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserQuestion AS HAUSERQUESTION
                      ON HAUSERRISKAREA.ITEMID = HAUSERQUESTION.HARISKAREAITEMID
                  INNER JOIN DBO.DIM_EDW_View_EDW_HealthAssesmentQuestions AS HAQUESTIONSVIEW
                      ON HAUSERQUESTION.HAQUESTIONNODEGUID = HAQUESTIONSVIEW.NODEGUID
                  LEFT JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserQuestionGROUPRESULTS AS HAUSERQUESTIONGROUPRESULTS
                      ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
                  INNER JOIN DBO.DIM_EDW_HFIT_HealthAssesmentUserAnswers AS HAUSERANSWERS
                      ON HAUSERQUESTION.ITEMID = HAUSERANSWERS.HAQUESTIONITEMID
                  INNER JOIN dbo.LKUP_UpdatedEdwHAHashkeys AS HKEY
                      ON HKEY.HAUSERSTARTED_ITEMID = HAUserStarted.ITEMID
                     AND HKEY.USERGUID = CMSUSER.USERGUID
                     AND HKEY.PKHASHCODE = PKHASHCODE
                     --AND HKEY.ChangeType = 'U'
                     --AND HKEY.ChangeDate > GETDATE () - 1
          WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
                SELECT
                       HFIT_LKP_EDW_REJECTMPI.REJECTMPICODE
                       FROM DBO.HFIT_LKP_EDW_REJECTMPI);
GO

--CREATE unique clustered INDEX [PI_view_EDW_PullHAData_IDX] ON [dbo].[view_EDW_PullHAData_NoCT_Updates]
--(
--UserStartedITEMID
--, PkHashCode
--)
--GO
--CREATE unique clustered INDEX [PI_view_EDW_PullHAData_IDX_DATES] ON [dbo].[view_EDW_PullHAData_NoCT_Updates]
--(
--HAUserStarted_LastModified
--, CMSUSER_LastModified
--, USERSETTINGS_LastModified
--, USERSITE_LastModified
--, CMSSITE_LastModified
--, ACCT_LastModified
--, HAUSERMODULE_LastModified
--, VHCJ_LastModified
--, VHAJ_LastModified
--, HARISKCATEGORY_LastModified
--, HAUSERRISKAREA_LastModified
--, HAUSERQUESTION_LastModified
--, HAQUESTIONSVIEW_LastModified
--, HAUSERQUESTIONGROUPRESULTS_LastModified
--, HAUSERANSWERS_LastModified
--)

GO
PRINT 'Executed view_EDW_PullHAData_NoCT_Updates.sql';
GO
--select top 100 * from dbo.STAGED_ED_PhHashkey
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing view_EDW_PullHAData_NoCT_Deletes.sql';
GO
IF EXISTS ( SELECT
                   NAME
                   FROM SYS.VIEWS
                   WHERE
                   NAME = 'view_EDW_PullHAData_NoCT_Deletes') 
    BEGIN
        DROP VIEW
             DBO.view_EDW_PullHAData_NoCT_Deletes;
    END;
GO
/*---------------------------------------------------------------
select * from view_EDW_PullHAData_NoCT_Deletes
where
	   HAUserStarted_LastUpdateID > 0
        or  CMSUSER_LastUpdateID > 0
        or  USERSETTINGS_LastUpdateID > 0
        or  USERSITE_LastUpdateID > 0
        --or  CMSSITE_LastUpdateID > 0
        --or  ACCT_LastUpdateID > 0
        or  HAUSERMODULE_LastUpdateID > 0
        or  VHCJ_LastUpdateID > 0
        or  VHAJ_LastUpdateID > 0
        or  HARISKCATEGORY_LastUpdateID > 0
        or  HAUSERRISKAREA_LastUpdateID > 0
        or  HAUSERQUESTION_LastUpdateID > 0
        or  HAQUESTIONSVIEW_LastUpdateID > 0
        or  HAUSERQUESTIONGROUPRESULTS_LastUpdateID > 0
        or  HAUSERANSWERS_LastUpdateID > 0

select top 1000 * 
into #xxx
from view_EDW_PullHAData_NoCT_Deletes
where
        HAUserStarted_LASTMODIFIED > '2015-07-28'
        OR CMSUSER_LASTMODIFIED > '2015-07-28'
        OR USERSETTINGS_LASTMODIFIED > '2015-07-28'
        OR USERSITE_LASTMODIFIED > '2015-07-28'
        OR CMSSITE_LASTMODIFIED > '2015-07-28'
        OR ACCT_LASTMODIFIED > '2015-07-28'
        OR HAUSERMODULE_LASTMODIFIED > '2015-07-28'
        OR VHCJ_LASTMODIFIED > '2015-07-28'
        OR VHAJ_LASTMODIFIED > '2015-07-28'
        OR HARISKCATEGORY_LASTMODIFIED > '2015-07-28'
        OR HAUSERRISKAREA_LASTMODIFIED > '2015-07-28'
        OR HAUSERQUESTION_LASTMODIFIED > '2015-07-28'
        OR HAQUESTIONSVIEW_LASTMODIFIED > '2015-07-28'
        OR HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED > '2015-07-28'
        OR HAUSERANSWERS_LASTMODIFIED > '2015-07-28'
*/
CREATE VIEW view_EDW_PullHAData_NoCT_Deletes
    --WITH SCHEMABINDING
AS SELECT
          HAUserStarted.ITEMID AS UserStartedITEMID
        , VHAJ.NODEGUID AS HEALTHASSESMENTUserStartedNODEGUID
        , HAUserStarted.USERID
        , CMSUSER.USERGUID
        , USERSETTINGS.HFITUSERMPINUMBER
        , CMSSITE.SITEGUID
        , ACCT.ACCOUNTID
        , ACCT.ACCOUNTCD
        , ACCT.ACCOUNTNAME
        , HAUserStarted.HASTARTEDDT
        , HAUserStarted.HACOMPLETEDDT
        , HAUSERMODULE.ITEMID AS USERMODULEITEMID
        , HAUSERMODULE.CODENAME AS USERMODULECODENAME
        , HAUSERMODULE.HAMODULENODEGUID
        , VHAJ.NODEGUID AS CMSNODEGUID
        , NULL AS HAMODULEVERSIONID
        , HARISKCATEGORY.ITEMID AS USERRISKCATEGORYITEMID
        , HARISKCATEGORY.CODENAME AS USERRISKCATEGORYCODENAME
        , HARISKCATEGORY.HARISKCATEGORYNODEGUID
        , NULL AS HARISKCATEGORYVERSIONID
        , HAUSERRISKAREA.ITEMID AS USERRISKAREAITEMID
        , HAUSERRISKAREA.CODENAME AS USERRISKAREACODENAME
        , HAUSERRISKAREA.HARISKAREANODEGUID
        , NULL AS HARISKAREAVERSIONID
        , HAUSERQUESTION.ITEMID AS USERQUESTIONITEMID
        , HAQUESTIONSVIEW.TITLE
        , HAUSERQUESTION.HAQUESTIONNODEGUID AS HAQUESTIONGUID
        , HAUSERQUESTION.CODENAME AS USERQUESTIONCODENAME
        , NULL AS HAQUESTIONDOCUMENTID
        , NULL AS HAQUESTIONVERSIONID
        , HAUSERQUESTION.HAQUESTIONNODEGUID
        , HAUSERANSWERS.ITEMID AS USERANSWERITEMID
        , HAUSERANSWERS.HAANSWERNODEGUID
        , NULL AS HAANSWERVERSIONID
        , HAUSERANSWERS.CODENAME AS USERANSWERCODENAME
        , HAUSERANSWERS.HAANSWERVALUE
        , HAUSERMODULE.HAMODULESCORE
        , HARISKCATEGORY.HARISKCATEGORYSCORE
        , HAUSERRISKAREA.HARISKAREASCORE
        , HAUSERQUESTION.HAQUESTIONSCORE
        , HAUSERANSWERS.HAANSWERPOINTS
        , HAUSERQUESTIONGROUPRESULTS.POINTRESULTS
        , HAUSERANSWERS.UOMCODE
        , HAUserStarted.HASCORE
        , HAUSERMODULE.PREWEIGHTEDSCORE AS MODULEPREWEIGHTEDSCORE
        , HARISKCATEGORY.PREWEIGHTEDSCORE AS RISKCATEGORYPREWEIGHTEDSCORE
        , HAUSERRISKAREA.PREWEIGHTEDSCORE AS RISKAREAPREWEIGHTEDSCORE
        , HAUSERQUESTION.PREWEIGHTEDSCORE AS QUESTIONPREWEIGHTEDSCORE
        , HAUSERQUESTIONGROUPRESULTS.CODENAME AS QUESTIONGROUPCODENAME

          --, COALESCE ( CT_CMS_USER.SYS_CHANGE_OPERATION , CT_CMS_USERSETTINGS.SYS_CHANGE_OPERATION , CT_CMS_SITE.SYS_CHANGE_OPERATION , CT_CMS_USERSITE.SYS_CHANGE_OPERATION , CT_HFIT_ACCOUNT.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERMODULE.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERQUESTION.SYS_CHANGE_OPERATION , CT_HFIT_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.SYS_CHANGE_OPERATION , CT_HFIT_HEALTHASSESMENTUserStarted.SYS_CHANGE_OPERATION) AS CHANGETYPE

        , HAUSERANSWERS.ITEMCREATEDWHEN
        , HAUSERANSWERS.ITEMMODIFIEDWHEN
        , HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED
        , HARISKCATEGORY.ITEMMODIFIEDWHEN AS HARISKCATEGORY_ITEMMODIFIEDWHEN
        , HAUSERRISKAREA.ITEMMODIFIEDWHEN AS HAUSERRISKAREA_ITEMMODIFIEDWHEN
        , HAUSERQUESTION.ITEMMODIFIEDWHEN AS HAUSERQUESTION_ITEMMODIFIEDWHEN
        , HAUSERANSWERS.ITEMMODIFIEDWHEN AS HAUSERANSWERS_ITEMMODIFIEDWHEN
        , HAUserStarted.HAPAPERFLG
        , HAUserStarted.HATELEPHONICFLG
        , HAUserStarted.HASTARTEDMODE
        , HAUserStarted.HACOMPLETEDMODE
        , VHCJ.DOCUMENTCULTURE AS DOCUMENTCULTURE_VHCJ
        , HAQUESTIONSVIEW.DOCUMENTCULTURE AS DOCUMENTCULTURE_HAQUESTIONSVIEW
        , HAUserStarted.HACAMPAIGNNODEGUID AS CAMPAIGNNODEGUID
        , VHCJ.HACAMPAIGNID
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.USERID AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( USERSETTINGS.HFITUSERMPINUMBER AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTNAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASTARTEDDT AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACOMPLETEDDT AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS nvarchar (100)) , '-') + ISNULL ( LEFT ( HAQUESTIONSVIEW.TITLE , 1000) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERVALUE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULESCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREASCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERPOINTS AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.POINTRESULTS AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.UOMCODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMCREATEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAPAPERFLG AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HATELEPHONICFLG AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HASTARTEDMODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACOMPLETEDMODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACAMPAIGNNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHCJ.HACAMPAIGNID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-')) AS varchar (100)) AS HASHCODE
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS varchar (50)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS varchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserStarted.HACAMPAIGNNODEGUID AS varchar (50)) , '-')) AS varchar (100)) AS PKHASHCODE

          --, COALESCE ( CT_CMS_USER.USERID , CT_CMS_USERSETTINGS.USERSETTINGSID , CT_CMS_SITE.SITEID , CT_CMS_USERSITE.USERSITEID , CT_HFIT_ACCOUNT.ACCOUNTID , CT_HFIT_HealthAssesmentUserAnswers.ITEMID , CT_HFIT_HEALTHASSESMENTUSERMODULE.ITEMID , CT_HFIT_HEALTHASSESMENTUSERQUESTION.ITEMID , CT_HFIT_HealthAssesmentUserQuestionGroupResults.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKAREA.ITEMID , CT_HFIT_HEALTHASSESMENTUSERRISKCATEGORY.ITEMID , CT_HFIT_HEALTHASSESMENTUserStarted.ITEMID) AS CHANGED_FLG

        , NULL AS CHANGED_FLG
        , HAUSERANSWERS.ITEMMODIFIEDWHEN AS LASTMODIFIEDDATE
        , CASE
              WHEN HAUserStarted.HADOCUMENTCONFIGID IS NULL
                  THEN 'SHORT_VER'
              WHEN HAUserStarted.HADOCUMENTCONFIGID IS NOT NULL
                  THEN 'LONG_VER'
              ELSE 'UNKNOWN'
          END AS HEALTHASSESSMENTTYPE

        , HAUserStarted.LASTLOADEDDATE AS HAUserStarted_LASTMODIFIED
        , CMSUSER.LASTLOADEDDATE AS CMSUSER_LASTMODIFIED
        , USERSETTINGS.LASTLOADEDDATE AS USERSETTINGS_LASTMODIFIED
        , USERSITE.LASTLOADEDDATE AS USERSITE_LASTMODIFIED
        , CMSSITE.SITELASTMODIFIED AS CMSSITE_LASTMODIFIED
        , ACCT.ITEMMODIFIEDWHEN AS ACCT_LASTMODIFIED
        , HAUSERMODULE.LASTLOADEDDATE AS HAUSERMODULE_LASTMODIFIED
        , VHCJ.LASTLOADEDDATE AS VHCJ_LASTMODIFIED
        , VHAJ.LASTLOADEDDATE AS VHAJ_LASTMODIFIED
        , HARISKCATEGORY.LASTLOADEDDATE AS HARISKCATEGORY_LASTMODIFIED
        , HAUSERRISKAREA.LASTLOADEDDATE AS HAUSERRISKAREA_LASTMODIFIED
        , HAUSERQUESTION.LASTLOADEDDATE AS HAUSERQUESTION_LASTMODIFIED
        , HAQUESTIONSVIEW.LASTLOADEDDATE AS HAQUESTIONSVIEW_LASTMODIFIED
        , HAUSERQUESTIONGROUPRESULTS.LASTLOADEDDATE AS HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED
        , HAUSERANSWERS.LASTLOADEDDATE AS HAUSERANSWERS_LASTMODIFIED

        , HAUserStarted.LastUpdateID AS HAUserStarted_LastUpdateID
        , CMSUSER.LastUpdateID AS CMSUSER_LastUpdateID
        , USERSETTINGS.LastUpdateID AS USERSETTINGS_LastUpdateID
        , USERSITE.LastUpdateID AS USERSITE_LastUpdateID
          --, CMSSITE.LastUpdateID AS CMSSITE_LastUpdateID
        , ACCT.ItemModifiedWhen AS ACCT_LastUpdateID
        , HAUSERMODULE.LastUpdateID AS HAUSERMODULE_LastUpdateID
        , VHCJ.LastUpdateID AS VHCJ_LastUpdateID
        , VHAJ.LastUpdateID AS VHAJ_LastUpdateID
        , HARISKCATEGORY.LastUpdateID AS HARISKCATEGORY_LastUpdateID
        , HAUSERRISKAREA.LastUpdateID AS HAUSERRISKAREA_LastUpdateID
        , HAUSERQUESTION.LastUpdateID AS HAUSERQUESTION_LastUpdateID
        , HAQUESTIONSVIEW.LastUpdateID AS HAQUESTIONSVIEW_LastUpdateID
        , HAUSERQUESTIONGROUPRESULTS.LastUpdateID AS HAUSERQUESTIONGROUPRESULTS_LastUpdateID
        , HAUSERANSWERS.LastUpdateID AS HAUSERANSWERS_LastUpdateID

        , 0 AS LASTUPDATEID
        , 0 AS DELETEFLG
        , @@Servername AS SVR
        , DB_NAME () AS DBNAME
        , 0 AS DELETEDFLG
        , NULL AS ChangeType
          FROM
              DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED AS HAUserStarted
                  INNER JOIN DBO.DIM_EDW_CMS_USER AS CMSUSER
                      ON HAUserStarted.USERID = CMSUSER.USERID
                  INNER JOIN DBO.DIM_EDW_CMS_USERSETTINGS AS USERSETTINGS
                      ON USERSETTINGS.USERSETTINGSUSERID = CMSUSER.USERID
                     AND USERSETTINGS.HFITUSERMPINUMBER >= 0
                     AND USERSETTINGS.HFITUSERMPINUMBER IS NOT NULL
                  INNER JOIN DBO.DIM_EDW_CMS_USERSITE AS USERSITE
                      ON CMSUSER.USERID = USERSITE.USERID
                  INNER JOIN DBO.CMS_SITE AS CMSSITE
                      ON USERSITE.SITEID = CMSSITE.SITEID
                  INNER JOIN DBO.HFIT_ACCOUNT AS ACCT
                      ON ACCT.SITEID = CMSSITE.SITEID
                  INNER JOIN DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE
                      ON HAUserStarted.ITEMID = HAUSERMODULE.HASTARTEDITEMID
                  INNER JOIN DBO.DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED AS VHCJ
                      ON VHCJ.NODEGUID = HAUserStarted.HACAMPAIGNNODEGUID
                     AND VHCJ.NODESITEID = USERSITE.SITEID
                     AND VHCJ.DOCUMENTCULTURE = 'en-US'
                  INNER JOIN DBO.DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED AS VHAJ
                      ON VHAJ.DOCUMENTID = VHCJ.HEALTHASSESSMENTID
                  INNER JOIN DBO.DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY
                      ON HAUSERMODULE.ITEMID = HARISKCATEGORY.HAMODULEITEMID
                  INNER JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserRiskArea AS HAUSERRISKAREA
                      ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
                  INNER JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserQuestion AS HAUSERQUESTION
                      ON HAUSERRISKAREA.ITEMID = HAUSERQUESTION.HARISKAREAITEMID
                  INNER JOIN DBO.DIM_EDW_View_EDW_HealthAssesmentQuestions AS HAQUESTIONSVIEW
                      ON HAUSERQUESTION.HAQUESTIONNODEGUID = HAQUESTIONSVIEW.NODEGUID
                  LEFT JOIN DBO.DIM_EDW_HFit_HealthAssesmentUserQuestionGROUPRESULTS AS HAUSERQUESTIONGROUPRESULTS
                      ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
                  INNER JOIN DBO.DIM_EDW_HFIT_HealthAssesmentUserAnswers AS HAUSERANSWERS
                      ON HAUSERQUESTION.ITEMID = HAUSERANSWERS.HAQUESTIONITEMID
                  INNER JOIN dbo.LKUP_DeletedEdwHAHashkeys AS HKEY
                      ON HKEY.HAUSERSTARTED_ITEMID = HAUserStarted.ITEMID
                     AND HKEY.USERGUID = CMSUSER.USERGUID
                     AND HKEY.PKHASHCODE = PKHASHCODE
                     --AND HKEY.ChangeType = 'D'
                     --AND HKEY.ChangeDate > GETDATE () - 1
          WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
                SELECT
                       HFIT_LKP_EDW_REJECTMPI.REJECTMPICODE
                       FROM DBO.HFIT_LKP_EDW_REJECTMPI);
GO

--CREATE unique clustered INDEX [PI_view_EDW_PullHAData_IDX] ON [dbo].[view_EDW_PullHAData_NoCT_Deletes]
--(
--UserStartedITEMID
--, PkHashCode
--)
--GO
--CREATE unique clustered INDEX [PI_view_EDW_PullHAData_IDX_DATES] ON [dbo].[view_EDW_PullHAData_NoCT_Deletes]
--(
--HAUserStarted_LastModified
--, CMSUSER_LastModified
--, USERSETTINGS_LastModified
--, USERSITE_LastModified
--, CMSSITE_LastModified
--, ACCT_LastModified
--, HAUSERMODULE_LastModified
--, VHCJ_LastModified
--, VHAJ_LastModified
--, HARISKCATEGORY_LastModified
--, HAUSERRISKAREA_LastModified
--, HAUSERQUESTION_LastModified
--, HAQUESTIONSVIEW_LastModified
--, HAUSERQUESTIONGROUPRESULTS_LastModified
--, HAUSERANSWERS_LastModified
--)

GO
PRINT 'Executed view_EDW_PullHAData_NoCT_Deletes.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
print 'Executing proc_EDW_Gen_Temp_PkHashKeys.sql'
go

if exists (select name from sys.procedures where name = 'proc_EDW_Gen_Temp_PkHashKeys')
    drop procedure proc_EDW_Gen_Temp_PkHashKeys;

go


create procedure proc_EDW_Gen_Temp_PkHashKeys
as
begin
declare @CT as datetime = getdate() ;
declare @ET as datetime = getdate() ;
declare @ST as datetime = getdate() ;
DECLARE @ms AS float = 0 ;
            DECLARE @secs AS float = 0;
            DECLARE @mins AS float = 0;
--***************************************************************************************************************
    IF NOT EXISTS ( SELECT
                           name
                           FROM tempdb.dbo.sysobjects
                           WHERE id = OBJECT_ID ( N'tempdb..##STAGED_EDW_PkHashkey')) 
        BEGIN
            PRINT 'Generating ##STAGED_EDW_PkHashkey';
            EXEC proc_trace 'Temp_PkHashKeys: START Process MarkNewRecords - CREATE TABLE VAR', @CT, NULL;
            CREATE TABLE dbo.##STAGED_EDW_PkHashkey (
                         HAUSERSTARTED_ITEMID int NULL
                       , USERGUID uniqueidentifier NOT NULL
                       , HASHCODE nvarchar (100) NULL
                       , PKHASHCODE nvarchar (100) NULL
                       , RowNbr int IDENTITY (1, 1) 
                                    NOT NULL
                       , ChangeType nchar (1) NULL
                       , ChangeDate nchar (1) NULL
            );
            CREATE CLUSTERED INDEX PK_STAGED_EDW_PkHashkey_TEMP ON dbo.##STAGED_EDW_PkHashkey
            (
            HAUSERSTARTED_ITEMID ASC,
            USERGUID ASC,
            HASHCODE ASC,
            PKHASHCODE ASC
            );
            INSERT INTO ##STAGED_EDW_PkHashkey
            (
                   HAUSERSTARTED_ITEMID
                 , USERGUID
                 , HASHCODE
                 , PKHASHCODE) 
            SELECT
                   HAUSERSTARTED.ITEMID AS HAUSERSTARTED_ITEMID
                 , USERGUID
                 , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUSERSTARTED.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.USERID AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSUSER.USERGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( USERSETTINGS.HFITUSERMPINUMBER AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSSITE.SITEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTCD AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTNAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASTARTEDDT AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACOMPLETEDDT AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULENODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREANODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS nvarchar (100)) , '-') + ISNULL ( LEFT ( HAQUESTIONSVIEW.TITLE , 1000) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERVALUE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.HAMODULESCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.HARISKAREASCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.HAANSWERPOINTS AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.POINTRESULTS AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.UOMCODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERMODULE.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.PREWEIGHTEDSCORE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTIONGROUPRESULTS.CODENAME AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMCREATEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ISPROFESSIONALLYCOLLECTED AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HAPAPERFLG AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HATELEPHONICFLG AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HASTARTEDMODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACOMPLETEDMODE AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACAMPAIGNNODEGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHCJ.HACAMPAIGNID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMMODIFIEDWHEN AS nvarchar (100)) , '-')) AS varchar (100)) AS HASHCODE
                 , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUSERSTARTED.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( USERGUID AS varchar (50)) , '-') + ISNULL ( CAST ( SITEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.ACCOUNTID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCOUNTCD AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERMODULE.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAMODULENODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORYNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.CODENAME AS varchar (100)) , '-') + ISNULL ( CAST ( HARISKCATEGORY.HARISKCATEGORYNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HARISKAREANODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERRISKAREA.CODENAME AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.HAQUESTIONNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERQUESTION.CODENAME AS varchar (50)) , '-') + ISNULL ( CAST ( HAQUESTIONNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERANSWERS.ITEMID AS varchar (50)) , '-') + ISNULL ( CAST ( HAANSWERNODEGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUSERSTARTED.HACAMPAIGNNODEGUID AS varchar (50)) , '-')) AS varchar (100)) AS PKHASHCODE
                   FROM
                       DIM_EDW_HFIT_HEALTHASSESMENTUSERSTARTED AS HAUSERSTARTED
                           INNER JOIN DIM_EDW_CMS_USER AS CMSUSER
                               ON HAUSERSTARTED.USERID = CMSUSER.USERID
                           INNER JOIN DIM_EDW_CMS_USERSETTINGS AS USERSETTINGS
                               ON USERSETTINGS.USERSETTINGSUSERID = CMSUSER.USERID
                              AND HFITUSERMPINUMBER >= 0
                              AND HFITUSERMPINUMBER IS NOT NULL
                           INNER JOIN DIM_EDW_CMS_USERSITE AS USERSITE
                               ON CMSUSER.USERID = USERSITE.USERID
                           INNER JOIN DBO.CMS_SITE AS CMSSITE
                               ON USERSITE.SITEID = CMSSITE.SITEID
                           INNER JOIN DBO.HFIT_ACCOUNT AS ACCT
                               ON ACCT.SITEID = CMSSITE.SITEID
                           INNER JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERMODULE AS HAUSERMODULE
                               ON HAUSERSTARTED.ITEMID = HAUSERMODULE.HASTARTEDITEMID
                           INNER JOIN DIM_EDW_TEMP_VIEW_HFIT_HACAMPAIGN_JOINED AS VHCJ
                               ON VHCJ.NODEGUID = HAUSERSTARTED.HACAMPAIGNNODEGUID
                              AND VHCJ.NODESITEID = USERSITE.SITEID
                              AND VHCJ.DOCUMENTCULTURE = 'en-US'
                           INNER JOIN DIM_EDW_TEMP_VIEW_HFIT_HEALTHASSESSMENT_JOINED AS VHAJ
                               ON VHAJ.DOCUMENTID = VHCJ.HEALTHASSESSMENTID
                           INNER JOIN DIM_EDW_HFIT_HEALTHASSESMENTUSERRISKCATEGORY AS HARISKCATEGORY
                               ON HAUSERMODULE.ITEMID = HARISKCATEGORY.HAMODULEITEMID
                           INNER JOIN DIM_EDW_HFit_HealthAssesmentUserRiskArea AS HAUSERRISKAREA
                               ON HARISKCATEGORY.ITEMID = HAUSERRISKAREA.HARISKCATEGORYITEMID
                           INNER JOIN DIM_EDW_HFit_HealthAssesmentUserQuestion AS HAUSERQUESTION
                               ON HAUSERRISKAREA.ITEMID = HAUSERQUESTION.HARISKAREAITEMID
                           INNER JOIN DIM_EDW_View_EDW_HealthAssesmentQuestions AS HAQUESTIONSVIEW
                               ON HAUSERQUESTION.HAQUESTIONNODEGUID = HAQUESTIONSVIEW.NODEGUID
                           LEFT OUTER JOIN DIM_EDW_HFit_HealthAssesmentUserQuestionGroupResults AS HAUSERQUESTIONGROUPRESULTS
                               ON HAUSERRISKAREA.ITEMID = HAUSERQUESTIONGROUPRESULTS.HARISKAREAITEMID
                           INNER JOIN DIM_EDW_HFIT_HealthAssesmentUserAnswers AS HAUSERANSWERS
                               ON HAUSERQUESTION.ITEMID = HAUSERANSWERS.HAQUESTIONITEMID --Add in the change tracking data
                   WHERE USERSETTINGS.HFITUSERMPINUMBER NOT IN (
                         SELECT
                                REJECTMPICODE
                                FROM HFIT_LKP_EDW_REJECTMPI);

            SET @ET = GETDATE () ;
            EXEC proc_trace 'Temp_PkHashKeys: END Process MarkNewRecords - CREATE TABLE VAR', @CT, @ET;

            EXEC proc_trace 'Temp_PkHashKeys: START Process MarkNewRecords - Remove DUPS', @CT, NULL;
            --select * from @HASHKEYS
            set @ms = DATEDIFF (ms, @st, GETDATE ()) ;
            set  @secs = @ms / 1000;
            set @mins = @ms / 1000 / 60;
            PRINT '1 - @Secs = ' + CAST (@secs AS nvarchar (50)) ;
            PRINT '1 - @mins = ' + CAST (@mins AS nvarchar (50)) ;

            DECLARE @RemoveDups AS bit = 1;

            IF @RemoveDups = 1
                BEGIN
                    WITH CTE (
                         PKHASHCODE
                       , HAUSERSTARTED_ITEMID
                       , HASHCODE
                       , DuplicateCount) 
                        AS (
                        SELECT
                               PKHASHCODE
                             , HAUSERSTARTED_ITEMID
                             , HASHCODE
                             , ROW_NUMBER () OVER ( PARTITION BY PKHASHCODE
                                                               , HAUSERSTARTED_ITEMID
                                                               , HASHCODE  ORDER BY PKHASHCODE , HAUSERSTARTED_ITEMID , HASHCODE) AS DuplicateCount
                               FROM ##STAGED_EDW_PkHashkey
                        ) 
                        DELETE
                        FROM CTE
                        WHERE
                              DuplicateCount > 1;
                END;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'Temp_PkHashKeys: END Process MarkNewRecords - Remove DUPS', @CT, @ET;

            SET @CT = GETDATE () ;
            EXEC proc_trace 'Temp_PkHashKeys: START Process MarkNewRecords - Remove NULL RECS', @CT, NULL;

            DELETE FROM DIM_EDW_HealthAssessment
            WHERE
                  PKHashCode IS NULL;

            DELETE FROM ##STAGED_EDW_PkHashkey
            WHERE
                  PKHashCode IS NULL;

            SET @ET = GETDATE () ;
            EXEC proc_trace 'Temp_PkHashKeys: END Process MarkNewRecords - Remove NULL RECS', @CT, @ET;

        END;
    --***************************************************************************************************************
end ;

go
print 'Executed proc_EDW_Gen_Temp_PkHashKeys.sql'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*------------------------------------------------------------
DELETE FROM DIM_EDW_HealthAssessment
WHERE
      PkHashCode IN (SELECT TOP 1000
                            PkHashCode
                          FROM DIM_EDW_HealthAssessment) ;

SELECT
       COUNT (*) 
       FROM DIM_EDW_HealthAssessment;
*/
GO

PRINT 'Execute proc_CT_HA_MarkDeletedRecords.sql';

GO

--0.23.2015 03:36:42
--0.24.2015 00:08:42 @ 1,000,000 no CT
--0.24.2015 00:05:16 @ 1,000,000 no CT / no DUPS
--0.24.2015 00:04:56 @ 1,000,000 no CT / no DUPS / TEMP TABLE
-- select count(*) from [@EdwHAHashkeys]
-- exec [proc_CT_HA_MarkDeletedRecords]

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_HA_MarkDeletedRecords') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_MarkDeletedRecords;
    END;

GO
-- exec [proc_CT_HA_MarkDeletedRecords]
CREATE PROCEDURE proc_CT_HA_MarkDeletedRecords
AS
BEGIN

    --************************************************
    --MAKE SURE THE STAGED HASH KEY Table exists
    EXEC proc_Create_STAGED_EDW_PkHashkey_TBL ;
    --************************************************

    DECLARE @st AS datetime = GETDATE () ;
    DECLARE @ET AS datetime = GETDATE () ;
    DECLARE @CT AS datetime = GETDATE () ;

    DECLARE @LatestDbVersionToPull AS bigint = 0;
    SET @LatestDbVersionToPull = CHANGE_TRACKING_CURRENT_VERSION () - 1;

    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START determine if DELETED records present', @CT, NULL;
    --**************************************************************

declare @iChgTypes as int = 0 ; 
declare @NbrOfDetectedChanges as bigint = 0 ; 
    EXEC @iChgTypes = proc_CkHaDataChanged NULL, @NbrOfDetectedChanges OUTPUT;
    PRINT 'iChgType is: ' + CAST (@iChgTypes AS nvarchar (50)) ;
    PRINT 'Total Number Of Changes to process is: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) ;
    --**************************************************************
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END determine if DELETED records present', @CT, @ET;
/*-------------------------------
if @iChgTypes = 
    0 - no changes
    1 - updates only
    2 - deletes only
    3 - deletes and updates
    4 - inserts only
    5 - inserts and updates
    6 - inserts and deletes
    7 - inserts, updates, and deletes
*/
    IF @iChgTypes = 0
    OR @iChgTypes = 1
    OR @iChgTypes = 4
    OR @iChgTypes = 5
        BEGIN
            PRINT 'NO DELETES found.';
		  RETURN 0;
        END;

    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process proc_EDW_Gen_Temp_PkHashKeys', @CT, NULL;
    --****************************************
    exec proc_EDW_Gen_Temp_PkHashKeys ;
    --****************************************
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process proc_EDW_Gen_Temp_PkHashKeys', @CT, @ET;

    --***************************************************************************************************************
    SET @CT = GETDATE () ;    
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - CREATE TABLE VAR', @CT, NULL;
    
    
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - Remove DUPS', @CT, NULL;
    --select * from @HASHKEYS
    DECLARE @ms AS float = DATEDIFF (ms, @st, GETDATE ()) ;
    DECLARE @secs AS float = @ms / 1000;
    DECLARE @mins AS float = @ms / 1000 / 60;
    PRINT '1 - @Secs = ' + CAST (@secs AS nvarchar (50)) ;
    PRINT '1 - @mins = ' + CAST (@mins AS nvarchar (50)) ;

    DECLARE @RemoveDups AS bit = 1;

    IF @RemoveDups = 1
        BEGIN
            WITH CTE (
                 PKHASHCODE
               , HAUSERSTARTED_ITEMID
               , HASHCODE
               , DuplicateCount) 
                AS (
                SELECT
                       PKHASHCODE
                     , HAUSERSTARTED_ITEMID
                     , HASHCODE
                     , ROW_NUMBER () OVER ( PARTITION BY PKHASHCODE
                                                       , HAUSERSTARTED_ITEMID
                                                       , HASHCODE  ORDER BY PKHASHCODE , HAUSERSTARTED_ITEMID , HASHCODE) AS DuplicateCount
                       FROM ##STAGED_EDW_PkHashkey
                ) 
                DELETE
                FROM CTE
                WHERE
                      DuplicateCount > 1;
        END;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process MarkDeletedRecords - Remove DUPS', @CT, @ET;
    --***************************************************************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - Remove NULL RECS', @CT, NULL;

    DELETE FROM DIM_EDW_HealthAssessment
    WHERE
          PKHashCode IS NULL;

    DELETE FROM ##STAGED_EDW_PkHashkey
    WHERE
          PKHashCode IS NULL;

    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process MarkDeletedRecords - Remove NULL RECS', @CT, @ET;
    --***************************************************************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: START Process MarkDeletedRecords - FIND AND MARK Deleted Recs', @CT, NULL;

    --delete from STAGED_EDW_PkHashkey where RowNbr in (select top 100 RowNbr from STAGED_EDW_PkHashkey)
    DECLARE
    @DELDATE AS  datetime2 ( 7) = GETDATE () ;
    -- select top 100 * from STAGED_EDW_PkHashkey
    --  drop table LKUP_DeletedEdwHAHashkeys
if exists (select name from sys.tables where name = 'LKUP_DeletedEdwHAHashkeys')
    drop table LKUP_DeletedEdwHAHashkeys;

    create table LKUP_DeletedEdwHAHashkeys 
            (
                                    HAUSERSTARTED_ITEMID int  NOT NULL
                                  , USERGUID uniqueidentifier  NOT NULL
                                  , PKHASHCODE nvarchar (100) NOT NULL
                                  --, RowNbr int IDENTITY (1 , 1) 
                                  --             NOT NULL
                                  --  PRIMARY KEY ( PKHASHCODE ASC, HAUSERSTARTED_ITEMID ASC, USERGUID ASC, RowNbr ASC) 
            );

    CREATE CLUSTERED INDEX CI_TEMPEdwHAHashkeys ON dbo.LKUP_DeletedEdwHAHashkeys
	   (
		    HAUSERSTARTED_ITEMID ASC,
		    USERGUID ASC,
		    PKHASHCODE ASC
	   );
    
    -- delete from ##STAGED_EDW_PkHashkey where PKHashCode in (select top 1000 PKHashCode from STAGED_EDW_PkHashkey)
    -- exec proc_CT_HA_MarkDeletedRecords

    --*********************************************************************
    --If a record exists in the Staging Table and not in the temp table
    --Then it has been deleted. Take all the HASH KEYS in the Staging
    --table and remove those HASH KEYS that exists in the TEMP table,
    --and the ones remaining have been deleted from the STAGING table.
    --*********************************************************************
    WITH CTE_DEL (
         HAUserStarted_ItemID
       , UserGUID
       , PKHashCode
    ) 
        AS (
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
               FROM STAGED_EDW_PkHashkey
			WHERE ISNULL (DeletedFlg, 0) = 0
        EXCEPT
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
               FROM ##STAGED_EDW_PkHashkey               
        ) 
        INSERT INTO LKUP_DeletedEdwHAHashkeys
        (
               HAUSERSTARTED_ITEMID
             , USERGUID
             , PKHASHCODE) 
        SELECT
               HAUSERSTARTED_ITEMID
             , USERGUID
             , PKHASHCODE
               FROM CTE_DEL;


    -- select  count(*) from LKUP_DeletedEdwHAHashkeys ;

    UPDATE S
           SET
               S.DeletedFlg = 1
             ,S.ChangeDate = GETDATE () 
             ,S.ChangeType = 'D'
               FROM STAGED_EDW_PkHashkey AS S
                        JOIN
                        LKUP_DeletedEdwHAHashkeys AS C
                            ON
                            C.PKHashCode = S.PKHashCode
                        AND C.HAUSERSTARTED_ITEMID = S.HAUSERSTARTED_ITEMID
                        AND C.UserGUID = S.UserGUID;    

    UPDATE S
           SET
               DeletedFlg = 1
             ,LastModifiedDate = GETDATE () 
             --,ChangeType = 'D'
               FROM DIM_EDW_HealthAssessment AS S
                        JOIN
                        LKUP_DeletedEdwHAHashkeys AS C
                            ON
                            C.PKHashCode = S.PKHashCode
                        AND C.HAUSERSTARTED_ITEMID = S.UserStartedItemID
                        AND C.UserGUID = S.UserGUID;
    
    DECLARE
    @iDels AS int = @@ROWCOUNT;

        UPDATE dbo.CT_VersionTracking
           SET
               CNT_Delete = @iDels
    WHERE
          SVRName = @@SERVERNAME
      AND DBName = DB_NAME () 
      AND TgtView = 'view_EDW_HealthAssesment'
      AND rownbr = (select max(RowNbr) from CT_VersionTracking where TgtView = 'view_EDW_HealthAssesment')

    PRINT 'NUMBER OF ROWS flagged as deleted: ' + CAST (@iDels AS nvarchar (50)) ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process MarkDeletedRecords - FIND AND MARK Deleted Recs', @CT, @ET;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Deleted Recs: END Process', @CT, @ET;
    RETURN @iDels;

END;

GO
PRINT 'Executed MarkDeletedRecords.sql';
--select top 1000 * from [@EdwHAHashkeys] order by RowNbr
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*------------------------------------------------------------
DELETE FROM DIM_EDW_HealthAssessment
WHERE
      PkHashCode IN (SELECT TOP 1000
                            PkHashCode
                          FROM DIM_EDW_HealthAssessment) ;

SELECT
       COUNT (*) 
       FROM DIM_EDW_HealthAssessment;
*/
GO

PRINT 'Execute proc_CT_HA_MarkNewRecords.sql';

GO

--0.23.2015 03:36:42
--0.24.2015 00:08:42 @ 1,000,000 no CT
--0.24.2015 00:05:16 @ 1,000,000 no CT / no DUPS
--0.24.2015 00:04:56 @ 1,000,000 no CT / no DUPS / TEMP TABLE
-- select count(*) from [@EdwHAHashkeys]
-- exec [proc_CT_HA_MarkNewRecords]

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_HA_MarkNewRecords') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_MarkNewRecords;
    END;

GO
-- exec [proc_CT_HA_MarkNewRecords]
CREATE PROCEDURE proc_CT_HA_MarkNewRecords
AS
BEGIN

    --************************************************
    --MAKE SURE THE STAGED HASH KEY Table exists
    EXEC proc_Create_STAGED_EDW_PkHashkey_TBL ;
    --************************************************

    DECLARE @st AS datetime = GETDATE () ;
    DECLARE @ET AS datetime = GETDATE () ;
    DECLARE @CT AS datetime = GETDATE () ;

    DECLARE @LatestDbVersionToPull AS bigint = 0;
    SET @LatestDbVersionToPull = CHANGE_TRACKING_CURRENT_VERSION () - 1;



    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK New Recs: START determine if NEW records present', @CT, NULL;
    --**************************************************************
declare @iChgTypes as int = 0 ; 
declare @NbrOfDetectedChanges as bigint = 0 ; 
    EXEC @iChgTypes = proc_CkHaDataChanged NULL, @NbrOfDetectedChanges OUTPUT;
    PRINT 'iChgType is: ' + CAST (@iChgTypes AS nvarchar (50)) ;
    PRINT 'Total Number Of Changes to process is: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) ;
    --**************************************************************
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK New Recs: END determine if NEW records present', @CT, @ET;
/*-------------------------------
if @iChgTypes = 
0 - no changes
1 - updates only
2 - deletes only
3 - deletes and updates
4 - inserts only
5 - inserts and updates
6 - inserts and deletes
7 - inserts, updates, and deletes
*/
    IF @iChgTypes = 0
    OR @iChgTypes = 2
    OR @iChgTypes = 4
    OR @iChgTypes = 6
        BEGIN
            PRINT 'NO INSERTS found.';
        --RETURN 0;
        END;

    SET @CT = GETDATE () ;

    -- EXEC proc_EDW_BuildStagingTables null

    --****************************************
    EXEC proc_EDW_Gen_Temp_PkHashKeys ;
    --****************************************

    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK New Recs: START Process MarkNewRecords - FIND AND MARK NEW Recs', @CT, NULL;

    -- select top 100 * from STAGED_EDW_PkHashkey
    --  drop table LKUP_NewEdwHAHashkeys

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE name = 'LKUP_NewEdwHAHashkeys') 
        BEGIN
            PRINT 'Creating LKUP_NewEdwHAHashkeys';
            CREATE TABLE LKUP_NewEdwHAHashkeys
            (
                         HAUSERSTARTED_ITEMID int  NOT NULL
                       , USERGUID uniqueidentifier  NOT NULL
                       , PKHASHCODE nvarchar (100) NOT NULL
                       , HASHCODE nvarchar (100) NOT NULL
            );

            CREATE CLUSTERED INDEX CI_TEMPEdwNewHAHashkeys ON dbo.LKUP_NewEdwHAHashkeys
            (
            PKHASHCODE ASC,
            HAUSERSTARTED_ITEMID ASC,
            HASHCODE ASC,
            USERGUID ASC
            );
        END;
    ELSE
        BEGIN
            PRINT 'RELOADING LKUP_NewEdwHAHashkeys';
            truncate TABLE LKUP_NewEdwHAHashkeys;
        END;

    -- select count(*) from LKUP_NewEdwHAHashkeys
    -- delete from STAGED_EDW_PkHashkey where RowNbr in (select top 100 RowNbr from STAGED_EDW_PkHashkey)
    -- exec proc_CT_HA_MarkNewRecords

    --***************************************************************************
    --If a record exists in the TEMP table and not in the staging table,
    --it is a NEW record. Take all the PKHASHKEYS from the temp table
    --and remove those same keys that exist in the STAGED table and those 
    --that are remaining in the TEMP table are newly added records. Add those 
    --records to the staged data.
    --NOTE: The HASHCODE need not be considered here as the PHHASHCODE is the 
    --	  only one of importance.
    --***************************************************************************
    WITH CTE_TBL (
         HAUserStarted_ItemID
       , UserGUID
       , PKHashCode
       , HashCode) 
        AS (
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
             , HashCode
               FROM ##STAGED_EDW_PkHashkey
        EXCEPT
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
             , HashCode
               FROM STAGED_EDW_PkHashkey
               WHERE ISNULL (DeletedFlg, 0) = 0
        ) 
        INSERT INTO LKUP_NewEdwHAHashkeys
        (
               HAUSERSTARTED_ITEMID
             , USERGUID
             , PKHASHCODE
             , HashCode) 
        SELECT
               HAUSERSTARTED_ITEMID
             , USERGUID
             , PKHASHCODE
             , HashCode
               FROM CTE_TBL;

    -- JUST INCASE, REMOVE DUPS
    -- select * from LKUP_NewEdwHAHashkeys
    WITH CTE (
         PKHASHCODE
       , HAUSERSTARTED_ITEMID
       , USERGUID
       , HashCode
       , DuplicateCount) 
        AS (
        SELECT
               PKHASHCODE
             , HAUSERSTARTED_ITEMID
             , USERGUID
             , HashCode
             , ROW_NUMBER () OVER ( PARTITION BY PKHASHCODE
                                               , HAUSERSTARTED_ITEMID
                                               , USERGUID
                                               , HashCode
               ORDER BY PKHASHCODE , HAUSERSTARTED_ITEMID , USERGUID, HashCode) AS DuplicateCount
               FROM LKUP_NewEdwHAHashkeys
        ) 
        DELETE
        FROM CTE
        WHERE
              DuplicateCount > 1;
    -- select  count(*) from LKUP_NewEdwHAHashkeys ;
    INSERT INTO STAGED_EDW_PkHashkey
    (
           HAUSERSTARTED_ITEMID
         , USERGUID
         , HASHCODE
         , PKHASHCODE
         , ChangeType
         , ChangeDate
         , DeletedFlg
         , SVR
         , DBNAME) 
    SELECT
           HAUSERSTARTED_ITEMID
         , USERGUID
         , HASHCODE
         , PKHASHCODE
         , 'I' AS ChangeType
         , GETDATE () AS ChangeDate
         , 0 AS DeletedFlg
         , @@SERVERNAME AS SVR
         , DB_NAME () AS DBNAME
           FROM LKUP_NewEdwHAHashkeys;

    INSERT INTO DIM_EDW_HealthAssessment
    (
           UserStartedITEMID
         , HEALTHASSESMENTUserStartedNODEGUID
         , USERID
         , USERGUID
         , HFITUSERMPINUMBER
         , SITEGUID
         , ACCOUNTID
         , ACCOUNTCD
         , ACCOUNTNAME
         , HASTARTEDDT
         , HACOMPLETEDDT
         , USERMODULEITEMID
         , USERMODULECODENAME
         , HAMODULENODEGUID
         , CMSNODEGUID
         , HAMODULEVERSIONID
         , USERRISKCATEGORYITEMID
         , USERRISKCATEGORYCODENAME
         , HARISKCATEGORYNODEGUID
         , HARISKCATEGORYVERSIONID
         , USERRISKAREAITEMID
         , USERRISKAREACODENAME
         , HARISKAREANODEGUID
         , HARISKAREAVERSIONID
         , USERQUESTIONITEMID
         , TITLE
         , HAQUESTIONGUID
         , USERQUESTIONCODENAME
         , HAQUESTIONDOCUMENTID
         , HAQUESTIONVERSIONID
         , HAQUESTIONNODEGUID
         , USERANSWERITEMID
         , HAANSWERNODEGUID
         , HAANSWERVERSIONID
         , USERANSWERCODENAME
         , HAANSWERVALUE
         , HAMODULESCORE
         , HARISKCATEGORYSCORE
         , HARISKAREASCORE
         , HAQUESTIONSCORE
         , HAANSWERPOINTS
         , POINTRESULTS
         , UOMCODE
         , HASCORE
         , MODULEPREWEIGHTEDSCORE
         , RISKCATEGORYPREWEIGHTEDSCORE
         , RISKAREAPREWEIGHTEDSCORE
         , QUESTIONPREWEIGHTEDSCORE
         , QUESTIONGROUPCODENAME
         , ITEMCREATEDWHEN
         , ITEMMODIFIEDWHEN
         , ISPROFESSIONALLYCOLLECTED
         , HARISKCATEGORY_ITEMMODIFIEDWHEN
         , HAUSERRISKAREA_ITEMMODIFIEDWHEN
         , HAUSERQUESTION_ITEMMODIFIEDWHEN
         , HAUSERANSWERS_ITEMMODIFIEDWHEN
         , HAPAPERFLG
         , HATELEPHONICFLG
         , HASTARTEDMODE
         , HACOMPLETEDMODE
         , DOCUMENTCULTURE_VHCJ
         , DOCUMENTCULTURE_HAQUESTIONSVIEW
         , CAMPAIGNNODEGUID
         , HACAMPAIGNID
         , HASHCODE
         , PKHASHCODE
         , CHANGED_FLG
         , LASTMODIFIEDDATE
         , HEALTHASSESSMENTTYPE
         , HAUserStarted_LASTMODIFIED
         , CMSUSER_LASTMODIFIED
         , USERSETTINGS_LASTMODIFIED
         , USERSITE_LASTMODIFIED
         , CMSSITE_LASTMODIFIED
         , ACCT_LASTMODIFIED
         , HAUSERMODULE_LASTMODIFIED
         , VHCJ_LASTMODIFIED
         , VHAJ_LASTMODIFIED
         , HARISKCATEGORY_LASTMODIFIED
         , HAUSERRISKAREA_LASTMODIFIED
         , HAUSERQUESTION_LASTMODIFIED
         , HAQUESTIONSVIEW_LASTMODIFIED
         , HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED
         , HAUSERANSWERS_LASTMODIFIED
         , HAUserStarted_LastUpdateID
         , CMSUSER_LastUpdateID
         , USERSETTINGS_LastUpdateID
         , USERSITE_LastUpdateID
         , ACCT_LastUpdateID
         , HAUSERMODULE_LastUpdateID
         , VHCJ_LastUpdateID
         , VHAJ_LastUpdateID
         , HARISKCATEGORY_LastUpdateID
         , HAUSERRISKAREA_LastUpdateID
         , HAUSERQUESTION_LastUpdateID
         , HAQUESTIONSVIEW_LastUpdateID
         , HAUSERQUESTIONGROUPRESULTS_LastUpdateID
         , HAUSERANSWERS_LastUpdateID
           --,[LASTUPDATEID]
         , DELETEFLG
         , SVR
         , DBNAME
         , DELETEDFLG
         --, ChangeType
    ) 
    SELECT
           T.UserStartedITEMID
         , T.HEALTHASSESMENTUserStartedNODEGUID
         , T.USERID
         , T.USERGUID
         , T.HFITUSERMPINUMBER
         , T.SITEGUID
         , T.ACCOUNTID
         , T.ACCOUNTCD
         , T.ACCOUNTNAME
         , T.HASTARTEDDT
         , T.HACOMPLETEDDT
         , T.USERMODULEITEMID
         , T.USERMODULECODENAME
         , T.HAMODULENODEGUID
         , T.CMSNODEGUID
         , T.HAMODULEVERSIONID
         , T.USERRISKCATEGORYITEMID
         , T.USERRISKCATEGORYCODENAME
         , T.HARISKCATEGORYNODEGUID
         , T.HARISKCATEGORYVERSIONID
         , T.USERRISKAREAITEMID
         , T.USERRISKAREACODENAME
         , T.HARISKAREANODEGUID
         , T.HARISKAREAVERSIONID
         , T.USERQUESTIONITEMID
         , T.TITLE
         , T.HAQUESTIONGUID
         , T.USERQUESTIONCODENAME
         , T.HAQUESTIONDOCUMENTID
         , T.HAQUESTIONVERSIONID
         , T.HAQUESTIONNODEGUID
         , T.USERANSWERITEMID
         , T.HAANSWERNODEGUID
         , T.HAANSWERVERSIONID
         , T.USERANSWERCODENAME
         , T.HAANSWERVALUE
         , T.HAMODULESCORE
         , T.HARISKCATEGORYSCORE
         , T.HARISKAREASCORE
         , T.HAQUESTIONSCORE
         , T.HAANSWERPOINTS
         , T.POINTRESULTS
         , T.UOMCODE
         , T.HASCORE
         , T.MODULEPREWEIGHTEDSCORE
         , T.RISKCATEGORYPREWEIGHTEDSCORE
         , T.RISKAREAPREWEIGHTEDSCORE
         , T.QUESTIONPREWEIGHTEDSCORE
         , T.QUESTIONGROUPCODENAME
         , T.ITEMCREATEDWHEN
         , T.ITEMMODIFIEDWHEN
         , T.ISPROFESSIONALLYCOLLECTED
         , T.HARISKCATEGORY_ITEMMODIFIEDWHEN
         , T.HAUSERRISKAREA_ITEMMODIFIEDWHEN
         , T.HAUSERQUESTION_ITEMMODIFIEDWHEN
         , T.HAUSERANSWERS_ITEMMODIFIEDWHEN
         , T.HAPAPERFLG
         , T.HATELEPHONICFLG
         , T.HASTARTEDMODE
         , T.HACOMPLETEDMODE
         , T.DOCUMENTCULTURE_VHCJ
         , T.DOCUMENTCULTURE_HAQUESTIONSVIEW
         , T.CAMPAIGNNODEGUID
         , T.HACAMPAIGNID
         , T.HASHCODE
         , T.PKHASHCODE
         , T.CHANGED_FLG
         , T.LASTMODIFIEDDATE
         , T.HEALTHASSESSMENTTYPE
         , T.HAUserStarted_LASTMODIFIED
         , T.CMSUSER_LASTMODIFIED
         , T.USERSETTINGS_LASTMODIFIED
         , T.USERSITE_LASTMODIFIED
         , T.CMSSITE_LASTMODIFIED
         , T.ACCT_LASTMODIFIED
         , T.HAUSERMODULE_LASTMODIFIED
         , T.VHCJ_LASTMODIFIED
         , T.VHAJ_LASTMODIFIED
         , T.HARISKCATEGORY_LASTMODIFIED
         , T.HAUSERRISKAREA_LASTMODIFIED
         , T.HAUSERQUESTION_LASTMODIFIED
         , T.HAQUESTIONSVIEW_LASTMODIFIED
         , T.HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED
         , T.HAUSERANSWERS_LASTMODIFIED
         , T.HAUserStarted_LastUpdateID
         , T.CMSUSER_LastUpdateID
         , T.USERSETTINGS_LastUpdateID
         , T.USERSITE_LastUpdateID
         , T.ACCT_LastUpdateID
         , T.HAUSERMODULE_LastUpdateID
         , T.VHCJ_LastUpdateID
         , T.VHAJ_LastUpdateID
         , T.HARISKCATEGORY_LastUpdateID
         , T.HAUSERRISKAREA_LastUpdateID
         , T.HAUSERQUESTION_LastUpdateID
         , T.HAQUESTIONSVIEW_LastUpdateID
         , T.HAUSERQUESTIONGROUPRESULTS_LastUpdateID
         , T.HAUSERANSWERS_LastUpdateID
           --,T.[LASTUPDATEID]
         , T.DELETEFLG
         , T.SVR
         , T.DBNAME
         , T.DELETEDFLG
         --, 'I' AS ChangeType
           FROM
               view_EDW_PullHAData_NoCT_Inserts AS T
                   JOIN LKUP_NewEdwHAHashkeys AS C
                       ON C.HAUSERSTARTED_ITEMID = T.UserStartedItemID
                      AND C.UserGUID = T.UserGUID
                      AND C.PKHashCode = T.PKHashCode;

    --******************************************************************************
    DECLARE
    @iNewRecs AS int = @@ROWCOUNT;

    UPDATE dbo.CT_VersionTracking
           SET
               CNT_Insert = @iNewRecs
    WHERE
          SVRName = @@SERVERNAME
      AND DBName = DB_NAME () 
      AND TgtView = 'view_EDW_HealthAssesment'
      AND rownbr = (select max(RowNbr) from CT_VersionTracking where TgtView = 'view_EDW_HealthAssesment')

    --WITH CTE (
    --     PKHASHCODE
    --   , HAUSERSTARTEDITEMID
    --   , USERGUID
    --   , HashCode
    --   , DuplicateCount) 
    --    AS (
    --    SELECT
    --           PKHASHCODE
    --         , UserStartedITEMID
    --         , USERGUID
    --         , HashCode
    --         , ROW_NUMBER () OVER ( PARTITION BY PKHASHCODE
    --                                           , UserStartedITEMID
    --                                           , USERGUID
    --                                           , HashCode
    --           ORDER BY PKHASHCODE , UserStartedITEMID , USERGUID, HashCode) AS DuplicateCount
    --           FROM DIM_EDW_HealthAssessment
    --    ) 
    --    DELETE
    --    FROM CTE
    --    WHERE
    --          DuplicateCount > 1;

    PRINT 'NUMBER OF ROWS flagged as NEW: ' + CAST (@iNewRecs AS nvarchar (50)) ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK New Recs: END Process MarkNewRecords - FIND AND MARK NEW Recs', @CT, @ET;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK New Recs: END Process', @CT, @ET;
    RETURN @iNewRecs;

END;

GO
PRINT 'Executed MarkNewRecords.sql';
--select top 1000 * from [@EdwHAHashkeys] order by RowNbr
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*------------------------------------------------------------
DELETE FROM DIM_EDW_HealthAssessment
WHERE
      PkHashCode IN (SELECT TOP 1000
                            PkHashCode
                          FROM DIM_EDW_HealthAssessment) ;

SELECT
       COUNT (*) 
       FROM DIM_EDW_HealthAssessment;
*/
GO

PRINT 'Execute proc_CT_HA_MarkUpdatedRecords.sql';

GO

-- exec [proc_CT_HA_MarkUpdatedRecords]

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_HA_MarkUpdatedRecords') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HA_MarkUpdatedRecords;
    END;

GO
-- exec [proc_CT_HA_MarkUpdatedRecords]
CREATE PROCEDURE proc_CT_HA_MarkUpdatedRecords
AS
BEGIN

    DECLARE @st AS datetime = GETDATE () ;
    DECLARE @ET AS datetime = GETDATE () ;
    DECLARE @CT AS datetime = GETDATE () ;

    DECLARE @LatestDbVersionToPull AS bigint = 0;
    SET @LatestDbVersionToPull = CHANGE_TRACKING_CURRENT_VERSION () - 1;


    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Updated Recs: START determine if DELETED records present', @CT, NULL;
    --**************************************************************
declare @iChgTypes as int = 0 ; 
declare @NbrOfDetectedChanges as bigint = 0 ; 
    EXEC @iChgTypes = proc_CkHaDataChanged NULL, @NbrOfDetectedChanges OUTPUT;
    PRINT 'iChgType is: ' + CAST (@iChgTypes AS nvarchar (50)) ;
    PRINT 'Total Number Of Changes to process is: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) ;
    --**************************************************************
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Updated Recs: END determine if DELETED records present', @CT, @ET;
/*-----------------------------------
-------------------------------
if @iChgTypes = 
    0 - no changes
    1 - updates only
    2 - deletes only
    3 - deletes and updates
    4 - inserts only
    5 - inserts and updates
    6 - inserts and deletes
    7 - inserts, updates, and deletes
*/
    IF @iChgTypes = 0
    OR @iChgTypes = 2
    OR @iChgTypes = 4
    OR @iChgTypes = 6
        BEGIN
            PRINT 'NO INSERTS found.';
            RETURN 0;
        END;

    --************************************************
    --MAKE SURE THE STAGED HASH KEY Table exists
    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Updated Recs: START Process proc_Create_STAGED_EDW_PkHashkey_TBL', @CT, NULL;
    EXEC proc_Create_STAGED_EDW_PkHashkey_TBL ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Updated Recs: START Process proc_Create_STAGED_EDW_PkHashkey_TBL', @CT, @ET;
    --************************************************

    SET @CT = GETDATE () ;
    EXEC proc_trace 'MARK Updated Recs: START Process MarkUpdatedRecords - FIND AND MARK Deleted Recs', @CT, NULL;

    -- select top 100 * from STAGED_EDW_PkHashkey
    --  drop table LKUP_UpdatedEdwHAHashkeys

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE name = 'LKUP_UpdatedEdwHAHashkeys') 
        BEGIN
            PRINT 'Creating LKUP_UpdatedEdwHAHashkeys';
            CREATE TABLE LKUP_UpdatedEdwHAHashkeys
            (
                         HAUSERSTARTED_ITEMID int  NOT NULL
                       , USERGUID uniqueidentifier  NOT NULL
                       , PKHASHCODE nvarchar (100) NOT NULL
                       , HASHCODE nvarchar (100) NOT NULL
            --, RowNbr int IDENTITY (1 , 1) 
            --             NOT NULL
            --  PRIMARY KEY ( PKHASHCODE ASC, HAUSERSTARTED_ITEMID ASC, USERGUID ASC, RowNbr ASC) 
            );

            CREATE CLUSTERED INDEX CI_TEMPEdwHAHashkeys ON dbo.LKUP_UpdatedEdwHAHashkeys
            (
            HAUSERSTARTED_ITEMID ASC,
            PKHASHCODE ASC,
            HASHCODE ASC,
            USERGUID ASC
            );
        END;
    ELSE
        BEGIN
            PRINT 'RELOADING LKUP_UpdatedEdwHAHashkeys';
            truncate TABLE LKUP_UpdatedEdwHAHashkeys;
        END;

    -- select count(*) from LKUP_UpdatedEdwHAHashkeys
    -- update STAGED_EDW_PkHashkey set HASHCODE = cast(hashbytes('sha1','WDaleMiller') as nvarchar(100)) where RowNbr in (select top 100 RowNbr from STAGED_EDW_PkHashkey)
    -- exec proc_CT_HA_MarkUpdatedRecords

    --****************************************************************************
    --If a record exists in both the temp table and the staging table
    --and the Hashcode is not the same, then the record has been updated.
    --It is critical to skip records that have been previously marked as deleted. 
    --Take all HASH KEYS and HASH CODES from the temp table and remove
    --The ones that are the same in the staging TABLE. The remaining keys
    --belong to records that have been UPDATED as the HASCODE will be 
    --different. Apply those records back to the staged data.
    --****************************************************************************
    WITH CTE_TBL (
         HAUserStarted_ItemID
       , UserGUID
       , PKHashCode
       , HashCode) 
        AS (
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
             , HashCode
               FROM ##STAGED_EDW_PkHashkey
        EXCEPT
        SELECT
               HAUserStarted_ItemID
             , UserGUID
             , PKHashCode
             , HashCode
               FROM STAGED_EDW_PkHashkey
               WHERE ISNULL (DeletedFlg, 0) = 0
        ) 
        INSERT INTO LKUP_UpdatedEdwHAHashkeys
        (
               HAUSERSTARTED_ITEMID
             , USERGUID
             , PKHASHCODE
             , HASHCODE) 
        SELECT
               HAUSERSTARTED_ITEMID
             , USERGUID
             , PKHASHCODE
             , HASHCODE
               FROM CTE_TBL;

    -- JUST INCASE, REMOVE DUPS
    WITH CTE (
         PKHASHCODE
       , HAUSERSTARTED_ITEMID
       , HASHCODE
       , USERGUID
       , DuplicateCount) 
        AS (
        SELECT
               PKHASHCODE
             , HAUSERSTARTED_ITEMID
             , HASHCODE
             , USERGUID
             , ROW_NUMBER () OVER ( PARTITION BY PKHASHCODE
                                               , HAUSERSTARTED_ITEMID
                                               , HASHCODE
                                               , USERGUID  ORDER BY PKHASHCODE , HAUSERSTARTED_ITEMID , HASHCODE, USERGUID) AS DuplicateCount
               FROM LKUP_UpdatedEdwHAHashkeys
        ) 
        DELETE
        FROM CTE
        WHERE
              DuplicateCount > 1;
    -- select  count(*) from LKUP_UpdatedEdwHAHashkeys ;

    UPDATE S
           SET
               S.DeletedFlg = 0
             ,S.ChangeDate = GETDATE () 
             ,S.ChangeType = 'U'
               FROM STAGED_EDW_PkHashkey AS S
                        JOIN
                        LKUP_UpdatedEdwHAHashkeys AS C
                            ON
                            C.PKHashCode = S.PKHashCode
                        AND C.HAUSERSTARTED_ITEMID = S.HAUSERSTARTED_ITEMID
                        AND C.UserGUID = S.UserGUID;

    --******************************************************************************
    DECLARE
    @RUNDATE AS  datetime2 ( 7) = GETDATE () ;

    UPDATE S
           SET
               S.UserStartedITEMID = T.UserStartedITEMID
             ,S.HEALTHASSESMENTUserStartedNODEGUID = T.HEALTHASSESMENTUserStartedNODEGUID
             ,S.USERID = T.USERID
             ,S.USERGUID = T.USERGUID
             ,S.HFITUSERMPINUMBER = T.HFITUSERMPINUMBER
             ,S.SITEGUID = T.SITEGUID
             ,S.ACCOUNTID = T.ACCOUNTID
             ,S.ACCOUNTCD = T.ACCOUNTCD
             ,S.ACCOUNTNAME = T.ACCOUNTNAME
             ,S.HASTARTEDDT = T.HASTARTEDDT
             ,S.HACOMPLETEDDT = T.HACOMPLETEDDT
             ,S.USERMODULEITEMID = T.USERMODULEITEMID
             ,S.USERMODULECODENAME = T.USERMODULECODENAME
             ,S.HAMODULENODEGUID = T.HAMODULENODEGUID
             ,S.CMSNODEGUID = T.CMSNODEGUID
             ,S.HAMODULEVERSIONID = T.HAMODULEVERSIONID
             ,S.USERRISKCATEGORYITEMID = T.USERRISKCATEGORYITEMID
             ,S.USERRISKCATEGORYCODENAME = T.USERRISKCATEGORYCODENAME
             ,S.HARISKCATEGORYNODEGUID = T.HARISKCATEGORYNODEGUID
             ,S.HARISKCATEGORYVERSIONID = T.HARISKCATEGORYVERSIONID
             ,S.USERRISKAREAITEMID = T.USERRISKAREAITEMID
             ,S.USERRISKAREACODENAME = T.USERRISKAREACODENAME
             ,S.HARISKAREANODEGUID = T.HARISKAREANODEGUID
             ,S.HARISKAREAVERSIONID = T.HARISKAREAVERSIONID
             ,S.USERQUESTIONITEMID = T.USERQUESTIONITEMID
             ,S.TITLE = T.TITLE
             ,S.HAQUESTIONGUID = T.HAQUESTIONGUID
             ,S.USERQUESTIONCODENAME = T.USERQUESTIONCODENAME
             ,S.HAQUESTIONDOCUMENTID = T.HAQUESTIONDOCUMENTID
             ,S.HAQUESTIONVERSIONID = T.HAQUESTIONVERSIONID
             ,S.HAQUESTIONNODEGUID = T.HAQUESTIONNODEGUID
             ,S.USERANSWERITEMID = T.USERANSWERITEMID
             ,S.HAANSWERNODEGUID = T.HAANSWERNODEGUID
             ,S.HAANSWERVERSIONID = T.HAANSWERVERSIONID
             ,S.USERANSWERCODENAME = T.USERANSWERCODENAME
             ,S.HAANSWERVALUE = T.HAANSWERVALUE
             ,S.HAMODULESCORE = T.HAMODULESCORE
             ,S.HARISKCATEGORYSCORE = T.HARISKCATEGORYSCORE
             ,S.HARISKAREASCORE = T.HARISKAREASCORE
             ,S.HAQUESTIONSCORE = T.HAQUESTIONSCORE
             ,S.HAANSWERPOINTS = T.HAANSWERPOINTS
             ,S.POINTRESULTS = T.POINTRESULTS
             ,S.UOMCODE = T.UOMCODE
             ,S.HASCORE = T.HASCORE
             ,S.MODULEPREWEIGHTEDSCORE = T.MODULEPREWEIGHTEDSCORE
             ,S.RISKCATEGORYPREWEIGHTEDSCORE = T.RISKCATEGORYPREWEIGHTEDSCORE
             ,S.RISKAREAPREWEIGHTEDSCORE = T.RISKAREAPREWEIGHTEDSCORE
             ,S.QUESTIONPREWEIGHTEDSCORE = T.QUESTIONPREWEIGHTEDSCORE
             ,S.QUESTIONGROUPCODENAME = T.QUESTIONGROUPCODENAME
             ,S.ITEMCREATEDWHEN = T.ITEMCREATEDWHEN
             ,S.ITEMMODIFIEDWHEN = T.ITEMMODIFIEDWHEN
             ,S.ISPROFESSIONALLYCOLLECTED = T.ISPROFESSIONALLYCOLLECTED
             ,S.HARISKCATEGORY_ITEMMODIFIEDWHEN = T.HARISKCATEGORY_ITEMMODIFIEDWHEN
             ,S.HAUSERRISKAREA_ITEMMODIFIEDWHEN = T.HAUSERRISKAREA_ITEMMODIFIEDWHEN
             ,S.HAUSERQUESTION_ITEMMODIFIEDWHEN = T.HAUSERQUESTION_ITEMMODIFIEDWHEN
             ,S.HAUSERANSWERS_ITEMMODIFIEDWHEN = T.HAUSERANSWERS_ITEMMODIFIEDWHEN
             ,S.HAPAPERFLG = T.HAPAPERFLG
             ,S.HATELEPHONICFLG = T.HATELEPHONICFLG
             ,S.HASTARTEDMODE = T.HASTARTEDMODE
             ,S.HACOMPLETEDMODE = T.HACOMPLETEDMODE
             ,S.DOCUMENTCULTURE_VHCJ = T.DOCUMENTCULTURE_VHCJ
             ,S.DOCUMENTCULTURE_HAQUESTIONSVIEW = T.DOCUMENTCULTURE_HAQUESTIONSVIEW
             ,S.CAMPAIGNNODEGUID = T.CAMPAIGNNODEGUID
             ,S.HACAMPAIGNID = T.HACAMPAIGNID
             ,S.HASHCODE = T.HASHCODE
             ,S.CHANGED_FLG = T.CHANGED_FLG
             ,S.HEALTHASSESSMENTTYPE = T.HEALTHASSESSMENTTYPE
             ,S.HAUserStarted_LASTMODIFIED = T.HAUserStarted_LASTMODIFIED
             ,S.CMSUSER_LASTMODIFIED = T.CMSUSER_LASTMODIFIED
             ,S.USERSETTINGS_LASTMODIFIED = T.USERSETTINGS_LASTMODIFIED
             ,S.USERSITE_LASTMODIFIED = T.USERSITE_LASTMODIFIED
             ,S.CMSSITE_LASTMODIFIED = T.CMSSITE_LASTMODIFIED
             ,S.ACCT_LASTMODIFIED = T.ACCT_LASTMODIFIED
             ,S.HAUSERMODULE_LASTMODIFIED = T.HAUSERMODULE_LASTMODIFIED
             ,S.VHCJ_LASTMODIFIED = T.VHCJ_LASTMODIFIED
             ,S.VHAJ_LASTMODIFIED = T.VHAJ_LASTMODIFIED
             ,S.HARISKCATEGORY_LASTMODIFIED = T.HARISKCATEGORY_LASTMODIFIED
             ,S.HAUSERRISKAREA_LASTMODIFIED = T.HAUSERRISKAREA_LASTMODIFIED
             ,S.HAUSERQUESTION_LASTMODIFIED = T.HAUSERQUESTION_LASTMODIFIED
             ,S.HAQUESTIONSVIEW_LASTMODIFIED = T.HAQUESTIONSVIEW_LASTMODIFIED
             ,S.HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED = T.HAUSERQUESTIONGROUPRESULTS_LASTMODIFIED
             ,S.HAUSERANSWERS_LASTMODIFIED = T.HAUSERANSWERS_LASTMODIFIED
             ,S.HAUserStarted_LastUpdateID = T.HAUserStarted_LastUpdateID
             ,S.CMSUSER_LastUpdateID = T.CMSUSER_LastUpdateID
             ,S.USERSETTINGS_LastUpdateID = T.USERSETTINGS_LastUpdateID
             ,S.USERSITE_LastUpdateID = T.USERSITE_LastUpdateID
             ,S.ACCT_LastUpdateID = T.ACCT_LastUpdateID
             ,S.HAUSERMODULE_LastUpdateID = T.HAUSERMODULE_LastUpdateID
             ,S.VHCJ_LastUpdateID = T.VHCJ_LastUpdateID
             ,S.VHAJ_LastUpdateID = T.VHAJ_LastUpdateID
             ,S.HARISKCATEGORY_LastUpdateID = T.HARISKCATEGORY_LastUpdateID
             ,S.HAUSERRISKAREA_LastUpdateID = T.HAUSERRISKAREA_LastUpdateID
             ,S.HAUSERQUESTION_LastUpdateID = T.HAUSERQUESTION_LastUpdateID
             ,S.HAQUESTIONSVIEW_LastUpdateID = T.HAQUESTIONSVIEW_LastUpdateID
             ,S.HAUSERQUESTIONGROUPRESULTS_LastUpdateID = T.HAUSERQUESTIONGROUPRESULTS_LastUpdateID
             ,S.HAUSERANSWERS_LastUpdateID = T.HAUSERANSWERS_LastUpdateID

             ,S.DELETEFLG = T.DELETEFLG
             ,S.SVR = T.SVR
             ,S.DBNAME = T.DBNAME

             ,S.ConvertedToCentralTime = NULL
             ,S.LastModifiedDate = GETDATE () 
             ,S.RowNbr = NULL
             ,S.DeletedFlg = NULL
             ,S.TimeZone = NULL
             ,S.PKHashCode = T.PKHashCode
             --,S.ChangeType = 'U'
               FROM
               view_EDW_PullHAData_NoCT_Updates AS T
                   JOIN
                   DIM_EDW_HealthAssessment AS S
                       ON
                       S.UserStartedItemID = T.UserStartedItemID
                   AND S.UserGUID = T.UserGUID
                   AND S.PKHashCode = T.PKHashCode
                   AND S.HashCode != T.HashCode;
    --******************************************************************************
    -- select count(*) from LKUP_UpdatedEdwHAHashkeys
    -- select * from view_EDW_PullHAData_NoCT_Updates
    DECLARE
    @iUpdatedRecs AS int = @@ROWCOUNT;

            UPDATE dbo.CT_VersionTracking
           SET
               CNT_Update = @iUpdatedRecs
    WHERE
          SVRName = @@SERVERNAME
      AND DBName = DB_NAME () 
      AND TgtView = 'view_EDW_HealthAssesment'
      AND rownbr = (select max(RowNbr) from CT_VersionTracking where TgtView = 'view_EDW_HealthAssesment')

    PRINT 'NUMBER OF ROWS flagged as deleted: ' + CAST (@iUpdatedRecs AS nvarchar (50)) ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Updated Recs: END Process MarkUpdatedRecords - FIND AND MARK Deleted Recs', @CT, @ET;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'MARK Updated Recs: END Process', @CT, @ET;
    RETURN @iUpdatedRecs;

END;

GO
PRINT 'Executed MarkUpdatedRecords.sql';
--select top 1000 * from [@EdwHAHashkeys] order by RowNbr
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_EDW_HA_Master.SQL';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EDW_HA_Master') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_HA_Master;
    END;

GO

--  exec proc_EDW_HA_Master
CREATE PROCEDURE proc_EDW_HA_Master
     @ReloadAll AS int = 0
AS
BEGIN

    declare @CT_NAME AS nvarchar ( 50) = 'proc_Staging_EDW_Data' ;
    declare @RecordID AS uniqueidentifier = NEWID () ;
    declare @NbrOfDetectedChanges as bigint = 0 ; 

    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '001 START proc_EDW_HA_Master';

    IF @ReloadAll = 1
        BEGIN
            
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '002 BEGIN RELOAD ALL';

            --**************************************************************************************************
            PRINT 'START proc_EDW_Reload_EDW_HealthAssessment: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @NbrOfDetectedChanges = proc_EDW_Reload_EDW_HealthAssessment ;
            PRINT 'ENDED proc_EDW_Reload_EDW_HealthAssessment: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            --**************************************************************************************************

            PRINT '00 Number of records loaded: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '003 END RELOAD ALL';

            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '004 Begin Converting Time to Central';
            --**************************************************************************************************
            PRINT 'START Converting Time to Central' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthAssessment';
            PRINT 'END Converting Time to Central' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            --**************************************************************************************************
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '005 Complete Converting Time to Central';

            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '006 Begin Cleaning Staging Data';
            PRINT 'START Cleaning Staging Data' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_clean_EDW_Staging;
            PRINT 'END Cleaning Staging Data' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '007 END Cleaning Staging Data';

            PRINT 'Load Complete' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , 0;

            RETURN;
        END;

    DECLARE @ST AS datetime = GETDATE () 
          , @CT AS datetime = GETDATE () 
          , @ET AS datetime = GETDATE () ;

    DECLARE @LatestDbVersionToPull AS bigint = 0;
    SET @LatestDbVersionToPull = CHANGE_TRACKING_CURRENT_VERSION () - 1;

    SET @CT = GETDATE () ;
    EXEC proc_trace 'START MASTER proc_EDW_HA_Master', @CT, NULL;

    --*********************************************************************
    DECLARE @TgtView AS nvarchar ( 100) = 'view_EDW_HealthAssesment';
    DECLARE @CTVersionToPullNow AS int = ( SELECT
                                                  MAX ( CurrentDbVersion) 
                                                  FROM CT_VersionTracking
                                                  WHERE
                                                  SVRname = @@ServerName
                                              AND DBName = DB_NAME () 
                                              AND TgtView = 'view_EDW_HealthAssesment');

    --*********************************************************************
    DECLARE @iChgTypes AS int = 0 ;
    EXEC @iChgTypes = proc_CkHaDataChanged NULL, @NbrOfDetectedChanges OUTPUT;
    PRINT 'iChgType is: ' + CAST (@iChgTypes AS nvarchar (50)) ;
    PRINT 'Total Number Of Changes to process is: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) ;
    IF @iChgTypes = 0
        BEGIN
            PRINT 'NO CHANGES found.';
            RETURN 0;
        END;
    --*********************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'START proc_EDW_BuildStagingTables', @CT, NULL;
    EXEC proc_EDW_BuildStagingTables @CTVersionToPullNow;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END proc_EDW_BuildStagingTables', @CT, @ET;
    --*********************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'START proc_Create_STAGED_EDW_PkHashkey_TBL', @CT, NULL;
    EXEC proc_Create_STAGED_EDW_PkHashkey_TBL ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END proc_Create_STAGED_EDW_PkHashkey_TBL', @CT, @ET;
    --*********************************************************************
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------
if @iChgTypes = 
    0 - no changes 1 - updates only 2 - deletes only 3 - deletes and updates 4 - inserts only 5 - inserts and updates 6 - inserts and deletes 7 - inserts, updates, and deletes
*/
    IF @iChgTypes = 1
    OR @iChgTypes = 3
    OR @iChgTypes = 4
    OR @iChgTypes = 5
    OR @iChgTypes = 6
    OR @iChgTypes = 7
        BEGIN
            --*********************************************************************
            SET @CT = GETDATE () ;
            EXEC proc_trace 'START proc_EDW_Gen_Temp_PkHashKeys', @CT, NULL;
            EXEC proc_EDW_Gen_Temp_PkHashKeys ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END proc_EDW_Gen_Temp_PkHashKeys', @CT, @ET;
        --*********************************************************************
        END;

    --************************************************
    --MAKE SURE THE STAGED HASH KEY Table exists
    EXEC proc_Create_STAGED_EDW_PkHashkey_TBL ;
    --************************************************
    DECLARE @TotalAvailRecs AS bigint = 0;
    EXEC @TotalAvailRecs = proc_QuickRowCount 'DIM_EDW_HealthAssessment';

    INSERT INTO CT_VersionTracking (
           SVRName
         , DBName
         , TgtView
         , ExtractionDate
         , ExtractedVersion
         , CurrentDbVersion
         , ExtractedRowCnt
         , StartTime
         , EndTime
         , CNT_Insert
         , CNT_Update
         , CNT_Delete
         , CNT_StagingTable
         , CNT_PulledRecords) 
    VALUES
           (
           @@SERVERNAME , DB_NAME () , @TgtView , GETDATE () , @LatestDbVersionToPull ,
           @LatestDbVersionToPull , @NbrOfDetectedChanges , @ST , GETDATE () , NULL ,
           NULL, NULL, @TotalAvailRecs , @NbrOfDetectedChanges) ;
    --************************************************

    DECLARE @DBNAME AS nvarchar (100) = DB_NAME () ;
    DECLARE @jName AS nvarchar (100) = '';

    SET @jname = 'job_EDW_CT_HA_MarkDeletedRecords_' + @DBNAME;
    EXEC msdb.dbo.sp_start_job @jname;

    SET @jname = 'job_EDW_CT_HA_MarkUpdatedRecords_' + @DBNAME;
    EXEC msdb.dbo.sp_start_job @jname;

    SET @jname = 'job_EDW_CT_HA_MarkNewRecords_' + @DBNAME;
    EXEC msdb.dbo.sp_start_job @jname;

    SET @ET = GETDATE () ;
    EXEC proc_trace 'END MASTER proc_EDW_HA_Master', @CT, @ET;

--*************************************************************************************
 EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , 0;
--*************************************************************************************

END;

GO
PRINT 'Executed proc_EDW_HA_Master.SQL';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
PRINT 'Executing  Create_job_Proc_EDW_HA_Master' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_HA_Master_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_EDW_HA_Master]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_EDW_HA_Master',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec Proc_EDW_HA_Master;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_HA_Master',
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=24, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20150412, 
		@active_end_date=99991231, 
		@active_start_time=183000, 
		@active_end_time=235959
		--@schedule_uid=N'afcb6980-89fe-4a08-ad03-6598bd55454a'

IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
PRINT 'Executing  Create_job_EDW_CT_HA_MarkNewRecords' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_CT_HA_MarkNewRecords_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_CT_HA_MarkNewRecords]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_CT_HA_MarkNewRecords',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_CT_HA_MarkNewRecords;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_CT_HA_MarkNewRecords',
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=24, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20150412, 
		@active_end_date=99991231, 
		@active_start_time=183000, 
		@active_end_time=235959
		--@schedule_uid=N'afcb6980-89fe-4a08-ad03-6598bd55454a'

IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
PRINT 'Executing  Create_job_EDW_CT_HA_MarkDeletedRecords' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_CT_HA_MarkDeletedRecords_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_CT_HA_MarkDeletedRecords]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_CT_HA_MarkDeletedRecords',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_CT_HA_MarkDeletedRecords;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_CT_HA_MarkDeletedRecords',
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=24, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20150412, 
		@active_end_date=99991231, 
		@active_start_time=183000, 
		@active_end_time=235959 
		--@schedule_uid=N'afcb6980-89fe-4a08-ad03-6598bd55454a'

IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
PRINT 'Executing  Create_job_EDW_CT_HA_MarkUpdatedRecords' ;
GO

BEGIN TRANSACTION;
DECLARE
   @ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                 WHERE name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback
            END;

    END;

DECLARE
   @TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
   @JNAME AS nvarchar (100) = 'job_EDW_CT_HA_MarkUpdatedRecords_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
             WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1
    END;

DECLARE
   @jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;

/****** Object:  Step [Load_CT_HA_MarkUpdatedRecords]    Script Date: 4/12/2015 9:59:37 AM ******/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_CT_HA_MarkUpdatedRecords',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_CT_HA_MarkUpdatedRecords;',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_CT_HA_MarkUpdatedRecords',
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=8, 
		@freq_subday_interval=24, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20150412, 
		@active_end_date=99991231, 
		@active_start_time=183000, 
		@active_end_time=235959
		--@schedule_uid=N'afcb6980-89fe-4a08-ad03-6598bd55454a'

IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go 
print 'Executing view_EDW_CT_VersionTracking' ;
go
if exists (select name from sys.views where name = 'view_EDW_CT_VersionTracking')
    drop view view_EDW_CT_VersionTracking;
go

create view view_EDW_CT_VersionTracking
as 
SELECT
       *
       FROM CT_VersionTracking ;

go 
print 'Executed view_EDW_CT_VersionTracking' ;
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;







GO
PRINT 'Creating proc_QuickRowCount.sql';

GO
IF EXISTS ( SELECT
                   name
              FROM sys.procedures
              WHERE name = 'proc_QuickRowCount' )
    BEGIN
        DROP PROCEDURE
             proc_QuickRowCount
    END;
GO

/*
declare @i as bigint = 0 ;
EXEC @i = proc_QuickRowCount 'Device_RawNotification' ;
print @i ;

    DECLARE
       @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_RewardUserDetail';

    IF @iTotal = 1
        BEGIN
            SET @Reloadall = 1;
        END;

*/

CREATE PROCEDURE proc_QuickRowCount ( @TblName AS nvarchar( 254 ))
AS
BEGIN

    /*********************************************
    Author:	  Dale Miller
    Date:	  02.02.2008
    Copyright:  DMA, Ltd., Chicago, IL
    **********************************************/

    DECLARE
   @i AS bigint = 0;

    SET @i = ( SELECT
                      SUM ( row_count )
                 FROM sys.dm_db_partition_stats
                 WHERE
                      object_id = OBJECT_ID( @TblName )
                  AND (
                      index_id = 0
                   OR index_id = 1));
    if @i is null
	   set @i = 0 ;
    PRINT @i;
    return @i ;
END;

GO
PRINT 'Created proc_QuickRowCount.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
print 'FROM ckChangeTrackingTurnedON.sql';
print 'Installing Change Tracking';
go


DECLARE @DB AS NVarChar (200) = DB_NAME () ;
DECLARE @DBID AS Int = 0;
DECLARE @s AS NVarChar (2000) = '';

IF NOT EXISTS (SELECT
				  [database_id]
			   FROM [sys].[change_tracking_databases]
			   WHERE [database_id] = DB_ID (@DB)) 
    BEGIN
	   SET @s =
			'ALTER DATABASE ' + @DB + ' SET CHANGE_TRACKING = ON (CHANGE_RETENTION = 5 DAYS, AUTO_CLEANUP = ON) ';
	   EXEC (@s) ;
	   PRINT 'Turned Change Tracking On';
    END;

GO
print 'FROM ckChangeTrackingTurnedON.sql';
print 'Installed Change Tracking';
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing proc_ChangeTracking.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_ChangeTracking') 
    BEGIN
        PRINT 'replacing proc_ChangeTracking';
        DROP PROCEDURE
             proc_ChangeTracking;
    END;
GO

-- exec proc_ChangeTracking @InstanceName = 'KenticoCMS_1', @TblName = 'COM_SKU', @Enable = 1
-- exec proc_ChangeTracking 'KenticoCMS_1', 'CMS_USER', 1
CREATE PROCEDURE proc_ChangeTracking (
     @InstanceName AS nvarchar (100) 
   , @TblName AS nvarchar (100) 
   , @Enable AS bit) 
AS
BEGIN
    --DECLARE @InstanceName AS nvarchar (100) = 'KenticoCMS_2';
    --DECLARE @TblName AS nvarchar (100)  = 'CMS_Class';
    --DECLARE @Enable AS bit = 1;
    DECLARE @S AS nvarchar (2000) = '';
    DECLARE @iCnt AS integer = 0;
    DECLARE @TEMPVAR AS TABLE (
                              iCNT integer) ;
PRINT 'INSIDE proc_ChangeTracking: ' + @InstanceName + ' / ' +  @TblName;
    IF @Enable = 1
        BEGIN

            SET @S = 'SELECT count(*) as iCNT FROM ' + CHAR (10) ;
            SET @S = @S + '    ' + @InstanceName + '.sys.change_tracking_tables ' + CHAR (10) ;
            SET @S = @S + '        JOIN ' + @InstanceName + '.sys.tables ' + CHAR (10) ;
            SET @S = @S + '           ON ' + @InstanceName + '.sys.tables.object_id = ' + @InstanceName + '.sys.change_tracking_tables.object_id ' + CHAR (10) ;
            SET @S = @S + '               JOIN ' + @InstanceName + '.sys.schemas ' + CHAR (10) ;
            SET @S = @S + '			    ON ' + @InstanceName + '.sys.schemas.schema_id = ' + @InstanceName + '.sys.tables.schema_id ' + CHAR (10) ;
            SET @S = @S + '           WHERE ' + @InstanceName + '.sys.tables.name = ''' + @TblName + '''';

            INSERT INTO @TEMPVAR
            EXEC (@S) ;
            SET @iCnt = (SELECT TOP 1
                                iCNT
                                FROM @TEMPVAR);

            IF @iCnt = 0
                BEGIN
                    PRINT 'ENABLING Change Tracking on ' + @InstanceName + '.dbo.' + @TblName;
                    SET @S = 'ALTER TABLE ' + @InstanceName + '.dbo.' + @TblName + ' ENABLE CHANGE_TRACKING WITH (TRACK_COLUMNS_UPDATED = ON) ';
    print @S ;
                    EXEC (@S) ;
                END;
            ELSE
                BEGIN
                    PRINT 'Change Tracking ENABLED for: ' + + @InstanceName + '.dbo.' + @TblName;
                END;
        END;
    IF @Enable = 0
        BEGIN
            SET @S = 'SELECT count(*) as iCNT FROM ' + CHAR (10) ;
            SET @S = @S + '    ' + @InstanceName + '.sys.change_tracking_tables ' + CHAR (10) ;
            SET @S = @S + '        JOIN ' + @InstanceName + '.sys.tables ' + CHAR (10) ;
            SET @S = @S + '           ON ' + @InstanceName + '.sys.tables.object_id = ' + @InstanceName + '.sys.change_tracking_tables.object_id ' + CHAR (10) ;
            SET @S = @S + '               JOIN ' + @InstanceName + '.sys.schemas ' + CHAR (10) ;
            SET @S = @S + '			    ON ' + @InstanceName + '.sys.schemas.schema_id = ' + @InstanceName + '.sys.tables.schema_id ' + CHAR (10) ;
            SET @S = @S + '           WHERE ' + @InstanceName + '.sys.tables.name = ''' + @TblName + '''';

            INSERT INTO @TEMPVAR
            EXEC (@S) ;
            SET @iCnt = (SELECT TOP 1
                                iCNT
                                FROM @TEMPVAR);

            IF @iCnt > 0
                BEGIN
                    PRINT 'DISABLED Change Tracking on ' + @InstanceName + '.dbo.' + @TblName;
                    SET @S = 'ALTER TABLE ' + @InstanceName + '.dbo.' + @TblName + ' DISABLE CHANGE_TRACKING ';
                    EXEC (@S) ;
                END;
            ELSE
                BEGIN
                    PRINT 'Change Tracking is NOT applied to ' + + @InstanceName + '.dbo.' + @TblName + '.';
                END;
        END;
END;

GO
PRINT 'Executed proc_ChangeTracking.sql';
GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'EXECUTING SetCtHA.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EnableChangeTracking') 
    BEGIN
        DROP PROCEDURE
             proc_EnableChangeTracking;
    END;

GO
-- exec proc_EnableChangeTracking 'KenticoCMS_1'
-- exec proc_EnableChangeTracking 'KenticoCMS_2'
-- exec proc_EnableChangeTracking 'KenticoCMS_3'
CREATE PROCEDURE proc_EnableChangeTracking ( @DatabaseName AS nvarchar (100) )
AS
BEGIN
    DECLARE @DB AS nvarchar (100) = DB_NAME () ;
    DECLARE @MySql AS nvarchar (1000) = '';
    --DECLARE @DatabaseName AS nvarchar (2000) = 'KenticoCMS_2';

    IF NOT EXISTS (SELECT
                          database_id
                          FROM sys.change_tracking_databases
                          WHERE database_id = DB_ID (@DatabaseName)) 
        BEGIN
		  PRINT ('ENABLED CHANGE TRACKING ON: ' + @DatabaseName);
            SET @MySql = 'ALTER DATABASE ' + @DatabaseName + ' SET CHANGE_TRACKING = ON (CHANGE_RETENTION = 2 DAYS, AUTO_CLEANUP = ON) ';
            EXEC (@MySql) ;
        END;

    DECLARE @DBID AS int = 0;
    DECLARE @s AS nvarchar (2000) = '';
    
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Class', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Document', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Site', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'CMS_Tree', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'cms_user', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'cms_usersettings', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'cms_usersite', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'COM_SKU', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_Account', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_CoachingHealthArea', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_CoachingHealthInterest', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HACampaign', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentMatrixQuestion', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentModule', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentMultipleChoiceQuestion', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentRiskArea', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentRiskCategory', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserAnswers', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserModule', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserQuestion', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserQuestionGroupResults', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserRiskArea', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserRiskCategory', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssesmentUserStarted', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssessment', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_HealthAssessmentFreeForm', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_EDW_RejectMPI', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardActivity', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardLevelType', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardTrigger', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_RewardType', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_LKP_TrackerVendor', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_OutComeMessages', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'hfit_PPTEligibility', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardActivity', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardException', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardGroup', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardLevel', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardProgram', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardsUserActivityDetail', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardsUserLevelDetail', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardTrigger', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_RewardTriggerParameter', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'Hfit_SmallStepResponses', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_ToDoSmallSteps', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFIT_Tracker', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBloodPressure', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBloodSugarAndGlucose', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBMI', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBodyFat', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerBodyMeasurements', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCardio', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCholesterol', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCollectionSource', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerCotinine', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerDailySteps', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerDef_Tracker', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerFlexibility', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerFruits', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHbA1c', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHeight', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHighFatFoods', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerHighSodiumFoods', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerInstance_Tracker', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerMealPortions', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerMedicalCarePlan', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerPreventiveCare', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerRegularMeals', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerRestingHeartRate', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerShots', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSitLess', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSleepPlan', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerStrength', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerStress', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerStressManagement', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSugaryDrinks', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerSugaryFoods', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerTests', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerTobaccoAttestation', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerTobaccoFree', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerVegetables', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerWater', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerWeight', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_TrackerWholeGrains', 1;
    EXEC proc_ChangeTracking  @DatabaseName, 'HFit_UserTracker', 1;


    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1', @enabled = 1;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_HA_Master_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_HA_Master_KenticoCMS_PRD_1', @enabled = 1;
        END;
    PRINT 'Activated Change Tracking for EDW Views and tables';
END;

GO
PRINT 'EXECUTED SetCtHA.sql';

GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing DisableCT_EDW.sql';
GO

if exists (select name from sys.procedures where name = 'proc_DisableChangeTracking')
drop procedure proc_DisableChangeTracking

go
-- exec proc_DisableChangeTracking 'KenticoCMS_1' ;
CREATE PROCEDURE proc_DisableChangeTracking (@DatabaseName as nvarchar(100))
AS
BEGIN
    DECLARE @DB AS nvarchar (100) = @DatabaseName ;
    DECLARE @MySql AS nvarchar (1000) = '';
    DECLARE @DBID AS int = 0;
    DECLARE @s AS nvarchar (2000) = '';

    --declare @DatabaseName as nvarchar(100) = 'KenticoCMS_1' ;
    EXEC proc_ChangeTracking @DatabaseName, 'Hfit_SmallStepResponses', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Class', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Document', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Site', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'CMS_Tree', 0;
    -- The below tables are used in Audit Tracking and cannot be removed from Change TRacking
    --EXEC proc_ChangeTracking @DatabaseName, 'cms_user', 0;
    --EXEC proc_ChangeTracking @DatabaseName, 'cms_usersettings', 0;
    --EXEC proc_ChangeTracking @DatabaseName, 'cms_usersite', 0;
    --EXEC proc_ChangeTracking @DatabaseName, 'hfit_ppteligibility', 0;    
    EXEC proc_ChangeTracking @DatabaseName, 'COM_SKU', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_Account', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_CoachingHealthArea', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_CoachingHealthInterest', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HACampaign', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentMatrixQuestion', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentModule', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentMultipleChoiceQuestion', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentRiskArea', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentRiskCategory', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserAnswers', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserModule', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserQuestion', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserQuestionGroupResults', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserRiskArea', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserRiskCategory', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssesmentUserStarted', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssessment', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_HealthAssessmentFreeForm', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_EDW_RejectMPI', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardActivity', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardLevelType', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardTrigger', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_RewardType', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_LKP_TrackerVendor', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_OutComeMessages', 0;    
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardActivity', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardException', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardGroup', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardLevel', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardProgram', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardsUserActivityDetail', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardsUserLevelDetail', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardTrigger', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_RewardTriggerParameter', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_ToDoSmallSteps', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFIT_Tracker', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBloodPressure', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBloodSugarAndGlucose', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBMI', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBodyFat', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerBodyMeasurements', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCardio', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCholesterol', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCollectionSource', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCotinine', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerCotinine', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerDailySteps', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerDef_Tracker', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerFlexibility', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerFruits', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHbA1c', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHeight', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHighFatFoods', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerHighSodiumFoods', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerInstance_Tracker', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerMealPortions', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerMedicalCarePlan', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerPreventiveCare', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerPreventiveCare', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerRegularMeals', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerRestingHeartRate', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerShots', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSitLess', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSleepPlan', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerStrength', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerStress', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerStressManagement', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSugaryDrinks', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerSugaryFoods', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerTests', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerTobaccoAttestation', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerTobaccoFree', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerVegetables', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerWater', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerWeight', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_TrackerWholeGrains', 0;
    EXEC proc_ChangeTracking @DatabaseName, 'HFit_UserTracker', 0;

    IF NOT EXISTS (SELECT
                          database_id
                          FROM sys.change_tracking_databases
                          WHERE database_id = DB_ID (@DB)) 
        BEGIN
            SET @MySql = 'ALTER DATABASE ' + @DB + ' SET CHANGE_TRACKING = OFF ';
            EXEC (@MySql) ;
        END;

    SELECT
           OBJECT_NAME (object_id) AS TABLE_NAME
           FROM sys.change_tracking_tables;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkDeletedRecords_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkNewRecords_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_CT_HA_MarkUpdatedRecords_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_Generate_BMI_Staging_Data_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_BioMetrics_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSettings_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CMS_UserSite_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CoachingDetail_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_CT_USER_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HA_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HADefinition_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_HFIT_PPTEligibility_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardAwardDetail_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardsDefinition_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardTriggerParameters_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserDetail_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_RewardUserLevel_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_GetStagingData_Trackers_KenticoCMS_PRD_1', @enabled = 0;
        END;

    IF EXISTS (SELECT
                      job_id
                      FROM msdb.dbo.sysjobs_view
                      WHERE name = 'job_EDW_HA_Master_KenticoCMS_PRD_1') 
        BEGIN
            EXEC msdb.dbo.sp_update_job @job_name = 'job_EDW_HA_Master_KenticoCMS_PRD_1', @enabled = 0;
        END;

END;

GO
PRINT 'Executed DisableCT_EDW.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'executing proc_EnableAuditControl.sql;';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_EnableAuditControl') 
    BEGIN
        DROP PROCEDURE
             proc_EnableAuditControl;
    END;

GO
CREATE PROCEDURE proc_EnableAuditControl
AS
BEGIN

    DECLARE @DB nvarchar (100) = DB_NAME () ;
    DECLARE @S nvarchar (2000) = '';
    DECLARE @TrgName  nvarchar (100) = '';
    DECLARE @TBL  nvarchar (100) = '';

    IF NOT EXISTS (SELECT
                          database_id
                          FROM sys.change_tracking_databases
                          WHERE database_id = DB_ID (@DB)) 
        BEGIN
            SET @S = 'ALTER DATABASE ' + @DB + ' SET CHANGE_TRACKING = ON (CHANGE_RETENTION = 2 DAYS, AUTO_CLEANUP = ON) ';
            EXEC (@S) ;
            PRINT 'TURNED ON CHANGE TRACKING FOR: ' + @@ServerName + ' and Database ' + DB_NAME () ;
        END;
    ELSE
        BEGIN
            PRINT 'CHANGE TRACKING IS ACTIVE FOR: ' + @@ServerName + ' and Database ' + DB_NAME () ;
        END;

    EXEC proc_ChangeTracking 'hfit_ppteligibility', 1;
    EXEC proc_ChangeTracking 'CMS_Class', 1;
    EXEC proc_ChangeTracking 'CMS_Document', 1;
    EXEC proc_ChangeTracking 'CMS_Site', 1;
    EXEC proc_ChangeTracking 'CMS_Tree', 1;
    EXEC proc_ChangeTracking 'cms_user', 1;
    EXEC proc_ChangeTracking 'cms_usersettings', 1;
    EXEC proc_ChangeTracking 'cms_usersite', 1;
    --EXEC proc_ChangeTracking 'COM_SKU', 1;

    PRINT 'Enabeling Audit Control Triggers on server ' + @@ServerName + ' and Database ' + DB_NAME () ;

    SET @TBL = 'CMS_User';
    SET @TrgName = 'trig_INS_CMS_User_Audit';
    IF EXISTS (SELECT
                      name
                      FROM sys.triggers
                      WHERE name = @TrgName) 
        BEGIN
            PRINT 'Enabled Trigger: ' + @TrgName;
            SET @S = 'ENABLE TRIGGER ' + @TrgName + ' ON ' + @TBL;
            EXEC (@S) ;
        END;
    ELSE
        BEGIN
            PRINT @TrgName + ' does not exist.';
        END;

    SET @TBL = 'CMS_UserSettings';
    SET @TrgName = 'trig_INS_CMS_UserSettings_Audit';
    IF EXISTS (SELECT
                      name
                      FROM sys.triggers
                      WHERE name = @TrgName) 
        BEGIN
            PRINT 'Enabled Trigger: ' + @TrgName;
            SET @S = 'ENABLE TRIGGER ' + @TrgName + ' ON ' + @TBL;
            EXEC (@S) ;
        END;
    ELSE
        BEGIN
            PRINT @TrgName + ' does not exist.';
        END;

    SET @TBL = 'CMS_UserSite';
    SET @TrgName = 'trig_INS_CMS_UserSite_Audit';
    IF EXISTS (SELECT
                      name
                      FROM sys.triggers
                      WHERE name = @TrgName) 
        BEGIN
            PRINT 'Enabled Trigger: ' + @TrgName;
            SET @S = 'ENABLE TRIGGER ' + @TrgName + ' ON ' + @TBL;
            EXEC (@S) ;
        END;
    ELSE
        BEGIN
            PRINT @TrgName + ' does not exist.';
        END;

    SET @TBL = 'HFIT_PPTEligibility';
    SET @TrgName = 'trig_UPDT_HFIT_PPTEligibility_Audit';
    IF EXISTS (SELECT
                      name
                      FROM sys.triggers
                      WHERE name = @TrgName) 
        BEGIN
            PRINT 'Enabled Trigger: ' + @TrgName;
            SET @S = 'ENABLE TRIGGER ' + @TrgName + ' ON ' + @TBL;
            EXEC (@S) ;
        END;
    ELSE
        BEGIN
            PRINT @TrgName + ' does not exist.';
        END;

END;
GO
EXEC proc_EnableAuditControl;
GO
PRINT 'executing proc_EnableAuditControl.sq;';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing proc_DisableAuditControl.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_DisableAuditControl') 
    BEGIN
        DROP PROCEDURE
             proc_DisableAuditControl;
    END;
GO

-- exec proc_DisableAuditControl
CREATE PROCEDURE proc_DisableAuditControl
AS
BEGIN
    DECLARE @DB nvarchar (100) = DB_NAME () ;
    DECLARE @S nvarchar (2000) = '';
    DECLARE @TrgName  nvarchar (100) = '';
    DECLARE @TBL  nvarchar (100) = '';

    PRINT 'ONLY TRIIGERS WIL BE DISABLED for Audit Control, no Change Tracking Tables will be modified.';

    SET @TBL = 'CMS_User';
    SET @TrgName = 'trig_INS_CMS_User_Audit';
    IF EXISTS (SELECT
                      name
                      FROM sys.triggers
                      WHERE name = @TrgName) 
        BEGIN
            SET @S = 'DISABLE TRIGGER ' + @TrgName + ' ON ' + @TBL;
            EXEC (@S) ;
            PRINT 'TRIGGER ' + @TrgName + ' ON ' + @TBL + ', DISABLED';
        END;

    SET @TBL = 'CMS_UserSettings';
    SET @TrgName = 'trig_INS_CMS_UserSettings_Audit';
    IF EXISTS (SELECT
                      name
                      FROM sys.triggers
                      WHERE name = @TrgName) 
        BEGIN
            SET @S = 'DISABLE TRIGGER ' + @TrgName + ' ON ' + @TBL;
            EXEC (@S) ;
            PRINT 'TRIGGER ' + @TrgName + ' ON ' + @TBL + ', DISABLED';
        END;

    SET @TBL = 'CMS_UserSite';
    SET @TrgName = 'trig_INS_CMS_UserSite_Audit';
    IF EXISTS (SELECT
                      name
                      FROM sys.triggers
                      WHERE name = @TrgName) 
        BEGIN
            SET @S = 'DISABLE TRIGGER ' + @TrgName + ' ON ' + @TBL;
            EXEC (@S) ;
            PRINT 'TRIGGER ' + @TrgName + ' ON ' + @TBL + ', DISABLED';
        END;

    SET @TBL = 'HFIT_PPTEligibility';
    SET @TrgName = 'trig_UPDT_HFIT_PPTEligibility_Audit';
    IF EXISTS (SELECT
                      name
                      FROM sys.triggers
                      WHERE name = @TrgName) 
        BEGIN
            SET @S = 'DISABLE TRIGGER ' + @TrgName + ' ON ' + @TBL;
            EXEC (@S) ;
            PRINT 'TRIGGER ' + @TrgName + ' ON ' + @TBL + ', DISABLED';
        END;

END;
GO
PRINT 'Executed proc_DisableAuditControl.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating Table EDW_CT_ExecutionLog';
PRINT 'FROM: createTable_EDW_CT_ExecutionLog.sql';
GO
--drop table EDW_CT_ExecutionLog

/*
alter table EDW_CT_ExecutionLog add CT_Inserts bigint NULL
alter table EDW_CT_ExecutionLog add CT_Updates bigint NULL
alter table EDW_CT_ExecutionLog add CT_Deletes bigint NULL	
*/

SET QUOTED_IDENTIFIER ON;

IF NOT EXISTS ( SELECT
                       name
                       FROM sys.tables
                       WHERE name = 'EDW_CT_ExecutionLog') 
    BEGIN

        CREATE TABLE dbo.EDW_CT_ExecutionLog (
                     CT_NAME nvarchar ( 80) NOT NULL
                   , CT_Start datetime NOT NULL
                   , CT_End datetime NULL
                   , CT_TotalMinutes int NULL
                   , CT_RecordsProcessed bigint NULL
                   , CT_Inserts bigint NULL
                   , CT_Updates bigint NULL
                   , CT_Deletes bigint NULL
                   , RecordID uniqueidentifier NOT NULL
                   , CONSTRAINT PK_EDW_CT_ExecutionLog PRIMARY KEY CLUSTERED ( RecordID ASC)) ;

        ALTER TABLE dbo.EDW_CT_ExecutionLog
        ADD
                    CONSTRAINT DF_EDW_CT_ExecutionLog_RecordID DEFAULT NEWID () FOR RecordID;

    END;
ELSE
    BEGIN
        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               column_name = 'CT_Inserts'
                           AND table_name = 'EDW_CT_ExecutionLog') 
            BEGIN
                ALTER TABLE EDW_CT_ExecutionLog
                ADD
                            CT_Inserts bigint NULL;
            END;
        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               column_name = 'CT_Updates'
                           AND table_name = 'EDW_CT_ExecutionLog') 
            BEGIN
                ALTER TABLE EDW_CT_ExecutionLog
                ADD
                            CT_Updates bigint NULL;
            END;
        IF NOT EXISTS ( SELECT
                               column_name
                               FROM information_schema.columns
                               WHERE
                               column_name = 'CT_Deletes'
                           AND table_name = 'EDW_CT_ExecutionLog') 
            BEGIN
                ALTER TABLE EDW_CT_ExecutionLog
                ADD
                            CT_Deletes bigint NULL;
            END;
    END;
GO

PRINT 'CREATED Table EDW_CT_ExecutionLog';
GO

PRINT 'CREATING PROC proc_EDW_CT_ExecutionLog_Update';
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_CT_ExecutionLog_Update') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_CT_ExecutionLog_Update;
    END;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_EDW_CT_ExecutionLog_Update_Counts') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_CT_ExecutionLog_Update_Counts;
    END;

GO

CREATE PROCEDURE proc_EDW_CT_ExecutionLog_Update_Counts (
       @RecordID AS uniqueidentifier
     , @TypeAction AS char (1) 
     , @iCnt AS bigint = 0) 
AS
BEGIN

/*
    @TypeAction:
    T = Total of processed records.
    I = Update the count of inserted records
    U = Update the count of updated records
    D = Update the count of flaged as deleted records
    */

    IF @TypeAction = 'T'
        BEGIN
            DECLARE
                   @TotRecs AS bigint = (SELECT
                                                ISNULL (CT_INSERTs, 0) + ISNULL (CT_Updates, 0) + ISNULL (CT_Deletes, 0) 
                                                FROM EDW_CT_ExecutionLog
                                                WHERE RecordID = @RecordID);

            IF @iCnt > 0
                BEGIN
                    PRINT 'Executing Log Update T0 on ' + CAST (@iCnt AS nvarchar (50)) + ' records.';
                    UPDATE dbo.EDW_CT_ExecutionLog
                           SET
                               CT_RecordsProcessed = @iCnt
                    WHERE
                          RecordID = @RecordID;
                END;
            ELSE
                BEGIN
                    PRINT 'Executing Log Update T1 on ' + CAST (@TotRecs AS nvarchar (50)) + ' records.';
                    UPDATE dbo.EDW_CT_ExecutionLog
                           SET
                               CT_RecordsProcessed = @TotRecs
                    WHERE
                          RecordID = @RecordID;
                END;
        END;
    IF @TypeAction = 'I'
        BEGIN
            UPDATE dbo.EDW_CT_ExecutionLog
                   SET
                       CT_Inserts = @iCnt
            WHERE
                  RecordID = @RecordID;
        END;
    IF @TypeAction = 'U'
        BEGIN
            UPDATE dbo.EDW_CT_ExecutionLog
                   SET
                       CT_Updates = @iCnt
            WHERE
                  RecordID = @RecordID;
        END;
    IF @TypeAction = 'D'
        BEGIN
            UPDATE dbo.EDW_CT_ExecutionLog
                   SET
                       CT_Deletes = @iCnt
            WHERE
                  RecordID = @RecordID;
        END;
END;
GO
CREATE PROCEDURE proc_EDW_CT_ExecutionLog_Update (
       @RecordID AS uniqueidentifier
     , @CT_NAME AS nvarchar (80) 
     , @CT_DateTimeNow AS datetime
     , @CT_RecordsProcessed AS bigint = 0
     , @Action AS nvarchar (5)) 
AS
BEGIN
    IF @Action = 'I'
        BEGIN
            INSERT INTO dbo.EDW_CT_ExecutionLog (
                   CT_NAME
                 , CT_Start
                 , CT_End
                 , CT_TotalMinutes
                 , CT_RecordsProcessed
                 , RecordID) 
            VALUES
                   (
                   @CT_NAME , @CT_DateTimeNow , NULL , NULL , NULL , @RecordID) ;
        END;
    IF @Action = 'U'
        BEGIN
            --declare @STime as datetime = getdate() -1 ;
            --declare @CT_DateTimeNow as datetime = getdate();
            --select DATEDIFF (MINUTE, @STime , @CT_DateTimeNow);
            DECLARE
                   @STime AS datetime = ( SELECT
                                                 CT_Start
                                                 FROM EDW_CT_ExecutionLog
                                                 WHERE RecordID = @RecordID );

            PRINT '@Stime = ' + CAST ( @Stime AS nvarchar ( 50)) ;
            DECLARE
                   @Mins AS int = DATEDIFF ( MINUTE , @STime , @CT_DateTimeNow) ;
            PRINT '@Mins = ' + CAST ( @Mins AS nvarchar ( 50)) ;
            UPDATE dbo.EDW_CT_ExecutionLog
                   SET
                       CT_End = @CT_DateTimeNow
                     ,CT_TotalMinutes = DATEDIFF ( MINUTE , @STime , @CT_DateTimeNow) 
                     ,CT_RecordsProcessed = @CT_RecordsProcessed
            WHERE
                  RecordID = @RecordID;

        END;

END;

GO
PRINT 'CREATED PROC proc_EDW_CT_ExecutionLog_Update';
GO

--Test the PROC

/*
declare @RecordID AS uniqueidentifier = newid();
declare @CT_NAME as nvarchar(50) = 'TESTRUN' ;
declare @CT_DateTimeNow as datetime = getdate() -1 ;
declare @CT_RecordsProcessed as bigint = 0 ; 
declare @Action AS nvarchar (5) = 'I';

exec proc_EDW_CT_ExecutionLog_Update @RecordID, @CT_NAME, @CT_DateTimeNow, @CT_RecordsProcessed, 'I';
select * from EDW_CT_ExecutionLog ;
set @CT_DateTimeNow = getdate() ;
set @CT_RecordsProcessed = 9999;
exec proc_EDW_CT_ExecutionLog_Update @RecordID, @CT_NAME, @CT_DateTimeNow, @CT_RecordsProcessed, 'U';
select * from EDW_CT_ExecutionLog ;
truncate table EDW_CT_ExecutionLog;
*/--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*---------------------------
cms_user	  -> DONE
cms_usersettings	  -> DONE
cms_usersite	  -> DONE
hfit_ppteligibility	  -> DONE
cms_usercontact
*/
GO
PRINT 'Executing create_table_STAGING_cms_user.sql';
GO

IF NOT EXISTS (SELECT
                      sys.tables.name AS Table_name
                      FROM
                          sys.change_tracking_tables
                              JOIN sys.tables
                                  ON sys.tables.object_id = sys.change_tracking_tables.object_id
                              JOIN sys.schemas
                                  ON sys.schemas.schema_id = sys.tables.schema_id
                      WHERE sys.tables.name = 'CMS_User') 
    BEGIN
        PRINT 'ADDING Change Tracking to CMS_User';
        ALTER TABLE dbo.CMS_User
            ENABLE CHANGE_TRACKING
                WITH (TRACK_COLUMNS_UPDATED = ON) ;
    END;
ELSE
    BEGIN
        PRINT 'Change Tracking exists on CMS_User';
    END;
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Create_Table_STAGING_cms_user') 
    BEGIN
        DROP PROCEDURE
             proc_Create_Table_STAGING_cms_user;
    END;
GO
-- exec proc_Create_Table_STAGING_cms_user
-- select top 100 * from [STAGING_cms_user]
CREATE PROCEDURE proc_Create_Table_STAGING_cms_user
AS
BEGIN

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_cms_user') 
        BEGIN
            DROP TABLE
                 dbo.STAGING_cms_user;
        END;

    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;

    CREATE TABLE dbo.STAGING_cms_user (
                 UserID int IDENTITY (1, 1) 
                            NOT NULL
               , UserName nvarchar (100) NOT NULL
               , FirstName nvarchar (100) NULL
               , MiddleName nvarchar (100) NULL
               , LastName nvarchar (100) NULL
               , FullName nvarchar (450) NULL
               , Email nvarchar (100) NULL
               , UserPassword nvarchar (100) NOT NULL
               , PreferredCultureCode nvarchar (10) NULL
               , PreferredUICultureCode nvarchar (10) NULL
               , UserEnabled bit NOT NULL
               , UserIsEditor bit NOT NULL
               , UserIsGlobalAdministrator bit NOT NULL
               , UserIsExternal bit NULL
               , UserPasswordFormat nvarchar (10) NULL
               , UserCreated datetime2 (7) NULL
               , LastLogon datetime2 (7) NULL
               , UserStartingAliasPath nvarchar (200) NULL
               , UserGUID uniqueidentifier NOT NULL
               , UserLastModified datetime2 (7) NOT NULL
               , UserLastLogonInfo nvarchar (max) NULL
               , UserIsHidden bit NULL
               , UserVisibility nvarchar (max) NULL
               , UserIsDomain bit NULL
               , UserHasAllowedCultures bit NULL
               , UserSiteManagerDisabled bit NULL
               , UserPasswordBuffer nvarchar (2000) NULL
               , UserTokenID uniqueidentifier NULL
               , UserMFRequired bit NULL
               , UserTokenIteration int NULL
               , LastModifiedDate datetime NULL
               , RowNbr int NULL
               , DeletedFlg bit NULL
               , TimeZone nvarchar (10) NULL
               , ConvertedToCentralTime bit NULL
               , SVR nvarchar (100) NOT NULL
               , DBNAME nvarchar (100) NOT NULL
               , SYS_CHANGE_VERSION int NULL
    ) 
    ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

    ALTER TABLE dbo.STAGING_cms_user
    ADD
                DEFAULT @@servername FOR SVR;
    ALTER TABLE dbo.STAGING_cms_user
    ADD
                DEFAULT DB_NAME () FOR DBNAME;

    SET IDENTITY_INSERT STAGING_cms_user ON;

    CREATE CLUSTERED INDEX PI_STAGING_CMS_USer ON dbo.STAGING_cms_user
    (
    UserID ASC,
    SVR ASC,
    DBNAME ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

    INSERT INTO STAGING_cms_user
    (
           UserID
         , UserName
         , FirstName
         , MiddleName
         , LastName
         , FullName
         , Email
         , UserPassword
         , PreferredCultureCode
         , PreferredUICultureCode
         , UserEnabled
         , UserIsEditor
         , UserIsGlobalAdministrator
         , UserIsExternal
         , UserPasswordFormat
         , UserCreated
         , LastLogon
         , UserStartingAliasPath
         , UserGUID
         , UserLastModified
         , UserLastLogonInfo
         , UserIsHidden
         , UserVisibility
         , UserIsDomain
         , UserHasAllowedCultures
         , UserSiteManagerDisabled
         , UserPasswordBuffer
         , UserTokenID
         , UserMFRequired
         , UserTokenIteration) 
    SELECT
           UserID
         , UserName
         , FirstName
         , MiddleName
         , LastName
         , FullName
         , Email
         , UserPassword
         , PreferredCultureCode
         , PreferredUICultureCode
         , UserEnabled
         , UserIsEditor
         , UserIsGlobalAdministrator
         , UserIsExternal
         , UserPasswordFormat
         , UserCreated
         , LastLogon
         , UserStartingAliasPath
         , UserGUID
         , UserLastModified
         , UserLastLogonInfo
         , UserIsHidden
         , UserVisibility
         , UserIsDomain
         , UserHasAllowedCultures
         , UserSiteManagerDisabled
         , UserPasswordBuffer
         , UserTokenID
         , UserMFRequired
         , UserTokenIteration
           FROM cms_user;

    SET IDENTITY_INSERT STAGING_cms_user OFF;

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_cms_user_Update_History') 
        BEGIN
            DROP TABLE
                 STAGING_cms_user_Update_History;
        END;

CREATE TABLE [dbo].[STAGING_CMS_USER_Update_History](
	[Userid] [int] NOT NULL,
	[SYS_CHANGE_VERSION] [bigint] NULL,
	[SYS_CHANGE_OPERATION] [nchar](1) NULL,
	[SYS_CHANGE_COLUMNS] [varbinary](4100) NULL,
	[CurrUser] [varchar](60) NOT NULL,
	[SysUser] [varchar](60) NOT NULL,
	[IPADDR] [varchar](60) NOT NULL,
	[commit_time] [datetime] NOT NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[SVR] [nvarchar](128) NULL,
	[DBNAME] [nvarchar](128) NULL,
	[Email_cg] [int] NULL,
	[FirstName_cg] [int] NULL,
	[FullName_cg] [int] NULL,
	[LastLogon_cg] [int] NULL,
	[LastName_cg] [int] NULL,
	[MiddleName_cg] [int] NULL,
	[PreferredCultureCode_cg] [int] NULL,
	[PreferredUICultureCode_cg] [int] NULL,
	[UserCreated_cg] [int] NULL,
	[UserEnabled_cg] [int] NULL,
	[UserGUID_cg] [int] NULL,
	[UserHasAllowedCultures_cg] [int] NULL,
	[UserID_cg] [int] NULL,
	[UserIsDomain_cg] [int] NULL,
	[UserIsEditor_cg] [int] NULL,
	[UserIsExternal_cg] [int] NULL,
	[UserIsGlobalAdministrator_cg] [int] NULL,
	[UserIsHidden_cg] [int] NULL,
	[UserLastLogonInfo_cg] [int] NULL,
	[UserLastModified_cg] [int] NULL,
	[UserMFRequired_cg] [int] NULL,
	[UserName_cg] [int] NULL,
	[UserPassword_cg] [int] NULL,
	[UserPasswordBuffer_cg] [int] NULL,
	[UserPasswordFormat_cg] [int] NULL,
	[UserSiteManagerDisabled_cg] [int] NULL,
	[UserStartingAliasPath_cg] [int] NULL,
	[UserTokenID_cg] [int] NULL,
	[UserTokenIteration_cg] [int] NULL,
	[UserVisibility_cg] [int] NULL
)


ALTER TABLE [dbo].[STAGING_CMS_USER_Update_History] ADD  CONSTRAINT [DF_STAGING_cms_user_Update_History_CurrUser]  DEFAULT (user_name()) FOR [CurrUser]

ALTER TABLE [dbo].[STAGING_CMS_USER_Update_History] ADD  CONSTRAINT [DF_STAGING_cms_user_Update_History_SysUser]  DEFAULT (suser_sname()) FOR [SysUser]

ALTER TABLE [dbo].[STAGING_CMS_USER_Update_History] ADD  CONSTRAINT [DF_STAGING_cms_user_Update_History_IPADDR]  DEFAULT (CONVERT([nvarchar](50),connectionproperty('client_net_address'))) FOR [IPADDR]
    
    CREATE CLUSTERED INDEX PI_STAGING_cms_user_Update_History ON dbo.STAGING_cms_user_Update_History
    (
    UserID ASC,
    SVR ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];


END;

GO
PRINT 'Executed create_table_STAGING_cms_user.sql';
GO
EXEC proc_Create_Table_STAGING_cms_user;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing proc_CMS_User_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CMS_User_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CMS_User_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CMS_User_AddDeletedRecs
AS
BEGIN

    UPDATE STAGING_cms_user
           SET
               DeletedFlg = 1
             ,LastModifiedDate = GETDATE () 
    WHERE
          UserID IN
          (SELECT
                  UserID
                  FROM CHANGETABLE (CHANGES CMS_USER, NULL) AS CT
                  WHERE SYS_CHANGE_OPERATION = 'D') 
      AND DeletedFlg IS NULL;

    DECLARE
    @iCnt AS int = @@ROWCOUNT;
    PRINT 'Deleted Count: ' + CAST ( @iCnt AS nvarchar (50)) ;

    exec proc_CT_CMS_USER_History 'D'

    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CMS_User_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- USe KenticoCMS_Prod1

PRINT 'Executing proc_CT_CMS_User_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_CMS_User_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_CMS_User_AddNewRecs;
    END;
GO
-- proc_CT_CMS_User_AddNewRecs
CREATE PROCEDURE proc_CT_CMS_User_AddNewRecs
AS
BEGIN

    SET IDENTITY_INSERT STAGING_cms_user ON;

    WITH CTE (
         UserID) 
        AS ( SELECT
                    UserID
                    FROM cms_user
             EXCEPT
             SELECT
                    UserID
                    FROM STAGING_cms_user
                    WHERE DeletedFlg IS NULL) 
        INSERT INTO STAGING_cms_user
        (
               UserID
             , UserName
             , FirstName
             , MiddleName
             , LastName
             , FullName
             , Email
             , UserPassword
             , PreferredCultureCode
             , PreferredUICultureCode
             , UserEnabled
             , UserIsEditor
             , UserIsGlobalAdministrator
             , UserIsExternal
             , UserPasswordFormat
             , UserCreated
             , LastLogon
             , UserStartingAliasPath
             , UserGUID
             , UserLastModified
             , UserLastLogonInfo
             , UserIsHidden
             , UserVisibility
             , UserIsDomain
             , UserHasAllowedCultures
             , UserSiteManagerDisabled
             , UserPasswordBuffer
             , UserTokenID
             , UserMFRequired
             , UserTokenIteration
             , LastModifiedDate
               --,[RowNbr]
             , DeletedFlg
             , TimeZone
             , ConvertedToCentralTime
             , SVR
             , DBNAME
             , SYS_CHANGE_VERSION) 
        SELECT
               T.UserID
             , T.UserName
             , T.FirstName
             , T.MiddleName
             , T.LastName
             , T.FullName
             , T.Email
             , T.UserPassword
             , T.PreferredCultureCode
             , T.PreferredUICultureCode
             , T.UserEnabled
             , T.UserIsEditor
             , T.UserIsGlobalAdministrator
             , T.UserIsExternal
             , T.UserPasswordFormat
             , T.UserCreated
             , T.LastLogon
             , T.UserStartingAliasPath
             , T.UserGUID
             , T.UserLastModified
             , T.UserLastLogonInfo
             , T.UserIsHidden
             , T.UserVisibility
             , T.UserIsDomain
             , T.UserHasAllowedCultures
             , T.UserSiteManagerDisabled
             , T.UserPasswordBuffer
             , T.UserTokenID
             , T.UserMFRequired
             , T.UserTokenIteration
             , GETDATE () AS LastModifiedDate
             , NULL AS DeletedFlg
             , NULL AS TimeZone
             , NULL AS ConvertedToCentralTime
             , @@SERVERNAME AS SVR
             , DB_NAME () AS DBNAME
             , NULL AS SYS_CHANGE_VERSION
               FROM
                   cms_user AS T
                       JOIN CTE AS S
                           ON S.UserID = T.UserID;
    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    SET IDENTITY_INSERT STAGING_cms_user OFF;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;

    exec proc_CT_CMS_USER_History 'I'

    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_CMS_User_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_CMS_USER_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_CMS_USER_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_CMS_USER_AddUpdatedRecs;
    END;
GO
/*----------------------------------------------------------------------------------------------------------------------------------------------------------
    select top 100 * from CMS_USER
    update CMS_USER set LastName = LastName where UserID in (select top 50 UserID from CMS_USER order by UserID )
    update CMS_USER set UserName = UserName where UserID in (select top 50 UserID from CMS_USER order by UserID desc)
    update CMS_USER set MiddleName = MiddleName where UserID in (select top 100 UserID from CMS_USER order by UserID desc)
    update CMS_USER set Email = Email,PreferredCultureCode = PreferredCultureCode where UserID in (select top 100 UserID from CMS_USER order by UserID desc)

    exec proc_CT_CMS_USER_AddUpdatedRecs

    select * from STAGING_CMS_USER where SYS_CHANGE_VERSION is not null
    select * from STAGING_CMS_USER_Update_History
*/

CREATE PROCEDURE proc_CT_CMS_USER_AddUpdatedRecs
AS
BEGIN
    WITH CTE (
         UserID
       , SYS_CHANGE_VERSION
       , SYS_CHANGE_OPERATION
       , SYS_CHANGE_COLUMNS) 
        AS ( SELECT
                    CT.UserID
                  , CT.SYS_CHANGE_VERSION
                  , CT.SYS_CHANGE_OPERATION
                  , SYS_CHANGE_COLUMNS
                    FROM CHANGETABLE (CHANGES CMS_USER, NULL) AS CT
                    WHERE SYS_CHANGE_OPERATION = 'U') 
        UPDATE S
               SET
                   S.UserName = T.UserName
                 ,S.FirstName = T.FirstName
                 ,S.MiddleName = T.MiddleName
                 ,S.LastName = T.LastName
                 ,S.FullName = T.FullName
                 ,S.Email = T.Email
                 ,S.UserPassword = T.UserPassword
                 ,S.PreferredCultureCode = T.PreferredCultureCode
                 ,S.PreferredUICultureCode = T.PreferredUICultureCode
                 ,S.UserEnabled = T.UserEnabled
                 ,S.UserIsEditor = T.UserIsEditor
                 ,S.UserIsGlobalAdministrator = T.UserIsGlobalAdministrator
                 ,S.UserIsExternal = T.UserIsExternal
                 ,S.UserPasswordFormat = T.UserPasswordFormat
                 ,S.UserCreated = T.UserCreated
                 ,S.LastLogon = T.LastLogon
                 ,S.UserStartingAliasPath = T.UserStartingAliasPath
                 ,S.UserGUID = T.UserGUID
                 ,S.UserLastModified = T.UserLastModified
                 ,S.UserLastLogonInfo = T.UserLastLogonInfo
                 ,S.UserIsHidden = T.UserIsHidden
                 ,S.UserVisibility = T.UserVisibility
                 ,S.UserIsDomain = T.UserIsDomain
                 ,S.UserHasAllowedCultures = T.UserHasAllowedCultures
                 ,S.UserSiteManagerDisabled = T.UserSiteManagerDisabled
                 ,S.UserPasswordBuffer = T.UserPasswordBuffer
                 ,S.UserTokenID = T.UserTokenID
                 ,S.UserMFRequired = T.UserMFRequired
                 ,S.UserTokenIteration = T.UserTokenIteration
                 ,S.LastModifiedDate = GETDATE () 
                 ,S.DeletedFlg = NULL
                 ,S.ConvertedToCentralTime = NULL
                 ,S.SYS_CHANGE_VERSION = CTE.SYS_CHANGE_VERSION
                   FROM STAGING_CMS_USER AS S
                            JOIN
                            CMS_USER AS T
                                ON
                                S.UserID = T.UserID
                            AND S.DeletedFlg IS NULL
                            JOIN CTE
                                ON CTE.Userid = T.UserID
                               AND (CTE.SYS_CHANGE_VERSION != S.SYS_CHANGE_VERSION
                                 OR S.SYS_CHANGE_VERSION IS NULL);

    DECLARE
    @iCnt AS int = @@ROWCOUNT;

    PRINT 'Updated Count: ' + CAST ( @iCnt AS nvarchar (50)) ;

    exec proc_CT_CMS_USER_History 'U'

    --WITH CTE (
    --     UserID
    --   , SYS_CHANGE_VERSION
    --   , SYS_CHANGE_COLUMNS) 
    --    AS ( SELECT
    --                CT.UserID
    --              , CT.SYS_CHANGE_VERSION
    --              , SYS_CHANGE_COLUMNS
    --                FROM CHANGETABLE (CHANGES CMS_USER, NULL) AS CT
    --                WHERE SYS_CHANGE_OPERATION = 'U'
    --         EXCEPT
    --         SELECT
    --                UserID
    --              , SYS_CHANGE_VERSION
    --              , SYS_CHANGE_COLUMNS
    --                FROM STAGING_CMS_USER_Update_History
    --    ) 
    --    INSERT INTO STAGING_CMS_USER_Update_History
    --    (
    --           UserID
    --         , LastModifiedDate
    --         , SVR
    --         , DBNAME
    --         , SYS_CHANGE_VERSION
    --         , SYS_CHANGE_COLUMNS
    --         , commit_time) 
    --    SELECT
    --           CTE.UserID
    --         , GETDATE () AS LastModifiedDate
    --         , @@SERVERNAME AS SVR
    --         , DB_NAME () AS DBNAME
    --         , CTE.SYS_CHANGE_VERSION
    --         , CTE.SYS_CHANGE_COLUMNS
    --         , isnull(tc.commit_time, getdate())
    --           FROM
    --               CTE
    --                   JOIN sys.dm_tran_commit_table AS tc
    --                       ON CTE.sys_change_version = tc.commit_ts;

    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CT_CMS_USER_AddUpdatedRecs.sql';
GO
 --**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*---------------------------
cms_user	  -> DONE
cms_usersettings	  -> DONE
cms_usersite	  -> DONE
hfit_ppteligibility	  -> DONE
cms_usercontact
*/
GO
PRINT 'Executing create_table_STAGING_cms_user.sql';
GO

IF NOT EXISTS (SELECT
                      sys.tables.name AS Table_name
                      FROM
                          sys.change_tracking_tables
                              JOIN sys.tables
                                  ON sys.tables.object_id = sys.change_tracking_tables.object_id
                              JOIN sys.schemas
                                  ON sys.schemas.schema_id = sys.tables.schema_id
                      WHERE sys.tables.name = 'CMS_User') 
    BEGIN
        PRINT 'ADDING Change Tracking to CMS_User';
        ALTER TABLE dbo.CMS_User
            ENABLE CHANGE_TRACKING
                WITH (TRACK_COLUMNS_UPDATED = ON) ;
    END;
ELSE
    BEGIN
        PRINT 'Change Tracking exists on CMS_User';
    END;
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Create_Table_STAGING_cms_user') 
    BEGIN
        DROP PROCEDURE
             proc_Create_Table_STAGING_cms_user;
    END;
GO
-- exec proc_Create_Table_STAGING_cms_user
-- select top 100 * from [STAGING_cms_user]
CREATE PROCEDURE proc_Create_Table_STAGING_cms_user
AS
BEGIN

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_cms_user') 
        BEGIN
            DROP TABLE
                 dbo.STAGING_cms_user;
        END;

    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;

    CREATE TABLE dbo.STAGING_cms_user (
                 UserID int IDENTITY (1, 1) 
                            NOT NULL
               , UserName nvarchar (100) NOT NULL
               , FirstName nvarchar (100) NULL
               , MiddleName nvarchar (100) NULL
               , LastName nvarchar (100) NULL
               , FullName nvarchar (450) NULL
               , Email nvarchar (100) NULL
               , UserPassword nvarchar (100) NOT NULL
               , PreferredCultureCode nvarchar (10) NULL
               , PreferredUICultureCode nvarchar (10) NULL
               , UserEnabled bit NOT NULL
               , UserIsEditor bit NOT NULL
               , UserIsGlobalAdministrator bit NOT NULL
               , UserIsExternal bit NULL
               , UserPasswordFormat nvarchar (10) NULL
               , UserCreated datetime2 (7) NULL
               , LastLogon datetime2 (7) NULL
               , UserStartingAliasPath nvarchar (200) NULL
               , UserGUID uniqueidentifier NOT NULL
               , UserLastModified datetime2 (7) NOT NULL
               , UserLastLogonInfo nvarchar (max) NULL
               , UserIsHidden bit NULL
               , UserVisibility nvarchar (max) NULL
               , UserIsDomain bit NULL
               , UserHasAllowedCultures bit NULL
               , UserSiteManagerDisabled bit NULL
               , UserPasswordBuffer nvarchar (2000) NULL
               , UserTokenID uniqueidentifier NULL
               , UserMFRequired bit NULL
               , UserTokenIteration int NULL
               , LastModifiedDate datetime NULL
               , RowNbr int NULL
               , DeletedFlg bit NULL
               , TimeZone nvarchar (10) NULL
               , ConvertedToCentralTime bit NULL
               , SVR nvarchar (100) NOT NULL
               , DBNAME nvarchar (100) NOT NULL
               , SYS_CHANGE_VERSION int NULL
    ) 
    ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

    ALTER TABLE dbo.STAGING_cms_user
    ADD
                DEFAULT @@servername FOR SVR;
    ALTER TABLE dbo.STAGING_cms_user
    ADD
                DEFAULT DB_NAME () FOR DBNAME;

    SET IDENTITY_INSERT STAGING_cms_user ON;

    CREATE CLUSTERED INDEX PI_STAGING_CMS_USer ON dbo.STAGING_cms_user
    (
    UserID ASC,
    SVR ASC,
    DBNAME ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

    INSERT INTO STAGING_cms_user
    (
           UserID
         , UserName
         , FirstName
         , MiddleName
         , LastName
         , FullName
         , Email
         , UserPassword
         , PreferredCultureCode
         , PreferredUICultureCode
         , UserEnabled
         , UserIsEditor
         , UserIsGlobalAdministrator
         , UserIsExternal
         , UserPasswordFormat
         , UserCreated
         , LastLogon
         , UserStartingAliasPath
         , UserGUID
         , UserLastModified
         , UserLastLogonInfo
         , UserIsHidden
         , UserVisibility
         , UserIsDomain
         , UserHasAllowedCultures
         , UserSiteManagerDisabled
         , UserPasswordBuffer
         , UserTokenID
         , UserMFRequired
         , UserTokenIteration) 
    SELECT
           UserID
         , UserName
         , FirstName
         , MiddleName
         , LastName
         , FullName
         , Email
         , UserPassword
         , PreferredCultureCode
         , PreferredUICultureCode
         , UserEnabled
         , UserIsEditor
         , UserIsGlobalAdministrator
         , UserIsExternal
         , UserPasswordFormat
         , UserCreated
         , LastLogon
         , UserStartingAliasPath
         , UserGUID
         , UserLastModified
         , UserLastLogonInfo
         , UserIsHidden
         , UserVisibility
         , UserIsDomain
         , UserHasAllowedCultures
         , UserSiteManagerDisabled
         , UserPasswordBuffer
         , UserTokenID
         , UserMFRequired
         , UserTokenIteration
           FROM cms_user;

    SET IDENTITY_INSERT STAGING_cms_user OFF;

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_cms_user_Update_History') 
        BEGIN
            DROP TABLE
                 STAGING_cms_user_Update_History;
        END;

CREATE TABLE [dbo].[STAGING_CMS_USER_Update_History](
	[Userid] [int] NOT NULL,
	[SYS_CHANGE_VERSION] [bigint] NULL,
	[SYS_CHANGE_OPERATION] [nchar](1) NULL,
	[SYS_CHANGE_COLUMNS] [varbinary](4100) NULL,
	[CurrUser] [varchar](60) NOT NULL,
	[SysUser] [varchar](60) NOT NULL,
	[IPADDR] [varchar](60) NOT NULL,
	[commit_time] [datetime] NOT NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[SVR] [nvarchar](128) NULL,
	[DBNAME] [nvarchar](128) NULL,
	[Email_cg] [int] NULL,
	[FirstName_cg] [int] NULL,
	[FullName_cg] [int] NULL,
	[LastLogon_cg] [int] NULL,
	[LastName_cg] [int] NULL,
	[MiddleName_cg] [int] NULL,
	[PreferredCultureCode_cg] [int] NULL,
	[PreferredUICultureCode_cg] [int] NULL,
	[UserCreated_cg] [int] NULL,
	[UserEnabled_cg] [int] NULL,
	[UserGUID_cg] [int] NULL,
	[UserHasAllowedCultures_cg] [int] NULL,
	[UserID_cg] [int] NULL,
	[UserIsDomain_cg] [int] NULL,
	[UserIsEditor_cg] [int] NULL,
	[UserIsExternal_cg] [int] NULL,
	[UserIsGlobalAdministrator_cg] [int] NULL,
	[UserIsHidden_cg] [int] NULL,
	[UserLastLogonInfo_cg] [int] NULL,
	[UserLastModified_cg] [int] NULL,
	[UserMFRequired_cg] [int] NULL,
	[UserName_cg] [int] NULL,
	[UserPassword_cg] [int] NULL,
	[UserPasswordBuffer_cg] [int] NULL,
	[UserPasswordFormat_cg] [int] NULL,
	[UserSiteManagerDisabled_cg] [int] NULL,
	[UserStartingAliasPath_cg] [int] NULL,
	[UserTokenID_cg] [int] NULL,
	[UserTokenIteration_cg] [int] NULL,
	[UserVisibility_cg] [int] NULL
)


ALTER TABLE [dbo].[STAGING_CMS_USER_Update_History] ADD  CONSTRAINT [DF_STAGING_cms_user_Update_History_CurrUser]  DEFAULT (user_name()) FOR [CurrUser]

ALTER TABLE [dbo].[STAGING_CMS_USER_Update_History] ADD  CONSTRAINT [DF_STAGING_cms_user_Update_History_SysUser]  DEFAULT (suser_sname()) FOR [SysUser]

ALTER TABLE [dbo].[STAGING_CMS_USER_Update_History] ADD  CONSTRAINT [DF_STAGING_cms_user_Update_History_IPADDR]  DEFAULT (CONVERT([nvarchar](50),connectionproperty('client_net_address'))) FOR [IPADDR]
    
    CREATE CLUSTERED INDEX PI_STAGING_cms_user_Update_History ON dbo.STAGING_cms_user_Update_History
    (
    UserID ASC,
    SVR ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];


END;

GO
PRINT 'Executed create_table_STAGING_cms_user.sql';
GO
EXEC proc_Create_Table_STAGING_cms_user;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'creating proc_STAGING_EDW_CT_USER';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_STAGING_EDW_CT_USER') 
    BEGIN
        PRINT 'UPDATING proc_STAGING_EDW_CT_USER';
        DROP PROCEDURE
             proc_STAGING_EDW_CT_USER;
    END;

GO

-- exec proc_STAGING_EDW_CT_USER

CREATE PROCEDURE proc_STAGING_EDW_CT_USER (
     @ReloadAll AS int = 0) 
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'STAGING_cms_user';

    IF @iTotal <= 1
        BEGIN
            SET @Reloadall = 1;
        END;

    --******************************************************************************************************************************
    -- This procedure is added to the job job_EDW_GetStagingData_RewardUserDetail and set to run automatically on a schedule.
    --******************************************************************************************************************************

    BEGIN

        IF @ReloadAll IS NULL
            BEGIN
                SET @ReloadAll = 0;
            END;

        DECLARE
        @RecordID AS uniqueidentifier = NEWID () ;
        DECLARE
        @CT_DateTimeNow AS datetime = GETDATE () ;
        DECLARE
        @CT_NAME AS nvarchar ( 50) = 'proc_STAGING_EDW_CT_USER';
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'I';

        IF @ReloadAll = 1
            BEGIN
                PRINT 'RELOADING ALL Change Tracking CT_USER records';
                EXEC proc_Create_Table_STAGING_cms_user ;
                PRINT 'RELOAD COMPLETE';
            END;
        ELSE
            BEGIN
                EXEC proc_CT_CMS_User_AddNewRecs ;
                EXEC proc_CT_CMS_USER_AddUpdatedRecs ;
                EXEC proc_CMS_User_AddDeletedRecs ;
            END;

    END;
END;

GO
PRINT 'CREATED proc_STAGING_EDW_CT_USER';
PRINT GETDATE () ;
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating JOB job_EDW_GetStagingData_CT_USER';
GO

BEGIN TRANSACTION;
DECLARE
@ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS ( SELECT
                       name
                       FROM msdb.dbo.syscategories
                       WHERE
                       name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB' , @type = N'LOCAL' , @name = N'[Uncategorized (Local)]';
        IF
        @@ERROR <> 0
     OR @ReturnCode <> 0
            BEGIN
                GOTO QuitWithRollback;
            END;

    END;

DECLARE
@TGTDB AS nvarchar ( 50) = DB_NAME () ;

DECLARE
@JNAME AS nvarchar ( 100) = 'job_EDW_GetStagingData_CT_USER_' + @TGTDB;

IF EXISTS ( SELECT
                   job_id
                   FROM msdb.dbo.sysjobs_view
                   WHERE name = @JNAME) 
    BEGIN EXEC msdb.dbo.sp_delete_job @job_name = @JNAME , @delete_unused_schedule = 1;
    END;

DECLARE
@jobId binary ( 16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME , @enabled = 1 , @notify_level_eventlog = 2 , @notify_level_email = 2 , @notify_level_netsend = 0 , @notify_level_page = 0 , @delete_level = 0 , @description = N'No description available.' , @category_name = N'[Uncategorized (Local)]' , @owner_login_name = N'sa' , @notify_email_operator_name = N'DBA_Notify' , @job_id = @jobId OUTPUT;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;

/*---------------------------------------------------------------------------------------
***** Object:  Step [Load_STAGING_EDW_CT_USER]    Script Date: 4/12/2015 9:59:37 AM *****
*/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId , @step_name = N'Load_STAGING_EDW_CT_USER' , @step_id = 1 , @cmdexec_success_code = 0 , @on_success_action = 1 , @on_success_step_id = 0 , @on_fail_action = 2 , @on_fail_step_id = 0 , @retry_attempts = 0 , @retry_interval = 0 , @os_run_priority = 0 , @subsystem = N'TSQL' , @command = N'exec proc_STAGING_EDW_CT_USER;' , @database_name = @TGTDB , @flags = 0;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId , @start_step_id = 1;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId , @name = N'Schedule_STAGING_EDW_CT_USER' , @enabled = 1 , @freq_type = 4 , @freq_interval = 1 , @freq_subday_type = 8 , @freq_subday_interval = 8 , @freq_relative_interval = 0 , @freq_recurrence_factor = 0 , @active_start_date = 20150412 , @active_end_date = 99991231 , @active_start_time = 10000 ,
@active_end_time = 235959;
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId , @server_name = N'(local)';
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN
        ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing TRIG_CMS_User_Audit.SQL';
GO
-- select count(*) from STAGING_CMS_User_Audit
-- select * from STAGING_CMS_User_Audit
-- truncate table STAGING_CMS_User_Audit

IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'STAGING_CMS_User_Audit') 
    BEGIN
        DROP TABLE
             STAGING_CMS_User_Audit;
    END;
GO

CREATE TABLE dbo.STAGING_CMS_User_Audit (
             UserID int NOT NULL
           , SVR nvarchar (100) NOT NULL
           , DBNAME nvarchar (100) NOT NULL
           , SYS_CHANGE_VERSION int NULL
           , SYS_CHANGE_OPERATION nvarchar (10) NULL
           , SchemaName nvarchar (100) NULL
           , SysUser nvarchar (100) NULL
           , IPADDR  nvarchar (50) NULL
           , Processed integer NULL
           , TBL nvarchar (100) NULL
           , CreateDate datetime NULL
           , commit_time datetime NULL
);
GO
ALTER TABLE dbo.STAGING_CMS_User_Audit
ADD
            CONSTRAINT DF_STAGING_CMS_User_Audit_CreateDate  DEFAULT GETDATE () FOR CreateDate;
GO
CREATE CLUSTERED INDEX PK_CMS_User_Audit ON dbo.STAGING_CMS_User_Audit
(
UserID ASC,
SVR ASC,
SYS_CHANGE_VERSION ASC,
SYS_CHANGE_OPERATION ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

GO

/*---------------------------------------------------------------------------------------------------------------
-- TROUBLESHOOTING AND TESTING QRYS
	select count(*) from CMS_User where UserID = 53 and SiteID = 36
	INSERT INTO CMS_User (UserID, SiteID) VALUES (53, 36) ;
	delete from CMS_User where UserID = 53 and SiteID = 36
	select top 1000 * from CMS_User
	select top 1000 * from CMS_User
	update CMS_User set FirstName = FirstName where UserID in (Select top 100 UserID from CMS_User order by UserID )
	select * from STAGING_CMS_User_Audit
	truncate table  STAGING_CMS_User_Audit
*/

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_INS_CMS_User_Audit') 
    BEGIN
        DROP TRIGGER
             trig_INS_CMS_User_Audit;
    END;
GO

CREATE TRIGGER trig_INS_CMS_User_Audit ON CMS_User
    AFTER INSERT
AS
BEGIN

    DECLARE @svr nvarchar (100) = (SELECT
                                          @@SERVERNAME);
    DECLARE @db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CHG_VER int = (SELECT
                                   MAX (CT.SYS_CHANGE_VERSION) 
                                   FROM CHANGETABLE (CHANGES CMS_User, NULL) AS CT);
    DECLARE @ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)) );
    DECLARE @userid nvarchar (50) = (SELECT
                                            USER_NAME () );
    DECLARE @sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);
    IF @CHG_VER IS NULL
        BEGIN
            SET @CHG_VER = 1
        END;

    SET @CHG_VER = @CHG_VER - 1;
    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES CMS_User, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);

    INSERT INTO STAGING_CMS_User_Audit
    (
           UserID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL
         , commit_time
    ) 
    SELECT
           UserID
         , @svr
         , @db
         , @CHG_VER
         , 'I'
         , @userid
         , @sysuser
         , @ipaddr
         , 0 AS Processed
         , 'CMS_User'
         , @Commit_Time
           FROM Inserted;
END;

GO

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_UPDT_CMS_User_Audit') 
    BEGIN
        DROP TRIGGER
             trig_UPDT_CMS_User_Audit;
    END;
GO

CREATE TRIGGER trig_UPDT_CMS_User_Audit ON CMS_User
    AFTER UPDATE
AS
BEGIN

    DECLARE @svr nvarchar (100) = (SELECT
                                          @@SERVERNAME);
    DECLARE @db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CHG_VER int = (SELECT
                                   MAX (CT.SYS_CHANGE_VERSION) 
                                   FROM CHANGETABLE (CHANGES CMS_User, NULL) AS CT);
    DECLARE @ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)) );
    DECLARE @userid nvarchar (50) = (SELECT
                                            USER_NAME () );
    DECLARE @sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);

    IF @CHG_VER IS NULL
        BEGIN
            SET @CHG_VER = 1
        END;

    SET @CHG_VER = @CHG_VER - 1;
    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES CMS_User, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);

    INSERT INTO STAGING_CMS_User_Audit
    (
           UserID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL
         , commit_time
    ) 
    SELECT
           UserID
         , @svr
         , @db
         , @CHG_VER
         , 'U'
         , @userid
         , @sysuser
         , @ipaddr
         , 0 AS Processed
         , 'CMS_User'
         , @Commit_Time
           FROM Inserted;
END;

GO

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_DEL_CMS_User_Audit') 
    BEGIN
        DROP TRIGGER
             trig_DEL_CMS_User_Audit;
    END;
GO

CREATE TRIGGER trig_DEL_CMS_User_Audit ON CMS_User
    AFTER DELETE
AS
BEGIN

    DECLARE @svr nvarchar (100) = (SELECT
                                          @@SERVERNAME);
    DECLARE @db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CHG_VER int = (SELECT
                                   MAX (CT.SYS_CHANGE_VERSION) 
                                   FROM CHANGETABLE (CHANGES CMS_User, NULL) AS CT);
    DECLARE @ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)) );
    DECLARE @userid nvarchar (50) = (SELECT
                                            USER_NAME () );
    DECLARE @sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);

    IF @CHG_VER IS NULL
        BEGIN
            SET @CHG_VER = 1
        END;

    SET @CHG_VER = @CHG_VER - 1;
    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES CMS_User, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);

    INSERT INTO STAGING_CMS_User_Audit
    (
           UserID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL
         , commit_time
    ) 
    SELECT
           UserID
         , @svr
         , @db
         , @CHG_VER
         , 'D'
         , @userid
         , @sysuser
         , @ipaddr
         , 0 AS Processed
         , 'CMS_User'
         , @Commit_Time
           FROM DELETED;
END;

GO
PRINT 'EXECUTED TRIG_CMS_User_Audit.SQL';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_CMS_USER_History.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_CMS_USER_History') 
    BEGIN
        DROP PROCEDURE
             proc_CT_CMS_USER_History;
    END;
GO

/*-------------------------------------------------------------------------
*************************************************************************

select tc.commit_time, *
from
    changetable(changes CMS_USER, 0) c
    join sys.dm_tran_commit_table tc on c.sys_change_version = tc.commit_ts


exec proc_CT_CMS_USER_History 'I'
exec proc_CT_CMS_USER_History 'D'
exec proc_CT_CMS_USER_History 'U'

truncate table STAGING_CMS_USER_Update_History
select * from STAGING_CMS_USER_Update_History

SELECT CHANGE_TRACKING_MIN_VALID_VERSION(OBJECT_ID('CMS_USER'))
*************************************************************************
*/

CREATE PROCEDURE proc_CT_CMS_USER_History (
     @Typesave AS nchar (1)) 
AS
BEGIN
    WITH CTE (
         UserID
       , SYS_CHANGE_VERSION
       , SYS_CHANGE_COLUMNS) 
        AS (SELECT
                   CT.UserID
                 , CT.SYS_CHANGE_VERSION
                 , SYS_CHANGE_COLUMNS
                   FROM CHANGETABLE (CHANGES CMS_USER, NULL) AS CT
                   WHERE SYS_CHANGE_OPERATION = @Typesave
            EXCEPT
            SELECT
                   UserID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_COLUMNS
                   FROM STAGING_CMS_USER_Update_History) 
        INSERT INTO STAGING_CMS_USER_Update_History
        (
               Userid
             , SYS_CHANGE_VERSION
             , SYS_CHANGE_OPERATION
             , SYS_CHANGE_COLUMNS
             --, CurrUser
             --, SysUser
             --, IPADDR
             , commit_time
             , LastModifiedDate
             , SVR
             , DBNAME
             , Email_cg
             , FirstName_cg
             , FullName_cg
             , LastLogon_cg
             , LastName_cg
             , MiddleName_cg
             , PreferredCultureCode_cg
             , PreferredUICultureCode_cg
             , UserCreated_cg
             , UserEnabled_cg
             , UserGUID_cg
             , UserHasAllowedCultures_cg
             , UserID_cg
             , UserIsDomain_cg
             , UserIsEditor_cg
             , UserIsExternal_cg
             , UserIsGlobalAdministrator_cg
             , UserIsHidden_cg
             , UserLastLogonInfo_cg
             , UserLastModified_cg
             , UserMFRequired_cg
             , UserName_cg
             , UserPassword_cg
             , UserPasswordBuffer_cg
             , UserPasswordFormat_cg
             , UserSiteManagerDisabled_cg
             , UserStartingAliasPath_cg
             , UserTokenID_cg
             , UserTokenIteration_cg
             , UserVisibility_cg) 
        SELECT
               CTE.Userid
             , CTE.SYS_CHANGE_VERSION
             , @Typesave as SYS_CHANGE_OPERATION
             , CTE.SYS_CHANGE_COLUMNS
             --, CurrUser
             --, SysUser
             --, IPADDR
             , isnull(tc.commit_time, getdate())
             , GETDATE () AS LastModifiedDate
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME
               --********************************************     
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'Email', 'columnid') , CTE.sys_change_columns) AS Email_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'FirstName', 'columnid') , CTE.sys_change_columns) AS FirstName_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'FullName', 'columnid') , CTE.sys_change_columns) AS FullName_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'LastLogon', 'columnid') , CTE.sys_change_columns) AS LastLogon_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'LastName', 'columnid') , CTE.sys_change_columns) AS LastName_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'MiddleName', 'columnid') , CTE.sys_change_columns) AS MiddleName_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'PreferredCultureCode', 'columnid') , CTE.sys_change_columns) AS PreferredCultureCode_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'PreferredUICultureCode', 'columnid') , CTE.sys_change_columns) AS PreferredUICultureCode_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserCreated', 'columnid') , CTE.sys_change_columns) AS UserCreated_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserEnabled', 'columnid') , CTE.sys_change_columns) AS UserEnabled_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserGUID', 'columnid') , CTE.sys_change_columns) AS UserGUID_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserHasAllowedCultures', 'columnid') , CTE.sys_change_columns) AS UserHasAllowedCultures_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserID', 'columnid') , CTE.sys_change_columns) AS UserID_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserIsDomain', 'columnid') , CTE.sys_change_columns) AS UserIsDomain_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserIsEditor', 'columnid') , CTE.sys_change_columns) AS UserIsEditor_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserIsExternal', 'columnid') , CTE.sys_change_columns) AS UserIsExternal_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserIsGlobalAdministrator', 'columnid') , CTE.sys_change_columns) AS UserIsGlobalAdministrator_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserIsHidden', 'columnid') , CTE.sys_change_columns) AS UserIsHidden_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserLastLogonInfo', 'columnid') , CTE.sys_change_columns) AS UserLastLogonInfo_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserLastModified', 'columnid') , CTE.sys_change_columns) AS UserLastModified_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserMFRequired', 'columnid') , CTE.sys_change_columns) AS UserMFRequired_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserName', 'columnid') , CTE.sys_change_columns) AS UserName_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserPassword', 'columnid') , CTE.sys_change_columns) AS UserPassword_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserPasswordBuffer', 'columnid') , CTE.sys_change_columns) AS UserPasswordBuffer_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserPasswordFormat', 'columnid') , CTE.sys_change_columns) AS UserPasswordFormat_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserSiteManagerDisabled', 'columnid') , CTE.sys_change_columns) AS UserSiteManagerDisabled_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserStartingAliasPath', 'columnid') , CTE.sys_change_columns) AS UserStartingAliasPath_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserTokenID', 'columnid') , CTE.sys_change_columns) AS UserTokenID_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserTokenIteration', 'columnid') , CTE.sys_change_columns) AS UserTokenIteration_cg
             , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_User') , 'UserVisibility', 'columnid') , CTE.sys_change_columns) AS UserVisibility_cg
        --********************************************    				  
               FROM
                   CTE
                       JOIN sys.dm_tran_commit_table AS tc
                           ON CTE.sys_change_version = tc.commit_ts;

END;

GO
PRINT 'Executed proc_CT_CMS_USER_History.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing view_AUDIT_CMS_User.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE name = 'view_AUDIT_CMS_User') 
    BEGIN
        DROP VIEW
             view_AUDIT_CMS_User
    END;

GO

/*-------------------------------------------------
select * from STAGING_CMS_User
select * from STAGING_CMS_User_Update_History
select * from STAGING_CMS_User_Audit
*/
-- select * from view_AUDIT_CMS_User order by UserID desc
/*------------------------------------------------------------------------------
HOW TO USE:
    select * from view_AUDIT_CMS_User
	   where CreateDate between '2015-09-18 14:55:33.000' and '2015-09-18 14:55:34'

    select * from view_AUDIT_CMS_User
	   where SysUser = 'dmiller'
*/

CREATE VIEW view_AUDIT_CMS_User
AS SELECT DISTINCT
          A.SysUser
        , A.IPADDR
        , A.CreateDate
        , A.SYS_CHANGE_OPERATION
        , A.SYS_CHANGE_VERSION as SysChangeVersion
        , S.*
          FROM
              STAGING_CMS_User_Audit AS A
                  JOIN STAGING_CMS_User AS S
                      ON S.UserID = A.UserID;
GO
PRINT 'Executed view_AUDIT_CMS_User.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*------------------------
-----------------
cms_user			    -> DONE
cms_usersettings	  -> DONE
cms_usersite
hfit_ppteligibility
cms_usercontact
*/
GO
PRINT 'Executing create_table_STAGING_CMS_UserSettings.sql';
GO

IF NOT EXISTS (SELECT
                      sys.tables.name AS Table_name
                      FROM
                          sys.change_tracking_tables
                              JOIN sys.tables
                                  ON sys.tables.object_id = sys.change_tracking_tables.object_id
                              JOIN sys.schemas
                                  ON sys.schemas.schema_id = sys.tables.schema_id
                      WHERE sys.tables.name = 'CMS_UserSettings') 
    BEGIN
        PRINT 'ADDING Change Tracking to CMS_UserSettings';
        ALTER TABLE dbo.CMS_UserSettings
            ENABLE CHANGE_TRACKING
                WITH (TRACK_COLUMNS_UPDATED = ON) ;
    END;
ELSE
    BEGIN
        PRINT 'Change Tracking exists on CMS_UserSettings';
    END;
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Create_Table_STAGING_CMS_UserSettings') 
    BEGIN
        DROP PROCEDURE
             proc_Create_Table_STAGING_CMS_UserSettings;
    END;
GO
-- exec proc_Create_Table_STAGING_CMS_UserSettings
-- select top 100 * from [STAGING_CMS_UserSettings]
CREATE PROCEDURE proc_Create_Table_STAGING_CMS_UserSettings
AS
BEGIN

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_CMS_UserSettings') 
        BEGIN
            DROP TABLE
                 dbo.STAGING_CMS_UserSettings;
        END;

    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;

    CREATE TABLE dbo.STAGING_CMS_UserSettings (
                 UserSettingsID int NOT NULL
               , UserNickName nvarchar (200) NULL
               , UserPicture nvarchar (200) NULL
               , UserSignature nvarchar (max) NULL
               , UserURLReferrer nvarchar (450) NULL
               , UserCampaign nvarchar (200) NULL
               , UserMessagingNotificationEmail nvarchar (200) NULL
               , UserCustomData nvarchar (max) NULL
               , UserRegistrationInfo nvarchar (max) NULL
               , UserPreferences nvarchar (max) NULL
               , UserActivationDate datetime2 (7) NULL
               , UserActivatedByUserID int NULL
               , UserTimeZoneID int NULL
               , UserAvatarID int NULL
               , UserBadgeID int NULL
               , UserActivityPoints int NULL
               , UserForumPosts int NULL
               , UserBlogComments int NULL
               , UserGender int NULL
               , UserDateOfBirth datetime2 (7) NULL
               , UserMessageBoardPosts int NULL
               , UserSettingsUserGUID uniqueidentifier NOT NULL
               , UserSettingsUserID int NOT NULL
               , WindowsLiveID nvarchar (50) NULL
               , UserBlogPosts int NULL
               , UserWaitingForApproval bit NULL
               , UserDialogsConfiguration nvarchar (max) NULL
               , UserDescription nvarchar (max) NULL
               , UserUsedWebParts nvarchar (1000) NULL
               , UserUsedWidgets nvarchar (1000) NULL
               , UserFacebookID nvarchar (100) NULL
               , UserAuthenticationGUID uniqueidentifier NULL
               , UserSkype nvarchar (100) NULL
               , UserIM nvarchar (100) NULL
               , UserPhone nvarchar (26) NULL
               , UserPosition nvarchar (200) NULL
               , UserBounces int NULL
               , UserLinkedInID nvarchar (100) NULL
               , UserLogActivities bit NULL
               , UserPasswordRequestHash nvarchar (100) NULL
               , UserInvalidLogOnAttempts int NULL
               , UserInvalidLogOnAttemptsHash nvarchar (100) NULL
               , UserAvatarType nvarchar (200) NULL
               , UserAccountLockReason int NULL
               , UserPasswordLastChanged datetime2 (7) NULL
               , UserSecurityQuestionAnswer1 nvarchar (100) NULL
               , UserSecurityQuestionAnswer2 nvarchar (100) NULL
               , UserSecurityQuestionAnswer3 nvarchar (100) NULL
               , HfitUserSsoId nvarchar (250) NULL
               , HFitIsPlatformEnabled bit NULL
               , HFitIsHraEnabled bit NULL
               , HFitIsIncentivesEnabled bit NULL
               , HFitUserMpiNumber bigint NULL
               , SocialSecurity nvarchar (100) NULL
               , HFitUserMobilePhone nvarchar (15) NULL
               , HFitUserPhoneType nvarchar (10) NULL
               , HFitUserAgreesToTerms bit NULL
               , HFitUserPreferredEmail nvarchar (100) NULL
               , HFitUserPreferredPhone nvarchar (15) NULL
               , HFitUserPreferredFirstName nvarchar (50) NULL
               , HFitUserPhoneExt nvarchar (16) NULL
               , HFitComInboxNotifyByEmail bit NULL
               , HFitComInboxNotifyByText bit NULL
               , HFitComActivitiesNotifyEmail bit NULL
               , HFitComActivitiesNotifyText bit NULL
               , HFitComTipOfTheDayNotifyByEmail bit NULL
               , HFitComTipOfTheDayNotifyByText bit NULL
               , HFitComCoachingTrackingEmail bit NULL
               , HFitComCoachingTrackingText bit NULL
               , HfitUserPreferredMailingAddress nvarchar (100) NULL
               , HfitUserPreferredMailingCity nvarchar (50) NULL
               , HfitUserPreferredMailingState nvarchar (2) NULL
               , HfitUserPreferredMailingPostalCode nvarchar (10) NULL
               , HFitCoachingEnrollDate datetime2 (7) NULL
               , HFitUserAltPreferredPhone nvarchar (15) NULL
               , HFitUserAltPreferredPhoneType int NULL
               , HFitUserAltPreferredPhoneExt nvarchar (16) NULL
               , HFitHealthVision nvarchar (max) NULL
               , HFitCoachId int NULL
               , HFitUserTypeID int NULL
               , HFitCoachSystemLastActivity datetime2 (7) NULL
               , HFitIsConditionManagement bit NULL
               , HFitCoachSystemNextActivity datetime2 (7) NULL
               , HFitCoachWebLastActivity datetime2 (7) NULL
               , HFitUserPreferredCallTime int NULL
               , HFitCoachSession1Date datetime2 (7) NULL
               , HFitCoachSystemCoachID int NULL
               , HFitUserPreferredMailingAddress2 nvarchar (100) NULL
               , HFitCoachingOptOutDate datetime2 (7) NULL
               , HFitCoachingOptOutItemID int NULL
               , HFitComScreeningSchedulersEmail bit NULL
               , HFitCoachingOptOutSentDate datetime2 (7) NULL
               , HFitComScreeningSchedulersText bit NULL
               , WellnessGoalGuid uniqueidentifier NULL
               , UserSecurityQuestionGuid1 uniqueidentifier NULL
               , UserSecurityQuestionGuid2 uniqueidentifier NULL
               , UserSecurityQuestionGuid3 uniqueidentifier NULL
               , HFitUserRegistrationDate datetime2 (7) NULL
               , HFitCoachingServiceLevel int NULL
               , HealthAdvisingEvaluationDate datetime2 (7) NULL
               , HFitCallLogStatus int NULL
               , HFitCallLogStatusDate datetime2 (7) NULL
               , HFitCoachingDeliveryMethod int NULL
               , HFitTrackerReminderDisplayed datetime2 (7) NULL
               , HFitPrimaryContactID int NULL
               , HFitPrimaryContactGuid uniqueidentifier NULL
               , HFitUserIsRegistered bit NULL
               , UserDataComUser nvarchar (200) NULL
               , UserDataComPassword nvarchar (200) NULL
               , UserShowIntroductionTile bit NULL
               , UserDashboardApplications nvarchar (max) NULL
               , LastModifiedDate datetime NULL
               , RowNbr int NULL
               , DeletedFlg bit NULL
               , TimeZone nvarchar (10) NULL
               , ConvertedToCentralTime bit NULL
               , SVR nvarchar (100) NOT NULL
               , DBNAME nvarchar (100) NOT NULL
               , SYS_CHANGE_VERSION int NULL
    ) 
    ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

    ALTER TABLE dbo.STAGING_CMS_UserSettings
    ADD
                DEFAULT @@servername FOR SVR;
    ALTER TABLE dbo.STAGING_CMS_UserSettings
    ADD
                DEFAULT DB_NAME () FOR DBNAME;

    CREATE CLUSTERED INDEX PI_STAGING_CMS_UserSettings ON dbo.STAGING_CMS_UserSettings
    (
    UserSettingsID ASC,
    SVR ASC,
    DBNAME ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

    --SET IDENTITY_INSERT STAGING_CMS_UserSettings ON;

    INSERT INTO STAGING_CMS_UserSettings
    (
           UserSettingsID
         , UserNickName
         , UserPicture
         , UserSignature
         , UserURLReferrer
         , UserCampaign
         , UserMessagingNotificationEmail
         , UserCustomData
         , UserRegistrationInfo
         , UserPreferences
         , UserActivationDate
         , UserActivatedByUserID
         , UserTimeZoneID
         , UserAvatarID
         , UserBadgeID
         , UserActivityPoints
         , UserForumPosts
         , UserBlogComments
         , UserGender
         , UserDateOfBirth
         , UserMessageBoardPosts
         , UserSettingsUserGUID
         , UserSettingsUserID
         , WindowsLiveID
         , UserBlogPosts
         , UserWaitingForApproval
         , UserDialogsConfiguration
         , UserDescription
         , UserUsedWebParts
         , UserUsedWidgets
         , UserFacebookID
         , UserAuthenticationGUID
         , UserSkype
         , UserIM
         , UserPhone
         , UserPosition
         , UserBounces
         , UserLinkedInID
         , UserLogActivities
         , UserPasswordRequestHash
         , UserInvalidLogOnAttempts
         , UserInvalidLogOnAttemptsHash
         , UserAvatarType
         , UserAccountLockReason
         , UserPasswordLastChanged
         , UserSecurityQuestionAnswer1
         , UserSecurityQuestionAnswer2
         , UserSecurityQuestionAnswer3
         , HfitUserSsoId
         , HFitIsPlatformEnabled
         , HFitIsHraEnabled
         , HFitIsIncentivesEnabled
         , HFitUserMpiNumber
         , SocialSecurity
         , HFitUserMobilePhone
         , HFitUserPhoneType
         , HFitUserAgreesToTerms
         , HFitUserPreferredEmail
         , HFitUserPreferredPhone
         , HFitUserPreferredFirstName
         , HFitUserPhoneExt
         , HFitComInboxNotifyByEmail
         , HFitComInboxNotifyByText
         , HFitComActivitiesNotifyEmail
         , HFitComActivitiesNotifyText
         , HFitComTipOfTheDayNotifyByEmail
         , HFitComTipOfTheDayNotifyByText
         , HFitComCoachingTrackingEmail
         , HFitComCoachingTrackingText
         , HfitUserPreferredMailingAddress
         , HfitUserPreferredMailingCity
         , HfitUserPreferredMailingState
         , HfitUserPreferredMailingPostalCode
         , HFitCoachingEnrollDate
         , HFitUserAltPreferredPhone
         , HFitUserAltPreferredPhoneType
         , HFitUserAltPreferredPhoneExt
         , HFitHealthVision
         , HFitCoachId
         , HFitUserTypeID
         , HFitCoachSystemLastActivity
         , HFitIsConditionManagement
         , HFitCoachSystemNextActivity
         , HFitCoachWebLastActivity
         , HFitUserPreferredCallTime
         , HFitCoachSession1Date
         , HFitCoachSystemCoachID
         , HFitUserPreferredMailingAddress2
         , HFitCoachingOptOutDate
         , HFitCoachingOptOutItemID
         , HFitComScreeningSchedulersEmail
         , HFitCoachingOptOutSentDate
         , HFitComScreeningSchedulersText
         , WellnessGoalGuid
         , UserSecurityQuestionGuid1
         , UserSecurityQuestionGuid2
         , UserSecurityQuestionGuid3
         , HFitUserRegistrationDate
         , HFitCoachingServiceLevel
         , HealthAdvisingEvaluationDate
         , HFitCallLogStatus
         , HFitCallLogStatusDate
         , HFitCoachingDeliveryMethod
         , HFitTrackerReminderDisplayed
         , HFitPrimaryContactID
         , HFitPrimaryContactGuid
         , HFitUserIsRegistered
         , UserDataComUser
         , UserDataComPassword
         , UserShowIntroductionTile
         , UserDashboardApplications) 
    SELECT
           UserSettingsID
         , UserNickName
         , UserPicture
         , UserSignature
         , UserURLReferrer
         , UserCampaign
         , UserMessagingNotificationEmail
         , UserCustomData
         , UserRegistrationInfo
         , UserPreferences
         , UserActivationDate
         , UserActivatedByUserID
         , UserTimeZoneID
         , UserAvatarID
         , UserBadgeID
         , UserActivityPoints
         , UserForumPosts
         , UserBlogComments
         , UserGender
         , UserDateOfBirth
         , UserMessageBoardPosts
         , UserSettingsUserGUID
         , UserSettingsUserID
         , WindowsLiveID
         , UserBlogPosts
         , UserWaitingForApproval
         , UserDialogsConfiguration
         , UserDescription
         , UserUsedWebParts
         , UserUsedWidgets
         , UserFacebookID
         , UserAuthenticationGUID
         , UserSkype
         , UserIM
         , UserPhone
         , UserPosition
         , UserBounces
         , UserLinkedInID
         , UserLogActivities
         , UserPasswordRequestHash
         , UserInvalidLogOnAttempts
         , UserInvalidLogOnAttemptsHash
         , UserAvatarType
         , UserAccountLockReason
         , UserPasswordLastChanged
         , UserSecurityQuestionAnswer1
         , UserSecurityQuestionAnswer2
         , UserSecurityQuestionAnswer3
         , HfitUserSsoId
         , HFitIsPlatformEnabled
         , HFitIsHraEnabled
         , HFitIsIncentivesEnabled
         , HFitUserMpiNumber
         , SocialSecurity
         , HFitUserMobilePhone
         , HFitUserPhoneType
         , HFitUserAgreesToTerms
         , HFitUserPreferredEmail
         , HFitUserPreferredPhone
         , HFitUserPreferredFirstName
         , HFitUserPhoneExt
         , HFitComInboxNotifyByEmail
         , HFitComInboxNotifyByText
         , HFitComActivitiesNotifyEmail
         , HFitComActivitiesNotifyText
         , HFitComTipOfTheDayNotifyByEmail
         , HFitComTipOfTheDayNotifyByText
         , HFitComCoachingTrackingEmail
         , HFitComCoachingTrackingText
         , HfitUserPreferredMailingAddress
         , HfitUserPreferredMailingCity
         , HfitUserPreferredMailingState
         , HfitUserPreferredMailingPostalCode
         , HFitCoachingEnrollDate
         , HFitUserAltPreferredPhone
         , HFitUserAltPreferredPhoneType
         , HFitUserAltPreferredPhoneExt
         , HFitHealthVision
         , HFitCoachId
         , HFitUserTypeID
         , HFitCoachSystemLastActivity
         , HFitIsConditionManagement
         , HFitCoachSystemNextActivity
         , HFitCoachWebLastActivity
         , HFitUserPreferredCallTime
         , HFitCoachSession1Date
         , HFitCoachSystemCoachID
         , HFitUserPreferredMailingAddress2
         , HFitCoachingOptOutDate
         , HFitCoachingOptOutItemID
         , HFitComScreeningSchedulersEmail
         , HFitCoachingOptOutSentDate
         , HFitComScreeningSchedulersText
         , WellnessGoalGuid
         , UserSecurityQuestionGuid1
         , UserSecurityQuestionGuid2
         , UserSecurityQuestionGuid3
         , HFitUserRegistrationDate
         , HFitCoachingServiceLevel
         , HealthAdvisingEvaluationDate
         , HFitCallLogStatus
         , HFitCallLogStatusDate
         , HFitCoachingDeliveryMethod
         , HFitTrackerReminderDisplayed
         , HFitPrimaryContactID
         , HFitPrimaryContactGuid
         , HFitUserIsRegistered
         , UserDataComUser
         , UserDataComPassword
         , UserShowIntroductionTile
         , UserDashboardApplications
           FROM CMS_UserSettings;

    --SET IDENTITY_INSERT STAGING_CMS_UserSettings OFF;

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_CMS_UserSettings_Update_History') 
        BEGIN
            DROP TABLE
                 STAGING_CMS_UserSettings_Update_History;
        END;

    CREATE TABLE dbo.STAGING_CMS_UserSettings_Update_History (
                 UserSettingsid int NOT NULL
               ,SYS_CHANGE_VERSION bigint NULL
               ,SYS_CHANGE_OPERATION nchar (1) NULL
               ,SYS_CHANGE_COLUMNS varbinary (4100) NULL
               ,CurrUser varchar (60) NOT NULL
               ,SysUser varchar (60) NOT NULL
               ,IPADDR varchar (60) NOT NULL
               ,commit_time datetime NOT NULL
               ,LastModifiedDate datetime NOT NULL
               ,SVR nvarchar (128) NULL
               ,DBNAME nvarchar (128) NULL
               ,UserSettingsID_cg int NULL
               ,UserNickName_cg int NULL
               ,UserPicture_cg int NULL
               ,UserSignature_cg int NULL
               ,UserURLReferrer_cg int NULL
               ,UserCampaign_cg int NULL
               ,UserMessagingNotificationEmail_cg int NULL
               ,UserCustomData_cg int NULL
               ,UserRegistrationInfo_cg int NULL
               ,UserPreferences_cg int NULL
               ,UserActivationDate_cg int NULL
               ,UserActivatedByUserID_cg int NULL
               ,UserTimeZoneID_cg int NULL
               ,UserAvatarID_cg int NULL
               ,UserBadgeID_cg int NULL
               ,UserActivityPoints_cg int NULL
               ,UserForumPosts_cg int NULL
               ,UserBlogComments_cg int NULL
               ,UserGender_cg int NULL
               ,UserDateOfBirth_cg int NULL
               ,UserMessageBoardPosts_cg int NULL
               ,UserSettingsUserGUID_cg int NULL
               ,UserSettingsUserID_cg int NULL
               ,WindowsLiveID_cg int NULL
               ,UserBlogPosts_cg int NULL
               ,UserWaitingForApproval_cg int NULL
               ,UserDialogsConfiguration_cg int NULL
               ,UserDescription_cg int NULL
               ,UserUsedWebParts_cg int NULL
               ,UserUsedWidgets_cg int NULL
               ,UserFacebookID_cg int NULL
               ,UserAuthenticationGUID_cg int NULL
               ,UserSkype_cg int NULL
               ,UserIM_cg int NULL
               ,UserPhone_cg int NULL
               ,UserPosition_cg int NULL
               ,UserBounces_cg int NULL
               ,UserLinkedInID_cg int NULL
               ,UserLogActivities_cg int NULL
               ,UserPasswordRequestHash_cg int NULL
               ,UserInvalidLogOnAttempts_cg int NULL
               ,UserInvalidLogOnAttemptsHash_cg int NULL
               ,UserAvatarType_cg int NULL
               ,UserAccountLockReason_cg int NULL
               ,UserPasswordLastChanged_cg int NULL
               ,UserSecurityQuestionAnswer1_cg int NULL
               ,UserSecurityQuestionAnswer2_cg int NULL
               ,UserSecurityQuestionAnswer3_cg int NULL
               ,HfitUserSsoId_cg int NULL
               ,HFitIsPlatformEnabled_cg int NULL
               ,HFitIsHraEnabled_cg int NULL
               ,HFitIsIncentivesEnabled_cg int NULL
               ,HFitUserMpiNumber_cg int NULL
               ,SocialSecurity_cg int NULL
               ,HFitUserMobilePhone_cg int NULL
               ,HFitUserPhoneType_cg int NULL
               ,HFitUserAgreesToTerms_cg int NULL
               ,HFitUserPreferredEmail_cg int NULL
               ,HFitUserPreferredPhone_cg int NULL
               ,HFitUserPreferredFirstName_cg int NULL
               ,HFitUserPhoneExt_cg int NULL
               ,HFitComInboxNotifyByEmail_cg int NULL
               ,HFitComInboxNotifyByText_cg int NULL
               ,HFitComActivitiesNotifyEmail_cg int NULL
               ,HFitComActivitiesNotifyText_cg int NULL
               ,HFitComTipOfTheDayNotifyByEmail_cg int NULL
               ,HFitComTipOfTheDayNotifyByText_cg int NULL
               ,HFitComCoachingTrackingEmail_cg int NULL
               ,HFitComCoachingTrackingText_cg int NULL
               ,HfitUserPreferredMailingAddress_cg int NULL
               ,HfitUserPreferredMailingCity_cg int NULL
               ,HfitUserPreferredMailingState_cg int NULL
               ,HfitUserPreferredMailingPostalCode_cg int NULL
               ,HFitCoachingEnrollDate_cg int NULL
               ,HFitUserAltPreferredPhone_cg int NULL
               ,HFitUserAltPreferredPhoneType_cg int NULL
               ,HFitUserAltPreferredPhoneExt_cg int NULL
               ,HFitHealthVision_cg int NULL
               ,HFitCoachId_cg int NULL
               ,HFitUserTypeID_cg int NULL
               ,HFitCoachSystemLastActivity_cg int NULL
               ,HFitIsConditionManagement_cg int NULL
               ,HFitCoachSystemNextActivity_cg int NULL
               ,HFitCoachWebLastActivity_cg int NULL
               ,HFitUserPreferredCallTime_cg int NULL
               ,HFitCoachSession1Date_cg int NULL
               ,HFitCoachSystemCoachID_cg int NULL
               ,HFitUserPreferredMailingAddress2_cg int NULL
               ,HFitCoachingOptOutDate_cg int NULL
               ,HFitCoachingOptOutItemID_cg int NULL
               ,HFitComScreeningSchedulersEmail_cg int NULL
               ,HFitCoachingOptOutSentDate_cg int NULL
               ,HFitComScreeningSchedulersText_cg int NULL
               ,WellnessGoalGuid_cg int NULL
               ,UserSecurityQuestionGuid1_cg int NULL
               ,UserSecurityQuestionGuid2_cg int NULL
               ,UserSecurityQuestionGuid3_cg int NULL
               ,HFitUserRegistrationDate_cg int NULL
               ,HFitCoachingServiceLevel_cg int NULL
               ,HealthAdvisingEvaluationDate_cg int NULL
               ,HFitCallLogStatus_cg int NULL
               ,HFitCallLogStatusDate_cg int NULL
               ,HFitCoachingDeliveryMethod_cg int NULL
               ,HFitTrackerReminderDisplayed_cg int NULL
               ,HFitPrimaryContactID_cg int NULL
               ,HFitPrimaryContactGuid_cg int NULL
               ,HFitUserIsRegistered_cg int NULL
               ,UserDataComUser_cg int NULL
               ,UserDataComPassword_cg int NULL
               ,UserShowIntroductionTile_cg int NULL
               ,UserDashboardApplications_cg int NULL
               ,HFitForgotPasswordAttempts_cg int NULL
               ,HFitForgotPasswordStarted_cg int NULL
    ) 
    ON [PRIMARY];

    ALTER TABLE dbo.STAGING_CMS_UserSettings_Update_History
    ADD
                CONSTRAINT DF_STAGING_CMS_UserSettings_Update_History_CurrUser  DEFAULT USER_NAME () FOR CurrUser;
    ALTER TABLE dbo.STAGING_CMS_UserSettings_Update_History
    ADD
                CONSTRAINT DF_STAGING_CMS_UserSettings_Update_History_SysUser  DEFAULT SUSER_SNAME () FOR SysUser;
    ALTER TABLE dbo.STAGING_CMS_UserSettings_Update_History
    ADD
                CONSTRAINT DF_STAGING_CMS_UserSettings_Update_History_IPADDR  DEFAULT CONVERT (nvarchar (50) , CONNECTIONPROPERTY ('client_net_address')) FOR IPADDR;

    CREATE CLUSTERED INDEX PI_STAGING_CMS_UserSettings_Update_History ON dbo.STAGING_CMS_UserSettings_Update_History
    (
    UserSettingsID ASC,
    SVR ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

    --CREATE CLUSTERED INDEX [PI_STAGING_CMS_UserSettings_Update_History] ON [dbo].[STAGING_CMS_UserSettings_Update_History]
    --(
	   -- [UserSettingsid] ASC
    --)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

END;

GO
PRINT 'Executed create_table_STAGING_CMS_UserSettings.sql';
GO
EXEC proc_Create_Table_STAGING_CMS_UserSettings;
GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing proc_CMS_UserSettings_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CMS_UserSettings_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CMS_UserSettings_AddDeletedRecs;
    END;
GO
/*
    SELECT TOP 100 * FROM CMS_UserSettings
    DELETE FROM CMS_UserSettings where UserSettingsID = 20174
    EXEC proc_CMS_UserSettings_AddDeletedRecs
*/
CREATE PROCEDURE proc_CMS_UserSettings_AddDeletedRecs 
AS
BEGIN

    UPDATE STAGING_CMS_UserSettings
           SET
               DeletedFlg = 1
             ,LastModifiedDate = GETDATE () 
    WHERE
          UserSettingsID IN
          (SELECT
                  UserSettingsID
                  FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT
                  WHERE SYS_CHANGE_OPERATION = 'D') 
      AND DeletedFlg IS NULL;

    DECLARE
    @iCnt AS int = @@ROWCOUNT;
    PRINT 'Deleted Count: ' + CAST ( @iCnt AS nvarchar (50)) ;
    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CMS_UserSettings_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- USe KenticoCMS_Prod1

PRINT 'Executing proc_CT_CMS_UserSettings_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_CMS_UserSettings_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_CMS_UserSettings_AddNewRecs;
    END;
GO

/*
    SELECT TOP 100 * FROM STAGING_CMS_UserSettings
    DELETE FROM STAGING_CMS_UserSettings where UserSettingsID = 20210
    exec proc_CT_CMS_UserSettings_AddNewRecs
*/
CREATE PROCEDURE proc_CT_CMS_UserSettings_AddNewRecs
AS
BEGIN

    --SET IDENTITY_INSERT STAGING_CMS_UserSettings ON;

    WITH CTE (
         UserSettingsID) 
        AS ( SELECT
                    UserSettingsID
                    FROM CMS_UserSettings
             EXCEPT
             SELECT
                    UserSettingsID
                    FROM STAGING_CMS_UserSettings
                    WHERE DeletedFlg IS NULL) 
        INSERT INTO STAGING_CMS_UserSettings
        (
               UserSettingsID
             , UserNickName
             , UserPicture
             , UserSignature
             , UserURLReferrer
             , UserCampaign
             , UserMessagingNotificationEmail
             , UserCustomData
             , UserRegistrationInfo
             , UserPreferences
             , UserActivationDate
             , UserActivatedByUserID
             , UserTimeZoneID
             , UserAvatarID
             , UserBadgeID
             , UserActivityPoints
             , UserForumPosts
             , UserBlogComments
             , UserGender
             , UserDateOfBirth
             , UserMessageBoardPosts
             , UserSettingsUserGUID
             , UserSettingsUserID
             , WindowsLiveID
             , UserBlogPosts
             , UserWaitingForApproval
             , UserDialogsConfiguration
             , UserDescription
             , UserUsedWebParts
             , UserUsedWidgets
             , UserFacebookID
             , UserAuthenticationGUID
             , UserSkype
             , UserIM
             , UserPhone
             , UserPosition
             , UserBounces
             , UserLinkedInID
             , UserLogActivities
             , UserPasswordRequestHash
             , UserInvalidLogOnAttempts
             , UserInvalidLogOnAttemptsHash
             , UserAvatarType
             , UserAccountLockReason
             , UserPasswordLastChanged
             , UserSecurityQuestionAnswer1
             , UserSecurityQuestionAnswer2
             , UserSecurityQuestionAnswer3
             , HfitUserSsoId
             , HFitIsPlatformEnabled
             , HFitIsHraEnabled
             , HFitIsIncentivesEnabled
             , HFitUserMpiNumber
             , SocialSecurity
             , HFitUserMobilePhone
             , HFitUserPhoneType
             , HFitUserAgreesToTerms
             , HFitUserPreferredEmail
             , HFitUserPreferredPhone
             , HFitUserPreferredFirstName
             , HFitUserPhoneExt
             , HFitComInboxNotifyByEmail
             , HFitComInboxNotifyByText
             , HFitComActivitiesNotifyEmail
             , HFitComActivitiesNotifyText
             , HFitComTipOfTheDayNotifyByEmail
             , HFitComTipOfTheDayNotifyByText
             , HFitComCoachingTrackingEmail
             , HFitComCoachingTrackingText
             , HfitUserPreferredMailingAddress
             , HfitUserPreferredMailingCity
             , HfitUserPreferredMailingState
             , HfitUserPreferredMailingPostalCode
             , HFitCoachingEnrollDate
             , HFitUserAltPreferredPhone
             , HFitUserAltPreferredPhoneType
             , HFitUserAltPreferredPhoneExt
             , HFitHealthVision
             , HFitCoachId
             , HFitUserTypeID
             , HFitCoachSystemLastActivity
             , HFitIsConditionManagement
             , HFitCoachSystemNextActivity
             , HFitCoachWebLastActivity
             , HFitUserPreferredCallTime
             , HFitCoachSession1Date
             , HFitCoachSystemCoachID
             , HFitUserPreferredMailingAddress2
             , HFitCoachingOptOutDate
             , HFitCoachingOptOutItemID
             , HFitComScreeningSchedulersEmail
             , HFitCoachingOptOutSentDate
             , HFitComScreeningSchedulersText
             , WellnessGoalGuid
             , UserSecurityQuestionGuid1
             , UserSecurityQuestionGuid2
             , UserSecurityQuestionGuid3
             , HFitUserRegistrationDate
             , HFitCoachingServiceLevel
             , HealthAdvisingEvaluationDate
             , HFitCallLogStatus
             , HFitCallLogStatusDate
             , HFitCoachingDeliveryMethod
             , HFitTrackerReminderDisplayed
             , HFitPrimaryContactID
             , HFitPrimaryContactGuid
             , HFitUserIsRegistered
             , UserDataComUser
             , UserDataComPassword
             , UserShowIntroductionTile
             , UserDashboardApplications

             , LastModifiedDate
               --,[RowNbr]
             , DeletedFlg
             , TimeZone
             , ConvertedToCentralTime
             , SVR
             , DBNAME
             , SYS_CHANGE_VERSION) 
        SELECT
               T.UserSettingsID
             , T.UserNickName
             , T.UserPicture
             , T.UserSignature
             , T.UserURLReferrer
             , T.UserCampaign
             , T.UserMessagingNotificationEmail
             , T.UserCustomData
             , T.UserRegistrationInfo
             , T.UserPreferences
             , T.UserActivationDate
             , T.UserActivatedByUserID
             , T.UserTimeZoneID
             , T.UserAvatarID
             , T.UserBadgeID
             , T.UserActivityPoints
             , T.UserForumPosts
             , T.UserBlogComments
             , T.UserGender
             , T.UserDateOfBirth
             , T.UserMessageBoardPosts
             , T.UserSettingsUserGUID
             , T.UserSettingsUserID
             , T.WindowsLiveID
             , T.UserBlogPosts
             , T.UserWaitingForApproval
             , T.UserDialogsConfiguration
             , T.UserDescription
             , T.UserUsedWebParts
             , T.UserUsedWidgets
             , T.UserFacebookID
             , T.UserAuthenticationGUID
             , T.UserSkype
             , T.UserIM
             , T.UserPhone
             , T.UserPosition
             , T.UserBounces
             , T.UserLinkedInID
             , T.UserLogActivities
             , T.UserPasswordRequestHash
             , T.UserInvalidLogOnAttempts
             , T.UserInvalidLogOnAttemptsHash
             , T.UserAvatarType
             , T.UserAccountLockReason
             , T.UserPasswordLastChanged
             , T.UserSecurityQuestionAnswer1
             , T.UserSecurityQuestionAnswer2
             , T.UserSecurityQuestionAnswer3
             , T.HfitUserSsoId
             , T.HFitIsPlatformEnabled
             , T.HFitIsHraEnabled
             , T.HFitIsIncentivesEnabled
             , T.HFitUserMpiNumber
             , T.SocialSecurity
             , T.HFitUserMobilePhone
             , T.HFitUserPhoneType
             , T.HFitUserAgreesToTerms
             , T.HFitUserPreferredEmail
             , T.HFitUserPreferredPhone
             , T.HFitUserPreferredFirstName
             , T.HFitUserPhoneExt
             , T.HFitComInboxNotifyByEmail
             , T.HFitComInboxNotifyByText
             , T.HFitComActivitiesNotifyEmail
             , T.HFitComActivitiesNotifyText
             , T.HFitComTipOfTheDayNotifyByEmail
             , T.HFitComTipOfTheDayNotifyByText
             , T.HFitComCoachingTrackingEmail
             , T.HFitComCoachingTrackingText
             , T.HfitUserPreferredMailingAddress
             , T.HfitUserPreferredMailingCity
             , T.HfitUserPreferredMailingState
             , T.HfitUserPreferredMailingPostalCode
             , T.HFitCoachingEnrollDate
             , T.HFitUserAltPreferredPhone
             , T.HFitUserAltPreferredPhoneType
             , T.HFitUserAltPreferredPhoneExt
             , T.HFitHealthVision
             , T.HFitCoachId
             , T.HFitUserTypeID
             , T.HFitCoachSystemLastActivity
             , T.HFitIsConditionManagement
             , T.HFitCoachSystemNextActivity
             , T.HFitCoachWebLastActivity
             , T.HFitUserPreferredCallTime
             , T.HFitCoachSession1Date
             , T.HFitCoachSystemCoachID
             , T.HFitUserPreferredMailingAddress2
             , T.HFitCoachingOptOutDate
             , T.HFitCoachingOptOutItemID
             , T.HFitComScreeningSchedulersEmail
             , T.HFitCoachingOptOutSentDate
             , T.HFitComScreeningSchedulersText
             , T.WellnessGoalGuid
             , T.UserSecurityQuestionGuid1
             , T.UserSecurityQuestionGuid2
             , T.UserSecurityQuestionGuid3
             , T.HFitUserRegistrationDate
             , T.HFitCoachingServiceLevel
             , T.HealthAdvisingEvaluationDate
             , T.HFitCallLogStatus
             , T.HFitCallLogStatusDate
             , T.HFitCoachingDeliveryMethod
             , T.HFitTrackerReminderDisplayed
             , T.HFitPrimaryContactID
             , T.HFitPrimaryContactGuid
             , T.HFitUserIsRegistered
             , T.UserDataComUser
             , T.UserDataComPassword
             , T.UserShowIntroductionTile
             , T.UserDashboardApplications

             , GETDATE () AS LastModifiedDate
             , NULL AS DeletedFlg
             , NULL AS TimeZone
             , NULL AS ConvertedToCentralTime
             , @@SERVERNAME AS SVR
             , DB_NAME () AS DBNAME
             , null as SYS_CHANGE_VERSION
               FROM
                   CMS_UserSettings AS T
                       JOIN CTE AS S
                           ON S.UserSettingsID = T.UserSettingsID;
                        
    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    --SET IDENTITY_INSERT STAGING_CMS_UserSettings OFF;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;
    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_CMS_UserSettings_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_CMS_UserSettings_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_CMS_UserSettings_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_CMS_UserSettings_AddUpdatedRecs;
    END;
GO
/*----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
select top 100 * from CMS_UserSettings
update CMS_UserSettings set UserNickName = UserNickName where UserSettingsID in (select top 50 UserSettingsID from CMS_UserSettings order by UserSettingsID desc )

 exec proc_CT_CMS_UserSettings_AddUpdatedRecs
 select * from STAGING_CMS_UserSettings where SYS_CHANGE_VERSION is not null

*/

CREATE PROCEDURE proc_CT_CMS_UserSettings_AddUpdatedRecs
AS
BEGIN
    WITH CTE (
         UserSettingsID
       , SYS_CHANGE_VERSION
       , SYS_CHANGE_OPERATION
       , SYS_CHANGE_COLUMNS) 
        AS ( SELECT
                    CT.UserSettingsID
                  , CT.SYS_CHANGE_VERSION
                  , CT.SYS_CHANGE_OPERATION
                  , SYS_CHANGE_COLUMNS
                    FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT
                    WHERE SYS_CHANGE_OPERATION = 'U') 
        UPDATE S
               SET
                   S.UserSettingsID = T.UserSettingsID
                 ,S.UserNickName = T.UserNickName
                 ,S.UserPicture = T.UserPicture
                 ,S.UserSignature = T.UserSignature
                 ,S.UserURLReferrer = T.UserURLReferrer
                 ,S.UserCampaign = T.UserCampaign
                 ,S.UserMessagingNotificationEmail = T.UserMessagingNotificationEmail
                 ,S.UserCustomData = T.UserCustomData
                 ,S.UserRegistrationInfo = T.UserRegistrationInfo
                 ,S.UserPreferences = T.UserPreferences
                 ,S.UserActivationDate = T.UserActivationDate
                 ,S.UserActivatedByUserID = T.UserActivatedByUserID
                 ,S.UserTimeZoneID = T.UserTimeZoneID
                 ,S.UserAvatarID = T.UserAvatarID
                 ,S.UserBadgeID = T.UserBadgeID
                 ,S.UserActivityPoints = T.UserActivityPoints
                 ,S.UserForumPosts = T.UserForumPosts
                 ,S.UserBlogComments = T.UserBlogComments
                 ,S.UserGender = T.UserGender
                 ,S.UserDateOfBirth = T.UserDateOfBirth
                 ,S.UserMessageBoardPosts = T.UserMessageBoardPosts
                 ,S.UserSettingsUserGUID = T.UserSettingsUserGUID
                 ,S.UserSettingsUserID = T.UserSettingsUserID
                 ,S.WindowsLiveID = T.WindowsLiveID
                 ,S.UserBlogPosts = T.UserBlogPosts
                 ,S.UserWaitingForApproval = T.UserWaitingForApproval
                 ,S.UserDialogsConfiguration = T.UserDialogsConfiguration
                 ,S.UserDescription = T.UserDescription
                 ,S.UserUsedWebParts = T.UserUsedWebParts
                 ,S.UserUsedWidgets = T.UserUsedWidgets
                 ,S.UserFacebookID = T.UserFacebookID
                 ,S.UserAuthenticationGUID = T.UserAuthenticationGUID
                 ,S.UserSkype = T.UserSkype
                 ,S.UserIM = T.UserIM
                 ,S.UserPhone = T.UserPhone
                 ,S.UserPosition = T.UserPosition
                 ,S.UserBounces = T.UserBounces
                 ,S.UserLinkedInID = T.UserLinkedInID
                 ,S.UserLogActivities = T.UserLogActivities
                 ,S.UserPasswordRequestHash = T.UserPasswordRequestHash
                 ,S.UserInvalidLogOnAttempts = T.UserInvalidLogOnAttempts
                 ,S.UserInvalidLogOnAttemptsHash = T.UserInvalidLogOnAttemptsHash
                 ,S.UserAvatarType = T.UserAvatarType
                 ,S.UserAccountLockReason = T.UserAccountLockReason
                 ,S.UserPasswordLastChanged = T.UserPasswordLastChanged
                 ,S.UserSecurityQuestionAnswer1 = T.UserSecurityQuestionAnswer1
                 ,S.UserSecurityQuestionAnswer2 = T.UserSecurityQuestionAnswer2
                 ,S.UserSecurityQuestionAnswer3 = T.UserSecurityQuestionAnswer3
                 ,S.HfitUserSsoId = T.HfitUserSsoId
                 ,S.HFitIsPlatformEnabled = T.HFitIsPlatformEnabled
                 ,S.HFitIsHraEnabled = T.HFitIsHraEnabled
                 ,S.HFitIsIncentivesEnabled = T.HFitIsIncentivesEnabled
                 ,S.HFitUserMpiNumber = T.HFitUserMpiNumber
                 ,S.SocialSecurity = T.SocialSecurity
                 ,S.HFitUserMobilePhone = T.HFitUserMobilePhone
                 ,S.HFitUserPhoneType = T.HFitUserPhoneType
                 ,S.HFitUserAgreesToTerms = T.HFitUserAgreesToTerms
                 ,S.HFitUserPreferredEmail = T.HFitUserPreferredEmail
                 ,S.HFitUserPreferredPhone = T.HFitUserPreferredPhone
                 ,S.HFitUserPreferredFirstName = T.HFitUserPreferredFirstName
                 ,S.HFitUserPhoneExt = T.HFitUserPhoneExt
                 ,S.HFitComInboxNotifyByEmail = T.HFitComInboxNotifyByEmail
                 ,S.HFitComInboxNotifyByText = T.HFitComInboxNotifyByText
                 ,S.HFitComActivitiesNotifyEmail = T.HFitComActivitiesNotifyEmail
                 ,S.HFitComActivitiesNotifyText = T.HFitComActivitiesNotifyText
                 ,S.HFitComTipOfTheDayNotifyByEmail = T.HFitComTipOfTheDayNotifyByEmail
                 ,S.HFitComTipOfTheDayNotifyByText = T.HFitComTipOfTheDayNotifyByText
                 ,S.HFitComCoachingTrackingEmail = T.HFitComCoachingTrackingEmail
                 ,S.HFitComCoachingTrackingText = T.HFitComCoachingTrackingText
                 ,S.HfitUserPreferredMailingAddress = T.HfitUserPreferredMailingAddress
                 ,S.HfitUserPreferredMailingCity = T.HfitUserPreferredMailingCity
                 ,S.HfitUserPreferredMailingState = T.HfitUserPreferredMailingState
                 ,S.HfitUserPreferredMailingPostalCode = T.HfitUserPreferredMailingPostalCode
                 ,S.HFitCoachingEnrollDate = T.HFitCoachingEnrollDate
                 ,S.HFitUserAltPreferredPhone = T.HFitUserAltPreferredPhone
                 ,S.HFitUserAltPreferredPhoneType = T.HFitUserAltPreferredPhoneType
                 ,S.HFitUserAltPreferredPhoneExt = T.HFitUserAltPreferredPhoneExt
                 ,S.HFitHealthVision = T.HFitHealthVision
                 ,S.HFitCoachId = T.HFitCoachId
                 ,S.HFitUserTypeID = T.HFitUserTypeID
                 ,S.HFitCoachSystemLastActivity = T.HFitCoachSystemLastActivity
                 ,S.HFitIsConditionManagement = T.HFitIsConditionManagement
                 ,S.HFitCoachSystemNextActivity = T.HFitCoachSystemNextActivity
                 ,S.HFitCoachWebLastActivity = T.HFitCoachWebLastActivity
                 ,S.HFitUserPreferredCallTime = T.HFitUserPreferredCallTime
                 ,S.HFitCoachSession1Date = T.HFitCoachSession1Date
                 ,S.HFitCoachSystemCoachID = T.HFitCoachSystemCoachID
                 ,S.HFitUserPreferredMailingAddress2 = T.HFitUserPreferredMailingAddress2
                 ,S.HFitCoachingOptOutDate = T.HFitCoachingOptOutDate
                 ,S.HFitCoachingOptOutItemID = T.HFitCoachingOptOutItemID
                 ,S.HFitComScreeningSchedulersEmail = T.HFitComScreeningSchedulersEmail
                 ,S.HFitCoachingOptOutSentDate = T.HFitCoachingOptOutSentDate
                 ,S.HFitComScreeningSchedulersText = T.HFitComScreeningSchedulersText
                 ,S.WellnessGoalGuid = T.WellnessGoalGuid
                 ,S.UserSecurityQuestionGuid1 = T.UserSecurityQuestionGuid1
                 ,S.UserSecurityQuestionGuid2 = T.UserSecurityQuestionGuid2
                 ,S.UserSecurityQuestionGuid3 = T.UserSecurityQuestionGuid3
                 ,S.HFitUserRegistrationDate = T.HFitUserRegistrationDate
                 ,S.HFitCoachingServiceLevel = T.HFitCoachingServiceLevel
                 ,S.HealthAdvisingEvaluationDate = T.HealthAdvisingEvaluationDate
                 ,S.HFitCallLogStatus = T.HFitCallLogStatus
                 ,S.HFitCallLogStatusDate = T.HFitCallLogStatusDate
                 ,S.HFitCoachingDeliveryMethod = T.HFitCoachingDeliveryMethod
                 ,S.HFitTrackerReminderDisplayed = T.HFitTrackerReminderDisplayed
                 ,S.HFitPrimaryContactID = T.HFitPrimaryContactID
                 ,S.HFitPrimaryContactGuid = T.HFitPrimaryContactGuid
                 ,S.HFitUserIsRegistered = T.HFitUserIsRegistered
                 ,S.UserDataComUser = T.UserDataComUser
                 ,S.UserDataComPassword = T.UserDataComPassword
                 ,S.UserShowIntroductionTile = T.UserShowIntroductionTile
                 ,S.UserDashboardApplications = T.UserDashboardApplications

                 ,S.LastModifiedDate = GETDATE () 
                 ,S.DeletedFlg = NULL
                 ,S.ConvertedToCentralTime = NULL
                 ,S.SYS_CHANGE_VERSION = CTE.SYS_CHANGE_VERSION
                   FROM STAGING_CMS_UserSettings AS S
                            JOIN
                            CMS_UserSettings AS T
                                ON
                                S.UserSettingsID = T.UserSettingsID
                            AND S.DeletedFlg IS NULL
                            JOIN CTE
                                ON CTE.UserSettingsID = T.UserSettingsID
                               AND (CTE.SYS_CHANGE_VERSION != S.SYS_CHANGE_VERSION
                                 OR S.SYS_CHANGE_VERSION IS NULL);

    DECLARE
    @iCnt AS int = @@ROWCOUNT;
    PRINT 'Updated Count: ' + CAST ( @iCnt AS nvarchar (50)) ;

    exec proc_CT_CMS_UserSettings_History 'U';

    --WITH CTE (
    --     UserSettingsID
    --   , SYS_CHANGE_VERSION
    --   , SYS_CHANGE_COLUMNS) 
    --    AS ( SELECT
    --                CT.UserSettingsID
    --              , CT.SYS_CHANGE_VERSION
    --              , SYS_CHANGE_COLUMNS
    --                FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT
    --                WHERE SYS_CHANGE_OPERATION = 'U'
    --         EXCEPT
    --         SELECT
    --                UserSettingsID
    --              , SYS_CHANGE_VERSION
    --              , SYS_CHANGE_COLUMNS
    --                FROM STAGING_CMS_UserSettings_Update_History
    --    ) 
    --    INSERT INTO STAGING_CMS_UserSettings_Update_History
    --    (
    --           UserSettingsID
    --         , LastModifiedDate
    --         , SVR
    --         , DBNAME
    --         , SYS_CHANGE_VERSION
    --         , SYS_CHANGE_COLUMNS, commit_time) 
    --    SELECT
    --           CTE.UserSettingsID
    --         , GETDATE () AS LastModifiedDate
    --         , @@SERVERNAME AS SVR
    --         , DB_NAME () AS DBNAME
    --         , CTE.SYS_CHANGE_VERSION
    --         , CTE.SYS_CHANGE_COLUMNS, tc.commit_time
    --           FROM CTE JOIN sys.dm_tran_commit_table AS tc
    --                       ON CTE.sys_change_version = tc.commit_ts;

    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CT_CMS_UserSettings_AddUpdatedRecs.sql';
GO
 --**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*------------------------
-----------------
cms_user			    -> DONE
cms_usersettings	  -> DONE
cms_usersite
hfit_ppteligibility
cms_usercontact
*/
GO
PRINT 'Executing create_table_STAGING_CMS_UserSettings.sql';
GO

IF NOT EXISTS (SELECT
                      sys.tables.name AS Table_name
                      FROM
                          sys.change_tracking_tables
                              JOIN sys.tables
                                  ON sys.tables.object_id = sys.change_tracking_tables.object_id
                              JOIN sys.schemas
                                  ON sys.schemas.schema_id = sys.tables.schema_id
                      WHERE sys.tables.name = 'CMS_UserSettings') 
    BEGIN
        PRINT 'ADDING Change Tracking to CMS_UserSettings';
        ALTER TABLE dbo.CMS_UserSettings
            ENABLE CHANGE_TRACKING
                WITH (TRACK_COLUMNS_UPDATED = ON) ;
    END;
ELSE
    BEGIN
        PRINT 'Change Tracking exists on CMS_UserSettings';
    END;
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Create_Table_STAGING_CMS_UserSettings') 
    BEGIN
        DROP PROCEDURE
             proc_Create_Table_STAGING_CMS_UserSettings;
    END;
GO
-- exec proc_Create_Table_STAGING_CMS_UserSettings
-- select top 100 * from [STAGING_CMS_UserSettings]
CREATE PROCEDURE proc_Create_Table_STAGING_CMS_UserSettings
AS
BEGIN

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_CMS_UserSettings') 
        BEGIN
            DROP TABLE
                 dbo.STAGING_CMS_UserSettings;
        END;

    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;

    CREATE TABLE dbo.STAGING_CMS_UserSettings (
                 UserSettingsID int NOT NULL
               , UserNickName nvarchar (200) NULL
               , UserPicture nvarchar (200) NULL
               , UserSignature nvarchar (max) NULL
               , UserURLReferrer nvarchar (450) NULL
               , UserCampaign nvarchar (200) NULL
               , UserMessagingNotificationEmail nvarchar (200) NULL
               , UserCustomData nvarchar (max) NULL
               , UserRegistrationInfo nvarchar (max) NULL
               , UserPreferences nvarchar (max) NULL
               , UserActivationDate datetime2 (7) NULL
               , UserActivatedByUserID int NULL
               , UserTimeZoneID int NULL
               , UserAvatarID int NULL
               , UserBadgeID int NULL
               , UserActivityPoints int NULL
               , UserForumPosts int NULL
               , UserBlogComments int NULL
               , UserGender int NULL
               , UserDateOfBirth datetime2 (7) NULL
               , UserMessageBoardPosts int NULL
               , UserSettingsUserGUID uniqueidentifier NOT NULL
               , UserSettingsUserID int NOT NULL
               , WindowsLiveID nvarchar (50) NULL
               , UserBlogPosts int NULL
               , UserWaitingForApproval bit NULL
               , UserDialogsConfiguration nvarchar (max) NULL
               , UserDescription nvarchar (max) NULL
               , UserUsedWebParts nvarchar (1000) NULL
               , UserUsedWidgets nvarchar (1000) NULL
               , UserFacebookID nvarchar (100) NULL
               , UserAuthenticationGUID uniqueidentifier NULL
               , UserSkype nvarchar (100) NULL
               , UserIM nvarchar (100) NULL
               , UserPhone nvarchar (26) NULL
               , UserPosition nvarchar (200) NULL
               , UserBounces int NULL
               , UserLinkedInID nvarchar (100) NULL
               , UserLogActivities bit NULL
               , UserPasswordRequestHash nvarchar (100) NULL
               , UserInvalidLogOnAttempts int NULL
               , UserInvalidLogOnAttemptsHash nvarchar (100) NULL
               , UserAvatarType nvarchar (200) NULL
               , UserAccountLockReason int NULL
               , UserPasswordLastChanged datetime2 (7) NULL
               , UserSecurityQuestionAnswer1 nvarchar (100) NULL
               , UserSecurityQuestionAnswer2 nvarchar (100) NULL
               , UserSecurityQuestionAnswer3 nvarchar (100) NULL
               , HfitUserSsoId nvarchar (250) NULL
               , HFitIsPlatformEnabled bit NULL
               , HFitIsHraEnabled bit NULL
               , HFitIsIncentivesEnabled bit NULL
               , HFitUserMpiNumber bigint NULL
               , SocialSecurity nvarchar (100) NULL
               , HFitUserMobilePhone nvarchar (15) NULL
               , HFitUserPhoneType nvarchar (10) NULL
               , HFitUserAgreesToTerms bit NULL
               , HFitUserPreferredEmail nvarchar (100) NULL
               , HFitUserPreferredPhone nvarchar (15) NULL
               , HFitUserPreferredFirstName nvarchar (50) NULL
               , HFitUserPhoneExt nvarchar (16) NULL
               , HFitComInboxNotifyByEmail bit NULL
               , HFitComInboxNotifyByText bit NULL
               , HFitComActivitiesNotifyEmail bit NULL
               , HFitComActivitiesNotifyText bit NULL
               , HFitComTipOfTheDayNotifyByEmail bit NULL
               , HFitComTipOfTheDayNotifyByText bit NULL
               , HFitComCoachingTrackingEmail bit NULL
               , HFitComCoachingTrackingText bit NULL
               , HfitUserPreferredMailingAddress nvarchar (100) NULL
               , HfitUserPreferredMailingCity nvarchar (50) NULL
               , HfitUserPreferredMailingState nvarchar (2) NULL
               , HfitUserPreferredMailingPostalCode nvarchar (10) NULL
               , HFitCoachingEnrollDate datetime2 (7) NULL
               , HFitUserAltPreferredPhone nvarchar (15) NULL
               , HFitUserAltPreferredPhoneType int NULL
               , HFitUserAltPreferredPhoneExt nvarchar (16) NULL
               , HFitHealthVision nvarchar (max) NULL
               , HFitCoachId int NULL
               , HFitUserTypeID int NULL
               , HFitCoachSystemLastActivity datetime2 (7) NULL
               , HFitIsConditionManagement bit NULL
               , HFitCoachSystemNextActivity datetime2 (7) NULL
               , HFitCoachWebLastActivity datetime2 (7) NULL
               , HFitUserPreferredCallTime int NULL
               , HFitCoachSession1Date datetime2 (7) NULL
               , HFitCoachSystemCoachID int NULL
               , HFitUserPreferredMailingAddress2 nvarchar (100) NULL
               , HFitCoachingOptOutDate datetime2 (7) NULL
               , HFitCoachingOptOutItemID int NULL
               , HFitComScreeningSchedulersEmail bit NULL
               , HFitCoachingOptOutSentDate datetime2 (7) NULL
               , HFitComScreeningSchedulersText bit NULL
               , WellnessGoalGuid uniqueidentifier NULL
               , UserSecurityQuestionGuid1 uniqueidentifier NULL
               , UserSecurityQuestionGuid2 uniqueidentifier NULL
               , UserSecurityQuestionGuid3 uniqueidentifier NULL
               , HFitUserRegistrationDate datetime2 (7) NULL
               , HFitCoachingServiceLevel int NULL
               , HealthAdvisingEvaluationDate datetime2 (7) NULL
               , HFitCallLogStatus int NULL
               , HFitCallLogStatusDate datetime2 (7) NULL
               , HFitCoachingDeliveryMethod int NULL
               , HFitTrackerReminderDisplayed datetime2 (7) NULL
               , HFitPrimaryContactID int NULL
               , HFitPrimaryContactGuid uniqueidentifier NULL
               , HFitUserIsRegistered bit NULL
               , UserDataComUser nvarchar (200) NULL
               , UserDataComPassword nvarchar (200) NULL
               , UserShowIntroductionTile bit NULL
               , UserDashboardApplications nvarchar (max) NULL
               , LastModifiedDate datetime NULL
               , RowNbr int NULL
               , DeletedFlg bit NULL
               , TimeZone nvarchar (10) NULL
               , ConvertedToCentralTime bit NULL
               , SVR nvarchar (100) NOT NULL
               , DBNAME nvarchar (100) NOT NULL
               , SYS_CHANGE_VERSION int NULL
    ) 
    ON [PRIMARY] TEXTIMAGE_ON [PRIMARY];

    ALTER TABLE dbo.STAGING_CMS_UserSettings
    ADD
                DEFAULT @@servername FOR SVR;
    ALTER TABLE dbo.STAGING_CMS_UserSettings
    ADD
                DEFAULT DB_NAME () FOR DBNAME;

    CREATE CLUSTERED INDEX PI_STAGING_CMS_UserSettings ON dbo.STAGING_CMS_UserSettings
    (
    UserSettingsID ASC,
    SVR ASC,
    DBNAME ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

    --SET IDENTITY_INSERT STAGING_CMS_UserSettings ON;

    INSERT INTO STAGING_CMS_UserSettings
    (
           UserSettingsID
         , UserNickName
         , UserPicture
         , UserSignature
         , UserURLReferrer
         , UserCampaign
         , UserMessagingNotificationEmail
         , UserCustomData
         , UserRegistrationInfo
         , UserPreferences
         , UserActivationDate
         , UserActivatedByUserID
         , UserTimeZoneID
         , UserAvatarID
         , UserBadgeID
         , UserActivityPoints
         , UserForumPosts
         , UserBlogComments
         , UserGender
         , UserDateOfBirth
         , UserMessageBoardPosts
         , UserSettingsUserGUID
         , UserSettingsUserID
         , WindowsLiveID
         , UserBlogPosts
         , UserWaitingForApproval
         , UserDialogsConfiguration
         , UserDescription
         , UserUsedWebParts
         , UserUsedWidgets
         , UserFacebookID
         , UserAuthenticationGUID
         , UserSkype
         , UserIM
         , UserPhone
         , UserPosition
         , UserBounces
         , UserLinkedInID
         , UserLogActivities
         , UserPasswordRequestHash
         , UserInvalidLogOnAttempts
         , UserInvalidLogOnAttemptsHash
         , UserAvatarType
         , UserAccountLockReason
         , UserPasswordLastChanged
         , UserSecurityQuestionAnswer1
         , UserSecurityQuestionAnswer2
         , UserSecurityQuestionAnswer3
         , HfitUserSsoId
         , HFitIsPlatformEnabled
         , HFitIsHraEnabled
         , HFitIsIncentivesEnabled
         , HFitUserMpiNumber
         , SocialSecurity
         , HFitUserMobilePhone
         , HFitUserPhoneType
         , HFitUserAgreesToTerms
         , HFitUserPreferredEmail
         , HFitUserPreferredPhone
         , HFitUserPreferredFirstName
         , HFitUserPhoneExt
         , HFitComInboxNotifyByEmail
         , HFitComInboxNotifyByText
         , HFitComActivitiesNotifyEmail
         , HFitComActivitiesNotifyText
         , HFitComTipOfTheDayNotifyByEmail
         , HFitComTipOfTheDayNotifyByText
         , HFitComCoachingTrackingEmail
         , HFitComCoachingTrackingText
         , HfitUserPreferredMailingAddress
         , HfitUserPreferredMailingCity
         , HfitUserPreferredMailingState
         , HfitUserPreferredMailingPostalCode
         , HFitCoachingEnrollDate
         , HFitUserAltPreferredPhone
         , HFitUserAltPreferredPhoneType
         , HFitUserAltPreferredPhoneExt
         , HFitHealthVision
         , HFitCoachId
         , HFitUserTypeID
         , HFitCoachSystemLastActivity
         , HFitIsConditionManagement
         , HFitCoachSystemNextActivity
         , HFitCoachWebLastActivity
         , HFitUserPreferredCallTime
         , HFitCoachSession1Date
         , HFitCoachSystemCoachID
         , HFitUserPreferredMailingAddress2
         , HFitCoachingOptOutDate
         , HFitCoachingOptOutItemID
         , HFitComScreeningSchedulersEmail
         , HFitCoachingOptOutSentDate
         , HFitComScreeningSchedulersText
         , WellnessGoalGuid
         , UserSecurityQuestionGuid1
         , UserSecurityQuestionGuid2
         , UserSecurityQuestionGuid3
         , HFitUserRegistrationDate
         , HFitCoachingServiceLevel
         , HealthAdvisingEvaluationDate
         , HFitCallLogStatus
         , HFitCallLogStatusDate
         , HFitCoachingDeliveryMethod
         , HFitTrackerReminderDisplayed
         , HFitPrimaryContactID
         , HFitPrimaryContactGuid
         , HFitUserIsRegistered
         , UserDataComUser
         , UserDataComPassword
         , UserShowIntroductionTile
         , UserDashboardApplications) 
    SELECT
           UserSettingsID
         , UserNickName
         , UserPicture
         , UserSignature
         , UserURLReferrer
         , UserCampaign
         , UserMessagingNotificationEmail
         , UserCustomData
         , UserRegistrationInfo
         , UserPreferences
         , UserActivationDate
         , UserActivatedByUserID
         , UserTimeZoneID
         , UserAvatarID
         , UserBadgeID
         , UserActivityPoints
         , UserForumPosts
         , UserBlogComments
         , UserGender
         , UserDateOfBirth
         , UserMessageBoardPosts
         , UserSettingsUserGUID
         , UserSettingsUserID
         , WindowsLiveID
         , UserBlogPosts
         , UserWaitingForApproval
         , UserDialogsConfiguration
         , UserDescription
         , UserUsedWebParts
         , UserUsedWidgets
         , UserFacebookID
         , UserAuthenticationGUID
         , UserSkype
         , UserIM
         , UserPhone
         , UserPosition
         , UserBounces
         , UserLinkedInID
         , UserLogActivities
         , UserPasswordRequestHash
         , UserInvalidLogOnAttempts
         , UserInvalidLogOnAttemptsHash
         , UserAvatarType
         , UserAccountLockReason
         , UserPasswordLastChanged
         , UserSecurityQuestionAnswer1
         , UserSecurityQuestionAnswer2
         , UserSecurityQuestionAnswer3
         , HfitUserSsoId
         , HFitIsPlatformEnabled
         , HFitIsHraEnabled
         , HFitIsIncentivesEnabled
         , HFitUserMpiNumber
         , SocialSecurity
         , HFitUserMobilePhone
         , HFitUserPhoneType
         , HFitUserAgreesToTerms
         , HFitUserPreferredEmail
         , HFitUserPreferredPhone
         , HFitUserPreferredFirstName
         , HFitUserPhoneExt
         , HFitComInboxNotifyByEmail
         , HFitComInboxNotifyByText
         , HFitComActivitiesNotifyEmail
         , HFitComActivitiesNotifyText
         , HFitComTipOfTheDayNotifyByEmail
         , HFitComTipOfTheDayNotifyByText
         , HFitComCoachingTrackingEmail
         , HFitComCoachingTrackingText
         , HfitUserPreferredMailingAddress
         , HfitUserPreferredMailingCity
         , HfitUserPreferredMailingState
         , HfitUserPreferredMailingPostalCode
         , HFitCoachingEnrollDate
         , HFitUserAltPreferredPhone
         , HFitUserAltPreferredPhoneType
         , HFitUserAltPreferredPhoneExt
         , HFitHealthVision
         , HFitCoachId
         , HFitUserTypeID
         , HFitCoachSystemLastActivity
         , HFitIsConditionManagement
         , HFitCoachSystemNextActivity
         , HFitCoachWebLastActivity
         , HFitUserPreferredCallTime
         , HFitCoachSession1Date
         , HFitCoachSystemCoachID
         , HFitUserPreferredMailingAddress2
         , HFitCoachingOptOutDate
         , HFitCoachingOptOutItemID
         , HFitComScreeningSchedulersEmail
         , HFitCoachingOptOutSentDate
         , HFitComScreeningSchedulersText
         , WellnessGoalGuid
         , UserSecurityQuestionGuid1
         , UserSecurityQuestionGuid2
         , UserSecurityQuestionGuid3
         , HFitUserRegistrationDate
         , HFitCoachingServiceLevel
         , HealthAdvisingEvaluationDate
         , HFitCallLogStatus
         , HFitCallLogStatusDate
         , HFitCoachingDeliveryMethod
         , HFitTrackerReminderDisplayed
         , HFitPrimaryContactID
         , HFitPrimaryContactGuid
         , HFitUserIsRegistered
         , UserDataComUser
         , UserDataComPassword
         , UserShowIntroductionTile
         , UserDashboardApplications
           FROM CMS_UserSettings;

    --SET IDENTITY_INSERT STAGING_CMS_UserSettings OFF;

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_CMS_UserSettings_Update_History') 
        BEGIN
            DROP TABLE
                 STAGING_CMS_UserSettings_Update_History;
        END;

    CREATE TABLE dbo.STAGING_CMS_UserSettings_Update_History (
                 UserSettingsid int NOT NULL
               ,SYS_CHANGE_VERSION bigint NULL
               ,SYS_CHANGE_OPERATION nchar (1) NULL
               ,SYS_CHANGE_COLUMNS varbinary (4100) NULL
               ,CurrUser varchar (60) NOT NULL
               ,SysUser varchar (60) NOT NULL
               ,IPADDR varchar (60) NOT NULL
               ,commit_time datetime NOT NULL
               ,LastModifiedDate datetime NOT NULL
               ,SVR nvarchar (128) NULL
               ,DBNAME nvarchar (128) NULL
               ,UserSettingsID_cg int NULL
               ,UserNickName_cg int NULL
               ,UserPicture_cg int NULL
               ,UserSignature_cg int NULL
               ,UserURLReferrer_cg int NULL
               ,UserCampaign_cg int NULL
               ,UserMessagingNotificationEmail_cg int NULL
               ,UserCustomData_cg int NULL
               ,UserRegistrationInfo_cg int NULL
               ,UserPreferences_cg int NULL
               ,UserActivationDate_cg int NULL
               ,UserActivatedByUserID_cg int NULL
               ,UserTimeZoneID_cg int NULL
               ,UserAvatarID_cg int NULL
               ,UserBadgeID_cg int NULL
               ,UserActivityPoints_cg int NULL
               ,UserForumPosts_cg int NULL
               ,UserBlogComments_cg int NULL
               ,UserGender_cg int NULL
               ,UserDateOfBirth_cg int NULL
               ,UserMessageBoardPosts_cg int NULL
               ,UserSettingsUserGUID_cg int NULL
               ,UserSettingsUserID_cg int NULL
               ,WindowsLiveID_cg int NULL
               ,UserBlogPosts_cg int NULL
               ,UserWaitingForApproval_cg int NULL
               ,UserDialogsConfiguration_cg int NULL
               ,UserDescription_cg int NULL
               ,UserUsedWebParts_cg int NULL
               ,UserUsedWidgets_cg int NULL
               ,UserFacebookID_cg int NULL
               ,UserAuthenticationGUID_cg int NULL
               ,UserSkype_cg int NULL
               ,UserIM_cg int NULL
               ,UserPhone_cg int NULL
               ,UserPosition_cg int NULL
               ,UserBounces_cg int NULL
               ,UserLinkedInID_cg int NULL
               ,UserLogActivities_cg int NULL
               ,UserPasswordRequestHash_cg int NULL
               ,UserInvalidLogOnAttempts_cg int NULL
               ,UserInvalidLogOnAttemptsHash_cg int NULL
               ,UserAvatarType_cg int NULL
               ,UserAccountLockReason_cg int NULL
               ,UserPasswordLastChanged_cg int NULL
               ,UserSecurityQuestionAnswer1_cg int NULL
               ,UserSecurityQuestionAnswer2_cg int NULL
               ,UserSecurityQuestionAnswer3_cg int NULL
               ,HfitUserSsoId_cg int NULL
               ,HFitIsPlatformEnabled_cg int NULL
               ,HFitIsHraEnabled_cg int NULL
               ,HFitIsIncentivesEnabled_cg int NULL
               ,HFitUserMpiNumber_cg int NULL
               ,SocialSecurity_cg int NULL
               ,HFitUserMobilePhone_cg int NULL
               ,HFitUserPhoneType_cg int NULL
               ,HFitUserAgreesToTerms_cg int NULL
               ,HFitUserPreferredEmail_cg int NULL
               ,HFitUserPreferredPhone_cg int NULL
               ,HFitUserPreferredFirstName_cg int NULL
               ,HFitUserPhoneExt_cg int NULL
               ,HFitComInboxNotifyByEmail_cg int NULL
               ,HFitComInboxNotifyByText_cg int NULL
               ,HFitComActivitiesNotifyEmail_cg int NULL
               ,HFitComActivitiesNotifyText_cg int NULL
               ,HFitComTipOfTheDayNotifyByEmail_cg int NULL
               ,HFitComTipOfTheDayNotifyByText_cg int NULL
               ,HFitComCoachingTrackingEmail_cg int NULL
               ,HFitComCoachingTrackingText_cg int NULL
               ,HfitUserPreferredMailingAddress_cg int NULL
               ,HfitUserPreferredMailingCity_cg int NULL
               ,HfitUserPreferredMailingState_cg int NULL
               ,HfitUserPreferredMailingPostalCode_cg int NULL
               ,HFitCoachingEnrollDate_cg int NULL
               ,HFitUserAltPreferredPhone_cg int NULL
               ,HFitUserAltPreferredPhoneType_cg int NULL
               ,HFitUserAltPreferredPhoneExt_cg int NULL
               ,HFitHealthVision_cg int NULL
               ,HFitCoachId_cg int NULL
               ,HFitUserTypeID_cg int NULL
               ,HFitCoachSystemLastActivity_cg int NULL
               ,HFitIsConditionManagement_cg int NULL
               ,HFitCoachSystemNextActivity_cg int NULL
               ,HFitCoachWebLastActivity_cg int NULL
               ,HFitUserPreferredCallTime_cg int NULL
               ,HFitCoachSession1Date_cg int NULL
               ,HFitCoachSystemCoachID_cg int NULL
               ,HFitUserPreferredMailingAddress2_cg int NULL
               ,HFitCoachingOptOutDate_cg int NULL
               ,HFitCoachingOptOutItemID_cg int NULL
               ,HFitComScreeningSchedulersEmail_cg int NULL
               ,HFitCoachingOptOutSentDate_cg int NULL
               ,HFitComScreeningSchedulersText_cg int NULL
               ,WellnessGoalGuid_cg int NULL
               ,UserSecurityQuestionGuid1_cg int NULL
               ,UserSecurityQuestionGuid2_cg int NULL
               ,UserSecurityQuestionGuid3_cg int NULL
               ,HFitUserRegistrationDate_cg int NULL
               ,HFitCoachingServiceLevel_cg int NULL
               ,HealthAdvisingEvaluationDate_cg int NULL
               ,HFitCallLogStatus_cg int NULL
               ,HFitCallLogStatusDate_cg int NULL
               ,HFitCoachingDeliveryMethod_cg int NULL
               ,HFitTrackerReminderDisplayed_cg int NULL
               ,HFitPrimaryContactID_cg int NULL
               ,HFitPrimaryContactGuid_cg int NULL
               ,HFitUserIsRegistered_cg int NULL
               ,UserDataComUser_cg int NULL
               ,UserDataComPassword_cg int NULL
               ,UserShowIntroductionTile_cg int NULL
               ,UserDashboardApplications_cg int NULL
               ,HFitForgotPasswordAttempts_cg int NULL
               ,HFitForgotPasswordStarted_cg int NULL
    ) 
    ON [PRIMARY];

    ALTER TABLE dbo.STAGING_CMS_UserSettings_Update_History
    ADD
                CONSTRAINT DF_STAGING_CMS_UserSettings_Update_History_CurrUser  DEFAULT USER_NAME () FOR CurrUser;
    ALTER TABLE dbo.STAGING_CMS_UserSettings_Update_History
    ADD
                CONSTRAINT DF_STAGING_CMS_UserSettings_Update_History_SysUser  DEFAULT SUSER_SNAME () FOR SysUser;
    ALTER TABLE dbo.STAGING_CMS_UserSettings_Update_History
    ADD
                CONSTRAINT DF_STAGING_CMS_UserSettings_Update_History_IPADDR  DEFAULT CONVERT (nvarchar (50) , CONNECTIONPROPERTY ('client_net_address')) FOR IPADDR;

    CREATE CLUSTERED INDEX PI_STAGING_CMS_UserSettings_Update_History ON dbo.STAGING_CMS_UserSettings_Update_History
    (
    UserSettingsID ASC,
    SVR ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

    --CREATE CLUSTERED INDEX [PI_STAGING_CMS_UserSettings_Update_History] ON [dbo].[STAGING_CMS_UserSettings_Update_History]
    --(
	   -- [UserSettingsid] ASC
    --)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

END;

GO
PRINT 'Executed create_table_STAGING_CMS_UserSettings.sql';
GO
EXEC proc_Create_Table_STAGING_CMS_UserSettings;
GO

--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_CMS_UserSettings_History.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_CMS_UserSettings_History') 
    BEGIN
        DROP PROCEDURE
             proc_CT_CMS_UserSettings_History;
    END;
GO

/*-------------------------------------------------------------------------
*************************************************************************

select tc.commit_time, *
from
    changetable(changes CMS_UserSettings, 0) c
    join sys.dm_tran_commit_table tc on c.sys_change_version = tc.commit_ts


exec proc_CT_CMS_UserSettings_History 'I'
exec proc_CT_CMS_UserSettings_History 'D'
exec proc_CT_CMS_UserSettings_History 'U'

truncate table STAGING_CMS_UserSettings_Update_History
select * from STAGING_CMS_UserSettings_Update_History

SELECT CHANGE_TRACKING_MIN_VALID_VERSION(OBJECT_ID('CMS_UserSettings'))
*************************************************************************
*/

CREATE PROCEDURE proc_CT_CMS_UserSettings_History (
     @Typesave AS nchar (1)) 
AS
BEGIN
    WITH CTE (
         UserSettingsID
       , SYS_CHANGE_VERSION
       , SYS_CHANGE_COLUMNS) 
        AS ( SELECT
                    CT.UserSettingsID
                  , CT.SYS_CHANGE_VERSION
                  , SYS_CHANGE_COLUMNS
                    FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT
                    WHERE SYS_CHANGE_OPERATION = 'U' --@Typesave
             EXCEPT
             SELECT
                    UserSettingsID
                  , SYS_CHANGE_VERSION
                  , SYS_CHANGE_COLUMNS
                    FROM STAGING_CMS_UserSettings_Update_History) 
        INSERT INTO STAGING_CMS_UserSettings_Update_History
        (
               UserSettingsid
             , SYS_CHANGE_VERSION
             , SYS_CHANGE_OPERATION
             , SYS_CHANGE_COLUMNS

               --, CurrUser 
               --, SysUser 
               --, IPADDR 

             , commit_time
             , LastModifiedDate
             , SVR
             , DBNAME
             , HealthAdvisingEvaluationDate_cg
             , HFitCallLogStatus_cg
             , HFitCallLogStatusDate_cg
             , HFitCoachId_cg
             , HFitCoachingDeliveryMethod_cg
             , HFitCoachingEnrollDate_cg
             , HFitCoachingOptOutDate_cg
             , HFitCoachingOptOutItemID_cg
             , HFitCoachingOptOutSentDate_cg
             , HFitCoachingServiceLevel_cg
             , HFitCoachSession1Date_cg
             , HFitCoachSystemCoachID_cg
             , HFitCoachSystemLastActivity_cg
             , HFitCoachSystemNextActivity_cg
             , HFitCoachWebLastActivity_cg
             , HFitComActivitiesNotifyEmail_cg
             , HFitComActivitiesNotifyText_cg
             , HFitComCoachingTrackingEmail_cg
             , HFitComCoachingTrackingText_cg
             , HFitComInboxNotifyByEmail_cg
             , HFitComInboxNotifyByText_cg
             , HFitComScreeningSchedulersEmail_cg
             , HFitComScreeningSchedulersText_cg
             , HFitComTipOfTheDayNotifyByEmail_cg
             , HFitComTipOfTheDayNotifyByText_cg
             , HFitHealthVision_cg
             , HFitIsConditionManagement_cg
             , HFitIsHraEnabled_cg
             , HFitIsIncentivesEnabled_cg
             , HFitIsPlatformEnabled_cg
             , HFitPrimaryContactGuid_cg
             , HFitPrimaryContactID_cg
             , HFitTrackerReminderDisplayed_cg
             , HFitUserAgreesToTerms_cg
             , HFitUserAltPreferredPhone_cg
             , HFitUserAltPreferredPhoneExt_cg
             , HFitUserAltPreferredPhoneType_cg
             , HFitUserIsRegistered_cg
             , HFitUserMobilePhone_cg
             , HFitUserMpiNumber_cg
             , HFitUserPhoneExt_cg
             , HFitUserPhoneType_cg
             , HFitUserPreferredCallTime_cg
             , HFitUserPreferredEmail_cg
             , HFitUserPreferredFirstName_cg
             , HfitUserPreferredMailingAddress_cg
             , HFitUserPreferredMailingAddress2_cg
             , HfitUserPreferredMailingCity_cg
             , HfitUserPreferredMailingPostalCode_cg
             , HfitUserPreferredMailingState_cg
             , HFitUserPreferredPhone_cg
             , HFitUserRegistrationDate_cg
             , HfitUserSsoId_cg
             , HFitUserTypeID_cg
             , SocialSecurity_cg
             , UserAccountLockReason_cg
             , UserActivatedByUserID_cg
             , UserActivationDate_cg
             , UserActivityPoints_cg
             , UserAuthenticationGUID_cg
             , UserAvatarID_cg
             , UserAvatarType_cg
             , UserBadgeID_cg
             , UserBlogComments_cg
             , UserBlogPosts_cg
             , UserBounces_cg
             , UserCampaign_cg
             , UserCustomData_cg
             , UserDashboardApplications_cg
             , UserDataComPassword_cg
             , UserDataComUser_cg
             , UserDateOfBirth_cg
             , UserDescription_cg
             , UserDialogsConfiguration_cg
             , UserFacebookID_cg
             , UserForumPosts_cg
             , UserGender_cg
             , UserIM_cg
             , UserInvalidLogOnAttempts_cg
             , UserInvalidLogOnAttemptsHash_cg
             , UserLinkedInID_cg
             , UserLogActivities_cg
             , UserMessageBoardPosts_cg
             , UserMessagingNotificationEmail_cg
             , UserNickName_cg
             , UserPasswordLastChanged_cg
             , UserPasswordRequestHash_cg
             , UserPhone_cg
             , UserPicture_cg
             , UserPosition_cg
             , UserPreferences_cg
             , UserRegistrationInfo_cg
             , UserSecurityQuestionAnswer1_cg
             , UserSecurityQuestionAnswer2_cg
             , UserSecurityQuestionAnswer3_cg
             , UserSecurityQuestionGuid1_cg
             , UserSecurityQuestionGuid2_cg
             , UserSecurityQuestionGuid3_cg
             , UserSettingsID_cg
             , UserSettingsUserGUID_cg
             , UserSettingsUserID_cg
             , UserShowIntroductionTile_cg
             , UserSignature_cg
             , UserSkype_cg
             , UserTimeZoneID_cg
             , UserURLReferrer_cg
             , UserUsedWebParts_cg
             , UserUsedWidgets_cg
             , UserWaitingForApproval_cg
             , WellnessGoalGuid_cg
             , WindowsLiveID_cg) 
        SELECT
               CTE.UserSettingsID
             , CTE.SYS_CHANGE_VERSION
             --, @Typesave AS SYS_CHANGE_OPERATION
		   , 'U' AS SYS_CHANGE_OPERATION
             , CTE.SYS_CHANGE_COLUMNS

               --, CurrUser
               --, SysUser
               --, IPADDR

             , ISNULL ( tc.commit_time , GETDATE ()) 
             , GETDATE () AS LastModifiedDate
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME

               --********************************************     

             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HealthAdvisingEvaluationDate' , 'columnid') , CTE.sys_change_columns) AS HealthAdvisingEvaluationDate_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCallLogStatus' , 'columnid') , CTE.sys_change_columns) AS HFitCallLogStatus_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCallLogStatusDate' , 'columnid') , CTE.sys_change_columns) AS HFitCallLogStatusDate_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachId' , 'columnid') , CTE.sys_change_columns) AS HFitCoachId_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachingDeliveryMethod' , 'columnid') , CTE.sys_change_columns) AS HFitCoachingDeliveryMethod_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachingEnrollDate' , 'columnid') , CTE.sys_change_columns) AS HFitCoachingEnrollDate_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachingOptOutDate' , 'columnid') , CTE.sys_change_columns) AS HFitCoachingOptOutDate_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachingOptOutItemID' , 'columnid') , CTE.sys_change_columns) AS HFitCoachingOptOutItemID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachingOptOutSentDate' , 'columnid') , CTE.sys_change_columns) AS HFitCoachingOptOutSentDate_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachingServiceLevel' , 'columnid') , CTE.sys_change_columns) AS HFitCoachingServiceLevel_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachSession1Date' , 'columnid') , CTE.sys_change_columns) AS HFitCoachSession1Date_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachSystemCoachID' , 'columnid') , CTE.sys_change_columns) AS HFitCoachSystemCoachID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachSystemLastActivity' , 'columnid') , CTE.sys_change_columns) AS HFitCoachSystemLastActivity_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachSystemNextActivity' , 'columnid') , CTE.sys_change_columns) AS HFitCoachSystemNextActivity_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitCoachWebLastActivity' , 'columnid') , CTE.sys_change_columns) AS HFitCoachWebLastActivity_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitComActivitiesNotifyEmail' , 'columnid') , CTE.sys_change_columns) AS HFitComActivitiesNotifyEmail_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitComActivitiesNotifyText' , 'columnid') , CTE.sys_change_columns) AS HFitComActivitiesNotifyText_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitComCoachingTrackingEmail' , 'columnid') , CTE.sys_change_columns) AS HFitComCoachingTrackingEmail_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitComCoachingTrackingText' , 'columnid') , CTE.sys_change_columns) AS HFitComCoachingTrackingText_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitComInboxNotifyByEmail' , 'columnid') , CTE.sys_change_columns) AS HFitComInboxNotifyByEmail_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitComInboxNotifyByText' , 'columnid') , CTE.sys_change_columns) AS HFitComInboxNotifyByText_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitComScreeningSchedulersEmail' , 'columnid') , CTE.sys_change_columns) AS HFitComScreeningSchedulersEmail_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitComScreeningSchedulersText' , 'columnid') , CTE.sys_change_columns) AS HFitComScreeningSchedulersText_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitComTipOfTheDayNotifyByEmail' , 'columnid') , CTE.sys_change_columns) AS HFitComTipOfTheDayNotifyByEmail_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitComTipOfTheDayNotifyByText' , 'columnid') , CTE.sys_change_columns) AS HFitComTipOfTheDayNotifyByText_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitHealthVision' , 'columnid') , CTE.sys_change_columns) AS HFitHealthVision_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitIsConditionManagement' , 'columnid') , CTE.sys_change_columns) AS HFitIsConditionManagement_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitIsHraEnabled' , 'columnid') , CTE.sys_change_columns) AS HFitIsHraEnabled_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitIsIncentivesEnabled' , 'columnid') , CTE.sys_change_columns) AS HFitIsIncentivesEnabled_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitIsPlatformEnabled' , 'columnid') , CTE.sys_change_columns) AS HFitIsPlatformEnabled_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitPrimaryContactGuid' , 'columnid') , CTE.sys_change_columns) AS HFitPrimaryContactGuid_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitPrimaryContactID' , 'columnid') , CTE.sys_change_columns) AS HFitPrimaryContactID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitTrackerReminderDisplayed' , 'columnid') , CTE.sys_change_columns) AS HFitTrackerReminderDisplayed_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserAgreesToTerms' , 'columnid') , CTE.sys_change_columns) AS HFitUserAgreesToTerms_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserAltPreferredPhone' , 'columnid') , CTE.sys_change_columns) AS HFitUserAltPreferredPhone_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserAltPreferredPhoneExt' , 'columnid') , CTE.sys_change_columns) AS HFitUserAltPreferredPhoneExt_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserAltPreferredPhoneType' , 'columnid') , CTE.sys_change_columns) AS HFitUserAltPreferredPhoneType_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserIsRegistered' , 'columnid') , CTE.sys_change_columns) AS HFitUserIsRegistered_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserMobilePhone' , 'columnid') , CTE.sys_change_columns) AS HFitUserMobilePhone_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserMpiNumber' , 'columnid') , CTE.sys_change_columns) AS HFitUserMpiNumber_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserPhoneExt' , 'columnid') , CTE.sys_change_columns) AS HFitUserPhoneExt_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserPhoneType' , 'columnid') , CTE.sys_change_columns) AS HFitUserPhoneType_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserPreferredCallTime' , 'columnid') , CTE.sys_change_columns) AS HFitUserPreferredCallTime_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserPreferredEmail' , 'columnid') , CTE.sys_change_columns) AS HFitUserPreferredEmail_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserPreferredFirstName' , 'columnid') , CTE.sys_change_columns) AS HFitUserPreferredFirstName_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HfitUserPreferredMailingAddress' , 'columnid') , CTE.sys_change_columns) AS HfitUserPreferredMailingAddress_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserPreferredMailingAddress2' , 'columnid') , CTE.sys_change_columns) AS HFitUserPreferredMailingAddress2_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HfitUserPreferredMailingCity' , 'columnid') , CTE.sys_change_columns) AS HfitUserPreferredMailingCity_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HfitUserPreferredMailingPostalCode' , 'columnid') , CTE.sys_change_columns) AS HfitUserPreferredMailingPostalCode_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HfitUserPreferredMailingState' , 'columnid') , CTE.sys_change_columns) AS HfitUserPreferredMailingState_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserPreferredPhone' , 'columnid') , CTE.sys_change_columns) AS HFitUserPreferredPhone_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserRegistrationDate' , 'columnid') , CTE.sys_change_columns) AS HFitUserRegistrationDate_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HfitUserSsoId' , 'columnid') , CTE.sys_change_columns) AS HfitUserSsoId_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'HFitUserTypeID' , 'columnid') , CTE.sys_change_columns) AS HFitUserTypeID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'SocialSecurity' , 'columnid') , CTE.sys_change_columns) AS SocialSecurity_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserAccountLockReason' , 'columnid') , CTE.sys_change_columns) AS UserAccountLockReason_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserActivatedByUserID' , 'columnid') , CTE.sys_change_columns) AS UserActivatedByUserID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserActivationDate' , 'columnid') , CTE.sys_change_columns) AS UserActivationDate_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserActivityPoints' , 'columnid') , CTE.sys_change_columns) AS UserActivityPoints_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserAuthenticationGUID' , 'columnid') , CTE.sys_change_columns) AS UserAuthenticationGUID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserAvatarID' , 'columnid') , CTE.sys_change_columns) AS UserAvatarID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserAvatarType' , 'columnid') , CTE.sys_change_columns) AS UserAvatarType_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserBadgeID' , 'columnid') , CTE.sys_change_columns) AS UserBadgeID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserBlogComments' , 'columnid') , CTE.sys_change_columns) AS UserBlogComments_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserBlogPosts' , 'columnid') , CTE.sys_change_columns) AS UserBlogPosts_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserBounces' , 'columnid') , CTE.sys_change_columns) AS UserBounces_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserCampaign' , 'columnid') , CTE.sys_change_columns) AS UserCampaign_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserCustomData' , 'columnid') , CTE.sys_change_columns) AS UserCustomData_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserDashboardApplications' , 'columnid') , CTE.sys_change_columns) AS UserDashboardApplications_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserDataComPassword' , 'columnid') , CTE.sys_change_columns) AS UserDataComPassword_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserDataComUser' , 'columnid') , CTE.sys_change_columns) AS UserDataComUser_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserDateOfBirth' , 'columnid') , CTE.sys_change_columns) AS UserDateOfBirth_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserDescription' , 'columnid') , CTE.sys_change_columns) AS UserDescription_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserDialogsConfiguration' , 'columnid') , CTE.sys_change_columns) AS UserDialogsConfiguration_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserFacebookID' , 'columnid') , CTE.sys_change_columns) AS UserFacebookID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserForumPosts' , 'columnid') , CTE.sys_change_columns) AS UserForumPosts_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserGender' , 'columnid') , CTE.sys_change_columns) AS UserGender_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserIM' , 'columnid') , CTE.sys_change_columns) AS UserIM_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserInvalidLogOnAttempts' , 'columnid') , CTE.sys_change_columns) AS UserInvalidLogOnAttempts_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserInvalidLogOnAttemptsHash' , 'columnid') , CTE.sys_change_columns) AS UserInvalidLogOnAttemptsHash_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserLinkedInID' , 'columnid') , CTE.sys_change_columns) AS UserLinkedInID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserLogActivities' , 'columnid') , CTE.sys_change_columns) AS UserLogActivities_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserMessageBoardPosts' , 'columnid') , CTE.sys_change_columns) AS UserMessageBoardPosts_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserMessagingNotificationEmail' , 'columnid') , CTE.sys_change_columns) AS UserMessagingNotificationEmail_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserNickName' , 'columnid') , CTE.sys_change_columns) AS UserNickName_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserPasswordLastChanged' , 'columnid') , CTE.sys_change_columns) AS UserPasswordLastChanged_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserPasswordRequestHash' , 'columnid') , CTE.sys_change_columns) AS UserPasswordRequestHash_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserPhone' , 'columnid') , CTE.sys_change_columns) AS UserPhone_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserPicture' , 'columnid') , CTE.sys_change_columns) AS UserPicture_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserPosition' , 'columnid') , CTE.sys_change_columns) AS UserPosition_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserPreferences' , 'columnid') , CTE.sys_change_columns) AS UserPreferences_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserRegistrationInfo' , 'columnid') , CTE.sys_change_columns) AS UserRegistrationInfo_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSecurityQuestionAnswer1' , 'columnid') , CTE.sys_change_columns) AS UserSecurityQuestionAnswer1_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSecurityQuestionAnswer2' , 'columnid') , CTE.sys_change_columns) AS UserSecurityQuestionAnswer2_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSecurityQuestionAnswer3' , 'columnid') , CTE.sys_change_columns) AS UserSecurityQuestionAnswer3_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSecurityQuestionGuid1' , 'columnid') , CTE.sys_change_columns) AS UserSecurityQuestionGuid1_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSecurityQuestionGuid2' , 'columnid') , CTE.sys_change_columns) AS UserSecurityQuestionGuid2_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSecurityQuestionGuid3' , 'columnid') , CTE.sys_change_columns) AS UserSecurityQuestionGuid3_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSettingsID' , 'columnid') , CTE.sys_change_columns) AS UserSettingsID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSettingsUserGUID' , 'columnid') , CTE.sys_change_columns) AS UserSettingsUserGUID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSettingsUserID' , 'columnid') , CTE.sys_change_columns) AS UserSettingsUserID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserShowIntroductionTile' , 'columnid') , CTE.sys_change_columns) AS UserShowIntroductionTile_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSignature' , 'columnid') , CTE.sys_change_columns) AS UserSignature_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserSkype' , 'columnid') , CTE.sys_change_columns) AS UserSkype_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserTimeZoneID' , 'columnid') , CTE.sys_change_columns) AS UserTimeZoneID_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserURLReferrer' , 'columnid') , CTE.sys_change_columns) AS UserURLReferrer_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserUsedWebParts' , 'columnid') , CTE.sys_change_columns) AS UserUsedWebParts_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserUsedWidgets' , 'columnid') , CTE.sys_change_columns) AS UserUsedWidgets_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'UserWaitingForApproval' , 'columnid') , CTE.sys_change_columns) AS UserWaitingForApproval_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'WellnessGoalGuid' , 'columnid') , CTE.sys_change_columns) AS WellnessGoalGuid_cg
             , change_tracking_is_column_in_mask ( COLUMNPROPERTY ( OBJECT_ID ( 'CMS_UserSettings') , 'WindowsLiveID' , 'columnid') , CTE.sys_change_columns) AS WindowsLiveID_cg

        --********************************************    				  

               FROM
                   CTE
                       JOIN sys.dm_tran_commit_table AS tc
                           ON CTE.sys_change_version = tc.commit_ts;
END;
GO
PRINT 'Executed proc_CT_CMS_UserSettings_History.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*
select top 100 * from CMS_UserSettings
update CMS_UserSettings set UserNickNAme = null where UserSettingsID in (select top 100 UserSettingsID from CMS_UserSettings order by UserSettingsID desc) and UserNickName is null
*/

GO
-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'creating proc_STAGING_EDW_CMS_UserSettings';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_STAGING_EDW_CMS_UserSettings') 
    BEGIN
        PRINT 'UPDATING proc_STAGING_EDW_CMS_UserSettings';
        DROP PROCEDURE
             proc_STAGING_EDW_CMS_UserSettings;
    END;

GO

-- exec proc_STAGING_EDW_CMS_UserSettings

CREATE PROCEDURE proc_STAGING_EDW_CMS_UserSettings (
     @ReloadAll AS int = 0) 
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'STAGING_CMS_UserSettings';

    IF @iTotal <= 1
        BEGIN
            SET @Reloadall = 1;
        END;

    --******************************************************************************************************************************
    -- This procedure is added to the job job_EDW_GetStagingData_RewardUserDetail and set to run automatically on a schedule.
    --******************************************************************************************************************************

    BEGIN

        IF @ReloadAll IS NULL
            BEGIN
                SET @ReloadAll = 0;
            END;

        DECLARE
        @RecordID AS uniqueidentifier = NEWID () ;
        DECLARE
        @CT_DateTimeNow AS datetime = GETDATE () ;
        DECLARE
        @CT_NAME AS nvarchar ( 50) = 'proc_STAGING_EDW_CMS_UserSettings';
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'I';

        IF @ReloadAll = 1
            BEGIN
                PRINT 'RELOADING ALL Change Tracking CMS_UserSettings records';
                EXEC proc_Create_Table_STAGING_CMS_UserSettings ;
                PRINT 'RELOAD COMPLETE';
            END;
        ELSE
            BEGIN
                EXEC proc_CT_CMS_UserSettings_AddNewRecs ;
                EXEC proc_CT_CMS_UserSettings_AddUpdatedRecs ;
                EXEC proc_CMS_UserSettings_AddDeletedRecs ;
            END;

    END;
END;

GO
PRINT 'CREATED proc_STAGING_EDW_CMS_UserSettings';
PRINT GETDATE () ;
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing TRIG_CMS_UserSettings_Audit.SQL';
GO
-- select count(*) from STAGING_CMS_UserSettings_Audit
-- select * from STAGING_CMS_UserSettings_Audit
-- truncate table STAGING_CMS_UserSettings_Audit

IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'STAGING_CMS_UserSettings_Audit') 
    BEGIN
        DROP TABLE
             STAGING_CMS_UserSettings_Audit;
    END;
GO

-- select * from [STAGING_CMS_UserSettings_Audit]
CREATE TABLE dbo.STAGING_CMS_UserSettings_Audit (
             UserSettingsID int NOT NULL
           ,SVR nvarchar (100) NOT NULL
           ,DBNAME nvarchar (100) NOT NULL
           ,SYS_CHANGE_VERSION int NULL
           ,SYS_CHANGE_OPERATION nvarchar (10) NULL
           ,SchemaName nvarchar (100) NULL
           ,SysUser nvarchar (100) NULL
           ,IPADDR nvarchar (50) NULL
           ,Processed int NULL
           ,TBL nvarchar (100) NULL
           ,CreateDate datetime NULL
	   ,commit_time datetime NULL
) 
ON [PRIMARY];

GO

ALTER TABLE dbo.STAGING_CMS_UserSettings_Audit
ADD
            CONSTRAINT DF_STAGING_CMS_UserSettings_Audit_CreateDate  DEFAULT GETDATE () FOR CreateDate;
GO

GO
CREATE CLUSTERED INDEX PK_CMS_UserSettings_Audit ON dbo.STAGING_CMS_UserSettings_Audit
(
UserSettingsID ASC,
SVR ASC,
SYS_CHANGE_VERSION ASC,
SYS_CHANGE_OPERATION ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
GO

/*-------------------------------------------------------------------------------------------------------------------------------------------------------------
-- TROUBLESHOOTING AND TESTING QRYS
	select count(*) from CMS_UserSettings where UserSettingsID = 53 and SiteID = 36
	INSERT INTO CMS_UserSettings (UserSettingsID, SiteID) VALUES (53, 36) ;
	delete from CMS_UserSettings where UserSettingsID = 53 and SiteID = 36
	select top 1000 * from CMS_UserSettings
	select top 1000 * from CMS_UserSettings
	update CMS_UserSettings set UserNickName = UserNickName where UserSettingsID in (Select top 100 UserSettingsID from CMS_UserSettings order by UserSettingsID )
	select * from STAGING_CMS_UserSettings_Audit
	truncate table  STAGING_CMS_UserSettings_Audit
*/

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_INS_CMS_UserSettings_Audit') 
    BEGIN
        DROP TRIGGER
             trig_INS_CMS_UserSettings_Audit;
    END;
GO

CREATE TRIGGER trig_INS_CMS_UserSettings_Audit ON CMS_UserSettings
    AFTER INSERT
AS
BEGIN

    DECLARE @svr nvarchar (100) = (SELECT
                                          @@SERVERNAME);
    DECLARE @db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CHG_VER int = (SELECT
                                   MAX (CT.SYS_CHANGE_VERSION) 
                                   FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT);
    DECLARE @ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)) );
    DECLARE @UserSettingsID nvarchar (50) = (SELECT
                                                    USER_NAME () );
    DECLARE @sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);

    IF @CHG_VER IS NULL
        BEGIN
            SET @CHG_VER = 1;
        END;

    SET @CHG_VER = @CHG_VER - 1;
    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES CMS_UserSettings, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);

    INSERT INTO STAGING_CMS_UserSettings_Audit
    (
           UserSettingsID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL
    , commit_time
    ) 
    SELECT
           UserSettingsID
         , @svr
         , @db
         , @CHG_VER
         , 'I'
         , @UserSettingsID
         , @sysuser
         , @ipaddr
         , 0 AS Processed
         , 'CMS_UserSettings'
     , @Commit_Time
           FROM Inserted;
END;

GO

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_UPDT_CMS_UserSettings_Audit') 
    BEGIN
        DROP TRIGGER
             trig_UPDT_CMS_UserSettings_Audit;
    END;
GO

CREATE TRIGGER trig_UPDT_CMS_UserSettings_Audit ON CMS_UserSettings
    AFTER UPDATE
AS
BEGIN

    DECLARE @svr nvarchar (100) = (SELECT
                                          @@SERVERNAME);
    DECLARE @db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CHG_VER int = (SELECT
                                   MAX (CT.SYS_CHANGE_VERSION) 
                                   FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT);
    DECLARE @ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)) );
    DECLARE @UserSettingsID nvarchar (50) = (SELECT
                                                    USER_NAME () );
    DECLARE @sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);
    IF @CHG_VER IS NULL
        BEGIN
            SET @CHG_VER = 1;
        END;

    SET @CHG_VER = @CHG_VER - 1;
    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES CMS_UserSettings, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);
    INSERT INTO STAGING_CMS_UserSettings_Audit
    (
           UserSettingsID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL, commit_time
    ) 
    SELECT
           UserSettingsID
         , @svr
         , @db
         , @CHG_VER
         , 'U'
         , @UserSettingsID
         , @sysuser
         , @ipaddr
         , 0 AS Processed
         , 'CMS_UserSettings' , @Commit_Time
           FROM Inserted;
END;

GO

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_DEL_CMS_UserSettings_Audit') 
    BEGIN
        DROP TRIGGER
             trig_DEL_CMS_UserSettings_Audit;
    END;
GO

CREATE TRIGGER trig_DEL_CMS_UserSettings_Audit ON CMS_UserSettings
    AFTER DELETE
AS
BEGIN

    DECLARE @svr nvarchar (100) = (SELECT
                                          @@SERVERNAME);
    DECLARE @db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CHG_VER int = (SELECT
                                   MAX (CT.SYS_CHANGE_VERSION) 
                                   FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT);
    DECLARE @ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)) );
    DECLARE @UserSettingsID nvarchar (50) = (SELECT
                                                    USER_NAME () );
    DECLARE @sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);
    IF @CHG_VER IS NULL
        BEGIN
            SET @CHG_VER = 1;
        END;

    SET @CHG_VER = @CHG_VER - 1;
    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES CMS_UserSettings, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);
    INSERT INTO STAGING_CMS_UserSettings_Audit
    (
           UserSettingsID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL , commit_time
    ) 
    SELECT
           UserSettingsID
         , @svr
         , @db
         , @CHG_VER
         , 'D'
         , @UserSettingsID
         , @sysuser
         , @ipaddr
         , 0 AS Processed
         , 'CMS_UserSettings' , @Commit_Time
           FROM DELETED;
END;

GO
PRINT 'EXECUTED TRIG_CMS_UserSettings_Audit.SQL';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'EXECUTING view_AUDIT_CMS_UserSettings.SQL';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE name = 'view_AUDIT_CMS_UserSettings') 
    BEGIN
        DROP VIEW
             view_AUDIT_CMS_UserSettings
    END;

GO

/*---------------------------------------------------
select * from STAGING_CMS_UserSettings
select * from STAGING_CMS_UserSettings_Update_History
select * from STAGING_CMS_UserSettings_Audit
*/
-- select * from view_AUDIT_CMS_UserSettings order by UserSettingsID
CREATE VIEW view_AUDIT_CMS_UserSettings
AS 
    SELECT DISTINCT
          A.SysUser
        , A.IPADDR
        , A.CreateDate
        , A.SYS_CHANGE_OPERATION
        , A.SYS_CHANGE_VERSION AS SysChangeVersion
        , S.*
          FROM
              STAGING_CMS_UserSettings_Audit AS A
                  JOIN STAGING_CMS_UserSettings AS S
                      ON S.UserSettingsID = A.UserSettingsID;

GO
PRINT 'EXECUTED view_AUDIT_CMS_UserSettings.SQL';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating JOB job_EDW_GetStagingData_CMS_UserSettings';
GO

BEGIN TRANSACTION;
DECLARE
@ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS ( SELECT
                       name
                       FROM msdb.dbo.syscategories
                       WHERE
                       name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB' , @type = N'LOCAL' , @name = N'[Uncategorized (Local)]';
        IF
        @@ERROR <> 0
     OR @ReturnCode <> 0
            BEGIN
                GOTO QuitWithRollback;
            END;

    END;

DECLARE
@TGTDB AS nvarchar ( 50) = DB_NAME () ;

DECLARE
@JNAME AS nvarchar ( 100) = 'job_EDW_GetStagingData_CMS_UserSettings_' + @TGTDB;

IF EXISTS ( SELECT
                   job_id
                   FROM msdb.dbo.sysjobs_view
                   WHERE name = @JNAME) 
    BEGIN EXEC msdb.dbo.sp_delete_job @job_name = @JNAME , @delete_unused_schedule = 1;
    END;

DECLARE
@jobId binary ( 16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME , @enabled = 1 , @notify_level_eventlog = 2 , @notify_level_email = 2 , @notify_level_netsend = 0 , @notify_level_page = 0 , @delete_level = 0 , @description = N'No description available.' , @category_name = N'[Uncategorized (Local)]' , @owner_login_name = N'sa' , @notify_email_operator_name = N'DBA_Notify' , @job_id = @jobId OUTPUT;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;

/*---------------------------------------------------------------------------------------
***** Object:  Step [Load_STAGING_EDW_CMS_UserSettings]    Script Date: 4/12/2015 9:59:37 AM *****
*/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId , @step_name = N'Load_STAGING_EDW_CMS_UserSettings' , @step_id = 1 , @cmdexec_success_code = 0 , @on_success_action = 1 , @on_success_step_id = 0 , @on_fail_action = 2 , @on_fail_step_id = 0 , @retry_attempts = 0 , @retry_interval = 0 , @os_run_priority = 0 , @subsystem = N'TSQL' , @command = N'exec proc_STAGING_EDW_CMS_UserSettings;' , @database_name = @TGTDB , @flags = 0;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId , @start_step_id = 1;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId , @name = N'Schedule_STAGING_EDW_CMS_UserSettings' , @enabled = 1 , @freq_type = 4 , @freq_interval = 1 , @freq_subday_type = 8 , @freq_subday_interval = 8 , @freq_relative_interval = 0 , @freq_recurrence_factor = 0 , @active_start_date = 20150412 , @active_end_date = 99991231 , @active_start_time = 10000 ,
@active_end_time = 235959;
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId , @server_name = N'(local)';
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN
        ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*------------------------
cms_user			    -> DONE
cms_usersettings	  -> DONE
CMS_UserSite	  -> DONE
hfit_ppteligibility
cms_usercontact
*/
GO
PRINT 'Executing create_table_STAGING_CMS_UserSite.sql';
GO

IF NOT EXISTS (SELECT
                      sys.tables.name AS Table_name
                      FROM
                          sys.change_tracking_tables
                              JOIN sys.tables
                                  ON sys.tables.object_id = sys.change_tracking_tables.object_id
                              JOIN sys.schemas
                                  ON sys.schemas.schema_id = sys.tables.schema_id
                      WHERE sys.tables.name = 'CMS_UserSite') 
    BEGIN
        PRINT 'ADDING Change Tracking to CMS_UserSite';
        ALTER TABLE dbo.CMS_UserSite
            ENABLE CHANGE_TRACKING
                WITH (TRACK_COLUMNS_UPDATED = ON) ;
    END;
ELSE
    BEGIN
        PRINT 'Change Tracking exists on CMS_UserSite';
    END;
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Create_Table_STAGING_CMS_UserSite') 
    BEGIN
        DROP PROCEDURE
             proc_Create_Table_STAGING_CMS_UserSite;
    END;
GO
-- exec proc_Create_Table_STAGING_CMS_UserSite
-- select top 100 * from [STAGING_CMS_UserSite]
CREATE PROCEDURE proc_Create_Table_STAGING_CMS_UserSite
AS
BEGIN

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_CMS_UserSite') 
        BEGIN
            DROP TABLE
                 dbo.STAGING_CMS_UserSite;
        END;

    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;

    CREATE TABLE dbo.STAGING_CMS_UserSite (
                 UserSiteID int NOT NULL
               , UserID int NOT NULL
               , SiteID int NOT NULL
               , UserPreferredCurrencyID int NULL
               , UserPreferredShippingOptionID int NULL
               , UserPreferredPaymentOptionID int NULL

               , LastModifiedDate datetime NULL
               , RowNbr int NULL
               , DeletedFlg bit NULL
               , TimeZone nvarchar (10) NULL
               , ConvertedToCentralTime bit NULL
               , SVR nvarchar (100) NOT NULL
               , DBNAME nvarchar (100) NOT NULL
               , SYS_CHANGE_VERSION int NULL
    ) 
    ON [PRIMARY];

    ALTER TABLE dbo.STAGING_CMS_UserSite
    ADD
                DEFAULT @@servername FOR SVR;
    ALTER TABLE dbo.STAGING_CMS_UserSite
    ADD
                DEFAULT DB_NAME () FOR DBNAME;

    CREATE CLUSTERED INDEX PI_STAGING_CMS_UserSite ON dbo.STAGING_CMS_UserSite
    (
    UserSiteID ASC,
    SVR ASC,
    DBNAME ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

    --SET IDENTITY_INSERT STAGING_CMS_UserSite ON;

    INSERT INTO STAGING_CMS_UserSite
    (
           UserSiteID
         , UserID
         , SiteID
         , UserPreferredCurrencyID
         , UserPreferredShippingOptionID
         , UserPreferredPaymentOptionID) 
    SELECT
           UserSiteID
         , UserID
         , SiteID
         , UserPreferredCurrencyID
         , UserPreferredShippingOptionID
         , UserPreferredPaymentOptionID
           FROM CMS_UserSite;

    --SET IDENTITY_INSERT STAGING_CMS_UserSite OFF;

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_CMS_UserSite_Update_History') 
        BEGIN
            DROP TABLE
                 STAGING_CMS_UserSite_Update_History;
        END;

    -- select * from STAGING_CMS_UserSite_Update_History
   
CREATE TABLE [dbo].[STAGING_CMS_UserSite_Update_History](
	[UserSiteid] [int] NOT NULL,
	[SYS_CHANGE_VERSION] [bigint] NULL,
	[SYS_CHANGE_OPERATION] [nchar](1) NULL,
	[SYS_CHANGE_COLUMNS] [varbinary](4100) NULL,
	[CurrUser] [varchar](60) NOT NULL,
	[SysUser] [varchar](60) NOT NULL,
	[IPADDR] [varchar](60) NOT NULL,
	[commit_time] [datetime] NOT NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[SVR] [nvarchar](128) NULL,
	[DBNAME] [nvarchar](128) NULL,
	[UserSiteID_cg] [int] NULL,
	[UserID_cg] [int] NULL,
	[SiteID_cg] [int] NULL,
	[UserPreferredCurrencyID_cg] [int] NULL,
	[UserPreferredShippingOptionID_cg] [int] NULL,
	[UserPreferredPaymentOptionID_cg] [int] NULL
) ON [PRIMARY]

ALTER TABLE [dbo].[STAGING_CMS_UserSite_Update_History] ADD  CONSTRAINT [DF_STAGING_CMS_UserSite_Update_History_CurrUser]  DEFAULT (user_name()) FOR [CurrUser]
ALTER TABLE [dbo].[STAGING_CMS_UserSite_Update_History] ADD  CONSTRAINT [DF_STAGING_CMS_UserSite_Update_History_SysUser]  DEFAULT (suser_sname()) FOR [SysUser]
ALTER TABLE [dbo].[STAGING_CMS_UserSite_Update_History] ADD  CONSTRAINT [DF_STAGING_CMS_UserSite_Update_History_IPADDR]  DEFAULT (CONVERT([nvarchar](50),connectionproperty('client_net_address'))) FOR [IPADDR]


    CREATE CLUSTERED INDEX PI_STAGING_CMS_UserSite_Update_History ON dbo.STAGING_CMS_UserSite_Update_History
    (
    UserSiteID ASC,
    SVR ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];


END;

GO
PRINT 'Executed create_table_STAGING_CMS_UserSite.sql';
GO
-- select * from STAGING_CMS_UserSite_Update_History
EXEC proc_Create_Table_STAGING_CMS_UserSite;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
select top 100 * from CMS_UserSite
update CMS_UserSite set UserNickNAme = null where UserSettingsID in (select top 100 UserSettingsID from CMS_UserSite order by UserSettingsID desc) and UserNickName is null
*/

GO
-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'creating proc_STAGING_EDW_CMS_UserSite';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_STAGING_EDW_CMS_UserSite') 
    BEGIN
        PRINT 'UPDATING proc_STAGING_EDW_CMS_UserSite';
        DROP PROCEDURE
             proc_STAGING_EDW_CMS_UserSite;
    END;

GO

-- exec proc_STAGING_EDW_CMS_UserSite

CREATE PROCEDURE proc_STAGING_EDW_CMS_UserSite (
     @ReloadAll AS int = 0) 
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'STAGING_CMS_UserSite';

    IF @iTotal <= 1
        BEGIN
            SET @Reloadall = 1;
        END;

    BEGIN

        IF @ReloadAll IS NULL
            BEGIN
                SET @ReloadAll = 0;
            END;

        DECLARE
        @RecordID AS uniqueidentifier = NEWID () ;
        DECLARE
        @CT_DateTimeNow AS datetime = GETDATE () ;
        DECLARE
        @CT_NAME AS nvarchar ( 50) = 'proc_STAGING_EDW_CMS_UserSite';
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'I';

        IF @ReloadAll = 1
            BEGIN
                PRINT 'RELOADING ALL Change Tracking CMS_UserSite records';
                EXEC proc_Create_Table_STAGING_CMS_UserSite ;
                PRINT 'RELOAD COMPLETE';
            END;
        ELSE
            BEGIN
                EXEC proc_CT_CMS_UserSite_AddNewRecs ;
                EXEC proc_CT_CMS_UserSite_AddUpdatedRecs ;
                EXEC proc_CMS_UserSite_AddDeletedRecs ;
            END;

    END;
END;

GO
PRINT 'CREATED proc_STAGING_EDW_CMS_UserSite';
PRINT GETDATE () ;
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_CMS_UserSite_History.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_CMS_UserSite_History') 
    BEGIN
        DROP PROCEDURE
             proc_CT_CMS_UserSite_History;
    END;
GO

/*-------------------------------------------------------------------------
*************************************************************************

select tc.commit_time, *
from
    changetable(changes CMS_UserSite, 0) c
    join sys.dm_tran_commit_table tc on c.sys_change_version = tc.commit_ts


exec proc_CT_CMS_UserSite_History 'I'
exec proc_CT_CMS_UserSite_History 'D'
exec proc_CT_CMS_UserSite_History 'U'

truncate table STAGING_CMS_UserSite_Update_History
select * from STAGING_CMS_UserSite_Update_History

SELECT CHANGE_TRACKING_MIN_VALID_VERSION(OBJECT_ID('CMS_UserSite'))

SELECT * FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CT WHERE SYS_CHANGE_OPERATION = 'U'
SELECT * FROM STAGING_CMS_UserSite_Update_History
*************************************************************************
*/


CREATE PROCEDURE proc_CT_CMS_UserSite_History (
     @Typesave AS nchar (1)) 
AS
BEGIN
    WITH CTE (
         UserSiteID
       , SYS_CHANGE_VERSION
       , SYS_CHANGE_COLUMNS) 
        AS (SELECT
                   CT.UserSiteID
                 , CT.SYS_CHANGE_VERSION
                 , SYS_CHANGE_COLUMNS
                   FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CT
                   WHERE SYS_CHANGE_OPERATION = @Typesave
            EXCEPT
            SELECT
                   UserSiteID
                 , SYS_CHANGE_VERSION
                 , SYS_CHANGE_COLUMNS
                   FROM STAGING_CMS_UserSite_Update_History) 
        INSERT INTO STAGING_CMS_UserSite_Update_History
        (
		  UserSiteid
		  , SYS_CHANGE_VERSION 
		  , SYS_CHANGE_OPERATION 
		  , SYS_CHANGE_COLUMNS 
		  --, CurrUser 
		  --, SysUser 
		  --, IPADDR 
		  , commit_time 
		  , LastModifiedDate 
		  , SVR 
		  , DBNAME 
		  , UserSiteID_cg 
		  , UserID_cg 
		  , SiteID_cg 
		  , UserPreferredCurrencyID_cg 
		  , UserPreferredShippingOptionID_cg 
		  , UserPreferredPaymentOptionID_cg ) 
        SELECT
               CTE.UserSiteID
             , CTE.SYS_CHANGE_VERSION
             , @Typesave as SYS_CHANGE_OPERATION
             , CTE.SYS_CHANGE_COLUMNS
             --, CurrUser
             --, SysUser
             --, IPADDR
             , tc.commit_time
             , GETDATE () AS LastModifiedDate
             , @@Servername AS SVR
             , DB_NAME () AS DBNAME
               --********************************************     
			 , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'SiteID', 'columnid') , CTE.sys_change_columns) AS [SiteID_cg] 
			 , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'UserID', 'columnid') , CTE.sys_change_columns) AS [UserID_cg] 
			 , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'UserPreferredCurrencyID', 'columnid') , CTE.sys_change_columns) AS [UserPreferredCurrencyID_cg] 
			 , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'UserPreferredPaymentOptionID', 'columnid') , CTE.sys_change_columns) AS [UserPreferredPaymentOptionID_cg] 
			 , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'UserPreferredShippingOptionID', 'columnid') , CTE.sys_change_columns) AS [UserPreferredShippingOptionID_cg] 
			 , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('CMS_UserSite') , 'UserSiteID', 'columnid') , CTE.sys_change_columns) AS [UserSiteID_cg] 

        --********************************************    				  
               FROM
                   CTE
                       JOIN sys.dm_tran_commit_table AS tc
                           ON CTE.sys_change_version = tc.commit_ts;

END;

GO
PRINT 'Executed proc_CT_CMS_UserSite_History.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing proc_CMS_UserSite_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CMS_UserSite_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CMS_UserSite_AddDeletedRecs;
    END;
GO
CREATE PROCEDURE proc_CMS_UserSite_AddDeletedRecs
AS
BEGIN

    UPDATE STAGING_CMS_UserSite
           SET
               DeletedFlg = 1
             ,LastModifiedDate = GETDATE () 
    WHERE
          UserSiteID IN
          (SELECT
                  UserSiteID
                  FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CT
                  WHERE SYS_CHANGE_OPERATION = 'D') 
      AND DeletedFlg IS NULL;

    DECLARE
    @iCnt AS int = @@ROWCOUNT;
    PRINT 'Deleted Count: ' + CAST ( @iCnt AS nvarchar (50)) ;

    if @iCnt > 0
	   exec proc_CT_CMS_UserSite_History 'D' ;
    
    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CMS_UserSite_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- USe KenticoCMS_Prod1

PRINT 'Executing proc_CT_CMS_UserSite_AddNewRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_CMS_UserSite_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_CMS_UserSite_AddNewRecs;
    END;
GO
-- exec proc_CT_CMS_UserSite_AddNewRecs
CREATE PROCEDURE proc_CT_CMS_UserSite_AddNewRecs
AS
BEGIN

    -- SET IDENTITY_INSERT STAGING_CMS_UserSite ON;
 
    WITH CTE (
         UserSiteID
       ) 
        AS ( SELECT
                    UserSiteID
                    FROM CMS_UserSite
             EXCEPT
             SELECT
                    UserSiteID
                    FROM STAGING_CMS_UserSite
                    WHERE DeletedFlg IS NULL) 
        INSERT INTO STAGING_CMS_UserSite
        (
               UserSiteID
             , UserID
             , SiteID
             , UserPreferredCurrencyID
             , UserPreferredShippingOptionID
             , UserPreferredPaymentOptionID

             , LastModifiedDate
               --,[RowNbr]
             , DeletedFlg
             , TimeZone
             , ConvertedToCentralTime
             , SVR
             , DBNAME
             , SYS_CHANGE_VERSION) 
        SELECT
               T.UserSiteID
             , T.UserID
             , T.SiteID
             , T.UserPreferredCurrencyID
             , T.UserPreferredShippingOptionID
             , T.UserPreferredPaymentOptionID

             , GETDATE () AS LastModifiedDate
             , NULL AS DeletedFlg
             , NULL AS TimeZone
             , NULL AS ConvertedToCentralTime
             , @@SERVERNAME AS SVR
             , DB_NAME () AS DBNAME
             , null as SYS_CHANGE_VERSION
               FROM
                   CMS_UserSite AS T
                       JOIN CTE AS S
                           ON S.UserSiteID = T.UserSiteID;
    DECLARE
    @iInserts AS int = @@ROWCOUNT;
    --SET IDENTITY_INSERT STAGING_CMS_UserSite OFF;
    PRINT 'NEW Insert Count: ' + CAST ( @iInserts AS nvarchar (50)) ;

    if @iInserts > 0
	   exec proc_CT_CMS_UserSite_History 'I';

    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_CMS_UserSite_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_CMS_UserSite_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_CMS_UserSite_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_CMS_UserSite_AddUpdatedRecs;
    END;
GO
/*--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
select * from COM_Currency
select top 1000 * from CMS_UserSite

update CMS_UserSite set UserPreferredCurrencyID = NULL where UserSiteID in (select top 50 UserSiteID from CMS_UserSite order by UserSiteID ) and UserPreferredCurrencyID is null

 exec proc_CT_CMS_UserSite_AddUpdatedRecs
 select * from STAGING_CMS_UserSite where SYS_CHANGE_VERSION is not null
*/

CREATE PROCEDURE proc_CT_CMS_UserSite_AddUpdatedRecs
AS
BEGIN
    WITH CTE (
         UserSiteID
       , SYS_CHANGE_VERSION
       , SYS_CHANGE_OPERATION
       , SYS_CHANGE_COLUMNS) 
        AS ( SELECT
                    CT.UserSiteID
                  , CT.SYS_CHANGE_VERSION
                  , CT.SYS_CHANGE_OPERATION
                  , SYS_CHANGE_COLUMNS
                    FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CT
                    WHERE SYS_CHANGE_OPERATION = 'U') 
        UPDATE S
               SET
                   S.UserSiteID = T.UserSiteID
                 ,S.UserID = T.UserID
                 ,S.SiteID = T.SiteID
                 ,S.UserPreferredCurrencyID = T.UserPreferredCurrencyID
                 ,S.UserPreferredShippingOptionID = T.UserPreferredShippingOptionID
                 ,S.UserPreferredPaymentOptionID = T.UserPreferredPaymentOptionID

                 ,S.LastModifiedDate = GETDATE () 
                 ,S.DeletedFlg = NULL
                 ,S.ConvertedToCentralTime = NULL
                 ,S.SYS_CHANGE_VERSION = CTE.SYS_CHANGE_VERSION
                   FROM STAGING_CMS_UserSite AS S
                            JOIN
                            CMS_UserSite AS T
                                ON
                                S.UserSiteID = T.UserSiteID
                            AND S.DeletedFlg IS NULL
                            JOIN CTE
                                ON CTE.UserSiteID = T.UserSiteID
                               AND (CTE.SYS_CHANGE_VERSION != S.SYS_CHANGE_VERSION
                                 OR S.SYS_CHANGE_VERSION IS NULL);

    DECLARE
    @iCnt AS int = @@ROWCOUNT;
    PRINT 'Updated Count: ' + CAST ( @iCnt AS nvarchar (50)) ;

    exec proc_CT_CMS_UserSite_History 'U';

    --WITH CTE (
    --     UserSiteID
    --   , SYS_CHANGE_VERSION
    --   , SYS_CHANGE_COLUMNS) 
    --    AS ( SELECT
    --                CT.UserSiteID
    --              , CT.SYS_CHANGE_VERSION
    --              , SYS_CHANGE_COLUMNS
    --                FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CT
    --                WHERE SYS_CHANGE_OPERATION = 'U'
    --         EXCEPT
    --         SELECT
    --                UserSiteID
    --              , SYS_CHANGE_VERSION
    --              , SYS_CHANGE_COLUMNS
    --                FROM STAGING_CMS_UserSite_Update_History
    --    ) 
    --    INSERT INTO STAGING_CMS_UserSite_Update_History
    --    (
    --           UserSiteID
    --         , LastModifiedDate
    --         , SVR
    --         , DBNAME
    --         , SYS_CHANGE_VERSION
    --         , SYS_CHANGE_COLUMNS
    --         , commit_time) 
    --    SELECT
    --           CTE.UserSiteID
    --         , GETDATE () AS LastModifiedDate
    --         , @@SERVERNAME AS SVR
    --         , DB_NAME () AS DBNAME
    --         , CTE.SYS_CHANGE_VERSION
    --         , CTE.SYS_CHANGE_COLUMNS
    --         , tc.commit_time
    --           FROM
    --               CTE
    --                   JOIN sys.dm_tran_commit_table AS tc
    --                       ON CTE.sys_change_version = tc.commit_ts;

    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CT_CMS_UserSite_AddUpdatedRecs.sql';
GO
 --**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





/*------------------------
cms_user			    -> DONE
cms_usersettings	  -> DONE
CMS_UserSite	  -> DONE
hfit_ppteligibility
cms_usercontact
*/
GO
PRINT 'Executing create_table_STAGING_CMS_UserSite.sql';
GO

IF NOT EXISTS (SELECT
                      sys.tables.name AS Table_name
                      FROM
                          sys.change_tracking_tables
                              JOIN sys.tables
                                  ON sys.tables.object_id = sys.change_tracking_tables.object_id
                              JOIN sys.schemas
                                  ON sys.schemas.schema_id = sys.tables.schema_id
                      WHERE sys.tables.name = 'CMS_UserSite') 
    BEGIN
        PRINT 'ADDING Change Tracking to CMS_UserSite';
        ALTER TABLE dbo.CMS_UserSite
            ENABLE CHANGE_TRACKING
                WITH (TRACK_COLUMNS_UPDATED = ON) ;
    END;
ELSE
    BEGIN
        PRINT 'Change Tracking exists on CMS_UserSite';
    END;
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Create_Table_STAGING_CMS_UserSite') 
    BEGIN
        DROP PROCEDURE
             proc_Create_Table_STAGING_CMS_UserSite;
    END;
GO
-- exec proc_Create_Table_STAGING_CMS_UserSite
-- select top 100 * from [STAGING_CMS_UserSite]
CREATE PROCEDURE proc_Create_Table_STAGING_CMS_UserSite
AS
BEGIN

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_CMS_UserSite') 
        BEGIN
            DROP TABLE
                 dbo.STAGING_CMS_UserSite;
        END;

    SET ANSI_NULLS ON;
    SET QUOTED_IDENTIFIER ON;

    CREATE TABLE dbo.STAGING_CMS_UserSite (
                 UserSiteID int NOT NULL
               , UserID int NOT NULL
               , SiteID int NOT NULL
               , UserPreferredCurrencyID int NULL
               , UserPreferredShippingOptionID int NULL
               , UserPreferredPaymentOptionID int NULL

               , LastModifiedDate datetime NULL
               , RowNbr int NULL
               , DeletedFlg bit NULL
               , TimeZone nvarchar (10) NULL
               , ConvertedToCentralTime bit NULL
               , SVR nvarchar (100) NOT NULL
               , DBNAME nvarchar (100) NOT NULL
               , SYS_CHANGE_VERSION int NULL
    ) 
    ON [PRIMARY];

    ALTER TABLE dbo.STAGING_CMS_UserSite
    ADD
                DEFAULT @@servername FOR SVR;
    ALTER TABLE dbo.STAGING_CMS_UserSite
    ADD
                DEFAULT DB_NAME () FOR DBNAME;

    CREATE CLUSTERED INDEX PI_STAGING_CMS_UserSite ON dbo.STAGING_CMS_UserSite
    (
    UserSiteID ASC,
    SVR ASC,
    DBNAME ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

    --SET IDENTITY_INSERT STAGING_CMS_UserSite ON;

    INSERT INTO STAGING_CMS_UserSite
    (
           UserSiteID
         , UserID
         , SiteID
         , UserPreferredCurrencyID
         , UserPreferredShippingOptionID
         , UserPreferredPaymentOptionID) 
    SELECT
           UserSiteID
         , UserID
         , SiteID
         , UserPreferredCurrencyID
         , UserPreferredShippingOptionID
         , UserPreferredPaymentOptionID
           FROM CMS_UserSite;

    --SET IDENTITY_INSERT STAGING_CMS_UserSite OFF;

    IF EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGING_CMS_UserSite_Update_History') 
        BEGIN
            DROP TABLE
                 STAGING_CMS_UserSite_Update_History;
        END;

    -- select * from STAGING_CMS_UserSite_Update_History
   
CREATE TABLE [dbo].[STAGING_CMS_UserSite_Update_History](
	[UserSiteid] [int] NOT NULL,
	[SYS_CHANGE_VERSION] [bigint] NULL,
	[SYS_CHANGE_OPERATION] [nchar](1) NULL,
	[SYS_CHANGE_COLUMNS] [varbinary](4100) NULL,
	[CurrUser] [varchar](60) NOT NULL,
	[SysUser] [varchar](60) NOT NULL,
	[IPADDR] [varchar](60) NOT NULL,
	[commit_time] [datetime] NOT NULL,
	[LastModifiedDate] [datetime] NOT NULL,
	[SVR] [nvarchar](128) NULL,
	[DBNAME] [nvarchar](128) NULL,
	[UserSiteID_cg] [int] NULL,
	[UserID_cg] [int] NULL,
	[SiteID_cg] [int] NULL,
	[UserPreferredCurrencyID_cg] [int] NULL,
	[UserPreferredShippingOptionID_cg] [int] NULL,
	[UserPreferredPaymentOptionID_cg] [int] NULL
) ON [PRIMARY]

ALTER TABLE [dbo].[STAGING_CMS_UserSite_Update_History] ADD  CONSTRAINT [DF_STAGING_CMS_UserSite_Update_History_CurrUser]  DEFAULT (user_name()) FOR [CurrUser]
ALTER TABLE [dbo].[STAGING_CMS_UserSite_Update_History] ADD  CONSTRAINT [DF_STAGING_CMS_UserSite_Update_History_SysUser]  DEFAULT (suser_sname()) FOR [SysUser]
ALTER TABLE [dbo].[STAGING_CMS_UserSite_Update_History] ADD  CONSTRAINT [DF_STAGING_CMS_UserSite_Update_History_IPADDR]  DEFAULT (CONVERT([nvarchar](50),connectionproperty('client_net_address'))) FOR [IPADDR]


    CREATE CLUSTERED INDEX PI_STAGING_CMS_UserSite_Update_History ON dbo.STAGING_CMS_UserSite_Update_History
    (
    UserSiteID ASC,
    SVR ASC,
    SYS_CHANGE_VERSION ASC
    )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];


END;

GO
PRINT 'Executed create_table_STAGING_CMS_UserSite.sql';
GO
-- select * from STAGING_CMS_UserSite_Update_History
EXEC proc_Create_Table_STAGING_CMS_UserSite;
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing TRIG_CMS_UserSite_Audit.SQL';
GO
-- select count(*) from STAGING_CMS_UserSite_Audit
-- select * from STAGING_CMS_UserSite_Audit
-- truncate table STAGING_CMS_UserSite_Audit

IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'STAGING_CMS_UserSite_Audit') 
    BEGIN
        DROP TABLE
             STAGING_CMS_UserSite_Audit;
    END;
GO

CREATE TABLE dbo.STAGING_CMS_UserSite_Audit (
             UserSiteID int NOT NULL
           , SVR nvarchar (100) NOT NULL
           , DBNAME nvarchar (100) NOT NULL
           , SYS_CHANGE_VERSION int NULL
           , SYS_CHANGE_OPERATION nvarchar (10) NULL
           , SchemaName nvarchar (100) NULL
           , SysUser nvarchar (100) NULL
           , IPADDR  nvarchar (50) NULL
           , Processed integer NULL
           , TBL nvarchar (100) NULL
           , CreateDate datetime NULL
           , commit_time datetime NULL
);
GO
ALTER TABLE dbo.STAGING_CMS_UserSite_Audit
ADD
            CONSTRAINT DF_STAGING_CMS_UserSite_Audit_CreateDate  DEFAULT GETDATE () FOR CreateDate;
GO
CREATE CLUSTERED INDEX PK_CMS_UserSite_Audit ON dbo.STAGING_CMS_UserSite_Audit
(
    UserSiteID ASC,
    SVR ASC,
    SYS_CHANGE_VERSION ASC,
    SYS_CHANGE_OPERATION ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

GO

/*---------------------------------------------------------------------------------------------------------------------------------
-- TROUBLESHOOTING AND TESTING QRYS
	select count(*) from CMS_UserSite where UserID = 53 and SiteID = 36
	INSERT INTO CMS_UserSite (UserID, SiteID) VALUES (53, 36) ;
	delete from CMS_UserSite where UserID = 13593 and SiteID = 9
	select top 1000 * from CMS_User
	select top 1000 * from CMS_UserSite
	update CMS_UserSite set SiteID = SiteID where UserSiteID in (Select top 100 UserSiteID from CMS_UserSite order by UserSiteID desc)
	select * from STAGING_CMS_UserSite_Audit
	truncate table  STAGING_CMS_UserSite_Audit
*/

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_INS_CMS_UserSite_Audit') 
    BEGIN
        DROP TRIGGER
             trig_INS_CMS_UserSite_Audit;
    END;
GO

CREATE TRIGGER trig_INS_CMS_UserSite_Audit ON CMS_UserSite
    AFTER INSERT
AS
BEGIN

    DECLARE @svr nvarchar (100) = (SELECT
                                          @@SERVERNAME);
    DECLARE @db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CHG_VER int = (SELECT
                                   MAX (CT.SYS_CHANGE_VERSION) 
                                   FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CT);
    DECLARE @ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)) );
    DECLARE @userid nvarchar (50) = (SELECT
                                            USER_NAME () );
    DECLARE @sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);

    SET @CHG_VER = @CHG_VER - 1;
    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES CMS_User, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);

    INSERT INTO STAGING_CMS_UserSite_Audit
    (
           UserSiteID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL
         , commit_time
    ) 
    SELECT
           UserSiteID
         , @svr
         , @db
         , @CHG_VER
         , 'I'
         , @userid
         , @sysuser
         , @ipaddr
         , 0 AS Processed
         , 'CMS_UserSite'
         , @Commit_Time
           FROM Inserted;
END;

GO

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_UPDT_CMS_UserSite_Audit') 
    BEGIN
        DROP TRIGGER
             trig_UPDT_CMS_UserSite_Audit;
    END;
GO

CREATE TRIGGER trig_UPDT_CMS_UserSite_Audit ON CMS_UserSite
    AFTER UPDATE
AS
BEGIN

    DECLARE @svr nvarchar (100) = (SELECT
                                          @@SERVERNAME);
    DECLARE @db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CHG_VER int = (SELECT
                                   MAX (CT.SYS_CHANGE_VERSION) 
                                   FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CT);
    DECLARE @ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)) );
    DECLARE @userid nvarchar (50) = (SELECT
                                            USER_NAME () );
    DECLARE @sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);
    SET @CHG_VER = @CHG_VER - 1;
    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES CMS_User, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);
    INSERT INTO STAGING_CMS_UserSite_Audit
    (
           UserSiteID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL
         , commit_time
    ) 
    SELECT
           UserSiteID
         , @svr
         , @db
         , @CHG_VER
         , 'U'
         , @userid
         , @sysuser
         , @ipaddr
         , 0 AS Processed
         , 'CMS_UserSite'
         , @Commit_Time
           FROM Inserted;
END;

GO

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_DEL_CMS_UserSite_Audit') 
    BEGIN
        DROP TRIGGER
             trig_DEL_CMS_UserSite_Audit;
    END;
GO

CREATE TRIGGER trig_DEL_CMS_UserSite_Audit ON CMS_UserSite
    AFTER DELETE
AS
BEGIN

    DECLARE @svr nvarchar (100) = (SELECT
                                          @@SERVERNAME);
    DECLARE @db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CHG_VER int = (SELECT
                                   MAX (CT.SYS_CHANGE_VERSION) 
                                   FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CT);
    DECLARE @ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)) );
    DECLARE @userid nvarchar (50) = (SELECT
                                            USER_NAME () );
    DECLARE @sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);
    SET @CHG_VER = @CHG_VER - 1;
    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES CMS_User, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);
    INSERT INTO STAGING_CMS_UserSite_Audit
    (
           UserSiteID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL
         , commit_time
    ) 
    SELECT
           UserSiteID
         , @svr
         , @db
         , @CHG_VER
         , 'D'
         , @userid
         , @sysuser
         , @ipaddr
         , 0 AS Processed
         , 'CMS_UserSite'
         , @Commit_Time
           FROM DELETED;
END;

GO
PRINT 'EXECUTED _TriggerToUpdateAuditRecordForCT.SQL';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






go
print 'Executing view_AUDIT_CMS_UserSite.sql'
go
if exists (select name from sys.views where name = 'view_AUDIT_CMS_UserSite')
    drop view view_AUDIT_CMS_UserSite;

go

/*---------------------------------------------------
select * from STAGING_CMS_UserSite
select * from STAGING_CMS_UserSite_Update_History
select * from STAGING_CMS_UserSite_Audit
*/
-- select * from view_AUDIT_CMS_UserSite order by UserSiteID
/*
HOW TO USE:
    select * from view_AUDIT_CMS_UserSite order by UserSiteID
	   where CreateDate between '2015-09-18 14:55:33.000' and '2015-09-18 14:55:34'

    select * from view_AUDIT_CMS_UserSite
	   where SysUser = 'dmiller'
*/

CREATE VIEW view_AUDIT_CMS_UserSite
AS 
SELECT distinct
          A.SysUser
        , A.IPADDR
        , A.CreateDate
        , A.SYS_CHANGE_OPERATION
        , A.SYS_CHANGE_VERSION as SysChangeVersion
        , S.*
          FROM
		  STAGING_CMS_UserSite_Audit	as A
		  join STAGING_CMS_UserSite AS S
                      ON S.UserSiteID = A.UserSiteID ;
go
print 'Executed view_AUDIT_CMS_UserSite.sql'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating JOB Create_job_EDW_GetStagingData_CMS_UserSite';
GO

BEGIN TRANSACTION;
DECLARE
@ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS ( SELECT
                       name
                       FROM msdb.dbo.syscategories
                       WHERE
                       name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB' , @type = N'LOCAL' , @name = N'[Uncategorized (Local)]';
        IF
        @@ERROR <> 0
     OR @ReturnCode <> 0
            BEGIN
                GOTO QuitWithRollback;
            END;

    END;

DECLARE
@TGTDB AS nvarchar ( 50) = DB_NAME () ;

DECLARE
@JNAME AS nvarchar ( 100) = 'job_EDW_GetStagingData_CMS_UserSite_' + @TGTDB;

IF EXISTS ( SELECT
                   job_id
                   FROM msdb.dbo.sysjobs_view
                   WHERE name = @JNAME) 
    BEGIN EXEC msdb.dbo.sp_delete_job @job_name = @JNAME , @delete_unused_schedule = 1;
    END;

DECLARE
@jobId binary ( 16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME , @enabled = 1 , @notify_level_eventlog = 2 , @notify_level_email = 2 , @notify_level_netsend = 0 , @notify_level_page = 0 , @delete_level = 0 , @description = N'No description available.' , @category_name = N'[Uncategorized (Local)]' , @owner_login_name = N'sa' , @notify_email_operator_name = N'DBA_Notify' , @job_id = @jobId OUTPUT;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;

/*--------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------
***** Object:  Step [Load_STAGING_EDW_CMS_UserSite]    Script Date: 4/12/2015 9:59:37 AM *****
*/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId , @step_name = N'Load_STAGING_EDW_CMS_UserSite' , @step_id = 1 , @cmdexec_success_code = 0 , @on_success_action = 1 , @on_success_step_id = 0 , @on_fail_action = 2 , @on_fail_step_id = 0 , @retry_attempts = 0 , @retry_interval = 0 , @os_run_priority = 0 , @subsystem = N'TSQL' , @command = N'exec proc_STAGING_EDW_CMS_UserSite;' , @database_name = @TGTDB , @flags = 0;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId , @start_step_id = 1;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId , @name = N'Schedule_STAGING_EDW_CMS_UserSite' , @enabled = 1 , @freq_type = 4 , @freq_interval = 1 , @freq_subday_type = 8 , @freq_subday_interval = 8 , @freq_relative_interval = 0 , @freq_recurrence_factor = 0 , @active_start_date = 20150412 , @active_end_date = 99991231 , @active_start_time = 10000 ,
@active_end_time = 235959;
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId , @server_name = N'(local)';
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN
        ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_getPrevVer.sql';
GO

IF EXISTS (SELECT
				  name
				  FROM sys.procedures
				  WHERE name = 'proc_CT_getPrevVer') 
	BEGIN
		DROP PROCEDURE
			 proc_CT_getPrevVer
	END;

GO
-- exec proc_CT_getPrevVer "hfit_PPtEligibility"
CREATE PROCEDURE proc_CT_getPrevVer (
	   @Tblname nvarchar (100)) 
AS
	 BEGIN
		 DECLARE @Ct TABLE (
						   ver bigint) ;
		 INSERT INTO @Ct
		 SELECT DISTINCT TOP 2
				CT.SYS_CHANGE_VERSION
				FROM CHANGETABLE (CHANGES HFIT_PPTEligibility, NULL) AS CT
				ORDER BY
						 CT.SYS_CHANGE_VERSION DESC;

		 DECLARE @Tgtver bigint = (SELECT TOP 1
										  ver
										  FROM @Ct
										  ORDER BY
												   ver) ;

		 RETURN @Tgtver;
	 END;

GO
PRINT 'Executed proc_CT_getPrevVer.sql';
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





go
print 'Executing udf_CT_GetCommitTime.sql'
go

IF OBJECT_ID (N'dbo.udf_CT_GetCommitTime', N'FN') IS NOT NULL
	BEGIN
		DROP FUNCTION
			 udf_CT_GetCommitTime
	END;
GO
CREATE FUNCTION dbo.udf_CT_GetCommitTime (
				@Verno bigint) 
RETURNS datetime
AS
	 BEGIN
		 DECLARE @Dt datetime;
		 SET @Dt = (SELECT
						   tc.commit_time
						   FROM
								CHANGETABLE (CHANGES HFIT_PPTEligibility, 0) c
									JOIN sys.dm_tran_commit_table AS tc
										ON c.sys_change_version = tc.commit_ts) ;

		 RETURN @Dt;
	 END;
GO

print 'Executed udf_CT_GetCommitTime.sql'
go
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




-- USE KenticoCMS_PRD_1

/*************************
------------------------
cms_user			    -> DONE
cms_usersettings	  -> DONE
CMS_UserSite	  -> DONE
HFIT_PPTEligibility
cms_usercontact
*************************/
GO
PRINT 'Executing create_table_STAGING_HFIT_PPTEligibility.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'STAGING_HFIT_PPTEligibility_Audit') 
    BEGIN
        DROP TABLE
             STAGING_HFIT_PPTEligibility_Audit;
    END;
GO

CREATE TABLE dbo.STAGING_HFIT_PPTEligibility_Audit (
             PPTID int NOT NULL
           , SVR nvarchar (100) NOT NULL
           , DBNAME nvarchar (100) NOT NULL
           , SYS_CHANGE_VERSION int NULL
           , SYS_CHANGE_OPERATION nvarchar (10) NULL
           , SchemaName nvarchar (100) NULL
           , SysUser nvarchar (100) NULL
           , IPADDR nvarchar (50) NULL
           , Processed integer NULL
           , TBL nvarchar (100) NULL
           , CreateDate datetime NULL
           , commit_time datetime NULL) ;
GO
ALTER TABLE dbo.STAGING_HFIT_PPTEligibility_Audit
ADD
            CONSTRAINT DF_STAGING_HFIT_PPTEligibility_Audit_CreateDate DEFAULT GETDATE () FOR CreateDate;
GO

CREATE CLUSTERED INDEX PK_HFIT_PPTEligibility_Audit ON dbo.STAGING_HFIT_PPTEligibility_Audit (PPTID ASC, SVR ASC, SYS_CHANGE_VERSION ASC, SYS_CHANGE_OPERATION ASC) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

GO

IF NOT EXISTS (SELECT
					  sys.tables.name AS Table_name
					  FROM
						   sys.change_tracking_tables
							   JOIN sys.tables
								   ON sys.tables.object_id = sys.change_tracking_tables.object_id
							   JOIN sys.schemas
								   ON sys.schemas.schema_id = sys.tables.schema_id
					  WHERE sys.tables.name = 'HFIT_PPTEligibility') 
	BEGIN
		PRINT 'ADDING Change Tracking to HFIT_PPTEligibility';
		ALTER TABLE dbo.HFIT_PPTEligibility ENABLE CHANGE_TRACKING
				WITH (TRACK_COLUMNS_UPDATED = ON) ;
	END;
ELSE
	BEGIN
		PRINT 'Change Tracking exists on HFIT_PPTEligibility';
	END;
GO
IF EXISTS (SELECT
				  name
				  FROM sys.procedures
				  WHERE name = 'proc_Create_Table_STAGING_HFIT_PPTEligibility') 
	BEGIN
		DROP PROCEDURE
			 proc_Create_Table_STAGING_HFIT_PPTEligibility;
	END;
GO
-- exec proc_Create_Table_STAGING_HFIT_PPTEligibility
-- select top 100 * from [STAGING_HFIT_PPTEligibility]
CREATE PROCEDURE proc_Create_Table_STAGING_HFIT_PPTEligibility
AS
	 BEGIN

		 IF EXISTS (SELECT
						   name
						   FROM sys.tables
						   WHERE name = 'STAGING_HFIT_PPTEligibility') 
			 BEGIN
				 DROP TABLE
					  dbo.STAGING_HFIT_PPTEligibility;
			 END;

		 SET ANSI_NULLS ON;
		 SET QUOTED_IDENTIFIER ON;

		 CREATE TABLE dbo.STAGING_HFIT_PPTEligibility (
					  PPTID int NOT NULL
					, ClientID varchar (27) NULL
					, ClientCode varchar (12) NULL
					, UserID int NULL
					, IDCard nvarchar (25) NULL
					, FirstName varchar (50) NOT NULL
					, LastName varchar (50) NOT NULL
					, MiddleInit varchar (2) NULL
					, BirthDate datetime2 (7) NULL
					, Gender nvarchar (1) NULL
					, AddressLine1 varchar (50) NULL
					, AddressLine2 varchar (50) NULL
					, City varchar (30) NULL
					, State varchar (2) NULL
					, PostalCode varchar (10) NULL
					, HomePhoneNum varchar (12) NULL
					, WorkPhoneNum varchar (12) NULL
					, MobilePhoneNum varchar (12) NULL
					, EmailAddress varchar (50) NULL
					, MPI varchar (50) NOT NULL
					, MatchMethodCode nvarchar (25) NULL
					, SSN varchar (11) NULL
					, PrimarySSN varchar (11) NULL
					, HireDate datetime2 (7) NULL
					, TermDate datetime2 (7) NULL
					, RetireeDate datetime2 (7) NULL
					, PlanName varchar (50) NULL
					, PlanDescription varchar (50) NULL
					, PlanID varchar (25) NULL
					, PlanStartDate datetime2 (7) NULL
					, PlanEndDate datetime2 (7) NULL
					, Company varchar (50) NULL
					, CompanyCd varchar (20) NULL
					, LocationName varchar (50) NULL
					, LocationCd varchar (20) NULL
					, DepartmentName varchar (50) NULL
					, DepartmentCd varchar (20) NULL
					, UnionCd varchar (30) NULL
					, BenefitGrp varchar (20) NULL
					, PayGrp varchar (20) NULL
					, Division varchar (30) NULL
					, JobTitle varchar (50) NULL
					, JobCd varchar (20) NULL
					, TeamName varchar (30) NULL
					, MaritalStatus varchar (30) NULL
					, PersonType varchar (30) NULL
					, PersonStatus varchar (30) NULL
					, EmployeeType varchar (30) NULL
					, CoverageType varchar (30) NULL
					, EmployeeStatus varchar (30) NULL
					, PayCd varchar (30) NULL
					, BenefitStatus varchar (30) NULL
					, PlanType varchar (20) NULL
					, ClientPlatformElig bit NULL
					, ClientHRAElig bit NULL
					, ClientLMElig bit NULL
					, ClientIncentiveElig bit NULL
					, ClientCMElig bit NULL
					, ClientScreeningElig bit NULL
					, Custom1 varchar (50) NULL
					, Custom2 varchar (50) NULL
					, Custom3 varchar (50) NULL
					, Custom4 varchar (50) NULL
					, Custom5 varchar (50) NULL
					, Custom6 varchar (50) NULL
					, Custom7 varchar (50) NULL
					, Custom8 varchar (50) NULL
					, Custom9 varchar (50) NULL
					, Custom10 varchar (50) NULL
					, Custom11 varchar (50) NULL
					, Custom12 varchar (50) NULL
					, Custom13 varchar (50) NULL
					, Custom14 varchar (50) NULL
					, Custom15 varchar (50) NULL
					, ChangeStatusFlag nvarchar (1) NULL
					, Last_Update_Dt datetime2 (7) NULL
					, FlatFileName nvarchar (500) NULL
					, ItemGUID uniqueidentifier NOT NULL
					, Hashbyte_Checksum varchar (32) NULL
					, Primary_MPI nvarchar (50) NULL
					, MPI_Relationship_Type varchar (50) NULL
					, WorkInd bit NULL
					, LastModifiedDate datetime NULL
					, RowNbr int NULL
					, DeletedFlg bit NULL
					, TimeZone nvarchar (10) NULL
					, ConvertedToCentralTime bit NULL
					, SVR nvarchar (100) NOT NULL
					, DBNAME nvarchar (100) NOT NULL
					, SYS_CHANGE_VERSION int NULL) 
		 ON [PRIMARY];

		 ALTER TABLE dbo.STAGING_HFIT_PPTEligibility
		 ADD
					 DEFAULT @@Servername FOR SVR;
		 ALTER TABLE dbo.STAGING_HFIT_PPTEligibility
		 ADD
					 DEFAULT DB_NAME () FOR DBNAME;

		 CREATE CLUSTERED INDEX PI_STAGING_HFIT_PPTEligibility ON dbo.STAGING_HFIT_PPTEligibility (PPTID ASC, SVR ASC, DBNAME ASC, SYS_CHANGE_VERSION ASC) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

		 --SET IDENTITY_INSERT STAGING_HFIT_PPTEligibility ON;

		 INSERT INTO STAGING_HFIT_PPTEligibility (
					 PPTID
				   , ClientID
				   , ClientCode
				   , UserID
				   , IDCard
				   , FirstName
				   , LastName
				   , MiddleInit
				   , BirthDate
				   , Gender
				   , AddressLine1
				   , AddressLine2
				   , City
				   , State
				   , PostalCode
				   , HomePhoneNum
				   , WorkPhoneNum
				   , MobilePhoneNum
				   , EmailAddress
				   , MPI
				   , MatchMethodCode
				   , SSN
				   , PrimarySSN
				   , HireDate
				   , TermDate
				   , RetireeDate
				   , PlanName
				   , PlanDescription
				   , PlanID
				   , PlanStartDate
				   , PlanEndDate
				   , Company
				   , CompanyCd
				   , LocationName
				   , LocationCd
				   , DepartmentName
				   , DepartmentCd
				   , UnionCd
				   , BenefitGrp
				   , PayGrp
				   , Division
				   , JobTitle
				   , JobCd
				   , TeamName
				   , MaritalStatus
				   , PersonType
				   , PersonStatus
				   , EmployeeType
				   , CoverageType
				   , EmployeeStatus
				   , PayCd
				   , BenefitStatus
				   , PlanType
				   , ClientPlatformElig
				   , ClientHRAElig
				   , ClientLMElig
				   , ClientIncentiveElig
				   , ClientCMElig
				   , ClientScreeningElig
				   , Custom1
				   , Custom2
				   , Custom3
				   , Custom4
				   , Custom5
				   , Custom6
				   , Custom7
				   , Custom8
				   , Custom9
				   , Custom10
				   , Custom11
				   , Custom12
				   , Custom13
				   , Custom14
				   , Custom15
				   , ChangeStatusFlag
				   , Last_Update_Dt
				   , FlatFileName
				   , ItemGUID
				   , Hashbyte_Checksum
				   , Primary_MPI
				   , MPI_Relationship_Type
				   , WorkInd) 
		 SELECT
				PPTID
			  , ClientID
			  , ClientCode
			  , UserID
			  , IDCard
			  , FirstName
			  , LastName
			  , MiddleInit
			  , BirthDate
			  , Gender
			  , AddressLine1
			  , AddressLine2
			  , City
			  , State
			  , PostalCode
			  , HomePhoneNum
			  , WorkPhoneNum
			  , MobilePhoneNum
			  , EmailAddress
			  , MPI
			  , MatchMethodCode
			  , SSN
			  , PrimarySSN
			  , HireDate
			  , TermDate
			  , RetireeDate
			  , PlanName
			  , PlanDescription
			  , PlanID
			  , PlanStartDate
			  , PlanEndDate
			  , Company
			  , CompanyCd
			  , LocationName
			  , LocationCd
			  , DepartmentName
			  , DepartmentCd
			  , UnionCd
			  , BenefitGrp
			  , PayGrp
			  , Division
			  , JobTitle
			  , JobCd
			  , TeamName
			  , MaritalStatus
			  , PersonType
			  , PersonStatus
			  , EmployeeType
			  , CoverageType
			  , EmployeeStatus
			  , PayCd
			  , BenefitStatus
			  , PlanType
			  , ClientPlatformElig
			  , ClientHRAElig
			  , ClientLMElig
			  , ClientIncentiveElig
			  , ClientCMElig
			  , ClientScreeningElig
			  , Custom1
			  , Custom2
			  , Custom3
			  , Custom4
			  , Custom5
			  , Custom6
			  , Custom7
			  , Custom8
			  , Custom9
			  , Custom10
			  , Custom11
			  , Custom12
			  , Custom13
			  , Custom14
			  , Custom15
			  , ChangeStatusFlag
			  , Last_Update_Dt
			  , FlatFileName
			  , ItemGUID
			  , Hashbyte_Checksum
			  , Primary_MPI
			  , MPI_Relationship_Type
			  , WorkInd
				FROM HFIT_PPTEligibility;

		 --SET IDENTITY_INSERT STAGING_HFIT_PPTEligibility OFF;

		 IF EXISTS (SELECT
						   name
						   FROM sys.tables
						   WHERE name = 'STAGING_HFIT_PPTEligibility_Update_History') 
			 BEGIN
				 PRINT 'dropping and recreating STAGING_HFIT_PPTEligibility_Update_History';
				 DROP TABLE
					  STAGING_HFIT_PPTEligibility_Update_History;
			 END;

		 CREATE TABLE dbo.STAGING_HFIT_PPTEligibility_Update_History (
					  PPTID int NOT NULL
					, AddressLine1_cg int NULL
					, AddressLine2_cg int NULL
					, BenefitGrp_cg int NULL
					, BenefitStatus_cg int NULL
					, BirthDate_cg int NULL
					, ChangeStatusFlag_cg int NULL
					, City_cg int NULL
					, ClientCMElig_cg int NULL
					, ClientCode_cg int NULL
					, ClientHRAElig_cg int NULL
					, ClientID_cg int NULL
					, ClientIncentiveElig_cg int NULL
					, ClientLMElig_cg int NULL
					, ClientPlatformElig_cg int NULL
					, ClientScreeningElig_cg int NULL
					, Company_cg int NULL
					, CompanyCd_cg int NULL
					, CoverageType_cg int NULL
					, Custom1_cg int NULL
					, Custom10_cg int NULL
					, Custom11_cg int NULL
					, Custom12_cg int NULL
					, Custom13_cg int NULL
					, Custom14_cg int NULL
					, Custom15_cg int NULL
					, Custom2_cg int NULL
					, Custom3_cg int NULL
					, Custom4_cg int NULL
					, Custom5_cg int NULL
					, Custom6_cg int NULL
					, Custom7_cg int NULL
					, Custom8_cg int NULL
					, Custom9_cg int NULL
					, DepartmentCd_cg int NULL
					, DepartmentName_cg int NULL
					, Division_cg int NULL
					, EmailAddress_cg int NULL
					, EmployeeStatus_cg int NULL
					, EmployeeType_cg int NULL
					, FirstName_cg int NULL
					, FlatFileName_cg int NULL
					, Gender_cg int NULL
					, Hashbyte_Checksum_cg int NULL
					, HireDate_cg int NULL
					, HomePhoneNum_cg int NULL
					, IDCard_cg int NULL
					, ItemGUID_cg int NULL
					, JobCd_cg int NULL
					, JobTitle_cg int NULL
					, Last_Update_Dt_cg int NULL
					, LastName_cg int NULL
					, LocationCd_cg int NULL
					, LocationName_cg int NULL
					, MaritalStatus_cg int NULL
					, MatchMethodCode_cg int NULL
					, MiddleInit_cg int NULL
					, MobilePhoneNum_cg int NULL
					, MPI_cg int NULL
					, MPI_Relationship_Type_cg int NULL
					, PayCd_cg int NULL
					, PayGrp_cg int NULL
					, PersonStatus_cg int NULL
					, PersonType_cg int NULL
					, PlanDescription_cg int NULL
					, PlanEndDate_cg int NULL
					, PlanID_cg int NULL
					, PlanName_cg int NULL
					, PlanStartDate_cg int NULL
					, PlanType_cg int NULL
					, PostalCode_cg int NULL
					, PPTID_cg int NULL
					, Primary_MPI_cg int NULL
					, PrimarySSN_cg int NULL
					, RetireeDate_cg int NULL
					, SSN_cg int NULL
					, State_cg int NULL
					, TeamName_cg int NULL
					, TermDate_cg int NULL
					, UnionCd_cg int NULL
					, UserID_cg int NULL
					, WorkInd_cg int NULL
					, WorkPhoneNum_cg int NULL
					, LastModifiedDate datetime DEFAULT GETDATE () 
					, SVR nvarchar (100) NOT NULL
										 DEFAULT @@Servername
					, DBNAME nvarchar (100) NOT NULL
											DEFAULT DB_NAME () 
					, SYS_CHANGE_VERSION int NULL
					, SYS_CHANGE_COLUMNS varbinary (4000) NULL
					, SYS_CHANGE_OPERATION nchar (1) NULL
					, CurrUser nvarchar (100) NULL
											  CONSTRAINT DF_STAGING_HFIT_PPTEligibility_Update_History_CurrUser DEFAULT USER_NAME () 
					, SysUser nvarchar (100) NULL
											 CONSTRAINT DF_STAGING_HFIT_PPTEligibility_Update_History_SysUser DEFAULT SUSER_SNAME () 
					, IPADDR nvarchar (50) NULL
										   CONSTRAINT DF_STAGING_HFIT_PPTEligibility_Update_History_IPADDR DEFAULT CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50))
					,commit_time datetime)
		 ON [PRIMARY];

		 CREATE CLUSTERED INDEX PI_STAGING_HFIT_PPTEligibility_Update_History ON dbo.STAGING_HFIT_PPTEligibility_Update_History (PPTID ASC, SVR ASC, SYS_CHANGE_VERSION ASC) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

	 -- select * from STAGING_HFIT_PPTEligibility_Update_History
	 --ALTER TABLE dbo.STAGING_HFIT_PPTEligibility_Update_History
	 --ADD
	 --            DEFAULT @@servername FOR SVR;
	 --ALTER TABLE dbo.STAGING_HFIT_PPTEligibility_Update_History
	 --ADD
	 --            DEFAULT DB_NAME () FOR DBNAME;

	 END;

GO
PRINT 'Executed create_table_STAGING_HFIT_PPTEligibility.sql';
GO
EXEC proc_Create_Table_STAGING_HFIT_PPTEligibility;
GO
--SELECT * FROM STAGING_HFIT_PPTEligibility_Update_History;
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





-- use KenticoCMS_PRD_1
GO
PRINT 'Executing proc_HFIT_PPTEligibility_AddDeletedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_HFIT_PPTEligibility_AddDeletedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_HFIT_PPTEligibility_AddDeletedRecs;
    END;
GO
-- delete from HFIT_PPTEligibility where PPTID = 1 
-- EXEC proc_HFIT_PPTEligibility_AddDeletedRecs
CREATE PROCEDURE proc_HFIT_PPTEligibility_AddDeletedRecs
AS
BEGIN

    UPDATE STAGING_HFIT_PPTEligibility
           SET
               DeletedFlg = 1
             ,LastModifiedDate = GETDATE () 
    WHERE
          PPTID IN
          (SELECT
                  PPTID
                  FROM CHANGETABLE (CHANGES HFIT_PPTEligibility, NULL) AS CT
                  WHERE SYS_CHANGE_OPERATION = 'D') 
      AND DeletedFlg IS NULL;

    DECLARE
    @iCnt AS int = @@ROWCOUNT;
    PRINT 'Deleted Count: ' + CAST ( @iCnt AS nvarchar (50)) ;

	exec proc_CT_HFIT_PPTEligibility_History 'D' ;

    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_HFIT_PPTEligibility_AddDeletedRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
-- use KenticoCMS_PRD_1

PRINT 'Executing proc_CT_HFIT_PPTEligibility_AddNewRecs.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_CT_HFIT_PPTEligibility_AddNewRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HFIT_PPTEligibility_AddNewRecs;
    END;
GO
-- exec proc_CT_HFIT_PPTEligibility_AddNewRecs
CREATE PROCEDURE proc_CT_HFIT_PPTEligibility_AddNewRecs
AS
BEGIN

    --SET IDENTITY_INSERT STAGING_HFIT_PPTEligibility ON;

    WITH CTE (
         PPTID) 
        AS (SELECT
                   PPTID
                   FROM HFIT_PPTEligibility
            EXCEPT
            SELECT
                   PPTID
                   FROM STAGING_HFIT_PPTEligibility
                   WHERE DeletedFlg IS NULL) 
        INSERT INTO STAGING_HFIT_PPTEligibility (
               PPTID
             , ClientID
             , ClientCode
             , UserID
             , IDCard
             , FirstName
             , LastName
             , MiddleInit
             , BirthDate
             , Gender
             , AddressLine1
             , AddressLine2
             , City
             , State
             , PostalCode
             , HomePhoneNum
             , WorkPhoneNum
             , MobilePhoneNum
             , EmailAddress
             , MPI
             , MatchMethodCode
             , SSN
             , PrimarySSN
             , HireDate
             , TermDate
             , RetireeDate
             , PlanName
             , PlanDescription
             , PlanID
             , PlanStartDate
             , PlanEndDate
             , Company
             , CompanyCd
             , LocationName
             , LocationCd
             , DepartmentName
             , DepartmentCd
             , UnionCd
             , BenefitGrp
             , PayGrp
             , Division
             , JobTitle
             , JobCd
             , TeamName
             , MaritalStatus
             , PersonType
             , PersonStatus
             , EmployeeType
             , CoverageType
             , EmployeeStatus
             , PayCd
             , BenefitStatus
             , PlanType
             , ClientPlatformElig
             , ClientHRAElig
             , ClientLMElig
             , ClientIncentiveElig
             , ClientCMElig
             , ClientScreeningElig
             , Custom1
             , Custom2
             , Custom3
             , Custom4
             , Custom5
             , Custom6
             , Custom7
             , Custom8
             , Custom9
             , Custom10
             , Custom11
             , Custom12
             , Custom13
             , Custom14
             , Custom15
             , ChangeStatusFlag
             , Last_Update_Dt
             , FlatFileName
             , ItemGUID
             , Hashbyte_Checksum
             , Primary_MPI
             , MPI_Relationship_Type
             , WorkInd
             , LastModifiedDate
               --,[RowNbr]
             , DeletedFlg
             , TimeZone
             , ConvertedToCentralTime
             , SVR
             , DBNAME
             , SYS_CHANGE_VERSION) 
        SELECT
               T.PPTID
             , T.ClientID
             , T.ClientCode
             , T.UserID
             , T.IDCard
             , T.FirstName
             , T.LastName
             , T.MiddleInit
             , T.BirthDate
             , T.Gender
             , T.AddressLine1
             , T.AddressLine2
             , T.City
             , T.State
             , T.PostalCode
             , T.HomePhoneNum
             , T.WorkPhoneNum
             , T.MobilePhoneNum
             , T.EmailAddress
             , T.MPI
             , T.MatchMethodCode
             , T.SSN
             , T.PrimarySSN
             , T.HireDate
             , T.TermDate
             , T.RetireeDate
             , T.PlanName
             , T.PlanDescription
             , T.PlanID
             , T.PlanStartDate
             , T.PlanEndDate
             , T.Company
             , T.CompanyCd
             , T.LocationName
             , T.LocationCd
             , T.DepartmentName
             , T.DepartmentCd
             , T.UnionCd
             , T.BenefitGrp
             , T.PayGrp
             , T.Division
             , T.JobTitle
             , T.JobCd
             , T.TeamName
             , T.MaritalStatus
             , T.PersonType
             , T.PersonStatus
             , T.EmployeeType
             , T.CoverageType
             , T.EmployeeStatus
             , T.PayCd
             , T.BenefitStatus
             , T.PlanType
             , T.ClientPlatformElig
             , T.ClientHRAElig
             , T.ClientLMElig
             , T.ClientIncentiveElig
             , T.ClientCMElig
             , T.ClientScreeningElig
             , T.Custom1
             , T.Custom2
             , T.Custom3
             , T.Custom4
             , T.Custom5
             , T.Custom6
             , T.Custom7
             , T.Custom8
             , T.Custom9
             , T.Custom10
             , T.Custom11
             , T.Custom12
             , T.Custom13
             , T.Custom14
             , T.Custom15
             , T.ChangeStatusFlag
             , T.Last_Update_Dt
             , T.FlatFileName
             , T.ItemGUID
             , T.Hashbyte_Checksum
             , T.Primary_MPI
             , T.MPI_Relationship_Type
             , T.WorkInd
             , GETDATE () AS LastModifiedDate
             , NULL AS DeletedFlg
             , NULL AS TimeZone
             , NULL AS ConvertedToCentralTime
             , @@SERVERNAME AS SVR
             , DB_NAME () AS DBNAME
             , NULL AS SYS_CHANGE_VERSION
               FROM
                   HFIT_PPTEligibility AS T
                       JOIN CTE AS S
                           ON S.PPTID = T.PPTID;
    DECLARE @iInserts AS int = @@ROWCOUNT;
    --SET IDENTITY_INSERT STAGING_HFIT_PPTEligibility OFF;
    PRINT 'NEW Insert Count: ' + CAST (@iInserts AS nvarchar (50)) ;
    EXEC proc_CT_HFIT_PPTEligibility_History 'I';

    RETURN @iInserts;
END;

GO
PRINT 'Executed proc_CT_HFIT_PPTEligibility_AddNewRecs.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





-- use KenticoCMS_PRD_1

GO
PRINT 'Executing proc_CT_HFIT_PPTEligibility_AddUpdatedRecs.sql';
GO
IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_CT_HFIT_PPTEligibility_AddUpdatedRecs') 
    BEGIN
        DROP PROCEDURE
             proc_CT_HFIT_PPTEligibility_AddUpdatedRecs;
    END;
GO

/*----------------------------------------------------------
    exec proc_CT_HFIT_PPTEligibility_AddUpdatedRecs
    select * from STAGING_HFIT_PPTEligibility where SYS_CHANGE_VERSION is not null
*/

CREATE PROCEDURE proc_CT_HFIT_PPTEligibility_AddUpdatedRecs
AS
BEGIN
    WITH CTE (
         PPTID
       , SYS_CHANGE_VERSION
       , SYS_CHANGE_OPERATION
       , SYS_CHANGE_COLUMNS) 
        AS ( SELECT
                    CT.PPTID
                  , CT.SYS_CHANGE_VERSION
                  , CT.SYS_CHANGE_OPERATION
                  , SYS_CHANGE_COLUMNS
                    FROM CHANGETABLE (CHANGES HFIT_PPTEligibility, NULL) AS CT
                    WHERE SYS_CHANGE_OPERATION = 'U') 
        UPDATE S
               SET
                   S.PPTID = T.PPTID
                 ,S.ClientID = T.ClientID
                 ,S.ClientCode = T.ClientCode
                 ,S.UserID = T.UserID
                 ,S.IDCard = T.IDCard
                 ,S.FirstName = T.FirstName
                 ,S.LastName = T.LastName
                 ,S.MiddleInit = T.MiddleInit
                 ,S.BirthDate = T.BirthDate
                 ,S.Gender = T.Gender
                 ,S.AddressLine1 = T.AddressLine1
                 ,S.AddressLine2 = T.AddressLine2
                 ,S.City = T.City
                 ,S.State = T.State
                 ,S.PostalCode = T.PostalCode
                 ,S.HomePhoneNum = T.HomePhoneNum
                 ,S.WorkPhoneNum = T.WorkPhoneNum
                 ,S.MobilePhoneNum = T.MobilePhoneNum
                 ,S.EmailAddress = T.EmailAddress
                 ,S.MPI = T.MPI
                 ,S.MatchMethodCode = T.MatchMethodCode
                 ,S.SSN = T.SSN
                 ,S.PrimarySSN = T.PrimarySSN
                 ,S.HireDate = T.HireDate
                 ,S.TermDate = T.TermDate
                 ,S.RetireeDate = T.RetireeDate
                 ,S.PlanName = T.PlanName
                 ,S.PlanDescription = T.PlanDescription
                 ,S.PlanID = T.PlanID
                 ,S.PlanStartDate = T.PlanStartDate
                 ,S.PlanEndDate = T.PlanEndDate
                 ,S.Company = T.Company
                 ,S.CompanyCd = T.CompanyCd
                 ,S.LocationName = T.LocationName
                 ,S.LocationCd = T.LocationCd
                 ,S.DepartmentName = T.DepartmentName
                 ,S.DepartmentCd = T.DepartmentCd
                 ,S.UnionCd = T.UnionCd
                 ,S.BenefitGrp = T.BenefitGrp
                 ,S.PayGrp = T.PayGrp
                 ,S.Division = T.Division
                 ,S.JobTitle = T.JobTitle
                 ,S.JobCd = T.JobCd
                 ,S.TeamName = T.TeamName
                 ,S.MaritalStatus = T.MaritalStatus
                 ,S.PersonType = T.PersonType
                 ,S.PersonStatus = T.PersonStatus
                 ,S.EmployeeType = T.EmployeeType
                 ,S.CoverageType = T.CoverageType
                 ,S.EmployeeStatus = T.EmployeeStatus
                 ,S.PayCd = T.PayCd
                 ,S.BenefitStatus = T.BenefitStatus
                 ,S.PlanType = T.PlanType
                 ,S.ClientPlatformElig = T.ClientPlatformElig
                 ,S.ClientHRAElig = T.ClientHRAElig
                 ,S.ClientLMElig = T.ClientLMElig
                 ,S.ClientIncentiveElig = T.ClientIncentiveElig
                 ,S.ClientCMElig = T.ClientCMElig
                 ,S.ClientScreeningElig = T.ClientScreeningElig
                 ,S.Custom1 = T.Custom1
                 ,S.Custom2 = T.Custom2
                 ,S.Custom3 = T.Custom3
                 ,S.Custom4 = T.Custom4
                 ,S.Custom5 = T.Custom5
                 ,S.Custom6 = T.Custom6
                 ,S.Custom7 = T.Custom7
                 ,S.Custom8 = T.Custom8
                 ,S.Custom9 = T.Custom9
                 ,S.Custom10 = T.Custom10
                 ,S.Custom11 = T.Custom11
                 ,S.Custom12 = T.Custom12
                 ,S.Custom13 = T.Custom13
                 ,S.Custom14 = T.Custom14
                 ,S.Custom15 = T.Custom15
                 ,S.ChangeStatusFlag = T.ChangeStatusFlag
                 ,S.Last_Update_Dt = T.Last_Update_Dt
                 ,S.FlatFileName = T.FlatFileName
                 ,S.ItemGUID = T.ItemGUID
                 ,S.Hashbyte_Checksum = T.Hashbyte_Checksum
                 ,S.Primary_MPI = T.Primary_MPI
                 ,S.MPI_Relationship_Type = T.MPI_Relationship_Type
                 ,S.WorkInd = T.WorkInd

                 ,S.LastModifiedDate = GETDATE () 
                 ,S.DeletedFlg = NULL
                 ,S.ConvertedToCentralTime = NULL
                 ,S.SYS_CHANGE_VERSION = CTE.SYS_CHANGE_VERSION

                   FROM STAGING_HFIT_PPTEligibility AS S
                            JOIN
                            HFIT_PPTEligibility AS T
                                ON
                                S.PPTID = T.PPTID
                            AND S.DeletedFlg IS NULL
                            JOIN CTE
                                ON CTE.PPTID = T.PPTID
                               AND (CTE.SYS_CHANGE_VERSION != S.SYS_CHANGE_VERSION
                                 OR S.SYS_CHANGE_VERSION IS NULL);

    DECLARE
    @iCnt AS int = @@ROWCOUNT;
    PRINT 'Updated Count: ' + CAST ( @iCnt AS nvarchar (50)) ;

	exec proc_CT_HFIT_PPTEligibility_History 'U' ;
    
    RETURN @iCnt;
END;

GO
PRINT 'Executed proc_CT_HFIT_PPTEligibility_AddUpdatedRecs.sql';
GO
 --**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_HFIT_PPTEligibility_History.sql';
GO
IF EXISTS (SELECT
				  name
				  FROM sys.procedures
				  WHERE name = 'proc_CT_HFIT_PPTEligibility_History') 
	BEGIN
		DROP PROCEDURE
			 proc_CT_HFIT_PPTEligibility_History;
	END;
GO

/**************************************************************************

select tc.commit_time, *
from
    changetable(changes HFIT_PPTEligibility, 0) c
    join sys.dm_tran_commit_table tc on c.sys_change_version = tc.commit_ts


exec proc_CT_HFIT_PPTEligibility_History 'I'
exec proc_CT_HFIT_PPTEligibility_History 'D'
exec proc_CT_HFIT_PPTEligibility_History 'U'

truncate table STAGING_HFIT_PPTEligibility_Update_History
select * from STAGING_HFIT_PPTEligibility_Update_History

SELECT CHANGE_TRACKING_MIN_VALID_VERSION(OBJECT_ID('HFIT_PPTEligibility'))
**************************************************************************/

CREATE PROCEDURE proc_CT_HFIT_PPTEligibility_History (@Typesave AS nchar (1)) 
AS
	 BEGIN
		 WITH CTE (
			  PPTID
			, SYS_CHANGE_VERSION
			, SYS_CHANGE_COLUMNS) 
			 AS (SELECT
						CT.PPTID
					  , CT.SYS_CHANGE_VERSION
					  , SYS_CHANGE_COLUMNS
						FROM CHANGETABLE (CHANGES HFIT_PPTEligibility, NULL) AS CT
						WHERE SYS_CHANGE_OPERATION = @Typesave
				 EXCEPT
				 SELECT
						PPTID
					  , SYS_CHANGE_VERSION
					  , SYS_CHANGE_COLUMNS
						FROM STAGING_HFIT_PPTEligibility_Update_History) 
			 INSERT INTO STAGING_HFIT_PPTEligibility_Update_History (
						 PPTID
					   , LastModifiedDate
					   , SVR
					   , DBNAME
					   , SYS_CHANGE_VERSION
					   , SYS_CHANGE_COLUMNS
					   , SYS_CHANGE_OPERATION
					   , AddressLine1_cg
					   , AddressLine2_cg
					   , BenefitGrp_cg
					   , BenefitStatus_cg
					   , BirthDate_cg
					   , ChangeStatusFlag_cg
					   , City_cg
					   , ClientCMElig_cg
					   , ClientCode_cg
					   , ClientHRAElig_cg
					   , ClientID_cg
					   , ClientIncentiveElig_cg
					   , ClientLMElig_cg
					   , ClientPlatformElig_cg
					   , ClientScreeningElig_cg
					   , Company_cg
					   , CompanyCd_cg
					   , CoverageType_cg
					   , Custom1_cg
					   , Custom10_cg
					   , Custom11_cg
					   , Custom12_cg
					   , Custom13_cg
					   , Custom14_cg
					   , Custom15_cg
					   , Custom2_cg
					   , Custom3_cg
					   , Custom4_cg
					   , Custom5_cg
					   , Custom6_cg
					   , Custom7_cg
					   , Custom8_cg
					   , Custom9_cg
					   , DepartmentCd_cg
					   , DepartmentName_cg
					   , Division_cg
					   , EmailAddress_cg
					   , EmployeeStatus_cg
					   , EmployeeType_cg
					   , FirstName_cg
					   , FlatFileName_cg
					   , Gender_cg
					   , Hashbyte_Checksum_cg
					   , HireDate_cg
					   , HomePhoneNum_cg
					   , IDCard_cg
					   , ItemGUID_cg
					   , JobCd_cg
					   , JobTitle_cg
					   , Last_Update_Dt_cg
					   , LastName_cg
					   , LocationCd_cg
					   , LocationName_cg
					   , MaritalStatus_cg
					   , MatchMethodCode_cg
					   , MiddleInit_cg
					   , MobilePhoneNum_cg
					   , MPI_cg
					   , MPI_Relationship_Type_cg
					   , PayCd_cg
					   , PayGrp_cg
					   , PersonStatus_cg
					   , PersonType_cg
					   , PlanDescription_cg
					   , PlanEndDate_cg
					   , PlanID_cg
					   , PlanName_cg
					   , PlanStartDate_cg
					   , PlanType_cg
					   , PostalCode_cg
					   , PPTID_cg
					   , Primary_MPI_cg
					   , PrimarySSN_cg
					   , RetireeDate_cg
					   , SSN_cg
					   , State_cg
					   , TeamName_cg
					   , TermDate_cg
					   , UnionCd_cg
					   , UserID_cg
					   , WorkInd_cg
					   , WorkPhoneNum_cg,commit_time) 
			 SELECT
					CTE.PPTID
				  , GETDATE () AS LastModifiedDate
				  , @@Servername AS SVR
				  , DB_NAME () AS DBNAME
				  , CTE.SYS_CHANGE_VERSION
				  , CTE.SYS_CHANGE_COLUMNS
				  , @Typesave AS SYS_CHANGE_OPERATION
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'AddressLine1', 'columnid') , CTE.sys_change_columns) AS AddressLine1_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'AddressLine2', 'columnid') , CTE.sys_change_columns) AS AddressLine2_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'BenefitGrp', 'columnid') , CTE.sys_change_columns) AS BenefitGrp_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'BenefitStatus', 'columnid') , CTE.sys_change_columns) AS BenefitStatus_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'BirthDate', 'columnid') , CTE.sys_change_columns) AS BirthDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ChangeStatusFlag', 'columnid') , CTE.sys_change_columns) AS ChangeStatusFlag_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'City', 'columnid') , CTE.sys_change_columns) AS City_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientCMElig', 'columnid') , CTE.sys_change_columns) AS ClientCMElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientCode', 'columnid') , CTE.sys_change_columns) AS ClientCode_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientHRAElig', 'columnid') , CTE.sys_change_columns) AS ClientHRAElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientID', 'columnid') , CTE.sys_change_columns) AS ClientID_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientIncentiveElig', 'columnid') , CTE.sys_change_columns) AS ClientIncentiveElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientLMElig', 'columnid') , CTE.sys_change_columns) AS ClientLMElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientPlatformElig', 'columnid') , CTE.sys_change_columns) AS ClientPlatformElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientScreeningElig', 'columnid') , CTE.sys_change_columns) AS ClientScreeningElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Company', 'columnid') , CTE.sys_change_columns) AS Company_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'CompanyCd', 'columnid') , CTE.sys_change_columns) AS CompanyCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'CoverageType', 'columnid') , CTE.sys_change_columns) AS CoverageType_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom1', 'columnid') , CTE.sys_change_columns) AS Custom1_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom10', 'columnid') , CTE.sys_change_columns) AS Custom10_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom11', 'columnid') , CTE.sys_change_columns) AS Custom11_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom12', 'columnid') , CTE.sys_change_columns) AS Custom12_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom13', 'columnid') , CTE.sys_change_columns) AS Custom13_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom14', 'columnid') , CTE.sys_change_columns) AS Custom14_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom15', 'columnid') , CTE.sys_change_columns) AS Custom15_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom2', 'columnid') , CTE.sys_change_columns) AS Custom2_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom3', 'columnid') , CTE.sys_change_columns) AS Custom3_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom4', 'columnid') , CTE.sys_change_columns) AS Custom4_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom5', 'columnid') , CTE.sys_change_columns) AS Custom5_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom6', 'columnid') , CTE.sys_change_columns) AS Custom6_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom7', 'columnid') , CTE.sys_change_columns) AS Custom7_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom8', 'columnid') , CTE.sys_change_columns) AS Custom8_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom9', 'columnid') , CTE.sys_change_columns) AS Custom9_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'DepartmentCd', 'columnid') , CTE.sys_change_columns) AS DepartmentCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'DepartmentName', 'columnid') , CTE.sys_change_columns) AS DepartmentName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Division', 'columnid') , CTE.sys_change_columns) AS Division_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'EmailAddress', 'columnid') , CTE.sys_change_columns) AS EmailAddress_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'EmployeeStatus', 'columnid') , CTE.sys_change_columns) AS EmployeeStatus_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'EmployeeType', 'columnid') , CTE.sys_change_columns) AS EmployeeType_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'FirstName', 'columnid') , CTE.sys_change_columns) AS FirstName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'FlatFileName', 'columnid') , CTE.sys_change_columns) AS FlatFileName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Gender', 'columnid') , CTE.sys_change_columns) AS Gender_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Hashbyte_Checksum', 'columnid') , CTE.sys_change_columns) AS Hashbyte_Checksum_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'HireDate', 'columnid') , CTE.sys_change_columns) AS HireDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'HomePhoneNum', 'columnid') , CTE.sys_change_columns) AS HomePhoneNum_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'IDCard', 'columnid') , CTE.sys_change_columns) AS IDCard_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ItemGUID', 'columnid') , CTE.sys_change_columns) AS ItemGUID_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'JobCd', 'columnid') , CTE.sys_change_columns) AS JobCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'JobTitle', 'columnid') , CTE.sys_change_columns) AS JobTitle_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Last_Update_Dt', 'columnid') , CTE.sys_change_columns) AS Last_Update_Dt_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'LastName', 'columnid') , CTE.sys_change_columns) AS LastName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'LocationCd', 'columnid') , CTE.sys_change_columns) AS LocationCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'LocationName', 'columnid') , CTE.sys_change_columns) AS LocationName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MaritalStatus', 'columnid') , CTE.sys_change_columns) AS MaritalStatus_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MatchMethodCode', 'columnid') , CTE.sys_change_columns) AS MatchMethodCode_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MiddleInit', 'columnid') , CTE.sys_change_columns) AS MiddleInit_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MobilePhoneNum', 'columnid') , CTE.sys_change_columns) AS MobilePhoneNum_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MPI', 'columnid') , CTE.sys_change_columns) AS MPI_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MPI_Relationship_Type', 'columnid') , CTE.sys_change_columns) AS MPI_Relationship_Type_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PayCd', 'columnid') , CTE.sys_change_columns) AS PayCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PayGrp', 'columnid') , CTE.sys_change_columns) AS PayGrp_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PersonStatus', 'columnid') , CTE.sys_change_columns) AS PersonStatus_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PersonType', 'columnid') , CTE.sys_change_columns) AS PersonType_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanDescription', 'columnid') , CTE.sys_change_columns) AS PlanDescription_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanEndDate', 'columnid') , CTE.sys_change_columns) AS PlanEndDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanID', 'columnid') , CTE.sys_change_columns) AS PlanID_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanName', 'columnid') , CTE.sys_change_columns) AS PlanName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanStartDate', 'columnid') , CTE.sys_change_columns) AS PlanStartDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanType', 'columnid') , CTE.sys_change_columns) AS PlanType_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PostalCode', 'columnid') , CTE.sys_change_columns) AS PostalCode_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PPTID', 'columnid') , CTE.sys_change_columns) AS PPTID_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Primary_MPI', 'columnid') , CTE.sys_change_columns) AS Primary_MPI_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PrimarySSN', 'columnid') , CTE.sys_change_columns) AS PrimarySSN_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'RetireeDate', 'columnid') , CTE.sys_change_columns) AS RetireeDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'SSN', 'columnid') , CTE.sys_change_columns) AS SSN_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'State', 'columnid') , CTE.sys_change_columns) AS State_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'TeamName', 'columnid') , CTE.sys_change_columns) AS TeamName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'TermDate', 'columnid') , CTE.sys_change_columns) AS TermDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'UnionCd', 'columnid') , CTE.sys_change_columns) AS UnionCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'UserID', 'columnid') , CTE.sys_change_columns) AS UserID_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'WorkInd', 'columnid') , CTE.sys_change_columns) AS WorkInd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'WorkPhoneNum', 'columnid') , CTE.sys_change_columns) AS WorkPhoneNum_cg
				  ,tc.commit_time
					FROM
						 CTE
							 JOIN sys.dm_tran_commit_table AS tc
								 ON CTE.sys_change_version = tc.commit_ts;

	 END;

GO
PRINT 'Executed proc_CT_HFIT_PPTEligibility_History.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




-- USE KenticoCMS_PRD_1

/*************************
------------------------
cms_user			    -> DONE
cms_usersettings	  -> DONE
CMS_UserSite	  -> DONE
HFIT_PPTEligibility
cms_usercontact
*************************/
GO
PRINT 'Executing create_table_STAGING_HFIT_PPTEligibility.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'STAGING_HFIT_PPTEligibility_Audit') 
    BEGIN
        DROP TABLE
             STAGING_HFIT_PPTEligibility_Audit;
    END;
GO

CREATE TABLE dbo.STAGING_HFIT_PPTEligibility_Audit (
             PPTID int NOT NULL
           , SVR nvarchar (100) NOT NULL
           , DBNAME nvarchar (100) NOT NULL
           , SYS_CHANGE_VERSION int NULL
           , SYS_CHANGE_OPERATION nvarchar (10) NULL
           , SchemaName nvarchar (100) NULL
           , SysUser nvarchar (100) NULL
           , IPADDR nvarchar (50) NULL
           , Processed integer NULL
           , TBL nvarchar (100) NULL
           , CreateDate datetime NULL
           , commit_time datetime NULL) ;
GO
ALTER TABLE dbo.STAGING_HFIT_PPTEligibility_Audit
ADD
            CONSTRAINT DF_STAGING_HFIT_PPTEligibility_Audit_CreateDate DEFAULT GETDATE () FOR CreateDate;
GO

CREATE CLUSTERED INDEX PK_HFIT_PPTEligibility_Audit ON dbo.STAGING_HFIT_PPTEligibility_Audit (PPTID ASC, SVR ASC, SYS_CHANGE_VERSION ASC, SYS_CHANGE_OPERATION ASC) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

GO

IF NOT EXISTS (SELECT
					  sys.tables.name AS Table_name
					  FROM
						   sys.change_tracking_tables
							   JOIN sys.tables
								   ON sys.tables.object_id = sys.change_tracking_tables.object_id
							   JOIN sys.schemas
								   ON sys.schemas.schema_id = sys.tables.schema_id
					  WHERE sys.tables.name = 'HFIT_PPTEligibility') 
	BEGIN
		PRINT 'ADDING Change Tracking to HFIT_PPTEligibility';
		ALTER TABLE dbo.HFIT_PPTEligibility ENABLE CHANGE_TRACKING
				WITH (TRACK_COLUMNS_UPDATED = ON) ;
	END;
ELSE
	BEGIN
		PRINT 'Change Tracking exists on HFIT_PPTEligibility';
	END;
GO
IF EXISTS (SELECT
				  name
				  FROM sys.procedures
				  WHERE name = 'proc_Create_Table_STAGING_HFIT_PPTEligibility') 
	BEGIN
		DROP PROCEDURE
			 proc_Create_Table_STAGING_HFIT_PPTEligibility;
	END;
GO
-- exec proc_Create_Table_STAGING_HFIT_PPTEligibility
-- select top 100 * from [STAGING_HFIT_PPTEligibility]
CREATE PROCEDURE proc_Create_Table_STAGING_HFIT_PPTEligibility
AS
	 BEGIN

		 IF EXISTS (SELECT
						   name
						   FROM sys.tables
						   WHERE name = 'STAGING_HFIT_PPTEligibility') 
			 BEGIN
				 DROP TABLE
					  dbo.STAGING_HFIT_PPTEligibility;
			 END;

		 SET ANSI_NULLS ON;
		 SET QUOTED_IDENTIFIER ON;

		 CREATE TABLE dbo.STAGING_HFIT_PPTEligibility (
					  PPTID int NOT NULL
					, ClientID varchar (27) NULL
					, ClientCode varchar (12) NULL
					, UserID int NULL
					, IDCard nvarchar (25) NULL
					, FirstName varchar (50) NOT NULL
					, LastName varchar (50) NOT NULL
					, MiddleInit varchar (2) NULL
					, BirthDate datetime2 (7) NULL
					, Gender nvarchar (1) NULL
					, AddressLine1 varchar (50) NULL
					, AddressLine2 varchar (50) NULL
					, City varchar (30) NULL
					, State varchar (2) NULL
					, PostalCode varchar (10) NULL
					, HomePhoneNum varchar (12) NULL
					, WorkPhoneNum varchar (12) NULL
					, MobilePhoneNum varchar (12) NULL
					, EmailAddress varchar (50) NULL
					, MPI varchar (50) NOT NULL
					, MatchMethodCode nvarchar (25) NULL
					, SSN varchar (11) NULL
					, PrimarySSN varchar (11) NULL
					, HireDate datetime2 (7) NULL
					, TermDate datetime2 (7) NULL
					, RetireeDate datetime2 (7) NULL
					, PlanName varchar (50) NULL
					, PlanDescription varchar (50) NULL
					, PlanID varchar (25) NULL
					, PlanStartDate datetime2 (7) NULL
					, PlanEndDate datetime2 (7) NULL
					, Company varchar (50) NULL
					, CompanyCd varchar (20) NULL
					, LocationName varchar (50) NULL
					, LocationCd varchar (20) NULL
					, DepartmentName varchar (50) NULL
					, DepartmentCd varchar (20) NULL
					, UnionCd varchar (30) NULL
					, BenefitGrp varchar (20) NULL
					, PayGrp varchar (20) NULL
					, Division varchar (30) NULL
					, JobTitle varchar (50) NULL
					, JobCd varchar (20) NULL
					, TeamName varchar (30) NULL
					, MaritalStatus varchar (30) NULL
					, PersonType varchar (30) NULL
					, PersonStatus varchar (30) NULL
					, EmployeeType varchar (30) NULL
					, CoverageType varchar (30) NULL
					, EmployeeStatus varchar (30) NULL
					, PayCd varchar (30) NULL
					, BenefitStatus varchar (30) NULL
					, PlanType varchar (20) NULL
					, ClientPlatformElig bit NULL
					, ClientHRAElig bit NULL
					, ClientLMElig bit NULL
					, ClientIncentiveElig bit NULL
					, ClientCMElig bit NULL
					, ClientScreeningElig bit NULL
					, Custom1 varchar (50) NULL
					, Custom2 varchar (50) NULL
					, Custom3 varchar (50) NULL
					, Custom4 varchar (50) NULL
					, Custom5 varchar (50) NULL
					, Custom6 varchar (50) NULL
					, Custom7 varchar (50) NULL
					, Custom8 varchar (50) NULL
					, Custom9 varchar (50) NULL
					, Custom10 varchar (50) NULL
					, Custom11 varchar (50) NULL
					, Custom12 varchar (50) NULL
					, Custom13 varchar (50) NULL
					, Custom14 varchar (50) NULL
					, Custom15 varchar (50) NULL
					, ChangeStatusFlag nvarchar (1) NULL
					, Last_Update_Dt datetime2 (7) NULL
					, FlatFileName nvarchar (500) NULL
					, ItemGUID uniqueidentifier NOT NULL
					, Hashbyte_Checksum varchar (32) NULL
					, Primary_MPI nvarchar (50) NULL
					, MPI_Relationship_Type varchar (50) NULL
					, WorkInd bit NULL
					, LastModifiedDate datetime NULL
					, RowNbr int NULL
					, DeletedFlg bit NULL
					, TimeZone nvarchar (10) NULL
					, ConvertedToCentralTime bit NULL
					, SVR nvarchar (100) NOT NULL
					, DBNAME nvarchar (100) NOT NULL
					, SYS_CHANGE_VERSION int NULL) 
		 ON [PRIMARY];

		 ALTER TABLE dbo.STAGING_HFIT_PPTEligibility
		 ADD
					 DEFAULT @@Servername FOR SVR;
		 ALTER TABLE dbo.STAGING_HFIT_PPTEligibility
		 ADD
					 DEFAULT DB_NAME () FOR DBNAME;

		 CREATE CLUSTERED INDEX PI_STAGING_HFIT_PPTEligibility ON dbo.STAGING_HFIT_PPTEligibility (PPTID ASC, SVR ASC, DBNAME ASC, SYS_CHANGE_VERSION ASC) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

		 --SET IDENTITY_INSERT STAGING_HFIT_PPTEligibility ON;

		 INSERT INTO STAGING_HFIT_PPTEligibility (
					 PPTID
				   , ClientID
				   , ClientCode
				   , UserID
				   , IDCard
				   , FirstName
				   , LastName
				   , MiddleInit
				   , BirthDate
				   , Gender
				   , AddressLine1
				   , AddressLine2
				   , City
				   , State
				   , PostalCode
				   , HomePhoneNum
				   , WorkPhoneNum
				   , MobilePhoneNum
				   , EmailAddress
				   , MPI
				   , MatchMethodCode
				   , SSN
				   , PrimarySSN
				   , HireDate
				   , TermDate
				   , RetireeDate
				   , PlanName
				   , PlanDescription
				   , PlanID
				   , PlanStartDate
				   , PlanEndDate
				   , Company
				   , CompanyCd
				   , LocationName
				   , LocationCd
				   , DepartmentName
				   , DepartmentCd
				   , UnionCd
				   , BenefitGrp
				   , PayGrp
				   , Division
				   , JobTitle
				   , JobCd
				   , TeamName
				   , MaritalStatus
				   , PersonType
				   , PersonStatus
				   , EmployeeType
				   , CoverageType
				   , EmployeeStatus
				   , PayCd
				   , BenefitStatus
				   , PlanType
				   , ClientPlatformElig
				   , ClientHRAElig
				   , ClientLMElig
				   , ClientIncentiveElig
				   , ClientCMElig
				   , ClientScreeningElig
				   , Custom1
				   , Custom2
				   , Custom3
				   , Custom4
				   , Custom5
				   , Custom6
				   , Custom7
				   , Custom8
				   , Custom9
				   , Custom10
				   , Custom11
				   , Custom12
				   , Custom13
				   , Custom14
				   , Custom15
				   , ChangeStatusFlag
				   , Last_Update_Dt
				   , FlatFileName
				   , ItemGUID
				   , Hashbyte_Checksum
				   , Primary_MPI
				   , MPI_Relationship_Type
				   , WorkInd) 
		 SELECT
				PPTID
			  , ClientID
			  , ClientCode
			  , UserID
			  , IDCard
			  , FirstName
			  , LastName
			  , MiddleInit
			  , BirthDate
			  , Gender
			  , AddressLine1
			  , AddressLine2
			  , City
			  , State
			  , PostalCode
			  , HomePhoneNum
			  , WorkPhoneNum
			  , MobilePhoneNum
			  , EmailAddress
			  , MPI
			  , MatchMethodCode
			  , SSN
			  , PrimarySSN
			  , HireDate
			  , TermDate
			  , RetireeDate
			  , PlanName
			  , PlanDescription
			  , PlanID
			  , PlanStartDate
			  , PlanEndDate
			  , Company
			  , CompanyCd
			  , LocationName
			  , LocationCd
			  , DepartmentName
			  , DepartmentCd
			  , UnionCd
			  , BenefitGrp
			  , PayGrp
			  , Division
			  , JobTitle
			  , JobCd
			  , TeamName
			  , MaritalStatus
			  , PersonType
			  , PersonStatus
			  , EmployeeType
			  , CoverageType
			  , EmployeeStatus
			  , PayCd
			  , BenefitStatus
			  , PlanType
			  , ClientPlatformElig
			  , ClientHRAElig
			  , ClientLMElig
			  , ClientIncentiveElig
			  , ClientCMElig
			  , ClientScreeningElig
			  , Custom1
			  , Custom2
			  , Custom3
			  , Custom4
			  , Custom5
			  , Custom6
			  , Custom7
			  , Custom8
			  , Custom9
			  , Custom10
			  , Custom11
			  , Custom12
			  , Custom13
			  , Custom14
			  , Custom15
			  , ChangeStatusFlag
			  , Last_Update_Dt
			  , FlatFileName
			  , ItemGUID
			  , Hashbyte_Checksum
			  , Primary_MPI
			  , MPI_Relationship_Type
			  , WorkInd
				FROM HFIT_PPTEligibility;

		 --SET IDENTITY_INSERT STAGING_HFIT_PPTEligibility OFF;

		 IF EXISTS (SELECT
						   name
						   FROM sys.tables
						   WHERE name = 'STAGING_HFIT_PPTEligibility_Update_History') 
			 BEGIN
				 PRINT 'dropping and recreating STAGING_HFIT_PPTEligibility_Update_History';
				 DROP TABLE
					  STAGING_HFIT_PPTEligibility_Update_History;
			 END;

		 CREATE TABLE dbo.STAGING_HFIT_PPTEligibility_Update_History (
					  PPTID int NOT NULL
					, AddressLine1_cg int NULL
					, AddressLine2_cg int NULL
					, BenefitGrp_cg int NULL
					, BenefitStatus_cg int NULL
					, BirthDate_cg int NULL
					, ChangeStatusFlag_cg int NULL
					, City_cg int NULL
					, ClientCMElig_cg int NULL
					, ClientCode_cg int NULL
					, ClientHRAElig_cg int NULL
					, ClientID_cg int NULL
					, ClientIncentiveElig_cg int NULL
					, ClientLMElig_cg int NULL
					, ClientPlatformElig_cg int NULL
					, ClientScreeningElig_cg int NULL
					, Company_cg int NULL
					, CompanyCd_cg int NULL
					, CoverageType_cg int NULL
					, Custom1_cg int NULL
					, Custom10_cg int NULL
					, Custom11_cg int NULL
					, Custom12_cg int NULL
					, Custom13_cg int NULL
					, Custom14_cg int NULL
					, Custom15_cg int NULL
					, Custom2_cg int NULL
					, Custom3_cg int NULL
					, Custom4_cg int NULL
					, Custom5_cg int NULL
					, Custom6_cg int NULL
					, Custom7_cg int NULL
					, Custom8_cg int NULL
					, Custom9_cg int NULL
					, DepartmentCd_cg int NULL
					, DepartmentName_cg int NULL
					, Division_cg int NULL
					, EmailAddress_cg int NULL
					, EmployeeStatus_cg int NULL
					, EmployeeType_cg int NULL
					, FirstName_cg int NULL
					, FlatFileName_cg int NULL
					, Gender_cg int NULL
					, Hashbyte_Checksum_cg int NULL
					, HireDate_cg int NULL
					, HomePhoneNum_cg int NULL
					, IDCard_cg int NULL
					, ItemGUID_cg int NULL
					, JobCd_cg int NULL
					, JobTitle_cg int NULL
					, Last_Update_Dt_cg int NULL
					, LastName_cg int NULL
					, LocationCd_cg int NULL
					, LocationName_cg int NULL
					, MaritalStatus_cg int NULL
					, MatchMethodCode_cg int NULL
					, MiddleInit_cg int NULL
					, MobilePhoneNum_cg int NULL
					, MPI_cg int NULL
					, MPI_Relationship_Type_cg int NULL
					, PayCd_cg int NULL
					, PayGrp_cg int NULL
					, PersonStatus_cg int NULL
					, PersonType_cg int NULL
					, PlanDescription_cg int NULL
					, PlanEndDate_cg int NULL
					, PlanID_cg int NULL
					, PlanName_cg int NULL
					, PlanStartDate_cg int NULL
					, PlanType_cg int NULL
					, PostalCode_cg int NULL
					, PPTID_cg int NULL
					, Primary_MPI_cg int NULL
					, PrimarySSN_cg int NULL
					, RetireeDate_cg int NULL
					, SSN_cg int NULL
					, State_cg int NULL
					, TeamName_cg int NULL
					, TermDate_cg int NULL
					, UnionCd_cg int NULL
					, UserID_cg int NULL
					, WorkInd_cg int NULL
					, WorkPhoneNum_cg int NULL
					, LastModifiedDate datetime DEFAULT GETDATE () 
					, SVR nvarchar (100) NOT NULL
										 DEFAULT @@Servername
					, DBNAME nvarchar (100) NOT NULL
											DEFAULT DB_NAME () 
					, SYS_CHANGE_VERSION int NULL
					, SYS_CHANGE_COLUMNS varbinary (4000) NULL
					, SYS_CHANGE_OPERATION nchar (1) NULL
					, CurrUser nvarchar (100) NULL
											  CONSTRAINT DF_STAGING_HFIT_PPTEligibility_Update_History_CurrUser DEFAULT USER_NAME () 
					, SysUser nvarchar (100) NULL
											 CONSTRAINT DF_STAGING_HFIT_PPTEligibility_Update_History_SysUser DEFAULT SUSER_SNAME () 
					, IPADDR nvarchar (50) NULL
										   CONSTRAINT DF_STAGING_HFIT_PPTEligibility_Update_History_IPADDR DEFAULT CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50))
					,commit_time datetime)
		 ON [PRIMARY];

		 CREATE CLUSTERED INDEX PI_STAGING_HFIT_PPTEligibility_Update_History ON dbo.STAGING_HFIT_PPTEligibility_Update_History (PPTID ASC, SVR ASC, SYS_CHANGE_VERSION ASC) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

	 -- select * from STAGING_HFIT_PPTEligibility_Update_History
	 --ALTER TABLE dbo.STAGING_HFIT_PPTEligibility_Update_History
	 --ADD
	 --            DEFAULT @@servername FOR SVR;
	 --ALTER TABLE dbo.STAGING_HFIT_PPTEligibility_Update_History
	 --ADD
	 --            DEFAULT DB_NAME () FOR DBNAME;

	 END;

GO
PRINT 'Executed create_table_STAGING_HFIT_PPTEligibility.sql';
GO
EXEC proc_Create_Table_STAGING_HFIT_PPTEligibility;
GO
--SELECT * FROM STAGING_HFIT_PPTEligibility_Update_History;
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




-- USE KenticoCMS_PRD_1
/*-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
select top 100 * from HFIT_PPTEligibility
update HFIT_PPTEligibility set UserNickNAme = null where UserSettingsID in (select top 100 UserSettingsID from HFIT_PPTEligibility order by UserSettingsID desc) and UserNickName is null
*/

GO
-- use KenticoCMS_Prod1

/*---------------------------------------
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing
*/

GO
PRINT 'creating proc_STAGING_EDW_HFIT_PPTEligibility';
PRINT GETDATE () ;
GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_STAGING_EDW_HFIT_PPTEligibility') 
    BEGIN
        PRINT 'UPDATING proc_STAGING_EDW_HFIT_PPTEligibility';
        DROP PROCEDURE
             proc_STAGING_EDW_HFIT_PPTEligibility;
    END;

GO

-- exec proc_STAGING_EDW_HFIT_PPTEligibility

CREATE PROCEDURE proc_STAGING_EDW_HFIT_PPTEligibility (
     @ReloadAll AS int = 0) 
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE
    @iTotal AS bigint = 0;

    EXEC @iTotal = proc_QuickRowCount 'STAGING_HFIT_PPTEligibility';

    IF @iTotal <= 1
        BEGIN
            SET @Reloadall = 1;
        END;

    BEGIN

        IF @ReloadAll IS NULL
            BEGIN
                SET @ReloadAll = 0;
            END;

        DECLARE
        @RecordID AS uniqueidentifier = NEWID () ;
        DECLARE
        @CT_DateTimeNow AS datetime = GETDATE () ;
        DECLARE
        @CT_NAME AS nvarchar ( 50) = 'proc_STAGING_EDW_HFIT_PPTEligibility';
        EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'I';

        IF @ReloadAll = 1
            BEGIN
                PRINT 'RELOADING ALL Change Tracking HFIT_PPTEligibility records';
                EXEC proc_Create_Table_STAGING_HFIT_PPTEligibility ;
                PRINT 'RELOAD COMPLETE';
            END;
        ELSE
            BEGIN
                EXEC proc_CT_HFIT_PPTEligibility_AddNewRecs ;
                EXEC proc_CT_HFIT_PPTEligibility_AddUpdatedRecs ;
                EXEC proc_HFIT_PPTEligibility_AddDeletedRecs ;
            END;

    END;
END;

GO
PRINT 'CREATED proc_STAGING_EDW_HFIT_PPTEligibility';
PRINT GETDATE () ;
GO--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating JOB Create_job_EDW_GetStagingData_HFIT_PPTEligibility';
GO

BEGIN TRANSACTION;
DECLARE
@ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS ( SELECT
                       name
                       FROM msdb.dbo.syscategories
                       WHERE
                       name = N'[Uncategorized (Local)]'
                   AND category_class = 1) 
    BEGIN EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB' , @type = N'LOCAL' , @name = N'[Uncategorized (Local)]';
        IF
        @@ERROR <> 0
     OR @ReturnCode <> 0
            BEGIN
                GOTO QuitWithRollback;
            END;

    END;

DECLARE
@TGTDB AS nvarchar ( 50) = DB_NAME () ;

DECLARE
@JNAME AS nvarchar ( 100) = 'job_EDW_GetStagingData_HFIT_PPTEligibility_' + @TGTDB;

IF EXISTS ( SELECT
                   job_id
                   FROM msdb.dbo.sysjobs_view
                   WHERE name = @JNAME) 
    BEGIN EXEC msdb.dbo.sp_delete_job @job_name = @JNAME , @delete_unused_schedule = 1;
    END;

DECLARE
@jobId binary ( 16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME , @enabled = 1 , @notify_level_eventlog = 2 , @notify_level_email = 2 , @notify_level_netsend = 0 , @notify_level_page = 0 , @delete_level = 0 , @description = N'No description available.' , @category_name = N'[Uncategorized (Local)]' , @owner_login_name = N'sa' , @notify_email_operator_name = N'DBA_Notify' , @job_id = @jobId OUTPUT;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;

/*--------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------
***** Object:  Step [Load_STAGING_EDW_HFIT_PPTEligibility]    Script Date: 4/12/2015 9:59:37 AM *****
*/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId , @step_name = N'Load_STAGING_EDW_HFIT_PPTEligibility' , @step_id = 1 , @cmdexec_success_code = 0 , @on_success_action = 1 , @on_success_step_id = 0 , @on_fail_action = 2 , @on_fail_step_id = 0 , @retry_attempts = 0 , @retry_interval = 0 , @os_run_priority = 0 , @subsystem = N'TSQL' , @command = N'exec proc_STAGING_EDW_HFIT_PPTEligibility;' , @database_name = @TGTDB , @flags = 0;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId , @start_step_id = 1;
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId , @name = N'Schedule_STAGING_EDW_HFIT_PPTEligibility' , @enabled = 1 , @freq_type = 4 , @freq_interval = 1 , @freq_subday_type = 8 , @freq_subday_interval = 8 , @freq_relative_interval = 0 , @freq_recurrence_factor = 0 , @active_start_date = 20150412 , @active_end_date = 99991231 , @active_start_time = 10000 ,
@active_end_time = 235959;
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId , @server_name = N'(local)';
IF
@@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN
        GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN
        ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO



--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Executing proc_CT_HFIT_PPTEligibility_History.sql';
GO
IF EXISTS (SELECT
				  name
				  FROM sys.procedures
				  WHERE name = 'proc_CT_HFIT_PPTEligibility_History') 
	BEGIN
		DROP PROCEDURE
			 proc_CT_HFIT_PPTEligibility_History;
	END;
GO

/**************************************************************************

select tc.commit_time, *
from
    changetable(changes HFIT_PPTEligibility, 0) c
    join sys.dm_tran_commit_table tc on c.sys_change_version = tc.commit_ts


exec proc_CT_HFIT_PPTEligibility_History 'I'
exec proc_CT_HFIT_PPTEligibility_History 'D'
exec proc_CT_HFIT_PPTEligibility_History 'U'

truncate table STAGING_HFIT_PPTEligibility_Update_History
select * from STAGING_HFIT_PPTEligibility_Update_History

SELECT CHANGE_TRACKING_MIN_VALID_VERSION(OBJECT_ID('HFIT_PPTEligibility'))
**************************************************************************/

CREATE PROCEDURE proc_CT_HFIT_PPTEligibility_History (@Typesave AS nchar (1)) 
AS
	 BEGIN
		 WITH CTE (
			  PPTID
			, SYS_CHANGE_VERSION
			, SYS_CHANGE_COLUMNS) 
			 AS (SELECT
						CT.PPTID
					  , CT.SYS_CHANGE_VERSION
					  , SYS_CHANGE_COLUMNS
						FROM CHANGETABLE (CHANGES HFIT_PPTEligibility, NULL) AS CT
						WHERE SYS_CHANGE_OPERATION = @Typesave
				 EXCEPT
				 SELECT
						PPTID
					  , SYS_CHANGE_VERSION
					  , SYS_CHANGE_COLUMNS
						FROM STAGING_HFIT_PPTEligibility_Update_History) 
			 INSERT INTO STAGING_HFIT_PPTEligibility_Update_History (
						 PPTID
					   , LastModifiedDate
					   , SVR
					   , DBNAME
					   , SYS_CHANGE_VERSION
					   , SYS_CHANGE_COLUMNS
					   , SYS_CHANGE_OPERATION
					   , AddressLine1_cg
					   , AddressLine2_cg
					   , BenefitGrp_cg
					   , BenefitStatus_cg
					   , BirthDate_cg
					   , ChangeStatusFlag_cg
					   , City_cg
					   , ClientCMElig_cg
					   , ClientCode_cg
					   , ClientHRAElig_cg
					   , ClientID_cg
					   , ClientIncentiveElig_cg
					   , ClientLMElig_cg
					   , ClientPlatformElig_cg
					   , ClientScreeningElig_cg
					   , Company_cg
					   , CompanyCd_cg
					   , CoverageType_cg
					   , Custom1_cg
					   , Custom10_cg
					   , Custom11_cg
					   , Custom12_cg
					   , Custom13_cg
					   , Custom14_cg
					   , Custom15_cg
					   , Custom2_cg
					   , Custom3_cg
					   , Custom4_cg
					   , Custom5_cg
					   , Custom6_cg
					   , Custom7_cg
					   , Custom8_cg
					   , Custom9_cg
					   , DepartmentCd_cg
					   , DepartmentName_cg
					   , Division_cg
					   , EmailAddress_cg
					   , EmployeeStatus_cg
					   , EmployeeType_cg
					   , FirstName_cg
					   , FlatFileName_cg
					   , Gender_cg
					   , Hashbyte_Checksum_cg
					   , HireDate_cg
					   , HomePhoneNum_cg
					   , IDCard_cg
					   , ItemGUID_cg
					   , JobCd_cg
					   , JobTitle_cg
					   , Last_Update_Dt_cg
					   , LastName_cg
					   , LocationCd_cg
					   , LocationName_cg
					   , MaritalStatus_cg
					   , MatchMethodCode_cg
					   , MiddleInit_cg
					   , MobilePhoneNum_cg
					   , MPI_cg
					   , MPI_Relationship_Type_cg
					   , PayCd_cg
					   , PayGrp_cg
					   , PersonStatus_cg
					   , PersonType_cg
					   , PlanDescription_cg
					   , PlanEndDate_cg
					   , PlanID_cg
					   , PlanName_cg
					   , PlanStartDate_cg
					   , PlanType_cg
					   , PostalCode_cg
					   , PPTID_cg
					   , Primary_MPI_cg
					   , PrimarySSN_cg
					   , RetireeDate_cg
					   , SSN_cg
					   , State_cg
					   , TeamName_cg
					   , TermDate_cg
					   , UnionCd_cg
					   , UserID_cg
					   , WorkInd_cg
					   , WorkPhoneNum_cg,commit_time) 
			 SELECT
					CTE.PPTID
				  , GETDATE () AS LastModifiedDate
				  , @@Servername AS SVR
				  , DB_NAME () AS DBNAME
				  , CTE.SYS_CHANGE_VERSION
				  , CTE.SYS_CHANGE_COLUMNS
				  , @Typesave AS SYS_CHANGE_OPERATION
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'AddressLine1', 'columnid') , CTE.sys_change_columns) AS AddressLine1_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'AddressLine2', 'columnid') , CTE.sys_change_columns) AS AddressLine2_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'BenefitGrp', 'columnid') , CTE.sys_change_columns) AS BenefitGrp_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'BenefitStatus', 'columnid') , CTE.sys_change_columns) AS BenefitStatus_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'BirthDate', 'columnid') , CTE.sys_change_columns) AS BirthDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ChangeStatusFlag', 'columnid') , CTE.sys_change_columns) AS ChangeStatusFlag_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'City', 'columnid') , CTE.sys_change_columns) AS City_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientCMElig', 'columnid') , CTE.sys_change_columns) AS ClientCMElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientCode', 'columnid') , CTE.sys_change_columns) AS ClientCode_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientHRAElig', 'columnid') , CTE.sys_change_columns) AS ClientHRAElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientID', 'columnid') , CTE.sys_change_columns) AS ClientID_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientIncentiveElig', 'columnid') , CTE.sys_change_columns) AS ClientIncentiveElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientLMElig', 'columnid') , CTE.sys_change_columns) AS ClientLMElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientPlatformElig', 'columnid') , CTE.sys_change_columns) AS ClientPlatformElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ClientScreeningElig', 'columnid') , CTE.sys_change_columns) AS ClientScreeningElig_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Company', 'columnid') , CTE.sys_change_columns) AS Company_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'CompanyCd', 'columnid') , CTE.sys_change_columns) AS CompanyCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'CoverageType', 'columnid') , CTE.sys_change_columns) AS CoverageType_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom1', 'columnid') , CTE.sys_change_columns) AS Custom1_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom10', 'columnid') , CTE.sys_change_columns) AS Custom10_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom11', 'columnid') , CTE.sys_change_columns) AS Custom11_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom12', 'columnid') , CTE.sys_change_columns) AS Custom12_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom13', 'columnid') , CTE.sys_change_columns) AS Custom13_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom14', 'columnid') , CTE.sys_change_columns) AS Custom14_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom15', 'columnid') , CTE.sys_change_columns) AS Custom15_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom2', 'columnid') , CTE.sys_change_columns) AS Custom2_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom3', 'columnid') , CTE.sys_change_columns) AS Custom3_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom4', 'columnid') , CTE.sys_change_columns) AS Custom4_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom5', 'columnid') , CTE.sys_change_columns) AS Custom5_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom6', 'columnid') , CTE.sys_change_columns) AS Custom6_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom7', 'columnid') , CTE.sys_change_columns) AS Custom7_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom8', 'columnid') , CTE.sys_change_columns) AS Custom8_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Custom9', 'columnid') , CTE.sys_change_columns) AS Custom9_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'DepartmentCd', 'columnid') , CTE.sys_change_columns) AS DepartmentCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'DepartmentName', 'columnid') , CTE.sys_change_columns) AS DepartmentName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Division', 'columnid') , CTE.sys_change_columns) AS Division_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'EmailAddress', 'columnid') , CTE.sys_change_columns) AS EmailAddress_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'EmployeeStatus', 'columnid') , CTE.sys_change_columns) AS EmployeeStatus_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'EmployeeType', 'columnid') , CTE.sys_change_columns) AS EmployeeType_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'FirstName', 'columnid') , CTE.sys_change_columns) AS FirstName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'FlatFileName', 'columnid') , CTE.sys_change_columns) AS FlatFileName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Gender', 'columnid') , CTE.sys_change_columns) AS Gender_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Hashbyte_Checksum', 'columnid') , CTE.sys_change_columns) AS Hashbyte_Checksum_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'HireDate', 'columnid') , CTE.sys_change_columns) AS HireDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'HomePhoneNum', 'columnid') , CTE.sys_change_columns) AS HomePhoneNum_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'IDCard', 'columnid') , CTE.sys_change_columns) AS IDCard_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'ItemGUID', 'columnid') , CTE.sys_change_columns) AS ItemGUID_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'JobCd', 'columnid') , CTE.sys_change_columns) AS JobCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'JobTitle', 'columnid') , CTE.sys_change_columns) AS JobTitle_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Last_Update_Dt', 'columnid') , CTE.sys_change_columns) AS Last_Update_Dt_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'LastName', 'columnid') , CTE.sys_change_columns) AS LastName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'LocationCd', 'columnid') , CTE.sys_change_columns) AS LocationCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'LocationName', 'columnid') , CTE.sys_change_columns) AS LocationName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MaritalStatus', 'columnid') , CTE.sys_change_columns) AS MaritalStatus_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MatchMethodCode', 'columnid') , CTE.sys_change_columns) AS MatchMethodCode_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MiddleInit', 'columnid') , CTE.sys_change_columns) AS MiddleInit_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MobilePhoneNum', 'columnid') , CTE.sys_change_columns) AS MobilePhoneNum_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MPI', 'columnid') , CTE.sys_change_columns) AS MPI_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'MPI_Relationship_Type', 'columnid') , CTE.sys_change_columns) AS MPI_Relationship_Type_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PayCd', 'columnid') , CTE.sys_change_columns) AS PayCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PayGrp', 'columnid') , CTE.sys_change_columns) AS PayGrp_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PersonStatus', 'columnid') , CTE.sys_change_columns) AS PersonStatus_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PersonType', 'columnid') , CTE.sys_change_columns) AS PersonType_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanDescription', 'columnid') , CTE.sys_change_columns) AS PlanDescription_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanEndDate', 'columnid') , CTE.sys_change_columns) AS PlanEndDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanID', 'columnid') , CTE.sys_change_columns) AS PlanID_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanName', 'columnid') , CTE.sys_change_columns) AS PlanName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanStartDate', 'columnid') , CTE.sys_change_columns) AS PlanStartDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PlanType', 'columnid') , CTE.sys_change_columns) AS PlanType_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PostalCode', 'columnid') , CTE.sys_change_columns) AS PostalCode_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PPTID', 'columnid') , CTE.sys_change_columns) AS PPTID_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'Primary_MPI', 'columnid') , CTE.sys_change_columns) AS Primary_MPI_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'PrimarySSN', 'columnid') , CTE.sys_change_columns) AS PrimarySSN_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'RetireeDate', 'columnid') , CTE.sys_change_columns) AS RetireeDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'SSN', 'columnid') , CTE.sys_change_columns) AS SSN_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'State', 'columnid') , CTE.sys_change_columns) AS State_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'TeamName', 'columnid') , CTE.sys_change_columns) AS TeamName_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'TermDate', 'columnid') , CTE.sys_change_columns) AS TermDate_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'UnionCd', 'columnid') , CTE.sys_change_columns) AS UnionCd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'UserID', 'columnid') , CTE.sys_change_columns) AS UserID_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'WorkInd', 'columnid') , CTE.sys_change_columns) AS WorkInd_cg
				  , change_tracking_is_column_in_mask (COLUMNPROPERTY (OBJECT_ID ('HFit_PPTEligibility') , 'WorkPhoneNum', 'columnid') , CTE.sys_change_columns) AS WorkPhoneNum_cg
				  ,tc.commit_time
					FROM
						 CTE
							 JOIN sys.dm_tran_commit_table AS tc
								 ON CTE.sys_change_version = tc.commit_ts;

	 END;

GO
PRINT 'Executed proc_CT_HFIT_PPTEligibility_History.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing TRIG_HFIT_PPTEligibility_Audit.SQL';
GO
-- select count(*) from STAGING_HFIT_PPTEligibility_Audit
-- select * from STAGING_HFIT_PPTEligibility_Audit
-- truncate table STAGING_HFIT_PPTEligibility_Audit

IF EXISTS (SELECT
                  name
                  FROM sys.tables
                  WHERE name = 'STAGING_HFIT_PPTEligibility_Audit') 
    BEGIN
        DROP TABLE
             STAGING_HFIT_PPTEligibility_Audit;
    END;
GO

CREATE TABLE dbo.STAGING_HFIT_PPTEligibility_Audit (
             PPTID int NOT NULL
           , SVR nvarchar (100) NOT NULL
           , DBNAME nvarchar (100) NOT NULL
           , SYS_CHANGE_VERSION int NULL
           , SYS_CHANGE_OPERATION nvarchar (10) NULL
           , SchemaName nvarchar (100) NULL
           , SysUser nvarchar (100) NULL
           , IPADDR nvarchar (50) NULL
           , Processed integer NULL
           , TBL nvarchar (100) NULL
           , CreateDate datetime NULL
           , commit_time datetime NULL) ;
GO
ALTER TABLE dbo.STAGING_HFIT_PPTEligibility_Audit
ADD
            CONSTRAINT DF_STAGING_HFIT_PPTEligibility_Audit_CreateDate DEFAULT GETDATE () FOR CreateDate;
GO

CREATE CLUSTERED INDEX PK_HFIT_PPTEligibility_Audit ON dbo.STAGING_HFIT_PPTEligibility_Audit (PPTID ASC, SVR ASC, SYS_CHANGE_VERSION ASC, SYS_CHANGE_OPERATION ASC) WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];

GO

/*----------------------------------------------------------------------------------------------------------------------------------
**********************************************************************************************************************************
-- TROUBLESHOOTING AND TESTING QRYS
	select count(*) from HFIT_PPTEligibility where UserID = 53 and SiteID = 36
	INSERT INTO HFIT_PPTEligibility (UserID, SiteID) VALUES (53, 36) ;
	delete from HFIT_PPTEligibility where UserID = 53 and SiteID = 36
	select top 1000 * from CMS_User
	select top 1000 * from HFIT_PPTEligibility
	update HFIT_PPTEligibility set FirstName = FirstName where PPTID in (Select top 100 PPTID from HFIT_PPTEligibility order by PPTID )
	select * from STAGING_HFIT_PPTEligibility_Audit
	truncate table  STAGING_HFIT_PPTEligibility_Audit
**********************************************************************************************************************************
*/

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_INS_HFIT_PPTEligibility_Audit') 
    BEGIN
        DROP TRIGGER
             trig_INS_HFIT_PPTEligibility_Audit;
    END;
GO

CREATE TRIGGER trig_INS_HFIT_PPTEligibility_Audit ON HFIT_PPTEligibility
    AFTER INSERT
AS
BEGIN

    DECLARE @Svr nvarchar (100) = (SELECT
                                          @@Servername);
    DECLARE @Db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CurrChg_Ver int = (SELECT
                                       MAX (CT.SYS_CHANGE_VERSION) 
                                       FROM CHANGETABLE (CHANGES HFIT_PPTEligibility, NULL) AS CT);

    DECLARE @Chg_Ver int = @CurrChg_Ver - 1;

    DECLARE @Ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)));
    DECLARE @Userid nvarchar (50) = (SELECT
                                            USER_NAME ());
    DECLARE @Sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);

    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES HFIT_PPTEligibility, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);

    INSERT INTO STAGING_HFIT_PPTEligibility_Audit (
           PPTID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL
         , commit_time) 
    SELECT
           PPTID
         , @Svr
         , @Db
         , @Chg_Ver
         , 'I'
         , @Userid
         , @Sysuser
         , @Ipaddr
         , 0 AS Processed
         , 'HFIT_PPTEligibility'
         , @Commit_Time
           FROM Inserted;
END;

GO

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_UPDT_HFIT_PPTEligibility_Audit') 
    BEGIN
        DROP TRIGGER
             trig_UPDT_HFIT_PPTEligibility_Audit;
    END;
GO

CREATE TRIGGER trig_UPDT_HFIT_PPTEligibility_Audit ON HFIT_PPTEligibility
    AFTER UPDATE
AS
BEGIN
    DECLARE @Next_Baseline bigint;
    SET @Next_Baseline = CHANGE_TRACKING_CURRENT_VERSION () ;
    DECLARE @Svr nvarchar (100) = (SELECT
                                          @@Servername);
    DECLARE @Db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CurrChg_Ver int = (SELECT
                                       MAX (CT.SYS_CHANGE_VERSION) 
                                       FROM CHANGETABLE (CHANGES HFIT_PPTEligibility, NULL) AS CT);

    DECLARE @Chg_Ver int = @CurrChg_Ver - 1;
    DECLARE @Ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)));
    DECLARE @Userid nvarchar (50) = (SELECT
                                            USER_NAME ());
    DECLARE @Sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);

    --exec @Chg_Ver = proc_CT_getPrevVer 'HFIT_PPTEligibility' ;
    --print @Chg_Ver ;

    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES HFIT_PPTEligibility, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);
    SET @Chg_Ver = @Chg_Ver - 1;

    INSERT INTO STAGING_HFIT_PPTEligibility_Audit (
           PPTID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL
         , commit_time) 
    SELECT
           PPTID
         , @Svr
         , @Db
         , @Chg_Ver
         , 'U'
         , @Userid
         , @Sysuser
         , @Ipaddr
         , 0 AS Processed
         , 'HFIT_PPTEligibility'
         , @Commit_Time
           FROM Inserted;
END;

GO

IF EXISTS (SELECT
                  name
                  FROM sys.triggers
                  WHERE name = 'trig_DEL_HFIT_PPTEligibility_Audit') 
    BEGIN
        DROP TRIGGER
             trig_DEL_HFIT_PPTEligibility_Audit;
    END;
GO

CREATE TRIGGER trig_DEL_HFIT_PPTEligibility_Audit ON HFIT_PPTEligibility
    AFTER DELETE
AS
BEGIN

    DECLARE @Svr nvarchar (100) = (SELECT
                                          @@Servername);
    DECLARE @Db nvarchar (100) = (SELECT
                                         DB_NAME ());
    DECLARE @CurrChg_Ver int = (SELECT
                                       MAX (CT.SYS_CHANGE_VERSION) 
                                       FROM CHANGETABLE (CHANGES HFIT_PPTEligibility, NULL) AS CT);

    DECLARE @Chg_Ver int = @CurrChg_Ver - 1;

    DECLARE @Ipaddr nvarchar (50) = (SELECT
                                            CAST (CONNECTIONPROPERTY ('client_net_address') AS nvarchar (50)));
    DECLARE @Userid nvarchar (50) = (SELECT
                                            USER_NAME ());
    DECLARE @Sysuser nvarchar (50) = (SELECT
                                             SYSTEM_USER);
    EXEC @Chg_Ver = proc_CT_getPrevVer 'HFIT_PPTEligibility';
    PRINT @Chg_Ver;

    DECLARE @Commit_Time datetime = (SELECT TOP 1
                                            tc.commit_time
                                            FROM
                                                CHANGETABLE (CHANGES HFIT_PPTEligibility, @Chg_Ver) c
                                                    JOIN sys.dm_tran_commit_table AS tc
                                                        ON c.sys_change_version = tc.commit_ts);

    SET @Chg_Ver = @Chg_Ver - 1;

    INSERT INTO STAGING_HFIT_PPTEligibility_Audit (
           PPTID
         , SVR
         , DBNAME
         , SYS_CHANGE_VERSION
         , SYS_CHANGE_OPERATION
         , SchemaName
         , SysUser
         , IPADDR
         , Processed
         , TBL
         , commit_time) 
    SELECT
           PPTID
         , @Svr
         , @Db
         , @Chg_Ver
         , 'D'
         , @Userid
         , @Sysuser
         , @Ipaddr
         , 0 AS Processed
         , 'HFIT_PPTEligibility'
         , @Commit_Time
           FROM DELETED;
END;

GO
PRINT 'EXECUTED TRIG_HFIT_PPTEligibility_Audit.SQL';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;






GO
PRINT 'Executing view_AUDIT_HFit_PPTEligibility.sql';
GO
IF EXISTS (SELECT
                  name
                  FROM sys.views
                  WHERE name = 'view_AUDIT_HFit_PPTEligibility') 
    BEGIN
        DROP VIEW
             view_AUDIT_HFit_PPTEligibility;
    END;

GO

/*------------------------------------------------------
    select top 100 * from STAGING_HFit_PPTEligibility
    select top 1000 * from STAGING_HFit_PPTEligibility_Update_History
    select top 1000 * from STAGING_HFit_PPTEligibility_Audit
*/

-- select top 1000 * from view_AUDIT_HFit_PPTEligibility order by PPTID
/*------------------------------------------------------------------------------
HOW TO USE:
    select * from view_AUDIT_HFit_PPTEligibility
	   where CreateDate between '2015-09-18 14:55:33.000' and '2015-09-18 14:55:34'

    select * from view_AUDIT_HFit_PPTEligibility
	   where SysUser = 'dmiller'
*/

CREATE VIEW view_AUDIT_HFit_PPTEligibility
AS SELECT
          A.SysUser
        , A.IPADDR
        , A.CreateDate as DateModified
        , A.SYS_CHANGE_OPERATION
        , A.SYS_CHANGE_VERSION as SysChangeVersion
        , S.*
          FROM
              STAGING_HFit_PPTEligibility_Audit AS A
                  JOIN STAGING_HFit_PPTEligibility AS S
                      ON S.PPTID = A.PPTID;
GO
PRINT 'Executed view_AUDIT_HFit_PPTEligibility.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;




-- POSSIBLE SOLUTION TO RETRIEVING THE BMI CALCULATION
--****************************************************************************************************************

GO
PRINT 'Executing proc_Create_BMI_StagingData.sql';
GO

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE name = 'PI_55552_BmiXover') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_55552_BmiXover
        ON dbo.HFit_HealthAssesmentUserQuestion (CodeName) 
        INCLUDE (ItemID, UserID, HARiskAreaItemID) ;
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE name = 'PI_55552_BmiXover_Results') 
    BEGIN
        CREATE NONCLUSTERED INDEX PI_55552_BmiXover_Results
        ON dbo.HFit_HealthAssesmentUserQuestionGroupResults (CodeName) 
        INCLUDE (UserID, HARiskAreaItemID) ;
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.tables
                      WHERE name = 'STAGED_BMI_DATA') 
    BEGIN
        CREATE TABLE dbo.STAGED_BMI_DATA (
                     UserID bigint NOT NULL
                   , HFitUserMpiNumber bigint NULL
                   , Height nvarchar (255) NULL
                   , Weight nvarchar (255) NULL
                   , BMI float NULL
                   , HAStartedDT datetime NULL
                   , HACompetedDT datetime NULL
        );
    END;

IF NOT EXISTS (SELECT
                      name
                      FROM sys.indexes
                      WHERE name = 'PK_StagedBmiData') 
    BEGIN
        CREATE CLUSTERED INDEX PK_StagedBmiData ON dbo.STAGED_BMI_DATA
        (
        UserID ASC,
        HFitUserMpiNumber ASC,
        BMI ASC
        )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
    END;

truncate TABLE STAGED_BMI_DATA;
-- select top 100 * from view_hfit_healthassesmentuserresponses
INSERT INTO STAGED_BMI_DATA
SELECT  DISTINCT
       t1.UserID
     , US.HFitUserMpiNumber
     , t1.HAAnswerValue AS Height
     , t2.HAAnswerValue AS Weight
     , ROUND ( CAST (t2.HAAnswerValue AS float) * 703 / CAST (t1.HAAnswerValue AS float) * CAST (t1.HAAnswerValue AS float) , 1) AS BMI
     , t1.HAStartedDT
     , t1.HACompletedDT
       FROM
           CMS_USER AS U
               JOIN CMS_UserSettings AS US
                   ON U.UserID = US.UserSettingsID
               JOIN view_hfit_healthassesmentuserresponses AS t1
                   ON t1.UserID = U.UserID
               INNER JOIN view_hfit_healthassesmentuserresponses AS t2
                   ON t1.UserID = t2.UserID
                  AND t1.UserModuleItemID = t2.UserModuleItemID
       WHERE   t1.QuestionGroupCodeName = 'BMI'
           AND t1.UserQuestionCodeName = 'Height'
           AND t2.UserQuestionCodeName = 'Weight';
--****************************************************************************************************************
PRINT 'CREATING proc_Create_BMI_StagingData.sql';
GO

IF EXISTS (SELECT
                  name
                  FROM sys.procedures
                  WHERE name = 'proc_Create_BMI_StagingData') 
    BEGIN
        DROP PROCEDURE
             proc_Create_BMI_StagingData;
    END;
GO

-- exec proc_Create_BMI_StagingData
CREATE PROCEDURE proc_Create_BMI_StagingData
AS
BEGIN
    IF NOT EXISTS (SELECT
                          name
                          FROM sys.indexes
                          WHERE name = 'PI_55552_BmiXover') 
        BEGIN
            CREATE NONCLUSTERED INDEX PI_55552_BmiXover
            ON dbo.HFit_HealthAssesmentUserQuestion (CodeName) 
            INCLUDE (ItemID, UserID, HARiskAreaItemID) ;
        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.indexes
                          WHERE name = 'PI_55552_BmiXover_Results') 
        BEGIN
            CREATE NONCLUSTERED INDEX PI_55552_BmiXover_Results
            ON dbo.HFit_HealthAssesmentUserQuestionGroupResults (CodeName) 
            INCLUDE (UserID, HARiskAreaItemID) ;
        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.tables
                          WHERE name = 'STAGED_BMI_DATA') 
        BEGIN
            CREATE TABLE dbo.STAGED_BMI_DATA (
                         UserID bigint NOT NULL
                       , HFitUserMpiNumber bigint NULL
                       , Height nvarchar (255) NULL
                       , Weight nvarchar (255) NULL
                       , BMI float NULL
                       , HAStartedDT datetime NULL
                       , HACompetedDT datetime NULL
            );
        END;

    IF NOT EXISTS (SELECT
                          name
                          FROM sys.indexes
                          WHERE name = 'PK_StagedBmiData') 
        BEGIN
            CREATE CLUSTERED INDEX PK_StagedBmiData ON dbo.STAGED_BMI_DATA
            (
            UserID ASC,
            HFitUserMpiNumber ASC,
            BMI ASC
            )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY];
        END;

    truncate TABLE STAGED_BMI_DATA;
    -- select top 1000 * from STAGED_BMI_DATA
    INSERT INTO STAGED_BMI_DATA
    SELECT  DISTINCT
           t1.UserID
         , US.HFitUserMpiNumber
         , t1.HAAnswerValue AS Height
         , t2.HAAnswerValue AS Weight
         , ROUND ( CAST (t2.HAAnswerValue AS float) * 703 / CAST (t1.HAAnswerValue AS float) * CAST (t1.HAAnswerValue AS float) , 1) AS BMI
         , t1.HAStartedDT
         , t1.HACompletedDT
           FROM
               CMS_USER AS U
                   JOIN CMS_UserSettings AS US
                       ON U.UserID = US.UserSettingsID
                   JOIN view_hfit_healthassesmentuserresponses AS t1
                       ON t1.UserID = U.UserID
                   INNER JOIN view_hfit_healthassesmentuserresponses AS t2
                       ON t1.UserID = t2.UserID
                      AND t1.UserModuleItemID = t2.UserModuleItemID
           WHERE   t1.QuestionGroupCodeName = 'BMI'
               AND t1.UserQuestionCodeName = 'Height'
               AND t2.UserQuestionCodeName = 'Weight';
END;
GO
PRINT 'Executed proc_Create_BMI_StagingData.sql';
GO
--**************
print('END: ' + cast(getdate() as nvarchar(50)));
print('@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-@-');
print'***************************************************************' ;
print('START: ' + cast(getdate() as nvarchar(50)));
--**************

--SET ANSI_NULLS ON;
--SET ANSI_PADDING ON;
--SET ANSI_WARNINGS ON;
--SET ARITHABORT ON;
--SET CONCAT_NULL_YIELDS_NULL ON;
--SET NUMERIC_ROUNDABORT OFF;
--SET QUOTED_IDENTIFIER ON;





GO
PRINT 'Creating JOB job_Gen_BMI_Staging_Data';
GO

BEGIN TRANSACTION;
DECLARE
@ReturnCode int;
SELECT
       @ReturnCode = 0;

IF NOT EXISTS (SELECT
                      name
                      FROM msdb.dbo.syscategories
                      WHERE name = N'[Uncategorized (Local)]'
                        AND category_class = 1) 
    BEGIN
        EXEC @ReturnCode = msdb.dbo.sp_add_category @class = N'JOB', @type = N'LOCAL', @name = N'[Uncategorized (Local)]';
        IF @@ERROR <> 0
        OR @ReturnCode <> 0
            BEGIN GOTO QuitWithRollback;
            END;

    END;

DECLARE
@TGTDB AS nvarchar (50) = DB_NAME () ;
DECLARE
@JNAME AS nvarchar (100) = 'job_EDW_Generate_BMI_Staging_Data_' + @TGTDB;

IF EXISTS (SELECT
                  job_id
                  FROM msdb.dbo.sysjobs_view
                  WHERE name = @JNAME) 
    BEGIN
        EXEC msdb.dbo.sp_delete_job @job_name = @JNAME, @delete_unused_schedule = 1;
    END;

DECLARE
@jobId binary (16) ;
EXEC @ReturnCode = msdb.dbo.sp_add_job @job_name = @JNAME,
@enabled = 1,
@notify_level_eventlog = 2,
@notify_level_email = 2,
@notify_level_netsend = 0,
@notify_level_page = 0,
@delete_level = 0,
@description = N'No description available.',
@category_name = N'[Uncategorized (Local)]',
@owner_login_name = N'sa',
@notify_email_operator_name = N'DBA_Notify', @job_id = @jobId OUTPUT;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;

/*------------------------------------------------------------------------------------
***** Object:  Step [Load_BMI_Staging_Data]    Script Date: 4/12/2015 9:59:37 AM *****
*/

EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id = @jobId, @step_name = N'Load_BMI_Staging_Data',
@step_id = 1,
@cmdexec_success_code = 0,
@on_success_action = 1,
@on_success_step_id = 0,
@on_fail_action = 2,
@on_fail_step_id = 0,
@retry_attempts = 0,
@retry_interval = 0,
@os_run_priority = 0, @subsystem = N'TSQL',
@command = N'exec proc_Create_BMI_StagingData',
@database_name = @TGTDB,
@flags = 0;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1;
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id = @jobId, @name = N'Schedule_EDW_SmallSteps',
@enabled = 1,
@freq_type = 4,
@freq_interval = 1,
@freq_subday_type = 8,
@freq_subday_interval = 8,
@freq_relative_interval = 0,
@freq_recurrence_factor = 0,
@active_start_date = 20150412,
@active_end_date = 99991231,
@active_start_time = 123000,
@active_end_time = 235959;
--@schedule_uid = N'afcb6980-89fe-4a08-ad03-6598bd55454a';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)';
IF @@ERROR <> 0
OR @ReturnCode <> 0
    BEGIN GOTO QuitWithRollback;
    END;
COMMIT TRANSACTION;
GOTO EndSave;
QuitWithRollback:
IF @@TRANCOUNT > 0
    BEGIN ROLLBACK TRANSACTION;
    END;
EndSave:

PRINT 'CREATED JOB ' + @JNAME;

GO




--START ENDING THE IVP
GO

DECLARE @DBNAME nvarchar (100) ;
DECLARE @ServerName nvarchar (80) ;
SET @ServerName = (SELECT
                          @@SERVERNAME);
SET @DBNAME = (SELECT
                      DB_NAME () AS [Current Database]);

IF @@TRANCOUNT > 0
    BEGIN
	   print 'OPEN Transaction Committed!!'
        COMMIT TRANSACTION
    END;

PRINT '--';
PRINT '*************************************************************************************************************';
PRINT 'IVP Processing complete - please check for errors: on database ' + @DBNAME + ' : ON SERVER : ' + @ServerName + ' ON ' + CAST (GETDATE () AS nvarchar (50)) ;
PRINT '*************************************************************************************************************';
--  
GO
PRINT '***** FROM: TheEnd.sql';
GO 


GO
-- use KenticoCMS_Prod1

GO

PRINT ' FROM view_EDW_HealthAssesment_CT.sql';

PRINT 'Processing view_EDW_HealthAssesment_CT';

/*-------------------------------------------------------------------------------------------------------------------
*******************************************************************************************************************
SELECT count(*) FROM view_EDW_HealthAssesment_CT  WHERE [ChangeType] IS NOT NULL group by [ChangeType] ;	   --6587671
SELECT count(*) FROM view_EDW_HealthAssesment_CT  group by [ChangeType] ;
SELECT count(*) FROM view_EDW_HealthAssesment_CT WHERE [ChangeType] = 'U';    
SELECT top 100 * FROM view_EDW_HealthAssesment_CT WHERE [ChangeType] = 'U';  
*******************************************************************************************************************
*/

GO

IF NOT EXISTS ( SELECT
                       name
                       FROM sys.indexes
                       WHERE name = 'CI_HFit_HealthAssesmentUserRiskArea_HARiskCategoryItemID') 

    BEGIN

        CREATE NONCLUSTERED INDEX CI_HFit_HealthAssesmentUserRiskArea_HARiskCategoryItemID ON dbo.HFit_HealthAssesmentUserRiskArea (
        HARiskCategoryItemID) INCLUDE (
        ItemID
        , HARiskAreaScore
        , ItemModifiedWhen
        , CodeName
        , PreWeightedScore
        , HARiskAreaNodeGUID) ;
    END;

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.views
                   WHERE name = 'view_EDW_HealthAssesment_CT') 

    BEGIN

        DROP VIEW
             view_EDW_HealthAssesment_CT;
    END;

GO

/*------------------------------------------------------------------------
************************************************************************
**************************************************************************
select top 100 * from [view_EDW_HealthAssesment_CT] 

select * 
into #TEMP_HA
from [view_EDW_HealthAssesment_CT] 
where CHANGED_FLG is not null

select * from #TEMP_HA

--07.09.2015 (WDM) - Dea and I discussed the need to capture and present the Health Assessment Type.
--				Mark and I discussed how best to do this and the data, basically, was already in 
--				the view. I added the field HealthAssessmentType to the view.

**************************************************************************
************************************************************************
*/
CREATE VIEW dbo.view_EDW_HealthAssesment_CT
AS SELECT
          HAUserStarted.ItemID AS UserStartedItemID
        , VHAJ.NodeGUID AS HealthAssesmentUserStartedNodeGUID
        , HAUserStarted.UserID
        , CMSUser.UserGUID
        , UserSettings.HFitUserMpiNumber
        , CMSSite.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , ACCT.AccountName
        , HAUserStarted.HAStartedDt
        , HAUserStarted.HACompletedDt
        , HAUserModule.ItemID AS UserModuleItemId
        , HAUserModule.CodeName AS UserModuleCodeName
        , HAUserModule.HAModuleNodeGUID
        , VHAJ.NodeGUID AS CMSNodeGuid
        , NULL AS HAModuleVersionID
        , HARiskCategory.ItemID AS UserRiskCategoryItemID
        , HARiskCategory.CodeName AS UserRiskCategoryCodeName
        , HARiskCategory.HARiskCategoryNodeGUID
        , NULL AS HARiskCategoryVersionID
        , HAUserRiskArea.ItemID AS UserRiskAreaItemID
        , HAUserRiskArea.CodeName AS UserRiskAreaCodeName
        , HAUserRiskArea.HARiskAreaNodeGUID
        , NULL AS HARiskAreaVersionID
        , HAUserQuestion.ItemID AS UserQuestionItemID
        , dbo.udf_StripHTML ( HAQuestionsView.Title) AS Title
        , HAUserQuestion.HAQuestionNodeGUID AS HAQuestionGuid
        , HAUserQuestion.CodeName AS UserQuestionCodeName
        , NULL AS HAQuestionDocumentID
        , NULL AS HAQuestionVersionID
        , HAUserQuestion.HAQuestionNodeGUID
        , HAUserAnswers.ItemID AS UserAnswerItemID
        , HAUserAnswers.HAAnswerNodeGUID
        , NULL AS HAAnswerVersionID
        , HAUserAnswers.CodeName AS UserAnswerCodeName
        , HAUserAnswers.HAAnswerValue
        , HAUserModule.HAModuleScore
        , HARiskCategory.HARiskCategoryScore
        , HAUserRiskArea.HARiskAreaScore
        , HAUserQuestion.HAQuestionScore
        , HAUserAnswers.HAAnswerPoints
        , HAUserQuestionGroupResults.PointResults
        , HAUserAnswers.UOMCode
        , HAUserStarted.HAScore
        , HAUserModule.PreWeightedScore AS ModulePreWeightedScore
        , HARiskCategory.PreWeightedScore AS RiskCategoryPreWeightedScore
        , HAUserRiskArea.PreWeightedScore AS RiskAreaPreWeightedScore
        , HAUserQuestion.PreWeightedScore AS QuestionPreWeightedScore
        , HAUserQuestionGroupResults.CodeName AS QuestionGroupCodeName

          --, CASE
          --	 WHEN [HAUserAnswers].[ItemCreatedWhen] = [HAUserAnswers].[ItemModifiedWhen]
          --	 THEN 'I'
          --	 ELSE 'U'
          --  END AS [ChangeType]

        , COALESCE ( CT_CMS_User.SYS_CHANGE_OPERATION , CT_CMS_UserSettings.SYS_CHANGE_OPERATION , CT_CMS_Site.SYS_CHANGE_OPERATION , CT_CMS_UserSite.SYS_CHANGE_OPERATION , CT_HFit_Account.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION ,
          CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_OPERATION , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION) AS ChangeType

        , HAUserAnswers.ItemCreatedWhen
        , HAUserAnswers.ItemModifiedWhen
        , HAUserQuestion.IsProfessionallyCollected
        , HARiskCategory.ItemModifiedWhen AS HARiskCategory_ItemModifiedWhen
        , HAUserRiskArea.ItemModifiedWhen AS HAUserRiskArea_ItemModifiedWhen
        , HAUserQuestion.ItemModifiedWhen AS HAUserQuestion_ItemModifiedWhen
        , HAUserAnswers.ItemModifiedWhen AS HAUserAnswers_ItemModifiedWhen
        , HAUserStarted.HAPaperFlg
        , HAUserStarted.HATelephonicFlg
        , HAUserStarted.HAStartedMode
        , HAUserStarted.HACompletedMode
        , VHCJ.DocumentCulture AS DocumentCulture_VHCJ
        , HAQuestionsView.DocumentCulture AS DocumentCulture_HAQuestionsView
        , HAUserStarted.HACampaignNodeGUID AS CampaignNodeGUID
        , VHCJ.HACampaignID
        , CAST ( HASHBYTES ( 'sha1' ,
          ISNULL ( CAST ( HAUserStarted.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserStarted.UserID AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSUser.UserGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( UserSettings.HFitUserMpiNumber AS nvarchar (100)) , '-') + ISNULL ( CAST ( CMSSite.SiteGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountID AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountCD AS nvarchar (100)) , '-') + ISNULL ( CAST ( ACCT.AccountName AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserStarted.HAStartedDt AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACompletedDt AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserModule.ItemID  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.CodeName  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.HAModuleNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.CodeName AS nvarchar (100)) ,
          '-') + ISNULL ( CAST ( HAUserRiskArea.HARiskAreaNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemID AS nvarchar (100)) , '-') + ISNULL ( LEFT ( HAQuestionsView.Title , 1000) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserQuestion.CodeName  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.ItemID AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.HAAnswerNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.HAAnswerValue AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.HAModuleScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryScore AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserRiskArea.HARiskAreaScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionScore AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.HAAnswerPoints AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestionGroupResults.PointResults AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserAnswers.UOMCode AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserModule.PreWeightedScore AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserRiskArea.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.PreWeightedScore  AS nvarchar (100)) , '-') + ISNULL ( CAST
          ( HAUserQuestionGroupResults.CodeName AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemCreatedWhen AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.IsProfessionallyCollected AS nvarchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HAPaperFlg AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HATelephonicFlg AS nvarchar (100)) , '-') + ISNULL (
          CAST ( HAUserStarted.HAStartedMode AS nvarchar (100)) , '-') + ISNULL ( CAST ( HAUserStarted.HACompletedMode AS nvarchar (100)) , '-') + ISNULL ( CAST
          ( HAUserStarted.HACampaignNodeGUID AS nvarchar (100)) , '-') + ISNULL ( CAST ( VHCJ.HACampaignID AS nvarchar (100)) , '-') + ISNULL ( CAST (
          HAUserAnswers.ItemModifiedWhen AS nvarchar (100)) , '-')) AS varchar (100)) AS HashCode
        , CAST ( HASHBYTES ( 'sha1' , ISNULL ( CAST ( HAUserStarted.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID  AS varchar (50)) , '-') + ISNULL ( CAST ( UserGUID AS varchar (50)) , '-') + ISNULL ( CAST ( SiteGUID AS varchar (50)) , '-') + ISNULL ( CAST ( ACCT.AccountID AS varchar (50)) , '-') + ISNULL ( CAST ( AccountCD AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserModule.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAModuleNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( VHAJ.NodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategory.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategoryNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskCategory.CodeName AS varchar (100)) , '-') + ISNULL ( CAST ( HARiskCategory.HARiskCategoryNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserRiskArea.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HARiskAreaNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserRiskArea.CodeName AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.HAQuestionNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserQuestion.CodeName AS varchar (50)) , '-') + ISNULL ( CAST ( HAQuestionNodeGUID AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserAnswers.ItemID AS varchar (50)) , '-') + ISNULL ( CAST ( HAAnswerNodeGUID   AS varchar (50)) , '-') + ISNULL ( CAST ( HAUserStarted.HACampaignNodeGUID AS varchar (50)) , '-')) AS varchar (100)) AS PKHashCode
        , COALESCE ( CT_CMS_User.UserID , CT_CMS_UserSettings.UserSettingsID , CT_CMS_Site.SiteID , CT_CMS_UserSite.UserSiteID , CT_HFit_Account.AccountID , CT_HFit_HealthAssesmentUserAnswers.ItemID , CT_HFit_HealthAssesmentUserModule.ItemID , CT_HFit_HealthAssesmentUserQuestion.ItemID , CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID , CT_HFit_HealthAssesmentUserRiskArea.ItemID , CT_HFit_HealthAssesmentUserRiskCategory.ItemID , CT_HFit_HealthAssesmentUserStarted.ItemID) AS CHANGED_FLG

/*---------------------------------------
***************************************
*****************************************
join changes to the records 
*****************************************
***************************************
*/

        , CT_CMS_User.UserID AS CT_CMS_User_UserID
        , CT_CMS_User.SYS_CHANGE_OPERATION AS CT_CMS_User_CHANGE_OPERATION
        , CT_CMS_UserSettings.UserSettingsID AS CT_UserSettingsID
        , CT_CMS_UserSettings.SYS_CHANGE_OPERATION AS CT_UserSettingsID_CHANGE_OPERATION
        , CT_CMS_Site.SiteID AS SiteID_CtID
        , CT_CMS_Site.SYS_CHANGE_OPERATION AS SiteID_CHANGE_OPERATION
        , CT_CMS_UserSite.UserSiteID AS UserSiteID_CtID
        , CT_CMS_UserSite.SYS_CHANGE_OPERATION AS UserSiteID_CHANGE_OPERATION
        , CT_HFit_Account.AccountID AS AccountID_CtID
        , CT_HFit_Account.SYS_CHANGE_OPERATION AS AccountID__CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserAnswers.ItemID AS HAUserAnswers_CtID
        , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_OPERATION AS HAUserAnswers_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserModule.ItemID AS HFit_HealthAssesmentUserModule_CtID
        , CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserModule_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserQuestion.ItemID AS HFit_HealthAssesmentUserQuestion_CtID
        , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserQuestion_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID AS HFit_HealthAssesmentUserQuestionGroupResults_CtID
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserQuestionGroupResults_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserRiskArea.ItemID AS HFit_HealthAssesmentUserRiskArea_CtID
        , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserRiskArea_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserRiskCategory.ItemID AS HFit_HealthAssesmentUserRiskCategory_CtID
        , CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserRiskCategory_CHANGE_OPERATION
        , CT_HFit_HealthAssesmentUserStarted.ItemID AS HFit_HealthAssesmentUserStarted_CtID
        , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_OPERATION AS HFit_HealthAssesmentUserStarted_CHANGE_OPERATION

          --Get the TYPE of change ID NUMBER

        , CT_CMS_User.SYS_CHANGE_VERSION AS CT_CMS_User_SCV
        , CT_CMS_UserSettings.SYS_CHANGE_VERSION AS CT_CMS_UserSettings_SCV
        , CT_CMS_Site.SYS_CHANGE_VERSION AS CT_CMS_Site_SCV
        , CT_CMS_UserSite.SYS_CHANGE_VERSION AS CT_CMS_UserSite_SCV
        , CT_HFit_Account.SYS_CHANGE_VERSION AS CT_HFit_Account_SCV
        , CT_HFit_HealthAssesmentUserAnswers.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserAnswers_SCV
        , CT_HFit_HealthAssesmentUserModule.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserModule_SCV
        , CT_HFit_HealthAssesmentUserQuestion.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserQuestion_SCV
        , CT_HFit_HealthAssesmentUserQuestionGroupResults.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserQuestionGroupResults_SCV
        , CT_HFit_HealthAssesmentUserRiskArea.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserRiskArea_SCV
        , CT_HFit_HealthAssesmentUserRiskCategory.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserRiskCategory_SCV
        , CT_HFit_HealthAssesmentUserStarted.SYS_CHANGE_VERSION AS CT_HFit_HealthAssesmentUserStarted_SCV
        , HAUserAnswers.ItemModifiedWhen AS LastModifiedDate
        , 0 AS DeleteFlg
        , CASE
              WHEN HAUserStarted.HADocumentConfigID IS NULL
                  THEN 'SHORT_VER'
              WHEN HAUserStarted.HADocumentConfigID IS NOT NULL
                  THEN 'LONG_VER'
              ELSE 'UNKNOWN'
          END AS HealthAssessmentType
        , @@SERVERNAME AS SVR
        , DB_NAME () AS DBNAME
          FROM
               dbo.HFit_HealthAssesmentUserStarted AS HAUserStarted
                    INNER JOIN dbo.CMS_User AS CMSUser
                    ON HAUserStarted.UserID = CMSUser.UserID
                    INNER JOIN dbo.CMS_UserSettings AS UserSettings
                    ON
                       UserSettings.UserSettingsUserID = CMSUser.UserID AND
                       HFitUserMpiNumber >= 0 AND
                       HFitUserMpiNumber IS NOT NULL
                    INNER JOIN dbo.CMS_UserSite AS UserSite
                    ON CMSUser.UserID = UserSite.UserID
                    INNER JOIN dbo.CMS_Site AS CMSSite
                    ON UserSite.SiteID = CMSSite.SiteID
                    INNER JOIN dbo.HFit_Account AS ACCT
                    ON ACCT.SiteID = CMSSite.SiteID
                    INNER JOIN dbo.HFit_HealthAssesmentUserModule AS HAUserModule
                    ON HAUserStarted.ItemID = HAUserModule.HAStartedItemID
                    INNER JOIN dbo.View_HFit_HACampaign_Joined AS VHCJ
                    ON
                       VHCJ.NodeGUID = HAUserStarted.HACampaignNodeGUID AND
                       VHCJ.NodeSiteID = UserSite.SiteID AND
                       VHCJ.DocumentCulture = 'en-US'
                    INNER JOIN dbo.View_HFit_HealthAssessment_Joined AS VHAJ
                    ON VHAJ.DocumentID = VHCJ.HealthAssessmentID
                    INNER JOIN dbo.HFit_HealthAssesmentUserRiskCategory AS HARiskCategory
                    ON HAUserModule.ItemID = HARiskCategory.HAModuleItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserRiskArea AS HAUserRiskArea
                    ON HARiskCategory.ItemID = HAUserRiskArea.HARiskCategoryItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserQuestion AS HAUserQuestion
                    ON HAUserRiskArea.ItemID = HAUserQuestion.HARiskAreaItemID
                    INNER JOIN dbo.View_EDW_HealthAssesmentQuestions AS HAQuestionsView
                    ON
                       HAUserQuestion.HAQuestionNodeGUID = HAQuestionsView.NodeGUID AND
                       HAQuestionsView.DocumentCulture = 'en-US'
                    LEFT OUTER JOIN dbo.HFit_HealthAssesmentUserQuestionGroupResults AS HAUserQuestionGroupResults
                    ON HAUserRiskArea.ItemID = HAUserQuestionGroupResults.HARiskAreaItemID
                    INNER JOIN dbo.HFit_HealthAssesmentUserAnswers AS HAUserAnswers
                    ON HAUserQuestion.ItemID = HAUserAnswers.HAQuestionItemID

/*-----------------------------
*****************************
Add in the change tracking data
*****************************
*/
                    LEFT JOIN CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CT_CMS_UserSettings
                    ON UserSettings.UserSettingsID = CT_CMS_UserSettings.UserSettingsID
                    LEFT JOIN CHANGETABLE (CHANGES CMS_User , NULL) AS CT_CMS_User
                    ON CMSUser.UserID = CT_CMS_User.UserID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_Site , NULL) AS CT_CMS_Site
                    ON CMSSite.SiteID = CT_CMS_Site.SiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES CMS_UserSite , NULL) AS CT_CMS_UserSite
                    ON UserSite.UserSiteID = CT_CMS_UserSite.UserSiteID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_Account , NULL) AS CT_HFit_Account
                    ON ACCT.AccountID = CT_HFit_Account.AccountID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HACampaign , NULL) AS CT_HFit_HACampaign
                    ON VHCJ.HACampaignID = CT_HFit_HACampaign.HACampaignID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserAnswers , NULL) AS CT_HFit_HealthAssesmentUserAnswers
                    ON HAUserAnswers.ItemID = CT_HFit_HealthAssesmentUserAnswers.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserModule , NULL) AS CT_HFit_HealthAssesmentUserModule
                    ON HAUserModule.ItemID = CT_HFit_HealthAssesmentUserModule.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestion , NULL) AS CT_HFit_HealthAssesmentUserQuestion
                    ON HAUserQuestion.ItemID = CT_HFit_HealthAssesmentUserQuestion.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults , NULL) AS CT_HFit_HealthAssesmentUserQuestionGroupResults
                    ON HAUserQuestionGroupResults.ItemID = CT_HFit_HealthAssesmentUserQuestionGroupResults.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea , NULL) AS CT_HFit_HealthAssesmentUserRiskArea
                    ON HAUserRiskArea.ItemID = CT_HFit_HealthAssesmentUserRiskArea.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskCategory , NULL) AS CT_HFit_HealthAssesmentUserRiskCategory
                    ON HARiskCategory.ItemID = CT_HFit_HealthAssesmentUserRiskCategory.ItemID
                    LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted , NULL) AS CT_HFit_HealthAssesmentUserStarted
                    ON HAUserStarted.ItemID = CT_HFit_HealthAssesmentUserStarted.ItemID
          WHERE UserSettings.HFitUserMpiNumber NOT IN (
          SELECT
                 RejectMPICode
                 FROM HFit_LKP_EDW_RejectMPI) ;
GO

PRINT 'Processed view_EDW_HealthAssesment_CT';

GO

PRINT ' FROM view_EDW_HealthAssesment_CT.sql';

GO





GO
IF EXISTS (SELECT
                  name
                  FROM sys.procedures AS CTCNT
             WHERE name = 'proc_EDW_CountDeletedHA') 
    BEGIN
        DROP PROCEDURE
             proc_EDW_CountDeletedHA;
    END;
GO
CREATE PROC proc_EDW_CountDeletedHA
AS
BEGIN
    DECLARE
       @iCnt AS bigint = 0;

    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES CMS_UserSettings , NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES CMS_User, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES CMS_Site, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES CMS_UserSite, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_Account, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HACampaign, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserAnswers, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserModule, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestion, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserQuestionGroupResults, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskArea, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserRiskCategory, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    SET @iCnt = @iCnt + (SELECT
                                COUNT (*) 
                                FROM CHANGETABLE (CHANGES HFit_HealthAssesmentUserStarted, NULL) AS CTCNT
                           WHERE SYS_CHANGE_OPERATION = 'D') ;
    print ('HA Deletes found: ' + cast(@iCnt as nvarchar(50)));
    RETURN @iCnt;
END;
GO
PRINT 'Creating proc_CkUserTrackerHasChanged';
PRINT 'FROM proc_CkUserTrackerHasChanged.sql';

IF EXISTS (SELECT
              name
                  FROM sys.procedures
                  WHERE name = 'proc_CkUserTrackerHasChanged') 
    BEGIN
        DROP PROCEDURE
           proc_CkUserTrackerHasChanged
    END;
GO

CREATE PROC proc_CkUserTrackerHasChanged
AS
BEGIN

    DECLARE
    @UpdatesFOund TABLE (
       ChangeType nvarchar (10) NULL) ;
    DECLARE
    @b AS bit = 0;

    INSERT INTO @UpdatesFOund
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_UserTracker, NULL) AS CT
    UNION
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_Site, NULL) AS CT
    UNION
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT
    UNION
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES CMS_UserSettings, NULL) AS CT
    UNION
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_Account, NULL) AS CT
    UNION
    SELECT
       SYS_CHANGE_OPERATION
           FROM CHANGETABLE (CHANGES HFit_TrackerCollectionSource, NULL) AS CT;

    DECLARE @NbrUpdates AS int = @@ROWCOUNT;

    IF @NbrUpdates = 0
        BEGIN
            PRINT 'No changes found';
            SET @b = 0;
        END;
    ELSE
        BEGIN
            PRINT 'Changes found';
            SET @b = 1;
            IF EXISTS (SELECT
                          ChangeType
                              FROM @UpdatesFOund
                              WHERE ChangeType = 'D') 
                BEGIN
                    PRINT 'DELETES found';
                    SET @b = 2;
                END;
            RETURN @b;
        END;
END;
GO
PRINT 'Created proc_CkUserTrackerHasChanged';
GO
/*-----------------------------------------------------------------------------------------------
***********************************************************************************************
Developer  : W. Dale Miller
05.28.2015 : WDM - completed unit testing

exec proc_STAGING_EDW_HA_Changes 0   --Process Changed Data only
exec proc_STAGING_EDW_HA_Changes 1   --Reload ALL
exec proc_STAGING_EDW_HA_Changes 0, @PullLatestVersionOnly = 1

select * from TEMP_EDW_HealthAssessment_DATA
select  * from CT_VersionTracking ; 

select * from information_schema.columns where column_name = 'HAModuleScore'
SELECT top 100 * FROM [HFit_HealthAssesmentUserModule]

update HFit_HealthAssesmentUserModule set HAModuleScore = HAModuleScore + .03 where ItemID = 1526
update HFit_HealthAssesmentUserModule set HAModuleScore = HAModuleScore + .03 where ItemID = 1527

update HFit_HealthAssesmentUserModule set HAModuleScore = HAModuleScore - .03 where ItemID = 1526
update HFit_HealthAssesmentUserModule set HAModuleScore = HAModuleScore - .03 where ItemID = 1527

SELECT COUNT(*) FROM DIM_EDW_HealthAssessment
SELECT COUNT(*) FROM [view_EDW_HealthAssesment_CT]
SELECT top 100 * FROM [view_EDW_HealthAssesment_CT]
SELECT TOP 100 * FROM [DIM_EDW_HealthAssessment];
SELECT COUNT (*) FROM [DIM_EDW_HealthAssessment]; 

select * from DIM_EDW_HealthAssessment where Hashcode = 'f#Kj92%2'
select count(*), HashCode
from DIM_EDW_HealthAssessment
group by HashCode 
having Count(*) > 1
***********************************************************************************************
*/

/*-----------------------------------------------------
USES:
    PROCS:
    dbo.proc_EDW_Procedure_Performance_Monitor
    dbo.proc_EDW_ChangeGmtToCentralTime
    dbo.proc_CkHaDataChanged
    dbo.proc_CT_Performance_History
    dbo.proc_clean_EDW_Staging
    dbo.proc_EDW_PullHA_Temp_Data
    dbo.proc_trace
    dbo.proc_EDW_CT_ExecutionLog_Update_Counts
    dbo.proc_EDW_CT_ExecutionLog_Update
    dbo.proc_EDW_UpdateDIMTables
    dbo.proc_CT_HA_AddNewRecs
    dbo.proc_CT_HA_AddUpdatedRecs
    dbo.proc_CT_HA_AddDeletedRecs
    dbo.proc_EDW_Reload_EDW_HealthAssessment
    dbo.proc_QuickRowCount
    dbo.proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI
    
    TABLE:
    CT_VersionTracking
    EDW_Proc_Performance_Monitor

    JOBS:
    job_EDW_GetStagingData_HA_KenticoCMS_ProdXX
*/

GO

PRINT 'FROM proc_STAGING_EDW_HA_Changes.SQL';
PRINT 'Creating proc_STAGING_EDW_HA_Changes';

GO

IF EXISTS ( SELECT
                   name
                   FROM sys.procedures
                   WHERE name = 'proc_STAGING_EDW_HA_Changes') 

    BEGIN
        PRINT 'Replacing proc_STAGING_EDW_HA_Changes proc';
        DROP PROCEDURE
             proc_STAGING_EDW_HA_Changes;
    END;

GO
-- exec proc_STAGING_EDW_HA_Changes
CREATE PROCEDURE proc_STAGING_EDW_HA_Changes
     @LoadType int = 0
   , @TrackProgress AS bit = 0
   , @CTVersionOverride AS int = NULL
   , @PullLatestVersionOnly AS bit = 0
AS
BEGIN

    SET NOCOUNT ON;

/*------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------
***************************************************************************************************
Developer		 : W. Dale Miller
@LoadType		 :	0 load only changes, 
				1 is reload the staging table with all data.
				2 is reload the staging table with all data.
@TrackProgress			 : 1 causes tracing data to be displayed, 0 skips the tracing display
@CTVersionOverride		 : NULL is no action, Any positive number will force the specified version 
					   and all above that to be pulled.
@PullLatestVersionOnly    : 0 pull all changes, 1 pull only data between the last and current CHANGE ID.
***************************************************************************************************
*/

    DECLARE
    @ActivateTestMode AS bit = 0
  , @iTotal AS bigint = 0
  , @NbrOfDetectedChanges AS bigint = 0
  , @CT_NAME AS nvarchar ( 50) = 'proc_Staging_EDW_Data'
  , @CT AS datetime = GETDATE () 
  , @ET AS datetime = GETDATE () 
  , @STime AS datetime = GETDATE () 
  , @RecordID AS uniqueidentifier = NEWID () 
  , @PROC_LOCATION AS nvarchar ( 100) = ''
  , @iCnt AS bigint = 0
  , @proc_RowsProcessed AS bigint = 0
  , @proc_endtime AS datetime
  , @CT_DateTimeNow AS datetime
  , @TOTSECS AS bigint = 0
  , @RowNbr  AS bigint = 0
  , @CNT_StagingTable  AS bigint = 0
  , @MINS AS bigint = 0
  , @proc_elapsedsecs AS bigint = 0;

    DECLARE
    @ExtractionDate AS datetime = GETDATE () ;

    DECLARE
    @CTVersionToPullNow AS bigint = 0
  , @ExtractedVersion AS bigint = 0;

    DECLARE
    @TgtView AS nvarchar ( 100) = 'view_EDW_HealthAssesment';

    DECLARE
    @StartTime AS datetime = GETDATE () 
  , @EndTime AS datetime = GETDATE () ;

    DECLARE
    @SVRName AS nvarchar ( 100) = @@SERVERNAME
  , @DBName AS nvarchar ( 100) = DB_NAME () ;

    DECLARE
    @CNT_Insert AS bigint = 0
  , @CNT_Update  AS bigint = 0
  , @CNT_delete  AS bigint = 0;

    DECLARE
    @proc_RowGuid  AS uniqueidentifier = @RecordID;

    EXEC @iTotal = proc_QuickRowCount 'DIM_EDW_HealthAssessment';

    IF @iTotal <= 1
        BEGIN
            PRINT 'NO RECORDS FOUND IN STAGING TABLE - Reloading all.' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @LoadType = 1;
        END;

    IF @LoadType = NULL
        BEGIN
            SET @LoadType = 0;
        END;

    IF @LoadType = 1
        BEGIN
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '001 RELOAD ALL';
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '002 BEGIN RELOAD ALL';

            --**************************************************************************************************
            PRINT 'START proc_EDW_Reload_EDW_HealthAssessment: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @NbrOfDetectedChanges = proc_EDW_Reload_EDW_HealthAssessment ;
            PRINT 'ENDED proc_EDW_Reload_EDW_HealthAssessment: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            --**************************************************************************************************

            PRINT '00 Number of records loaded: ' + CAST (@NbrOfDetectedChanges AS nvarchar (50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '003 END RELOAD ALL';

            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '004 Begin Converting Time to Central';
            --**************************************************************************************************
            PRINT 'START Converting Time to Central' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthAssessment';
            PRINT 'END Converting Time to Central' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            --**************************************************************************************************
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '005 Complete Converting Time to Central';

            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '006 Begin Cleaning Staging Data';
            PRINT 'START Cleaning Staging Data' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_clean_EDW_Staging;
            PRINT 'END Cleaning Staging Data' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '007 END Cleaning Staging Data';

            PRINT 'Load Complete' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , 0;

            RETURN;
        END;

    --********************************************************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'START proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI', @CT, NULL;
    EXEC proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END proc_EDW_Create_HFIT_LKP_EDW_ALLOWED_MPI', @CT, @ET;
    --********************************************************************************************************

    DECLARE @LatestDbVersionToPull AS bigint = 0;
    SET @LatestDbVersionToPull = CHANGE_TRACKING_CURRENT_VERSION () - 1;
    PRINT 'The Current Change Version ID is : ' + CAST (@LatestDbVersionToPull AS nvarchar (50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;

    IF @CTVersionOverride IS NOT NULL
   AND @CTVersionOverride >= 0
        BEGIN
            SET @CTVersionToPullNow = @CTVersionOverride;
        END;
    ELSE
        BEGIN
            SET @CTVersionToPullNow = ( SELECT
                                               MAX ( CurrentDbVersion) 
                                               FROM CT_VersionTracking
                                               WHERE
                                               SVRname = @@ServerName
                                           AND DBName = DB_NAME () 
                                           AND TgtView = @TgtView);
        END;

    PRINT 'The Previous Change Version ID is ' + CAST ( @CTVersionToPullNow AS nvarchar (50)) ;

    DECLARE
    @iChgTypes AS int = 0;

    --**************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'START proc_CkHaDataChanged :', @CT, NULL;
    EXEC @iChgTypes = proc_CkHaDataChanged @CTVersionToPullNow, @NbrOfDetectedChanges OUTPUT;
    PRINT 'iChgType is: ' + CAST (@iChgTypes AS nvarchar (50)) ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END proc_CkHaDataChanged :', @CT, @ET;
    --**************************************************************

    IF @CTVersionToPullNow < 0 OR @CTVersionToPullNow IS NULL
        BEGIN
            SET @CTVersionToPullNow = 0;
        END;

    IF @TrackProgress = 1
        BEGIN
            PRINT 'Pulling @CTVersionToPullNow ' + CAST ( @CTVersionToPullNow AS nvarchar (50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
        END;

    IF @CTVersionToPullNow = @LatestDbVersionToPull AND @PullLatestVersionOnly = 1
        BEGIN

            PRINT 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX';
            PRINT 'NO Changes found in the db version of ' + CAST ( @LatestDbVersionToPull AS nvarchar ( 50)) + ' - RETURNING' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            PRINT 'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX';

            SET @STime = GETDATE () ;

            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'I' , 0;
            EXEC proc_EDW_CT_ExecutionLog_Update_Counts @RecordID , 'T' , 0;
            EXEC proc_EDW_CT_ExecutionLog_Update @RecordID , @CT_NAME , @CT_DateTimeNow , 0 , 'D';

            SET @proc_RowsProcessed = 0;
            SET @PROC_LOCATION = 'End Of Run - NO CHANGES FOUND';
            SET @proc_endtime = GETDATE () ;
            EXEC proc_CT_Performance_History @proc_RowGuid , @CT_NAME , @PROC_LOCATION , @STime , @proc_endtime , @proc_elapsedsecs , @proc_RowsProcessed;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '008';
            EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '009';

            RETURN;
        END;
    ELSE
        BEGIN
            PRINT 'PULLING Changes for versions between: ' + CAST ( @CTVersionToPullNow AS nvarchar ( 50)) + '  and ' + CAST ( @LatestDbVersionToPull
                  AS nvarchar ( 50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
        END;

    IF @iChgTypes = 0
        BEGIN
            PRINT '**01 Notice: No changes found to process, done.' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            RETURN 0;
        END;

    /*-------------------------------
    if @iChgTypes = 
    0 - no changes
    1 - updates only
    2 - deletes only
    3 - deletes and updates
    4 - inserts only
    5 - inserts and updates
    6 - inserts and deletes
    7 - inserts, updates, and deletes
    */
    -- EXEC proc_EDW_UpdateDIMTables null
    --*********************************************************************************************************
    PRINT '**Populating Staging Tables: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
    EXEC proc_EDW_UpdateDIMTables @CTVersionToPullNow;
    PRINT '**ENDED Populating Staging Tables: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
    --*********************************************************************************************************

    DECLARE @ReloadCnt AS bigint = 0;
    IF @iChgTypes > 0 AND @iChgTypes != 2
        BEGIN
            DECLARE @st100 AS datetime = GETDATE () ;
            PRINT 'Loading temp table: version# ' + CAST (@CTVersionToPullNow AS nvarchar (50)) + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @CT = GETDATE () ;
            EXEC proc_trace 'START Loading temp table', @CT, NULL;
            EXEC proc_trace 'START proc_EDW_PullHA_Temp_Data: ', @st100, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '010 pulling changes into Temp Table';
            EXEC @ReloadCnt = proc_EDW_PullHA_Temp_Data @CTVersionToPullNow;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '011 - ENDING data pull';
            PRINT 'ENDED loading temp table: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Loading temp table', @CT, @ET;
            DECLARE @ed100 AS datetime = GETDATE () ;
            EXEC proc_trace 'ENDED loading temp table: ', @st100, @ed100;
        END;

    DECLARE @iInserts AS int = 0
          , @iUpdates AS int = 0
          , @iDeletes AS int = 0;

    SET @CT = GETDATE () ;

    IF @iChgTypes = 1
        BEGIN
            SET @ET = GETDATE () ;
            EXEC proc_trace 'START Processing UPDATES ONLY', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '200 Pulling UPDATES only';
            EXEC @iUpdates = proc_CT_HA_AddUpdatedRecs;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '201 - ENDING data pull';
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 2
        BEGIN
            PRINT '**START Processing DELETES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing DELETES ONLY', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '250 Pulling DELETES only';
            EXEC @iDeletes = proc_CT_HA_AddDeletedRecs ;
            --exec @iDeletes = proc_CT_MarkDeletedRecords ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '251 - ENDING data pull';
            PRINT '** ENDED Processing DELETES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 3
        BEGIN
            PRINT '**START Processing Updates & DELETES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing Updates & DELETES ONLY', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '300 Pulling DELETES and UPDATES';
            EXEC @iUpdates = proc_CT_HA_AddUpdatedRecs;
            PRINT '**ENDED Step 1 - Start Step 2: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @iDeletes = proc_CT_HA_AddDeletedRecs ;
            --exec @iDeletes = proc_CT_MarkDeletedRecords ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '301 - ENDING data pull';
            PRINT '**ENDED Processing Updates & DELETES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 4
        BEGIN
            PRINT '**START Processing INSERTS ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing INSERTS ONLY', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '400 Pulling INSERTS ONLY';
            EXEC @iInserts = proc_CT_HA_AddNewRecs ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '401 - ENDING data pull';
            PRINT '** ENDED Processing INSERTS ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 5
        BEGIN
            PRINT '**START Processing Inserts and UPDATES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing Inserts and UPDATES', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '500 Pulling INSERTS and UPDATES';
            EXEC @iInserts = proc_CT_HA_AddNewRecs ;
            PRINT '**ENDED Step 1 - Start Step 2: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @iUpdates = proc_CT_HA_AddUpdatedRecs;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '501 - ENDING data pull';
            PRINT '**ENDED Processing Inserts and Updates ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 6
        BEGIN
            PRINT '**START Processing INSERTS and DELETES: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing Inserts and DELETES', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '600	     Pulling INSERTS and DELETES';
            EXEC @iInserts = proc_CT_HA_AddNewRecs ;
            PRINT '**ENDED Step 1 Start Step 2: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @iDeletes = proc_CT_HA_AddDeletedRecs ;
            --exec @iDeletes = proc_CT_MarkDeletedRecords ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '601 - ENDING data pull';
            PRINT '**ENDED Processing INSERTS and DELETES: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;
    IF @iChgTypes = 7
        BEGIN
            PRINT '**Start Processing INSERTS/DELETES/UPDATES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC proc_trace 'START Processing INSERTS/DELETES/UPDATES', @CT, NULL;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '700	 Pulling INSERTS/DELETES/UPDATES';
            EXEC @iInserts = proc_CT_HA_AddNewRecs ;
            PRINT '**ENDED Step 1 - Start Step 2: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @iUpdates = proc_CT_HA_AddUpdatedRecs;
            PRINT '**ENDED Step 2 - Start Step 3: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            EXEC @iDeletes = proc_CT_HA_AddDeletedRecs ;
            --exec @iDeletes = proc_CT_MarkDeletedRecords ;
            EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '701 - ENDING data pull';
            PRINT '**ENDED Processing INSERTS/DELETES/UPDATES ONLY: ' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
            SET @ET = GETDATE () ;
            EXEC proc_trace 'END Process', @CT, @ET;
        END;

    DECLARE @TotalAvailRecs AS bigint = 0;
    EXEC @TotalAvailRecs = proc_QuickRowCount 'DIM_EDW_HealthAssessment';

    IF @ReloadCnt > 0
        BEGIN
            SET @NbrOfDetectedChanges = @ReloadCnt;
        END;
    ELSE
        BEGIN
            SET @NbrOfDetectedChanges = @iInserts + @iUpdates + @iDeletes;
        END;

    INSERT INTO CT_VersionTracking (
           SVRName
         , DBName
         , TgtView
         , ExtractionDate
         , ExtractedVersion
         , CurrentDbVersion
         , ExtractedRowCnt
         , StartTime
         , EndTime
         , CNT_Insert
         , CNT_Update
         , CNT_Delete
         , CNT_StagingTable
         , CNT_PulledRecords) 
    VALUES
           (
           @@SERVERNAME , DB_NAME () , @TgtView , GETDATE () , @LatestDbVersionToPull ,
           @LatestDbVersionToPull , @NbrOfDetectedChanges , @StartTime , GETDATE () , @iInserts ,
           @iUpdates , @iDeletes , @TotalAvailRecs , @NbrOfDetectedChanges) ;

    --************************************************************************************************    
    SET @CT = GETDATE () ;
    EXEC proc_trace 'START Cleaning Staging Data', @CT, NULL;
    EXEC proc_clean_EDW_Staging;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END Process', @CT, @ET;
    --************************************************************************************************
    --************************************************************************************************
    SET @CT = GETDATE () ;
    EXEC proc_trace 'START Converting Time to Central', @CT, NULL;
    EXEC proc_EDW_ChangeGmtToCentralTime 'DIM_EDW_HealthAssessment';
    SET @ET = GETDATE () ;
    EXEC proc_trace 'END Process', @CT, @ET;
    --************************************************************************************************

    EXEC proc_EDW_Procedure_Performance_Monitor 'I' , @CT_NAME , '800 - PROC FINISHED';
    EXEC proc_EDW_Procedure_Performance_Monitor 'T' , @CT_NAME , '801 - END OF RUN';

    PRINT '015 LOAD Complete: PERF Monitor Table - EDW_Proc_Performance_Monitor' + ' @@  ' + CONVERT (nvarchar (50) , GETDATE () , 13) ;
    SET @ET = GETDATE () ;
    EXEC proc_trace 'RUN COMPETE - TOTAL TIME: ', @STime, @ET;

-- select * from EDW_Proc_Performance_Monitor where TraceName = 'proc_Staging_EDW_Data' order by RowNbr Desc
-- SELECT * FROM CT_VersionTracking
-- select * from EDW_Proc_Performance_Monitor where TraceName = 'proc_Staging_EDW_Data' order by RowNbr
END;

GO

PRINT 'Created proc_STAGING_EDW_HA_Changes';

GO 



go
-- use KenticoCMS_Prod1
PRINT 'Processing: view_EDW_TrackerCompositeDetails_CT ';
GO

--SELECT * from view_EDW_TrackerCompositeDetails_CT where CMS_Operation is not null

IF EXISTS ( SELECT
                   TABLE_NAME
                   FROM INFORMATION_SCHEMA.VIEWS
                   WHERE TABLE_NAME = 'view_EDW_TrackerCompositeDetails_CT') 
    BEGIN
        DROP VIEW
             view_EDW_TrackerCompositeDetails_CT;
    END;
GO

CREATE VIEW dbo.view_EDW_TrackerCompositeDetails_CT
AS SELECT DISTINCT
          'HFit_TrackerBloodPressure' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mm/Hg' AS UOM
        , 'Systolic' AS KEY1
        , CAST ( Systolic AS float) AS VAL1
        , 'Diastolic' AS KEY2
        , CAST ( Diastolic AS float) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'bp') AS UniqueName
        , ISNULL ( T.UniqueName , 'bp') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
         , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	   FROM
               dbo.HFit_TrackerBloodPressure AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerBloodPressure'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodPressure, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerBloodSugarAndGlucose' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mmol/L' AS UOM
        , 'Units' AS KEY1
        , CAST ( Units AS float) AS VAL1
        , 'FastingState' AS KEY2
        , CAST ( FastingState AS float) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'glucose') AS UniqueName
        , ISNULL ( T.UniqueName , 'glucose') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerBloodSugarAndGlucose AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodSugarAndGlucose, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerBMI' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'kg/m2' AS UOM
        , 'BMI' AS KEY1
        , CAST ( BMI AS float) AS VAL1
        , 'NA' AS KEY2
        , 0 AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerBMI') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerBMI AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerBMI'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBMI, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerBodyFat' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'PCT' AS UOM
        , 'Value' AS KEY1
        , CAST ( [Value] AS float) AS VAL1
        , 'NA' AS KEY2
        , 0 AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerBodyFat') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerBodyFat AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerBodyFat'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyFat, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL

   SELECT DISTINCT
          'HFit_TrackerBodyMeasurements' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Inch' AS UOM
        , 'WaistInches' AS KEY1
        , CAST ( WaistInches AS float) AS VAL1
        , 'HipInches' AS KEY2
        , CAST ( HipInches AS float) AS VAL2
        , 'ThighInches' AS KEY3
        , CAST ( ThighInches AS float) AS VAL3
        , 'ArmInches' AS KEY4
        , CAST ( ArmInches AS float) AS VAL4
        , 'ChestInches' AS KEY5
        , CAST ( ChestInches AS float) AS VAL5
        , 'CalfInches' AS KEY6
        , CAST ( CalfInches AS float) AS VAL6
        , 'NeckInches' AS KEY7
        , CAST ( NeckInches AS float) AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerBodyMeasurements AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyMeasurements, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerCardio' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'Minutes' AS KEY1
        , CAST ( Minutes AS float) AS VAL1
        , 'Distance' AS KEY2
        , CAST ( Distance AS float) AS VAL2
        , 'DistanceUnit' AS KEY3
        , CAST ( DistanceUnit AS float) AS VAL3
        , 'Intensity' AS KEY4
        , CAST ( Intensity AS float) AS VAL4
        , 'ActivityID' AS KEY5
        , CAST ( ActivityID AS float) AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerCardio AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerCardio' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCardio, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerCholesterol' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mg/dL' AS UOM
        , 'HDL' AS KEY1
        , CAST ( HDL AS float) AS VAL1
        , 'LDL' AS KEY2
        , CAST ( LDL AS float) AS VAL2
        , 'Total' AS KEY3
        , CAST ( Total AS float) AS VAL3
        , 'Tri' AS KEY4
        , CAST ( Tri AS float) AS VAL4
        , 'Ratio' AS KEY5
        , CAST ( Ratio AS float) AS VAL5
        , 'Fasting' AS KEY6
        , CAST ( Fasting AS float) AS VAL6
        , 'VLDL' AS VLDL
        , CAST ( VLDL AS float) AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerCholesterol') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerCholesterol AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerCholesterol'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCholesterol, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerDailySteps' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Step' AS UOM
        , 'Steps' AS KEY1
        , CAST ( Steps AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerDailySteps') AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerDailySteps AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerDailySteps' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerDailySteps, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerFlexibility' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'HasStretched' AS KEY1
        , CAST ( HasStretched AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerFlexibility AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerFlexibility' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerFlexibility, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerFruits' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'CUP(8oz)' AS UOM
        , 'Cups' AS KEY1
        , CAST ( Cups AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerFruits AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerFruits' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerFruits, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'mmol/mol' AS UOM
        , 'Value' AS KEY1
        , CAST ( [Value] AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerHbA1c AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerHbA1c'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHbA1c, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHeight' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'inch' AS UOM
        , 'Height' AS KEY1
        , Height AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS UniqueName
        , ISNULL ( T.UniqueName , 'HFit_TrackerHeight') AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerHeight AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerHeight'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHeight, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHighFatFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerHighFatFoods AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerHighFatFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHighFatFoods, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerHighSodiumFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerHighSodiumFoods AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerHighSodiumFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerHighSodiumFoods, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'TrackerDefID' AS KEY1
        , CAST ( TrackerDefID AS float) AS VAL1
        , 'YesNoValue' AS KEY2
        , CAST ( YesNoValue AS float) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerInstance_Tracker AS TT
                   INNER JOIN dbo.HFit_TrackerDef_Tracker AS TDT
                   ON TDT.trackerid = TT.trackerDefID
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON
          T.AggregateTableName = 'HFit_TrackerInstance_Tracker'
      AND T.uniquename = TDT.name
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerInstance_Tracker, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-portion' AS UOM
        , 'Portions' AS KEY1
        , CAST ( Portions AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerMealPortions AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerMealPortions' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerMealPortions, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'FollowedPlan' AS KEY1
        , CAST ( FollowedPlan AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerMedicalCarePlan AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerMedicalCarePlan' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerMedicalCarePlan, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerRegularMeals' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Units' AS KEY1
        , CAST ( Units AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerRegularMeals AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerRegularMeals' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerRegularMeals, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerRestingHeartRate' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'BPM' AS UOM
        , 'HeartRate' AS KEY1
        , CAST ( HeartRate AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerRestingHeartRate AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerRestingHeartRate, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerShots;' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'FluShot' AS KEY1
        , CAST ( FluShot AS float) AS VAL1
        , 'PneumoniaShot' AS KEY2
        , CAST ( PneumoniaShot AS float) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerShots AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerShots'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerShots, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSitLess' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Occurs' AS UOM
        , 'Times' AS KEY1
        , CAST ( Times AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerSitLess AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerSitLess' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerSitLess, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSleepPlan' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'HR' AS UOM
        , 'DidFollow' AS KEY1
        , CAST ( DidFollow AS float) AS VAL1
        , 'HoursSlept' AS KEY2
        , HoursSlept AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Techniques' AS TXTKEY1
        , Techniques AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerSleepPlan AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerSleepPlan' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerSleepPlan, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerStrength' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'HasTrained' AS KEY1
        , CAST ( HasTrained AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerStrength AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerStrength' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerStrength, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerStress' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'gradient' AS UOM
        , 'Intensity' AS KEY1
        , CAST ( Intensity AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Awareness' AS TXTKEY1
        , Awareness AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerStress AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerStress' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerStress, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerStressManagement' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'gradient' AS UOM
        , 'HasPracticed' AS KEY1
        , CAST ( HasPracticed AS float) AS VAL1
        , 'Effectiveness' AS KEY2
        , CAST ( Effectiveness AS float) AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'Activity' AS TXTKEY1
        , Activity AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerStressManagement AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerStressManagement' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerStressManagement, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSugaryDrinks' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'OZ' AS UOM
        , 'Ounces' AS KEY1
        , CAST ( Ounces AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerSugaryDrinks AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerSugaryDrinks' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerSugaryDrinks, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerSugaryFoods' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-portion' AS UOM
        , 'Portions' AS KEY1
        , CAST ( Portions AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerSugaryFoods AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerSugaryFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerSugaryFoods, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerTests' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'PSATest' AS KEY1
        , CAST ( PSATest AS float) AS VAL1
        , 'OtherExam' AS KEY1
        , CAST ( OtherExam AS float) AS VAL2
        , 'TScore' AS KEY3
        , CAST ( TScore AS float) AS VAL3
        , 'DRA' AS KEY4
        , CAST ( DRA AS float) AS VAL4
        , 'CotinineTest' AS KEY5
        , CAST ( CotinineTest AS float) AS VAL5
        , 'ColoCareKit' AS KEY6
        , CAST ( ColoCareKit AS float) AS VAL6
        , 'CustomTest' AS KEY7
        , CAST ( CustomTest AS float) AS VAL7
        , 'TSH' AS KEY8
        , CAST ( TSH AS float) AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'CustomDesc' AS TXTKEY1
        , CustomDesc AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , TT.ItemOrder
        , TT.ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerTests AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerTests'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerTests, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerTobaccoFree' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'Y/N' AS UOM
        , 'WasTobaccoFree' AS KEY1
        , CAST ( WasTobaccoFree AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'QuitAids' AS TXTKEY1
        , QuitAids AS TXTVAL1
        , 'QuitMeds' AS TXTKEY2
        , QuitMeds AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerTobaccoFree AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerTobaccoFree' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerTobaccoFree, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerVegetables' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'CUP(8oz)' AS UOM
        , 'Cups' AS KEY1
        , CAST ( Cups AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerVegetables AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerVegetables' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerVegetables, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerWater' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'OZ' AS UOM
        , 'Ounces' AS KEY1
        , CAST ( Ounces AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerWater AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerWater' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerWater, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerWeight' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'LBS' AS UOM
        , 'Value' AS KEY1
        , [Value] AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , VENDOR.ItemID AS VendorID
        , VENDOR.VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerWeight AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerWeight'
                   LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                   ON TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerWeight, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerWholeGrains' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , CollectionSourceName_Internal
        , CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA-serving' AS UOM
        , 'Servings' AS KEY1
        , CAST ( Servings AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , NULL AS IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerWholeGrains AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerWholeGrains' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerWholeGrains, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerCotinine' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'NicotineAssessment' AS KEY1
        , CAST ( NicotineAssessment AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerCotinine AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerCotinine' --LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
               --	ON TT.VendorID = VENDOR.ItemID;
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerCotinine, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerPreventiveCare' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'PreventiveCare' AS KEY1
        , CAST ( PreventiveCare AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerPreventiveCare AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerPreventiveCare' --LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
               --	ON TT.VendorID = VENDOR.ItemID;
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerPreventiveCare, NULL) AS CT
                   ON TT.itemid = CT.itemid
   UNION ALL
   SELECT DISTINCT
          'HFit_TrackerTobaccoAttestation' AS TrackerNameAggregateTable
        , TT.ItemID
        , cast(EventDate as datetime) as EventDate
        , TT.IsProfessionallyCollected
        , TT.TrackerCollectionSourceID
        , Notes
        , TT.UserID
        , NULL AS CollectionSourceName_Internal
        , NULL AS CollectionSourceName_External
        , 'MISSING' AS EventName
        , 'NA' AS UOM
        , 'TobaccoAttestation' AS KEY1
        , CAST ( TobaccoAttestation AS float) AS VAL1
        , 'NA' AS KEY2
        , NULL AS VAL2
        , 'NA' AS KEY3
        , NULL AS VAL3
        , 'NA' AS KEY4
        , NULL AS VAL4
        , 'NA' AS KEY5
        , NULL AS VAL5
        , 'NA' AS KEY6
        , NULL AS VAL6
        , 'NA' AS KEY7
        , NULL AS VAL7
        , 'NA' AS KEY8
        , NULL AS VAL8
        , 'NA' AS KEY9
        , NULL AS VAL9
        , 'NA' AS KEY10
        , NULL AS VAL10
        , TT.ItemCreatedBy
        , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
        , TT.ItemModifiedBy
        , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
        , IsProcessedForHa
        , 'NA' AS TXTKEY1
        , NULL AS TXTVAL1
        , 'NA' AS TXTKEY2
        , NULL AS TXTVAL2
        , 'NA' AS TXTKEY3
        , NULL AS TXTVAL3
        , NULL AS ItemOrder
        , NULL AS ItemGuid
        , C.UserGuid
        , PP.MPI
        , PP.ClientCode
        , S.SiteGUID
        , ACCT.AccountID
        , ACCT.AccountCD
        , T.IsAvailable
        , T.IsCustom
        , T.UniqueName
        , T.UniqueName AS ColDesc
        , NULL AS VendorID
        , NULL AS VendorName
        , CT.ItemID AS CT_ItemID
        , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
        , CT.SYS_CHANGE_OPERATION AS CMS_Operation
          , @@SERVERNAME as SVR
    , DB_NAME() as DBNAME
	  FROM
               dbo.HFit_TrackerTobaccoAttestation AS TT
                   INNER JOIN dbo.CMS_User AS C
                   ON C.UserID = TT.UserID
                   INNER JOIN dbo.hfit_ppteligibility AS PP
                   ON TT.UserID = PP.userID
                   INNER JOIN dbo.HFit_Account AS ACCT
                   ON PP.ClientCode = ACCT.AccountCD
                   INNER JOIN dbo.CMS_Site AS S
                   ON ACCT.SiteID = S.SiteID
                   INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                   ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                   LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                   ON T.AggregateTableName = 'HFit_TrackerTobaccoAttestation'
                   LEFT OUTER JOIN CHANGETABLE (CHANGES HFit_TrackerTobaccoAttestation, NULL) AS CT
                   ON TT.itemid = CT.itemid;

GO

--  
--  
GO
PRINT '***** FROM: view_EDW_TrackerCompositeDetails_CT.sql';
PRINT '***** CREATED view_EDW_TrackerCompositeDetails_CT ';
GO 




GO
PRINT 'Processing: view_EDW_TrackerCompositeDetails_CT_ONLY ';
GO
--SELECT * FROM HFit_TrackerCotinine
--select * from view_EDW_TrackerCompositeDetails_CT_ONLY
--select * from HFit_TrackerBMI
--select * from HFit_TrackerCholesterol
--update HFit_TrackerBMI set Notes = 'TEST CHANGE' where ItemID in (15234,15235,15236)
--update HFit_TrackerCholesterol set Notes = 'TEST CHANGE' where ItemID BETWEEN 55922 AND 55928
--update HFit_TrackerCotinine set Notes = 'TEST CHANGE' where ItemID = 3
IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
                  WHERE TABLE_NAME = 'view_EDW_TrackerCompositeDetails_CT_ONLY'
) 
    BEGIN
        DROP VIEW
             view_EDW_TrackerCompositeDetails_CT_ONLY;
    END;
GO

CREATE VIEW dbo.view_EDW_TrackerCompositeDetails_CT_ONLY
AS
--************************************************************************************************************************************
-- NOTES:
--************************************************************************************************************************************
--WDM 6/26/2014
--This view is needed by EDW in order to process the Tracker tables' data.
--As of now, the Tracker tables are representative of objects and that would cause 
--	large volumes of ETL to be devloped and maintained. 
--This view represents a columnar representation of all tracker tables in a Key/Value pair representation.
--Each tracker table to be processed into the EDW must be represented in this view.
--ALL new tracker tables need only be entered once using the structure contained within this view
--	and the same EDW ETL should be able to process it.
--If there is a change to the strucuture of any one query in this view, then all have to be modified 
--	to be support the change.
--Column TrackerNameAggregratetable (AggregateTableName) will be NULL if the Tracker is not a member 
--		of the DISPLAYED Trackers. This allows us to capture all trackers, displayed or not.

--7/29/2014
--ISSUE: HFit_TrackerBMI,  HFit_TrackerCholesterol, and HFit_TrackerHeight are not in the HFIT_Tracker
--		table. This causes T.IsAvailable, T.IsCustom, T.UniqueName to be NULL. 
--		This raises the need for the Tracker Definition Table.

--NOTE: It is a goal to keep this view using BASE tables in order to gain max performance. Nested views will 
--		be avoided here if possible.

--**************** SPECIFIC TRACKER DATA **********************
--**************** on 7/29/2014          **********************
--Tracker GUID or Unique ID across all DB Instances (ItemGuid)
--Tracker NodeID (we use it for the External ID for Audit and error Triage)  (John: can use ItemID in this case)
--Tracker Table Name or Value Group Name (e.g. Body Measurements) - Categorization (TrackerNameAggregateTable)
--Tracker Column Unique Name ( In English)  Must be consistent across all DB Instances  ([UniqueName] will be 
--		the TABLE NAME if tracker name not found in the HFIT_Tracker table)
--Tracker Column Description (In English) (???)
--Tracker Column Data Type (e.g. Character, Numeric, Date, Bit or Yes/No)  so that we can set up the answer type
--	NULLS accepted for No Answer?	(KEY1, KEY2, VAL1, VAL2, etc)
--Tracker Active flag (IsAvailable will be null if tracker name not found in the HFIT_Tracker table)
--Tracker Unit of Measure (character) (Currently, the UOM is supplied in the view based on the table and type of Tracker)
--Tracker Insert Date ([ItemCreatedWhen])
--Tracker Last Update Date ([ItemModifiedWhen])
--NOTE: Convert all numerics to floats 7/30/2104 John/Dale
--****************************************************************************************************************************
-- 12.23.2014 - Added the Vendor ID and Vendor name to the view via the HFit_LKP_TrackerVendor table
-- 12.25.2014 - Tested the view to see that it returned the correct VendorID description
--****************************************************************************************************************************
-- NEW ADDITIONS: 02.01.2015	Need for the updates to be completed and then we add.
--HFit_TrackerTobaccoAttestation
--HFit_TrackerPreventiveCare
--HFit_TrackerCotinine
--****************************************************************************************************************************
--USE:
--select * from view_EDW_TrackerCompositeDetails_CT_ONLY where EventDate between '2013-11-01 15:02:00.000' and '2013-12-01 15:02:00.000'

--Set statistics IO ON
--GO

SELECT DISTINCT
       'HFit_TrackerBloodPressure' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mm/Hg' AS UOM
     , 'Systolic' AS KEY1
     , CAST (Systolic AS float
       )AS VAL1
     , 'Diastolic' AS KEY2
     , CAST (Diastolic AS float
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'bp'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'bp'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerBloodPressure AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBloodPressure'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodPressure, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBloodSugarAndGlucose' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/L' AS UOM
     , 'Units' AS KEY1
     , CAST (Units AS float
       )AS VAL1
     , 'FastingState' AS KEY2
     , CAST (FastingState AS float
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'glucose'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'glucose'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerBloodSugarAndGlucose AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBloodSugarAndGlucose'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerBloodSugarAndGlucose, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL

/*
SELECT Distinct
	  [CT].[ItemID]
  FROM CHANGETABLE (CHANGES [HFit_TrackerBMI] , NULL) AS [CT];

*/

SELECT DISTINCT
       'HFit_TrackerBMI' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'kg/m2' AS UOM
     , 'BMI' AS KEY1
     , CAST (BMI AS float
       )AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'HFit_TrackerBMI'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'HFit_TrackerBMI'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerBMI AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBMI'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerBMI, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerBodyFat' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'PCT' AS UOM
     , 'Value' AS KEY1
     , CAST ([Value] AS float
       )AS VAL1
     , 'NA' AS KEY2
     , 0 AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'HFit_TrackerBodyFat'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'HFit_TrackerBodyFat'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerBodyFat AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBodyFat'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyFat, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
--******************************************************************************
SELECT DISTINCT
       'HFit_TrackerBodyMeasurements' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Inch' AS UOM
     , 'WaistInches' AS KEY1
     , CAST (WaistInches AS float
       )AS VAL1
     , 'HipInches' AS KEY2
     , CAST (HipInches AS float
       )AS VAL2
     , 'ThighInches' AS KEY3
     , CAST (ThighInches AS float
       )AS VAL3
     , 'ArmInches' AS KEY4
     , CAST (ArmInches AS float
       )AS VAL4
     , 'ChestInches' AS KEY5
     , CAST (ChestInches AS float
       )AS VAL5
     , 'CalfInches' AS KEY6
     , CAST (CalfInches AS float
       )AS VAL6
     , 'NeckInches' AS KEY7
     , CAST (NeckInches AS float
       )AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerBodyMeasurements AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerBodyMeasurements'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID --******************************************************************************
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerBodyMeasurements, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCardio' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'Minutes' AS KEY1
     , CAST (Minutes AS float
       )AS VAL1
     , 'Distance' AS KEY2
     , CAST (Distance AS float
       )AS VAL2
     , 'DistanceUnit' AS KEY3
     , CAST (DistanceUnit AS float
       )AS VAL3
     , 'Intensity' AS KEY4
     , CAST (Intensity AS float
       )AS VAL4
     , 'ActivityID' AS KEY5
     , CAST (ActivityID AS float
       )AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerCardio AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCardio' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerCardio, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCholesterol' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mg/dL' AS UOM
     , 'HDL' AS KEY1
     , CAST (HDL AS float
       )AS VAL1
     , 'LDL' AS KEY2
     , CAST (LDL AS float
       )AS VAL2
     , 'Total' AS KEY3
     , CAST (Total AS float
       )AS VAL3
     , 'Tri' AS KEY4
     , CAST (Tri AS float
       )AS VAL4
     , 'Ratio' AS KEY5
     , CAST (Ratio AS float
       )AS VAL5
     , 'Fasting' AS KEY6
     , CAST (Fasting AS float
       )AS VAL6
     , 'VLDL' AS VLDL
     , CAST (VLDL AS float
       )AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'HFit_TrackerCholesterol'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'HFit_TrackerCholesterol'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerCholesterol AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCholesterol'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerCholesterol, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerDailySteps' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Step' AS UOM
     , 'Steps' AS KEY1
     , CAST (Steps AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'HFit_TrackerDailySteps'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'HFit_TrackerDailySteps'
       )AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerDailySteps AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerDailySteps' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerDailySteps, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFlexibility' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasStretched' AS KEY1
     , CAST (HasStretched AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerFlexibility AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerFlexibility' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerFlexibility, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerFruits' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST (Cups AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerFruits AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerFruits' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerFruits, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHbA1c' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'mmol/mol' AS UOM
     , 'Value' AS KEY1
     , CAST ([Value] AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerHbA1c AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHbA1c'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerHbA1c, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHeight' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'inch' AS UOM
     , 'Height' AS KEY1
     , Height AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , ISNULL (T.UniqueName , 'HFit_TrackerHeight'
       )AS UniqueName
     , ISNULL (T.UniqueName , 'HFit_TrackerHeight'
       )AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerHeight AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHeight'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerHeight, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighFatFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST (Times AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerHighFatFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHighFatFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerHighFatFoods, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerHighSodiumFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST (Times AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerHighSodiumFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerHighSodiumFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerHighSodiumFoods, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerInstance_Tracker' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'TrackerDefID' AS KEY1
     , CAST (TrackerDefID AS float
       )AS VAL1
     , 'YesNoValue' AS KEY2
     , CAST (YesNoValue AS float
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerInstance_Tracker AS TT
                INNER JOIN dbo.HFit_TrackerDef_Tracker AS TDT
                ON TDT.trackerid = TT.trackerDefID
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON
       T.AggregateTableName = 'HFit_TrackerInstance_Tracker'
   AND T.uniquename = TDT.name
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerInstance_Tracker, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMealPortions' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST (Portions AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerMealPortions AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerMealPortions' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerMealPortions, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerMedicalCarePlan' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FollowedPlan' AS KEY1
     , CAST (FollowedPlan AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerMedicalCarePlan AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerMedicalCarePlan' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerMedicalCarePlan, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRegularMeals' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Units' AS KEY1
     , CAST (Units AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerRegularMeals AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerRegularMeals' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerRegularMeals, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerRestingHeartRate' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'BPM' AS UOM
     , 'HeartRate' AS KEY1
     , CAST (HeartRate AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerRestingHeartRate AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerRestingHeartRate'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerRestingHeartRate, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerShots' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'FluShot' AS KEY1
     , CAST (FluShot AS float
       )AS VAL1
     , 'PneumoniaShot' AS KEY2
     , CAST (PneumoniaShot AS float
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerShots AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerShots'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerShots, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSitLess' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Occurs' AS UOM
     , 'Times' AS KEY1
     , CAST (Times AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerSitLess AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSitLess' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerSitLess, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSleepPlan' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'HR' AS UOM
     , 'DidFollow' AS KEY1
     , CAST (DidFollow AS float
       )AS VAL1
     , 'HoursSlept' AS KEY2
     , HoursSlept AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Techniques' AS TXTKEY1
     , Techniques AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerSleepPlan AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSleepPlan' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerSleepPlan, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStrength' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'HasTrained' AS KEY1
     , CAST (HasTrained AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerStrength AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStrength' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerStrength, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStress' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'Intensity' AS KEY1
     , CAST (Intensity AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Awareness' AS TXTKEY1
     , Awareness AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerStress AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStress' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerStress, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerStressManagement' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'gradient' AS UOM
     , 'HasPracticed' AS KEY1
     , CAST (HasPracticed AS float
       )AS VAL1
     , 'Effectiveness' AS KEY2
     , CAST (Effectiveness AS float
       )AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'Activity' AS TXTKEY1
     , Activity AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerStressManagement AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerStressManagement' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerStressManagement, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryDrinks' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST (Ounces AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerSugaryDrinks AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSugaryDrinks' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerSugaryDrinks, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerSugaryFoods' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-portion' AS UOM
     , 'Portions' AS KEY1
     , CAST (Portions AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerSugaryFoods AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerSugaryFoods' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerSugaryFoods, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTests' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PSATest' AS KEY1
     , CAST (PSATest AS float
       )AS VAL1
     , 'OtherExam' AS KEY1
     , CAST (OtherExam AS float
       )AS VAL2
     , 'TScore' AS KEY3
     , CAST (TScore AS float
       )AS VAL3
     , 'DRA' AS KEY4
     , CAST (DRA AS float
       )AS VAL4
     , 'CotinineTest' AS KEY5
     , CAST (CotinineTest AS float
       )AS VAL5
     , 'ColoCareKit' AS KEY6
     , CAST (ColoCareKit AS float
       )AS VAL6
     , 'CustomTest' AS KEY7
     , CAST (CustomTest AS float
       )AS VAL7
     , 'TSH' AS KEY8
     , CAST (TSH AS float
       )AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'CustomDesc' AS TXTKEY1
     , CustomDesc AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , TT.ItemOrder
     , TT.ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerTests AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTests'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerTests, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoFree' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'Y/N' AS UOM
     , 'WasTobaccoFree' AS KEY1
     , CAST (WasTobaccoFree AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'QuitAids' AS TXTKEY1
     , QuitAids AS TXTVAL1
     , 'QuitMeds' AS TXTKEY2
     , QuitMeds AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerTobaccoFree AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTobaccoFree' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerTobaccoFree, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerVegetables' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'CUP(8oz)' AS UOM
     , 'Cups' AS KEY1
     , CAST (Cups AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerVegetables AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerVegetables' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerVegetables, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWater' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'OZ' AS UOM
     , 'Ounces' AS KEY1
     , CAST (Ounces AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerWater AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWater' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerWater, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWeight' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'LBS' AS UOM
     , 'Value' AS KEY1
     , [Value] AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , VENDOR.ItemID AS VendorID
     , VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerWeight AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWeight'
                LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
                ON TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerWeight, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerWholeGrains' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , CollectionSourceName_Internal
     , CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA-serving' AS UOM
     , 'Servings' AS KEY1
     , CAST (Servings AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , NULL AS IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , NULL AS VendorID	--VENDOR.ItemID as VendorID
     , NULL AS VendorName --VENDOR.VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerWholeGrains AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerWholeGrains' --left outer join HFit_LKP_TrackerVendor as VENDOR on TT.VendorID = VENDOR.ItemID
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerWholeGrains, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerCotinine' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'NicotineAssessment' AS KEY1
     , CAST (NicotineAssessment AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerCotinine AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerCotinine' --LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
            --	ON TT.VendorID = VENDOR.ItemID;
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerCotinine, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerPreventiveCare' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'PreventiveCare' AS KEY1
     , CAST (PreventiveCare AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerPreventiveCare AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerPreventiveCare' --LEFT OUTER JOIN HFit_LKP_TrackerVendor AS VENDOR
            --	ON TT.VendorID = VENDOR.ItemID;
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerPreventiveCare, NULL) AS CT
                ON TT.itemid = CT.itemid
UNION ALL
SELECT DISTINCT
       'HFit_TrackerTobaccoAttestation' AS TrackerNameAggregateTable
     , TT.ItemID
     , CAST (EventDate AS datetime) AS EventDate
     , TT.IsProfessionallyCollected
     , TT.TrackerCollectionSourceID
     , Notes
     , TT.UserID
     , NULL AS CollectionSourceName_Internal
     , NULL AS CollectionSourceName_External
     , 'MISSING' AS EventName
     , 'NA' AS UOM
     , 'TobaccoAttestation' AS KEY1
     , CAST (TobaccoAttestation AS float
       )AS VAL1
     , 'NA' AS KEY2
     , NULL AS VAL2
     , 'NA' AS KEY3
     , NULL AS VAL3
     , 'NA' AS KEY4
     , NULL AS VAL4
     , 'NA' AS KEY5
     , NULL AS VAL5
     , 'NA' AS KEY6
     , NULL AS VAL6
     , 'NA' AS KEY7
     , NULL AS VAL7
     , 'NA' AS KEY8
     , NULL AS VAL8
     , 'NA' AS KEY9
     , NULL AS VAL9
     , 'NA' AS KEY10
     , NULL AS VAL10
     , TT.ItemCreatedBy
     , cast(TT.ItemCreatedWhen as datetime) as ItemCreatedWhen
     , TT.ItemModifiedBy
     , cast(TT.ItemModifiedWhen as datetime) as ItemModifiedWhen
     , IsProcessedForHa
     , 'NA' AS TXTKEY1
     , NULL AS TXTVAL1
     , 'NA' AS TXTKEY2
     , NULL AS TXTVAL2
     , 'NA' AS TXTKEY3
     , NULL AS TXTVAL3
     , NULL AS ItemOrder
     , NULL AS ItemGuid
     , C.UserGuid
     , PP.MPI
     , PP.ClientCode
     , S.SiteGUID
     , ACCT.AccountID
     , ACCT.AccountCD
     , T.IsAvailable
     , T.IsCustom
     , T.UniqueName
     , T.UniqueName AS ColDesc
     , --VENDOR.ItemID AS VendorID ,
       --VENDOR.VendorName,
       NULL AS VendorID
     , NULL AS VendorName
     , CT.ItemID AS CT_ItemID
     , CT.SYS_CHANGE_VERSION AS CT_ChangeVersion
     , CT.SYS_CHANGE_OPERATION AS CMS_Operation
       FROM
            dbo.HFit_TrackerTobaccoAttestation AS TT
                INNER JOIN dbo.CMS_User AS C
                ON C.UserID = TT.UserID
                INNER JOIN dbo.hfit_ppteligibility AS PP
                ON TT.UserID = PP.userID
                INNER JOIN dbo.HFit_Account AS ACCT
                ON PP.ClientCode = ACCT.AccountCD
                INNER JOIN dbo.CMS_Site AS S
                ON ACCT.SiteID = S.SiteID
                INNER JOIN dbo.HFit_TrackerCollectionSource AS TC
                ON TC.TrackerCollectionSourceID = TT.TrackerCollectionSourceID
                LEFT OUTER JOIN dbo.HFIT_Tracker AS T
                ON T.AggregateTableName = 'HFit_TrackerTobaccoAttestation'
                INNER JOIN CHANGETABLE (CHANGES HFit_TrackerTobaccoAttestation, NULL) AS CT
                ON TT.itemid = CT.itemid;

GO

--  
--  
GO
PRINT '***** FROM: view_EDW_TrackerCompositeDetails_CT_ONLY.sql';
PRINT '***** CREATED view_EDW_TrackerCompositeDetails_CT_ONLY ';
GO 



GO
PRINT 'Processing: view_EDW_HealthAssesmentClientView ';
GO

IF EXISTS (SELECT
                  TABLE_NAME
                  FROM INFORMATION_SCHEMA.VIEWS
             WHERE TABLE_NAME = 'view_EDW_HealthAssesmentClientView') 
    BEGIN
        DROP VIEW
             view_EDW_HealthAssesmentClientView;
    END;
GO

--GRANT SELECT
--	ON [dbo].[view_EDW_HealthAssesmentClientView]
--	TO [EDWReader_PRD]
--GO

--******************************************************************************
--8/8/2014 - Generated corrected view in DEV (WDM)
--09.11.2014 (wdm) added to facilitate EDW last mod date
--02.04.2015 (wdm) #48828 added , HACampaign.BiometricCampaignStartDate, 
--		  HACampaign.BiometricCampaignEndDate, HACampaign.CampaignStartDate, 
--		  HACampaign.CampaignEndDate, HACampaign.Name, 
--		  HACampaign.NodeGuid as CampaignNodeGuid
--02.05.2015 Ashwin and I reviewed and approved
-- select top 100 * from view_EDW_HealthAssesmentClientView
--03.27.2015 ( Sowmiya V) - made changes to the view to look at the HealthAssesmentID 
--  only in the join condition.
--  The fix was needed to handle the SR#51281: Platform CampaignNodeGuid missing. 
--	   for view view_EDW_HealthAssesmentClientView
--  Leaving the old code as commented with notes. 
-- 03.13.2015 - (WDM) set the view up for change tracking - the SIMPLE version that does not 
--			 require change tracking tables to be involved.
--select count(*) from view_EDW_HealthAssesmentClientView
--SELECT * FROM   INFORMATION_SCHEMA.VIEWS WHERE  VIEW_DEFINITION like '%view_EDW_HealthAssesmentClientView%'
--******************************************************************************
CREATE VIEW dbo.view_EDW_HealthAssesmentClientView
AS SELECT 
          HFitAcct.AccountID
        , HFitAcct.AccountCD
        , HFitAcct.AccountName
        , HFitAcct.ItemGUID AS ClientGuid
        , CMSSite.SiteGUID
        , NULL AS CompanyID
        , NULL AS CompanyGUID
        , NULL AS CompanyName
        , HAJoined.DocumentName
        , cast(HACampaign.DocumentPublishFrom as datetime) AS HAStartDate
        , cast(HACampaign.DocumentPublishTo as datetime) AS HAEndDate
        , HACampaign.NodeSiteID
        , HAAssessmentMod.Title
        , HAAssessmentMod.CodeName
        , HAAssessmentMod.IsEnabled
        , CASE
              WHEN CAST (HACampaign.DocumentCreatedWhen AS date) = CAST (HACampaign.DocumentModifiedWhen AS date) 
                  THEN 'I'
              ELSE 'U'
          END AS ChangeType
        , cast(HACampaign.DocumentCreatedWhen as datetime) as DocumentCreatedWhen
        , cast(HACampaign.DocumentModifiedWhen as datetime) as DocumentModifiedWhen
        , cast(HAAssessmentMod.DocumentModifiedWhen  as datetime) AS AssesmentModule_DocumentModifiedWhen     --09.11.2014 (wdm) added to facilitate EDW last mod date
        , HAAssessmentMod.DocumentCulture AS DocumentCulture_HAAssessmentMod
        , HACampaign.DocumentCulture AS DocumentCulture_HACampaign
        , HAJoined.DocumentCulture AS DocumentCulture_HAJoined
        , cast(HACampaign.BiometricCampaignStartDate as datetime)as BiometricCampaignStartDate
        , cast(HACampaign.BiometricCampaignEndDate as datetime)as BiometricCampaignEndDate
        , cast(HACampaign.CampaignStartDate as datetime)as CampaignStartDate
        , cast(HACampaign.CampaignEndDate as datetime)as CampaignEndDate
        , HACampaign.Name
        , HACampaign.NodeGuid AS CampaignNodeGuid
        , HACampaign.HACampaignID
          FROM
               dbo.View_HFit_HACampaign_Joined AS HACampaign
                   INNER JOIN dbo.CMS_Site AS CMSSite
                       ON HACampaign.NodeSiteID = CMSSite.SiteID
                   INNER JOIN dbo.HFit_Account AS HFitAcct
                       ON HACampaign.NodeSiteID = HFitAcct.SiteID
                   INNER JOIN dbo.View_HFit_HealthAssessment_Joined AS HAJoined
                       ON HACampaign.HealthAssessmentID = HAJoined.DocumentID      --  added line to handle    SR #51281   
                          -- ON CASE ----03.27.2015 - Commented code to release the SR #51281
                          --WHEN [HACampaign].[HealthAssessmentConfigurationID] < 0
                          --THEN [HACampaign].[HealthAssessmentID]
                          --ELSE [HACampaign].[HealthAssessmentConfigurationID]
                          --END = HAJoined.DocumentID
                      AND HAJoined.DocumentCulture = 'en-US'
                   INNER JOIN dbo.View_HFit_HealthAssesmentModule_Joined AS HAAssessmentMod
                       ON HAJoined.nodeid = HAAssessmentMod.NodeParentID
                      AND HAAssessmentMod.DocumentCulture = 'en-US'
     WHERE HACampaign.DocumentCulture = 'en-US';
GO

PRINT 'Created: view_EDW_HealthAssesmentClientView ';
GO
--  
--  
GO
PRINT '***** FROM: view_EDW_HealthAssesmentClientView.sql';
GO 

GO
PRINT 'Processing: view_EDW_RewardUserDetail ';
GO

IF EXISTS (SELECT
                  NAME
                  FROM sys.VIEWS
                  WHERE NAME = 'view_EDW_RewardUserDetail') 
    BEGIN
        DROP VIEW
             view_EDW_RewardUserDetail;
    END;
GO
-- select count(*) from view_EDW_RewardUserDetail --334654
CREATE VIEW dbo.view_EDW_RewardUserDetail
AS

--**************************************************************************************************************************************************
--select * from [view_EDW_RewardUserDetail] where ItemModifiedWhen between '2000-11-14' and '2014-11-15'
--select * from [view_EDW_RewardUserDetail] where ItemModifiedWhen between '2014-05-12' and '2014-05-13' 
--8/7/2014 - added and commented out DocumentGuid and NodeGuid in case needed later
--8/08/2014 - Generated corrected view in DEV (WDM)
--8/12/2014 - Performance Issue - 00:06:49 @ 258502
--8/12/2014 - Performance Issue - Add PI01_view_EDW_RewardUserDetail
--8/12/2014 - Performance Issue - 00:03:46 @ 258502
--8/12/2014 - Performance Issue - Add PI02_view_EDW_RewardUserDetail
--8/12/2014 - Performance Issue - 00:03:45 @ 258502
--8/19/2014 - (WDM) Added where clause to make the query return english data only.	
--09.11.2014 : (wdm) Verified last mod date available to EDW - RewardsUserActivity_ItemModifiedWhen
--				RewardExceptionModifiedDate, RewardTrigger_DocumentModifiedWhen. Warned Laura this might create many dups.
--11.14.2014 : (wdm) The dups have surfaced. The combination of  HFRUAD.ActivityCompletedDt, 
--				HFRUAD.ItemModifiedWhen, HFRE.ItemModifiedWhen, HFRUAD.ItemModifiedWhen, VHFRTJ.DocumentModifiedWhen has exposed
--				tens of thousands of semi-redundant rows. Today, I commented these dates out and added a distinct and went from \
--				returning more than 100,000 rows for a given MPI and Client to 4 rows. I left in place the original dates of 
--				HFRULD.ItemCreatedWhen and HFRULD.ItemModifiedWhen. This gives us whether it is an insert or update. If multiple 
--				dates are used to determine changes, then it will be necessary to use a DATE filter to bring back only the 
--				rows indicating a change.
--11.18.2014 : (wdm) Found a USERID qualifier missing on the join of HFit_RewardsUserActivityDetail. Added this qualifier to USERID
--				and the view now appears to be functioning correctly returning about 160K rows in 2.5 minutes. The DISTINCT clause
--				made no difference in the number of returned rows, so it was removed and the execution time of the query was cut in half.
--11.18.2014 (wdm) added this filter so that only USER Detail was returned.
--01.01.2015 (WDM) added left outer join HFit_LKP_RewardActivity AND VHFRAJ.RewardActivityLKPName to the view - reference CR-47520
--01.01.2015 (WDM) Tested modifications - reference CR-47520
--02.17.2015 (WDM) and (SR) - modified the indexes and moved the where into a join to force the execution plan to modifiy itself. The 
--				view would not run in several hours since the deployment of this past Friday. Now, runs in a few minutes (less than 2).
-- 03.03.2015 Reviewed by nathan and dale and changes made as noted within.
--			ADDED THE FOLLOWING:
--				VHFRAJ.NodeGuid as RewardActivityGUID	--(03.03.2015 dale/nathan corrected)
--				VHFRPJ.DocumentGuid 	--(03.03.2015 dale/nathan corrected)
--				VHFRPJ.NodeGuid		--as RewardProgramGUID	--(03.03.2015 dale/nathan corrected)
--				VHFRGJ.NodeGuid	as RewardGroupGUID	--(03.03.2015 dale/nathan corrected)
--				VHFRTJ.NodeGuid AS RewardTriggerGUID	--(03.03.2015 dale/nathan corrected)
--03.19.2015 : by request of the EDW team, removed all columns not specificially requested
--			 and verified that was the request before initiating. The commented out columns
--			 were removed as a the solution to this request. 
--03.26.2015 : RewardGroupGUID removed per Shankar
--03.26.2015 : RewardExceptionModifiedDate Removed per Shankar
--03.26.2015 : Removed the following per Shankar  (ItemModifiedWhen/RewardExceptionModifiedDate)
--05.02.2015 : WDM - modified view for change tracking implementation (testing only)
--05.13.2015 : PUT IT BACK per discussion with Lee Allison. However, I can easily remove it again. (ItemModifiedWhen/RewardExceptionModifiedDate)
--05.13.2015 : Pulled the column from HFRUAD.ActivityCompletedDt AS RewardExceptionModifiedDate per Nathan 
--05.14.2015 : VHFRGJ.NodeGuid AS RewardGroupGUID	 --(03.03.2015 dale/nathan corrected) and removed 03.26.2015 per Shankar; put back 03.30.2015 deemed needed; removed 05.14.2015 who knows why.
--06.26.2015 : Dhaval and Dale discuss change request to view. 
--			 HFRUAD -> HFit_RewardsUserActivityDetail, we are asked to change a field (UserExceptionAppliedTo)
--			 to now point to ActivityCompletedId -> HFit_RewardsUserActivityDetail. This req made today 
--			 from Corina thru Laura. Dhaval and I CONNOT make this change without a CR. 
--			 We decided to implement as: HFRAUD.ActivityCompletedId as UserExceptionAppliedTo
--06.28.2015 : Reviewed, tested, and Passed by Corina
--07.13.2015 : #55054 raised by Corina indicates there may be data anomolies (returned number of rows) based on whether 
--			 a LEFT or INNER join is used. WDM tested the return counts on all machines using both inner and left joins.
--				288,480 with inner join   P5/P1	 @ 07.13.2015
--				288,480 with left join	 P5/P1	 @ 07.13.2015
--				372,060 with 2 left join	 P5/P1	 @ 07.13.2015
--				24,833 with inner join    P5/P2	 @ 07.13.2015
--				24,833 with left join	 P5/P2	 @ 07.13.2015
--				40,738 with 2 left join	 P5/P2	 @ 07.13.2015    
--				374,876 with inner join   P5/P3	 @ 07.13.2015
--				374,876 with left join	 P5/P3	 @ 07.13.2015
--				523,203 with 2 left join	 P5/P3	 @ 07.13.2015		  
--			 NOTE: In all instances on Prod5 and TGT, the returned row count is the same.
--08.02.2015	 Corina and Dale reviewed and tested the view DDL with corrections suggested by Corina that will cause a more 
--			 complete set of User Rewards to be returned.
--08.06.2015	 Yesterday the ciew was approved by Corina and is being scheduled for implementation tonight.
--**************************************************************************************************************************************************

SELECT DISTINCT
       cu.UserGUID
     , CS2.SiteGUID
     , cus2.HFitUserMpiNumber
     , VHFRAJ.NodeGuid AS RewardActivityGUID	--(03.03.2015 dale/nathan corrected)
     , VHFRPJ.RewardProgramName
     , CAST (VHFRPJ.DocumentModifiedWhen AS datetime) AS RewardModifiedDate

     , CAST (VHFRLJ.DocumentModifiedWhen  AS datetime) AS RewardLevelModifiedDate
     , CAST (HFRULD.LevelCompletedDt AS datetime) AS LevelCompletedDt
     , HFRUAD.ActivityPointsEarned
     , CAST (HFRUAD.ActivityCompletedDt AS datetime) AS ActivityCompletedDt
     , CAST (HFRUAD.ItemModifiedWhen  AS datetime) AS RewardActivityModifiedDate
     , VHFRAJ.ActivityPoints
     , HFRE.UserAccepted		  --Corina, please verify whether this column is needde or not
       --, HFRE.UserExceptionAppliedTo
     , HFRUAD.ActivityCompletedId AS UserExceptionAppliedTo
     , VHFRTJ.NodeGuid AS RewardTriggerGUID	--(03.03.2015 dale/nathan corrected)
     , HFA.AccountID
     , HFA.AccountCD
     , CASE
           WHEN CAST (HFRULD.ItemCreatedWhen AS date) = CAST (HFRULD.ItemModifiedWhen AS date) 
               THEN 'I'
           ELSE 'U'
       END AS ChangeType
     , CAST (HFRUAD.ActivityCompletedDt AS datetime) AS RewardExceptionModifiedDate

       FROM
           dbo.HFit_RewardsUserActivityDetail AS HFRUAD WITH (NOLOCK) 
               INNER JOIN dbo.View_HFit_RewardActivity_Joined AS VHFRAJ WITH (NOLOCK) 
                   ON VHFRAJ.NodeID = HFRUAD.ActivityNodeID
                  AND VHFRAJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardGroup_Joined AS VHFRGJ WITH (NOLOCK) 
                   ON HFRUAD.rewardgroupnodeid = VHFRGJ.NodeID
                  AND VHFRGJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardProgram_Joined AS VHFRPJ WITH (NOLOCK) 
                   ON HFRUAD.rewardprogramnodeid = VHFRPJ.NodeID
                  AND VHFRPJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardLevel_Joined AS VHFRLJ WITH (NOLOCK) 
                   ON HFRUAD.rewardlevelnodeid = VHFRLJ.NodeID
                  AND VHFRLJ.DocumentCulture = 'en-us'
               INNER JOIN dbo.CMS_User AS CU WITH (NOLOCK) 
                   ON cu.UserID = HFRUAD.userid
               INNER JOIN dbo.CMS_UserSite AS CUS WITH (NOLOCK) 
                   ON CU.UserID = CUS.UserID
               INNER JOIN dbo.CMS_Site AS CS2 WITH (NOLOCK) 
                   ON CUS.SiteID = CS2.SiteID
               INNER JOIN dbo.HFit_Account AS HFA WITH (NOLOCK) 
                   ON cs2.SiteID = HFA.SiteID
               INNER JOIN dbo.CMS_UserSettings AS CUS2 WITH (NOLOCK) 
                   ON cu.UserID = cus2.UserSettingsUserID
               LEFT JOIN dbo.HFit_RewardsUserLevelDetail AS HFRULD WITH (NOLOCK) 
                   ON HFRUAD.rewardlevelnodeid = HFRULD.LevelNodeID
                  AND HFRULD.rewardgroupnodeid = HFRUAD.rewardgroupnodeid
                  AND HFRULD.rewardprogramnodeid = HFRUAD.rewardprogramnodeid
                  AND HFRULD.userid = HFRUAD.userid
               LEFT OUTER JOIN dbo.View_HFit_RewardTrigger_Joined AS VHFRTJ WITH (NOLOCK) 
                   ON VHFRAJ.NodeID = VHFRTJ.NodeParentID
                  AND VHFRTJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.HFit_RewardException AS HFRE WITH (NOLOCK) 
                   ON HFRE.RewardActivityID = VHFRAJ.RewardActivityID
                  AND HFRE.UserID = cu.UserID
       WHERE  cus2.HFitUserMpiNumber > 0;

GO
PRINT 'Completed : view_EDW_RewardUserDetail ';
GO

/*----------------------------------------
(WDM) Kept only these columns IAW CR-51005
UserGUID
SiteGUID 
HFitUserMPINumber
RewardActivityGUID
RewardProgramName
RewardModifiedDate
RewardGroupGUID
RewardLevelModifiedDate
LevelCompletedDt
ActivityPointsEarned
ActivityCompletedDt
RewardActivityModifiedDate
ActivityPoints
UserAccepted
UserExceptionAppliedTo
RewardTriggerGUID
AccountID
AccountCD 
ChangeType
RewardExceptionModifiedDate
*/

PRINT '***** FROM: view_EDW_RewardUserDetail.sql';
GO 

GO
-- use KenticoCMS_Prod1

GO

PRINT 'Processing: view_EDW_RewardUserDetail_CT ';

GO

IF EXISTS ( SELECT
                   NAME
                   FROM sys.VIEWS
                   WHERE NAME = 'view_EDW_RewardUserDetail_CT') 

    BEGIN

        DROP VIEW
             view_EDW_RewardUserDetail_CT;
    END;

GO

/*----------------------------
TABLES USED IN VIEW:
CMS_Class
CMS_Document
CMS_Site
CMS_Tree
CMS_User
CMS_UserSettings
CMS_UserSite
COM_SKU
HFit_Account
HFit_LKP_RewardActivity
HFit_LKP_RewardLevelType
HFit_LKP_RewardTrigger
HFit_LKP_RewardType
HFit_RewardActivity
HFit_RewardException
HFit_RewardGroup
HFit_RewardLevel
HFit_RewardProgram
HFit_RewardsUserActivityDetail
HFit_RewardsUserLevelDetail
HFit_RewardTrigger
*/
--**************************************************************************************************************************************************
--06.26.2015 : Dhaval and Dale discuss change request to view. 
--			 HFRUAD -> HFit_RewardsUserActivityDetail, we are asked to change a field (UserExceptionAppliedTo)
--			 to now point to ActivityCompletedId -> HFit_RewardsUserActivityDetail. This req made today 
--			 from Corina thru Laura. Dhaval and I CONNOT make this change without a CR. 
--			 We decided to implement as: HFRAUD.ActivityCompletedId as UserExceptionAppliedTo
--**************************************************************************************************************************************************
-- select top 100 LevelCompletedDt, from view_EDW_RewardUserDetail_CT

CREATE VIEW dbo.view_EDW_RewardUserDetail_CT
AS 
SELECT DISTINCT
       cu.UserGUID
     , CS2.SiteGUID
     , cus2.HFitUserMpiNumber
     , VHFRAJ.NodeGuid AS RewardActivityGUID	--(03.03.2015 dale/nathan corrected)
     , VHFRPJ.RewardProgramName
     , CAST (VHFRPJ.DocumentModifiedWhen AS datetime) AS RewardModifiedDate

     , CAST (VHFRLJ.DocumentModifiedWhen  AS datetime) AS RewardLevelModifiedDate
     , CAST (HFRULD.LevelCompletedDt AS datetime) AS LevelCompletedDt
     , HFRUAD.ActivityPointsEarned
     , CAST (HFRUAD.ActivityCompletedDt AS datetime) AS ActivityCompletedDt
     , CAST (HFRUAD.ItemModifiedWhen  AS datetime) AS RewardActivityModifiedDate
     , VHFRAJ.ActivityPoints
     , HFRE.UserAccepted		  --Corina, please verify whether this column is needde or not
       --, HFRE.UserExceptionAppliedTo
     , HFRUAD.ActivityCompletedId AS UserExceptionAppliedTo
     , VHFRTJ.NodeGuid AS RewardTriggerGUID	--(03.03.2015 dale/nathan corrected)
     , HFA.AccountID
     , HFA.AccountCD
     , CASE
           WHEN CAST (HFRULD.ItemCreatedWhen AS date) = CAST (HFRULD.ItemModifiedWhen AS date) 
               THEN 'I'
           ELSE 'U'
       END AS ChangeType
     , CAST (HFRUAD.ActivityCompletedDt AS datetime) AS RewardExceptionModifiedDate

       FROM
           dbo.HFit_RewardsUserActivityDetail AS HFRUAD WITH (NOLOCK) 
               INNER JOIN dbo.View_HFit_RewardActivity_Joined AS VHFRAJ WITH (NOLOCK) 
                   ON VHFRAJ.NodeID = HFRUAD.ActivityNodeID
                  AND VHFRAJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardGroup_Joined AS VHFRGJ WITH (NOLOCK) 
                   ON HFRUAD.rewardgroupnodeid = VHFRGJ.NodeID
                  AND VHFRGJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardProgram_Joined AS VHFRPJ WITH (NOLOCK) 
                   ON HFRUAD.rewardprogramnodeid = VHFRPJ.NodeID
                  AND VHFRPJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.View_HFit_RewardLevel_Joined AS VHFRLJ WITH (NOLOCK) 
                   ON HFRUAD.rewardlevelnodeid = VHFRLJ.NodeID
                  AND VHFRLJ.DocumentCulture = 'en-us'
               INNER JOIN dbo.CMS_User AS CU WITH (NOLOCK) 
                   ON cu.UserID = HFRUAD.userid
               INNER JOIN dbo.CMS_UserSite AS CUS WITH (NOLOCK) 
                   ON CU.UserID = CUS.UserID
               INNER JOIN dbo.CMS_Site AS CS2 WITH (NOLOCK) 
                   ON CUS.SiteID = CS2.SiteID
               INNER JOIN dbo.HFit_Account AS HFA WITH (NOLOCK) 
                   ON cs2.SiteID = HFA.SiteID
               INNER JOIN dbo.CMS_UserSettings AS CUS2 WITH (NOLOCK) 
                   ON cu.UserID = cus2.UserSettingsUserID
               LEFT JOIN dbo.HFit_RewardsUserLevelDetail AS HFRULD WITH (NOLOCK) 
                   ON HFRUAD.rewardlevelnodeid = HFRULD.LevelNodeID
                  AND HFRULD.rewardgroupnodeid = HFRUAD.rewardgroupnodeid
                  AND HFRULD.rewardprogramnodeid = HFRUAD.rewardprogramnodeid
                  AND HFRULD.userid = HFRUAD.userid
               LEFT OUTER JOIN dbo.View_HFit_RewardTrigger_Joined AS VHFRTJ WITH (NOLOCK) 
                   ON VHFRAJ.NodeID = VHFRTJ.NodeParentID
                  AND VHFRTJ.DocumentCulture = 'en-us'
               LEFT OUTER JOIN dbo.HFit_RewardException AS HFRE WITH (NOLOCK) 
                   ON HFRE.RewardActivityID = VHFRAJ.RewardActivityID
                  AND HFRE.UserID = cu.UserID
       WHERE  cus2.HFitUserMpiNumber > 0;

GO

PRINT 'Completed : view_EDW_RewardUserDetail_CT ';

GO

PRINT '***** FROM: view_EDW_RewardUserDetail_CT.sql';

GO 
